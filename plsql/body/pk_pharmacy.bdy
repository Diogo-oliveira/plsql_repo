/*-- Last Change Revision: $Rev: 2027485 $*/
/*-- Last Change by: $Author: mario.fernandes $*/
/*-- Date of last change: $Date: 2022-08-02 18:42:22 +0100 (ter, 02 ago 2022) $*/

CREATE OR REPLACE PACKAGE BODY pk_pharmacy IS
    -- Author  : Rui Marante
    -- Created : 2009-01-05
    -- Purpose : functions and procedures for pharmacy requests ... 

    --MERGED FROM v2.5 #Revision: 1055014

    -- ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - *****
    --BEGIN: private constant declarations
    g_package_owner          CONSTANT VARCHAR2(30 CHAR) := 'ALERT';
    g_package_name           CONSTANT VARCHAR2(30 CHAR) := 'PK_PHARMACY';
    g_pharmacy_log_is_active CONSTANT BOOLEAN := TRUE;

    --request types drug_req.flg_type
    g_flg_int     CONSTANT drug_req.flg_type%TYPE := 'I';
    g_flg_adm     CONSTANT drug_req.flg_type%TYPE := 'A';
    g_flg_unidose CONSTANT drug_req.flg_type%TYPE := 'U';

    --others
    --(AUX - DEV)
    g_flg_aux_dev CONSTANT VARCHAR2(1 CHAR) := 'D';
    g_flg_aux_car CONSTANT VARCHAR2(1 CHAR) := 'M'; --aux car ... mobile ;)

    --unidose car
    g_flg_uni_car CONSTANT VARCHAR2(1 CHAR) := 'W'; --car ... wagon ;)

    --Y|N (true|false)
    g_yes CONSTANT VARCHAR2(1 CHAR) := 'Y';
    g_no  CONSTANT VARCHAR2(1 CHAR) := 'N';

    --error state id
    g_state_err CONSTANT wfl_state.id_state%TYPE := -1;

    --END: private constant declarations

    --BEGIN: private variable declarations
    g_error VARCHAR2(2000 CHAR);
    --END: private variable declarations

    --BEGIN: pharmacy custom exceptions
    g_ex_cannot_be_2checked EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_cannot_be_2checked, -20501);

    g_ex_cannot_be_checked EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_cannot_be_checked, -20502);

    g_ex_invalid_qty_sup EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_invalid_qty_sup, -20503);

    g_ex_cannot_be_canceled EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_cannot_be_canceled, -20504);

    g_ex_supply_cannot_be_canceled EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_supply_cannot_be_canceled, -20505);

    g_ex_cannot_be_rejected EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_cannot_be_rejected, -20506);

    g_ex_cannot_be_supplyed EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_cannot_be_supplyed, -20507);

    g_ex_cannot_be_delivered EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_cannot_be_delivered, -20508);

    g_ex_cannot_be_canceled_drs EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_cannot_be_canceled_drs, -20509);

    g_ex_cannot_be_transported_drs EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_cannot_be_transported_drs, -20510);

    g_ex_cannot_alter_car EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_cannot_alter_car, -20511);

    g_ex_unidose_car_full EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_unidose_car_full, -20512);

    g_ex_unidose_car_cannot_change EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_unidose_car_cannot_change, -20513);

    g_ex_unidose_car_gen EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_unidose_car_gen, -20514);

    g_ex_unidose_invalid_dates EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_unidose_invalid_dates, -20515);

    g_ex_unidose_car_empty EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_unidose_car_empty, -20516);

    g_ex_unidose_car_not_ready EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_unidose_car_not_ready, -20517);

    g_ex_invalid_st_transition EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_invalid_st_transition, -20518);

    g_ex_unidose_dup_val_slot EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_unidose_dup_val_slot, -20519);

    g_ex_unidose_dup_car EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_unidose_dup_car, -20520);

    g_ex_unidose_no_available_car EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_unidose_no_available_car, -20521);

    g_ex_unidose_none_for_today EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_unidose_none_for_today, -20522);

    g_ex_presc_takes_calculus EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_presc_takes_calculus, -20523);

    g_ex_co_sign_task EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_co_sign_task, -20524);

    g_ex_req_is_allocate2car EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_req_is_allocate2car, -20525);

    g_ex_presc_validate EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_presc_validate, -20526);

    g_ex_presc_validate_true EXCEPTION;
    PRAGMA EXCEPTION_INIT(g_ex_presc_validate_true, -20527);

    --END: exceptions

    g_drug_iv_fluid_constructed CONSTANT VARCHAR2(4 CHAR) := '7515'; --id_drug dos soros construidos!
    g_id_other_product          CONSTANT VARCHAR2(2 CHAR) := '-2'; --id ficticio dos outros produtos

    -- ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - *****
    --BEGIN: private methods

    -- ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - *****
    --BEGIN: LOG and ERROR procedures!

    --register log messages -- AUTONOMOUS_TRANSACTION!!
    PROCEDURE set_pharmacy_log
    (
        i_function   IN VARCHAR2,
        i_debug_into IN VARCHAR2
    ) IS
        PRAGMA AUTONOMOUS_TRANSACTION;
    BEGIN
        IF (g_pharmacy_log_is_active)
        THEN
            pk_alertlog.log_debug(i_debug_into, g_package_name, i_function);
            COMMIT;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            ROLLBACK;
    END set_pharmacy_log;

    --pharmacy custom error messages
    PROCEDURE process_pharmacy_error
    (
        i_lang    IN language.id_language%TYPE,
        i_sqlcode IN NUMBER,
        i_error   IN t_error_out,
        o_error   OUT t_error_out
    ) IS
    BEGIN
        /*
        o_error :=
          t_error_out(
            to_char(i_sqlcode),
            '' || pk_translation.get_translation(i_lang, 'PHARMACY_EXCEPTION_DESC' || to_char(i_sqlcode)),
            null,
            '' || pk_translation.get_translation(i_lang, 'PHARMACY_EXCEPTION_ACTION' || to_char(i_sqlcode)),
            i_error.log_id,
            null);
        */
    
        pk_alert_exceptions.process_error(i_lang     => i_lang,
                                          i_sqlcode  => to_char(i_sqlcode),
                                          i_sqlerrm  => '' || pk_translation.get_translation(i_lang,
                                                                                             'PHARMACY.EXCEPTION.DESC' ||
                                                                                             to_char(i_sqlcode)),
                                          i_message  => '' || pk_translation.get_translation(i_lang,
                                                                                             'PHARMACY.EXCEPTION.ACTION' ||
                                                                                             to_char(i_sqlcode)),
                                          i_owner    => g_package_owner,
                                          i_package  => g_package_name,
                                          i_function => 'process_pharmacy_error',
                                          o_error    => o_error);
    
    EXCEPTION
        WHEN OTHERS THEN
            o_error := i_error; --on error, return same error object
    END process_pharmacy_error;

    --process errors -- AUTONOMOUS_TRANSACTION!!
    PROCEDURE process_error
    (
        i_lang     IN language.id_language%TYPE,
        i_sqlcode  IN NUMBER,
        i_sqlerrm  IN VARCHAR2,
        i_message  IN VARCHAR2,
        i_function IN VARCHAR2,
        o_error    OUT t_error_out
    ) IS
        PRAGMA AUTONOMOUS_TRANSACTION;
    BEGIN
        pk_alert_exceptions.process_error(i_lang,
                                          i_sqlcode,
                                          i_sqlerrm,
                                          i_message,
                                          g_package_owner,
                                          g_package_name,
                                          i_function,
                                          o_error);
        COMMIT;
    
        IF (i_sqlcode BETWEEN - 20700 AND - 20500)
        THEN
            --pharmacy custom errors messages
            process_pharmacy_error(i_lang, i_sqlcode, o_error, o_error);
        END IF;
    
    EXCEPTION
        WHEN OTHERS THEN
            ROLLBACK;
    END process_error;
    --END: LOG and ERROR procedures!

    /********************************************************************************************
    * alert.pk_pharmacy.debug_workflow  
    *
    * @param    I_LANG                          IN        NUMBER(6)
    * @param    I_PROF                          IN        ALERT.PROFISSIONAL
    * @param    [I_ID_MARKET]                   IN        NUMBER(24)
    * @param    [I_DAY_DELTA]                   IN        NUMBER
    * @param    [I_TEXT]                        IN        VARCHAR2
    * @param    O_ROWS                          OUT       REF CURSOR
    *
    * @return   BOOLEAN
    *
    * @author   Rui Marante
    * @since    2011-10-13
    *
    * @notes    THIS FUNCTION IS ONLY FOR TEST AND DEBUG OF WORKFLOW ICON CONFIGURATION   
    *
    ********************************************************************************************/
    FUNCTION debug_workflow
    (
        i_lang      IN language.id_language%TYPE,
        i_prof      IN profissional,
        i_id_market IN wfl_state_scope.market%TYPE DEFAULT 1, --PT
        i_day_delta IN NUMBER DEFAULT -1, --menos um dia
        i_text      IN VARCHAR2 DEFAULT NULL, --texto no icon
        o_rows      OUT pk_types.cursor_type
    ) RETURN BOOLEAN IS
        l_db_object_name CONSTANT user_procedures.procedure_name%TYPE := 'DEBUG_WORKFLOW';
        --
        l_current_timestamp TIMESTAMP WITH LOCAL TIME ZONE := current_timestamp;
    BEGIN
        OPEN o_rows FOR
            SELECT sc.id_scope,
                   sc.flg_type,
                   s.id_state,
                   s.state_name,
                   pk_medication_workflow.get_state_translation(i_lang, s.id_state) state_translation,
                   MAX(decode(sd.prof_type,
                              'P',
                              get_status_pipe_str(i_lang,
                                                  i_prof,
                                                  s.id_state,
                                                  sd.prof_type,
                                                  l_current_timestamp + i_day_delta,
                                                  '0',
                                                  i_text,
                                                  g_yes),
                              NULL)) icon_pharmacist,
                   MAX(decode(sd.prof_type,
                              'T',
                              get_status_pipe_str(i_lang,
                                                  i_prof,
                                                  s.id_state,
                                                  sd.prof_type,
                                                  l_current_timestamp + i_day_delta,
                                                  '0',
                                                  i_text,
                                                  g_yes),
                              NULL)) icon_technician,
                   MAX(decode(sd.prof_type,
                              'D',
                              get_status_pipe_str(i_lang,
                                                  i_prof,
                                                  s.id_state,
                                                  sd.prof_type,
                                                  l_current_timestamp + i_day_delta,
                                                  '0',
                                                  i_text,
                                                  g_yes),
                              NULL)) icon_physician,
                   MAX(decode(sd.prof_type,
                              'N',
                              get_status_pipe_str(i_lang,
                                                  i_prof,
                                                  s.id_state,
                                                  sd.prof_type,
                                                  l_current_timestamp + i_day_delta,
                                                  '0',
                                                  i_text,
                                                  g_yes),
                              NULL)) icon_nurse,
                   MAX(decode(sd.prof_type,
                              'O',
                              get_status_pipe_str(i_lang,
                                                  i_prof,
                                                  s.id_state,
                                                  sd.prof_type,
                                                  l_current_timestamp + i_day_delta,
                                                  '0',
                                                  i_text,
                                                  g_yes),
                              NULL)) icon_ancillary
              FROM wfl_state_scope sc
              LEFT JOIN wfl_state s
                ON (sc.id_scope = s.scope)
              LEFT JOIN wfl_state_detail sd
                ON (s.id_state = sd.state)
             WHERE sc.market = i_id_market
               AND s.flg_active = g_yes
             GROUP BY sc.id_scope,
                      sc.flg_type,
                      s.id_state,
                      s.state_name,
                      alert.pk_medication_workflow.get_state_translation(i_lang, s.id_state)
             ORDER BY sc.id_scope, s.id_state;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            set_pharmacy_log(i_function => l_db_object_name, i_debug_into => SQLERRM);
            RETURN FALSE;
    END debug_workflow;
    -- ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - *****

    --verifica se o valor existe no type
    FUNCTION in_table
    (
        i_value        IN NUMBER,
        i_table_number IN table_number
    ) RETURN BOOLEAN DETERMINISTIC IS
        l_count NUMBER(1) := 0;
    BEGIN
    
        SELECT COUNT(1)
          INTO l_count
          FROM TABLE(i_table_number) t
         WHERE t.column_value = i_value
           AND rownum = 1;
    
        RETURN(l_count = 1);
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END in_table;

    /********************************************************************************************
    * alert.pk_pharmacy.update_unidose_car_state
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_UNIDOSE_CAR                IN    NUMBER(24)
    *
    * @author Rui Marante
    * @version  2.5.0.7.1
    * @since  2009-11-13
    *
    ********************************************************************************************/
    PROCEDURE update_unidose_car_state
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN alert.profissional,
        i_id_unidose_car IN pharm_unidose_car.id_unidose_car%TYPE
    ) IS
        l_state_transition_ok BOOLEAN := FALSE;
        l_current_car_state   pharm_unidose_car.id_state%TYPE;
        l_next_car_state      pharm_unidose_car.id_state%TYPE;
    BEGIN
        IF (i_id_unidose_car != -1)
        THEN
        
            g_error := 'CHECK CAR STATE TRANSITION';
            SELECT uc.id_state
              INTO l_current_car_state
              FROM pharm_unidose_car uc
             WHERE uc.id_unidose_car = i_id_unidose_car;
        
            l_next_car_state := get_state_for_req_type(i_prof, NULL, g_uni_car_executing_st);
        
            IF (l_current_car_state != l_next_car_state)
            THEN
                l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                                 i_prof,
                                                                                 l_current_car_state,
                                                                                 l_next_car_state);
            
                IF (l_state_transition_ok)
                THEN
                    UPDATE pharm_unidose_car uc
                       SET uc.id_state = l_next_car_state
                     WHERE uc.id_unidose_car = i_id_unidose_car;
                
                    INSERT INTO pharm_unidose_car_state_trans
                        (id_unidose_car, id_state, id_prof, dt_state)
                    VALUES
                        (i_id_unidose_car, l_next_car_state, i_prof.id, current_timestamp);
                ELSE
                    RAISE g_ex_unidose_car_cannot_change;
                END IF;
            END IF;
        
        END IF;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END update_unidose_car_state;

    /********************************************************************************************
    * alert.pk_pharmacy.get_allocation_for_prof
    *
    * @param  I_PROF_PRESC                       IN     ALERT.PROFISSIONAL
    * @param  O_DEP_CLIN_SERVS                   IN     VARCHAR2
    *
    * @author Rui Marante
    * @version  2.5.0.7
    * @since  2009-10-23
    *
    ********************************************************************************************/
    PROCEDURE get_allocation_for_prof
    (
        i_prof_presc     IN alert.profissional,
        o_dep_clin_servs OUT table_number
    ) IS
    BEGIN
        SELECT a.id_dep_clin_serv
          BULK COLLECT
          INTO o_dep_clin_servs
          FROM pharm_service_allocation a, dep_clin_serv b
         WHERE a.id_prof = i_prof_presc.id
           AND a.id_institution = i_prof_presc.institution
           AND a.id_dep_clin_serv = b.id_dep_clin_serv
           AND b.flg_available = g_yes;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_allocation_for_prof;

    /********************************************************************************************
    * alert.pk_pharmacy.get_state_for_req_type
    *
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_REQ_TYPE                      IN    VARCHAR2
    * @param  I_GENERIC_NAME                  IN    VARCHAR2
    *
    * @return NUMBER
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-02
    *
    ********************************************************************************************/
    FUNCTION get_state_for_req_type
    (
        i_prof         IN profissional,
        i_req_type     IN wfl_state_scope.flg_type%TYPE,
        i_generic_name IN wfl_state.generic_name%TYPE
    ) RETURN NUMBER DETERMINISTIC IS
        l_market institution.id_market%TYPE := NULL;
    BEGIN
        IF (i_prof.institution != 0)
        THEN
            SELECT i.id_market
              INTO l_market
              FROM institution i
             WHERE i.id_institution = i_prof.institution;
        END IF;
    
        IF (l_market IS NULL)
        THEN
            --alternative way (not very good!!)
            SELECT m.id_market
              INTO l_market
              FROM market m
             WHERE m.desc_market = pk_sysconfig.get_config('PRESCRIPTION_TYPE', i_prof)
               AND rownum = 1;
        END IF;
    
        RETURN pk_medication_workflow.get_states(i_lang         => 1,
                                                 i_prof         => i_prof,
                                                 i_flg_type     => i_req_type,
                                                 i_generic_name => i_generic_name,
                                                 i_market       => l_market);
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_state_for_req_type;

    /********************************************************************************************
    * alert.pk_pharmacy.get_states_for_req_type
    *
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_REQ_TYPE                      IN    VARCHAR2
    * @param  I_GENERIC_STATE                 IN    ALERT.TABLE_VARCHAR
    *
    * @return ALERT.TABLE_NUMBER
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-02
    *
    ********************************************************************************************/
    FUNCTION get_states_for_req_type
    (
        i_prof          IN profissional,
        i_req_type      IN drug_req.flg_type%TYPE,
        i_generic_state IN table_varchar
    ) RETURN table_number DETERMINISTIC IS
        l_state       NUMBER(5) := NULL;
        l_states      table_number := table_number();
        l_state_count NUMBER(5) := 0;
        l_input_count NUMBER(5) := 0;
    BEGIN
        l_input_count := i_generic_state.count;
    
        FOR i IN 1 .. l_input_count
        LOOP
        
            l_state := get_state_for_req_type(i_prof, i_req_type, i_generic_state(i));
        
            IF (l_state != g_state_err)
            THEN
                l_state_count := l_state_count + 1;
                l_states.extend(1);
                l_states(l_state_count) := l_state;
            END IF;
        
        END LOOP;
    
        RETURN l_states;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_states_for_req_type;

    FUNCTION create_uni_car
    (
        i_prof         IN profissional,
        i_id_car_model IN pharm_unidose_car_model.id_unidose_car_model%TYPE,
        i_dt_car_begin IN pharm_unidose_car.dt_car_begin%TYPE,
        i_dt_car_end   IN pharm_unidose_car.dt_car_end%TYPE
    ) RETURN pharm_unidose_car.id_unidose_car%TYPE IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'CREATE_UNI_CAR';
        --
        l_new_car_id pharm_unidose_car.id_unidose_car%TYPE;
        l_slot_count pharm_unidose_car_model.number_of_slots%TYPE;
        l_car_state  wfl_state.id_state%TYPE;
    BEGIN
        l_car_state := get_state_for_req_type(i_prof, NULL, g_uni_car_parked_st);
    
        --new car
        set_pharmacy_log(l_db_object_name, '--new car');
        INSERT INTO pharm_unidose_car
            (id_unidose_car, id_car_model, dt_car_begin, id_state, dt_car_end)
        VALUES
            (seq_pharm_unidose_car.nextval, i_id_car_model, i_dt_car_begin, l_car_state, i_dt_car_end)
        RETURNING id_unidose_car INTO l_new_car_id;
    
        --new car state
        set_pharmacy_log(l_db_object_name, '--new car state');
        INSERT INTO pharm_unidose_car_state_trans
            (id_unidose_car, id_state, id_prof, dt_state)
        VALUES
            (l_new_car_id, l_car_state, i_prof.id, i_dt_car_begin);
    
        --get number of slots
        set_pharmacy_log(l_db_object_name, '--get number of slots');
        SELECT ucm.number_of_slots
          INTO l_slot_count
          FROM pharm_unidose_car_model ucm
         WHERE ucm.id_unidose_car_model = i_id_car_model;
    
        --create car slots
        set_pharmacy_log(l_db_object_name, '--create car slots');
        FOR i IN 1 .. l_slot_count
        LOOP
            INSERT INTO pharm_unidose_car_slot
                (id_unidose_car, slot_number, id_patient)
            VALUES
                (l_new_car_id, i, NULL);
        END LOOP;
    
        set_pharmacy_log(l_db_object_name, 'return l_new_car_id=' || l_new_car_id);
        RETURN l_new_car_id;
    
    EXCEPTION
        WHEN OTHERS THEN
            set_pharmacy_log(l_db_object_name, 'ERROR!: ' || SQLERRM);
            RAISE;
    END create_uni_car;

    /********************************************************************************************
    * alert.pk_pharmacy.get_grid_allowed_states
    *
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_REQ_TYPE                      IN    VARCHAR2
    * @param  I_GROUP_CODE                    IN    VARCHAR2
    *
    * @return ALERT.TABLE_NUMBER
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-02
    *
    ********************************************************************************************/
    FUNCTION get_grid_allowed_states
    (
        i_prof       IN profissional,
        i_req_type   IN drug_req.flg_type%TYPE,
        i_group_code IN VARCHAR2
    ) RETURN table_number DETERMINISTIC IS
        l_states table_number;
    BEGIN
        l_states := CASE i_group_code
                        WHEN 'GRID_1' THEN
                         get_states_for_req_type(i_prof,
                                                 i_req_type,
                                                 table_varchar(g_drd_requested_st,
                                                               g_drd_terminated_st,
                                                               g_drd_canceled_st,
                                                               g_drd_rejected_st,
                                                               g_drd_validated_st,
                                                               g_drd_waiting_approv_st,
                                                               g_drd_validated_sign_st,
                                                               g_drd_executing_st,
                                                               g_drd_rejected2pharm_st,
                                                               g_drd_rejected2prep_st,
                                                               g_drd_validated_without_wf_st))
                        WHEN 'GRID_PAT' THEN
                         get_states_for_req_type(i_prof,
                                                 i_req_type,
                                                 table_varchar(g_drd_requested_st,
                                                               g_drd_canceled_st,
                                                               g_drd_rejected_st,
                                                               g_drd_validated_st,
                                                               g_drd_waiting_approv_st,
                                                               g_drd_validated_sign_st,
                                                               g_drd_rejected2pharm_st,
                                                               g_drd_rejected2prep_st,
                                                               g_drd_validated_without_wf_st))
                        WHEN 'GRID_PAT_REPORT' THEN
                         get_states_for_req_type(i_prof,
                                                 i_req_type,
                                                 table_varchar(g_drd_requested_st,
                                                               g_drd_rejected_st,
                                                               g_drd_validated_st,
                                                               g_drd_waiting_approv_st,
                                                               g_drd_validated_sign_st,
                                                               g_drd_rejected2pharm_st,
                                                               g_drd_rejected2prep_st,
                                                               g_drd_validated_without_wf_st))
                    END;
    
        RETURN l_states;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_grid_allowed_states;

    --actions for grid by pharmacy order type
    FUNCTION get_grid_actions(i_req_type IN drug_req.flg_type%TYPE) RETURN table_number DETERMINISTIC IS
        l_actions table_number;
    BEGIN
        l_actions := CASE i_req_type
                         WHEN g_flg_adm THEN
                          g_grid_actions_adm_pat
                         WHEN g_flg_int THEN
                          g_grid_actions_int_pat
                         WHEN g_flg_unidose THEN
                          g_grid_actions_uni_pat
                         WHEN g_flg_uni_car THEN
                          g_grid_actions_uni_car
                         WHEN g_flg_aux_dev THEN
                          g_grid_actions_aux_dev
                         WHEN g_flg_aux_car THEN
                          g_grid_actions_aux_car
                     --err!!
                         ELSE
                          table_number()
                     END;
    
        RETURN l_actions;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_grid_actions;

    --get the order type (I, A, U) : for the order id or for the supply id
    FUNCTION get_req_type
    (
        i_id_drug_req_det IN drug_req_det.id_drug_req_det%TYPE DEFAULT NULL,
        i_id_drug_req_sup IN drug_req_supply.id_drug_req_supply%TYPE DEFAULT NULL
    ) RETURN drug_req.flg_type%TYPE IS
        l_req_type drug_req.flg_type%TYPE;
    BEGIN
        IF (i_id_drug_req_det IS NOT NULL)
        THEN
        
            SELECT dr.flg_type
              INTO l_req_type
              FROM drug_req_det drd, drug_req dr
             WHERE drd.id_drug_req = dr.id_drug_req
               AND drd.id_drug_req_det = i_id_drug_req_det;
        
        ELSIF (i_id_drug_req_sup IS NOT NULL)
        THEN
        
            SELECT dr.flg_type
              INTO l_req_type
              FROM drug_req_supply drs, drug_req_det drd, drug_req dr
             WHERE drs.id_drug_req_det = drd.id_drug_req_det
               AND drd.id_drug_req = dr.id_drug_req
               AND drs.id_drug_req_supply = i_id_drug_req_sup;
        
        ELSE
            raise_application_error(-20001, 'parameters cannot be both null!');
        END IF;
    
        RETURN l_req_type;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_req_type;

    FUNCTION get_prof_type(i_prof IN profissional) RETURN VARCHAR2 DETERMINISTIC IS
    BEGIN
        RETURN pk_medication_current.get_prof_cat(i_prof);
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_prof_type;

    FUNCTION get_pat_room(i_id_episode IN epis_info.id_episode%TYPE) RETURN epis_info.id_room%TYPE IS
        l_room epis_info.id_room%TYPE;
    BEGIN
        SELECT ei.id_room
          INTO l_room
          FROM epis_info ei
         WHERE ei.id_episode = i_id_episode;
    
        RETURN l_room;
    
    EXCEPTION
        WHEN OTHERS THEN
            RETURN NULL;
    END get_pat_room;

    FUNCTION get_pat_bed(i_id_episode IN epis_info.id_episode%TYPE) RETURN epis_info.id_bed%TYPE IS
        l_bed epis_info.id_bed%TYPE;
    BEGIN
        SELECT ei.id_bed
          INTO l_bed
          FROM epis_info ei
         WHERE ei.id_episode = i_id_episode;
    
        RETURN l_bed;
    
    EXCEPTION
        WHEN OTHERS THEN
            RETURN NULL;
    END get_pat_bed;

    FUNCTION get_pat_clin_record
    (
        i_lang        IN language.id_language%TYPE,
        i_patient     IN patient.id_patient%TYPE,
        i_institution IN institution.id_institution%TYPE
    ) RETURN clin_record.num_clin_record%TYPE IS
        l_ret_out BOOLEAN := FALSE;
        l_error   t_error_out;
        l_cr_num  clin_record.num_clin_record%TYPE;
    BEGIN
        l_ret_out := pk_patient.get_clin_rec(i_lang       => i_lang,
                                             i_pat        => i_patient,
                                             i_instit     => i_institution,
                                             i_pat_family => NULL,
                                             o_num        => l_cr_num,
                                             o_error      => l_error);
    
        IF (NOT l_ret_out)
        THEN
            l_cr_num := NULL;
        END IF;
    
        RETURN l_cr_num;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_pat_clin_record;

    /********************************************************************************************
    * alert.pk_pharmacy.get_prioritary_state
    *
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_DRD_ID                        IN    NUMBER(24)
    * @param  I_DRD_STATE                     IN    NUMBER(5)
    * @param  I_REQ_TYPE                      IN    VARCHAR2
    *
    * @return NUMBER(5)
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-02
    *
    ********************************************************************************************/
    FUNCTION get_prioritary_state
    (
        i_prof     profissional,
        i_drd_id   drug_req_det.id_drug_req_det%TYPE,
        i_state_id wfl_state.id_state%TYPE,
        i_req_type drug_req.flg_type%TYPE,
        i_drsd_id  drug_req_supply_dev.id_drug_req_supply_dev%TYPE DEFAULT NULL
    ) RETURN wfl_state.id_state%TYPE IS
        l_ret_state  wfl_state.id_state%TYPE;
        l_prof_type  profile_template.flg_type%TYPE := 'P';
        l_drd_id     drug_req_det.id_drug_req_det%TYPE;
        l_drsd_id    drug_req_supply_dev.id_drug_req_supply_dev%TYPE;
        l_invalid_id NUMBER(6) := -999999; --so it doesn't get any records!
    BEGIN
        --set_pharmacy_log('get_prioritary_state', '***BEGIN*** i_drd_id=' || i_drd_id || '###i_drsd_id=' || i_drsd_id);
    
        IF (in_table(i_state_id,
                     get_states_for_req_type(i_prof,
                                             i_req_type,
                                             table_varchar(g_drd_executing_st,
                                                           g_drd_terminated_st,
                                                           g_drd_rejected2prep_st))) OR
           (i_drsd_id IS NOT NULL AND i_state_id = get_state_for_req_type(i_prof, NULL, g_drs_returned_st)))
        THEN
        
            l_prof_type := get_prof_type(i_prof);
        
            IF (i_drd_id IS NULL)
            THEN
                l_drd_id := l_invalid_id;
            ELSE
                l_drd_id := i_drd_id;
            END IF;
        
            IF (i_drsd_id IS NULL OR i_req_type != g_flg_adm)
            THEN
                l_drsd_id := l_invalid_id;
            ELSE
                l_drsd_id := i_drsd_id;
            END IF;
        
            BEGIN
                SELECT v1.id_state
                  INTO l_ret_state
                  FROM (SELECT v2.id_state
                          FROM (SELECT drs.id_state
                                  FROM drug_req_supply drs
                                 WHERE drs.id_drug_req_det = l_drd_id
                                   AND drs.id_state != get_state_for_req_type(i_prof, NULL, g_drs_preparing_st)
                                UNION ALL
                                SELECT drsd.id_state
                                  FROM drug_req_supply_dev drsd
                                 WHERE drsd.id_drug_req_supply_dev = l_drsd_id) v2,
                               wfl_state s,
                               wfl_state_detail sd
                         WHERE v2.id_state = s.id_state
                           AND s.id_state = sd.state
                           AND sd.prof_type = l_prof_type
                         ORDER BY sd.rank) v1
                 WHERE rownum = 1;
            EXCEPTION
                WHEN no_data_found THEN
                    l_ret_state := i_state_id;
            END;
        ELSE
            l_ret_state := i_state_id;
        END IF;
    
        --set_pharmacy_log('get_prioritary_state', 'l_ret_state=' || l_ret_state);
    
        RETURN l_ret_state;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_prioritary_state;

    /********************************************************************************************
    * pharmacy_actions
    *
    * @param      I_LANG
    * @param      I_PROF
    * @param      I_GET_ACTION
    * @param      I_ACTIONS --actions by grid
    *
    * @return                         pharmacy actions
    *
    * @author                         Rui Marante
    * @version                        0.1
    * @since                          2009/04/06
      *********************************************************************************************/
    PROCEDURE get_pharmacy_actions
    (
        i_lang        IN language.id_language%TYPE,
        i_prof        IN profissional,
        i_get_actions IN VARCHAR2 DEFAULT 'N',
        i_actions     IN table_number,
        o_actions     OUT pk_types.cursor_type
    ) IS
        l_profile_templ profile_template.id_profile_template%TYPE;
    BEGIN
        IF (i_get_actions = g_yes)
        THEN
            BEGIN
                --24 pharmacist | 32 tec. pharm.
                SELECT ppt.id_profile_template
                  INTO l_profile_templ
                  FROM prof_profile_template ppt
                 INNER JOIN profile_template pt
                    ON (ppt.id_profile_template = pt.id_profile_template)
                 WHERE ppt.id_professional = i_prof.id
                   AND ppt.id_software = i_prof.software
                   AND ppt.id_institution = i_prof.institution
                   AND pt.id_software = i_prof.software
                   AND rownum = 1;
            EXCEPTION
                WHEN no_data_found THEN
                    l_profile_templ := NULL;
            END;
        
            --actions
            pk_medication_workflow.get_actions(i_lang    => i_lang,
                                               i_prof    => i_prof,
                                               i_profile => l_profile_templ,
                                               i_actions => i_actions,
                                               o_actions => o_actions);
        ELSE
            pk_types.open_my_cursor(o_actions);
        END IF;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_pharmacy_actions;

    /********************************************************************************************
    * get_pharmacy_headers_labels
    *
    * @param      I_LANG
    * @param      I_PROF
    * @param      I_GET_HEADERS
    * @param      I_HEADER_CODES
    *
    * @return                         pharmacy headers and labels (for grids and other screens)
    *
    * @author                         Rui Marante
    * @version                        0.1
    * @since                          2009/04/06
      *********************************************************************************************/
    PROCEDURE get_pharmacy_headers_labels
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN profissional,
        i_get_headers  IN VARCHAR2 DEFAULT 'N',
        i_header_codes IN table_varchar DEFAULT NULL,
        o_headers      OUT pk_types.cursor_type
    ) IS
        l_bool_dummy BOOLEAN;
    BEGIN
    
        IF (i_get_headers = g_yes AND i_header_codes IS NOT NULL)
        THEN
            l_bool_dummy := pk_message.get_message_array(i_lang, i_header_codes, i_prof, o_headers);
        ELSE
            pk_types.open_my_cursor(o_headers);
        END IF;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_pharmacy_headers_labels;

    PROCEDURE get_pharmacy_unidose_visions
    (
        i_lang        IN language.id_language%TYPE,
        i_prof        IN profissional,
        i_get_visions IN VARCHAR2 DEFAULT 'N',
        o_visions     OUT pk_types.cursor_type
    ) IS
        l_tbl_visions1 t_tbl_pharm_vision := t_tbl_pharm_vision();
        l_tbl_visions2 t_tbl_pharm_vision := t_tbl_pharm_vision();
        l_tbl_visions3 t_tbl_pharm_vision := t_tbl_pharm_vision();
        --
        l_i        NUMBER := 0;
        l_tbl_rows NUMBER := 0;
    BEGIN
        IF (i_get_visions = g_yes)
        THEN
        
            SELECT t_rec_pharm_vision(sd.val, NULL, sd.desc_val, NULL, 'A', sd.rank, NULL)
              BULK COLLECT
              INTO l_tbl_visions1
              FROM sys_domain sd
             WHERE sd.code_domain = 'PHARMACY_UNIDOSE_VISIONS'
               AND sd.id_language = i_lang
               AND sd.domain_owner = pk_sysdomain.k_default_schema
             ORDER BY sd.rank;
        
            --
            SELECT t_rec_pharm_vision(NULL, v1.id_parent, v1.desc_action, v1.icon, v1.flg_status, v1.rank, v1.id_action)
              BULK COLLECT
              INTO l_tbl_visions2
              FROM (SELECT DISTINCT b.id_department id_action,
                                    NULL id_parent,
                                    pk_translation.get_translation(i_lang, c.code_department) desc_action,
                                    NULL icon,
                                    'A' flg_status,
                                    99 rank
                      FROM pharm_service_allocation a
                     INNER JOIN dep_clin_serv b
                        ON (a.id_dep_clin_serv = b.id_dep_clin_serv)
                     INNER JOIN department c
                        ON (b.id_department = c.id_department)
                     WHERE a.id_prof = i_prof.id
                       AND a.id_institution = i_prof.institution
                       AND b.flg_available = g_yes
                       AND c.flg_available = g_yes
                    UNION ALL
                    SELECT 0 id_action,
                           NULL id_parent,
                           pk_message.get_message(i_lang, 'PHARMACY_UNIDOSE_VISIONS_ALL_SERVICES') desc_action,
                           NULL icon,
                           'A' flg_status,
                           98 rank
                      FROM dual
                     ORDER BY rank, desc_action) v1;
        
            --
            SELECT t_rec_pharm_vision(NULL, NULL, sd.desc_val, NULL, 'A', sd.rank, sd.val)
              BULK COLLECT
              INTO l_tbl_visions3
              FROM sys_domain sd
             WHERE sd.code_domain = 'PHARMACY_UNIDOSE_VISIONS_2'
               AND sd.id_language = i_lang
               AND sd.domain_owner = pk_sysdomain.k_default_schema
             ORDER BY sd.rank;
        
            --
            l_tbl_rows := l_tbl_visions1.count;
            l_i        := l_tbl_rows;
            FOR i IN 1 .. l_tbl_rows
            LOOP
                FOR j IN 1 .. l_tbl_visions2.count
                LOOP
                    l_tbl_visions1.extend(1);
                    l_i := l_i + 1;
                    l_tbl_visions1(l_i) := t_rec_pharm_vision(l_i,
                                                              l_tbl_visions1(i).id_action,
                                                              l_tbl_visions2(j).desc_action,
                                                              NULL,
                                                              'A',
                                                              l_tbl_visions2(j).rank,
                                                              l_tbl_visions1(i)
                                                              .id_action || '|' || l_tbl_visions2(j).xinfo);
                END LOOP;
            END LOOP;
        
            l_tbl_rows := l_tbl_visions1.count;
            l_i        := l_tbl_rows;
            FOR i IN 1 .. l_tbl_rows
            LOOP
                IF (l_tbl_visions1(i).id_parent = 3)
                THEN
                    FOR j IN 1 .. l_tbl_visions3.count
                    LOOP
                        l_tbl_visions1.extend(1);
                        l_i := l_i + 1;
                        l_tbl_visions1(l_i) := t_rec_pharm_vision(l_i,
                                                                  l_tbl_visions1(i).id_action,
                                                                  l_tbl_visions3(j).desc_action,
                                                                  NULL,
                                                                  'A',
                                                                  l_tbl_visions3(j).rank,
                                                                  l_tbl_visions1(i)
                                                                  .xinfo || '|' || l_tbl_visions3(j).xinfo);
                    END LOOP;
                END IF;
            END LOOP;
        
            OPEN o_visions FOR
                SELECT *
                  FROM TABLE(l_tbl_visions1) t;
        
        ELSE
            pk_types.open_my_cursor(o_visions);
        END IF;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_pharmacy_unidose_visions;

    FUNCTION get_shortcut
    (
        i_lang          IN language.id_language%TYPE,
        i_prof          IN alert.profissional,
        i_shortcut_name IN sys_shortcut.intern_name%TYPE
    ) RETURN sys_shortcut.id_sys_shortcut%TYPE DETERMINISTIC IS
        l_shortcut sys_shortcut.id_sys_shortcut%TYPE;
    BEGIN
        BEGIN
            SELECT v1.id_sys_shortcut
              INTO l_shortcut
              FROM (SELECT s.id_sys_shortcut
                      FROM sys_shortcut s
                     WHERE s.intern_name = i_shortcut_name
                       AND s.id_software = i_prof.software
                       AND s.id_institution IN (0, i_prof.institution)
                     ORDER BY s.id_institution DESC) v1
             WHERE rownum = 1;
        EXCEPTION
            WHEN no_data_found THEN
                l_shortcut := NULL;
        END;
    
        RETURN l_shortcut;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_shortcut;

    FUNCTION get_pat_bed_dcs
    (
        i_lang    IN language.id_language%TYPE,
        i_prof    IN alert.profissional,
        i_episode IN drug_req.id_episode%TYPE,
        i_patient IN patient.id_patient%TYPE
    ) RETURN dep_clin_serv.id_dep_clin_serv%TYPE IS
        l_id_dep_clin_serv dep_clin_serv.id_dep_clin_serv%TYPE := NULL;
        l_desc             pk_translation.t_desc_translation := NULL;
        l_bed              bed.id_bed%TYPE;
        l_cursor           pk_types.cursor_type;
        l_error            t_error_out;
        l_ret              BOOLEAN := FALSE;
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'get_pat_bed_dcs';
    BEGIN
        g_error := 'GET_PAT_BED';
        l_bed   := get_pat_bed(i_id_episode => i_episode);
    
        g_error := 'PK_BMNG.GET_BED_DEP_CLIN_SERV';
        l_ret   := pk_bmng.get_bed_dep_clin_serv(i_lang  => i_lang,
                                                 i_prof  => i_prof,
                                                 i_bed   => l_bed,
                                                 o_dcs   => l_cursor,
                                                 o_error => l_error);
    
        IF (l_ret AND l_cursor%ISOPEN)
        THEN
            FETCH l_cursor
                INTO l_id_dep_clin_serv, l_desc;
            CLOSE l_cursor;
        END IF;
    
        set_pharmacy_log(l_db_object_name,
                         'l_bed=' || l_bed || ' l_id_dep_clin_serv=' || l_id_dep_clin_serv || ' l_desc=' || l_desc);
    
        RETURN l_id_dep_clin_serv;
    
    EXCEPTION
        WHEN OTHERS THEN
            IF (l_cursor%ISOPEN)
            THEN
                CLOSE l_cursor;
            END IF;
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, l_error);
            RAISE;
    END;

    PROCEDURE create_req_pharm_adm
    (
        i_lang                  IN language.id_language%TYPE,
        i_episode               IN drug_req.id_episode%TYPE,
        i_patient               IN patient.id_patient%TYPE,
        i_prof                  IN alert.profissional,
        i_drug_presc_det        IN alert.table_number,
        i_drug                  IN alert.table_varchar,
        i_version               IN drug_req_det.vers%TYPE,
        i_qty_req               IN alert.table_number,
        i_unit_measure          IN alert.table_number,
        i_notes                 IN alert.table_varchar,
        i_dispense              IN alert.table_number DEFAULT alert.table_number(),
        i_unit_measure_dispense IN alert.table_number DEFAULT alert.table_number(),
        i_datetime              IN drug_req_det.dt_last_change%TYPE,
        o_id_drug_req_det       OUT alert.table_number,
        o_error                 OUT t_error_out
    ) IS
        l_justify               mi_med.flg_justify%TYPE;
        l_id_room               drug_req.id_room%TYPE := NULL;
        l_next                  drug_req.id_drug_req%TYPE;
        l_next_det              drug_req_det.id_drug_req_det%TYPE;
        l_dpd_previous_status   drug_presc_det.flg_status%TYPE;
        l_drug_type             drug_presc_det.flg_take_type%TYPE;
        l_rowids                table_varchar;
        l_dispense              NUMBER;
        l_unit_measure_dispense NUMBER;
        l_id_drug_req_det       table_number := table_number();
        l_drug_count            NUMBER := 0;
        l_id_presc_instr_det    drug_req_det.id_presc_directions%TYPE;
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'create_req_pharm_adm';
    BEGIN
        g_error := 'GET ROOM';
        set_pharmacy_log(l_db_object_name, g_error);
        l_id_room := get_pat_room(i_episode);
    
        FOR i IN 1 .. i_drug.count
        LOOP
        
            IF (i_drug(i) IS NOT NULL)
            THEN
            
                -- *********************************
                -- PT 26/09/2008 2.4.3.d
                g_error := 'GET NEXT DRUG_REQ ID';
                l_next  := ts_drug_req.next_key();
            
                g_error := 'INSERT INTO DRUG_REQ';
                ts_drug_req.ins(id_drug_req_in       => l_next,
                                dt_drug_req_tstz_in  => i_datetime,
                                id_episode_in        => i_episode,
                                id_patient_in        => i_patient,
                                id_prof_req_in       => i_prof.id,
                                flg_status_in        => g_flg_temp,
                                dt_begin_tstz_in     => i_datetime,
                                id_room_in           => l_id_room,
                                flg_type_in          => g_flg_adm,
                                id_drug_presc_det_in => i_drug_presc_det(i),
                                rows_out             => l_rowids);
            
                t_data_gov_mnt.process_insert(i_lang       => i_lang,
                                              i_prof       => i_prof,
                                              i_table_name => 'DRUG_REQ',
                                              i_rowids     => l_rowids,
                                              o_error      => o_error);
                -- *********************************
            
                -- *****************************************************************************************
                -- PRESCRIPTION
                SELECT dpd.flg_status
                  INTO l_dpd_previous_status
                  FROM drug_presc_det dpd
                 WHERE dpd.id_drug_presc_det = i_drug_presc_det(i);
            
                --update prescription status
                UPDATE drug_presc_det dpd
                   SET dpd.flg_status     = pk_prescription_int.g_presc_det_req_hosp,
                       dpd.dt_last_change = current_timestamp
                 WHERE dpd.id_drug_presc_det = i_drug_presc_det(i);
            
                --history
                set_pharmacy_log(l_db_object_name, 'history');
                IF NOT pk_prescription_int.create_presc_hist(i_lang         => i_lang,
                                                             i_prof         => i_prof,
                                                             i_id_episode   => NULL,
                                                             i_type         => pk_medication_core.g_local,
                                                             i_begin_status => l_dpd_previous_status,
                                                             i_end_status   => pk_prescription_int.g_presc_det_req_hosp,
                                                             i_id_presc     => i_drug_presc_det(i),
                                                             o_error        => o_error)
                THEN
                    raise_application_error(-20001, o_error.ora_sqlerrm);
                END IF;
                -- *****************************************************************************************
            
                -- dispense can be table_number() --empty!! so.. null!
                BEGIN
                    l_dispense              := i_dispense(i);
                    l_unit_measure_dispense := i_unit_measure_dispense(i);
                EXCEPTION
                    WHEN OTHERS THEN
                        l_dispense              := NULL;
                        l_unit_measure_dispense := NULL;
                END;
            
                g_error := 'OPEN C_JUSTIFY';
                set_pharmacy_log(l_db_object_name, g_error);
                BEGIN
                    SELECT mm.flg_justify
                      INTO l_justify
                      FROM mi_med mm
                     WHERE mm.id_drug = i_drug(i)
                       AND mm.vers = i_version;
                EXCEPTION
                    WHEN no_data_found THEN
                        l_justify := NULL; --no justification
                END;
            
                SELECT seq_drug_req_det.nextval
                  INTO l_next_det
                  FROM dual;
            
                l_drug_type := pk_medication_core.check_int_drug_type(i_lang, i_prof, i_drug_presc_det(i), o_error);
            
                SELECT dpd.id_presc_directions
                  INTO l_id_presc_instr_det
                  FROM drug_presc_det dpd
                 WHERE dpd.id_drug_presc_det = i_drug_presc_det(i);
            
                g_error := 'INSERT DRUG REQUISITION DET';
                set_pharmacy_log(l_db_object_name, g_error);
                IF (l_drug_type = pk_prescription_int.g_type_other_product)
                THEN
                
                    INSERT INTO drug_req_det
                        (id_drug_req_det,
                         id_drug_req,
                         qty_req,
                         id_unit_measure,
                         flg_status,
                         notes,
                         flg_ci,
                         flg_cheaper,
                         flg_justif,
                         flg_interac_med,
                         flg_interac_allergy,
                         pharmacist_validation,
                         vers,
                         id_prof_last_change,
                         id_sw_last_change,
                         id_inst_last_change,
                         dt_last_change,
                         id_other_product,
                         id_state,
                         dispense,
                         unit_measure_dispense,
                         id_presc_directions)
                    VALUES
                        (l_next_det,
                         l_next,
                         i_qty_req(i),
                         i_unit_measure(i),
                         g_det_req,
                         i_notes(i),
                         g_no,
                         g_no,
                         l_justify,
                         g_no,
                         g_no,
                         g_no,
                         i_version,
                         i_prof.id,
                         i_prof.software,
                         i_prof.institution,
                         i_datetime,
                         i_drug(i),
                         get_state_for_req_type(i_prof, g_flg_adm, g_drd_requested_st),
                         l_dispense,
                         l_unit_measure_dispense,
                         l_id_presc_instr_det);
                
                ELSE
                    INSERT INTO drug_req_det
                        (id_drug_req_det,
                         id_drug_req,
                         id_drug,
                         qty_req,
                         id_unit_measure,
                         flg_status,
                         notes,
                         flg_ci,
                         flg_cheaper,
                         flg_justif,
                         flg_interac_med,
                         flg_interac_allergy,
                         pharmacist_validation,
                         vers,
                         id_prof_last_change,
                         id_sw_last_change,
                         id_inst_last_change,
                         dt_last_change,
                         id_state,
                         dispense,
                         unit_measure_dispense,
                         id_presc_directions)
                    VALUES
                        (l_next_det,
                         l_next,
                         i_drug(i),
                         i_qty_req(i),
                         i_unit_measure(i),
                         g_det_req,
                         i_notes(i),
                         g_no,
                         g_no,
                         l_justify,
                         g_no,
                         g_no,
                         g_no,
                         i_version,
                         i_prof.id,
                         i_prof.software,
                         i_prof.institution,
                         i_datetime,
                         get_state_for_req_type(i_prof, g_flg_adm, g_drd_requested_st),
                         l_dispense,
                         l_unit_measure_dispense,
                         l_id_presc_instr_det);
                
                END IF;
            
                --state history
                INSERT INTO drug_req_det_state_transition
                    (id_drug_req_det, id_state, id_prof, dt_state, notes1)
                VALUES
                    (l_next_det,
                     get_state_for_req_type(i_prof, g_flg_adm, g_drd_requested_st),
                     i_prof.id,
                     i_datetime,
                     i_notes(i));
            
                --output parameter
                l_drug_count := l_drug_count + 1;
                l_id_drug_req_det.extend(1);
                l_id_drug_req_det(l_drug_count) := l_next_det;
            
                g_error := 'CALL TO SET_WARNINGS';
                set_pharmacy_log(l_db_object_name, g_error);
                IF NOT pk_prescription_warnings.set_warnings(i_lang          => i_lang,
                                                             i_prof          => i_prof,
                                                             i_patient       => i_patient,
                                                             i_episode       => i_episode,
                                                             i_subject       => pk_medication_core.g_hospital,
                                                             i_presc         => table_number(l_next_det),
                                                             i_choice        => g_yes,
                                                             i_type          => 'I',
                                                             i_set_attention => NULL,
                                                             o_error         => o_error)
                THEN
                    raise_application_error(-20001, g_error);
                END IF;
            
            END IF;
        
        END LOOP;
    
        o_id_drug_req_det := l_id_drug_req_det;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END create_req_pharm_adm;

    PROCEDURE create_req_pharm_int
    (
        i_lang                  IN language.id_language%TYPE,
        i_episode               IN drug_req.id_episode%TYPE,
        i_patient               IN patient.id_patient%TYPE,
        i_prof                  IN alert.profissional,
        i_drug_presc_det        IN alert.table_number,
        i_drug                  IN alert.table_varchar,
        i_version               IN drug_req_det.vers%TYPE,
        i_qty_req               IN alert.table_number,
        i_unit_measure          IN alert.table_number,
        i_notes                 IN alert.table_varchar,
        i_dispense              IN alert.table_number DEFAULT alert.table_number(),
        i_unit_measure_dispense IN alert.table_number DEFAULT alert.table_number(),
        i_datetime              IN drug_req_det.dt_last_change%TYPE,
        --ALERT-133630
        i_refill             IN table_varchar DEFAULT table_varchar(),
        i_flg_first_dose     IN table_varchar DEFAULT table_varchar(),
        i_package_number     IN table_varchar DEFAULT table_varchar(),
        i_expiration_date    IN table_varchar DEFAULT table_varchar(),
        i_flg_dispense_as_is IN table_varchar DEFAULT table_varchar(),
        --
        o_id_drug_req_det OUT alert.table_number,
        o_error           OUT t_error_out
    ) IS
        l_justify               mi_med.flg_justify%TYPE;
        l_next                  drug_req.id_drug_req%TYPE;
        l_next_det              drug_req_det.id_drug_req_det%TYPE;
        l_drug_type             drug_presc_det.flg_take_type%TYPE;
        l_found                 BOOLEAN := FALSE;
        l_rowids                table_varchar;
        l_dispense              NUMBER;
        l_unit_measure_dispense NUMBER;
        l_id_drug_req_det       table_number := table_number();
        l_drug_count            NUMBER := 0;
        l_id_presc_instr_det    drug_presc_det.id_presc_directions%TYPE;
        l_qty_req               drug_req_det.qty_req%TYPE := NULL;
        l_unit_measure          drug_req_det.id_unit_measure%TYPE := NULL;
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'create_req_pharm_int';
        l_has_takes VARCHAR2(1 CHAR) := g_no;
        --
        l_refill               drug_req_det.refill%TYPE;
        l_flg_first_dose       drug_req_det.first_dose%TYPE;
        l_package_number       drug_req_det.package_number%TYPE;
        l_expiration_date      VARCHAR2(200 CHAR);
        l_expiration_date_tstz drug_req_det.dt_expire_tstz%TYPE;
        l_flg_dispense_as_is   drug_req_det.generico%TYPE;
        --
        FUNCTION get_value
        (
            i_tbl     IN table_varchar,
            i_index   IN NUMBER,
            i_default IN VARCHAR2
        ) RETURN VARCHAR2 IS
            l_value VARCHAR2(1000 CHAR);
        BEGIN
            BEGIN
                l_value := nvl(i_tbl(i_index), i_default);
            EXCEPTION
                WHEN OTHERS THEN
                    l_value := i_default;
            END;
        
            RETURN l_value;
        
        EXCEPTION
            WHEN OTHERS THEN
                RAISE;
        END get_value;
        --
    BEGIN
    
        g_error := 'verifica se existe alguma receita temp neste episodio';
        set_pharmacy_log(l_db_object_name, g_error);
        BEGIN
            l_found := TRUE;
        
            SELECT dr.id_drug_req
              INTO l_next
              FROM drug_req dr
             WHERE dr.id_episode = i_episode
               AND dr.flg_status = g_flg_temp
               AND dr.flg_type = g_flg_int
               AND rownum = 1;
        EXCEPTION
            WHEN no_data_found THEN
                l_found := FALSE;
            WHEN OTHERS THEN
                raise_application_error(-20001, SQLERRM);
        END;
    
        IF (NOT l_found)
        THEN
            -- *********************************
            -- PT 26/09/2008 2.4.3.d
            g_error := 'GET NEXT DRUG_REQ ID';
            set_pharmacy_log(l_db_object_name, g_error);
            l_next := ts_drug_req.next_key();
        
            g_error := 'INSERT INTO DRUG_REQ';
            set_pharmacy_log(l_db_object_name, g_error);
            ts_drug_req.ins(id_drug_req_in      => l_next,
                            dt_drug_req_tstz_in => i_datetime,
                            id_episode_in       => i_episode,
                            id_patient_in       => i_patient,
                            id_prof_req_in      => i_prof.id,
                            flg_status_in       => g_flg_temp,
                            dt_begin_tstz_in    => i_datetime,
                            id_room_in          => NULL,
                            flg_type_in         => g_flg_int,
                            rows_out            => l_rowids);
        
            t_data_gov_mnt.process_insert(i_lang       => i_lang,
                                          i_prof       => i_prof,
                                          i_table_name => 'DRUG_REQ',
                                          i_rowids     => l_rowids,
                                          o_error      => o_error);
            -- *********************************
        END IF;
    
        FOR i IN 1 .. i_drug.count
        LOOP
        
            IF (i_drug(i) IS NOT NULL)
            THEN
            
                -- dispense can be table_number() --empty!! so.. null!
                BEGIN
                    l_dispense              := i_dispense(i);
                    l_unit_measure_dispense := i_unit_measure_dispense(i);
                EXCEPTION
                    WHEN OTHERS THEN
                        l_dispense              := NULL;
                        l_unit_measure_dispense := NULL;
                END;
            
                g_error := 'OPEN C_JUSTIFY';
                set_pharmacy_log(l_db_object_name, g_error);
                BEGIN
                    SELECT mm.flg_justify
                      INTO l_justify
                      FROM mi_med mm
                     WHERE mm.id_drug = i_drug(i)
                       AND mm.vers = i_version;
                EXCEPTION
                    WHEN no_data_found THEN
                        l_justify := NULL;
                END;
            
                SELECT seq_drug_req_det.nextval
                  INTO l_next_det
                  FROM dual;
            
                BEGIN
                    l_drug_type := pk_medication_core.check_int_drug_type(i_lang, i_prof, i_drug_presc_det(i), o_error);
                EXCEPTION
                    WHEN OTHERS THEN
                        l_drug_type := NULL;
                END;
            
                g_error := 'calc_takes_and_dispense';
                calc_takes_and_dispense(i_lang                   => i_lang,
                                        i_prof                   => i_prof,
                                        i_id_presc_instr_det     => NULL, --TBD: este parametro sera passado quando a medicacao alterar a forma de criacao de receitas!!
                                        i_drug                   => i_drug(i),
                                        i_version                => i_version,
                                        i_flg_type               => g_flg_int,
                                        i_do_auto_dispense_calc  => g_yes,
                                        io_qty_req               => l_qty_req,
                                        io_unit_measure          => l_unit_measure,
                                        io_dispense              => l_dispense,
                                        io_unit_measure_dispense => l_unit_measure_dispense,
                                        o_has_takes              => l_has_takes,
                                        o_error                  => o_error);
            
                --
                l_refill             := get_value(i_refill, i, NULL);
                l_flg_first_dose     := get_value(i_flg_first_dose, i, g_no);
                l_package_number     := get_value(i_package_number, i, NULL);
                l_expiration_date    := get_value(i_expiration_date, i, NULL);
                l_flg_dispense_as_is := get_value(i_flg_dispense_as_is, i, g_no);
            
                IF (l_expiration_date IS NOT NULL)
                THEN
                    l_expiration_date_tstz := pk_date_utils.get_string_tstz(i_lang, i_prof, l_expiration_date, NULL);
                ELSE
                    l_expiration_date_tstz := NULL;
                END IF;
                --
            
                g_error := 'INSERT DRUG REQUISITION DET';
                set_pharmacy_log(l_db_object_name, g_error);
                IF (l_drug_type = pk_prescription_int.g_type_other_product)
                THEN
                
                    INSERT INTO drug_req_det
                        (id_drug_req_det,
                         id_drug_req,
                         qty_req,
                         id_unit_measure,
                         flg_status,
                         flg_ci,
                         flg_cheaper,
                         flg_justif,
                         flg_interac_med,
                         flg_interac_allergy,
                         pharmacist_validation,
                         vers,
                         id_prof_last_change,
                         id_sw_last_change,
                         id_inst_last_change,
                         dt_last_change,
                         id_other_product,
                         id_state,
                         dispense,
                         unit_measure_dispense,
                         notes,
                         refill,
                         package_number,
                         dt_expire_tstz,
                         first_dose,
                         generico)
                    VALUES
                        (l_next_det,
                         l_next,
                         i_qty_req(i),
                         i_unit_measure(i),
                         g_flg_temp,
                         g_no,
                         g_no,
                         l_justify,
                         g_no,
                         g_no,
                         g_no,
                         i_version,
                         i_prof.id,
                         i_prof.software,
                         i_prof.institution,
                         i_datetime,
                         i_drug(i),
                         get_state_for_req_type(i_prof, g_flg_int, g_drd_temporary_st),
                         l_dispense,
                         l_unit_measure_dispense,
                         i_notes(i),
                         l_refill,
                         l_package_number,
                         l_expiration_date_tstz,
                         l_flg_first_dose,
                         l_flg_dispense_as_is);
                
                ELSE
                    INSERT INTO drug_req_det
                        (id_drug_req_det,
                         id_drug_req,
                         id_drug,
                         qty_req,
                         id_unit_measure,
                         flg_status,
                         flg_ci,
                         flg_cheaper,
                         flg_justif,
                         flg_interac_med,
                         flg_interac_allergy,
                         pharmacist_validation,
                         vers,
                         id_prof_last_change,
                         id_sw_last_change,
                         id_inst_last_change,
                         dt_last_change,
                         id_state,
                         dispense,
                         unit_measure_dispense,
                         notes,
                         refill,
                         package_number,
                         dt_expire_tstz,
                         first_dose,
                         generico)
                    VALUES
                        (l_next_det,
                         l_next,
                         i_drug(i),
                         i_qty_req(i),
                         i_unit_measure(i),
                         g_flg_temp,
                         g_no,
                         g_no,
                         l_justify,
                         g_no,
                         g_no,
                         g_no,
                         i_version,
                         i_prof.id,
                         i_prof.software,
                         i_prof.institution,
                         i_datetime,
                         get_state_for_req_type(i_prof, g_flg_int, g_drd_temporary_st),
                         l_dispense,
                         l_unit_measure_dispense,
                         i_notes(i),
                         l_refill,
                         l_package_number,
                         l_expiration_date_tstz,
                         l_flg_first_dose,
                         l_flg_dispense_as_is);
                
                END IF;
            
                g_error := 'transferncia de informao entre episdios da mesma visita';
                set_pharmacy_log(l_db_object_name, g_error);
                IF NOT t_ti_log.ins_log(i_lang,
                                        i_prof,
                                        i_episode,
                                        'TX',
                                        l_next_det,
                                        pk_medication_core.g_ti_log_mh,
                                        o_error)
                THEN
                    raise_application_error(-20001, o_error.ora_sqlerrm);
                END IF;
            
                --state history
                INSERT INTO drug_req_det_state_transition
                    (id_drug_req_det, id_state, id_prof, dt_state, notes1)
                VALUES
                    (l_next_det,
                     get_state_for_req_type(i_prof, g_flg_int, g_drd_temporary_st),
                     i_prof.id,
                     i_datetime,
                     i_notes(i));
            
                --output parameter
                l_drug_count := l_drug_count + 1;
                l_id_drug_req_det.extend(1);
                l_id_drug_req_det(l_drug_count) := l_next_det;
            
                g_error := 'CALL TO SET_WARNINGS';
                set_pharmacy_log(l_db_object_name, g_error);
                IF NOT pk_prescription_warnings.set_warnings(i_lang          => i_lang,
                                                             i_prof          => i_prof,
                                                             i_patient       => i_patient,
                                                             i_episode       => i_episode,
                                                             i_subject       => pk_medication_core.g_hospital,
                                                             i_presc         => table_number(l_next_det),
                                                             i_choice        => g_yes,
                                                             i_type          => 'I',
                                                             i_set_attention => NULL,
                                                             o_error         => o_error)
                THEN
                    raise_application_error(-20001, g_error);
                END IF;
            
            END IF;
        
        END LOOP;
    
        o_id_drug_req_det := l_id_drug_req_det;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END create_req_pharm_int;

    /*
    esta funo verifica se o paciente tinha gaveta atribuida no carro do dia anterior e se tinha, tenta
    colocar as requisies nas mesmas gavetas, se for possivel (pode no ser.. a gaveta pode estar j ocupada)
    */
    --ALERT-54467
    PROCEDURE set_pat_slot_persistence
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN alert.profissional,
        i_patient      IN patient.id_patient%TYPE,
        i_car_model    IN pharm_unidose_req_gen_car.id_car_model%TYPE,
        i_car_id       IN pharm_unidose_car.id_unidose_car%TYPE,
        i_dt_req       IN pharm_unidose_car.dt_car_begin%TYPE,
        i_drug_req_det IN drug_req_det.id_drug_req_det%TYPE,
        i_episode      IN episode.id_episode%TYPE,
        i_flg_use_bed  IN VARCHAR2 DEFAULT 'Y'
    ) IS
        l_dt_car_day_before            pharm_unidose_car.dt_car_begin%TYPE;
        l_slot_numbers                 table_number := table_number(); -- pharm_unidose_car_slot.slot_number%type;
        l_patient_bed                  pk_translation.t_desc_translation;
        l_patient_bed_number           NUMBER := NULL;
        l_slot_allocation_ok           BOOLEAN := FALSE;
        l_flg_allocation_by_bed_number sys_config.value%TYPE;
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'set_pat_slot_persistence';
    
        --ALERT-54467 (see comments)
        FUNCTION extract_bed_number(i2_bed_desc IN VARCHAR2) RETURN NUMBER IS
            l_bed_number NUMBER := NULL;
        BEGIN
            IF (i2_bed_desc IS NOT NULL)
            THEN
                --try to extract a number from the bed description
                SELECT regexp_replace(i2_bed_desc, '[^0-9]')
                  INTO l_bed_number
                  FROM dual;
            
                set_pharmacy_log('extract_bed_number', 'l_bed_number=' || l_bed_number);
            END IF;
        
            RETURN l_bed_number;
        
        EXCEPTION
            WHEN OTHERS THEN
                RETURN NULL;
        END extract_bed_number;
    
        --slot allocation
        FUNCTION chk_if_slot_free_and_allocate
        (
            i2_patient IN patient.id_patient%TYPE,
            i2_car_id  IN pharm_unidose_car.id_unidose_car%TYPE,
            i2_slot    IN pharm_unidose_car_slot.slot_number%TYPE
        ) RETURN BOOLEAN IS
            l_count NUMBER := 0;
        BEGIN
            UPDATE pharm_unidose_car_slot ucs
               SET ucs.id_patient = i2_patient
             WHERE ucs.id_unidose_car = i2_car_id
               AND ucs.slot_number = i2_slot
               AND (ucs.id_patient IS NULL -- free slot
                   OR ucs.id_patient = i2_patient)
            RETURNING COUNT(1) INTO l_count;
        
            RETURN(l_count = 1);
        
        EXCEPTION
            WHEN OTHERS THEN
                RAISE;
        END chk_if_slot_free_and_allocate;
        --
    BEGIN
        g_error                        := 'GET SYS CONFIGS';
        l_flg_allocation_by_bed_number := nvl(pk_sysconfig.get_config(i_code_cf => 'PHARMACY_UNI_AUTOMATIC_BED_TO_SLOT_ALLOCATION',
                                                                      i_prof    => i_prof),
                                              g_yes);
    
        IF (i_flg_use_bed = g_yes AND l_flg_allocation_by_bed_number = g_yes)
        THEN
            g_error       := 'GET PATIENT BED';
            l_patient_bed := get_pat_location(i_lang       => i_lang,
                                              i_prof       => i_prof,
                                              i_id_episode => i_episode,
                                              i_id_patient => i_patient,
                                              i_dept_serv  => 'BED');
        
            l_patient_bed_number := extract_bed_number(l_patient_bed);
        END IF;
    
        IF (l_patient_bed_number IS NOT NULL)
        THEN
        
            l_slot_allocation_ok := chk_if_slot_free_and_allocate(i_patient, i_car_id, l_patient_bed_number);
        
            IF (l_slot_allocation_ok)
            THEN
                INSERT INTO pharm_unidose_slot_content usc
                    (id_unidose_car, slot_number, id_drug_req_det)
                VALUES
                    (i_car_id, l_patient_bed_number, i_drug_req_det);
            
                set_pharmacy_log(l_db_object_name,
                                 'slot persistence OK! (by bed number) id_drug_req_det=' || i_drug_req_det);
            
                update_unidose_car_state(i_lang => i_lang, i_prof => i_prof, i_id_unidose_car => i_car_id);
            END IF;
        
        ELSE
            --patient allocation based on the day before
            g_error             := 'DATE UNIDOSE CAR DAY BEFORE';
            l_dt_car_day_before := (i_dt_req - 1);
        
            --if no rows, raise.. (OK)
            SELECT ucs.slot_number
              BULK COLLECT
              INTO l_slot_numbers -- N slots (possibly)
              FROM pharm_unidose_car uc
              LEFT JOIN pharm_unidose_car_slot ucs
                ON (uc.id_unidose_car = ucs.id_unidose_car)
             WHERE uc.id_car_model = i_car_model
               AND to_char(uc.dt_car_begin, 'YYYYMMDD') = to_char(l_dt_car_day_before, 'YYYYMMDD')
               AND ucs.id_patient = i_patient;
        
            FOR s IN 1 .. l_slot_numbers.count
            LOOP
                IF (chk_if_slot_free_and_allocate(i_patient, i_car_id, l_slot_numbers(s)))
                THEN
                    BEGIN
                        INSERT INTO pharm_unidose_slot_content usc
                            (id_unidose_car, slot_number, id_drug_req_det)
                        VALUES
                            (i_car_id, l_slot_numbers(s), i_drug_req_det);
                    
                        set_pharmacy_log(l_db_object_name,
                                         'slot persistence OK! (by history) id_drug_req_det=' || i_drug_req_det);
                    
                        update_unidose_car_state(i_lang => i_lang, i_prof => i_prof, i_id_unidose_car => i_car_id);
                    
                        l_slot_allocation_ok := TRUE;
                    
                        EXIT; --OK, so exit
                    
                    EXCEPTION
                        WHEN dup_val_on_index THEN
                            l_slot_allocation_ok := FALSE; --the slot is not empty, try another slot!
                        WHEN OTHERS THEN
                            l_slot_allocation_ok := FALSE;
                    END;
                END IF;
            END LOOP;
        END IF;
    
        IF (l_slot_allocation_ok = FALSE)
        THEN
            --slot allocation has failed, so allocate this order to the car (not to a slot but to the car itself)
            INSERT INTO pharm_unidose_car_content ucc
                (id_unidose_car, id_drug_req_det)
            VALUES
                (i_car_id, i_drug_req_det);
        
            update_unidose_car_state(i_lang => i_lang, i_prof => i_prof, i_id_unidose_car => i_car_id);
        END IF;
    
    EXCEPTION
        WHEN OTHERS THEN
            --any error, continue without slot persistence
            set_pharmacy_log(l_db_object_name, 'id_drug_req_det=' || i_drug_req_det || ' error=' || SQLERRM);
    END set_pat_slot_persistence;

    /**
    * This procedure returns the quantity to dispense and the respective units
    *
    * @param i_drug           Drug to convert.
    * @param i_version        Version of the drug database.
    * @param i_dosis_qty      Quantity of requested dosis.
    * @param i_dosis_unit     Unit of requested dosis.
    * @param o_dispense_qty   Quantity of dosage to dispense.
    * @param o_dispense_unit  Unit of dosage to dispense.
    *
    * @return boolean
    *
    * @author   Fbio Oliveira
    * @version  2.5.0.7
    * @since    2009/11/05
    */
    PROCEDURE get_dispense_qty
    (
        i_drug          IN drug_req_det.id_drug%TYPE,
        i_version       IN mi_med.vers%TYPE,
        i_dosis_qty     IN NUMBER,
        i_dosis_unit    IN unit_measure.id_unit_measure%TYPE,
        o_dispense_qty  OUT NUMBER,
        o_dispense_unit OUT unit_measure.id_unit_measure%TYPE
    ) IS
        l_dosage_unit       unit_measure.id_unit_measure%TYPE;
        l_dosage_qty        NUMBER(24, 4);
        l_dosage_denom_unit unit_measure.id_unit_measure%TYPE;
        l_dosage_denom_qty  NUMBER(24, 4);
        l_package_unit      unit_measure.id_unit_measure%TYPE;
        l_package_qty       NUMBER(24, 4);
        l_flg_fractionable  mi_med_dosage.flg_fractionable%TYPE;
    
        l_normalized_dosis_qty   NUMBER(24, 4);
        l_normalized_dosis_unit  unit_measure.id_unit_measure%TYPE;
        l_normalized_dosage_qty  NUMBER(24, 4);
        l_normalized_dosage_unit unit_measure.id_unit_measure%TYPE;
    
        l_dispense_unit unit_measure.id_unit_measure%TYPE;
    
        l_error t_error_out;
        l_ret   BOOLEAN;
    
        PROCEDURE get_dosage_info
        (
            i_drug              IN mi_med_dosage.id_drug%TYPE,
            i_version           IN mi_med_dosage.version%TYPE,
            o_dosage_qty        OUT NUMBER,
            o_dosage_unit       OUT unit_measure.id_unit_measure%TYPE,
            o_dosage_denom_qty  OUT NUMBER,
            o_dosage_denom_unit OUT unit_measure.id_unit_measure%TYPE,
            o_package_qty       OUT NUMBER,
            o_package_unit      OUT unit_measure.id_unit_measure%TYPE,
            o_flg_fractionable  OUT VARCHAR2,
            o_dispense_unit     OUT NUMBER
        ) IS
        BEGIN
            SELECT mmd.qty_dosage_numer,
                   mmd.id_unit_dosage_numer,
                   mmd.qty_dosage_denom,
                   mmd.id_unit_dosage_denom,
                   mmd.qty_emb,
                   mmd.id_unit_emb,
                   mmd.flg_fractionable,
                   mmd.id_unit_dispense
              INTO o_dosage_qty,
                   o_dosage_unit,
                   o_dosage_denom_qty,
                   o_dosage_denom_unit,
                   o_package_qty,
                   o_package_unit,
                   o_flg_fractionable,
                   o_dispense_unit
              FROM mi_med_dosage mmd
             WHERE mmd.id_drug = i_drug
               AND mmd.version = i_version;
        END get_dosage_info;
    
        FUNCTION get_dispense_qty
        (
            i_dosis_qty        IN NUMBER,
            i_dosis_unit       IN unit_measure.id_unit_measure%TYPE,
            i_dosage_qty       IN NUMBER,
            i_dosage_unit      IN unit_measure.id_unit_measure%TYPE,
            i_flg_fractionable IN VARCHAR2
        ) RETURN NUMBER IS
            l_dispense_qty   NUMBER(24, 4);
            l_fraction_part  NUMBER(24, 4);
            l_normalized_qty NUMBER(24, 4);
        BEGIN
            l_normalized_qty := pk_unit_measure.get_unit_mea_conversion(i_value         => i_dosis_qty,
                                                                        i_unit_meas     => i_dosis_unit,
                                                                        i_unit_meas_def => i_dosage_unit);
            l_dispense_qty   := l_normalized_qty / i_dosage_qty;
            l_fraction_part  := l_dispense_qty - floor(l_dispense_qty);
        
            IF (l_fraction_part != 0.0)
            THEN
                IF (i_flg_fractionable = g_yes)
                THEN
                
                    IF (l_fraction_part < 1 AND l_fraction_part > 0.75)
                    THEN
                        l_dispense_qty := ceil(l_dispense_qty);
                    
                    ELSIF (l_fraction_part < 0.75 AND l_fraction_part > 0.5)
                    THEN
                        l_dispense_qty := l_dispense_qty - l_fraction_part + 0.75;
                    
                    ELSIF (l_fraction_part < 0.5 AND l_fraction_part > 0.25)
                    THEN
                        l_dispense_qty := l_dispense_qty - l_fraction_part + 0.5;
                    
                    ELSIF (l_fraction_part < 0.25 AND l_fraction_part > 0.0)
                    THEN
                        l_dispense_qty := l_dispense_qty - l_fraction_part + 0.25;
                    END IF;
                
                ELSE
                    l_dispense_qty := ceil(l_dispense_qty);
                END IF;
            END IF;
        
            RETURN l_dispense_qty;
        
        END get_dispense_qty;
    
    BEGIN
        get_dosage_info(i_drug              => i_drug,
                        i_version           => i_version,
                        o_dosage_qty        => l_dosage_qty,
                        o_dosage_unit       => l_dosage_unit,
                        o_dosage_denom_qty  => l_dosage_denom_qty,
                        o_dosage_denom_unit => l_dosage_denom_unit,
                        o_package_qty       => l_package_qty,
                        o_package_unit      => l_package_unit,
                        o_flg_fractionable  => l_flg_fractionable,
                        o_dispense_unit     => l_dispense_unit);
    
        alertlog.pk_alertlog.log_debug(text            => 'Dosage info: dosage quantity - ' || l_dosage_qty ||
                                                          '; dosage unit - ' || l_dosage_unit ||
                                                          '; dosage denominator quantity - ' || l_dosage_denom_qty ||
                                                          '; dosage denominator unit - ' || l_dosage_denom_unit ||
                                                          '; package quantity - ' || l_package_qty ||
                                                          '; package unit - ' || l_package_unit ||
                                                          '; is fractionable - ' || l_flg_fractionable ||
                                                          '; dispense unit - ' || l_dispense_unit,
                                       object_name     => g_package_name,
                                       sub_object_name => 'GET_DISPENSE_QTY');
    
        IF l_dosage_denom_qty IS NOT NULL
        THEN
            alertlog.pk_alertlog.log_info(text            => 'Has a concentration',
                                          object_name     => g_package_name,
                                          sub_object_name => 'GET_DISPENSE_QTY');
            CASE
                WHEN pk_unit_measure.are_convertible(i_dosis_unit, l_dosage_denom_unit) THEN
                    alertlog.pk_alertlog.log_info(text            => 'Conversion made on denominator',
                                                  object_name     => g_package_name,
                                                  sub_object_name => 'GET_DISPENSE_QTY');
                    l_normalized_dosis_qty  := i_dosis_qty;
                    l_normalized_dosis_unit := i_dosis_unit;
                
                    l_normalized_dosage_qty  := l_package_qty;
                    l_normalized_dosage_unit := l_package_unit;
                
                WHEN pk_unit_measure.are_convertible(i_dosis_unit, l_dosage_unit) THEN
                    alertlog.pk_alertlog.log_info(text            => 'Conversion made on numerator',
                                                  object_name     => g_package_name,
                                                  sub_object_name => 'GET_DISPENSE_QTY');
                    l_normalized_dosis_unit := l_dosage_denom_unit;
                    l_normalized_dosis_qty  := pk_unit_measure.get_unit_mea_conversion(i_dosis_qty,
                                                                                       i_dosis_unit,
                                                                                       l_dosage_unit) /
                                               (l_dosage_qty / l_dosage_denom_qty);
                
                    l_normalized_dosage_qty  := l_package_qty;
                    l_normalized_dosage_unit := l_package_unit;
                ELSE
                    l_normalized_dosis_unit  := i_dosis_unit;
                    l_normalized_dosis_qty   := i_dosis_qty;
                    l_normalized_dosage_qty  := l_dosage_qty;
                    l_normalized_dosage_unit := l_dosage_unit;
            END CASE; --
        ELSE
            alertlog.pk_alertlog.log_info(text            => 'Doesn''t have a concentration',
                                          object_name     => g_package_name,
                                          sub_object_name => 'GET_DISPENSE_QTY');
        
            l_normalized_dosis_qty  := i_dosis_qty;
            l_normalized_dosis_unit := i_dosis_unit;
        
            l_normalized_dosage_qty  := l_dosage_qty;
            l_normalized_dosage_unit := l_dosage_unit;
        END IF;
    
        alertlog.pk_alertlog.log_info(text            => 'Ready to get dispense quantity',
                                      object_name     => g_package_name,
                                      sub_object_name => 'GET_DISPENSE_QTY');
        o_dispense_qty := get_dispense_qty(i_dosis_qty        => l_normalized_dosis_qty,
                                           i_dosis_unit       => l_normalized_dosis_unit,
                                           i_dosage_qty       => l_normalized_dosage_qty,
                                           i_dosage_unit      => l_normalized_dosage_unit,
                                           i_flg_fractionable => l_flg_fractionable);
    
        IF o_dispense_qty IS NOT NULL
        THEN
            o_dispense_unit := l_dispense_unit;
        ELSE
            o_dispense_unit := NULL;
        END IF;
    
    EXCEPTION
        WHEN OTHERS THEN
            o_dispense_qty  := NULL;
            o_dispense_unit := NULL;
        
            l_ret := pk_alert_exceptions.process_error_short(i_sqlcode => SQLCODE,
                                                             i_sqlerrm => SQLERRM,
                                                             o_error   => l_error);
    END get_dispense_qty;

    PROCEDURE process_unit_conversion
    (
        i_id_drug       IN drug_presc_det.id_drug%TYPE,
        i_version       IN drug_presc_det.vers%TYPE,
        i_doses         IN t_tbl_pharm_takes,
        io_tbl_dispense IN OUT t_tbl_pharm_dispense_takes
    ) IS
        l_rec_dispense t_rec_pharm_dispense_takes;
    BEGIN
        FOR i IN 1 .. i_doses.count
        LOOP
            l_rec_dispense := t_rec_pharm_dispense_takes(NULL, NULL, NULL, NULL, NULL, NULL, NULL);
        
            --
            l_rec_dispense.drug    := i_id_drug;
            l_rec_dispense.version := i_version;
            --
            l_rec_dispense.qt_presc   := i_doses(i).qt;
            l_rec_dispense.unit_presc := i_doses(i).unit;
            --
            l_rec_dispense.takes := i_doses(i).takes;
        
            alertlog.pk_alertlog.log_debug(text            => 'Before conversion: quantity - ' ||
                                                              l_rec_dispense.qt_presc || '; unit - ' ||
                                                              l_rec_dispense.unit_presc,
                                           object_name     => g_package_name,
                                           sub_object_name => 'PROCESS_UNIT_CONVERSION');
        
            get_dispense_qty(i_drug          => l_rec_dispense.drug,
                             i_version       => l_rec_dispense.version,
                             i_dosis_qty     => l_rec_dispense.qt_presc,
                             i_dosis_unit    => l_rec_dispense.unit_presc,
                             o_dispense_qty  => l_rec_dispense.qt_disp,
                             o_dispense_unit => l_rec_dispense.unit_disp);
        
            alertlog.pk_alertlog.log_debug(text            => 'After conversion: quantity - ' ||
                                                              nvl(l_rec_dispense.qt_disp, l_rec_dispense.qt_presc) ||
                                                              '; unit - ' ||
                                                              nvl(l_rec_dispense.unit_disp, l_rec_dispense.unit_presc),
                                           object_name     => g_package_name,
                                           sub_object_name => 'PROCESS_UNIT_CONVERSION');
            --
            io_tbl_dispense.extend(1);
            io_tbl_dispense(i) := l_rec_dispense;
        END LOOP;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END process_unit_conversion;

    FUNCTION process_takes_for_presc
    (
        i_irreg_num_takes IN NUMBER,
        i_irreg_qtys      IN table_number,
        i_irreg_units     IN table_number
    ) RETURN t_tbl_pharm_takes IS
        l2_take      NUMBER;
        l2_tbl_takes t_tbl_pharm_takes := t_tbl_pharm_takes();
        l2_idx       NUMBER;
    
        -- ***** ***** ***** ***** ***** ***** ***** ***** ***** *****
        FUNCTION check_if_exists
        (
            l3_tbl_takes  IN t_tbl_pharm_takes,
            l3_irreg_unit IN NUMBER
        ) RETURN NUMBER IS
            l3_idx NUMBER := NULL;
        BEGIN
            FOR i IN 1 .. l3_tbl_takes.count
            LOOP
                IF (l3_irreg_unit = l3_tbl_takes(i).unit)
                THEN
                    l3_idx := i;
                    EXIT;
                END IF;
            END LOOP;
        
            RETURN l3_idx;
        
        EXCEPTION
            WHEN OTHERS THEN
                RAISE;
        END check_if_exists;
        -- ***** ***** ***** ***** ***** ***** ***** ***** ***** *****
    BEGIN
        FOR l2_take IN 1 .. i_irreg_num_takes
        LOOP
        
            l2_idx := check_if_exists(l2_tbl_takes, i_irreg_units(l2_take));
            IF (l2_idx IS NULL)
            THEN
                --new
                l2_tbl_takes.extend(1);
                l2_idx := l2_tbl_takes.count;
                l2_tbl_takes(l2_idx) := t_rec_pharm_takes(i_irreg_qtys(l2_take), i_irreg_units(l2_take), 1);
            ELSE
                --sum
                l2_tbl_takes(l2_idx).qt := l2_tbl_takes(l2_idx).qt + i_irreg_qtys(l2_take);
                l2_tbl_takes(l2_idx).takes := l2_tbl_takes(l2_idx).takes + 1;
            END IF;
        
        END LOOP;
    
        RETURN l2_tbl_takes;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END process_takes_for_presc;

    PROCEDURE create_req_pharm_uni
    (
        i_lang                  IN language.id_language%TYPE,
        i_episode               IN drug_req.id_episode%TYPE,
        i_patient               IN patient.id_patient%TYPE,
        i_prof                  IN alert.profissional,
        i_drug_presc_det        IN alert.table_number,
        i_drug                  IN alert.table_varchar,
        i_version               IN drug_req_det.vers%TYPE,
        i_qty_req               IN alert.table_number,
        i_unit_measure          IN alert.table_number,
        i_notes                 IN alert.table_varchar,
        i_dispense              IN alert.table_number DEFAULT alert.table_number(),
        i_unit_measure_dispense IN alert.table_number DEFAULT alert.table_number(),
        i_datetime              IN drug_req_det.dt_last_change%TYPE,
        i_do_auto_dispense_calc IN VARCHAR2 DEFAULT 'N',
        --
        i_id_unidose_car IN pharm_unidose_car.id_unidose_car%TYPE DEFAULT NULL,
        i_dt_car_begin   IN pharm_unidose_car.dt_car_begin%TYPE DEFAULT NULL,
        i_dt_car_end     IN pharm_unidose_car.dt_car_end%TYPE DEFAULT NULL,
        --
        o_id_drug_req_det OUT alert.table_number,
        o_error           OUT t_error_out
    ) IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'CREATE_REQ_PHARM_UNI';
        --
        l_justify               mi_med.flg_justify%TYPE;
        l_id_room               drug_req.id_room%TYPE := NULL;
        l_next                  drug_req.id_drug_req%TYPE;
        l_next_det              drug_req_det.id_drug_req_det%TYPE;
        l_dpd_previous_status   drug_presc_det.flg_status%TYPE;
        l_drug_type             drug_presc_det.flg_take_type%TYPE;
        l_rowids                table_varchar;
        l_id_drug_req_det       table_number := table_number();
        l_drug_count            NUMBER := 0;
        l_count_meds            NUMBER(1) := 0;
        l_id_dep_clin_serv      epis_info.id_dep_clin_serv%TYPE;
        l_bed_dcs               dep_clin_serv.id_dep_clin_serv%TYPE;
        l_id_car_model          pharm_unidose_car.id_car_model%TYPE;
        l_id_car                pharm_unidose_car.id_unidose_car%TYPE;
        l_id_presc_instr_det    drug_presc_det.id_presc_directions%TYPE;
        l_ret                   BOOLEAN := FALSE;
        l_qty_req               drug_req_det.qty_req%TYPE;
        l_unit_measure          drug_req_det.id_unit_measure%TYPE;
        l_dispense              NUMBER;
        l_unit_measure_dispense NUMBER;
        l_has_takes             VARCHAR2(1 CHAR) := g_no;
        l_flg_auto_validation   sys_config.value%TYPE;
    
        --
        PROCEDURE get_car_and_model
        (
            i_id_unidose_car2 IN pharm_unidose_car.id_unidose_car%TYPE,
            i_datetime2       IN pharm_unidose_car.dt_car_begin%TYPE,
            i_bed_dcs2        IN dep_clin_serv.id_dep_clin_serv%TYPE,
            o_id_car          OUT pharm_unidose_car.id_unidose_car%TYPE,
            o_id_car_model    OUT pharm_unidose_car.id_car_model%TYPE
        ) IS
        BEGIN
            IF (i_id_unidose_car2 IS NULL)
            THEN
                BEGIN
                    IF (i_bed_dcs2 IS NOT NULL)
                    THEN
                        SELECT v1.id_unidose_car, v1.id_car_model
                          INTO o_id_car, o_id_car_model
                          FROM (SELECT uc.id_unidose_car, uc.id_car_model
                                  FROM pharm_unidose_car uc, pharm_unidose_car_model ucm
                                 WHERE uc.id_car_model = ucm.id_unidose_car_model
                                   AND ucm.id_dep_clin_serv = i_bed_dcs2
                                   AND to_date(to_char(i_datetime2, 'YYYYMMDD'), 'YYYYMMDD') >=
                                       to_date(to_char(uc.dt_car_begin, 'YYYYMMDD'), 'YYYYMMDD')
                                   AND to_date(to_char(i_datetime2, 'YYYYMMDD'), 'YYYYMMDD') <
                                       to_date(to_char(nvl(uc.dt_car_end, uc.dt_car_begin), 'YYYYMMDD'), 'YYYYMMDD')
                                   AND uc.id_state IN
                                       (SELECT column_value
                                          FROM TABLE(get_states_for_req_type(i_prof,
                                                                             NULL,
                                                                             table_varchar(g_uni_car_parked_st,
                                                                                           g_uni_car_executing_st))))
                                 ORDER BY uc.dt_car_begin, uc.dt_car_end NULLS FIRST) v1
                         WHERE rownum = 1;
                    ELSE
                        o_id_car := NULL;
                    END IF;
                EXCEPTION
                    WHEN no_data_found THEN
                        o_id_car := NULL;
                END;
            ELSE
                SELECT uc.id_unidose_car, uc.id_car_model
                  INTO o_id_car, o_id_car_model
                  FROM pharm_unidose_car uc
                 WHERE uc.id_unidose_car = i_id_unidose_car2;
            END IF;
        
        EXCEPTION
            WHEN OTHERS THEN
                RAISE;
        END get_car_and_model;
        --
        FUNCTION is_presc_edited_since_last_val(i_id_drug_req_det IN drug_req_det.id_drug_req_det%TYPE) RETURN BOOLEAN IS
            l_ret      BOOLEAN := TRUE;
            l_continue BOOLEAN := TRUE;
            --
            l_id_drug              drug_req_det.id_drug%TYPE;
            l_vers                 drug_req_det.vers%TYPE;
            l_id_presc_directions  drug_req_det.id_presc_directions%TYPE;
            l_id_drug_presc_det    drug_req.id_drug_presc_det%TYPE;
            l_id_drug2             drug_req_det.id_drug%TYPE;
            l_vers2                drug_req_det.vers%TYPE;
            l_id_presc_directions2 drug_req_det.id_presc_directions%TYPE;
        BEGIN
            g_error := 'get med, directions and id presc';
            SELECT drd.id_drug, drd.vers, drd.id_presc_directions, dr.id_drug_presc_det
              INTO l_id_drug, l_vers, l_id_presc_directions, l_id_drug_presc_det
              FROM drug_req_det drd
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             WHERE drd.id_drug_req_det = i_id_drug_req_det;
        
            IF (l_id_drug IS NOT NULL AND l_vers IS NOT NULL AND l_id_presc_directions IS NOT NULL AND
               l_id_drug_presc_det IS NOT NULL)
            THEN
                g_error := 'get last validated pharmacy order for the same presc';
                BEGIN
                    SELECT v1.id_drug, v1.vers, v1.id_presc_directions
                      INTO l_id_drug2, l_vers2, l_id_presc_directions2
                      FROM (SELECT drd.id_drug, drd.vers, drd.id_presc_directions
                              FROM drug_req_det drd
                             INNER JOIN drug_req dr
                                ON (drd.id_drug_req = dr.id_drug_req)
                             INNER JOIN drug_req_det_state_transition drdst
                                ON (drd.id_drug_req_det = drdst.id_drug_req_det)
                             WHERE dr.id_drug_presc_det = l_id_drug_presc_det
                               AND dr.flg_type = g_flg_unidose
                               AND drdst.id_state = get_state_for_req_type(i_prof, dr.flg_type, g_drd_validated_st)
                             ORDER BY drdst.dt_state DESC) v1
                     WHERE rownum < 2;
                EXCEPTION
                    WHEN no_data_found THEN
                        l_continue := FALSE;
                        l_ret      := TRUE;
                END;
            
                IF (l_continue)
                THEN
                    IF (l_id_drug2 IS NOT NULL AND l_vers2 IS NOT NULL AND l_id_presc_directions2 IS NOT NULL AND
                       --
                       l_id_drug = l_id_drug2 AND l_vers = l_vers2 AND l_id_presc_directions = l_id_presc_directions2)
                    THEN
                        l_ret := FALSE;
                    ELSE
                        l_ret := TRUE;
                    END IF;
                END IF;
            
            END IF;
        
            RETURN l_ret;
        
        EXCEPTION
            WHEN OTHERS THEN
                RAISE;
        END is_presc_edited_since_last_val;
        --
    BEGIN
        g_error   := 'GET ROOM';
        l_id_room := get_pat_room(i_episode);
    
        g_error := 'GET ID_DEP_CLIN_SERV';
        set_pharmacy_log(l_db_object_name, g_error);
        SELECT nvl(ei.id_dep_clin_serv, 0)
          INTO l_id_dep_clin_serv
          FROM epis_info ei
         WHERE ei.id_episode = i_episode;
    
        g_error := 'LOOP i_drug';
        FOR i IN 1 .. i_drug.count
        LOOP
        
            IF (i_drug(i) IS NOT NULL)
            THEN
            
                -- *********************************
                -- PT 26/09/2008 2.4.3.d
                g_error := 'GET NEXT DRUG_REQ ID';
                l_next  := ts_drug_req.next_key();
            
                g_error := 'INSERT INTO DRUG_REQ';
                set_pharmacy_log(l_db_object_name, g_error);
                ts_drug_req.ins(id_drug_req_in       => l_next,
                                dt_drug_req_tstz_in  => i_datetime,
                                id_episode_in        => i_episode,
                                id_patient_in        => i_patient,
                                id_prof_req_in       => i_prof.id,
                                flg_status_in        => g_flg_temp,
                                dt_begin_tstz_in     => i_datetime,
                                id_room_in           => l_id_room,
                                flg_type_in          => g_flg_unidose,
                                id_drug_presc_det_in => i_drug_presc_det(i),
                                rows_out             => l_rowids);
            
                t_data_gov_mnt.process_insert(i_lang       => i_lang,
                                              i_prof       => i_prof,
                                              i_table_name => 'DRUG_REQ',
                                              i_rowids     => l_rowids,
                                              o_error      => o_error);
                -- *********************************
            
                g_error := 'CHECK IF DRUG -> UNIDOSE';
                set_pharmacy_log(l_db_object_name, g_error);
                -- apesar do departamento estar em unidose, podem existir medicamentos que s so requisitados de forma normal! ADM
                SELECT COUNT(1)
                  INTO l_count_meds
                  FROM pharm_unidose_exception_meds exm
                 WHERE exm.id_drug = i_drug(i)
                   AND exm.vers = i_version
                   AND (exm.id_institution = i_prof.institution OR exm.id_institution = 0)
                   AND nvl(exm.id_dep_clin_serv, l_id_dep_clin_serv) = l_id_dep_clin_serv
                   AND rownum = 1;
            
                IF (l_count_meds = 0)
                THEN
                
                    -- dispense can be table_number() --empty!! so.. null!
                    BEGIN
                        l_dispense              := i_dispense(i);
                        l_unit_measure_dispense := i_unit_measure_dispense(i);
                    EXCEPTION
                        WHEN OTHERS THEN
                            l_dispense              := NULL;
                            l_unit_measure_dispense := NULL;
                    END;
                
                    g_error := 'OPEN C_JUSTIFY';
                    set_pharmacy_log(l_db_object_name, g_error);
                    BEGIN
                        SELECT mm.flg_justify
                          INTO l_justify
                          FROM mi_med mm
                         WHERE mm.id_drug = i_drug(i)
                           AND mm.vers = i_version;
                    EXCEPTION
                        WHEN no_data_found THEN
                            l_justify := NULL;
                    END;
                
                    SELECT seq_drug_req_det.nextval
                      INTO l_next_det
                      FROM dual;
                
                    g_error := 'pk_medication_core.check_int_drug_type';
                    set_pharmacy_log(l_db_object_name, g_error);
                    l_drug_type := pk_medication_core.check_int_drug_type(i_lang, i_prof, i_drug_presc_det(i), o_error);
                
                    SELECT dpd.id_presc_directions
                      INTO l_id_presc_instr_det
                      FROM drug_presc_det dpd
                     WHERE dpd.id_drug_presc_det = i_drug_presc_det(i);
                
                    l_qty_req      := i_qty_req(i);
                    l_unit_measure := i_unit_measure(i);
                
                    g_error := 'calc_takes_and_dispense';
                    calc_takes_and_dispense(i_lang                   => i_lang,
                                            i_prof                   => i_prof,
                                            i_id_presc_instr_det     => l_id_presc_instr_det,
                                            i_drug                   => i_drug(i),
                                            i_version                => i_version,
                                            i_flg_type               => g_flg_unidose,
                                            i_do_auto_dispense_calc  => i_do_auto_dispense_calc,
                                            i_dt_begin               => i_dt_car_begin,
                                            i_dt_end                 => i_dt_car_end,
                                            io_qty_req               => l_qty_req,
                                            io_unit_measure          => l_unit_measure,
                                            io_dispense              => l_dispense,
                                            io_unit_measure_dispense => l_unit_measure_dispense,
                                            o_has_takes              => l_has_takes,
                                            o_error                  => o_error);
                
                    g_error := 'INSERT DRUG REQUISITION DET - drug_type:' || l_drug_type;
                    set_pharmacy_log(l_db_object_name, g_error);
                
                    IF (l_has_takes = g_yes)
                    THEN
                        -- Only enters this code if has takes.
                    
                        IF (l_drug_type = pk_prescription_int.g_type_other_product)
                        THEN
                        
                            INSERT INTO drug_req_det
                                (id_drug_req_det,
                                 id_drug_req,
                                 qty_req,
                                 id_unit_measure,
                                 flg_status,
                                 notes,
                                 flg_ci,
                                 flg_cheaper,
                                 flg_justif,
                                 flg_interac_med,
                                 flg_interac_allergy,
                                 pharmacist_validation,
                                 vers,
                                 id_prof_last_change,
                                 id_sw_last_change,
                                 id_inst_last_change,
                                 dt_last_change,
                                 id_other_product,
                                 id_state,
                                 dispense,
                                 unit_measure_dispense,
                                 qty_to_prep,
                                 id_unit_measure_prep,
                                 id_presc_directions)
                            VALUES
                                (l_next_det,
                                 l_next,
                                 l_qty_req,
                                 l_unit_measure,
                                 g_det_req,
                                 i_notes(i),
                                 g_no,
                                 g_no,
                                 l_justify,
                                 g_no,
                                 g_no,
                                 g_no,
                                 i_version,
                                 i_prof.id,
                                 i_prof.software,
                                 i_prof.institution,
                                 i_datetime,
                                 i_drug(i),
                                 get_state_for_req_type(i_prof, g_flg_unidose, g_drd_requested_st),
                                 l_dispense,
                                 l_unit_measure_dispense,
                                 l_dispense,
                                 l_unit_measure_dispense,
                                 l_id_presc_instr_det);
                        
                        ELSE
                            INSERT INTO drug_req_det
                                (id_drug_req_det,
                                 id_drug_req,
                                 id_drug,
                                 qty_req,
                                 id_unit_measure,
                                 flg_status,
                                 notes,
                                 flg_ci,
                                 flg_cheaper,
                                 flg_justif,
                                 flg_interac_med,
                                 flg_interac_allergy,
                                 pharmacist_validation,
                                 vers,
                                 id_prof_last_change,
                                 id_sw_last_change,
                                 id_inst_last_change,
                                 dt_last_change,
                                 id_state,
                                 dispense,
                                 unit_measure_dispense,
                                 qty_to_prep,
                                 id_unit_measure_prep,
                                 id_presc_directions)
                            VALUES
                                (l_next_det,
                                 l_next,
                                 i_drug(i),
                                 l_qty_req,
                                 l_unit_measure,
                                 g_det_req,
                                 i_notes(i),
                                 g_no,
                                 g_no,
                                 l_justify,
                                 g_no,
                                 g_no,
                                 g_no,
                                 i_version,
                                 i_prof.id,
                                 i_prof.software,
                                 i_prof.institution,
                                 i_datetime,
                                 get_state_for_req_type(i_prof, g_flg_unidose, g_drd_requested_st),
                                 l_dispense,
                                 l_unit_measure_dispense,
                                 l_dispense,
                                 l_unit_measure_dispense,
                                 l_id_presc_instr_det);
                        
                        END IF;
                    
                        --state history
                        g_error := 'INSERT drug_req_det_state_transition';
                        set_pharmacy_log(l_db_object_name, g_error);
                        INSERT INTO drug_req_det_state_transition
                            (id_drug_req_det, id_state, id_prof, dt_state, notes1)
                        VALUES
                            (l_next_det,
                             get_state_for_req_type(i_prof, g_flg_unidose, g_drd_requested_st),
                             i_prof.id,
                             i_datetime,
                             i_notes(i));
                    
                        --output parameter
                        l_drug_count := l_drug_count + 1;
                        l_id_drug_req_det.extend(1);
                        l_id_drug_req_det(l_drug_count) := l_next_det;
                    
                        g_error := 'CALL TO SET_WARNINGS';
                        set_pharmacy_log(l_db_object_name, g_error);
                    
                        IF NOT pk_prescription_warnings.set_warnings(i_lang          => i_lang,
                                                                     i_prof          => i_prof,
                                                                     i_patient       => i_patient,
                                                                     i_episode       => i_episode,
                                                                     i_subject       => pk_medication_core.g_hospital,
                                                                     i_presc         => table_number(l_next_det),
                                                                     i_choice        => g_yes,
                                                                     i_type          => 'I',
                                                                     i_set_attention => NULL,
                                                                     o_error         => o_error)
                        THEN
                            raise_application_error(-20001, g_error);
                        END IF;
                    
                        g_error := 'CALL TO GET_PAT_BED_DCS';
                        set_pharmacy_log(l_db_object_name, g_error);
                    
                        --try to put the order in the slot matched by the bed number.
                        l_bed_dcs := get_pat_bed_dcs(i_lang    => i_lang,
                                                     i_prof    => i_prof,
                                                     i_episode => i_episode,
                                                     i_patient => i_patient);
                    
                        set_pharmacy_log(l_db_object_name, 'l_bed_dcs=' || l_bed_dcs);
                    
                        get_car_and_model(i_id_unidose_car2 => i_id_unidose_car,
                                          i_datetime2       => i_datetime,
                                          i_bed_dcs2        => l_bed_dcs,
                                          o_id_car          => l_id_car,
                                          o_id_car_model    => l_id_car_model);
                    
                        set_pharmacy_log(l_db_object_name,
                                         'l_id_car=' || l_id_car || ' l_id_car_model=' || l_id_car_model);
                    
                        IF (l_id_car IS NOT NULL)
                        THEN
                            set_pat_slot_persistence(i_lang         => i_lang,
                                                     i_prof         => i_prof,
                                                     i_patient      => i_patient,
                                                     i_car_model    => l_id_car_model,
                                                     i_car_id       => l_id_car,
                                                     i_dt_req       => i_datetime,
                                                     i_drug_req_det => l_next_det,
                                                     i_episode      => i_episode,
                                                     i_flg_use_bed  => g_yes);
                        END IF;
                    
                        --ALERT-170541
                        IF (l_dispense IS NOT NULL AND l_unit_measure_dispense IS NOT NULL AND nvl(l_dispense, 0) > 0 AND
                           l_id_presc_instr_det IS NOT NULL)
                        THEN
                            l_flg_auto_validation := nvl(pk_sysconfig.get_config(i_code_cf => 'PHARMACY_UNI_AUTO_VALIDATION_WHEN_PRESC_NOT_ALTERED',
                                                                                 i_prof    => i_prof),
                                                         g_no);
                        
                            IF (l_flg_auto_validation = g_yes)
                            THEN
                                g_error := 'check_presc_for_editions';
                                IF (NOT is_presc_edited_since_last_val(i_id_drug_req_det => l_next_det))
                                THEN
                                    g_error := 'set_pat_check';
                                    set_pat_check(i_lang                => i_lang,
                                                  i_prof                => i_prof,
                                                  i_drug_req_det        => table_number(l_next_det),
                                                  i_notes_physician     => table_varchar(NULL),
                                                  i_notes_pharmacist    => table_varchar(NULL),
                                                  i_med_changed         => table_varchar(g_no),
                                                  i_id_drug             => table_varchar(NULL),
                                                  i_drug_vers           => table_varchar(NULL),
                                                  i_qty_req             => table_number(i_qty_req(i)),
                                                  i_qty_unit            => table_number(i_unit_measure(i)),
                                                  i_qty_prep            => table_number(l_dispense),
                                                  i_qty_prep_unit       => table_number(l_unit_measure_dispense),
                                                  i_wait_for_approv     => table_varchar(g_no),
                                                  i_cosigned_by         => table_number(NULL),
                                                  i_cosigned_date       => table_varchar(NULL),
                                                  i_cosigned_type       => table_number(NULL),
                                                  i_cosigned_notes      => table_varchar(NULL),
                                                  i_deliver_at_home     => table_varchar(g_no),
                                                  i_instr_changed       => table_varchar(g_no),
                                                  i_drug_presc_det_new  => table_number(NULL),
                                                  i_med_changed_to_new  => table_varchar(g_no),
                                                  i_dt_next_dispense    => table_varchar(NULL),
                                                  i_id_presc_directions => table_number(NULL));
                                END IF;
                            END IF;
                        END IF;
                        --
                    
                    END IF; --has_takes
                
                END IF; --drug not unidose!
            
            END IF;
        
        END LOOP;
    
        o_id_drug_req_det := l_id_drug_req_det;
    
    EXCEPTION
        WHEN OTHERS THEN
            set_pharmacy_log(l_db_object_name, 'l_next_det=' || l_next_det || '###' || SQLERRM);
            RAISE;
    END create_req_pharm_uni;

    --last DRD already been worked by the pharmacist
    FUNCTION get_last_order_for_presc
    (
        i_prof              IN profissional,
        i_id_drug_presc_det IN drug_presc_det.id_drug_presc_det%TYPE
    ) RETURN drug_req_det.id_drug_req_det%TYPE IS
        l_id_drd drug_req_det.id_drug_req_det%TYPE := NULL;
    BEGIN
        SELECT v1.id_drug_req_det
          INTO l_id_drd
          FROM (SELECT drd.id_drug_req_det
                  FROM drug_req dr, drug_req_det drd
                 WHERE dr.id_drug_presc_det = i_id_drug_presc_det
                   AND dr.id_drug_req = drd.id_drug_req
                   AND drd.id_state NOT IN
                       (SELECT column_value
                          FROM TABLE(get_states_for_req_type(i_prof,
                                                             dr.flg_type,
                                                             table_varchar( /*g_drd_requested_st, */ g_drd_temporary_st))))
                 ORDER BY dr.dt_drug_req_tstz DESC) v1
         WHERE rownum = 1;
    
        RETURN l_id_drd;
    
    EXCEPTION
        WHEN OTHERS THEN
            RETURN NULL;
    END get_last_order_for_presc;

    --last DRD already been worked by the pharmacist (with type = i_flg_type)
    FUNCTION get_last_order_for_presc
    (
        i_prof              IN profissional,
        i_id_drug_presc_det IN drug_presc_det.id_drug_presc_det%TYPE,
        i_flg_type          IN drug_req.flg_type%TYPE
    ) RETURN drug_req_det.id_drug_req_det%TYPE IS
        l_id_drd drug_req_det.id_drug_req_det%TYPE := NULL;
    BEGIN
        SELECT v1.id_drug_req_det
          INTO l_id_drd
          FROM (SELECT drd.id_drug_req_det
                  FROM drug_req dr, drug_req_det drd
                 WHERE dr.id_drug_presc_det = i_id_drug_presc_det
                   AND dr.id_drug_req = drd.id_drug_req
                   AND dr.flg_type = i_flg_type
                   AND drd.id_state NOT IN
                       (SELECT column_value
                        -- if cancelled but has dt_next_dispense it matters, so g_drd_canceled_st was removed 
                          FROM TABLE(get_states_for_req_type(i_prof,
                                                             dr.flg_type,
                                                             table_varchar(g_drd_requested_st, g_drd_temporary_st))))
                 ORDER BY dr.dt_drug_req_tstz DESC) v1
         WHERE rownum = 1;
    
        RETURN l_id_drd;
    
    EXCEPTION
        WHEN OTHERS THEN
            RETURN NULL;
    END get_last_order_for_presc;

    --RM: 12-NOV-2010
    --checks if this prescription is to be dispensed "today" (i_dt_now), because the user may have "told" on the last pharmacy order
    --for this prescription that the next dispense is to be done some date in the future. (edit/review screen -- next dispense field)
    --*** This applies ONLY to unit-dose orders! ***
    FUNCTION check_drd_dispense_date
    (
        i_lang              IN language.id_language%TYPE,
        i_prof              IN alert.profissional,
        i_id_drug_presc_det IN drug_presc_det.id_drug_presc_det%TYPE,
        i_dt_now            IN TIMESTAMP WITH LOCAL TIME ZONE
    ) RETURN BOOLEAN IS
        l_last_drd         drug_req_det.id_drug_req_det%TYPE := NULL;
        l_dt_next_dispense drug_req_det.dt_next_dispense%TYPE := NULL;
        l_ret              BOOLEAN := FALSE;
    BEGIN
    
        l_last_drd := get_last_order_for_presc(i_prof              => i_prof,
                                               i_id_drug_presc_det => i_id_drug_presc_det,
                                               i_flg_type          => g_flg_unidose);
    
        IF (l_last_drd IS NOT NULL)
        THEN
            SELECT drd.dt_next_dispense
              INTO l_dt_next_dispense
              FROM drug_req_det drd
             WHERE drd.id_drug_req_det = l_last_drd;
        
            IF (l_dt_next_dispense IS NULL OR i_dt_now > l_dt_next_dispense)
            THEN
                l_ret := TRUE;
            END IF;
        ELSE
            l_ret := TRUE;
        END IF;
    
        RETURN l_ret;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END check_drd_dispense_date;

    PROCEDURE create_unidose_reqs_for_id_gen
    (
        i_lang       IN language.id_language%TYPE,
        i_prof       IN alert.profissional,
        i_id_req_gen IN pharm_unidose_req_gen.id_req_gen%TYPE
    ) IS
        l_version               drug_req_det.vers%TYPE;
        l_institution           institution.id_institution%TYPE;
        l_prof                  alert.profissional;
        l_prof_software         software.id_software%TYPE := 11; --ALERT INPATIENT --TBD: este id_software = 11 tem de sair daqui!  necessrio controlar este valor de outra forma!!
        l_new_car               pharm_unidose_car.id_unidose_car%TYPE;
        l_drd_new               table_number := table_number();
        o_error                 t_error_out;
        l_take                  NUMBER := 0;
        l_dosage                NUMBER := 0;
        l_ret                   BOOLEAN := FALSE;
        l_pharm_order_count     NUMBER := 0;
        l_pharm_order_count_all NUMBER := 0;
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'create_unidose_reqs_for_id_gen';
        --
        l_dispense              NUMBER;
        l_unit_measure_dispense NUMBER;
        l_qty_req               drug_req_det.qty_req%TYPE;
        l_unit_measure          drug_req_det.id_unit_measure%TYPE;
        l_has_takes             VARCHAR2(1 CHAR) := g_no;
        l_auto_disp_calc        sys_config.value%TYPE := g_no;
        --
        l_unit_interval_config  sys_config.value%TYPE;
        l_dt_uni_interval_begin TIMESTAMP WITH LOCAL TIME ZONE;
        l_dt_uni_interval_end   TIMESTAMP WITH LOCAL TIME ZONE;
        --
    
        --CARS
        CURSOR c_cars_to_create(i_id_rg IN pharm_unidose_req_gen.id_req_gen%TYPE) IS
            SELECT a.id_car_model, a.day_car, b.id_dep_clin_serv, b.dt_begin, b.dt_end
              FROM pharm_unidose_req_gen_car a, pharm_unidose_req_gen b
             WHERE a.id_req_gen = i_id_rg
               AND a.id_req_gen = b.id_req_gen;
    
        --PRESCRIPTIONS
        CURSOR c_prescs_unidose(i_dcs IN dep_clin_serv.id_dep_clin_serv%TYPE) IS
            SELECT dp.id_episode,
                   dp.id_patient,
                   dpd.id_drug_presc_det,
                   dpd.id_drug,
                   dpd.vers,
                   nvl(dpd.qty, dpd.qty_inst) qty_req,
                   nvl(dpd.id_unit_measure, dpd.unit_measure_inst) unit_qty_req,
                   nvl(dpd.qty, dpd.qty_inst) qty_disp,
                   nvl(dpd.id_unit_measure, dpd.unit_measure_inst) unit_qty_disp,
                   dpd.notes,
                   profissional(dp.id_professional, e.id_institution, l_prof_software) prof,
                   dpd.id_presc_directions,
                   dpd.dosage,
                   dpd.frequency,
                   dpd.id_unit_measure,
                   dpd.id_other_product
              FROM drug_prescription dp,
                   drug_presc_det    dpd,
                   episode           e,
                   department        d,
                   dep_clin_serv     dcs,
                   clinical_service  cs
             WHERE dp.id_drug_prescription = dpd.id_drug_prescription
               AND pk_medication_core.is_active_prescription(i_lang, i_prof, dpd.id_drug_presc_det) = 1
               AND dpd.vers = l_version
               AND dp.id_episode = e.id_episode
               AND e.flg_status = 'A'
               AND e.id_department = d.id_department
               AND d.flg_unidose = g_yes
               AND e.id_institution = l_institution
               AND d.id_institution = l_institution
               AND e.id_clinical_service = cs.id_clinical_service
               AND cs.id_clinical_service = dcs.id_clinical_service
               AND e.id_department = dcs.id_department
               AND dcs.id_dep_clin_serv = i_dcs
               AND (dpd.id_drug IS NOT NULL OR dpd.id_other_product IS NOT NULL)
               AND dpd.vers IS NOT NULL
               AND (dpd.qty IS NOT NULL OR dpd.qty_inst IS NOT NULL OR dpd.id_presc_directions IS NOT NULL)
               AND (dpd.id_drug IS NULL OR (dpd.id_drug, dpd.vers) NOT IN
                   (SELECT exm.id_drug, exm.vers
                                              FROM pharm_unidose_exception_meds exm
                                             WHERE (exm.id_institution = l_institution OR exm.id_institution = 0)
                                               AND nvl(exm.id_dep_clin_serv, i_dcs) = i_dcs));
    
    BEGIN
        l_auto_disp_calc := nvl(pk_sysconfig.get_config('PHARMACY_AUTOMATIC_DISPENSE_CALCULATION', i_prof), g_no);
    
        IF (i_prof.software IS NOT NULL AND i_prof.software != 0)
        THEN
            --unit-dose JOB (automatic schedule)
            l_prof_software := i_prof.software;
        END IF;
    
        g_error := 'GET INSTITUTION';
        IF (i_prof.institution = 0)
        THEN
            --unit-dose JOB (automatic schedule)
            SELECT c.id_institution
              INTO l_institution
              FROM pharm_unidose_req_gen a, dep_clin_serv b, department c
             WHERE a.id_req_gen = i_id_req_gen
               AND a.id_dep_clin_serv = b.id_dep_clin_serv
               AND b.id_department = c.id_department
               AND rownum = 1;
        
            l_prof := profissional(i_prof.id, l_institution, l_prof_software);
        ELSE
            l_institution := i_prof.institution;
            l_prof        := i_prof;
        END IF;
    
        g_error   := 'GET MED VERSION';
        l_version := pk_sysconfig.get_config('PRESCRIPTION_TYPE', l_institution, l_prof_software);
    
        g_error := 'CREATE UNIDOSE CARS';
        FOR car IN c_cars_to_create(i_id_req_gen)
        LOOP
            --date interval for prescription administrations (calc takes)
            --1) check config time for id_dep_clin_serv
            l_unit_interval_config := pk_sysconfig.get_config('PHARMACY_UNIDOSE_DEP_CLIN_SERV_24H_INTERVAL_START__' ||
                                                              car.id_dep_clin_serv,
                                                              l_institution,
                                                              l_prof_software);
            IF (l_unit_interval_config IS NULL)
            THEN
                --2) check config time for institution
                l_unit_interval_config := nvl(pk_sysconfig.get_config('PHARMACY_UNIDOSE_INSTITUTION_24H_INTERVAL_START',
                                                                      l_institution,
                                                                      l_prof_software),
                                              '14:00');
            END IF;
        
            -- ex: '20101112 14:00:00' -> '20101113 13:59:59'
            l_dt_uni_interval_begin := to_timestamp(car.day_car || ' ' || l_unit_interval_config || ':00',
                                                    'YYYYMMDD HH24:MI:SS');
            l_dt_uni_interval_end   := ((l_dt_uni_interval_begin + 1) - INTERVAL '1' SECOND);
            --
        
            g_error := 'CREATE_UNI_CAR:' || car.id_car_model || ' ' || car.day_car;
            set_pharmacy_log(l_db_object_name, g_error);
            l_new_car := create_uni_car(l_prof, car.id_car_model, l_dt_uni_interval_begin, l_dt_uni_interval_end);
        
            g_error := 'CREATE UNIDOSE ORDERS - BEGIN';
            set_pharmacy_log(l_db_object_name, g_error);
            FOR presc IN c_prescs_unidose(car.id_dep_clin_serv)
            LOOP
            
                IF (check_drd_dispense_date(i_lang, i_prof, presc.id_drug_presc_det, l_dt_uni_interval_begin))
                THEN
                
                    set_pharmacy_log(l_db_object_name, '======> PRESC: ' || presc.id_drug_presc_det);
                
                    IF (presc.id_presc_directions IS NOT NULL)
                    THEN
                    
                        l_qty_req               := presc.qty_req;
                        l_unit_measure          := presc.unit_qty_req;
                        l_dispense              := presc.qty_disp;
                        l_unit_measure_dispense := presc.unit_qty_disp;
                    
                        calc_takes_and_dispense(i_lang                   => i_lang,
                                                i_prof                   => i_prof,
                                                i_id_presc_instr_det     => presc.id_presc_directions,
                                                i_drug                   => presc.id_drug,
                                                i_version                => presc.vers,
                                                i_flg_type               => g_flg_unidose,
                                                i_do_auto_dispense_calc  => g_yes,
                                                i_dt_begin               => l_dt_uni_interval_begin,
                                                i_dt_end                 => l_dt_uni_interval_end,
                                                io_qty_req               => l_qty_req,
                                                io_unit_measure          => l_unit_measure,
                                                io_dispense              => l_dispense,
                                                io_unit_measure_dispense => l_unit_measure_dispense,
                                                o_has_takes              => l_has_takes,
                                                o_error                  => o_error);
                    
                        IF (l_has_takes = g_yes OR l_auto_disp_calc = g_no)
                        THEN
                            create_req_pharm_uni(i_lang                  => i_lang,
                                                 i_episode               => presc.id_episode,
                                                 i_patient               => presc.id_patient,
                                                 i_prof                  => presc.prof,
                                                 i_drug_presc_det        => table_number(presc.id_drug_presc_det),
                                                 i_drug                  => table_varchar(nvl(presc.id_drug,
                                                                                              presc.id_other_product)),
                                                 i_version               => presc.vers,
                                                 i_qty_req               => table_number(l_qty_req),
                                                 i_unit_measure          => table_number(l_unit_measure),
                                                 i_notes                 => table_varchar(presc.notes),
                                                 i_dispense              => table_number(l_dispense),
                                                 i_unit_measure_dispense => table_number(l_unit_measure_dispense),
                                                 i_datetime              => l_dt_uni_interval_begin,
                                                 i_do_auto_dispense_calc => g_no,
                                                 o_id_drug_req_det       => l_drd_new,
                                                 o_error                 => o_error);
                        ELSE
                            set_pharmacy_log(l_db_object_name,
                                             'NAO TEM TOMAS!! presc.id_presc_directions=' || presc.id_presc_directions ||
                                             '###dt_begin=' || l_dt_uni_interval_begin || '###dt_end=' ||
                                             l_dt_uni_interval_end);
                        END IF;
                    
                    ELSE
                        --dose diaria
                        g_error := 'PK_PRESCRIPTION_WARNINGS.GET_PRESCRIBED_DAILY_DOSE';
                        set_pharmacy_log(l_db_object_name, g_error);
                        l_dosage := pk_prescription_warnings.get_prescribed_daily_dose(i_lang              => i_lang,
                                                                                       i_prof              => l_prof,
                                                                                       i_dose              => presc.dosage,
                                                                                       i_frequency         => presc.frequency,
                                                                                       i_unit_measure_freq => presc.id_unit_measure,
                                                                                       o_error             => o_error);
                    
                        --TBD: conversao entre unidades prescritas e unidades de dispensa!!!
                    
                        set_pharmacy_log(l_db_object_name, 'l_dosage=' || l_dosage);
                    
                        IF (l_dosage = 0)
                        THEN
                            l_dosage := NULL;
                        END IF;
                    
                        create_req_pharm_uni(i_lang                  => i_lang,
                                             i_episode               => presc.id_episode,
                                             i_patient               => presc.id_patient,
                                             i_prof                  => presc.prof,
                                             i_drug_presc_det        => table_number(presc.id_drug_presc_det),
                                             i_drug                  => table_varchar(nvl(presc.id_drug,
                                                                                          presc.id_other_product)),
                                             i_version               => presc.vers,
                                             i_qty_req               => table_number(l_dosage),
                                             i_unit_measure          => table_number(presc.unit_qty_req),
                                             i_notes                 => table_varchar(presc.notes),
                                             i_dispense              => table_number(NULL),
                                             i_unit_measure_dispense => table_number(NULL),
                                             i_datetime              => l_dt_uni_interval_begin,
                                             i_do_auto_dispense_calc => g_no,
                                             o_id_drug_req_det       => l_drd_new,
                                             o_error                 => o_error);
                    END IF;
                
                    IF (l_drd_new.count > 0)
                    THEN
                        l_pharm_order_count := l_pharm_order_count + 1;
                    
                        --try to put the order in the slot matched by the bed number. if it fails, try in the same slot that the patient used on the day before
                        set_pat_slot_persistence(i_lang         => i_lang,
                                                 i_prof         => l_prof,
                                                 i_patient      => presc.id_patient,
                                                 i_car_model    => car.id_car_model,
                                                 i_car_id       => l_new_car,
                                                 i_dt_req       => l_dt_uni_interval_begin, --l_dt,
                                                 i_drug_req_det => l_drd_new(1),
                                                 i_episode      => presc.id_episode,
                                                 i_flg_use_bed  => g_yes);
                    
                        set_pharmacy_log(l_db_object_name,
                                         'CREATE_REQ_PHARM_UNI -- ID_DRUG_PRESC_DET:' || presc.id_drug_presc_det ||
                                         ' ID_DRUG_REQ_DET:' || l_drd_new(1));
                    END IF;
                
                    l_pharm_order_count_all := l_pharm_order_count_all + 1;
                    l_drd_new.delete;
                
                END IF; --check dispense date
            
            END LOOP;
        
            g_error := 'CREATE UNIDOSE ORDERS - END: drug_req_det count=' || l_pharm_order_count || '/' ||
                       l_pharm_order_count_all;
            set_pharmacy_log(l_db_object_name, g_error);
            l_drd_new.delete;
        
        END LOOP;
    
        --[MEDICATION_RULE] if not active prescriptions then raise!
        IF (l_pharm_order_count = 0)
        THEN
            g_error := 'CREATE UNIDOSE ORDERS - END: drug_req_det count=' || l_pharm_order_count;
            set_pharmacy_log(l_db_object_name, g_error);
            RAISE g_ex_unidose_none_for_today;
        END IF;
    
    EXCEPTION
        WHEN g_ex_unidose_none_for_today THEN
            RAISE;
        WHEN OTHERS THEN
            IF (c_cars_to_create%ISOPEN)
            THEN
                CLOSE c_cars_to_create;
            END IF;
            IF (c_prescs_unidose%ISOPEN)
            THEN
                CLOSE c_prescs_unidose;
            END IF;
            RAISE g_ex_unidose_car_gen; --20514
    END create_unidose_reqs_for_id_gen;

    /********************************************************************************************
    * alert.pk_pharmacy.get_unidose_car_occupation  
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_ID_UNIDOSE_CAR                IN    NUMBER(24)
    *
    * @return VARCHAR2
    *
    * @author Pedro Martins Santos
    * @version  2.5.0.7.7.3
    * @since  20/05/2010
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_unidose_car_occupation
    (
        i_lang           IN language.id_language%TYPE,
        i_id_unidose_car IN pharm_unidose_car_slot.id_unidose_car%TYPE
    ) RETURN VARCHAR2 IS
        l_occupation VARCHAR2(4000 CHAR) := '';
    BEGIN
    
        SELECT (SUM(decode(ucs.id_patient, NULL, 0, 1)) || ' ' ||
               pk_message.get_message(i_lang, 'PHARMACIST_DETAIL_SLOT_FULL') || ' / ' ||
               SUM(decode(ucs.id_patient, NULL, 1, 0)) || ' ' ||
               pk_message.get_message(i_lang, 'PHARMACIST_DETAIL_SLOT_EMPTY'))
          INTO l_occupation
          FROM pharm_unidose_car_slot ucs
         WHERE ucs.id_unidose_car = i_id_unidose_car;
    
        RETURN l_occupation;
    
    EXCEPTION
        WHEN no_data_found THEN
            RETURN NULL;
        WHEN OTHERS THEN
            RAISE;
    END get_unidose_car_occupation;

    /********************************************************************************************
    * alert.pk_pharmacy.get_unidose_pat_slots  
    *
    * @param  I_ID_UNIDOSE_CAR                IN    NUMBER(24)
    * @param  I_ID_PATIENT                    IN    NUMBER(24)
    *
    * @return VARCHAR2
    *
    * @author Pedro Martins Santos
    * @version  2.5.0.7.7.3
    * @since  20/05/2010
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_unidose_pat_slots
    (
        i_id_unidose_car IN pharm_unidose_car.id_unidose_car%TYPE,
        i_id_patient     IN episode.id_patient%TYPE
    ) RETURN VARCHAR2 IS
        l_pat_slots VARCHAR2(4000 CHAR) := '';
        l_sep       VARCHAR2(2 CHAR) := ', ';
    BEGIN
        FOR slot_rec IN (SELECT DISTINCT oc.slot_number
                           FROM TABLE(get_orders_for_car(i_id_unidose_car)) oc
                          INNER JOIN drug_req_det drd
                             ON (oc.id_drug_req_det = drd.id_drug_req_det)
                          INNER JOIN drug_req dr
                             ON (drd.id_drug_req = dr.id_drug_req)
                          WHERE dr.id_patient = i_id_patient
                            AND oc.slot_number IS NOT NULL
                          ORDER BY 1)
        LOOP
            l_pat_slots := l_pat_slots || l_sep || slot_rec.slot_number;
        END LOOP;
    
        IF (l_pat_slots IS NULL)
        THEN
            l_pat_slots := '--';
        ELSE
            l_pat_slots := ltrim(l_pat_slots, l_sep);
        END IF;
    
        RETURN l_pat_slots;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_unidose_pat_slots;

    --END: private methods
    -- ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - *****
    --BEGIN: public methods

    /********************************************************************************************
    * alert.pk_pharmacy.check_last_order_for_presc
    *
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DRUG_PRESC_DET             IN    NUMBER(24)
    *
    * @return VARCHAR2
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-09-15
    *
    ********************************************************************************************/
    FUNCTION check_last_order_for_presc
    (
        i_prof              IN alert.profissional,
        i_id_drug_presc_det IN drug_presc_det.id_drug_presc_det%TYPE,
        i_id_drug_req_det   IN drug_req_det.id_drug_req_det%TYPE DEFAULT NULL
    ) RETURN VARCHAR2 IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'check_last_order_for_presc';
        --
        l_flg_status VARCHAR2(3 CHAR) := ''; --HN(I)=notes, HR(i)=rejected
        l_id_drd     drug_req_det.id_drug_req_det%TYPE := NULL;
        l_suffix     VARCHAR2(1 CHAR) := '';
    BEGIN
        IF (i_id_drug_req_det IS NULL)
        THEN
            g_error  := 'GET LAST PHARMACY REQUEST FOR PRESCRIPTION (already "worked" by the pharmacist)';
            l_id_drd := get_last_order_for_presc(i_prof, i_id_drug_presc_det);
        ELSE
            l_id_drd := i_id_drug_req_det;
            l_suffix := g_flg_int;
        END IF;
    
        --set_pharmacy_log(l_db_object_name, 'l_id_drd=' || l_id_drd || '#l_suffix=' || l_suffix);
    
        g_error := 'check if drd was modified';
        SELECT decode(COUNT(1), 1, 'HN' || l_suffix, NULL)
          INTO l_flg_status
          FROM pharm_drd_switch pds
         WHERE pds.id_drug_req_det_new = l_id_drd
           AND rownum = 1;
    
        --set_pharmacy_log(l_db_object_name, 'g_error=' || g_error || '#l_flg_status=' || l_flg_status);
    
        IF (l_flg_status IS NULL)
        THEN
            g_error := 'check if drd was rejected';
            SELECT decode(COUNT(1), 1, 'HR' || l_suffix, NULL)
              INTO l_flg_status
              FROM drug_req_det drd, drug_req dr
             WHERE drd.id_drug_req_det = l_id_drd
               AND drd.id_drug_req = dr.id_drug_req
               AND drd.id_state = get_state_for_req_type(i_prof, dr.flg_type, g_drd_rejected_st);
        
            --set_pharmacy_log(l_db_object_name, 'g_error=' || g_error || '#l_flg_status=' || l_flg_status);
        END IF;
    
        IF (l_flg_status IS NULL)
        THEN
            g_error := 'check if drs was delivered to the patient';
            SELECT decode(SUM(v1.n), 0, NULL, 'HP' || l_suffix)
              INTO l_flg_status
              FROM (SELECT COUNT(1) n
                      FROM drug_req_sup_state_transition drsst
                     INNER JOIN drug_req_supply drs
                        ON (drsst.id_drug_req_supply = drs.id_drug_req_supply)
                     INNER JOIN drug_req_det drd
                        ON (drs.id_drug_req_det = drd.id_drug_req_det)
                     INNER JOIN drug_req dr
                        ON (drd.id_drug_req = dr.id_drug_req)
                     WHERE drs.id_drug_req_det = l_id_drd
                       AND dr.flg_type = g_flg_int
                       AND drsst.id_state = get_state_for_req_type(i_prof, NULL, g_drs_delivered2pat_st)) v1;
        END IF;
    
        IF (l_flg_status IS NULL)
        THEN
            g_error := 'check if drs was delivered in the service';
            SELECT decode(SUM(v1.n), 0, NULL, 'HD' || l_suffix)
              INTO l_flg_status
              FROM (SELECT COUNT(1) n
                      FROM drug_req_sup_state_transition drsst
                     INNER JOIN drug_req_supply drs
                        ON (drsst.id_drug_req_supply = drs.id_drug_req_supply)
                     INNER JOIN drug_req_det drd
                        ON (drs.id_drug_req_det = drd.id_drug_req_det)
                     INNER JOIN drug_req dr
                        ON (drd.id_drug_req = dr.id_drug_req)
                     WHERE drs.id_drug_req_det = l_id_drd
                       AND drsst.id_state = get_state_for_req_type(i_prof, NULL, g_drs_supplied_st)) v1;
        END IF;
    
        IF (l_flg_status IS NULL)
        THEN
            g_error := 'check if drd has notes';
            SELECT decode(SUM(v1.n), 0, NULL, 'HN' || l_suffix)
              INTO l_flg_status
              FROM (SELECT COUNT(1) n
                      FROM drug_req_det_state_transition drdst, drug_req_det drd, drug_req dr
                     WHERE drdst.id_drug_req_det = l_id_drd
                       AND drdst.notes1 IS NOT NULL
                       AND drdst.id_drug_req_det = drd.id_drug_req_det
                       AND drd.id_drug_req = dr.id_drug_req
                       AND drdst.id_state IN
                           (SELECT column_value
                              FROM TABLE(get_states_for_req_type(i_prof,
                                                                 dr.flg_type,
                                                                 table_varchar(g_drd_executing_st,
                                                                               g_drd_terminated_st,
                                                                               g_drd_canceled_st,
                                                                               g_drd_validated_st,
                                                                               g_drd_waiting_approv_st,
                                                                               g_drd_validated_sign_st))))
                    UNION ALL
                    SELECT COUNT(1) n
                      FROM drug_req_sup_state_transition drsst, drug_req_supply drs, drug_req_det drd, drug_req dr
                     WHERE drsst.id_drug_req_supply = drs.id_drug_req_supply
                       AND drs.id_drug_req_det = l_id_drd
                       AND drsst.id_state = get_state_for_req_type(i_prof, dr.flg_type, g_drs_readyfortransp_st)
                       AND drsst.notes1 IS NOT NULL
                       AND drs.id_drug_req_det = drd.id_drug_req_det
                       AND drd.id_drug_req = dr.id_drug_req) v1;
        
            --set_pharmacy_log(l_db_object_name, 'g_error=' || g_error || '#l_flg_status=' || l_flg_status);
        END IF;
    
        RETURN l_flg_status;
    
    EXCEPTION
        WHEN OTHERS THEN
            RETURN NULL;
    END check_last_order_for_presc;

    /********************************************************************************************
    * alert.pk_pharmacy.get_notes_for_physician
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DRUG_REQ_DET               IN    NUMBER(24)
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  O_PRESC                         OUT   REF CURSOR
    * @param  O_REQ_NOTES                     OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-09-15
    *
    ********************************************************************************************/
    FUNCTION get_notes_for_physician
    (
        i_lang              IN language.id_language%TYPE,
        i_prof              IN alert.profissional,
        i_id_drug_presc_det IN drug_presc_det.id_drug_presc_det%TYPE,
        i_get_headers       IN VARCHAR2 DEFAULT 'N',
        i_header_codes      IN table_varchar DEFAULT NULL,
        o_notes_type        OUT VARCHAR2, -- PHARM_NOTES | PHARM_REJECT | PHARM_MED_CHANGE | PHARM_INSTR_CHANGE
        o_presc             OUT pk_types.cursor_type,
        o_req_notes         OUT pk_types.cursor_type,
        o_headers           OUT pk_types.cursor_type,
        o_med_change        OUT pk_types.cursor_type,
        o_error             OUT t_error_out
    ) RETURN BOOLEAN IS
        l_id_drd             drug_req_det.id_drug_req_det%TYPE := NULL;
        l_count              NUMBER(1) := 0;
        l_count_med_change   NUMBER(1) := 0;
        l_count_instr_change NUMBER(1) := 0;
    BEGIN
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error  := 'GET LAST PHARMACY REQUEST FOR PRESCRIPTION (already "worked" by the pharmacist)';
        l_id_drd := get_last_order_for_presc(i_prof, i_id_drug_presc_det);
    
        IF (l_id_drd IS NULL)
        THEN
            pk_types.open_my_cursor(o_presc);
            pk_types.open_my_cursor(o_req_notes);
            pk_types.open_my_cursor(o_med_change);
            o_notes_type := 'PHARM_NOTES';
        ELSE
            g_error := 'query order description';
            OPEN o_presc FOR
                SELECT get_medication_name(i_lang,
                                           i_prof,
                                           drd.id_drug,
                                           drd.vers,
                                           dr.flg_type,
                                           dr.id_drug_presc_det,
                                           g_yes,
                                           drd.id_other_product) pharm,
                       get_drug_desc_instr(i_lang, i_prof, dr.id_episode, drd.id_drug_req_det) instr,
                       pk_date_utils.date_send_tsz(i_lang, dpd.dt_begin_tstz, i_prof) begin_date,
                       pk_date_utils.date_send_tsz(i_lang, dpd.dt_end_tstz, i_prof) end_date
                  FROM drug_req_det drd, drug_req dr, drug_presc_det dpd
                 WHERE drd.id_drug_req_det = l_id_drd
                   AND drd.id_drug_req = dr.id_drug_req
                   AND dr.id_drug_presc_det = dpd.id_drug_presc_det(+);
        
            g_error := 'query order notes';
            OPEN o_req_notes FOR
                SELECT drdst.notes1 notes, drdst.dt_state
                  FROM drug_req_det_state_transition drdst, drug_req_det drd, drug_req dr
                 WHERE drdst.id_drug_req_det = l_id_drd
                   AND drdst.notes1 IS NOT NULL
                   AND drdst.id_drug_req_det = drd.id_drug_req_det
                   AND drd.id_drug_req = dr.id_drug_req
                   AND drdst.id_state IN
                       (SELECT column_value
                          FROM TABLE(get_states_for_req_type(i_prof,
                                                             dr.flg_type,
                                                             table_varchar(g_drd_executing_st,
                                                                           g_drd_terminated_st,
                                                                           g_drd_rejected_st,
                                                                           g_drd_validated_st,
                                                                           g_drd_waiting_approv_st,
                                                                           g_drd_validated_sign_st))))
                UNION ALL
                SELECT drsst.notes1 notes, drsst.dt_state
                  FROM drug_req_supply drs, drug_req_sup_state_transition drsst
                 WHERE drs.id_drug_req_det = l_id_drd
                   AND drsst.notes1 IS NOT NULL
                   AND drs.id_drug_req_supply = drsst.id_drug_req_supply
                   AND drsst.id_state = pk_pharmacy.get_state_for_req_type(i_prof, NULL, g_drs_readyfortransp_st)
                 ORDER BY dt_state;
        
            g_error := 'note type';
            SELECT COUNT(1)
              INTO l_count
              FROM drug_req_det_state_transition drdst, drug_req_det drd, drug_req dr
             WHERE drdst.id_drug_req_det = l_id_drd
               AND drdst.notes1 IS NOT NULL
               AND drdst.id_drug_req_det = drd.id_drug_req_det
               AND drd.id_drug_req = dr.id_drug_req
               AND drdst.id_state = get_state_for_req_type(i_prof, dr.flg_type, g_drd_rejected_st)
               AND rownum = 1;
        
            --pharmacist medications switch
            OPEN o_med_change FOR
            --old
                SELECT pk_translation.get_translation(i_lang, 'PHARMACIST_DETAIL_REQ_MODIFY') state_name,
                       pk_medication_core.format_detail_date(i_lang, i_prof, pds.dt_drd_switch) dt_state,
                       pk_prof_utils.get_name_signature(i_lang, i_prof, pds.id_prof) prof_name,
                       pk_date_utils.add_to_ltstz(pds.dt_drd_switch, 1, 'SECOND') dt,
                       
                       get_medication_name(i_lang,
                                           i_prof,
                                           drd_old.id_drug,
                                           drd_old.vers,
                                           dr_old.flg_type,
                                           dr_old.id_drug_presc_det,
                                           g_yes,
                                           drd_old.id_other_product) pharm,
                       get_drug_desc_instr(i_lang, i_prof, dr_old.id_episode, drd_old.id_drug_req_det) instr,
                       pk_date_utils.date_send_tsz(i_lang, dpd.dt_begin_tstz, i_prof) begin_date,
                       pk_date_utils.date_send_tsz(i_lang, dpd.dt_end_tstz, i_prof) end_date,
                       NULL prof_name_co_sign,
                       NULL date_co_sign,
                       NULL type_co_sign
                  FROM pharm_drd_switch pds
                 INNER JOIN drug_req_det drd_old
                    ON (pds.id_drug_req_det_old = drd_old.id_drug_req_det)
                 INNER JOIN drug_req dr_old
                    ON (drd_old.id_drug_req = dr_old.id_drug_req)
                  LEFT JOIN drug_presc_det dpd
                    ON (dr_old.id_drug_presc_det = dpd.id_drug_presc_det)
                 WHERE (pds.id_drug_req_det_old = l_id_drd OR pds.id_drug_req_det_new = l_id_drd)
                UNION ALL
                --new
                SELECT NULL              state_name,
                       NULL              dt_state,
                       NULL              prof_name,
                       pds.dt_drd_switch dt,
                       
                       get_medication_name(i_lang,
                                           i_prof,
                                           drd_new.id_drug,
                                           drd_new.vers,
                                           dr_new.flg_type,
                                           dr_new.id_drug_presc_det,
                                           g_yes,
                                           drd_new.id_other_product) pharm,
                       get_drug_desc_instr(i_lang, i_prof, dr_new.id_episode, drd_new.id_drug_req_det) instr,
                       pk_date_utils.date_send_tsz(i_lang, dpd.dt_begin_tstz, i_prof) begin_date,
                       pk_date_utils.date_send_tsz(i_lang, dpd.dt_end_tstz, i_prof) end_date,
                       pk_prof_utils.get_name_signature(i_lang, i_prof, drd_new.id_prof_co_sign) prof_name_co_sign,
                       pk_date_utils.date_send_tsz(i_lang, drd_new.dt_co_sign, i_prof) date_co_sign,
                       pk_translation.get_translation(i_lang, ot.code_order_type) ||
                       format_notes(table_varchar(drd_new.notes_co_sign), g_no, g_no, ' / ') type_co_sign
                  FROM pharm_drd_switch pds
                 INNER JOIN drug_req_det drd_new
                    ON (pds.id_drug_req_det_new = drd_new.id_drug_req_det)
                 INNER JOIN drug_req dr_new
                    ON (drd_new.id_drug_req = dr_new.id_drug_req)
                  LEFT JOIN order_type ot
                    ON (drd_new.id_type_co_sign = ot.id_order_type)
                  LEFT JOIN drug_presc_det dpd
                    ON (dr_new.id_drug_presc_det = dpd.id_drug_presc_det)
                 WHERE (pds.id_drug_req_det_old = l_id_drd OR pds.id_drug_req_det_new = l_id_drd);
        
            SELECT COUNT(1)
              INTO l_count_med_change
              FROM pharm_drd_switch pds
             WHERE pds.id_drug_req_det_new = l_id_drd
               AND rownum = 1;
        
            IF (l_count_med_change != 0)
            THEN
                o_notes_type := 'PHARM_MED_CHANGE';
            ELSIF (l_count_instr_change != 0)
            THEN
                o_notes_type := 'PHARM_INSTR_CHANGE'; --TBD: alteracao de instrucoes por parte do farmaceutico!
            ELSIF (l_count != 0)
            THEN
                o_notes_type := 'PHARM_REJECT';
            ELSE
                o_notes_type := 'PHARM_NOTES';
            END IF;
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_notes_for_physician', o_error);
            pk_types.open_my_cursor(o_presc);
            pk_types.open_my_cursor(o_req_notes);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_med_change);
            RETURN FALSE;
    END get_notes_for_physician;

    /********************************************************************************************
    * alert.pk_pharmacy.get_notes_from_drd
    *
    * @param  I_ID_DRUG_REQ_DET               IN    NUMBER(24)
    * @param  I_ID_STATE                      IN    ALERT.TABLE_NUMBER
    * @param  I_NOTE_NUMBER                   IN    NUMBER
    * @param  I_MOST_RECENT                   IN    VARCHAR2
    *
    * @return VARCHAR2
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-02
    *
    ********************************************************************************************/
    FUNCTION get_notes_from_drd
    (
        i_id_drug_req_det IN drug_req_det_state_transition.id_drug_req_det%TYPE,
        i_id_state        IN table_number,
        i_note_number     IN NUMBER DEFAULT 1,
        i_most_recent     IN VARCHAR2 DEFAULT 'Y'
    ) RETURN VARCHAR2 IS
        l_notes1 drug_req_det_state_transition.notes1%TYPE;
        l_notes2 drug_req_det_state_transition.notes1%TYPE;
        l_notes  drug_req_det_state_transition.notes1%TYPE;
    BEGIN
        IF (i_most_recent = g_yes)
        THEN
            SELECT v1.notes1, v1.notes2
              INTO l_notes1, l_notes2
              FROM (SELECT drdst.notes1, drdst.notes2
                      FROM drug_req_det_state_transition drdst
                     WHERE drdst.id_drug_req_det = i_id_drug_req_det
                       AND drdst.id_state IN (SELECT column_value
                                                FROM TABLE(i_id_state))
                     ORDER BY drdst.dt_state DESC --most recent
                    ) v1
             WHERE rownum = 1;
        
        ELSE
        
            SELECT v1.notes1, v1.notes2
              INTO l_notes1, l_notes2
              FROM (SELECT drdst.notes1, drdst.notes2
                      FROM drug_req_det_state_transition drdst
                     WHERE drdst.id_drug_req_det = i_id_drug_req_det
                       AND drdst.id_state IN (SELECT column_value
                                                FROM TABLE(i_id_state))
                     ORDER BY drdst.dt_state --oldest
                    ) v1
             WHERE rownum = 1;
        END IF;
    
        l_notes := CASE i_note_number
                       WHEN 1 THEN
                        l_notes1
                       WHEN 2 THEN
                        l_notes2
                       ELSE
                        ''
                   END;
    
        RETURN l_notes;
    
    EXCEPTION
        WHEN OTHERS THEN
            RETURN ''; --no data found
    END get_notes_from_drd;

    /********************************************************************************************
    * alert.pk_pharmacy.get_notes_from_drs
    *
    * @param  I_ID_DRUG_REQ_DET               IN    NUMBER(24)
    * @param  I_ID_STATE                      IN    ALERT.TABLE_NUMBER
    * @param  I_NOTE_NUMBER                   IN    NUMBER
    * @param  I_MOST_RECENT                   IN    VARCHAR2
    *
    * @return VARCHAR2
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-07-01
    *
    ********************************************************************************************/
    FUNCTION get_notes_from_drs
    (
        i_id_drug_req_det IN drug_req_det.id_drug_req_det%TYPE,
        i_id_state        IN table_number,
        i_note_number     IN NUMBER DEFAULT 1,
        i_most_recent     IN VARCHAR2 DEFAULT 'Y'
    ) RETURN VARCHAR2 IS
        l_notes1 drug_req_sup_state_transition.notes1%TYPE;
        l_notes2 drug_req_sup_state_transition.notes1%TYPE;
        l_notes  drug_req_sup_state_transition.notes1%TYPE;
    BEGIN
        IF (i_most_recent = g_yes)
        THEN
        
            SELECT v1.notes1, v1.notes2
              INTO l_notes1, l_notes2
              FROM (SELECT drsst.notes1, drsst.notes2
                      FROM drug_req_sup_state_transition drsst, drug_req_supply drs
                     WHERE drsst.id_drug_req_supply = drs.id_drug_req_supply
                       AND drs.id_drug_req_det = i_id_drug_req_det
                       AND drsst.id_state IN (SELECT column_value
                                                FROM TABLE(i_id_state))
                     ORDER BY drsst.dt_state DESC --most recent
                    ) v1
             WHERE rownum = 1;
        
        ELSE
        
            SELECT v1.notes1, v1.notes2
              INTO l_notes1, l_notes2
              FROM (SELECT drsst.notes1, drsst.notes2
                      FROM drug_req_sup_state_transition drsst, drug_req_supply drs
                     WHERE drsst.id_drug_req_supply = drs.id_drug_req_supply
                       AND drs.id_drug_req_det = i_id_drug_req_det
                       AND drsst.id_state IN (SELECT column_value
                                                FROM TABLE(i_id_state))
                     ORDER BY drsst.dt_state --oldest
                    ) v1
             WHERE rownum = 1;
        END IF;
    
        l_notes := CASE i_note_number
                       WHEN 1 THEN
                        l_notes1
                       WHEN 2 THEN
                        l_notes2
                       ELSE
                        ''
                   END;
    
        RETURN l_notes;
    
    EXCEPTION
        WHEN OTHERS THEN
            RETURN ''; --no data found
    END get_notes_from_drs;

    /********************************************************************************************
    * alert.pk_pharmacy.format_notes  
    *
    * @param  I_NOTES                         IN    ALERT.TABLE_VARCHAR
    * @param  I_FLG_WITH_BREAK                IN    VARCHAR2
    * @param  I_FLG_SHOW_DASH                 IN    VARCHAR2
    * @param  I_PREFIX                        IN    VARCHAR2
    *
    * @return VARCHAR2
    *
    * @author Rui Marante
    * @version  2.5.0.7.8
    * @since  2010-04-15
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION format_notes
    (
        i_notes          IN table_varchar,
        i_flg_with_break IN VARCHAR2 DEFAULT 'Y',
        i_flg_show_dash  IN VARCHAR2 DEFAULT 'Y',
        i_prefix         IN VARCHAR2 DEFAULT ''
    ) RETURN VARCHAR2 IS
        l_idx   NUMBER := 0;
        l_count NUMBER := 0;
        l_notes VARCHAR2(32000 CHAR) := '';
        l_break VARCHAR2(5 CHAR) := '<br/>';
    BEGIN
        IF (i_flg_with_break != g_yes)
        THEN
            l_break := '';
        END IF;
    
        l_count := i_notes.count;
    
        FOR l_idx IN 1 .. l_count
        LOOP
            IF (i_notes(l_idx) IS NOT NULL)
            THEN
                l_notes := l_notes || l_break || i_notes(l_idx);
            END IF;
        END LOOP;
    
        IF (l_notes IS NULL AND i_flg_show_dash = g_yes)
        THEN
            l_notes := g_null_notes;
        END IF;
    
        IF (l_notes IS NOT NULL)
        THEN
            l_notes := i_prefix || l_notes;
        END IF;
    
        RETURN l_notes;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END format_notes;

    /********************************************************************************************
    * alert.pk_pharmacy.row_is_visible
    *
    * @param  I_ID_STATE                      IN    NUMBER(24)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_UNITS                         IN    VARCHAR2
    * @param  I_DT_1                          IN    TIMESTAMP WITH LOCAL TIME ZONE
    * @param  I_DT_2                          IN    TIMESTAMP WITH LOCAL TIME ZONE
    * @param  I_FLG_HISTORY                   IN    VARCHAR2
    * @param  I_NO_NEGATIVES                  IN    VARCHAR2
    *
    * @return VARCHAR2
    *
    * @author Rui Marante
    * @version  2.5.0.7.3
    * @since  2009-12-04
    *
    ********************************************************************************************/
    FUNCTION row_is_visible
    (
        i_id_state     IN wfl_state.id_state%TYPE,
        i_prof         IN profissional,
        i_units        IN VARCHAR2 DEFAULT 'H', -- H = horas | D = dias
        i_dt_1         IN drug_req_det_state_transition.dt_state%TYPE,
        i_dt_2         IN drug_req_det_state_transition.dt_state%TYPE,
        i_flg_history  IN VARCHAR2 DEFAULT 'N',
        i_no_negatives IN VARCHAR2 DEFAULT 'N'
    ) RETURN VARCHAR2 IS
        l_grid_time_out NUMBER := 0;
        l_dt_diff_days  NUMBER := 0;
        l_ret           VARCHAR2(1 CHAR) := g_no;
    BEGIN
        IF (i_flg_history = g_yes)
        THEN
            --history, so show everything!
            l_ret := g_yes;
        ELSE
            --show only the rows not "expired"
            l_grid_time_out := get_grid_timeout(i_id_state, i_prof, i_units);
            l_dt_diff_days  := pk_date_utils.get_timestamp_diff(i_dt_1, i_dt_2);
        
            IF (i_no_negatives = g_yes)
            THEN
                l_dt_diff_days := abs(l_dt_diff_days);
            END IF;
        
            IF (l_grid_time_out > l_dt_diff_days)
            THEN
                l_ret := g_yes;
            ELSE
                l_ret := g_no;
            END IF;
        END IF;
    
        RETURN l_ret;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END row_is_visible;

    /********************************************************************************************
    * alert.pk_pharmacy.get_grid_timeout
    *
    * @param  I_ID_STATE                      IN    NUMBER(5)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_UNITS                         IN    VARCHAR2
    *
    * @return NUMBER
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-02
    *
    ********************************************************************************************/
    FUNCTION get_grid_timeout
    (
        i_id_state IN wfl_state.id_state%TYPE,
        i_prof     IN profissional,
        i_units    IN VARCHAR2 DEFAULT 'H' -- H = horas | D = dias
    ) RETURN NUMBER DETERMINISTIC IS
        l_timeout   NUMBER := 0;
        l_prof_type profile_template.flg_type%TYPE := 'P';
    BEGIN
        BEGIN
            l_prof_type := get_prof_type(i_prof);
        EXCEPTION
            WHEN OTHERS THEN
                l_prof_type := 'P'; --se faltar a configuracao, assume 'P' (para o caso pode ser)
        END;
    
        SELECT wsd.grid_timeout
          INTO l_timeout
          FROM wfl_state_detail wsd
         WHERE wsd.state = i_id_state
           AND wsd.prof_type = l_prof_type;
    
        IF (i_units = 'D')
        THEN
            l_timeout := (l_timeout / 24);
        END IF;
    
        RETURN l_timeout;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_grid_timeout;

    /********************************************************************************************
    * alert.pk_pharmacy.get_qty_pending (overload 1)  (DETERMINISTIC)
    *
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DRUG_REQ_DET               IN    ALERT.TABLE_NUMBER
    * @param  I_FLG_RETURN_QTPREP             IN    VARCHAR2
    * @param  I_DT_DUMMY_CACHE                IN    TIMESTAMP WITH LOCAL TIME ZONE
    *
    * @return NUMBER
    *
    * @author Rui Marante
    * @version  2.5.0.7.1
    * @since  2009-11-11
    *
    ********************************************************************************************/
    FUNCTION get_qty_pending
    (
        i_prof              IN profissional,
        i_id_drug_req_det   IN table_number,
        i_flg_return_qtprep IN VARCHAR2 DEFAULT 'N', --return qt_to_prep if qt_pending is ZERO
        i_flg_return_null   IN VARCHAR2 DEFAULT 'N', --return null if l_ret is ZERO
        i_dt_dummy_cache    IN TIMESTAMP WITH LOCAL TIME ZONE DEFAULT NULL -- change this to overwrite the DETERMINISTIC (this parameter is not used in the function)
    ) RETURN NUMBER DETERMINISTIC IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'get_qty_pending';
        --
        l_qty_to_prep NUMBER := 0;
        l_qty_pending NUMBER := 0;
        l_ret         NUMBER := 0;
    BEGIN
        --set_pharmacy_log(l_db_object_name, 'query');
    
        SELECT SUM(nvl(drd.qty_to_prep, 0)), SUM(nvl(drd.qty_to_prep, 0) - nvl(drs.qty_supply, 0))
          INTO l_qty_to_prep, l_qty_pending
          FROM drug_req_det drd
          LEFT JOIN drug_req_supply drs
            ON (drd.id_drug_req_det = drs.id_drug_req_det AND
               drs.id_state != get_state_for_req_type(i_prof, NULL, g_drs_rejected_st))
         WHERE drd.id_drug_req_det IN (SELECT column_value
                                         FROM TABLE(i_id_drug_req_det));
    
        --!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        IF (i_flg_return_qtprep = g_yes AND l_qty_pending = 0)
        THEN
            l_ret := l_qty_to_prep;
        ELSE
            l_ret := l_qty_pending;
        END IF;
    
        IF (i_flg_return_null = g_yes AND l_ret = 0)
        THEN
            l_ret := NULL;
        END IF;
        --!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    
        RETURN l_ret;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_qty_pending;

    /********************************************************************************************
    * alert.pk_pharmacy.get_qty_pending (overload 2)
    *
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DRUG_REQ_DET               IN    NUMBER(24)
    * @param  I_FLG_RETURN_NULL               IN    VARCHAR2
    *
    * @return NUMBER
    *
    * @author Rui Marante
    * @version  2.5.0.7.1
    * @since  2009-11-11
    *
    ********************************************************************************************/
    FUNCTION get_qty_pending
    (
        i_prof            IN profissional,
        i_id_drug_req_det IN drug_req_det.id_drug_req_det%TYPE,
        i_flg_return_null IN VARCHAR2 DEFAULT 'N'
    ) RETURN NUMBER IS
        l_qty_pending NUMBER := 0;
    BEGIN
        SELECT nvl(drd.qty_to_prep, 0) - SUM(nvl(drs.qty_supply, 0))
          INTO l_qty_pending
          FROM drug_req_det drd, drug_req_supply drs
         WHERE drd.id_drug_req_det = i_id_drug_req_det
           AND drd.id_drug_req_det = drs.id_drug_req_det(+)
           AND drs.id_state(+) != get_state_for_req_type(i_prof, NULL, g_drs_rejected_st)
         GROUP BY drd.qty_to_prep;
    
        IF (i_flg_return_null = g_yes AND l_qty_pending = 0)
        THEN
            --[MEDICATION_RULE] if qty pending is ZERO, some times a NULL is needed. (i_flg_return_null = g_yes)
            l_qty_pending := NULL;
        END IF;
    
        RETURN l_qty_pending;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_qty_pending;

    /********************************************************************************************
    * alert.pk_pharmacy.get_meds_with_same_dci
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_DRUG_REQ_DET                  IN    NUMBER(24)
    * @param  O_PHARM_OPTIONS                 OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.8
    * @since  2010-03-31
    *
    * @notes
    *
    ********************************************************************************************/
    FUNCTION get_meds_with_same_dci
    (
        i_lang          IN language.id_language%TYPE,
        i_prof          IN alert.profissional,
        i_drug_req_det  IN drug_req_det.id_drug_req_det%TYPE,
        o_pharm_options OUT pk_types.cursor_type,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
        l_id_drug drug_req_det.id_drug%TYPE;
        l_vers    drug_req_det.vers%TYPE;
    BEGIN
        --get drug id and market
        SELECT drd.id_drug, drd.vers
          INTO l_id_drug, l_vers
          FROM drug_req_det drd
         WHERE drd.id_drug_req_det = i_drug_req_det;
    
        --it cannot be an other_product nor an IV_Fluid
        IF (l_id_drug IS NOT NULL AND l_id_drug != g_drug_iv_fluid_constructed)
        THEN
        
            OPEN o_pharm_options FOR
                SELECT a.med_id data, l_vers vers, a.med_descr label, a.flg_default
                  FROM TABLE(pk_medication_core.get_related_meds(i_lang, i_prof, 'I', l_id_drug, g_no, g_yes, g_no)) a
                 ORDER BY a.flg_default DESC, a.med_descr;
        
        ELSE
            pk_types.open_my_cursor(o_pharm_options);
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_meds_with_same_dci', o_error);
            pk_types.open_my_cursor(o_pharm_options);
            RETURN FALSE;
    END get_meds_with_same_dci;

    -- *********** pk_prescription_directions -- BEGIN
    --this functions came from pk_irregular directions (TEMP) - TBD: remove this from here and use function from the original package

    FUNCTION concat_if_not_null
    (
        i_str         IN VARCHAR2,
        i_limiter     IN VARCHAR2 DEFAULT '; ',
        i_flg_limiter IN VARCHAR2 DEFAULT 'Y'
    ) RETURN VARCHAR2 IS
        l_limiter VARCHAR2(10 CHAR) := '';
    BEGIN
        IF (i_flg_limiter = g_yes)
        THEN
            l_limiter := i_limiter;
        END IF;
    
        IF (i_str IS NULL OR i_str = '---')
        THEN
            RETURN '';
        ELSE
            RETURN i_str || l_limiter;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END concat_if_not_null;

    FUNCTION get_drug_iv_instr
    (
        i_lang  IN language.id_language%TYPE,
        i_prof  IN alert.profissional,
        i_presc IN drug_presc_det.id_drug_presc_det%TYPE
    ) RETURN VARCHAR2 IS
        l_descr_format_inst VARCHAR2(4000 CHAR) := '';
        l_error             t_error_out;
        --
        l_route_desc    mi_route.route_descr%TYPE;
        l_flg_take_type drug_presc_det.flg_take_type%TYPE;
        l_qty           drug_presc_det.qty%TYPE;
        l_unit_qty      drug_presc_det.id_unit_measure%TYPE;
        l_value_bolus   drug_presc_det.value_bolus%TYPE;
        l_unit_bolus    drug_presc_det.id_unit_measure_bolus%TYPE;
        l_value_drip    drug_presc_det.value_drip%TYPE;
        l_unit_drip     drug_presc_det.id_unit_measure_drip%TYPE;
        l_freq          drug_presc_det.frequency%TYPE;
        l_unit_freq     drug_presc_det.id_unit_measure_freq%TYPE;
        l_dt_begin      drug_presc_det.dt_begin_tstz%TYPE;
        l_dt_end        drug_presc_det.dt_end_presc_tstz%TYPE;
        --
        l_message_begin sys_message.desc_message%TYPE;
        l_message_end   sys_message.desc_message%TYPE;
        l_message_bolus sys_message.desc_message%TYPE;
    BEGIN
        l_message_begin := pk_message.get_message(i_lang, pk_medication_core.g_message_inicio) || ': ';
        l_message_end   := pk_message.get_message(i_lang, pk_medication_core.g_message_fim) || ': ';
        l_message_bolus := pk_message.get_message(i_lang, 'PRESCRIPTION_REC_M042');
    
        g_error := 'QUERY 1';
        SELECT
        -- route
         nvl(mr.route_abrv, mr.route_descr),
         -- take type
         dpd.flg_take_type,
         -- qty + unit
         dpd.qty,
         dpd.id_unit_measure,
         -- bolus
         dpd.value_bolus,
         dpd.id_unit_measure_bolus,
         -- drip
         dpd.value_drip,
         dpd.id_unit_measure_drip,
         -- freq
         dpd.frequency,
         dpd.id_unit_measure_freq,
         -- start - end
         dpd.dt_begin_tstz,
         dpd.dt_end_presc_tstz
          INTO l_route_desc,
               l_flg_take_type,
               l_qty,
               l_unit_qty,
               l_value_bolus,
               l_unit_bolus,
               l_value_drip,
               l_unit_drip,
               l_freq,
               l_unit_freq,
               l_dt_begin,
               l_dt_end
          FROM drug_presc_det dpd
         INNER JOIN mi_med mm
            ON (dpd.id_drug = mm.id_drug AND dpd.vers = mm.vers)
         INNER JOIN mi_route mr
            ON (dpd.route_id = mr.route_id AND dpd.vers = mr.vers)
         WHERE dpd.id_drug_presc_det = i_presc;
    
        SELECT '[' || concat_if_not_null(l_route_desc) ||
               concat_if_not_null(pk_sysdomain.get_domain('DRUG_PRESC_DET.FLG_TAKE_TYPE', l_flg_take_type, i_lang)) ||
               decode(l_qty,
                      NULL,
                      '',
                      concat_if_not_null(l_qty, NULL, g_no) ||
                      concat_if_not_null(pk_medication_core.get_unit_translation(i_lang, i_prof, l_unit_qty, 3))) ||
               decode(l_value_bolus,
                      NULL,
                      '',
                      concat_if_not_null(l_value_bolus, NULL, g_no) ||
                      concat_if_not_null(pk_medication_core.get_unit_translation(i_lang, i_prof, l_unit_bolus, 3) || ' ' ||
                                         l_message_bolus)) ||
               decode(l_value_drip,
                      NULL,
                      '',
                      concat_if_not_null(l_value_drip, NULL, g_no) ||
                      concat_if_not_null(pk_medication_core.get_unit_translation(i_lang, i_prof, l_unit_drip, 3))) ||
               decode(l_freq,
                      NULL,
                      '',
                      concat_if_not_null(l_freq, NULL, g_no) ||
                      concat_if_not_null(pk_medication_core.get_unit_translation(i_lang, i_prof, l_unit_freq, 3))) ||
               decode(l_dt_begin,
                      NULL,
                      '',
                      concat_if_not_null(l_message_begin ||
                                         pk_date_utils.date_mon_hour_format_tsz(i_lang, l_dt_begin, i_prof))) ||
               decode(l_dt_end,
                      NULL,
                      '',
                      concat_if_not_null(l_message_end ||
                                         pk_date_utils.date_mon_hour_format_tsz(i_lang, l_dt_end, i_prof))) || ']'
          INTO l_descr_format_inst
          FROM dual;
    
        RETURN l_descr_format_inst;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_drug_iv_instr', l_error);
            RETURN '*';
    END get_drug_iv_instr;

    --this functions came from pk_irregular directions (TEMP) - TBD: remove this from here and use function from the original package
    -- *********** pk_prescription_directions -- BEGIN

    /********************************************************************************************
    * alert.pk_pharmacy.get_drug_desc
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_EPISODE                    IN    NUMBER(24)
    * @param  I_ID_DRD                        IN    NUMBER(24)
    * @param  I_FLG_PREV                      IN    VARCHAR2
    * @param  I_ADV_SCREEN                    IN    VARCHAR2
    *
    * @return VARCHAR2
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-07-07
    *
    ********************************************************************************************/
    FUNCTION get_drug_desc_pharm
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN alert.profissional,
        i_id_episode      IN episode.id_episode%TYPE,
        i_id_drd          IN drug_req_det.id_drug_req_det%TYPE,
        i_prev_msg        IN VARCHAR2 DEFAULT 'N',
        i_screen          IN VARCHAR2 DEFAULT 'N',
        i_pharmacy_format IN VARCHAR2 DEFAULT 'N' -- 'PHARMACY_FORMAT'
    ) RETURN VARCHAR2 IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'get_drug_desc_pharm';
        --
        l_id_dpd           drug_req.id_drug_presc_det%TYPE;
        l_presc            drug_req_det.id_drug_req_det%TYPE;
        l_subject          VARCHAR2(50 CHAR);
        l_return_value     VARCHAR2(4000 CHAR) := '';
        l_id_drug          drug_req_det.id_drug%TYPE;
        l_vers             drug_req_det.vers%TYPE;
        l_flg_type         drug_req.flg_type%TYPE;
        l_irreg_instr      drug_presc_det.id_presc_directions%TYPE;
        l_pharmacy_format  VARCHAR2(200 CHAR) := '';
        l_mm_flg_type      mi_med.flg_type%TYPE;
        l_ret_value        BOOLEAN := FALSE;
        l_id_other_product other_product.id_other_product%TYPE;
        --l_desc_other_product  other_product.other_product_desc%type;
        l_error t_error_out;
    BEGIN
        l_pharmacy_format := i_pharmacy_format;
    
        SELECT dr.id_drug_presc_det,
               drd.id_drug,
               drd.vers,
               dr.flg_type,
               nvl(drd.id_presc_directions, dpd.id_presc_directions),
               mm.flg_type,
               op.id_other_product --, op.other_product_desc
          INTO l_id_dpd, l_id_drug, l_vers, l_flg_type, l_irreg_instr, l_mm_flg_type, l_id_other_product --, l_desc_other_product
          FROM drug_req_det drd
         INNER JOIN drug_req dr
            ON (drd.id_drug_req = dr.id_drug_req)
          LEFT JOIN drug_presc_det dpd
            ON (dr.id_drug_presc_det = dpd.id_drug_presc_det)
          LEFT JOIN mi_med mm
            ON (drd.id_drug = mm.id_drug AND drd.vers = mm.vers)
          LEFT JOIN other_product op
            ON (drd.id_other_product = op.id_other_product AND drd.vers = op.vers)
         WHERE drd.id_drug_req_det = i_id_drd;
    
        IF (l_id_other_product IS NOT NULL)
        THEN
            l_presc   := l_id_dpd;
            l_subject := pk_medication_core.g_other_prod;
        ELSIF (l_id_dpd IS NULL)
        THEN
            l_presc   := i_id_drd;
            l_subject := pk_medication_core.g_hospital;
        ELSE
            l_presc   := l_id_dpd;
            l_subject := pk_medication_core.g_local;
        END IF;
    
        IF (l_id_other_product IS NOT NULL)
        THEN
            l_pharmacy_format := 'PHARMACY_FORMAT';
        ELSIF (l_mm_flg_type IS NOT NULL AND l_mm_flg_type = 'F')
        THEN
            l_pharmacy_format := 'PHARMACY_FORMAT_IV';
        ELSIF (l_irreg_instr IS NOT NULL AND l_pharmacy_format = 'PHARMACY_FORMAT')
        THEN
            l_pharmacy_format := 'PHARMACY_FORMAT_IRREGULAR';
        END IF;
    
        IF (l_pharmacy_format = 'PHARMACY_FORMAT_IV')
        THEN
        
            g_error := 'get_medication_name + get_drug_iv_instr';
            --set_pharmacy_log(l_db_object_name, g_error);
            l_return_value := '<b>' || get_medication_name(i_lang        => i_lang,
                                                           i_prof        => i_prof,
                                                           i_id_drug     => l_id_drug,
                                                           i_version     => l_vers,
                                                           i_dr_flg_type => l_flg_type,
                                                           i_id_dpd      => l_id_dpd) || '</b><br/>' ||
                              get_drug_iv_instr(i_lang => i_lang, i_prof => i_prof, i_presc => l_id_dpd);
        
        ELSIF (l_pharmacy_format = 'PHARMACY_FORMAT_IRREGULAR')
        THEN
        
            g_error     := 'get_medication_name + get_presc_dir_description';
            l_ret_value := pk_prescription_directions.get_presc_dir_description(i_lang                  => i_lang,
                                                                                i_prof                  => i_prof,
                                                                                i_id_presc_directions   => l_irreg_instr,
                                                                                i_id_drug               => NULL,
                                                                                i_presc_directions      => NULL,
                                                                                i_presc_dir_interval    => NULL,
                                                                                i_presc_dir_dosefreq    => NULL,
                                                                                i_presc_dir_freqdet     => NULL,
                                                                                o_presc_dir_description => l_return_value,
                                                                                o_error                 => l_error);
        
            --set_pharmacy_log(l_db_object_name, 'l_irreg_instr=' || l_irreg_instr || '#l_return_value=' || l_return_value);
        
            IF (NOT l_ret_value)
            THEN
                l_return_value := '--';
            END IF;
        
            l_return_value := '<b>' || get_medication_name(i_lang             => i_lang,
                                                           i_prof             => i_prof,
                                                           i_id_drug          => l_id_drug,
                                                           i_version          => l_vers,
                                                           i_dr_flg_type      => l_flg_type,
                                                           i_id_dpd           => l_id_dpd,
                                                           i_id_other_product => l_id_other_product) || '</b><br/>' ||
                              l_return_value;
        
        ELSIF (l_pharmacy_format = 'PHARMACY_FORMAT')
        THEN
        
            g_error        := 'get_medication_name + get_drug_desc_instr';
            l_return_value := '<b>' || get_medication_name(i_lang             => i_lang,
                                                           i_prof             => i_prof,
                                                           i_id_drug          => l_id_drug,
                                                           i_version          => l_vers,
                                                           i_dr_flg_type      => l_flg_type,
                                                           i_id_dpd           => l_id_dpd,
                                                           i_id_other_product => l_id_other_product) || '</b><br/>' ||
                              get_drug_desc_instr(i_lang       => i_lang,
                                                  i_prof       => i_prof,
                                                  i_id_episode => i_id_episode,
                                                  i_id_drd     => i_id_drd);
        
            l_return_value := REPLACE(l_return_value, '<b></b>', ''); --this shouldn't be necessary!! we need to change the core methods!! TBD!!
        
        ELSE
        
            g_error := 'pk_medication_core.get_drug_desc';
            --set_pharmacy_log(l_db_object_name, g_error);
            l_return_value := pk_medication_core.get_drug_desc(i_lang           => i_lang,
                                                               i_prof           => i_prof,
                                                               i_epis           => i_id_episode,
                                                               i_presc          => l_presc,
                                                               i_subject        => l_subject,
                                                               i_prev_message   => i_prev_msg,
                                                               i_adv_inp_screen => i_screen);
        END IF;
    
        --set_pharmacy_log(l_db_object_name, 'l_pharmacy_format=' || l_pharmacy_format || '###i_id_episode=' || i_id_episode || '###l_presc=' || l_presc || '###l_subject=' || l_subject || '###i_prev_msg=' || i_prev_msg || '###i_screen=' || i_screen);
    
        RETURN l_return_value;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_drug_desc_pharm;

    /********************************************************************************************
    * alert.pk_pharmacy.get_drug_desc_instr
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_EPISODE                    IN    NUMBER(24)
    * @param  I_ID_DRD                        IN    NUMBER(24)
    * @param  I_ID_PRESC_DIRECTIONS           IN    NUMBER(24)
    *
    * @return VARCHAR2
    *
    * @author Rui Marante
    * @version  2.5.0.7.8
    * @since  2010-03-29
    *
    * @notes
    *
    ********************************************************************************************/
    FUNCTION get_drug_desc_instr
    (
        i_lang                IN language.id_language%TYPE,
        i_prof                IN alert.profissional,
        i_id_episode          IN episode.id_episode%TYPE,
        i_id_drd              IN drug_req_det.id_drug_req_det%TYPE,
        i_id_presc_directions IN drug_presc_det.id_presc_directions%TYPE DEFAULT NULL
    ) RETURN VARCHAR2 IS
        l_id_dpd           drug_req.id_drug_presc_det%TYPE;
        l_presc            drug_req_det.id_drug_req_det%TYPE;
        l_subject          VARCHAR2(50 CHAR);
        l_return_value     VARCHAR2(16000 CHAR) := '';
        l_irreg_instr      drug_presc_det.id_presc_directions%TYPE;
        l_med_type         mi_med.flg_type%TYPE;
        l_ret_value        BOOLEAN := FALSE;
        l_id_other_product drug_req_det.id_other_product%TYPE;
        l_error            t_error_out;
    BEGIN
        l_irreg_instr := i_id_presc_directions;
    
        IF (l_irreg_instr IS NULL)
        THEN
            SELECT dr.id_drug_presc_det,
                   nvl(drd.id_presc_directions, dpd.id_presc_directions),
                   mm.flg_type,
                   drd.id_other_product
              INTO l_id_dpd, l_irreg_instr, l_med_type, l_id_other_product
              FROM drug_req_det drd
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
              LEFT JOIN mi_med mm
                ON (drd.id_drug = mm.id_drug AND drd.vers = mm.vers)
              LEFT JOIN drug_presc_det dpd
                ON (dr.id_drug_presc_det = dpd.id_drug_presc_det)
             WHERE drd.id_drug_req_det = i_id_drd;
        
            IF (l_id_other_product IS NOT NULL)
            THEN
                l_presc   := l_id_dpd;
                l_subject := pk_medication_core.g_other_prod;
            ELSIF (l_id_dpd IS NULL)
            THEN
                l_presc   := i_id_drd;
                l_subject := pk_medication_core.g_hospital;
            ELSE
                l_presc   := l_id_dpd;
                l_subject := pk_medication_core.g_local;
            END IF;
        END IF;
    
        IF (l_irreg_instr IS NOT NULL)
        THEN
            g_error     := 'get_drug_desc_irreg';
            l_ret_value := pk_prescription_directions.get_presc_dir_description(i_lang                  => i_lang,
                                                                                i_prof                  => i_prof,
                                                                                i_id_presc_directions   => l_irreg_instr,
                                                                                i_id_drug               => NULL,
                                                                                i_presc_directions      => NULL,
                                                                                i_presc_dir_interval    => NULL,
                                                                                i_presc_dir_dosefreq    => NULL,
                                                                                i_presc_dir_freqdet     => NULL,
                                                                                o_presc_dir_description => l_return_value,
                                                                                o_error                 => l_error);
        
        ELSIF (l_med_type IS NOT NULL AND l_med_type = pk_iv_fluids.g_flg_simple_fluid)
        THEN
            --soro simples
            g_error        := 'get_drug_iv_instr';
            l_return_value := get_drug_iv_instr(i_lang => i_lang, i_prof => i_prof, i_presc => l_id_dpd);
        ELSE
            g_error        := 'pk_medication_core.get_drug_desc';
            l_return_value := pk_medication_core.get_drug_desc(i_lang           => i_lang,
                                                               i_prof           => i_prof,
                                                               i_epis           => i_id_episode,
                                                               i_presc          => l_presc,
                                                               i_subject        => l_subject,
                                                               i_prev_message   => g_no,
                                                               i_adv_inp_screen => g_yes);
        
            l_return_value := REPLACE(l_return_value, '<b></b>', ''); --this shouldn't be necessary!! we need to change the core methods!! TBD!!
        END IF;
    
        RETURN l_return_value;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_drug_desc_instr;

    /********************************************************************************************
    * alert.pk_pharmacy.get_medication_name
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DRUG                       IN    VARCHAR2
    * @param  I_VERSION                       IN    VARCHAR2
    * @param  I_DR_FLG_TYPE                   IN    VARCHAR2
    * @param  I_ID_DPD                        IN    NUMBER(24)
    * @param  I_FLG_IS_NOT_REPORT             IN    VARCHAR2
    * @param  I_ID_OTHER_PRODUCT              IN    NUMBER(24)
    *
    * @return VARCHAR2
    *
    * @author Rui Marante
    * @version  2.5.0.7.7
    * @since  2010-03-19
    *
    * @notes
    *
    ********************************************************************************************/
    FUNCTION get_medication_name
    (
        i_lang              IN language.id_language%TYPE,
        i_prof              IN alert.profissional,
        i_id_drug           IN drug_req_det.id_drug%TYPE,
        i_version           IN drug_req_det.vers%TYPE,
        i_dr_flg_type       IN drug_req.flg_type%TYPE,
        i_id_dpd            IN drug_req.id_drug_presc_det%TYPE,
        i_flg_is_not_report IN VARCHAR2 DEFAULT 'Y',
        i_id_other_product  IN drug_req_det.id_other_product%TYPE DEFAULT NULL
    ) RETURN VARCHAR2 IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'get_medication_name';
        --
        l_flg_type     mi_med.flg_type%TYPE;
        l_med_descr    VARCHAR2(4000 CHAR) := '';
        l_return_value VARCHAR2(4000 CHAR) := '';
    BEGIN
        BEGIN
            IF (i_id_other_product IS NOT NULL)
            THEN
                IF (i_id_other_product = 1)
                THEN
                    SELECT 'I', dpd.desc_other_product -- I = Interior
                      INTO l_flg_type, l_med_descr
                      FROM drug_presc_det dpd
                     WHERE dpd.id_drug_presc_det = i_id_dpd;
                ELSE
                    SELECT op.flg_type, op.other_product_desc
                      INTO l_flg_type, l_med_descr
                      FROM other_product op
                     WHERE op.id_other_product = i_id_other_product
                       AND op.vers = i_version;
                END IF;
            ELSE
                SELECT m.flg_type, m.med_descr
                  INTO l_flg_type, l_med_descr
                  FROM mi_med m
                 WHERE m.id_drug = i_id_drug
                   AND m.vers = i_version;
            END IF;
        EXCEPTION
            WHEN no_data_found THEN
                l_flg_type := pk_medication_core.g_drug;
        END;
    
        --set_pharmacy_log(l_db_object_name, 'l_flg_type=' || l_flg_type || '###i_id_drug=' || i_id_drug || '###i_version=' || i_version || '###i_dr_flg_type=' || i_dr_flg_type || '###i_id_dpd=' || i_id_dpd || '###i_id_other_product=' || i_id_other_product);
    
        IF (l_flg_type IS NOT NULL AND l_flg_type = pk_medication_core.g_flg_new_fluid) --soros construdos
        THEN
            g_error        := 'pk_medication_core.get_medication_name - soros construdos';
            l_return_value := pk_medication_core.get_medication_name(i_lang    => i_lang,
                                                                     i_prof    => i_prof,
                                                                     i_med     => i_id_drug,
                                                                     i_subject => pk_medication_core.g_soro,
                                                                     i_type    => pk_medication_core.g_search_screen,
                                                                     i_presc   => i_id_dpd,
                                                                     i_vers    => i_version);
        
        ELSIF (i_id_other_product IS NOT NULL)
        THEN
        
            g_error        := 'pk_medication_core.get_medication_name - other products';
            l_return_value := l_med_descr;
        
            --ALERT-105591
            --commented because this function is not working correctly
            /*l_return_value := pk_medication_core.get_medication_name(
            i_lang    => i_lang,
            i_prof    => i_prof,
            i_med   => i_id_other_product,
            i_subject => pk_medication_core.g_other_prod,
            i_type    => pk_medication_core.g_search_screen,
            i_presc   => i_id_dpd,
            i_vers    => i_version);*/
        
        ELSE
        
            IF i_flg_is_not_report = g_yes
            THEN
                g_error        := 'pk_medication_core.get_medication_name - is not report';
                l_return_value := pk_medication_core.get_medication_name(i_lang    => i_lang,
                                                                         i_prof    => i_prof,
                                                                         i_med     => i_id_drug,
                                                                         i_subject => pk_medication_core.g_hospital,
                                                                         i_type    => pk_medication_core.g_search_screen, --pk_medication_core.g_chnm_screen,
                                                                         i_presc   => i_id_dpd,
                                                                         i_vers    => i_version);
            ELSE
                g_error        := 'pk_medication_core.get_medication_name - is report';
                l_return_value := l_med_descr;
            END IF;
        
        END IF;
    
        --set_pharmacy_log(l_db_object_name, 'l_flg_type=' || l_flg_type || '###i_id_drug=' || i_id_drug || '###i_version=' || i_version || '###i_dr_flg_type=' || i_dr_flg_type || '###i_id_dpd=' || i_id_dpd);
    
        RETURN l_return_value;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_medication_name;

    FUNCTION get_attention_pipe_str
    (
        i_lang   IN language.id_language%TYPE,
        i_prof   IN profissional,
        i_id_drd IN drug_req_det.id_drug_req_det%TYPE
    ) RETURN VARCHAR2 IS
        l_status VARCHAR2(100 CHAR) := '';
    BEGIN
        SELECT pk_sysdomain.get_img(i_lang, 'PRESCRIPTION_PHARM.FLG_ATTENTION', drd.flg_attention)
          INTO l_status
          FROM drug_req_det drd
         WHERE drd.id_drug_req_det = i_id_drd
           AND drd.flg_attention IS NOT NULL;
    
        IF (l_status IS NOT NULL)
        THEN
            l_status := '|I|||' || l_status || '||||0xC86464|';
        END IF;
    
        RETURN l_status;
    
    EXCEPTION
        WHEN no_data_found THEN
            RETURN NULL;
        WHEN OTHERS THEN
            RAISE;
    END get_attention_pipe_str;

    /********************************************************************************************
    * alert.pk_pharmacy.get_pat_location  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_ID_EPISODE                    IN        NUMBER(24)
    * @param  I_ID_PATIENT                    IN        NUMBER(24)
    * @param  I_SEPARATOR_TYPE                IN        VARCHAR2
    * @param  I_DEPT_SERV                     IN        VARCHAR2
    * @param  I_PREFIX                        IN        VARCHAR2
    *
    * @return VARCHAR2
    *
    * @author Rui Marante
    * @version  2.5.0.7.8
    * @since  2010-07-15
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_pat_location
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN alert.profissional,
        i_id_episode     IN episode.id_episode%TYPE,
        i_id_patient     IN patient.id_patient%TYPE,
        i_separator_type IN VARCHAR2 DEFAULT 'HTML', -- HTML | TEXT | NO_SPACE
        i_dept_serv      IN VARCHAR2 DEFAULT 'FULL', -- BED | FULL | DEP_SERV | ROOM_BED | DEP_SER_SPE | DEP | SER_SPE | ROOM
        i_prefix         IN VARCHAR2 DEFAULT NULL
    ) RETURN VARCHAR2 IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'get_pat_location';
        --
        l_location  VARCHAR2(4000 CHAR);
        l_episode   episode.id_episode%TYPE;
        l_separator VARCHAR2(10 CHAR);
        l_error     t_error_out;
        l_ret_out   BOOLEAN := TRUE;
    BEGIN
        --set_pharmacy_log(l_db_object_name, 'i_id_episode=' || i_id_episode || '##i_id_patient=' || i_id_patient || '##i_separator_type=' || i_separator_type || '##i_dept_serv=' || i_dept_serv);
    
        l_location := '';
        l_episode  := i_id_episode;
    
        IF (l_episode IS NULL)
        THEN
            BEGIN
                SELECT MAX(e.id_episode)
                  INTO l_episode
                  FROM episode e
                 WHERE e.id_patient = i_id_patient
                   AND e.flg_status = 'A'; --active
            EXCEPTION
                WHEN no_data_found THEN
                    set_pharmacy_log(l_db_object_name, 'episode id?');
                    raise_application_error(-20001, 'episode id?');
            END;
        END IF;
    
        IF (i_separator_type = 'HTML')
        THEN
            l_separator := '<br/>';
        ELSIF (i_separator_type = 'NO_SPACE')
        THEN
            l_separator := '/';
        ELSE
            l_separator := ' / ';
        END IF;
    
        BEGIN
            IF (i_dept_serv = 'DEP_SERV')
            THEN
            
                SELECT pk_translation.get_translation(i_lang, d.code_department) || l_separator ||
                       pk_translation.get_translation(i_lang, d2.code_dept)
                  INTO l_location
                  FROM episode e, department d, dept d2
                 WHERE e.id_episode = i_id_episode
                   AND e.id_department = d.id_department
                   AND e.id_dept = d2.id_dept
                   AND rownum = 1;
            
            ELSIF (i_dept_serv = 'FULL')
            THEN
            
                SELECT serv || ' - ' || spec || ' - ' || nvl(v1.room_abrev, v1.code_room) || l_separator ||
                       v1.code_epis_type || l_separator || nvl(v1.bed_name, v1.desc_bed)
                  INTO l_location
                  FROM (SELECT nvl(r.desc_room_abbreviation, pk_translation.get_translation(i_lang, r.code_abbreviation)) room_abrev,
                               pk_translation.get_translation(i_lang, et.code_epis_type) code_epis_type,
                               nvl(r.desc_room, pk_translation.get_translation(i_lang, r.code_room)) code_room,
                               nvl(b.desc_bed, pk_translation.get_translation(i_lang, b.code_bed)) bed_name,
                               pk_translation.get_translation(i_lang, d.code_department) serv,
                               pk_translation.get_translation(i_lang, cs1.code_clinical_service) spec,
                               b.desc_bed
                          FROM episode e
                         INNER JOIN epis_type et
                            ON (e.id_epis_type = et.id_epis_type)
                         INNER JOIN epis_info ei
                            ON (e.id_episode = ei.id_episode)
                         INNER JOIN dep_clin_serv dcs1
                            ON (ei.id_dep_clin_serv = dcs1.id_dep_clin_serv)
                         INNER JOIN department d
                            ON (dcs1.id_department = d.id_department)
                         INNER JOIN clinical_service cs1
                            ON (dcs1.id_clinical_service = cs1.id_clinical_service)
                          LEFT JOIN bed b
                            ON (ei.id_bed = b.id_bed)
                          LEFT JOIN room r
                            ON (b.id_room = r.id_room)
                         WHERE e.id_episode = l_episode
                           AND rownum = 1) v1;
            
            ELSIF (i_dept_serv = 'BED')
            THEN
                --patient bed
            
                l_ret_out := pk_bmng_pbl.get_bed_desc(i_lang  => i_lang,
                                                      i_prof  => i_prof,
                                                      i_epis  => l_episode,
                                                      o_desc  => l_location,
                                                      o_error => l_error);
            
            ELSIF (i_dept_serv = 'CLIN_SERV')
            THEN
                --clinical service
            
                SELECT pk_translation.get_translation(i_lang, cs.code_clinical_service)
                  INTO l_location
                  FROM episode e, clinical_service cs
                 WHERE e.id_episode = i_id_episode
                   AND e.id_clinical_service = cs.id_clinical_service
                   AND rownum = 1;
            
            ELSIF (i_dept_serv = 'ROOM_BED')
            THEN
                --clinical service
            
                SELECT CASE
                           WHEN (v1.room_abrev IS NULL AND v1.code_room IS NULL AND v1.bed_name IS NULL AND
                                v1.desc_bed IS NULL) THEN
                            ''
                           ELSE
                            v1.room_abrev || decode(v1.room_abrev, NULL, '', ' ') || v1.code_room || l_separator ||
                            nvl(v1.bed_name, v1.desc_bed)
                       END
                  INTO l_location
                  FROM (SELECT nvl(r.desc_room_abbreviation, pk_translation.get_translation(i_lang, r.code_abbreviation)) room_abrev,
                               nvl(r.desc_room, pk_translation.get_translation(i_lang, r.code_room)) code_room,
                               nvl(b.desc_bed, pk_translation.get_translation(i_lang, b.code_bed)) bed_name,
                               b.desc_bed
                          FROM episode e
                         INNER JOIN epis_type et
                            ON (e.id_epis_type = et.id_epis_type)
                         INNER JOIN epis_info ei
                            ON (e.id_episode = ei.id_episode)
                          LEFT JOIN bed b
                            ON (ei.id_bed = b.id_bed)
                          LEFT JOIN room r
                            ON (b.id_room = r.id_room)
                         WHERE e.id_episode = l_episode
                           AND rownum = 1) v1;
            
            ELSIF (i_dept_serv = 'ROOM')
            THEN
            
                SELECT v1.room_abrev || decode(v1.room_abrev, NULL, '', v1.code_room, '', ' ') ||
                       decode(v1.code_room, v1.room_abrev, '', v1.code_room)
                  INTO l_location
                  FROM (SELECT nvl(r.desc_room_abbreviation, pk_translation.get_translation(i_lang, r.code_abbreviation)) room_abrev,
                               nvl(r.desc_room, pk_translation.get_translation(i_lang, r.code_room)) code_room
                          FROM episode e
                         INNER JOIN epis_info ei
                            ON (e.id_episode = ei.id_episode)
                          LEFT JOIN bed b
                            ON (ei.id_bed = b.id_bed)
                          LEFT JOIN room r
                            ON (b.id_room = r.id_room)
                         WHERE e.id_episode = l_episode
                           AND rownum = 1) v1;
            
            ELSIF (i_dept_serv = 'DEP_SER_SPE')
            THEN
                --Department/Service/Speciality
            
                SELECT pk_translation.get_translation(i_lang, d2.code_dept) || l_separator ||
                       pk_translation.get_translation(i_lang, d.code_department) || l_separator ||
                       pk_translation.get_translation(i_lang, cs.code_clinical_service)
                  INTO l_location
                  FROM episode e, department d, dept d2, clinical_service cs
                 WHERE e.id_episode = i_id_episode
                   AND e.id_clinical_service = cs.id_clinical_service
                   AND e.id_department = d.id_department
                   AND e.id_dept = d2.id_dept
                   AND rownum = 1;
            
            ELSIF (i_dept_serv = 'DEP')
            THEN
                --Department
            
                SELECT pk_translation.get_translation(i_lang, d2.code_dept)
                  INTO l_location
                  FROM episode e, department d, dept d2, clinical_service cs
                 WHERE e.id_episode = i_id_episode
                   AND e.id_clinical_service = cs.id_clinical_service
                   AND e.id_department = d.id_department
                   AND e.id_dept = d2.id_dept
                   AND rownum = 1;
            
            ELSIF (i_dept_serv = 'SER_SPE')
            THEN
                --Service/Speciality
            
                SELECT pk_translation.get_translation(i_lang, d.code_department) || l_separator ||
                       pk_translation.get_translation(i_lang, cs.code_clinical_service)
                  INTO l_location
                  FROM episode e, department d, dept d2, clinical_service cs
                 WHERE e.id_episode = i_id_episode
                   AND e.id_clinical_service = cs.id_clinical_service
                   AND e.id_department = d.id_department
                   AND e.id_dept = d2.id_dept
                   AND rownum = 1;
            
            ELSIF (i_dept_serv = 'SER_ABBREV_SPE')
            THEN
                --Service abbreviation/Speciality
            
                SELECT d.abbreviation || l_separator ||
                       pk_translation.get_translation(i_lang, cs.code_clinical_service)
                  INTO l_location
                  FROM episode e, department d, dept d2, clinical_service cs
                 WHERE e.id_episode = i_id_episode
                   AND e.id_clinical_service = cs.id_clinical_service
                   AND e.id_department = d.id_department
                   AND e.id_dept = d2.id_dept
                   AND rownum = 1;
            
            ELSIF (i_dept_serv = 'SER_ABBREV')
            THEN
                --Service abbreviation/Speciality
            
                SELECT d.abbreviation
                  INTO l_location
                  FROM episode e, department d, dept d2, clinical_service cs
                 WHERE e.id_episode = i_id_episode
                   AND e.id_clinical_service = cs.id_clinical_service
                   AND e.id_department = d.id_department
                   AND e.id_dept = d2.id_dept
                   AND rownum = 1;
            
            END IF;
        
        EXCEPTION
            WHEN no_data_found THEN
                --set_pharmacy_log(l_db_object_name, sqlerrm);
                l_location := '';
        END;
    
        IF (i_prefix IS NOT NULL AND l_location IS NOT NULL)
        THEN
            l_location := i_prefix || ' ' || l_location;
        END IF;
    
        RETURN l_location;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_pat_location;

    /********************************************************************************************
    * alert.pk_pharmacy.get_episode_discharge_date
    *
    * @param  I_ID_EPISODE                    IN    NUMBER(24)
    *
    * @return TIMESTAMP WITH LOCAL TIME ZONE
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-07-22
    *
    ********************************************************************************************/
    FUNCTION get_episode_discharge_date(i_id_episode IN discharge_schedule.id_episode%TYPE)
        RETURN discharge_schedule.dt_discharge_schedule%TYPE IS
        l_dt_discharge discharge_schedule.dt_discharge_schedule%TYPE;
    BEGIN
        SELECT ds.dt_discharge_schedule
          INTO l_dt_discharge
          FROM discharge_schedule ds
         WHERE ds.id_episode = i_id_episode
           AND rownum = 1;
    
        RETURN l_dt_discharge;
    
    EXCEPTION
        WHEN no_data_found THEN
            RETURN NULL;
        WHEN OTHERS THEN
            RAISE;
    END get_episode_discharge_date;

    /********************************************************************************************
    * alert.pk_pharmacy.get_pat_reject
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_PROF_CAT_TYPE                 IN    VARCHAR2
    * @param  I_DRUG_REQ_DET                  IN    ALERT.TABLE_NUMBER
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  O_REQ                           OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-02
    *
    ********************************************************************************************/
    FUNCTION get_pat_reject
    (
        i_lang          IN language.id_language%TYPE,
        i_prof          IN profissional,
        i_prof_cat_type IN category.flg_type%TYPE,
        i_drug_req_det  IN table_number,
        i_get_headers   IN VARCHAR2 DEFAULT 'N',
        i_header_codes  IN table_varchar DEFAULT NULL,
        o_req           OUT pk_types.cursor_type,
        o_headers       OUT pk_types.cursor_type,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error := 'GET CURSOR';
        OPEN o_req FOR
            SELECT drd.id_drug_req_det,
                   get_drug_desc_pharm(i_lang, i_prof, e.id_episode, drd.id_drug_req_det) pharm,
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.flg_type,
                                       dr.id_drug_presc_det,
                                       g_yes,
                                       drd.id_other_product) short_pharm,
                   get_attention_pipe_str(i_lang, i_prof, drd.id_drug_req_det) attention,
                   dr.flg_type flg_type,
                   drdst.notes1 physician_notes
              FROM drug_req_det drd, drug_req dr, episode e, drug_req_det_state_transition drdst
             WHERE drd.id_drug_req = dr.id_drug_req
               AND dr.id_episode = e.id_episode
               AND drd.id_drug_req_det IN (SELECT column_value
                                             FROM TABLE(i_drug_req_det))
               AND drd.id_drug_req_det = drdst.id_drug_req_det
               AND drdst.id_state = get_state_for_req_type(i_prof, dr.flg_type, g_drd_requested_st)
             ORDER BY short_pharm;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'get_pat_reject', o_error);
            RETURN FALSE;
    END get_pat_reject;

    /********************************************************************************************
    * alert.pk_pharmacy.create_req_pharm  (overload 1)  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_EPISODE                       IN        NUMBER(24)
    * @param  I_PATIENT                       IN        NUMBER(24)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_PROF_CAT_TYPE                 IN        VARCHAR2
    * @param  I_FLG_TYPE                      IN        ALERT.TABLE_VARCHAR
    * @param  I_DRUG_PRESC_DET                IN        ALERT.TABLE_NUMBER
    * @param  I_DRUG                          IN        ALERT.TABLE_VARCHAR
    * @param  I_QTY_REQ                       IN        ALERT.TABLE_NUMBER
    * @param  I_UNIT_MEASURE                  IN        ALERT.TABLE_NUMBER
    * @param  I_NOTES                         IN        ALERT.TABLE_VARCHAR
    * @param  I_DISPENSE                      IN        ALERT.TABLE_NUMBER
    * @param  I_UNIT_MEASURE_DISPENSE         IN        ALERT.TABLE_NUMBER
    * @param  I_REFILL                        IN        ALERT.TABLE_VARCHAR
    * @param  I_FLG_FIRST_DOSE                IN        ALERT.TABLE_VARCHAR
    * @param  I_PACKAGE_NUMBER                IN        ALERT.TABLE_VARCHAR
    * @param  I_EXPIRATION_DATE               IN        ALERT.TABLE_VARCHAR
    * @param  I_FLG_DISPENSE_AS_IS            IN        ALERT.TABLE_VARCHAR
    * @param  I_TEST                          IN        VARCHAR2
    * @param  I_COMMIT                        IN        VARCHAR2
    * @param  O_ID_DRD                        OUT       ALERT.TABLE_NUMBER
    * @param  O_FLG_SHOW                      OUT       VARCHAR2
    * @param  O_MSG_TITLE                     OUT       VARCHAR2
    * @param  O_MSG                           OUT       VARCHAR2
    * @param  O_BUTTON                        OUT       VARCHAR2
    * @param  O_ERROR                         OUT       ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.6.0.4
    * @since  2010-10-22
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION create_req_pharm
    (
        i_lang                  IN language.id_language%TYPE,
        i_episode               IN drug_req.id_episode%TYPE,
        i_patient               IN patient.id_patient%TYPE,
        i_prof                  IN alert.profissional,
        i_prof_cat_type         IN category.flg_type%TYPE,
        i_flg_type              IN alert.table_varchar,
        i_drug_presc_det        IN alert.table_number,
        i_drug                  IN alert.table_varchar,
        i_qty_req               IN alert.table_number,
        i_unit_measure          IN alert.table_number,
        i_notes                 IN alert.table_varchar,
        i_dispense              IN alert.table_number DEFAULT alert.table_number(),
        i_unit_measure_dispense IN alert.table_number DEFAULT alert.table_number(),
        --ALERT-133630
        i_refill             IN table_varchar DEFAULT table_varchar(),
        i_flg_first_dose     IN table_varchar DEFAULT table_varchar(),
        i_package_number     IN table_varchar DEFAULT table_varchar(),
        i_expiration_date    IN table_varchar DEFAULT table_varchar(),
        i_flg_dispense_as_is IN table_varchar DEFAULT table_varchar(),
        --
        i_test      IN VARCHAR2 DEFAULT 'N',
        i_commit    IN VARCHAR2 DEFAULT 'Y',
        o_id_drd    OUT alert.table_number,
        o_flg_show  OUT VARCHAR2,
        o_msg_title OUT VARCHAR2,
        o_msg       OUT VARCHAR2,
        o_button    OUT VARCHAR2,
        o_error     OUT t_error_out
    ) RETURN BOOLEAN IS
        l_version    drug_req_det.vers%TYPE;
        l_department department.id_department%TYPE;
        l_is_unidose department.flg_unidose%TYPE;
        l_datetime   drug_req_det.dt_last_change%TYPE;
        l_flg_status drug_req.flg_status%TYPE;
        l_flg_type   drug_req.flg_type%TYPE;
    
        l_flg_alert    BOOLEAN;
        l_id_sys_alert sys_alert.id_sys_alert%TYPE;
        l_id_record    sys_alert_event.id_record%TYPE;
        --mensagem temporria SUBSTITUIR
        l_code_interv mi_med.med_descr%TYPE;
        l_replace1    sys_alert_event.replace1%TYPE;
        l_replace2    sys_alert_event.replace2%TYPE;
    
        ex_show_msg EXCEPTION;
    
        l_pharmacy_is_on VARCHAR2(1 CHAR) := g_no;
    
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'create_req_pharm';
    
        --
        l_cur_cars       pk_types.cursor_type;
        l_id_unidose_car pharm_unidose_car.id_unidose_car%TYPE;
        l_dt_car_begin   pharm_unidose_car.dt_car_begin%TYPE;
        l_dt_car_end     pharm_unidose_car.dt_car_end%TYPE;
        l_drd_u_count    NUMBER;
        l_dt_car         pharm_unidose_car.dt_car_begin%TYPE;
    
        l_id_drd alert.table_number;
        -- PMS 05-jan-2010
        -- it is necessary to filter cars by date i_dt_car
        -- which will be either the begin date from the prescription or
        -- if prescription date is not specified, current_timestamp
        PROCEDURE get_unidose_cars
        (
            i_id_episode IN episode.id_episode%TYPE,
            i_dt_car     IN pharm_unidose_car.dt_car_begin%TYPE,
            o_cur_cars   OUT pk_types.cursor_type
        ) IS
            l_id_dep_clin_service pharm_unidose_car_model.id_dep_clin_serv%TYPE;
            --
            l_db_object_name CONSTANT user_objects.object_name%TYPE := 'create_req_pharm (cars)';
        BEGIN
            set_pharmacy_log(l_db_object_name, 'get cars');
        
            g_error := '1) select dep_clin_serv';
            BEGIN
                SELECT ei.id_dep_clin_serv
                  INTO l_id_dep_clin_service
                  FROM epis_info ei
                 INNER JOIN dep_clin_serv dcs
                    ON (ei.id_dep_clin_serv = dcs.id_dep_clin_serv)
                 INNER JOIN department d
                    ON (dcs.id_department = d.id_department)
                 WHERE ei.id_episode = i_id_episode
                   AND dcs.flg_available = g_yes
                   AND d.id_institution = i_prof.institution
                   AND d.flg_available = g_yes
                   AND d.flg_unidose = g_yes;
            EXCEPTION
                WHEN OTHERS THEN
                    l_id_dep_clin_service := NULL;
            END;
        
            IF (l_id_dep_clin_service IS NOT NULL)
            THEN
                set_pharmacy_log(l_db_object_name, 'ID_DEP_CLIN_SERV - ' || l_id_dep_clin_service);
                g_error := '2) select cars';
                OPEN o_cur_cars FOR
                    SELECT uc.id_unidose_car,
                           uc.dt_car_begin,
                           nvl(uc.dt_car_end, (uc.dt_car_begin + 1) - (1 / 24 / 60 / 60)) dt_car_end
                      FROM pharm_unidose_car uc
                     INNER JOIN pharm_unidose_car_model ucm
                        ON (uc.id_car_model = ucm.id_unidose_car_model)
                     WHERE ucm.id_dep_clin_serv = l_id_dep_clin_service
                       AND uc.id_state IN
                           (SELECT column_value
                              FROM TABLE(get_states_for_req_type(i_prof,
                                                                 NULL,
                                                                 table_varchar(g_uni_car_parked_st,
                                                                               g_uni_car_executing_st))))
                       AND uc.dt_car_end >= i_dt_car
                     ORDER BY uc.dt_car_begin DESC;
            ELSE
                set_pharmacy_log(l_db_object_name, 'ID_DEP_CLIN_SERV - null');
                OPEN o_cur_cars FOR --empty cursor
                    SELECT NULL id_unidose_car, NULL dt_car_begin, NULL dt_car_end
                      FROM dual
                     WHERE 1 != 1;
            END IF;
        
        EXCEPTION
            WHEN OTHERS THEN
                RAISE;
        END get_unidose_cars;
    
        -- PMS 05-jan-2010
        -- this function retrieves the begin prescription date, or the current_timestamp
        -- so taht it will be used later to filter unidose cars
        FUNCTION get_instructions_date(i_id_drug_presc_det drug_presc_det.id_drug_presc_det%TYPE) RETURN TIMESTAMP
            WITH LOCAL TIME ZONE IS
            l_instructions_dt TIMESTAMP WITH LOCAL TIME ZONE;
        BEGIN
            BEGIN
                SELECT nvl(dpp.dt_plan_tstz, dpp.dt_take_tstz)
                  INTO l_instructions_dt
                  FROM drug_presc_plan dpp
                 WHERE dpp.id_drug_presc_plan = (SELECT MIN(dpp.id_drug_presc_plan)
                                                   FROM drug_presc_plan dpp
                                                  WHERE dpp.id_drug_presc_det = i_id_drug_presc_det
                                                    AND dpp.flg_status != 'C');
            EXCEPTION
                WHEN no_data_found THEN
                    l_instructions_dt := trunc(current_timestamp);
            END;
            RETURN l_instructions_dt;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE;
        END get_instructions_date;
        --
    BEGIN
        --
        g_error          := 'PHARMACY_ENABLED';
        l_pharmacy_is_on := nvl(pk_sysconfig.get_config('PHARMACY_ENABLED', i_prof), g_no);
        IF (l_pharmacy_is_on = g_no)
        THEN
            set_pharmacy_log(l_db_object_name, 'PHARMACY_ENABLED=FALSE!!!');
            RETURN FALSE;
        END IF;
        --
        o_id_drd   := table_number();
        l_datetime := current_timestamp;
        l_flg_type := i_flg_type(1);
    
        l_version := pk_sysconfig.get_config('PRESCRIPTION_TYPE', i_prof);
    
        IF (i_test = g_yes)
        THEN
        
            g_error := 'pk_prescription_int.exist_drug_req';
            IF NOT pk_prescription_int.exist_drug_req(i_lang       => i_lang,
                                                      i_id_patient => i_patient,
                                                      i_drug       => i_drug,
                                                      i_prof       => i_prof,
                                                      o_flg_show   => o_flg_show,
                                                      o_msg_result => o_msg,
                                                      o_title      => o_msg_title,
                                                      o_button     => o_button,
                                                      o_error      => o_error)
            THEN
                raise_application_error(-20001, o_error.ora_sqlerrm);
            END IF;
        
            IF (o_flg_show = g_yes)
            THEN
                RAISE ex_show_msg;
            END IF;
        
        END IF;
    
        --verificar se o servio tem unidose. se tem, DRUG_REQ.FLG_TYPE='U'; seno DRUG_REQ.FLG_TYPE='A'
        g_error := 'CHECK IF DEPARTMENT -> UNIDOSE';
        set_pharmacy_log(l_db_object_name, g_error);
        SELECT nvl(d.flg_unidose, g_no), d.id_department
          INTO l_is_unidose, l_department
          FROM episode e, department d
         WHERE e.id_episode = i_episode
           AND e.id_department = d.id_department;
    
        IF (l_flg_type = g_flg_unidose AND l_is_unidose = g_yes)
        THEN
        
            set_pharmacy_log(l_db_object_name, 'get_unidose_cars');
            --in order to call only cars already created with date higher than instructions date or current_timestamp
            l_dt_car := get_instructions_date(i_drug_presc_det(1));
            --ALERT-147547
            get_unidose_cars(i_id_episode => i_episode, i_dt_car => l_dt_car, o_cur_cars => l_cur_cars);
        
            LOOP
                FETCH l_cur_cars
                    INTO l_id_unidose_car, l_dt_car_begin, l_dt_car_end;
                EXIT WHEN l_cur_cars%NOTFOUND;
            
                set_pharmacy_log(l_db_object_name, 'l_id_unidose_car  -> ' || l_id_unidose_car);
                -- PMS 06-jan-2010
                -- Note: added drug_req_det to allow filtering of cancelled pharmacy orders
                SELECT COUNT(1)
                  INTO l_drd_u_count
                  FROM drug_req dr
                 INNER JOIN drug_req_det drd
                    ON (dr.id_drug_req = drd.id_drug_req)
                 WHERE dr.flg_type = g_flg_unidose
                   AND dr.id_drug_presc_det = i_drug_presc_det(1)
                   AND dr.dt_drug_req_tstz BETWEEN l_dt_car_begin AND l_dt_car_end
                   AND drd.id_state <> get_state_for_req_type(i_prof, dr.flg_type, g_drd_canceled_st)
                   AND rownum = 1;
            
                set_pharmacy_log(l_db_object_name, 'l_drd_u_count  -> ' || l_drd_u_count);
                -- PMS 05-jan-2010
                -- Note: used i_drug_presc_det(1) because it is an automatic pharmacy order
                -- thus only a single record instead of the whole table
                IF (l_drd_u_count = 0)
                THEN
                    set_pharmacy_log(l_db_object_name, 'create_req_pharm_uni: id_car = ' || l_id_unidose_car);
                
                    create_req_pharm_uni(i_lang                  => i_lang,
                                         i_episode               => i_episode,
                                         i_patient               => i_patient,
                                         i_prof                  => i_prof,
                                         i_drug                  => i_drug,
                                         i_version               => l_version,
                                         i_qty_req               => i_qty_req,
                                         i_unit_measure          => i_unit_measure,
                                         i_notes                 => i_notes,
                                         i_drug_presc_det        => i_drug_presc_det,
                                         i_dispense              => i_dispense,
                                         i_unit_measure_dispense => i_unit_measure_dispense,
                                         i_datetime              => l_dt_car_begin,
                                         i_do_auto_dispense_calc => g_yes,
                                         i_id_unidose_car        => l_id_unidose_car,
                                         i_dt_car_begin          => l_dt_car_begin,
                                         i_dt_car_end            => l_dt_car_end,
                                         o_id_drug_req_det       => l_id_drd,
                                         o_error                 => o_error);
                
                    -- PMS 05-jan-2010 
                    -- procedure may return more than one record and it will be called as many times 
                    -- as the number of detected cars
                    FOR j IN 1 .. l_id_drd.count
                    LOOP
                        o_id_drd.extend(1);
                        o_id_drd(o_id_drd.count) := l_id_drd(j);
                    END LOOP;
                
                    l_id_drd.delete();
                END IF;
            
                l_flg_status := g_drug_req;
            
            END LOOP;
            CLOSE l_cur_cars;
        
        ELSIF (l_flg_type = g_flg_adm)
        THEN
            --administrar neste local
        
            set_pharmacy_log(l_db_object_name, 'create_req_pharm_adm');
            create_req_pharm_adm(i_lang                  => i_lang,
                                 i_episode               => i_episode,
                                 i_patient               => i_patient,
                                 i_prof                  => i_prof,
                                 i_drug                  => i_drug,
                                 i_version               => l_version,
                                 i_qty_req               => i_qty_req,
                                 i_unit_measure          => i_unit_measure,
                                 i_notes                 => i_notes,
                                 i_drug_presc_det        => i_drug_presc_det,
                                 i_dispense              => i_dispense,
                                 i_unit_measure_dispense => i_unit_measure_dispense,
                                 i_datetime              => l_datetime,
                                 o_id_drug_req_det       => o_id_drd,
                                 o_error                 => o_error);
        
            l_flg_status := g_drug_req;
        
            l_flg_alert    := TRUE;
            l_id_sys_alert := g_id_alert_pharm_req_delay;
        
        ELSIF (l_flg_type = g_flg_int)
        THEN
            --receita farm. hospital
        
            set_pharmacy_log(l_db_object_name, 'create_req_pharm_int');
            create_req_pharm_int(i_lang                  => i_lang,
                                 i_episode               => i_episode,
                                 i_patient               => i_patient,
                                 i_prof                  => i_prof,
                                 i_drug                  => i_drug,
                                 i_version               => l_version,
                                 i_qty_req               => i_qty_req,
                                 i_unit_measure          => i_unit_measure,
                                 i_notes                 => i_notes,
                                 i_drug_presc_det        => i_drug_presc_det,
                                 i_dispense              => i_dispense,
                                 i_unit_measure_dispense => i_unit_measure_dispense,
                                 i_datetime              => l_datetime,
                                 --ALERT-133630
                                 i_refill             => i_refill,
                                 i_flg_first_dose     => i_flg_first_dose,
                                 i_package_number     => i_package_number,
                                 i_expiration_date    => i_expiration_date,
                                 i_flg_dispense_as_is => i_flg_dispense_as_is,
                                 --
                                 o_id_drug_req_det => o_id_drd,
                                 o_error           => o_error);
        END IF;
    
        -- INSERIR ALERTA NA TABELA SYS_ALERT_EVENT --
        set_pharmacy_log(l_db_object_name, 'ALERTS');
        IF l_flg_alert = TRUE
        THEN
            FOR i IN 1 .. o_id_drd.count
            LOOP
                BEGIN
                    SELECT mi.med_descr
                      INTO l_code_interv
                      FROM drug_req_det drd, mi_med mi
                     WHERE drd.id_drug = mi.id_drug
                       AND drd.vers = mi.vers
                       AND drd.id_drug_req_det = o_id_drd(i);
                
                    g_error := 'SET SYS_ALERT_EVENT REQ TO PHARMACY';
                    IF NOT pk_alerts.insert_sys_alert_event(i_lang                => i_lang,
                                                            i_prof                => i_prof,
                                                            i_sys_alert           => 14,
                                                            i_id_episode          => i_episode,
                                                            i_id_record           => o_id_drd(i),
                                                            i_dt_record           => current_timestamp,
                                                            i_id_professional     => NULL,
                                                            i_id_room             => NULL,
                                                            i_id_clinical_service => NULL,
                                                            i_flg_type_dest       => 'C',
                                                            i_replace1            => l_code_interv,
                                                            i_replace2            => pk_sysconfig.get_config('ALERT_DRUG_REQ_TIMEOUT',
                                                                                                             i_prof),
                                                            o_error               => o_error)
                    THEN
                        --raise_application_error(-20001, o_error.ora_sqlerrm);
                        pk_alertlog.log_error(g_error);
                    END IF;
                EXCEPTION
                    WHEN OTHERS THEN
                        NULL;
                END;
            END LOOP;
        END IF;
    
        -- ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** -
        --Actualiza dados estatsticos da visita
        g_error := 'CALL TO PK_VISIT.SET_FIRST_OBS';
        set_pharmacy_log(l_db_object_name, g_error);
        IF NOT pk_visit.set_first_obs(i_lang                => i_lang,
                                      i_id_episode          => i_episode,
                                      i_pat                 => NULL,
                                      i_prof                => i_prof,
                                      i_prof_cat_type       => i_prof_cat_type,
                                      i_dt_last_interaction => l_datetime,
                                      i_dt_first_obs        => l_datetime,
                                      o_error               => o_error)
        THEN
            raise_application_error(-20001, o_error.ora_sqlerrm);
        END IF;
    
        --se o estado da requisio estiver em "Requisitado" preencher a informao da primeira prescrio de medicamentos
        IF l_flg_status = g_drug_req
        THEN
            g_error := 'CALL TO PK_VISIT.UPD_EPIS_INFO_DRUG';
            set_pharmacy_log(l_db_object_name, g_error);
            IF NOT pk_visit.upd_epis_info_drug(i_lang               => i_lang,
                                               i_id_episode         => i_episode,
                                               i_id_prof            => i_prof,
                                               i_dt_first_drug_prsc => l_datetime,
                                               i_dt_first_drug_take => NULL,
                                               i_prof_cat_type      => i_prof_cat_type,
                                               o_error              => o_error)
            THEN
                raise_application_error(-20001, o_error.ora_sqlerrm);
            END IF;
        END IF;
    
        g_error := 'CALL TO PK_PRESCRIPTION_INT.INSERT_DRUG_REQ_TASK';
        set_pharmacy_log(l_db_object_name, g_error);
        IF NOT pk_prescription_int.insert_drug_req_task(i_lang          => i_lang,
                                                        i_episode       => i_episode,
                                                        i_prof          => i_prof,
                                                        i_prof_cat_type => i_prof_cat_type,
                                                        o_error         => o_error)
        THEN
            raise_application_error(-20001, o_error.ora_sqlerrm);
        END IF;
        -- ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** -
    
        IF (i_commit = g_yes)
        THEN
            COMMIT;
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN ex_show_msg THEN
            --mensagem de confirmacao
            IF (i_commit = g_yes)
            THEN
                pk_utils.undo_changes;
            END IF;
            RETURN TRUE;
        
        WHEN OTHERS THEN
            IF (l_cur_cars%ISOPEN)
            THEN
                CLOSE l_cur_cars;
            END IF;
        
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, l_db_object_name, o_error);
            IF (i_commit = g_yes)
            THEN
                pk_utils.undo_changes;
            END IF;
            RETURN FALSE;
    END create_req_pharm;

    FUNCTION create_req_pharm --deprecated --to be deleted soon!! :)
    (
        i_lang                  IN language.id_language%TYPE,
        i_episode               IN drug_req.id_episode%TYPE,
        i_patient               IN patient.id_patient%TYPE,
        i_prof                  IN alert.profissional,
        i_drug                  IN alert.table_varchar,
        i_qty_req               IN drug_req_det.qty_req%TYPE,
        i_notes                 IN drug_req_det.notes%TYPE,
        i_flg_type              IN drug_req.flg_type%TYPE,
        i_drug_presc_det        IN drug_presc_det.id_drug_presc_det%TYPE,
        i_prof_cat_type         IN category.flg_type%TYPE,
        i_test                  IN VARCHAR2 DEFAULT 'N',
        i_commit                IN VARCHAR2 DEFAULT 'Y',
        i_dispense              IN alert.table_number DEFAULT alert.table_number(),
        i_unit_measure_dispense IN alert.table_number DEFAULT alert.table_number(),
        o_id_drd                OUT table_number,
        o_flg_show              OUT VARCHAR2,
        o_msg_title             OUT VARCHAR2,
        o_msg                   OUT VARCHAR2,
        o_button                OUT VARCHAR2,
        o_error                 OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        RETURN create_req_pharm(i_lang                  => i_lang,
                                i_episode               => i_episode,
                                i_patient               => i_patient,
                                i_prof                  => i_prof,
                                i_prof_cat_type         => i_prof_cat_type,
                                i_flg_type              => i_flg_type,
                                i_drug_presc_det        => i_drug_presc_det,
                                i_drug                  => i_drug,
                                i_qty_req               => alert.table_number(i_qty_req),
                                i_unit_measure          => alert.table_number(10032),
                                i_notes                 => alert.table_varchar(i_notes),
                                i_dispense              => i_dispense,
                                i_unit_measure_dispense => i_unit_measure_dispense,
                                i_test                  => i_test,
                                i_commit                => i_commit,
                                o_id_drd                => o_id_drd,
                                o_flg_show              => o_flg_show,
                                o_msg_title             => o_msg_title,
                                o_msg                   => o_msg,
                                o_button                => o_button,
                                o_error                 => o_error);
    END;

    FUNCTION create_req_pharm --deprecated --to be deleted in a near future!! :)
    (
        i_lang                  IN language.id_language%TYPE,
        i_episode               IN drug_req.id_episode%TYPE,
        i_patient               IN patient.id_patient%TYPE,
        i_prof                  IN alert.profissional,
        i_prof_cat_type         IN category.flg_type%TYPE,
        i_flg_type              IN drug_req.flg_type%TYPE,
        i_drug_presc_det        IN drug_presc_det.id_drug_presc_det%TYPE,
        i_drug                  IN alert.table_varchar,
        i_qty_req               IN alert.table_number,
        i_unit_measure          IN alert.table_number,
        i_notes                 IN alert.table_varchar,
        i_dispense              IN alert.table_number DEFAULT alert.table_number(),
        i_unit_measure_dispense IN alert.table_number DEFAULT alert.table_number(),
        i_test                  IN VARCHAR2 DEFAULT 'N',
        i_commit                IN VARCHAR2 DEFAULT 'Y',
        o_id_drd                OUT alert.table_number,
        o_flg_show              OUT VARCHAR2,
        o_msg_title             OUT VARCHAR2,
        o_msg                   OUT VARCHAR2,
        o_button                OUT VARCHAR2,
        o_error                 OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        RETURN create_req_pharm(i_lang                  => i_lang,
                                i_episode               => i_episode,
                                i_patient               => i_patient,
                                i_prof                  => i_prof,
                                i_prof_cat_type         => i_prof_cat_type,
                                i_flg_type              => table_varchar(i_flg_type),
                                i_drug_presc_det        => table_number(i_drug_presc_det),
                                i_drug                  => i_drug,
                                i_qty_req               => i_qty_req,
                                i_unit_measure          => i_unit_measure,
                                i_notes                 => i_notes,
                                i_dispense              => i_dispense,
                                i_unit_measure_dispense => i_unit_measure_dispense,
                                i_test                  => i_test,
                                i_commit                => i_commit,
                                o_id_drd                => o_id_drd,
                                o_flg_show              => o_flg_show,
                                o_msg_title             => o_msg_title,
                                o_msg                   => o_msg,
                                o_button                => o_button,
                                o_error                 => o_error);
    END;

    /********************************************************************************************
    * alert.pk_pharmacy.set_print_req
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_DRUG_REQ                      IN    NUMBER(24)
    * @param  I_PRINT_TYPE                    IN    VARCHAR2
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-09-01
    *
    ********************************************************************************************/
    PROCEDURE set_print_req
    (
        i_lang       IN language.id_language%TYPE,
        i_prof       IN alert.profissional,
        i_drug_req   IN drug_req.id_drug_req%TYPE,
        i_print_type IN drug_req.flg_print_type%TYPE
    ) IS
        l_state_transition_ok BOOLEAN := FALSE;
        l_id_drug_req_det     drug_req_det.id_drug_req_det%TYPE;
        l_current_req_state   drug_req_det.id_state%TYPE;
        l_next_req_state      drug_req_det.id_state%TYPE;
        l_notes               drug_req_det.notes%TYPE;
        l_datetime            drug_req.dt_print_tstz%TYPE;
    
        CURSOR req_lines(id_req IN drug_req.id_drug_req%TYPE) IS
            SELECT drd.id_drug_req_det, drd.id_state, drd.notes
              FROM drug_req_det drd
             WHERE drd.id_drug_req = id_req;
    BEGIN
        l_datetime := current_timestamp;
    
        OPEN req_lines(i_drug_req);
        LOOP
            FETCH req_lines
                INTO l_id_drug_req_det, l_current_req_state, l_notes;
            EXIT WHEN req_lines%NOTFOUND;
        
            l_next_req_state := get_state_for_req_type(i_prof, g_flg_int, g_drd_requested_st);
        
            set_pharmacy_log('set_print_req',
                             'l_current_req_state=' || l_current_req_state || ' l_next_req_state=' || l_next_req_state);
        
            --[MEDICATION_RULE] if states are equal then it's a re-print, so don't do anything
            IF (l_current_req_state != l_next_req_state)
            THEN
                l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                                 i_prof,
                                                                                 l_current_req_state,
                                                                                 l_next_req_state);
            
                set_pharmacy_log('set_print_req',
                                 'l_state_transition_ok=' || sys.diutil.bool_to_int(l_state_transition_ok));
            
                IF (l_state_transition_ok)
                THEN
                    UPDATE drug_req_det drd
                       SET drd.flg_status = 'R', --old flag
                           drd.id_state   = l_next_req_state
                     WHERE drd.id_drug_req_det = l_id_drug_req_det;
                
                    INSERT INTO drug_req_det_state_transition
                        (id_drug_req_det, id_state, id_prof, dt_state, notes1)
                    VALUES
                        (l_id_drug_req_det, l_next_req_state, i_prof.id, l_datetime, l_notes);
                ELSE
                    RAISE g_ex_invalid_st_transition;
                END IF;
            END IF;
        
        END LOOP;
        CLOSE req_lines;
    
        UPDATE drug_req dr
           SET dr.flg_status       = 'R', --old flag
               dr.flg_print_type   = i_print_type,
               dr.id_prof_print    = i_prof.id,
               dr.dt_print_tstz    = l_datetime,
               dr.dt_drug_req_tstz = l_datetime
         WHERE dr.id_drug_req = i_drug_req;
    
    EXCEPTION
        WHEN OTHERS THEN
            IF (req_lines%ISOPEN)
            THEN
                CLOSE req_lines;
            END IF;
            RAISE;
    END set_print_req;

    /********************************************************************************************
    * alert.pk_pharmacy.get_category_prof
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_PROF                       IN    NUMBER(24)
    * @param  O_CAT                           OUT   VARCHAR2
    * @param  O_FLG_TYPE                      OUT   VARCHAR2
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-02
    *
    ********************************************************************************************/
    FUNCTION get_category_prof
    (
        i_lang     IN language.id_language%TYPE,
        i_prof     IN alert.profissional,
        i_id_prof  IN professional.id_professional%TYPE,
        o_cat      OUT VARCHAR2,
        o_flg_type OUT VARCHAR2,
        o_error    OUT t_error_out
    ) RETURN BOOLEAN IS
    
        CURSOR c_cat IS
            SELECT cat.flg_type, pk_translation.get_translation(i_lang, cat.code_category) desc_category
              FROM prof_cat prc, category cat
             WHERE prc.id_professional = nvl(i_id_prof, i_prof.id)
               AND prc.id_institution = i_prof.institution
               AND cat.id_category = prc.id_category
               AND flg_available = g_yes
               AND flg_prof = g_yes;
    
    BEGIN
        g_error := 'GET CURSOR C_CAT';
        OPEN c_cat;
        FETCH c_cat
            INTO o_flg_type, o_cat;
        CLOSE c_cat;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            IF (c_cat%ISOPEN)
            THEN
                CLOSE c_cat;
            END IF;
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'GET_CATEGORY_PROF', o_error);
            RETURN FALSE;
    END;

    /********************************************************************************************
    * alert.pk_pharmacy.get_next_appointment_date
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PAT                           IN    NUMBER(24)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_PROF_CAT_TYPE                 IN    VARCHAR2
    *
    * @return TIMESTAMP WITH LOCAL TIME ZONE
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-02
    *
    ********************************************************************************************/
    FUNCTION get_next_appointment_date
    (
        i_lang          IN language.id_language%TYPE,
        i_pat           IN patient.id_patient%TYPE,
        i_prof          IN alert.profissional,
        i_prof_cat_type IN category.flg_type%TYPE
    ) RETURN schedule.dt_begin_tstz%TYPE IS
        l_dt_appointment schedule.dt_begin_tstz%TYPE;
    BEGIN
        BEGIN
            SELECT MIN(s.dt_begin_tstz)
              INTO l_dt_appointment
              FROM schedule s, sch_group sg
             WHERE sg.id_patient = i_pat
               AND s.id_schedule = sg.id_schedule
               AND pk_date_utils.trunc_insttimezone(i_prof, s.dt_begin_tstz, NULL) >
                   pk_date_utils.trunc_insttimezone(i_prof, current_timestamp, NULL);
        EXCEPTION
            WHEN no_data_found THEN
                l_dt_appointment := NULL;
        END;
    
        RETURN l_dt_appointment;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_next_appointment_date;

    /********************************************************************************************
    * alert.pk_pharmacy.pharmacist_all_grid
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_PROF_CAT_TYPE                 IN    VARCHAR2
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  O_REQ                           OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-02
    *
    ********************************************************************************************/
    FUNCTION pharmacist_all_grid
    (
        i_lang          IN language.id_language%TYPE,
        i_prof          IN alert.profissional,
        i_prof_cat_type IN category.flg_type%TYPE,
        i_get_headers   IN VARCHAR2 DEFAULT 'N',
        i_header_codes  IN table_varchar DEFAULT NULL,
        o_req           OUT pk_types.cursor_type,
        o_headers       OUT pk_types.cursor_type,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
        l_short_adm     sys_shortcut.id_sys_shortcut%TYPE := 0;
        l_short_int     sys_shortcut.id_sys_shortcut%TYPE := 0;
        l_short_pend    sys_shortcut.id_sys_shortcut%TYPE := 0;
        l_short_unidose sys_shortcut.id_sys_shortcut%TYPE := 0;
        l_prof_type     profile_template.flg_type%TYPE;
        --pk_supplies
        l_prof_sup   table_number;
        l_status_sup table_varchar;
    
    BEGIN
        g_error         := 'GET SHORTCUTS';
        l_short_adm     := get_shortcut(i_lang, i_prof, 'PHARMACIST_ADM');
        l_short_int     := get_shortcut(i_lang, i_prof, 'PHARMACIST_INT');
        l_short_pend    := get_shortcut(i_lang, i_prof, 'PHARMACIST_PENDENT');
        l_short_unidose := get_shortcut(i_lang, i_prof, 'PHARMACIST_UNIDOSE');
    
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error     := 'GET PROF TYPE';
        l_prof_type := get_prof_type(i_prof);
    
        --pk_supplies
        g_error := 'GET pk_supplies';
        --        l_prof_sup   := pk_supplies_core.get_prof_conf(i_lang, i_prof);
        --l_status_sup := pk_supplies_core.get_status_prof(i_lang, i_prof);
    
        g_error := 'GET CURSOR';
        OPEN o_req FOR
            SELECT v2.id_patient,
                   get_pat_name(i_lang, i_prof, v2.id_patient) name,
                   pk_adt.get_pat_non_disc_options(i_lang, i_prof, v2.id_patient) pat_ndo,
                   pk_adt.get_pat_non_disclosure_icon(i_lang, i_prof, v2.id_patient) pat_nd_icon,
                   pk_patient.get_pat_name_to_sort(i_lang, i_prof, v2.id_patient, v2.id_episode) pat_name_to_sort,
                   p2.gender,
                   pk_patient.get_pat_age(i_lang, v2.id_patient, i_prof) pat_age,
                   pk_patphoto.get_pat_photo(i_lang, i_prof, v2.id_patient, v2.id_episode, NULL) photo,
                   get_pat_location(i_lang, i_prof, v2.id_episode, v2.id_patient) pat_location,
                   get_pat_clin_record(i_lang, p2.id_patient, i_prof.institution) num_clin_record,
                   get_status_pipe_str(i_lang,
                                       i_prof,
                                       v2.st_int.state,
                                       i_prof_cat_type,
                                       v2.st_int.dt_state,
                                       l_short_int,
                                       '',
                                       g_yes) int_status,
                   get_status_pipe_str(i_lang,
                                       i_prof,
                                       v2.st_adm.state,
                                       i_prof_cat_type,
                                       v2.st_adm.dt_state,
                                       l_short_adm,
                                       '',
                                       g_yes) adm_status,
                   get_status_pipe_str(i_lang,
                                       i_prof,
                                       v2.st_uni.state,
                                       i_prof_cat_type,
                                       v2.st_uni.dt_state,
                                       l_short_unidose,
                                       '',
                                       g_yes) unidose_status,
                   get_status_pipe_str(i_lang,
                                       i_prof,
                                       v2.st_pend.state,
                                       i_prof_cat_type,
                                       v2.st_pend.dt_state,
                                       l_short_pend,
                                       '',
                                       g_yes) pend_status,
                   st_supl supplies_status,
                   v2.id_episode --para o header
              FROM patient p2,
                   (SELECT v1.id_patient,
                           v1.id_episode,
                           pharmacy_min_dt_state(t_rec_pharm_state_dt_rank(v1.id_st_int, v1.dt_req_int, v1.rank_int)) st_int,
                           pharmacy_min_dt_state(t_rec_pharm_state_dt_rank(v1.id_st_adm, v1.dt_req_adm, v1.rank_adm)) st_adm,
                           pharmacy_min_dt_state(t_rec_pharm_state_dt_rank(v1.id_st_uni, v1.dt_req_uni, v1.rank_uni)) st_uni,
                           pharmacy_min_dt_state(t_rec_pharm_state_dt_rank(v1.id_st_pend, v1.dt_req_pend, v1.rank_pend)) st_pend,
                           pk_supplies_api_db.get_epis_max_supply_delay(i_lang,
                                                                        i_prof,
                                                                        id_patient,
                                                                        pk_alert_constant.g_yes) st_supl
                      FROM (SELECT --ambulatorio
                             inter.id_patient,
                             inter.id_episode,
                             inter.id_state   id_st_int,
                             NULL             id_st_adm,
                             NULL             id_st_uni,
                             NULL             id_st_pend,
                             inter.dt_req     dt_req_int,
                             NULL             dt_req_adm,
                             NULL             dt_req_uni,
                             NULL             dt_req_pend,
                             sdp.rank         rank_int,
                             NULL             rank_adm,
                             NULL             rank_uni,
                             NULL             rank_pend
                              FROM TABLE(pharmacy_list(i_prof, g_flg_int)) inter, wfl_state sp, wfl_state_detail sdp
                             WHERE inter.id_state = sp.id_state
                               AND sp.id_state = sdp.state
                               AND sdp.prof_type = l_prof_type
                               AND get_grid_timeout(inter.id_state, i_prof, 'D') >
                                   pk_date_utils.get_timestamp_diff(current_timestamp, inter.dt_req)
                            UNION ALL
                            SELECT --adm local
                             adm.id_patient,
                             adm.id_episode,
                             NULL           id_st_int,
                             adm.id_state   id_st_adm,
                             NULL           id_st_uni,
                             NULL           id_st_pend,
                             NULL           dt_req_int,
                             adm.dt_req     dt_req_adm,
                             NULL           dt_req_uni,
                             NULL           dt_req_pend,
                             NULL           rank_int,
                             sdp.rank       rank_adm,
                             NULL           rank_uni,
                             NULL           rank_pend
                              FROM TABLE(pharmacy_list(i_prof, g_flg_adm, g_yes)) adm, wfl_state sp, wfl_state_detail sdp
                             WHERE adm.id_state = sp.id_state
                               AND sp.id_state = sdp.state
                               AND sdp.prof_type = l_prof_type
                               AND get_grid_timeout(adm.id_state, i_prof, 'D') >
                                   pk_date_utils.get_timestamp_diff(current_timestamp, adm.dt_req)
                            UNION ALL
                            SELECT --unidose
                             uni.id_patient,
                             uni.id_episode,
                             NULL           id_st_int,
                             NULL           id_st_adm,
                             uni.id_state   id_st_uni,
                             NULL           id_st_pend,
                             NULL           dt_req_int,
                             NULL           dt_req_adm,
                             uni.dt_req     dt_req_uni,
                             NULL           dt_req_pend,
                             NULL           rank_int,
                             NULL           rank_adm,
                             sdp.rank       rank_uni,
                             NULL           rank_pend
                              FROM TABLE(pharmacy_list(i_prof, g_flg_unidose, g_yes)) uni,
                                   wfl_state sp,
                                   wfl_state_detail sdp
                             WHERE uni.id_state = sp.id_state
                               AND sp.id_state = sdp.state
                               AND sdp.prof_type = l_prof_type
                               AND row_is_visible(uni.id_state, i_prof, 'D', current_timestamp, uni.dt_req, g_no, g_yes) =
                                   g_yes
                            UNION ALL
                            SELECT --pendente
                             pend.id_patient,
                             pend.id_episode,
                             NULL            id_st_int,
                             NULL            id_st_adm,
                             NULL            id_st_uni,
                             pend.id_state   id_st_pend,
                             NULL            dt_req_int,
                             NULL            dt_req_adm,
                             NULL            dt_req_uni,
                             pend.dt_req     dt_req_pend,
                             NULL            rank_int,
                             NULL            rank_adm,
                             NULL            rank_uni,
                             sdp.rank        rank_pend
                              FROM TABLE(pharmacy_pending_list(i_prof)) pend, wfl_state sp, wfl_state_detail sdp
                             WHERE pend.id_state = sp.id_state
                               AND sp.id_state = sdp.state
                               AND sdp.prof_type = l_prof_type
                               AND get_grid_timeout(pend.id_state, i_prof, 'D') >
                                   pk_date_utils.get_timestamp_diff(current_timestamp, pend.dt_req)
                            --pk_supplies
                            UNION ALL
                            SELECT DISTINCT 1             id_patient,
                                            sw.id_episode id_episode,
                                            NULL          id_st_int,
                                            NULL          id_st_adm,
                                            NULL          id_st_uni,
                                            NULL          id_st_pend,
                                            NULL          dt_req_int,
                                            NULL          dt_req_adm,
                                            NULL          dt_req_uni,
                                            NULL          dt_req_pend,
                                            NULL          rank_int,
                                            NULL          rank_adm,
                                            NULL          rank_uni,
                                            NULL          rank_pend
                              FROM supply_request sr, supply_workflow sw, supply_location sl, episode e
                             WHERE sr.id_professional IN
                                   (SELECT column_value
                                      FROM TABLE(CAST(l_prof_sup AS table_number)))
                               AND sr.flg_status IN
                                   (pk_supplies_constant.g_srt_requested, pk_supplies_constant.g_srt_ongoing)
                               AND sr.id_episode = sw.id_episode
                               AND e.id_episode = sr.id_episode
                               AND e.id_institution = i_prof.institution
                               AND sl.id_supply_location = sw.id_supply_location
                               AND sl.flg_cat_workflow = pk_supplies_constant.g_supply_cat_workflow_f
                               AND sw.flg_status IN (SELECT column_value
                                                       FROM TABLE(CAST(l_status_sup AS table_varchar)))) v1
                     GROUP BY v1.id_patient, v1.id_episode) v2
             WHERE p2.id_patient = v2.id_patient
             ORDER BY pat_name_to_sort;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'PHARMACIST_ALL_GRID', o_error);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_req);
            RETURN FALSE;
    END pharmacist_all_grid;

    /********************************************************************************************
    * alert.pk_pharmacy.pharmacist_grid
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_PROF_CAT_TYPE                 IN    VARCHAR2
    * @param  I_REQ_TYPE                      IN    VARCHAR2
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  I_GET_VISIONS                   IN    VARCHAR2
    * @param  I_SERVICE                       IN    NUMBER(12)
    * @param  O_REQ                           OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_VISIONS                       OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.2
    * @since  2009-11-17
    *
    ********************************************************************************************/
    FUNCTION pharmacist_grid
    (
        i_lang          IN language.id_language%TYPE,
        i_prof          IN alert.profissional,
        i_prof_cat_type IN category.flg_type%TYPE,
        i_req_type      IN drug_req.flg_type%TYPE,
        i_get_headers   IN VARCHAR2 DEFAULT 'N',
        i_header_codes  IN table_varchar DEFAULT NULL,
        i_get_visions   IN VARCHAR2 DEFAULT 'N',
        i_service       IN clinical_service.id_clinical_service%TYPE DEFAULT NULL,
        o_req           OUT pk_types.cursor_type,
        o_headers       OUT pk_types.cursor_type,
        o_visions       OUT pk_types.cursor_type,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
        l_shortcut          sys_shortcut.id_sys_shortcut%TYPE;
        l_shortcut_name     sys_shortcut.intern_name%TYPE;
        l_prof_type         profile_template.flg_type%TYPE;
        l_dep_clin_servs    table_number;
        l_dcs_count         NUMBER := 0;
        l_note_msg          sys_message.desc_message%TYPE := '';
        l_drawer_msg        sys_message.desc_message%TYPE := '';
        l_states_for_grid   table_number;
        l_states_for_grid_1 table_number;
    BEGIN
        g_error         := 'GET SHORTCUT';
        l_shortcut_name := CASE i_req_type
                               WHEN g_flg_adm THEN
                                'PHARMACIST_ADM'
                               WHEN g_flg_int THEN
                                'PHARMACIST_INT'
                               WHEN g_flg_unidose THEN
                                'PHARMACIST_UNIDOSE'
                           END;
        l_shortcut      := get_shortcut(i_lang, i_prof, l_shortcut_name);
    
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error := 'GET VISIONS';
        get_pharmacy_unidose_visions(i_lang, i_prof, i_get_visions, o_visions);
    
        g_error     := 'GET PROF TYPE';
        l_prof_type := get_prof_type(i_prof);
    
        g_error      := 'GET QUERY MESSAGES';
        l_note_msg   := pk_message.get_message(i_lang, 'COMMON_M008');
        l_drawer_msg := pk_message.get_message(i_lang, 'PHARMACIST_UNIDOSE_DRAWER');
    
        IF (i_req_type IN (g_flg_adm, g_flg_int))
        THEN
        
            g_error := 'GET CURSOR (ADM/INT)';
            OPEN o_req FOR
                SELECT p2.id_patient,
                       get_pat_name(i_lang, i_prof, p2.id_patient) name,
                       pk_adt.get_pat_non_disc_options(i_lang, i_prof, p2.id_patient) pat_ndo,
                       pk_adt.get_pat_non_disclosure_icon(i_lang, i_prof, p2.id_patient) pat_nd_icon,
                       pk_patient.get_pat_name_to_sort(i_lang, i_prof, v1.id_patient, v1.id_episode) pat_name_to_sort,
                       p2.gender,
                       pk_patient.get_pat_age(i_lang, v1.id_patient, i_prof) pat_age,
                       pk_patphoto.get_pat_photo(i_lang, i_prof, v1.id_patient, v1.id_episode, NULL) photo,
                       get_pat_location(i_lang, i_prof, v1.id_episode, v1.id_patient) pat_location,
                       pk_date_utils.date_send_tsz(i_lang, v1.dt_req, i_prof) date_target,
                       decode(v1.has_notes, 0, NULL, l_note_msg) has_notes,
                       get_status_pipe_str(i_lang,
                                           i_prof,
                                           v1.id_state,
                                           i_prof_cat_type,
                                           v1.dt_req,
                                           l_shortcut,
                                           '',
                                           g_yes) adm_status,
                       get_pat_clin_record(i_lang, p2.id_patient, i_prof.institution) num_clin_record,
                       ws.id_state,
                       decode(i_req_type,
                              g_flg_int,
                              pk_date_utils.date_send_tsz(i_lang,
                                                          get_next_appointment_date(i_lang,
                                                                                    p2.id_patient,
                                                                                    i_prof,
                                                                                    i_prof_cat_type),
                                                          i_prof),
                              '') dt_next_appointment,
                       v1.id_episode --para o header
                  FROM patient p2,
                       TABLE(pharmacy_list(i_prof, i_req_type, g_yes)) v1,
                       wfl_state ws,
                       wfl_state_detail wsd
                 WHERE p2.id_patient = v1.id_patient
                   AND v1.id_state = ws.id_state
                   AND ws.id_state = wsd.state
                   AND wsd.prof_type = l_prof_type
                   AND get_grid_timeout(ws.id_state, i_prof, 'D') >
                       pk_date_utils.get_timestamp_diff(current_timestamp, v1.dt_req)
                 ORDER BY wsd.rank, v1.dt_req;
        
        ELSIF (i_req_type = g_flg_unidose)
        THEN
        
            get_allocation_for_prof(i_prof, l_dep_clin_servs);
            l_dcs_count := l_dep_clin_servs.count;
        
            set_pharmacy_log('pharmacist_grid', 'i_service=' || i_service || '#l_dcs_count=' || l_dcs_count);
        
            l_states_for_grid   := get_states_for_req_type(i_prof, NULL, g_grid_pat_drs_adm_states);
            l_states_for_grid_1 := get_grid_allowed_states(i_prof, i_req_type, 'GRID_1');
        
            IF (i_service IS NOT NULL)
            THEN
            
                g_error := 'GET CURSOR (UNIDOSE) WITH SERVICE';
                set_pharmacy_log('pharmacist_grid', g_error);
                OPEN o_req FOR
                    SELECT --
                     p.id_patient,
                     get_pat_name(i_lang, i_prof, p.id_patient) name,
                     pk_adt.get_pat_non_disc_options(i_lang, i_prof, p.id_patient) pat_ndo,
                     pk_adt.get_pat_non_disclosure_icon(i_lang, i_prof, p.id_patient) pat_nd_icon,
                     pk_patient.get_pat_name_to_sort(i_lang, i_prof, dr.id_patient, dr.id_episode) pat_name_to_sort,
                     p.gender,
                     pk_patient.get_pat_age(i_lang, p.id_patient, i_prof) pat_age,
                     pk_patphoto.get_pat_foto(v1.id_patient, i_prof) photo,
                     get_pat_location(i_lang, i_prof, dr.id_episode, v1.id_patient) pat_location,
                     get_pat_clin_record(i_lang, p.id_patient, i_prof.institution) num_clin_record,
                     pk_date_utils.date_send_tsz(i_lang, dr.dt_drug_req_tstz, i_prof) date_target,
                     get_status_pipe_str(i_lang,
                                         i_prof,
                                         v1.st.state,
                                         i_prof_cat_type,
                                         v1.st.dt_state,
                                         l_shortcut,
                                         '',
                                         g_yes) uni_status,
                     e.id_episode, --para o header
                     pk_date_utils.dt_chr(i_lang, min_dr.dt_drug_req_tstz, i_prof) || '<br/>' ||
                     pk_date_utils.dt_chr(i_lang, max_dr.dt_drug_req_tstz, i_prof) req_dates,
                     v1.car_slots
                      FROM (SELECT dr.id_patient,
                                   MIN(drd.id_drug_req_det) min_drd,
                                   MAX(drd.id_drug_req_det) max_drd,
                                   pharmacy_uni_type2varchar(pharmacy_tbl_uni_car_drawers(t_rec_pharm_uni_car_drawer(uc.id_unidose_car,
                                                                                                                     ucs.slot_number,
                                                                                                                     ucm.car_model_name,
                                                                                                                     l_drawer_msg))) car_slots,
                                   pharmacy_min_dt_state(t_rec_pharm_state_dt_rank(nvl(drs.id_state, drd.id_state),
                                                                                   nvl(drsst.dt_state, drdst.dt_state),
                                                                                   nvl(wsd2.rank, wsd.rank))) st
                              FROM drug_req_det drd
                             INNER JOIN drug_req dr
                                ON (drd.id_drug_req = dr.id_drug_req)
                             INNER JOIN episode e
                                ON (dr.id_episode = e.id_episode)
                             INNER JOIN epis_info ei
                                ON (e.id_episode = ei.id_episode)
                             INNER JOIN visit v
                                ON (e.id_visit = v.id_visit)
                              LEFT JOIN pharm_unidose_slot_content usc
                                ON (drd.id_drug_req_det = usc.id_drug_req_det)
                              LEFT JOIN pharm_unidose_car_slot ucs
                                ON (usc.id_unidose_car = ucs.id_unidose_car AND usc.slot_number = ucs.slot_number)
                              LEFT JOIN pharm_unidose_car uc
                                ON (ucs.id_unidose_car = uc.id_unidose_car)
                              LEFT JOIN pharm_unidose_car_model ucm
                                ON (uc.id_car_model = ucm.id_unidose_car_model)
                             INNER JOIN wfl_state ws
                                ON (drd.id_state = ws.id_state)
                             INNER JOIN wfl_state_detail wsd
                                ON (ws.id_state = wsd.state AND wsd.prof_type = l_prof_type)
                             INNER JOIN drug_req_det_state_transition drdst
                                ON (drd.id_drug_req_det = drdst.id_drug_req_det AND drd.id_state = drdst.id_state)
                              LEFT JOIN drug_req_supply drs
                                ON (drd.id_drug_req_det = drs.id_drug_req_det AND
                                   drs.id_state IN (SELECT column_value
                                                       FROM TABLE(l_states_for_grid)))
                              LEFT JOIN drug_req_sup_state_transition drsst
                                ON (drs.id_drug_req_supply = drsst.id_drug_req_supply AND drs.id_state = drsst.id_state)
                              LEFT JOIN wfl_state ws2
                                ON (drs.id_state = ws2.id_state)
                              LEFT JOIN wfl_state_detail wsd2
                                ON (ws2.id_state = wsd2.state AND wsd2.prof_type = l_prof_type)
                            --
                             INNER JOIN bmng_allocation_bed bab
                                ON (e.id_episode = bab.id_episode AND dr.id_patient = bab.id_patient)
                             INNER JOIN room r
                                ON (bab.id_room = r.id_room)
                             INNER JOIN department d
                                ON (r.id_department = d.id_department)
                             INNER JOIN dep_clin_serv dcs
                                ON (d.id_department = dcs.id_department)
                             WHERE dr.flg_type = i_req_type
                               AND v.id_institution = i_prof.institution
                               AND v.flg_status != 'C' -- not canceled
                               AND e.flg_status = 'A' -- active episode
                               AND drd.id_state IN (SELECT column_value
                                                      FROM TABLE(l_states_for_grid_1))
                               AND get_grid_timeout(drd.id_state, i_prof, 'D') >
                                   pk_date_utils.get_timestamp_diff(current_timestamp, drdst.dt_state)
                               AND dcs.id_department = i_service
                             GROUP BY dr.id_patient, uc.id_unidose_car) v1,
                           patient p,
                           drug_req_det min_drd,
                           drug_req_det max_drd,
                           drug_req dr,
                           drug_req min_dr,
                           drug_req max_dr,
                           episode e,
                           wfl_state ws,
                           wfl_state_detail wsd
                     WHERE v1.id_patient = p.id_patient
                       AND v1.max_drd = max_drd.id_drug_req_det
                       AND v1.min_drd = min_drd.id_drug_req_det
                       AND min_drd.id_drug_req = dr.id_drug_req
                       AND dr.id_episode = e.id_episode
                       AND max_drd.id_drug_req = max_dr.id_drug_req
                       AND min_drd.id_drug_req = min_dr.id_drug_req
                       AND v1.st.state = ws.id_state
                       AND ws.id_state = wsd.state
                       AND wsd.prof_type = l_prof_type
                     ORDER BY wsd.rank, min_dr.dt_drug_req_tstz, v1.st.dt_state, pat_name_to_sort;
            
            ELSIF (i_service IS NULL AND l_dcs_count > 0)
            THEN
            
                g_error := 'GET CURSOR (UNIDOSE) WITHOUT SERVICE BUT WITH ALLOCATED SERVICES';
                set_pharmacy_log('pharmacist_grid', g_error);
                OPEN o_req FOR
                    SELECT --
                     p.id_patient,
                     get_pat_name(i_lang, i_prof, p.id_patient) name,
                     pk_adt.get_pat_non_disc_options(i_lang, i_prof, p.id_patient) pat_ndo,
                     pk_adt.get_pat_non_disclosure_icon(i_lang, i_prof, p.id_patient) pat_nd_icon,
                     pk_patient.get_pat_name_to_sort(i_lang, i_prof, dr.id_patient, dr.id_episode) pat_name_to_sort,
                     p.gender,
                     pk_patient.get_pat_age(i_lang, p.id_patient, i_prof) pat_age,
                     pk_patphoto.get_pat_foto(v1.id_patient, i_prof) photo,
                     get_pat_location(i_lang, i_prof, dr.id_episode, v1.id_patient) pat_location,
                     get_pat_clin_record(i_lang, p.id_patient, i_prof.institution) num_clin_record,
                     pk_date_utils.date_send_tsz(i_lang, dr.dt_drug_req_tstz, i_prof) date_target,
                     get_status_pipe_str(i_lang,
                                         i_prof,
                                         v1.st.state,
                                         i_prof_cat_type,
                                         v1.st.dt_state,
                                         l_shortcut,
                                         '',
                                         g_yes) uni_status,
                     e.id_episode, --para o header
                     pk_date_utils.dt_chr(i_lang, min_dr.dt_drug_req_tstz, i_prof) || '<br/>' ||
                     pk_date_utils.dt_chr(i_lang, max_dr.dt_drug_req_tstz, i_prof) req_dates,
                     v1.car_slots
                      FROM (SELECT dr.id_patient,
                                   MIN(drd.id_drug_req_det) min_drd,
                                   MAX(drd.id_drug_req_det) max_drd,
                                   pharmacy_uni_type2varchar(pharmacy_tbl_uni_car_drawers(t_rec_pharm_uni_car_drawer(uc.id_unidose_car,
                                                                                                                     ucs.slot_number,
                                                                                                                     ucm.car_model_name,
                                                                                                                     l_drawer_msg))) car_slots,
                                   pharmacy_min_dt_state(t_rec_pharm_state_dt_rank(nvl(drs.id_state, drd.id_state),
                                                                                   nvl(drsst.dt_state, drdst.dt_state),
                                                                                   nvl(wsd2.rank, wsd.rank))) st
                              FROM drug_req_det drd
                             INNER JOIN drug_req dr
                                ON (drd.id_drug_req = dr.id_drug_req)
                             INNER JOIN episode e
                                ON (dr.id_episode = e.id_episode)
                             INNER JOIN epis_info ei
                                ON (e.id_episode = ei.id_episode)
                             INNER JOIN visit v
                                ON (e.id_visit = v.id_visit)
                              LEFT JOIN pharm_unidose_slot_content usc
                                ON (drd.id_drug_req_det = usc.id_drug_req_det)
                              LEFT JOIN pharm_unidose_car_slot ucs
                                ON (usc.id_unidose_car = ucs.id_unidose_car AND usc.slot_number = ucs.slot_number)
                              LEFT JOIN pharm_unidose_car uc
                                ON (ucs.id_unidose_car = uc.id_unidose_car)
                              LEFT JOIN pharm_unidose_car_model ucm
                                ON (uc.id_car_model = ucm.id_unidose_car_model)
                             INNER JOIN wfl_state ws
                                ON (drd.id_state = ws.id_state)
                             INNER JOIN wfl_state_detail wsd
                                ON (ws.id_state = wsd.state AND wsd.prof_type = l_prof_type)
                             INNER JOIN drug_req_det_state_transition drdst
                                ON (drd.id_drug_req_det = drdst.id_drug_req_det AND drd.id_state = drdst.id_state)
                              LEFT JOIN drug_req_supply drs
                                ON (drd.id_drug_req_det = drs.id_drug_req_det AND
                                   drs.id_state IN (SELECT column_value
                                                       FROM TABLE(l_states_for_grid)))
                              LEFT JOIN drug_req_sup_state_transition drsst
                                ON (drs.id_drug_req_supply = drsst.id_drug_req_supply AND drs.id_state = drsst.id_state)
                              LEFT JOIN wfl_state ws2
                                ON (drs.id_state = ws2.id_state)
                              LEFT JOIN wfl_state_detail wsd2
                                ON (ws2.id_state = wsd2.state AND wsd2.prof_type = l_prof_type)
                            --
                             INNER JOIN bmng_allocation_bed bab
                                ON (e.id_episode = bab.id_episode AND dr.id_patient = bab.id_patient)
                             INNER JOIN room r
                                ON (bab.id_room = r.id_room)
                             INNER JOIN department d
                                ON (r.id_department = d.id_department)
                             INNER JOIN dep_clin_serv dcs
                                ON (d.id_department = dcs.id_department)
                            --filter orders by id_dep_clin_server (pharmacist allocation to departments/services)
                              LEFT JOIN (SELECT column_value
                                          FROM TABLE(l_dep_clin_servs)) x
                                ON (dcs.id_dep_clin_serv = x.column_value)
                             WHERE dr.flg_type = i_req_type
                               AND v.id_institution = i_prof.institution
                               AND v.flg_status != 'C' -- not canceled
                               AND e.flg_status = 'A' -- active episode
                               AND drd.id_state IN (SELECT column_value
                                                      FROM TABLE(l_states_for_grid_1))
                               AND get_grid_timeout(drd.id_state, i_prof, 'D') >
                                   pk_date_utils.get_timestamp_diff(current_timestamp, drdst.dt_state)
                             GROUP BY dr.id_patient, uc.id_unidose_car) v1,
                           patient p,
                           drug_req_det min_drd,
                           drug_req_det max_drd,
                           drug_req dr,
                           drug_req min_dr,
                           drug_req max_dr,
                           episode e,
                           wfl_state ws,
                           wfl_state_detail wsd
                     WHERE v1.id_patient = p.id_patient
                       AND v1.max_drd = max_drd.id_drug_req_det
                       AND v1.min_drd = min_drd.id_drug_req_det
                       AND min_drd.id_drug_req = dr.id_drug_req
                       AND dr.id_episode = e.id_episode
                       AND max_drd.id_drug_req = max_dr.id_drug_req
                       AND min_drd.id_drug_req = min_dr.id_drug_req
                       AND v1.st.state = ws.id_state
                       AND ws.id_state = wsd.state
                       AND wsd.prof_type = l_prof_type
                     ORDER BY wsd.rank, min_dr.dt_drug_req_tstz, v1.st.dt_state, pat_name_to_sort;
            
            ELSE
            
                g_error := 'GET CURSOR (UNIDOSE) NO FILTER! NO ALLOCATION!';
                set_pharmacy_log('pharmacist_grid', g_error);
                OPEN o_req FOR
                    SELECT --
                     p.id_patient,
                     get_pat_name(i_lang, i_prof, p.id_patient) name,
                     pk_adt.get_pat_non_disc_options(i_lang, i_prof, p.id_patient) pat_ndo,
                     pk_adt.get_pat_non_disclosure_icon(i_lang, i_prof, p.id_patient) pat_nd_icon,
                     pk_patient.get_pat_name_to_sort(i_lang, i_prof, dr.id_patient, dr.id_episode) pat_name_to_sort,
                     p.gender,
                     pk_patient.get_pat_age(i_lang, p.id_patient, i_prof) pat_age,
                     pk_patphoto.get_pat_foto(v1.id_patient, i_prof) photo,
                     get_pat_location(i_lang, i_prof, dr.id_episode, v1.id_patient) pat_location,
                     get_pat_clin_record(i_lang, p.id_patient, i_prof.institution) num_clin_record,
                     pk_date_utils.date_send_tsz(i_lang, dr.dt_drug_req_tstz, i_prof) date_target,
                     get_status_pipe_str(i_lang,
                                         i_prof,
                                         v1.st.state,
                                         i_prof_cat_type,
                                         v1.st.dt_state,
                                         l_shortcut,
                                         '',
                                         g_yes) uni_status,
                     e.id_episode, --para o header
                     pk_date_utils.dt_chr(i_lang, min_dr.dt_drug_req_tstz, i_prof) || '<br/>' ||
                     pk_date_utils.dt_chr(i_lang, max_dr.dt_drug_req_tstz, i_prof) req_dates,
                     v1.car_slots
                      FROM (SELECT dr.id_patient,
                                   MIN(drd.id_drug_req_det) min_drd,
                                   MAX(drd.id_drug_req_det) max_drd,
                                   pharmacy_uni_type2varchar(pharmacy_tbl_uni_car_drawers(t_rec_pharm_uni_car_drawer(uc.id_unidose_car,
                                                                                                                     ucs.slot_number,
                                                                                                                     ucm.car_model_name,
                                                                                                                     l_drawer_msg))) car_slots,
                                   pharmacy_min_dt_state(t_rec_pharm_state_dt_rank(nvl(drs.id_state, drd.id_state),
                                                                                   nvl(drsst.dt_state, drdst.dt_state),
                                                                                   nvl(wsd2.rank, wsd.rank))) st
                              FROM drug_req_det drd
                             INNER JOIN drug_req dr
                                ON (drd.id_drug_req = dr.id_drug_req)
                             INNER JOIN episode e
                                ON (dr.id_episode = e.id_episode)
                             INNER JOIN epis_info ei
                                ON (e.id_episode = ei.id_episode)
                             INNER JOIN visit v
                                ON (e.id_visit = v.id_visit)
                              LEFT JOIN pharm_unidose_slot_content usc
                                ON (drd.id_drug_req_det = usc.id_drug_req_det)
                              LEFT JOIN pharm_unidose_car_slot ucs
                                ON (usc.id_unidose_car = ucs.id_unidose_car AND usc.slot_number = ucs.slot_number)
                              LEFT JOIN pharm_unidose_car uc
                                ON (ucs.id_unidose_car = uc.id_unidose_car)
                              LEFT JOIN pharm_unidose_car_model ucm
                                ON (uc.id_car_model = ucm.id_unidose_car_model)
                             INNER JOIN wfl_state ws
                                ON (drd.id_state = ws.id_state)
                             INNER JOIN wfl_state_detail wsd
                                ON (ws.id_state = wsd.state AND wsd.prof_type = l_prof_type)
                             INNER JOIN drug_req_det_state_transition drdst
                                ON (drd.id_drug_req_det = drdst.id_drug_req_det AND drd.id_state = drdst.id_state)
                              LEFT JOIN drug_req_supply drs
                                ON (drd.id_drug_req_det = drs.id_drug_req_det AND
                                   drs.id_state IN (SELECT column_value
                                                       FROM TABLE(l_states_for_grid)))
                              LEFT JOIN drug_req_sup_state_transition drsst
                                ON (drs.id_drug_req_supply = drsst.id_drug_req_supply AND drs.id_state = drsst.id_state)
                              LEFT JOIN wfl_state ws2
                                ON (drs.id_state = ws2.id_state)
                              LEFT JOIN wfl_state_detail wsd2
                                ON (ws2.id_state = wsd2.state AND wsd2.prof_type = l_prof_type)
                             WHERE dr.flg_type = i_req_type
                               AND v.id_institution = i_prof.institution
                               AND v.flg_status != 'C' -- not canceled
                               AND e.flg_status = 'A' -- active episode
                               AND drd.id_state IN (SELECT column_value
                                                      FROM TABLE(l_states_for_grid_1))
                               AND get_grid_timeout(drd.id_state, i_prof, 'D') >
                                   pk_date_utils.get_timestamp_diff(current_timestamp, drdst.dt_state)
                             GROUP BY dr.id_patient, uc.id_unidose_car) v1,
                           patient p,
                           drug_req_det min_drd,
                           drug_req_det max_drd,
                           drug_req dr,
                           drug_req min_dr,
                           drug_req max_dr,
                           episode e,
                           wfl_state ws,
                           wfl_state_detail wsd
                     WHERE v1.id_patient = p.id_patient
                       AND v1.max_drd = max_drd.id_drug_req_det
                       AND v1.min_drd = min_drd.id_drug_req_det
                       AND min_drd.id_drug_req = dr.id_drug_req
                       AND dr.id_episode = e.id_episode
                       AND max_drd.id_drug_req = max_dr.id_drug_req
                       AND min_drd.id_drug_req = min_dr.id_drug_req
                       AND v1.st.state = ws.id_state
                       AND ws.id_state = wsd.state
                       AND wsd.prof_type = l_prof_type
                     ORDER BY wsd.rank, min_dr.dt_drug_req_tstz, v1.st.dt_state, pat_name_to_sort;
            
            END IF;
        
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'PHARMACIST_GRID', o_error);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_visions);
            pk_types.open_my_cursor(o_req);
            RETURN FALSE;
    END pharmacist_grid;

    /********************************************************************************************
    * alert.pk_pharmacy.pharmacist_uni_med_serv_grid  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_PROF_CAT_TYPE                 IN        VARCHAR2
    * @param  I_GET_HEADERS                   IN        VARCHAR2
    * @param  I_HEADER_CODES                  IN        ALERT.TABLE_VARCHAR
    * @param  I_GET_VISIONS                   IN        VARCHAR2
    * @param  I_GET_ACTIONS                   IN        VARCHAR2
    * @param  I_SERVICE                       IN        NUMBER(12)
    * @param  I_FLG_FILTER                    IN        VARCHAR2
    * @param  O_PREPARE_NOT_VALIDATED         OUT       VARCHAR2
    * @param  O_PREPARE_NOT_VAL_JUSTI         OUT       VARCHAR2
    * @param  O_PREPARE_CHANGE_NOT_VAL        OUT       VARCHAR2
    * @param  O_REQ                           OUT       REF CURSOR
    * @param  O_HEADERS                       OUT       REF CURSOR
    * @param  O_VISIONS                       OUT       REF CURSOR
    * @param  O_ACTIONS                       OUT       REF CURSOR
    * @param  O_UNITS                         OUT       REF CURSOR
    * @param  O_ERROR                         OUT       ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.8
    * @since  2010-07-08
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION pharmacist_uni_med_serv_grid
    (
        i_lang                   IN language.id_language%TYPE,
        i_prof                   IN alert.profissional,
        i_prof_cat_type          IN category.flg_type%TYPE,
        i_get_headers            IN VARCHAR2 DEFAULT 'N',
        i_header_codes           IN table_varchar DEFAULT NULL,
        i_get_visions            IN VARCHAR2 DEFAULT 'N',
        i_get_actions            IN VARCHAR2 DEFAULT 'N',
        i_service                IN clinical_service.id_clinical_service%TYPE DEFAULT NULL,
        i_flg_filter             IN VARCHAR2 DEFAULT 'MED_VAL', -- MED_VAL | MED_NOT_VAL | MED_PREP
        o_prepare_not_validated  OUT VARCHAR2,
        o_prepare_not_val_justi  OUT VARCHAR2,
        o_prepare_change_not_val OUT VARCHAR2,
        o_req                    OUT pk_types.cursor_type,
        o_headers                OUT pk_types.cursor_type,
        o_visions                OUT pk_types.cursor_type,
        o_actions                OUT pk_types.cursor_type,
        o_units                  OUT pk_types.cursor_type,
        o_error                  OUT t_error_out
    ) RETURN BOOLEAN IS
        l_dep_clin_servs table_number;
        l_dcs_count      NUMBER := 0;
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'pharmacist_uni_med_serv_grid';
        l_dummy                    BOOLEAN := FALSE;
        l_grid_states_validated    table_number;
        l_grid_states_car          table_number;
        l_grid_state_not_validated wfl_state.id_state%TYPE;
        l_grid_state_prepared      wfl_state.id_state%TYPE;
        l_datetime                 TIMESTAMP WITH LOCAL TIME ZONE;
    BEGIN
        l_datetime := current_timestamp;
    
        g_error := 'GET DISPENSE UNITS';
        l_dummy := get_dispense_units(i_lang, i_prof, o_units, o_error);
    
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error := 'GET ACTIONS';
        get_pharmacy_actions(i_lang, i_prof, i_get_actions, table_number(g_action_uni_prepare), o_actions);
    
        g_error := 'GET VISIONS';
        get_pharmacy_unidose_visions(i_lang, i_prof, i_get_visions, o_visions);
    
        g_error := 'GET GET_ALLOCATION_FOR_PROF';
        get_allocation_for_prof(i_prof, l_dep_clin_servs);
        l_dcs_count := l_dep_clin_servs.count;
    
        g_error                  := 'GET SYS CONFIGS';
        o_prepare_not_validated  := nvl(pk_sysconfig.get_config(i_code_cf => 'PHARMACY_UNI_CAN_PREPARE_NOT_VALIDATED',
                                                                i_prof    => i_prof),
                                        g_no);
        o_prepare_not_val_justi  := nvl(pk_sysconfig.get_config(i_code_cf => 'PHARMACY_UNI_CAN_PREPARE_NOT_VALIDATED_WITH_JUSTIFICATION',
                                                                i_prof    => i_prof),
                                        g_no);
        o_prepare_change_not_val := nvl(pk_sysconfig.get_config(i_code_cf => 'PHARMACY_UNI_CAN_CHANGE_PREPARE_NOT_VALIDATED',
                                                                i_prof    => i_prof),
                                        g_no);
    
        g_error                    := 'GET STATES';
        l_grid_states_validated    := get_states_for_req_type(i_prof,
                                                              g_flg_unidose,
                                                              table_varchar(g_drd_validated_st,
                                                                            g_drd_validated_sign_st,
                                                                            g_drd_executing_st));
        l_grid_state_not_validated := get_state_for_req_type(i_prof, g_flg_unidose, g_drd_requested_st);
        l_grid_state_prepared      := get_state_for_req_type(i_prof, NULL, g_drs_readyforvalid_st);
        l_grid_states_car          := get_states_for_req_type(i_prof,
                                                              NULL,
                                                              table_varchar(g_uni_car_parked_st,
                                                                            g_uni_car_executing_st,
                                                                            g_uni_car_ready4transp_st));
    
        IF (i_flg_filter = 'MED_VAL')
        THEN
        
            g_error := 'GET CURSOR (UNIDOSE MEDS/SERVICES) - VALIDATED';
            OPEN o_req FOR
                SELECT v2.id_drug_req_det,
                       v2.id_drug,
                       v2.vers,
                       v2.id_other_product,
                       --
                       get_medication_name(i_lang,
                                           i_prof,
                                           v2.id_drug,
                                           v2.vers,
                                           g_flg_unidose,
                                           v2.id_drug_presc_det,
                                           g_yes,
                                           v2.id_other_product) pharm,
                       --
                       pk_translation.get_translation(i_lang, v2.code_clinical_service) clinical_service,
                       v2.car_model_name car_name,
                       v2.id_unidose_car,
                       --
                       nvl(get_qty_pending(i_prof, v2.id_drug_req_det, g_no, g_no, l_datetime), 0) || ' ' ||
                       pk_medication_core.get_unit_translation(i_lang, i_prof, v2.id_unit_measure_prep, 3) desc_qty_to_prep,
                       --
                       NULL desc_qty_prep,
                       --
                       get_status_pipe_str(i_lang, i_prof, v2.id_state, i_prof_cat_type, v2.dt_state, '', '', g_yes) status,
                       v2.id_state
                  FROM (SELECT pharmacy_tbl_num(drd.id_drug_req_det) id_drug_req_det,
                               drd.id_drug,
                               drd.vers,
                               drd.id_other_product,
                               drd.id_unit_measure_prep,
                               drd.id_state,
                               pharmacy_top_one_num(dr.id_drug_presc_det) id_drug_presc_det, --top 1 (first presc from N drug_reqs.. it is just to get the medication name.. so, only the first one is needed)
                               MIN(drdst.dt_state) dt_state, --min date (most delayed)
                               cs.code_clinical_service,
                               ucm.car_model_name,
                               pharmacy_tbl_num(uc.id_unidose_car) id_unidose_car
                          FROM drug_req_det drd
                         INNER JOIN drug_req dr
                            ON (drd.id_drug_req = dr.id_drug_req)
                         INNER JOIN drug_req_det_state_transition drdst
                            ON (drd.id_drug_req_det = drdst.id_drug_req_det AND drd.id_state = drdst.id_state)
                         INNER JOIN episode e
                            ON (dr.id_episode = e.id_episode)
                         INNER JOIN visit v
                            ON (e.id_visit = v.id_visit)
                         INNER JOIN (
                                    --orders allocated to slots of the car
                                    SELECT ucs.id_unidose_car, usc.id_drug_req_det
                                      FROM pharm_unidose_car_slot ucs
                                     INNER JOIN pharm_unidose_slot_content usc
                                        ON (ucs.id_unidose_car = usc.id_unidose_car AND ucs.slot_number = usc.slot_number)
                                    UNION ALL
                                    --orders allocated to car, but not to slots
                                    SELECT ucc.id_unidose_car, ucc.id_drug_req_det
                                      FROM pharm_unidose_car_content ucc) v1
                            ON (drd.id_drug_req_det = v1.id_drug_req_det)
                         INNER JOIN pharm_unidose_car uc
                            ON (v1.id_unidose_car = uc.id_unidose_car)
                         INNER JOIN pharm_unidose_car_model ucm
                            ON (uc.id_car_model = ucm.id_unidose_car_model)
                         INNER JOIN dep_clin_serv dcs
                            ON (ucm.id_dep_clin_serv = dcs.id_dep_clin_serv AND
                               (i_service IS NULL OR dcs.id_department = i_service))
                         INNER JOIN clinical_service cs
                            ON (dcs.id_clinical_service = cs.id_clinical_service)
                         WHERE dr.flg_type = g_flg_unidose
                           AND e.flg_status = 'A' --active episode
                           AND v.flg_status != 'C' --not canceled visit
                           AND v.id_institution = i_prof.institution
                           AND uc.id_state IN (SELECT v_csts.column_value
                                                 FROM TABLE(l_grid_states_car) v_csts)
                           AND drd.id_state IN (SELECT v_sts.column_value
                                                  FROM TABLE(l_grid_states_validated) v_sts)
                              --filter orders by id_dep_clin_server (pharmacist allocation to departments/services)
                           AND (l_dcs_count = 0 OR
                               ucm.id_dep_clin_serv IN (SELECT v_css.column_value
                                                           FROM TABLE(l_dep_clin_servs) v_css))
                              --
                           AND get_grid_timeout(drd.id_state, i_prof, 'D') >
                               pk_date_utils.get_timestamp_diff(current_timestamp, drdst.dt_state)
                         GROUP BY drd.id_drug,
                                  drd.vers,
                                  drd.id_other_product,
                                  drd.id_unit_measure_prep,
                                  drd.id_state,
                                  cs.code_clinical_service,
                                  ucm.car_model_name) v2
                 ORDER BY pharm;
        
        ELSIF (i_flg_filter = 'MED_NOT_VAL')
        THEN
        
            g_error := 'GET CURSOR (UNIDOSE MEDS/SERVICES) - NOT VALIDATED';
            OPEN o_req FOR
                SELECT v2.id_drug_req_det,
                       v2.id_drug,
                       v2.vers,
                       v2.id_other_product,
                       --
                       get_medication_name(i_lang,
                                           i_prof,
                                           v2.id_drug,
                                           v2.vers,
                                           g_flg_unidose,
                                           v2.id_drug_presc_det,
                                           g_yes,
                                           v2.id_other_product) pharm,
                       --
                       pk_translation.get_translation(i_lang, v2.code_clinical_service) clinical_service,
                       v2.car_model_name car_name,
                       v2.id_unidose_car,
                       --
                       v2.qt_to_prep || ' ' ||
                       pk_medication_core.get_unit_translation(i_lang, i_prof, v2.id_unit_measure_prep, 3) desc_qty_to_prep,
                       --
                       NULL desc_qty_prep,
                       --
                       get_status_pipe_str(i_lang, i_prof, v2.id_state, i_prof_cat_type, v2.dt_state, '', '', g_yes) status,
                       v2.id_state
                  FROM (SELECT pharmacy_tbl_num(drd.id_drug_req_det) id_drug_req_det,
                               drd.id_drug,
                               drd.vers,
                               drd.id_other_product,
                               SUM(nvl(drd.qty_to_prep, 0)) qt_to_prep,
                               drd.id_unit_measure_prep,
                               drd.id_state,
                               pharmacy_top_one_num(dr.id_drug_presc_det) id_drug_presc_det, --top 1 (first presc from N drug_reqs.. it is just to get the medication name.. so, only the first one is needed)
                               MIN(drdst.dt_state) dt_state, --min date (most delayed)
                               cs.code_clinical_service,
                               ucm.car_model_name,
                               pharmacy_tbl_num(uc.id_unidose_car) id_unidose_car
                          FROM drug_req_det drd
                         INNER JOIN drug_req dr
                            ON (drd.id_drug_req = dr.id_drug_req)
                         INNER JOIN drug_req_det_state_transition drdst
                            ON (drd.id_drug_req_det = drdst.id_drug_req_det AND drd.id_state = drdst.id_state)
                         INNER JOIN episode e
                            ON (dr.id_episode = e.id_episode)
                         INNER JOIN visit v
                            ON (e.id_visit = v.id_visit)
                         INNER JOIN (
                                    --orders allocated to slots of the car
                                    SELECT ucs.id_unidose_car, usc.id_drug_req_det
                                      FROM pharm_unidose_car_slot ucs
                                     INNER JOIN pharm_unidose_slot_content usc
                                        ON (ucs.id_unidose_car = usc.id_unidose_car AND ucs.slot_number = usc.slot_number)
                                    UNION ALL
                                    --orders allocated to car, but not to slots
                                    SELECT ucc.id_unidose_car, ucc.id_drug_req_det
                                      FROM pharm_unidose_car_content ucc) v1
                            ON (drd.id_drug_req_det = v1.id_drug_req_det)
                         INNER JOIN pharm_unidose_car uc
                            ON (v1.id_unidose_car = uc.id_unidose_car)
                         INNER JOIN pharm_unidose_car_model ucm
                            ON (uc.id_car_model = ucm.id_unidose_car_model)
                         INNER JOIN dep_clin_serv dcs
                            ON (ucm.id_dep_clin_serv = dcs.id_dep_clin_serv AND
                               (i_service IS NULL OR dcs.id_department = i_service))
                         INNER JOIN clinical_service cs
                            ON (dcs.id_clinical_service = cs.id_clinical_service)
                         WHERE dr.flg_type = g_flg_unidose
                           AND e.flg_status = 'A' --active episode
                           AND v.flg_status != 'C' --not canceled visit
                           AND v.id_institution = i_prof.institution
                           AND uc.id_state IN (SELECT v_csts.column_value
                                                 FROM TABLE(l_grid_states_car) v_csts)
                           AND drd.id_state = l_grid_state_not_validated
                              --filter orders by id_dep_clin_server (pharmacist allocation to departments/services)
                           AND (l_dcs_count = 0 OR
                               ucm.id_dep_clin_serv IN (SELECT v_css.column_value
                                                           FROM TABLE(l_dep_clin_servs) v_css))
                              --
                           AND get_grid_timeout(drd.id_state, i_prof, 'D') >
                               pk_date_utils.get_timestamp_diff(current_timestamp, drdst.dt_state)
                         GROUP BY drd.id_drug,
                                  drd.vers,
                                  drd.id_other_product,
                                  drd.id_unit_measure_prep,
                                  drd.id_state,
                                  cs.code_clinical_service,
                                  ucm.car_model_name) v2
                 ORDER BY pharm;
        
        ELSIF (i_flg_filter = 'MED_PREP')
        THEN
        
            g_error := 'GET CURSOR (UNIDOSE MEDS/SERVICES) - PREPARED';
            OPEN o_req FOR
                SELECT v2.id_drug_req_det,
                       v2.id_drug,
                       v2.vers,
                       v2.id_other_product,
                       --
                       get_medication_name(i_lang,
                                           i_prof,
                                           v2.id_drug,
                                           v2.vers,
                                           g_flg_unidose,
                                           v2.id_drug_presc_det,
                                           g_yes,
                                           v2.id_other_product) pharm,
                       --
                       pk_translation.get_translation(i_lang, v2.code_clinical_service) clinical_service,
                       v2.car_model_name car_name,
                       v2.id_unidose_car,
                       --
                       v2.qt_to_prep || ' ' ||
                       pk_medication_core.get_unit_translation(i_lang, i_prof, v2.id_unit_measure_prep, 3) desc_qty_to_prep,
                       --
                       v2.qt_prepared || ' ' ||
                       pk_medication_core.get_unit_translation(i_lang, i_prof, v2.id_unit_measure_prep, 3) desc_qty_prep,
                       --
                       get_status_pipe_str(i_lang, i_prof, v2.id_state, i_prof_cat_type, v2.dt_state, '', '', g_yes) status,
                       v2.id_state
                  FROM (SELECT pharmacy_tbl_num(drd.id_drug_req_det) id_drug_req_det,
                               drd.id_drug,
                               drd.vers,
                               drd.id_other_product,
                               SUM(nvl(drd.qty_to_prep, 0)) qt_to_prep,
                               drd.id_unit_measure_prep,
                               SUM(drs.qty_supply) qt_prepared,
                               pharmacy_top_one_num(drs.id_state) id_state,
                               pharmacy_top_one_num(dr.id_drug_presc_det) id_drug_presc_det, --top 1 (first presc from N drug_reqs.. it is just to get the medication name.. so, only the first one is needed)
                               MIN(drdst.dt_state) dt_state, --min date (most delayed)
                               cs.code_clinical_service,
                               ucm.car_model_name,
                               pharmacy_tbl_num(uc.id_unidose_car) id_unidose_car
                          FROM drug_req_det drd
                         INNER JOIN drug_req dr
                            ON (drd.id_drug_req = dr.id_drug_req)
                         INNER JOIN drug_req_det_state_transition drdst
                            ON (drd.id_drug_req_det = drdst.id_drug_req_det AND drd.id_state = drdst.id_state)
                         INNER JOIN drug_req_supply drs
                            ON (drd.id_drug_req_det = drs.id_drug_req_det)
                         INNER JOIN episode e
                            ON (dr.id_episode = e.id_episode)
                         INNER JOIN visit v
                            ON (e.id_visit = v.id_visit)
                         INNER JOIN (
                                    --orders allocated to slots of the car
                                    SELECT ucs.id_unidose_car, usc.id_drug_req_det
                                      FROM pharm_unidose_car_slot ucs
                                     INNER JOIN pharm_unidose_slot_content usc
                                        ON (ucs.id_unidose_car = usc.id_unidose_car AND ucs.slot_number = usc.slot_number)
                                    UNION ALL
                                    --orders allocated to car, but not to slots
                                    SELECT ucc.id_unidose_car, ucc.id_drug_req_det
                                      FROM pharm_unidose_car_content ucc) v1
                            ON (drd.id_drug_req_det = v1.id_drug_req_det)
                         INNER JOIN pharm_unidose_car uc
                            ON (v1.id_unidose_car = uc.id_unidose_car)
                         INNER JOIN pharm_unidose_car_model ucm
                            ON (uc.id_car_model = ucm.id_unidose_car_model)
                         INNER JOIN dep_clin_serv dcs
                            ON (ucm.id_dep_clin_serv = dcs.id_dep_clin_serv AND
                               (i_service IS NULL OR dcs.id_department = i_service))
                         INNER JOIN clinical_service cs
                            ON (dcs.id_clinical_service = cs.id_clinical_service)
                         WHERE dr.flg_type = g_flg_unidose
                           AND e.flg_status = 'A' --active episode
                           AND v.flg_status != 'C' --not canceled visit
                           AND v.id_institution = i_prof.institution
                           AND uc.id_state IN (SELECT v_csts.column_value
                                                 FROM TABLE(l_grid_states_car) v_csts)
                           AND drs.id_state = l_grid_state_prepared
                              --filter orders by id_dep_clin_server (pharmacist allocation to departments/services)
                           AND (l_dcs_count = 0 OR
                               ucm.id_dep_clin_serv IN (SELECT v_css.column_value
                                                           FROM TABLE(l_dep_clin_servs) v_css))
                              --
                           AND get_grid_timeout(drd.id_state, i_prof, 'D') >
                               pk_date_utils.get_timestamp_diff(current_timestamp, drdst.dt_state)
                         GROUP BY drd.id_drug,
                                  drd.vers,
                                  drd.id_other_product,
                                  drd.id_unit_measure_prep,
                                  drd.id_state,
                                  cs.code_clinical_service,
                                  ucm.car_model_name) v2
                 ORDER BY pharm;
        
        ELSE
            raise_application_error(-20001,
                                    'invalid filter: ' || i_flg_filter ||
                                    ' -- filter options: MED_VAL | MED_NOT_VAL | MED_PREP');
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, o_error);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_visions);
            pk_types.open_my_cursor(o_req);
            pk_types.open_my_cursor(o_actions);
            RETURN FALSE;
    END pharmacist_uni_med_serv_grid;

    /********************************************************************************************
    * alert.pk_pharmacy.get_uni_med_prep_grid  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_GET_HEADERS                   IN        VARCHAR2
    * @param  I_HEADER_CODES                  IN        ALERT.TABLE_VARCHAR
    * @param  I_DRDS                          IN        ALERT.TABLE_NUMBER
    * @param  O_REQ                           OUT       REF CURSOR
    * @param  O_HEADERS                       OUT       REF CURSOR
    * @param  O_UNITS                         OUT       REF CURSOR
    * @param  O_ERROR                         OUT       ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.8
    * @since  2010-07-08
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_uni_med_prep_grid
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN alert.profissional,
        i_get_headers  IN VARCHAR2 DEFAULT 'N',
        i_header_codes IN table_varchar DEFAULT NULL,
        i_drds         IN table_number,
        o_req          OUT pk_types.cursor_type,
        o_headers      OUT pk_types.cursor_type,
        o_units        OUT pk_types.cursor_type,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'get_uni_med_prep_grid';
        l_dummy      BOOLEAN := FALSE;
        l_datetime   TIMESTAMP WITH LOCAL TIME ZONE;
        l_bed_label  sys_message.desc_message%TYPE;
        l_slot_label sys_message.desc_message%TYPE;
    BEGIN
        l_datetime := current_timestamp;
    
        g_error := 'GET DISPENSE UNITS';
        l_dummy := get_dispense_units(i_lang, i_prof, o_units, o_error);
    
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        l_bed_label  := pk_message.get_message(i_lang => i_lang, i_code_mess => 'PHARMACIST_DETAIL_PAT_BED');
        l_slot_label := pk_message.get_message(i_lang => i_lang, i_code_mess => 'PHARMACIST_UNIDOSE_DRAWER');
    
        g_error := 'GET MEDS';
        OPEN o_req FOR
            SELECT /*+ opt_estimate(table, v_drds, scale_rows=0.00000001) */ /* -GET_UNI_MED_PREP_GRID- */
             drd.id_drug_req_det,
             --
             get_medication_name(i_lang,
                                 i_prof,
                                 drd.id_drug,
                                 drd.vers,
                                 g_flg_unidose,
                                 dr.id_drug_presc_det,
                                 g_yes,
                                 drd.id_other_product) pharm,
             --
             get_pat_name(i_lang, i_prof, dr.id_patient) pat_name,
             get_pat_clin_record(i_lang, dr.id_patient, i_prof.institution) pat_clinical_process,
             --
             pk_translation.get_translation(i_lang, cs.code_clinical_service) clinical_service,
             get_pat_location(i_lang, i_prof, dr.id_episode, dr.id_patient, 'TEXT', 'BED', l_bed_label) pat_bed,
             --
             ucm.car_model_name,
             decode(v1.slot_number, NULL, '', l_slot_label || ' ' || v1.slot_number) slot_number,
             --
             get_qty_pending(i_prof, table_number(drd.id_drug_req_det), g_no, g_no, l_datetime) qty_to_prep,
             drd.id_unit_measure_prep,
             pk_medication_core.get_unit_translation(i_lang, i_prof, drd.id_unit_measure_prep, 3) desc_unit_to_prep
              FROM drug_req_det drd
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             INNER JOIN (
                         --orders allocated to slots of the car
                         SELECT ucs.id_unidose_car, usc.slot_number, usc.id_drug_req_det
                           FROM pharm_unidose_car_slot ucs
                          INNER JOIN pharm_unidose_slot_content usc
                             ON (ucs.id_unidose_car = usc.id_unidose_car AND ucs.slot_number = usc.slot_number)
                         UNION ALL
                         --orders allocated to car, but not to slots
                         SELECT ucc.id_unidose_car, NULL slot_number, ucc.id_drug_req_det
                           FROM pharm_unidose_car_content ucc) v1
                ON (drd.id_drug_req_det = v1.id_drug_req_det)
             INNER JOIN pharm_unidose_car uc
                ON (v1.id_unidose_car = uc.id_unidose_car)
             INNER JOIN pharm_unidose_car_model ucm
                ON (uc.id_car_model = ucm.id_unidose_car_model)
             INNER JOIN dep_clin_serv dcs
                ON (ucm.id_dep_clin_serv = dcs.id_dep_clin_serv)
             INNER JOIN clinical_service cs
                ON (dcs.id_clinical_service = cs.id_clinical_service)
             WHERE drd.id_drug_req_det IN (SELECT v_drds.column_value
                                             FROM TABLE(i_drds) v_drds)
             ORDER BY pharm;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, o_error);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_req);
            RETURN FALSE;
    END get_uni_med_prep_grid;

    /********************************************************************************************
    * alert.pk_pharmacy.pharmacist_uni_car_grid
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_PROF_CAT_TYPE                 IN    VARCHAR2
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  I_GET_VISIONS                   IN    VARCHAR2
    * @param  I_GET_ACTIONS                   IN    VARCHAR2
    * @param  I_SERVICE                       IN    NUMBER(12)
    * @param  O_REQ                           OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_VISIONS                       OUT   REF CURSOR
    * @param  O_ACTIONS                       OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.2
    * @since  2009-11-17
    *
    ********************************************************************************************/
    FUNCTION pharmacist_uni_car_grid
    (
        i_lang          IN language.id_language%TYPE,
        i_prof          IN alert.profissional,
        i_prof_cat_type IN category.flg_type%TYPE,
        i_get_headers   IN VARCHAR2 DEFAULT 'N',
        i_header_codes  IN table_varchar DEFAULT NULL,
        i_get_visions   IN VARCHAR2 DEFAULT 'N',
        i_get_actions   IN VARCHAR2 DEFAULT 'N',
        i_service       IN clinical_service.id_clinical_service%TYPE DEFAULT NULL,
        o_req           OUT pk_types.cursor_type,
        o_headers       OUT pk_types.cursor_type,
        o_visions       OUT pk_types.cursor_type,
        o_actions       OUT pk_types.cursor_type,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
        l_shortcut       sys_shortcut.id_sys_shortcut%TYPE;
        l_dep_clin_servs table_number;
        l_dcs_count      NUMBER := 0;
        l_car_date_msg   sys_message.desc_message%TYPE;
    BEGIN
        g_error    := 'GET SHORTCUT';
        l_shortcut := get_shortcut(i_lang, i_prof, 'PHARMACIST_UNIDOSE');
    
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error := 'GET VISIONS';
        get_pharmacy_unidose_visions(i_lang, i_prof, i_get_visions, o_visions);
    
        g_error := 'GET ACTIONS';
        get_pharmacy_actions(i_lang, i_prof, i_get_actions, get_grid_actions(g_flg_uni_car), o_actions);
    
        g_error := 'GET GET_ALLOCATION_FOR_PROF';
        get_allocation_for_prof(i_prof, l_dep_clin_servs);
        l_dcs_count := l_dep_clin_servs.count;
    
        l_car_date_msg := ' ' || pk_message.get_message(i_lang, 'PHARMACIST_UNIDOSE_CAR_DATE_INTERVAL') || ' ';
    
        g_error := 'GET CURSOR (UNIDOSE CARS)';
        OPEN o_req FOR
            SELECT v1.id_unidose_car,
                   v1.car_model_name || '<br/>' || pk_date_utils.dt_chr(i_lang, v1.dt_car_begin, i_prof) ||
                   decode(v1.dt_car_end,
                          NULL,
                          '',
                          l_car_date_msg || pk_date_utils.dt_chr(i_lang, v1.dt_car_end, i_prof)) car_model_name,
                   '<b>' || pk_translation.get_translation(i_lang, v1.code_department) || '</b><br/>' ||
                   pk_translation.get_translation(i_lang, v1.code_clinical_service) dept_serv,
                   v1.number_of_slots,
                   get_alloc_count_pats2car(v1.id_unidose_car) patient_count,
                   get_unidose_car_location(i_lang,
                                            i_prof,
                                            v1.id_state,
                                            pk_translation.get_translation(i_lang, v1.code_department)) car_location,
                   v1.id_state,
                   get_status_pipe_str(i_lang, i_prof, v1.id_state, i_prof_cat_type, v1.dt_state, l_shortcut, '', g_yes) status
              FROM (SELECT uc.id_unidose_car,
                           uc.dt_car_begin,
                           uc.dt_car_end,
                           uc.id_state,
                           ucst.dt_state,
                           ucm.car_model_name,
                           ucm.number_of_slots,
                           cs.code_clinical_service,
                           d.code_department
                      FROM pharm_unidose_car uc
                     INNER JOIN pharm_unidose_car_state_trans ucst
                        ON (uc.id_unidose_car = ucst.id_unidose_car AND uc.id_state = ucst.id_state)
                     INNER JOIN pharm_unidose_car_model ucm
                        ON (uc.id_car_model = ucm.id_unidose_car_model)
                     INNER JOIN dep_clin_serv dcs
                        ON (ucm.id_dep_clin_serv = dcs.id_dep_clin_serv)
                     INNER JOIN clinical_service cs
                        ON (dcs.id_clinical_service = cs.id_clinical_service)
                     INNER JOIN department d
                        ON (dcs.id_department = d.id_department AND (i_service IS NULL OR d.id_department = i_service))
                     WHERE ucm.flg_active = g_yes
                       AND get_grid_timeout(uc.id_state, i_prof, 'D') >
                           pk_date_utils.get_timestamp_diff(current_timestamp, ucst.dt_state)
                       AND d.id_institution = i_prof.institution
                          --filter orders by id_dep_clin_server (pharmacist allocation to departments/services)
                       AND (l_dcs_count = 0 OR
                           ucm.id_dep_clin_serv IN (SELECT column_value
                                                       FROM TABLE(l_dep_clin_servs)))
                    --
                    ) v1
              LEFT JOIN wfl_state_detail sd
                ON (v1.id_state = sd.state AND i_prof_cat_type = sd.prof_type)
             ORDER BY sd.rank, v1.dt_car_begin, v1.car_model_name;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'pharmacist_uni_car_grid', o_error);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_req);
            pk_types.open_my_cursor(o_visions);
            pk_types.open_my_cursor(o_actions);
            RETURN FALSE;
    END pharmacist_uni_car_grid;

    /********************************************************************************************
    * alert.pk_pharmacy.get_alloc_count_pats2car  
    *
    * @param  I_ID_UNIDOSE_CAR                IN        NUMBER(24)
    *
    * @return NUMBER
    *
    * @author Rui Marante
    * @version  2.5.0.7.8
    * @since  2010-06-25
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_alloc_count_pats2car(i_id_unidose_car IN pharm_unidose_car.id_unidose_car%TYPE) RETURN NUMBER IS
        l_count NUMBER := 0;
    BEGIN
        SELECT COUNT(*)
          INTO l_count
          FROM (SELECT DISTINCT dr.id_patient
                  FROM pharm_unidose_car_content ucc
                 INNER JOIN drug_req_det drd
                    ON (ucc.id_drug_req_det = drd.id_drug_req_det)
                 INNER JOIN drug_req dr
                    ON (drd.id_drug_req = dr.id_drug_req)
                 WHERE ucc.id_unidose_car = i_id_unidose_car
                UNION
                SELECT DISTINCT dr.id_patient
                  FROM pharm_unidose_slot_content usc
                 INNER JOIN drug_req_det drd
                    ON (usc.id_drug_req_det = drd.id_drug_req_det)
                 INNER JOIN drug_req dr
                    ON (drd.id_drug_req = dr.id_drug_req)
                 WHERE usc.id_unidose_car = i_id_unidose_car) v1;
    
        RETURN l_count;
    
    EXCEPTION
        WHEN OTHERS THEN
            set_pharmacy_log('get_alloc_count_pats2car', 'err=' || SQLERRM);
            RAISE;
    END get_alloc_count_pats2car;

    /********************************************************************************************
    * alert.pk_pharmacy.get_unidose_car_location
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_UNIDOSE_CAR_STATE             IN    NUMBER(5)
    * @param  I_SERVICE_NAME                  IN    VARCHAR2
    *
    * @return VARCHAR2
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-08-26
    *
    ********************************************************************************************/
    FUNCTION get_unidose_car_location
    (
        i_lang              IN language.id_language%TYPE,
        i_prof              IN alert.profissional,
        i_unidose_car_state IN pharm_unidose_car.id_state%TYPE,
        i_service_name      IN VARCHAR2
    ) RETURN VARCHAR2 DETERMINISTIC IS
        l_car_location VARCHAR2(200 CHAR) := '';
    BEGIN
        l_car_location := CASE
                              WHEN in_table(i_unidose_car_state,
                                            get_states_for_req_type(i_prof,
                                                                    NULL,
                                                                    table_varchar(g_uni_car_parked_st,
                                                                                  g_uni_car_executing_st,
                                                                                  g_uni_car_ready4transp_st,
                                                                                  g_uni_car_delivered_dev_st,
                                                                                  g_uni_car_end_st))) = TRUE THEN
                               pk_translation.get_translation(i_lang, 'PHARMACY_NAME_001')
                              WHEN in_table(i_unidose_car_state,
                                            get_states_for_req_type(i_prof,
                                                                    NULL,
                                                                    table_varchar(g_uni_car_delivered_st,
                                                                                  g_uni_car_on_prep2dev_st,
                                                                                  g_uni_car_ready4transp_dev_st))) = TRUE THEN
                               i_service_name
                              ELSE
                               pk_translation.get_translation(i_lang, 'PHARMACIST_UNIDOSE_CAR_IN_TRANSP')
                          END;
    
        RETURN l_car_location;
    
    EXCEPTION
        WHEN OTHERS THEN
            RETURN ''; --not really important (car location)
    END get_unidose_car_location;

    /********************************************************************************************
    * alert.pk_pharmacy.get_uni_pats_not_allocated
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_CAR                        IN    NUMBER(24)
    * @param  I_FLG_GRID                      IN    VARCHAR2
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  O_PATIENTS                      OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-08-26
    *
    ********************************************************************************************/
    FUNCTION get_uni_pats_not_allocated
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN alert.profissional,
        i_id_car       IN pharm_unidose_car.id_unidose_car%TYPE,
        i_flg_grid     IN VARCHAR2 DEFAULT 'PNA', -- PNA | PAOC | ALL
        i_get_headers  IN VARCHAR2 DEFAULT 'N',
        i_header_codes IN table_varchar DEFAULT NULL,
        o_patients     OUT pk_types.cursor_type,
        o_headers      OUT pk_types.cursor_type,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
        l_car_dt_begin pharm_unidose_car.dt_car_begin%TYPE;
        l_car_dt_end   pharm_unidose_car.dt_car_end%TYPE;
        l_car_dep_cs   pharm_unidose_car_model.id_dep_clin_serv%TYPE;
    BEGIN
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        SELECT uc.dt_car_begin, nvl(uc.dt_car_end, uc.dt_car_begin), ucm.id_dep_clin_serv
          INTO l_car_dt_begin, l_car_dt_end, l_car_dep_cs
          FROM pharm_unidose_car uc, pharm_unidose_car_model ucm
         WHERE uc.id_unidose_car = i_id_car
           AND uc.id_car_model = ucm.id_unidose_car_model;
    
        IF (i_flg_grid = 'PNA')
        THEN
            --patients not allocated to any unitdose cars
            g_error := 'GET CURSOR PNA';
            OPEN o_patients FOR
                SELECT drd.id_drug_req_det,
                       dr.id_patient,
                       get_pat_name(i_lang, i_prof, dr.id_patient) || ' (' ||
                       get_pat_location(i_lang, i_prof, dr.id_episode, dr.id_patient, 'TEXT', 'BED') || ')' pat_name_bed,
                       i_id_car id_unidose_car,
                       to_char(dr.dt_drug_req_tstz, 'YYYYMMDDHH24MISS') req_date,
                       get_medication_name(i_lang,
                                           i_prof,
                                           drd.id_drug,
                                           drd.vers,
                                           dr.flg_type,
                                           dpd.id_drug_presc_det,
                                           g_yes,
                                           drd.id_other_product) pharm,
                       drd.qty_to_prep || ' ' ||
                       pk_medication_core.get_unit_translation(i_lang, i_prof, drd.id_unit_measure_prep, 3) qty_to_prep_desc
                  FROM drug_req_det drd, drug_req dr, episode e, dep_clin_serv dcs, drug_presc_det dpd
                 WHERE drd.id_drug_req = dr.id_drug_req
                   AND dr.id_drug_presc_det = dpd.id_drug_presc_det
                   AND dr.id_episode = e.id_episode
                   AND e.id_department = dcs.id_department
                   AND e.flg_status = 'A'
                   AND dcs.flg_available = g_yes
                   AND dcs.id_dep_clin_serv = l_car_dep_cs
                   AND dr.flg_type = g_flg_unidose
                   AND to_date(to_char(dr.dt_drug_req_tstz, 'YYYYMMDDHH24MI'), 'YYYYMMDDHH24MI') BETWEEN
                       to_date(to_char(l_car_dt_begin, 'YYYYMMDDHH24MI'), 'YYYYMMDDHH24MI') AND
                       to_date(to_char(l_car_dt_end, 'YYYYMMDDHH24MI'), 'YYYYMMDDHH24MI')
                   AND drd.id_state IN
                       (SELECT column_value
                          FROM TABLE(get_states_for_req_type(i_prof,
                                                             g_flg_unidose,
                                                             table_varchar(g_drd_requested_st,
                                                                           g_drd_executing_st,
                                                                           g_drd_validated_st,
                                                                           g_drd_waiting_approv_st,
                                                                           g_drd_validated_sign_st))))
                   AND NOT EXISTS (
                        --allocation to slots
                        SELECT 1
                          FROM pharm_unidose_slot_content usc
                         WHERE usc.id_drug_req_det = drd.id_drug_req_det
                           AND rownum = 1)
                   AND NOT EXISTS (
                        --allocation to car
                        SELECT 1
                          FROM pharm_unidose_car_content ucc
                         WHERE ucc.id_drug_req_det = drd.id_drug_req_det
                           AND rownum = 1)
                   AND e.id_institution = i_prof.institution
                 ORDER BY dr.dt_drug_req_tstz, pat_name_bed;
        
        ELSIF (i_flg_grid = 'PAOC')
        THEN
            --patients allocated to others cars
            g_error := 'GET CURSOR PAOC';
            OPEN o_patients FOR
                SELECT drd.id_drug_req_det,
                       dr.id_patient,
                       get_pat_name(i_lang, i_prof, dr.id_patient) || ' (' ||
                       get_pat_location(i_lang, i_prof, dr.id_episode, dr.id_patient, 'TEXT', 'BED') || ')' pat_name_bed,
                       i_id_car id_unidose_car,
                       to_char(dr.dt_drug_req_tstz, 'YYYYMMDDHH24MISS') req_date, --pk_date_utils.date_send_tsz(i_lang, dr.dt_drug_req_tstz, i_prof) req_date
                       get_medication_name(i_lang,
                                           i_prof,
                                           drd.id_drug,
                                           drd.vers,
                                           dr.flg_type,
                                           dpd.id_drug_presc_det,
                                           g_yes,
                                           drd.id_other_product) pharm,
                       drd.qty_to_prep || ' ' ||
                       pk_medication_core.get_unit_translation(i_lang, i_prof, drd.id_unit_measure_prep, 3) qty_to_prep_desc
                  FROM drug_req_det drd, drug_req dr, episode e, dep_clin_serv dcs, drug_presc_det dpd
                 WHERE drd.id_drug_req = dr.id_drug_req
                   AND dr.id_drug_presc_det = dpd.id_drug_presc_det
                   AND dr.id_episode = e.id_episode
                   AND e.id_department = dcs.id_department
                   AND e.flg_status = 'A'
                   AND dcs.flg_available = g_yes
                   AND dcs.id_dep_clin_serv = l_car_dep_cs
                   AND dr.flg_type = g_flg_unidose
                   AND to_date(to_char(dr.dt_drug_req_tstz, 'YYYYMMDDHH24MI'), 'YYYYMMDDHH24MI') BETWEEN
                       to_date(to_char(l_car_dt_begin, 'YYYYMMDDHH24MI'), 'YYYYMMDDHH24MI') AND
                       to_date(to_char(l_car_dt_end, 'YYYYMMDDHH24MI'), 'YYYYMMDDHH24MI')
                   AND drd.id_state IN
                       (SELECT column_value
                          FROM TABLE(get_states_for_req_type(i_prof,
                                                             g_flg_unidose,
                                                             table_varchar(g_drd_requested_st,
                                                                           g_drd_executing_st,
                                                                           g_drd_validated_st,
                                                                           g_drd_waiting_approv_st,
                                                                           g_drd_validated_sign_st))))
                   AND (EXISTS (
                                --allocation to slots
                                SELECT 1
                                  FROM pharm_unidose_slot_content usc
                                 WHERE usc.id_drug_req_det = drd.id_drug_req_det
                                   AND usc.id_unidose_car != i_id_car
                                   AND rownum = 1) OR EXISTS (
                                                              --allocation to car
                                                              SELECT 1
                                                                FROM pharm_unidose_car_content ucc
                                                               WHERE ucc.id_drug_req_det = drd.id_drug_req_det
                                                                 AND ucc.id_unidose_car != i_id_car
                                                                 AND rownum = 1))
                   AND e.id_institution = i_prof.institution
                 ORDER BY dr.dt_drug_req_tstz, pat_name_bed;
        
        ELSE
            --ALL = PNA + PAOC
            g_error := 'GET CURSOR ALL (PNA + PAOC)';
            OPEN o_patients FOR
                SELECT drd.id_drug_req_det,
                       dr.id_patient,
                       get_pat_name(i_lang, i_prof, dr.id_patient) || ' (' ||
                       get_pat_location(i_lang, i_prof, dr.id_episode, dr.id_patient, 'TEXT', 'BED') || ')' pat_name_bed,
                       i_id_car id_unidose_car,
                       to_char(dr.dt_drug_req_tstz, 'YYYYMMDDHH24MISS') req_date, --pk_date_utils.date_send_tsz(i_lang, dr.dt_drug_req_tstz, i_prof) req_date
                       get_medication_name(i_lang,
                                           i_prof,
                                           drd.id_drug,
                                           drd.vers,
                                           dr.flg_type,
                                           dpd.id_drug_presc_det,
                                           g_yes,
                                           drd.id_other_product) pharm,
                       drd.qty_to_prep || ' ' ||
                       pk_medication_core.get_unit_translation(i_lang, i_prof, drd.id_unit_measure_prep, 3) qty_to_prep_desc
                  FROM drug_req_det drd, drug_req dr, episode e, dep_clin_serv dcs, drug_presc_det dpd
                 WHERE drd.id_drug_req = dr.id_drug_req
                   AND dr.id_drug_presc_det = dpd.id_drug_presc_det
                   AND dr.id_episode = e.id_episode
                   AND e.id_department = dcs.id_department
                   AND e.flg_status = 'A'
                   AND dcs.flg_available = g_yes
                   AND dcs.id_dep_clin_serv = l_car_dep_cs
                   AND dr.flg_type = g_flg_unidose
                   AND to_date(to_char(dr.dt_drug_req_tstz, 'YYYYMMDDHH24MI'), 'YYYYMMDDHH24MI') BETWEEN
                       to_date(to_char(l_car_dt_begin, 'YYYYMMDDHH24MI'), 'YYYYMMDDHH24MI') AND
                       to_date(to_char(l_car_dt_end, 'YYYYMMDDHH24MI'), 'YYYYMMDDHH24MI')
                   AND drd.id_state IN
                       (SELECT column_value
                          FROM TABLE(get_states_for_req_type(i_prof,
                                                             g_flg_unidose,
                                                             table_varchar(g_drd_requested_st,
                                                                           g_drd_executing_st,
                                                                           g_drd_validated_st,
                                                                           g_drd_waiting_approv_st,
                                                                           g_drd_validated_sign_st))))
                   AND NOT EXISTS (
                        --allocation to slots
                        SELECT 1
                          FROM pharm_unidose_slot_content usc
                         WHERE usc.id_drug_req_det = drd.id_drug_req_det
                           AND usc.id_unidose_car = i_id_car
                           AND rownum = 1)
                   AND NOT EXISTS (
                        --allocation to car
                        SELECT 1
                          FROM pharm_unidose_car_content ucc
                         WHERE ucc.id_drug_req_det = drd.id_drug_req_det
                           AND ucc.id_unidose_car = i_id_car
                           AND rownum = 1)
                   AND e.id_institution = i_prof.institution
                 ORDER BY dr.dt_drug_req_tstz, pat_name_bed;
        
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'get_uni_pats_not_allocated', o_error);
            pk_types.open_my_cursor(o_patients);
            pk_types.open_my_cursor(o_headers);
            RETURN FALSE;
    END get_uni_pats_not_allocated;

    /********************************************************************************************
    * alert.pk_pharmacy.set_car_ready_to_go
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_UNIDOSE_CAR                IN    NUMBER(24)
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-08-25
    *
    ********************************************************************************************/
    --NOT IN USE!! 2009-11-04 RM
    --IMPORTANTE NOTE: 2009-11-04 RM
    -- This is commented because this can no longer be done! Now, the car can be full but still carrie "things" outside the slots!
    -- So, I cannot set the car ready to go automatically!
    /*procedure set_car_ready_to_go
    (
      i_lang        in  language.id_language%type,
      i_prof        in  alert.profissional,
      i_id_unidose_car  in  pharm_unidose_car.id_unidose_car%type
    )
    is
      l_count_free_slots      number(1) := 0;
      l_count_reqs_not_ready    number(1) := 0;
    begin
      --[MEDICATION_RULE] (10-09-2009) verify if car is full and all orders are fulfilled! if so, automatically change the status of the car (OK to go)
      select count(1)
      into l_count_free_slots
      from pharm_unidose_car_slot ucs
      where ucs.id_unidose_car = i_id_unidose_car
        and ucs.id_patient is null
        and rownum = 1;
    
      if (l_count_free_slots = 0) then
        --[MEDICATION_RULE] (10-09-2009) car full, so check if every req is ready!
        select count(1)
        into l_count_reqs_not_ready
        from pharm_unidose_slot_content usc, drug_req_det drd
        where usc.id_unidose_car = i_id_unidose_car
          and usc.id_drug_req_det = drd.id_drug_req_det
          and drd.id_state != get_state_for_req_type(i_prof, null, g_drs_readyfortransp_st)
          and rownum = 1;
    
        if (l_count_reqs_not_ready = 0) then
          --[MEDICATION_RULE] (10-09-2009) every req is ready! set car state to OK!
          update pharm_unidose_car uc
          set uc.id_state = get_state_for_req_type(i_prof, null, g_uni_car_ready4transp_st)
          where uc.id_unidose_car = i_id_unidose_car;
    
          insert into pharm_unidose_car_state_trans (id_unidose_car, id_state, id_prof, dt_state)
          values (i_id_unidose_car, get_state_for_req_type(i_prof, null, g_uni_car_ready4transp_st), i_prof.id, current_timestamp);
        end if;
      end if;
    
    exception
    when others then
      raise;
    end set_car_ready_to_go;*/

    /********************************************************************************************
    * alert.pk_pharmacy.set_uni_alloc_pat2car
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_UNIDOSE_CAR                IN    NUMBER(24)
    * @param  I_ID_PATIENT                    IN    ALERT.TABLE_NUMBER
    * @param  I_ID_DRUG_REQ_DET               IN    ALERT.TABLE_NUMBER
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-08-25
    *
    ********************************************************************************************/
    FUNCTION set_uni_alloc_pat2car
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN alert.profissional,
        i_id_unidose_car  IN pharm_unidose_car.id_unidose_car%TYPE,
        i_id_patient      IN table_number,
        i_id_drug_req_det IN table_number,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
        l_id_cars      table_number;
        l_id_episode   drug_req.id_episode%TYPE;
        l_id_car_model pharm_unidose_car.id_car_model%TYPE;
        l_dt_car       pharm_unidose_car.dt_car_begin%TYPE;
    BEGIN
        g_error := 'CHECK CAR STATE TRANSITION';
        update_unidose_car_state(i_lang => i_lang, i_prof => i_prof, i_id_unidose_car => i_id_unidose_car);
    
        FOR i IN i_id_drug_req_det.first .. i_id_drug_req_det.last
        LOOP
            -- 1) delete from other car in the pharmacy
            DELETE FROM pharm_unidose_car_content ucc
             WHERE ucc.id_drug_req_det = i_id_drug_req_det(i)
               AND ucc.id_unidose_car != i_id_unidose_car;
        
            DELETE FROM pharm_unidose_slot_content usc
             WHERE usc.id_drug_req_det = i_id_drug_req_det(i)
               AND usc.id_unidose_car != i_id_unidose_car
               AND EXISTS
             (SELECT 1
                      FROM pharm_unidose_car uc
                     WHERE uc.id_unidose_car = usc.id_unidose_car
                       AND uc.id_state IN
                           (SELECT column_value
                              FROM TABLE(get_states_for_req_type(i_prof,
                                                                 NULL,
                                                                 table_varchar(g_uni_car_parked_st, g_uni_car_executing_st)))))
            RETURNING usc.id_unidose_car BULK COLLECT INTO l_id_cars;
        
            -- 2) remove patient_id from slots that he(she) no longer uses
            UPDATE pharm_unidose_car_slot ucs
               SET ucs.id_patient = NULL
             WHERE ucs.id_unidose_car IN (SELECT column_value
                                            FROM TABLE(l_id_cars))
               AND ucs.id_patient = i_id_patient(i)
               AND NOT EXISTS (SELECT 1
                      FROM pharm_unidose_slot_content usc, drug_req_det drd, drug_req dr
                     WHERE usc.id_drug_req_det = drd.id_drug_req_det
                       AND drd.id_drug_req = dr.id_drug_req
                       AND dr.id_patient = i_id_patient(i)
                       AND usc.id_unidose_car IN (SELECT column_value
                                                    FROM TABLE(l_id_cars)));
        
            -- 3) get episode, car_model, dt_req
            SELECT dr.id_episode
              INTO l_id_episode
              FROM drug_req_det drd
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             WHERE drd.id_drug_req_det = i_id_drug_req_det(i);
        
            SELECT uc.id_car_model, uc.dt_car_begin
              INTO l_id_car_model, l_dt_car
              FROM pharm_unidose_car uc
             WHERE uc.id_unidose_car = i_id_unidose_car;
        
            -- 4) order allocation (to slot or to the unit-dose cart)
            set_pat_slot_persistence(i_lang         => i_lang,
                                     i_prof         => i_prof,
                                     i_patient      => i_id_patient(i),
                                     i_car_model    => l_id_car_model,
                                     i_car_id       => i_id_unidose_car,
                                     i_dt_req       => l_dt_car,
                                     i_drug_req_det => i_id_drug_req_det(i),
                                     i_episode      => l_id_episode,
                                     i_flg_use_bed  => g_yes);
        
        END LOOP;
    
        -- 5) verify if car is full and all orders are fulfilled! if so, automatically change the status of the car (OK to go) ;)
        --set_car_ready_to_go(i_lang, i_prof, i_id_unidose_car);
        --IMPORTANTE NOTE: 2009-11-04 RM
        -- This is commented because this can no longer be done! Now, the car can be full but still carrie "things" outside the slots!
        -- So, I cannot set the car ready to go automatically!
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'set_uni_alloc_pat2car', o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_uni_alloc_pat2car;

    /********************************************************************************************
    * alert.pk_pharmacy.get_uni_car_edit
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_CAR                        IN    NUMBER(24)
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  O_CAR                           OUT   REF CURSOR
    * @param  O_CAR_PATIENTS                  OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-07-21
    *
    ********************************************************************************************/
    FUNCTION get_uni_car_edit
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN alert.profissional,
        i_id_car       IN pharm_unidose_car.id_unidose_car%TYPE,
        i_get_headers  IN VARCHAR2 DEFAULT 'N',
        i_header_codes IN table_varchar DEFAULT NULL,
        i_get_options  IN VARCHAR2 DEFAULT 'N',
        o_car          OUT pk_types.cursor_type,
        o_car_patients OUT pk_types.cursor_type,
        o_headers      OUT pk_types.cursor_type,
        o_options      OUT pk_types.cursor_type,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
        l_prof_type profile_template.flg_type%TYPE;
    BEGIN
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error     := 'GET PROF TYPE';
        l_prof_type := get_prof_type(i_prof);
    
        g_error := 'GET OPTIONS';
        IF (i_get_options = g_yes)
        THEN
            OPEN o_options FOR
                SELECT sd.val id_action, sd.desc_val desc_action, NULL icon
                  FROM sys_domain sd
                 WHERE sd.code_domain = 'PHARMACY_UNIDOSE_CAR_PATIENTS'
                   AND sd.id_language = i_lang
                   AND sd.domain_owner = pk_sysdomain.k_default_schema
                 ORDER BY sd.rank;
        ELSE
            pk_types.open_my_cursor(o_options);
        END IF;
    
        g_error := 'GET CURSOR (UNIDOSE CAR)';
        OPEN o_car FOR
            SELECT v1.id_unidose_car,
                   v1.car_model_name,
                   v1.dept,
                   v1.dept_id,
                   v1.serv,
                   v1.id_dep_clin_serv,
                   v1.number_of_slots,
                   (SUM(v1.has_patient) || '/' || v1.number_of_slots) patient_count,
                   v1.car_location,
                   v1.id_state,
                   v1.state_desc,
                   v1.notes
              FROM (SELECT uc.id_unidose_car,
                           ucm.car_model_name || '  (' || pk_date_utils.dt_chr(i_lang, uc.dt_car_begin, i_prof) ||
                           decode(uc.dt_car_end,
                                  NULL,
                                  '',
                                  ' ' || pk_message.get_message(i_lang, 'PHARMACIST_UNIDOSE_CAR_DATE_INTERVAL') || ' ' ||
                                  pk_date_utils.dt_chr(i_lang, uc.dt_car_end, i_prof)) || ')' car_model_name,
                           ucm.number_of_slots,
                           pk_translation.get_translation(i_lang, d.code_department) dept,
                           d.id_department dept_id,
                           pk_translation.get_translation(i_lang, cs.code_clinical_service) serv,
                           ucm.id_dep_clin_serv,
                           nvl(get_unidose_car_location(i_lang,
                                                        i_prof,
                                                        uc.id_state,
                                                        pk_translation.get_translation(i_lang, d.code_department)),
                               '') car_location,
                           uc.id_state,
                           pk_translation.get_translation(i_lang, ws.code_state) state_desc,
                           decode(ucs.id_patient, NULL, 0, 1) has_patient,
                           ucm.notes
                      FROM pharm_unidose_car_slot  ucs,
                           pharm_unidose_car       uc,
                           pharm_unidose_car_model ucm,
                           dep_clin_serv           dcs,
                           clinical_service        cs,
                           department              d,
                           wfl_state               ws
                     WHERE ucs.id_unidose_car = uc.id_unidose_car
                       AND uc.id_car_model = ucm.id_unidose_car_model
                       AND ucm.id_dep_clin_serv = dcs.id_dep_clin_serv
                       AND dcs.id_clinical_service = cs.id_clinical_service
                       AND dcs.id_department = d.id_department
                       AND uc.id_state = ws.id_state
                       AND uc.id_unidose_car = i_id_car) v1
             GROUP BY v1.id_unidose_car,
                      v1.car_model_name,
                      v1.dept,
                      v1.dept_id,
                      v1.serv,
                      v1.id_dep_clin_serv,
                      v1.number_of_slots,
                      v1.car_location,
                      v1.id_state,
                      v1.state_desc,
                      v1.notes;
    
        g_error := 'GET CURSOR (UNIDOSE CAR PATIENTS)';
        OPEN o_car_patients FOR
            SELECT p.id_patient,
                   get_pat_name(i_lang, i_prof, p.id_patient) name,
                   pk_adt.get_pat_non_disc_options(i_lang, i_prof, p.id_patient) pat_ndo,
                   pk_adt.get_pat_non_disclosure_icon(i_lang, i_prof, p.id_patient) pat_nd_icon,
                   pk_patient.get_pat_name_to_sort(i_lang, i_prof, p.id_patient, dr.id_episode) pat_name_to_sort,
                   p.gender,
                   pk_patient.get_pat_age(i_lang, p.id_patient, i_prof) pat_age,
                   pk_patphoto.get_pat_photo(i_lang, i_prof, p.id_patient, dr.id_episode, NULL) photo,
                   rtrim(concatenate(to_char(v1.slot_number) || ', '), ', ') slot_number,
                   get_pat_clin_record(i_lang, p.id_patient, i_prof.institution) num_clin_record,
                   pk_date_utils.date_send_tsz(i_lang, get_episode_discharge_date(dr.id_episode), i_prof) discharge,
                   get_pat_location(i_lang, i_prof, dr.id_episode, p.id_patient, 'TEXT', 'BED') bed, --get patient bed
                   pk_date_utils.date_send_tsz(i_lang, dr.dt_drug_req_tstz, i_prof) date_target,
                   get_status_pipe_str(i_lang,
                                       i_prof,
                                       decode(drs.id_state, NULL, drd.id_state, drs.id_state),
                                       l_prof_type,
                                       drdst.dt_state,
                                       '',
                                       '',
                                       g_yes) status,
                   drd.id_drug_req_det,
                   dr.id_episode,
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.flg_type,
                                       dpd.id_drug_presc_det,
                                       g_yes,
                                       drd.id_other_product) pharm,
                   drd.qty_to_prep || ' ' ||
                   pk_medication_core.get_unit_translation(i_lang, i_prof, drd.id_unit_measure_prep, 3) qty_to_prep_desc
              FROM (
                    --orders allocated to slots of the car
                    SELECT ucs.id_patient, usc.slot_number, usc.id_drug_req_det
                      FROM pharm_unidose_car_slot ucs, pharm_unidose_slot_content usc
                     WHERE ucs.id_unidose_car = i_id_car
                       AND ucs.id_unidose_car = usc.id_unidose_car
                       AND ucs.slot_number = usc.slot_number
                    UNION ALL
                    --orders allocated to car, but not to slots
                    SELECT dr1.id_patient, NULL slot_number, ucc.id_drug_req_det
                      FROM pharm_unidose_car_content ucc, drug_req_det drd1, drug_req dr1
                     WHERE ucc.id_unidose_car = i_id_car
                       AND ucc.id_drug_req_det = drd1.id_drug_req_det
                       AND drd1.id_drug_req = dr1.id_drug_req) v1,
                   patient p,
                   drug_req_det drd,
                   drug_req_det_state_transition drdst,
                   drug_req dr,
                   drug_req_supply drs,
                   drug_presc_det dpd
             WHERE v1.id_patient = p.id_patient
               AND v1.id_drug_req_det = drd.id_drug_req_det
               AND drd.id_drug_req_det = drdst.id_drug_req_det
               AND drd.id_state = drdst.id_state
               AND drd.id_drug_req = dr.id_drug_req
               AND dr.id_drug_presc_det = dpd.id_drug_presc_det
               AND drd.id_drug_req_det = drs.id_drug_req_det(+)
             GROUP BY p.id_patient,
                      name,
                      p.gender,
                      dr.id_episode,
                      dr.dt_drug_req_tstz,
                      drd.id_state,
                      drdst.dt_state,
                      drd.id_drug_req_det,
                      drs.id_state,
                      drd.id_drug,
                      drd.vers,
                      dr.flg_type,
                      dpd.id_drug_presc_det,
                      drd.id_other_product,
                      drd.qty_to_prep,
                      drd.id_unit_measure_prep
             ORDER BY MIN(v1.slot_number) NULLS LAST, name;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'get_uni_car_edit', o_error);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_car);
            pk_types.open_my_cursor(o_car_patients);
            pk_types.open_my_cursor(o_options);
            RETURN FALSE;
    END get_uni_car_edit;

    /********************************************************************************************
    * alert.pk_pharmacy.get_pats_by_drug_serv
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DRUG                       IN    VARCHAR2
    * @param  I_VERSION                       IN    VARCHAR2
    * @param  I_ID_CAR                        IN    NUMBER(24)
    * @param  O_PATIENTS                      OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.1
    * @since  2009-11-12
    *
    ********************************************************************************************/
    FUNCTION get_pats_by_drug_serv
    (
        i_lang     IN language.id_language%TYPE,
        i_prof     IN alert.profissional,
        i_id_drug  IN drug_req_det.id_drug%TYPE,
        i_version  IN drug_req_det.vers%TYPE,
        i_id_car   IN pharm_unidose_car.id_unidose_car%TYPE,
        o_patients OUT pk_types.cursor_type,
        o_error    OUT t_error_out
    ) RETURN BOOLEAN IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'get_pats_by_drug_serv';
    BEGIN
        g_error := 'GET CURSOR';
        OPEN o_patients FOR
            SELECT v2.id_drug_req_det,
                   v2.id_patient,
                   v2.name,
                   pk_adt.get_pat_non_disc_options(i_lang, i_prof, v2.id_patient) pat_ndo,
                   pk_adt.get_pat_non_disclosure_icon(i_lang, i_prof, v2.id_patient) pat_nd_icon,
                   pk_patient.get_pat_name_to_sort(i_lang, i_prof, v2.id_patient, v2.id_episode) pat_name_to_sort,
                   v2.gender,
                   pk_patient.get_pat_age(i_lang, v2.id_patient, i_prof) pat_age,
                   pk_patphoto.get_pat_photo(i_lang, i_prof, v2.id_patient, v2.id_episode, NULL) photo,
                   pk_message.get_message(i_lang, 'PHARMACIST_DETAIL_PAT_BED') || ': ' ||
                   get_pat_location(i_lang, i_prof, v2.id_episode, v2.id_patient, 'TEXT', 'BED') bed,
                   pk_message.get_message(i_lang, 'PHARMACIST_REQ_GRID_097') || ': ' || v2.qty_to_prep || ' ' ||
                   pk_medication_core.get_unit_translation(i_lang, i_prof, v2.id_unit_measure_prep, 3) quantity
              FROM (SELECT pharmacy_tbl_num(drd.id_drug_req_det) id_drug_req_det,
                           p.id_patient,
                           get_pat_name(i_lang, i_prof, p.id_patient) name,
                           p.gender,
                           SUM(drd.qty_to_prep) qty_to_prep,
                           drd.id_unit_measure_prep,
                           dr.id_episode
                      FROM drug_req_det drd
                     INNER JOIN drug_req dr
                        ON (drd.id_drug_req = dr.id_drug_req)
                     INNER JOIN patient p
                        ON (dr.id_patient = p.id_patient)
                     INNER JOIN episode e
                        ON (dr.id_episode = e.id_episode)
                     INNER JOIN visit v
                        ON (e.id_visit = v.id_visit)
                     INNER JOIN TABLE(get_orders_for_car(i_id_car)) v1
                        ON (drd.id_drug_req_det = v1.id_drug_req_det)
                     WHERE drd.id_drug = i_id_drug
                       AND drd.vers = i_version
                       AND dr.flg_type = g_flg_unidose
                       AND e.flg_status = 'A'
                       AND v.flg_status != 'C'
                       AND drd.id_state IN
                           (SELECT v_ords.column_value
                              FROM TABLE(get_states_for_req_type(i_prof,
                                                                 g_flg_unidose,
                                                                 table_varchar(g_drd_requested_st,
                                                                               g_drd_validated_st,
                                                                               g_drd_executing_st,
                                                                               g_drd_terminated_st))) v_ords)
                     GROUP BY p.id_patient, name, p.gender, drd.id_unit_measure_prep, dr.id_episode) v2
             ORDER BY v2.name;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, o_error);
            pk_types.open_my_cursor(o_patients);
            RETURN FALSE;
    END get_pats_by_drug_serv;

    /********************************************************************************************
    * alert.pk_pharmacy.get_cars_for_req_gen_kardex
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_REQ_GEN                    IN    NUMBER(24)
    * @param  I_FLG_OLD                       IN    VARCHAR2
    *
    * @return ALERT.TABLE_NUMBER
    *
    * @author Rui Marante
    * @version  2.5.0.7.4
    * @since  2009-12-11
    *
    ********************************************************************************************/
    FUNCTION get_cars_for_req_gen_kardex
    (
        i_lang       IN language.id_language%TYPE,
        i_prof       IN alert.profissional,
        i_id_req_gen IN pharm_unidose_req_gen.id_req_gen%TYPE,
        i_flg_old    IN pharm_unidose_req_gen.flg_old%TYPE
    ) RETURN table_number IS
        l_tbl_cars table_number;
    BEGIN
        IF (i_flg_old = g_yes)
        THEN
            l_tbl_cars := table_number();
        ELSE
            SELECT uc.id_unidose_car
              BULK COLLECT
              INTO l_tbl_cars
              FROM pharm_unidose_req_gen_car urgc, pharm_unidose_car_model ucm, pharm_unidose_car uc
             WHERE urgc.id_car_model = ucm.id_unidose_car_model
               AND ucm.id_unidose_car_model = uc.id_car_model
               AND to_date(urgc.day_car, 'YYYYMMDD') BETWEEN to_date(to_char(uc.dt_car_begin, 'YYYYMMDD'), 'YYYYMMDD') AND
                   to_date(to_char(nvl(uc.dt_car_end, uc.dt_car_begin), 'YYYYMMDD'), 'YYYYMMDD')
               AND uc.flg_kardex_success = g_no
               AND urgc.id_req_gen = i_id_req_gen
               AND uc.id_state = get_state_for_req_type(i_prof, NULL, g_uni_car_executing_st);
        END IF;
    
        RETURN l_tbl_cars;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_cars_for_req_gen_kardex;

    /********************************************************************************************
    * alert.pk_pharmacy.get_conf_uni_dep_serv_gen
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  O_ROWS                          OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-07-27
    *
    ********************************************************************************************/
    FUNCTION get_conf_uni_dep_serv_gen
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN alert.profissional,
        i_get_headers  IN VARCHAR2 DEFAULT 'N',
        i_header_codes IN table_varchar DEFAULT NULL,
        o_rows         OUT pk_types.cursor_type,
        o_headers      OUT pk_types.cursor_type,
        o_actions      OUT pk_types.cursor_type,
        o_value        OUT sys_config.value%TYPE,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error := 'GET ACTIONS';
        OPEN o_actions FOR
            SELECT ss.code_message id_action, ss.desc_message desc_action, ss.flg_available
              FROM sys_message ss
             WHERE ss.code_message IN ('PHARMACIST_UNIDOSE_ACTION_EDIT',
                                       'PHARMACIST_UNIDOSE_ACTION_KARDEX',
                                       'PHARMACIST_UNIDOSE_ACTION_REQ')
               AND ss.id_language = i_lang
             ORDER BY ss.desc_message;
    
        g_error := 'GET CURSOR';
        OPEN o_rows FOR
            SELECT dcs.id_dep_clin_serv,
                   rg.id_req_gen,
                   pk_translation.get_translation(i_lang, d2.code_dept) dept,
                   pk_translation.get_translation(i_lang, d.code_department) || '<br/>' ||
                   pk_translation.get_translation(i_lang, cs.code_clinical_service) serv,
                   pk_date_utils.date_send_tsz(i_lang, rg.dt_begin, i_prof) dt_begin,
                   pk_date_utils.date_send_tsz(i_lang, rg.dt_end, i_prof) dt_end,
                   nvl(rg.flg_old, g_no) flg_old,
                   get_cars_for_req_gen_kardex(i_lang, i_prof, rg.id_req_gen, nvl(rg.flg_old, g_no)) kardex_cars
              FROM dep_clin_serv dcs
             INNER JOIN department d
                ON (dcs.id_department = d.id_department)
             INNER JOIN clinical_service cs
                ON (dcs.id_clinical_service = cs.id_clinical_service)
             INNER JOIN dept d2
                ON (d.id_dept = d2.id_dept)
              LEFT JOIN pharm_unidose_req_gen rg
                ON (rg.flg_manual_gen = g_yes AND rg.flg_success = g_yes AND dcs.id_dep_clin_serv = rg.id_dep_clin_serv AND
                   (rg.flg_old = g_no OR
                   (10 > abs(nvl(pk_date_utils.get_timestamp_diff(current_timestamp, rg.dt_begin), 0)) AND
                   rg.flg_old = g_yes)))
             WHERE d.id_institution = i_prof.institution
               AND d2.id_institution = i_prof.institution
               AND d2.flg_available = g_yes
               AND d.flg_unidose = g_yes
               AND dcs.flg_available = g_yes
               AND cs.flg_available = g_yes
             ORDER BY flg_old, dept, serv;
    
        o_value := pk_sysconfig.get_config(i_code_cf => 'PHARMACY_UNIDOSE_INSTITUTION_24H_INTERVAL_START',
                                           i_prof    => i_prof);
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'get_conf_uni_dep_serv_gen', o_error);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_rows);
            RETURN FALSE;
    END get_conf_uni_dep_serv_gen;

    /********************************************************************************************
    * alert.pk_pharmacy.set_conf_uni_dep_serv_gen
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_REQ_GEN                    IN    NUMBER(24)
    * @param  I_ID_DEP_CLIN_SERV              IN    NUMBER(24)
    * @param  I_DT_BEGIN                      IN    VARCHAR2
    * @param  I_DT_END                        IN    VARCHAR2
    * @param  O_ID_REQ_GEN_NEW                OUT   NUMBER(24)
    * @param  O_ID_REQ_GEN_OLD                OUT   NUMBER(24)
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7
    * @since  2009-10-25
    *
    ********************************************************************************************/
    FUNCTION set_conf_uni_dep_serv_gen
    (
        i_lang             IN language.id_language%TYPE,
        i_prof             IN alert.profissional,
        i_id_req_gen       IN pharm_unidose_req_gen.id_req_gen%TYPE,
        i_id_dep_clin_serv IN pharm_unidose_req_gen.id_dep_clin_serv%TYPE,
        i_dt_begin         IN VARCHAR2,
        i_dt_end           IN VARCHAR2,
        o_id_req_gen_new   OUT pharm_unidose_req_gen.id_req_gen%TYPE,
        o_id_req_gen_old   OUT pharm_unidose_req_gen.id_req_gen%TYPE,
        o_error            OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_dt_begin pharm_unidose_req_gen.dt_begin%TYPE;
        l_dt_end   pharm_unidose_req_gen.dt_end%TYPE;
    
        PROCEDURE get_uni_car_hour
        (
            i_lang     IN language.id_language%TYPE,
            i_prof     IN alert.profissional,
            i_dt_begin IN VARCHAR2,
            i_dt_end   IN VARCHAR2,
            o_dt_begin OUT pharm_unidose_req_gen.dt_begin%TYPE,
            o_dt_end   OUT pharm_unidose_req_gen.dt_end%TYPE
        ) IS
            l_dt_time_begin VARCHAR2(6 CHAR) := '000000';
            l_dt_time_end   VARCHAR2(6 CHAR) := '235959';
            l_dt_tsmp       TIMESTAMP WITH LOCAL TIME ZONE := current_timestamp;
            l_value         sys_config.value%TYPE;
            l_hour_begin    VARCHAR2(6 CHAR);
            l_hour_end      VARCHAR2(6 CHAR);
            l_hour_temp     VARCHAR2(6 CHAR);
        BEGIN
        
            l_value := pk_sysconfig.get_config(i_code_cf => 'PHARMACY_UNIDOSE_INSTITUTION_24H_INTERVAL_START',
                                               i_prof    => i_prof);
        
            l_hour_temp := to_char(substr(i_dt_begin, 9, 2) || ':' || substr(i_dt_begin, 11, 2));
        
            IF (l_value != l_hour_temp)
            THEN
                l_value := l_hour_temp;
            END IF;
        
            IF (l_value IS NOT NULL)
            THEN
                l_hour_begin := to_char(to_timestamp(to_char(l_dt_tsmp, 'YYYYMMDD') || REPLACE(l_value, ':', '') || '00',
                                                     'YYYYMMDDHH24MISS'),
                                        'HH24MISS');
                l_hour_end   := to_char((to_timestamp(to_char(l_dt_tsmp, 'YYYYMMDD') || REPLACE(l_value, ':', '') || '00',
                                                      'YYYYMMDDHH24MISS')) - (1 / (24 * 60 * 60)),
                                        'HH24MISS');
            
                o_dt_begin := pk_date_utils.get_string_tstz(i_lang,
                                                            i_prof,
                                                            substr(i_dt_begin, 0, 8) || l_hour_begin,
                                                            NULL);
                o_dt_end   := pk_date_utils.get_string_tstz(i_lang, i_prof, substr(i_dt_end, 0, 8) || l_hour_end, NULL);
            
            ELSE
                o_dt_begin := pk_date_utils.get_string_tstz(i_lang,
                                                            i_prof,
                                                            substr(i_dt_begin, 0, 8) || l_dt_time_begin,
                                                            NULL);
                o_dt_end   := pk_date_utils.get_string_tstz(i_lang,
                                                            i_prof,
                                                            substr(i_dt_end, 0, 8) || l_dt_time_end,
                                                            NULL);
            END IF;
        
        EXCEPTION
            WHEN OTHERS THEN
                RAISE;
            
        END get_uni_car_hour;
    
    BEGIN
    
        get_uni_car_hour(i_lang     => i_lang,
                         i_prof     => i_prof,
                         i_dt_begin => i_dt_begin,
                         i_dt_end   => i_dt_end,
                         o_dt_begin => l_dt_begin,
                         o_dt_end   => l_dt_end);
    
        IF (l_dt_begin > l_dt_end)
        THEN
            --[MEDICATION_RULE] se a data de inicio do carro unidose for maior que a data final ento  gerado um erro
            RAISE g_ex_unidose_invalid_dates;
        END IF;
    
        INSERT INTO pharm_unidose_req_gen
            (id_req_gen, id_dep_clin_serv, id_prof, dt_begin, dt_end, flg_success, flg_old, flg_manual_gen)
        VALUES
            (seq_pharm_unidose_req_gen.nextval, i_id_dep_clin_serv, i_prof.id, l_dt_begin, l_dt_end, g_no, g_no, g_yes)
        RETURNING id_req_gen INTO o_id_req_gen_new;
    
        o_id_req_gen_old := i_id_req_gen;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'set_conf_uni_dep_serv_gen', o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_conf_uni_dep_serv_gen;

    /********************************************************************************************
    * alert.pk_pharmacy.is_auto_pharmacy_order_enabled
    *
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_EPISODE                    IN    NUMBER(24)
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.2
    * @since  2009-11-16
    *
    ********************************************************************************************/
    FUNCTION is_auto_pharmacy_order_enabled
    (
        i_prof       IN profissional,
        i_id_episode IN episode.id_episode%TYPE
    ) RETURN BOOLEAN IS
        l_flg_auto            VARCHAR2(1 CHAR) := g_no;
        l_id_dep_clin_service dep_clin_serv.id_dep_clin_serv%TYPE;
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'is_auto_pharmacy_order_enabled';
    BEGIN
        set_pharmacy_log(l_db_object_name, 'i_id_episode=' || i_id_episode);
    
        g_error := 'QUERY l_id_dep_clin_service';
        BEGIN
            SELECT ei.id_dep_clin_serv
              INTO l_id_dep_clin_service
              FROM epis_info ei
             INNER JOIN dep_clin_serv dcs
                ON (ei.id_dep_clin_serv = dcs.id_dep_clin_serv)
             INNER JOIN department d
                ON (dcs.id_department = d.id_department)
             WHERE ei.id_episode = i_id_episode
               AND dcs.flg_available = g_yes
               AND d.id_institution = i_prof.institution
               AND d.flg_available = g_yes
               AND d.flg_unidose = g_yes;
        EXCEPTION
            WHEN no_data_found THEN
                l_id_dep_clin_service := NULL;
        END;
    
        set_pharmacy_log(l_db_object_name, 'l_id_dep_clin_service=' || l_id_dep_clin_service);
    
        IF (l_id_dep_clin_service IS NOT NULL)
        THEN
            g_error := 'QUERY flg_auto_pharmacy_order';
            BEGIN
                SELECT a.flg_auto_pharmacy_order
                  INTO l_flg_auto
                  FROM pharm_unidose_auto_order a
                 WHERE a.id_dep_clin_serv = l_id_dep_clin_service;
            EXCEPTION
                WHEN no_data_found THEN
                    l_flg_auto := g_no;
            END;
        END IF;
    
        set_pharmacy_log(l_db_object_name, 'l_flg_auto=' || l_flg_auto);
    
        RETURN(l_flg_auto = g_yes);
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END is_auto_pharmacy_order_enabled;

    /********************************************************************************************
    * alert.pk_pharmacy.set_auto_pharmacy_order_off
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DEP_CLIN_SERVICE           IN    ALERT.TABLE_NUMBER
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.2
    * @since  2009-11-16
    *
    ********************************************************************************************/
    PROCEDURE set_auto_pharmacy_order_off
    (
        i_lang                IN language.id_language%TYPE,
        i_prof                IN profissional,
        i_id_dep_clin_service IN table_number,
        o_error               OUT t_error_out
    ) IS
        l_row_count NUMBER := 0;
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'set_auto_pharmacy_order_off';
    BEGIN
        FOR l_row IN i_id_dep_clin_service.first .. i_id_dep_clin_service.last
        LOOP
            g_error := 'UPDATE';
            UPDATE pharm_unidose_auto_order a
               SET a.flg_auto_pharmacy_order = g_no, a.dt_stop_at = current_timestamp
             WHERE a.id_dep_clin_serv = i_id_dep_clin_service(l_row)
            RETURNING COUNT(1) INTO l_row_count;
        
            IF (l_row_count = 0)
            THEN
                g_error := 'INSERT';
                INSERT INTO pharm_unidose_auto_order
                    (id_dep_clin_serv, flg_auto_pharmacy_order, dt_stop_at)
                VALUES
                    (i_id_dep_clin_service(l_row), g_no, current_timestamp);
            END IF;
        END LOOP;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, o_error);
            RAISE;
    END set_auto_pharmacy_order_off;

    FUNCTION set_auto_pharmacy_order_off
    (
        i_lang                IN language.id_language%TYPE,
        i_prof                IN profissional,
        i_id_dep_clin_service IN table_number,
        o_error               OUT t_error_out
    ) RETURN BOOLEAN IS
        l_row_count NUMBER := 0;
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'set_auto_pharmacy_order_off';
    BEGIN
        set_auto_pharmacy_order_off(i_lang                => i_lang,
                                    i_prof                => i_prof,
                                    i_id_dep_clin_service => i_id_dep_clin_service,
                                    o_error               => o_error);
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_auto_pharmacy_order_off;

    PROCEDURE check_day_clin_serv_dup
    (
        i_id_dep_clin_serv IN pharm_unidose_car_model.id_dep_clin_serv%TYPE,
        i_day_car          IN VARCHAR2
    ) IS
        l_count NUMBER := 0;
    BEGIN
    
        SELECT COUNT(1)
          INTO l_count
          FROM pharm_unidose_req_gen_car u
         WHERE u.day_car = i_day_car
           AND u.id_car_model IN (SELECT cm.id_unidose_car_model
                                    FROM pharm_unidose_car_model cm
                                   WHERE cm.id_dep_clin_serv = i_id_dep_clin_serv)
           AND rownum = 1;
    
        IF (l_count > 0)
        THEN
            RAISE g_ex_unidose_dup_car;
        END IF;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END check_day_clin_serv_dup;

    /********************************************************************************************
    * alert.pk_pharmacy.create_unidose_today
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DEP_CLIN_SERV              IN    NUMBER(24)
    * @param  I_DT_CAR                        IN    DATE
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-08-19
    *
    ********************************************************************************************/
    FUNCTION create_unidose_today
    (
        i_lang             IN language.id_language%TYPE,
        i_prof             IN alert.profissional,
        i_id_dep_clin_serv IN pharm_unidose_req_gen.id_dep_clin_serv%TYPE,
        i_dt_car           IN TIMESTAMP WITH LOCAL TIME ZONE,
        o_error            OUT t_error_out
    ) RETURN BOOLEAN IS
        CURSOR c_cars IS
            SELECT v1.id_unidose_car_model
              FROM (SELECT cm.id_unidose_car_model
                      FROM pharm_unidose_car_model cm
                     WHERE cm.id_dep_clin_serv = i_id_dep_clin_serv
                       AND cm.flg_active = g_yes
                     ORDER BY cm.id_unidose_car_model DESC) v1
             WHERE rownum = 1; --um carro por servio
    
        l_dt_formated   VARCHAR2(8 CHAR) := '';
        l_available_car BOOLEAN := FALSE;
        l_id_req_gen    pharm_unidose_req_gen.id_req_gen%TYPE;
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'CREATE_UNIDOSE_TODAY';
        l_institution institution.id_institution%TYPE;
        l_prof        alert.profissional;
    BEGIN
        g_error := 'GET INSTITUTION';
        IF (i_prof.institution = 0)
        THEN
            --unit-dose JOB (automatic schedule)
            SELECT b.id_institution
              INTO l_institution
              FROM dep_clin_serv a, department b
             WHERE a.id_dep_clin_serv = i_id_dep_clin_serv
               AND a.id_department = b.id_department
               AND rownum = 1;
        
            l_prof := profissional(i_prof.id, l_institution, i_prof.software);
        ELSE
            l_prof := i_prof;
        END IF;
    
        l_dt_formated := pk_date_utils.to_char_insttimezone(i_lang      => i_lang,
                                                            i_prof      => l_prof,
                                                            i_timestamp => i_dt_car,
                                                            i_mask      => 'YYYYMMDD');
    
        g_error := 'insert into pharm_unidose_req_gen';
        INSERT INTO pharm_unidose_req_gen
            (id_req_gen, id_dep_clin_serv, id_prof, dt_begin, dt_end, flg_success, flg_old, flg_manual_gen)
        VALUES
            (seq_pharm_unidose_req_gen.nextval, i_id_dep_clin_serv, NULL, i_dt_car, i_dt_car, g_no, g_yes, g_no)
        RETURNING id_req_gen INTO l_id_req_gen;
    
        g_error := 'create car instances';
        FOR car IN c_cars
        LOOP
            set_pharmacy_log(l_db_object_name,
                             'insert into pharm_unidose_req_gen_car: l_id_req_gen=' || l_id_req_gen ||
                             ' car.id_unidose_car_model=' || car.id_unidose_car_model || ' l_dt_formated=' ||
                             l_dt_formated);
        
            --nao pode haver no mesmo dia para o mesmo servico clinico
            check_day_clin_serv_dup(i_id_dep_clin_serv, l_dt_formated);
        
            INSERT INTO pharm_unidose_req_gen_car
                (id_req_gen, id_car_model, day_car)
            VALUES
                (l_id_req_gen, car.id_unidose_car_model, l_dt_formated);
        
            l_available_car := TRUE;
        END LOOP;
    
        IF (l_available_car)
        THEN
            g_error := 'create_unidose_reqs_for_id_gen';
            set_pharmacy_log(l_db_object_name, g_error);
            create_unidose_reqs_for_id_gen(i_lang, l_prof, l_id_req_gen);
        
            --success!
            UPDATE pharm_unidose_req_gen a
               SET a.flg_success = g_yes
             WHERE a.id_req_gen = l_id_req_gen;
        ELSE
            g_error := 'G_EX_UNIDOSE_NO_AVAILABLE_CAR';
            set_pharmacy_log(l_db_object_name, g_error);
            RAISE g_ex_unidose_no_available_car;
        END IF;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END create_unidose_today;

    /********************************************************************************************
    * alert.pk_pharmacy.get_conf_uni_cars_dep_serv
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DEP_CLIN_SERV              IN    NUMBER(24)
    * @param  O_CAR_MODELS                    OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-07-27
    *
    ********************************************************************************************/
    FUNCTION get_conf_uni_cars_dep_serv
    (
        i_lang             IN language.id_language%TYPE,
        i_prof             IN alert.profissional,
        i_id_dep_clin_serv IN pharm_unidose_car_model.id_dep_clin_serv%TYPE,
        o_car_models       OUT pk_types.cursor_type,
        o_error            OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        g_error := 'GET CURSOR';
        OPEN o_car_models FOR
            SELECT ucm.id_unidose_car_model data, ucm.car_model_name label
              FROM pharm_unidose_car_model ucm
             WHERE ucm.id_dep_clin_serv = i_id_dep_clin_serv
               AND ucm.flg_active = g_yes
             ORDER BY ucm.car_model_name;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'get_conf_uni_cars_dep_serv', o_error);
            pk_types.open_my_cursor(o_car_models);
            RETURN FALSE;
    END get_conf_uni_cars_dep_serv;

    /********************************************************************************************
    * alert.pk_pharmacy.get_conf_uni_cars_days
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_REQ_GEN                    IN    NUMBER(24)
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  O_CAR_DAYS                      OUT   REF CURSOR
    * @param  O_CAR_DEP_SERV                  OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-07-27
    *
    ********************************************************************************************/
    FUNCTION get_conf_uni_cars_days
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN alert.profissional,
        i_id_req_gen   IN pharm_unidose_req_gen.id_req_gen%TYPE,
        i_get_headers  IN VARCHAR2 DEFAULT 'N',
        i_header_codes IN table_varchar DEFAULT NULL,
        o_car_days     OUT pk_types.cursor_type,
        o_car_dep_serv OUT pk_types.cursor_type,
        o_headers      OUT pk_types.cursor_type,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
        l_id_dep_clin_serv pharm_unidose_car_model.id_dep_clin_serv%TYPE;
        l_dt_begin         pharm_unidose_req_gen.dt_begin%TYPE;
        l_dt_end           pharm_unidose_req_gen.dt_end%TYPE;
        l_dt_current       pharm_unidose_req_gen.dt_end%TYPE;
        l_dates            table_timestamp_tz := table_timestamp_tz();
        l_dt_count         NUMBER := 0;
        l_dept             pk_translation.t_desc_translation;
        l_serv             pk_translation.t_desc_translation;
    BEGIN
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error := 'GET CURSOR (pharm_unidose_req_gen)';
        SELECT rg.id_dep_clin_serv, rg.dt_begin, rg.dt_end
          INTO l_id_dep_clin_serv, l_dt_begin, l_dt_end
          FROM pharm_unidose_req_gen rg
         WHERE rg.id_req_gen = i_id_req_gen;
    
        g_error := 'GET DEPT/SERV';
        SELECT pk_translation.get_translation(i_lang, d.code_department),
               pk_translation.get_translation(i_lang, cs.code_clinical_service)
          INTO l_dept, l_serv
          FROM dep_clin_serv dcs, clinical_service cs, department d
         WHERE dcs.id_dep_clin_serv = l_id_dep_clin_serv
           AND dcs.id_clinical_service = cs.id_clinical_service
           AND dcs.id_department = d.id_department
           AND rownum = 1;
    
        g_error      := 'LOOP BETWEEN DATES';
        l_dt_current := l_dt_begin;
        l_dt_count   := 1;
        WHILE (l_dt_current < l_dt_end OR l_dt_count > 30) --loop security (l_dt_count > 30)
        LOOP
            l_dates.extend(1);
            l_dates(l_dt_count) := l_dt_current;
            l_dt_count := l_dt_count + 1;
        
            SELECT (l_dt_current + 1)
              INTO l_dt_current
              FROM dual;
        END LOOP;
    
        g_error := 'GET CURSOR';
        OPEN o_car_days FOR
            SELECT pk_date_utils.date_send_tsz(i_lang, column_value, i_prof) car_date, l_dept dept, l_serv serv
              FROM TABLE(l_dates)
             ORDER BY 1;
    
        g_error := 'GET CURSOR (CARS)';
        OPEN o_car_dep_serv FOR
            SELECT ucm.id_unidose_car_model data, ucm.car_model_name label
              FROM pharm_unidose_car_model ucm
             WHERE ucm.id_dep_clin_serv = l_id_dep_clin_serv
               AND ucm.flg_active = g_yes
             ORDER BY ucm.car_model_name;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'get_conf_uni_cars_days', o_error);
            pk_types.open_my_cursor(o_car_days);
            pk_types.open_my_cursor(o_headers);
            RETURN FALSE;
    END get_conf_uni_cars_days;

    /********************************************************************************************
    * alert.pk_pharmacy.set_conf_uni_cars_gen
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_REQ_GEN                    IN    NUMBER(24)
    * @param  I_DATES                         IN    ALERT.TABLE_VARCHAR
    * @param  I_CARS                          IN    ALERT.TABLE_NUMBER
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-07-27
    *
    ********************************************************************************************/
    FUNCTION set_conf_uni_cars_gen
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN alert.profissional,
        i_id_req_gen     IN pharm_unidose_req_gen.id_req_gen%TYPE,
        i_id_req_gen_old IN pharm_unidose_req_gen.id_req_gen%TYPE,
        i_dates          IN table_varchar,
        i_cars           IN table_number,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
        l_dt_formated      VARCHAR2(8 CHAR) := '';
        l_count            NUMBER := 0;
        l_id_dep_clin_serv pharm_unidose_req_gen.id_dep_clin_serv%TYPE;
    BEGIN
        l_count := i_dates.count;
        FOR i IN 1 .. l_count
        LOOP
            l_dt_formated := to_char(to_date(i_dates(i), 'YYYYMMDDHH24MISS'), 'YYYYMMDD');
        
            --[MEDICATION_RULE] se o carro j foi usado na farmcia ento ao usar novamente o mesmo carro o registo do circuito anterior  marcado como sendo histrico
            IF (i_id_req_gen_old IS NOT NULL)
            THEN
                UPDATE pharm_unidose_req_gen rg
                   SET rg.flg_old = g_yes
                 WHERE rg.id_req_gen = i_id_req_gen_old;
            END IF;
        
            BEGIN
                g_error := 'insert into pharm_unidose_req_gen_car';
            
                SELECT cm.id_dep_clin_serv
                  INTO l_id_dep_clin_serv
                  FROM pharm_unidose_car_model cm
                 WHERE cm.id_unidose_car_model = i_cars(i);
            
                --nao pode haver no mesmo dia para o mesmo servico clinico
                check_day_clin_serv_dup(l_id_dep_clin_serv, l_dt_formated);
            
                INSERT INTO pharm_unidose_req_gen_car
                    (id_req_gen, id_car_model, day_car)
                VALUES
                    (i_id_req_gen, i_cars(i), l_dt_formated);
            EXCEPTION
                WHEN dup_val_on_index THEN
                    RAISE g_ex_unidose_dup_car;
                WHEN g_ex_unidose_dup_car THEN
                    RAISE g_ex_unidose_dup_car;
                WHEN OTHERS THEN
                    raise_application_error(-20001, g_error);
            END;
        END LOOP;
    
        g_error := 'create_unidose_reqs_for_id_gen';
        create_unidose_reqs_for_id_gen(i_lang, i_prof, i_id_req_gen);
    
        --success!
        UPDATE pharm_unidose_req_gen a
           SET a.flg_success = g_yes
         WHERE a.id_req_gen = i_id_req_gen
        RETURNING a.id_dep_clin_serv INTO l_id_dep_clin_serv;
    
        --activate the real time prescription -> pharmacy order
        UPDATE pharm_unidose_auto_order ao
           SET ao.flg_auto_pharmacy_order = g_yes
         WHERE ao.id_dep_clin_serv = l_id_dep_clin_serv;
    
        --TBD! popup de mensagem de sucesso!
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'set_conf_uni_cars_gen', o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_conf_uni_cars_gen;

    /********************************************************************************************
    * alert.pk_pharmacy.get_car_slots
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_CAR                        IN    NUMBER(24)
    * @param  I_ID_PATIENT                    IN    NUMBER(24)
    * @param  O_ACTIONS                       OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-07-29
    *
    ********************************************************************************************/
    FUNCTION get_car_slots
    (
        i_lang       IN language.id_language%TYPE,
        i_prof       IN alert.profissional,
        i_id_car     IN pharm_unidose_car.id_unidose_car%TYPE,
        i_id_patient IN pharm_unidose_car_slot.id_patient%TYPE,
        i_id_drd     IN drug_req_det.id_drug_req_det%TYPE,
        o_actions    OUT pk_types.cursor_type,
        o_error      OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        g_error := 'GET CURSOR';
        OPEN o_actions FOR
            SELECT to_number(sd.val) data, sd.desc_val label, 'N' flg_select
              FROM sys_domain sd
             WHERE sd.code_domain = 'PHARMACY_UNI_CAR_SLOT_NA'
               AND sd.id_language = i_lang
               AND sd.domain_owner = pk_sysdomain.k_default_schema
            UNION ALL
            SELECT a.slot_number data,
                   pk_message.get_message(i_lang, 'PHARMACIST_UNIDOSE_DRAWER_SINGLE') || ' ' || a.slot_number label,
                   MAX(decode(b.id_drug_req_det, NULL, 'N', decode(b.id_drug_req_det, i_id_drd, 'Y', 'N'))) flg_select
              FROM pharm_unidose_car_slot a, pharm_unidose_slot_content b
             WHERE a.id_unidose_car = b.id_unidose_car(+)
               AND a.slot_number = b.slot_number(+)
               AND a.id_unidose_car = i_id_car
               AND (b.id_drug_req_det IS NULL OR b.id_drug_req_det = i_id_drd OR a.id_patient = i_id_patient)
             GROUP BY a.slot_number
             ORDER BY data;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'get_car_slots', o_error);
            pk_types.open_my_cursor(o_actions);
            RETURN FALSE;
    END get_car_slots;

    FUNCTION set_car_slots
    (
        i_lang       IN language.id_language%TYPE,
        i_prof       IN alert.profissional,
        i_id_car     IN pharm_unidose_car.id_unidose_car%TYPE,
        i_id_patient IN pharm_unidose_car_slot.id_patient%TYPE,
        i_id_slots   IN table_number,
        i_id_drd_id  IN drug_req_det.id_drug_req_det%TYPE,
        o_error      OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        --[MEDICATION_RULE] (10-09-2009) delete old slots
        DELETE FROM pharm_unidose_slot_content usc
         WHERE usc.id_unidose_car = i_id_car
           AND usc.id_drug_req_det = i_id_drd_id;
    
        --[MEDICATION_RULE] (10-09-2009) remove patient reference from car slot
        UPDATE pharm_unidose_car_slot s
           SET s.id_patient = NULL
         WHERE s.id_unidose_car = i_id_car
           AND s.id_patient = i_id_patient
           AND (s.id_unidose_car, s.slot_number) NOT IN
               (SELECT usc.id_unidose_car, usc.slot_number
                  FROM pharm_unidose_slot_content usc, drug_req_det drd, drug_req dr
                 WHERE usc.id_drug_req_det = drd.id_drug_req_det
                   AND drd.id_drug_req = dr.id_drug_req
                   AND dr.id_patient = i_id_patient);
    
        --[MEDICATION_RULE] (03-11-2009) delete from car
        DELETE FROM pharm_unidose_car_content ucc
         WHERE ucc.id_drug_req_det = i_id_drd_id;
    
        IF (i_id_slots.count > 0)
        THEN
            IF (i_id_slots(1) = -1)
            THEN
                --[MEDICATION_RULE] (03-11-2009) not allocated to any slot but allocated to the car
                BEGIN
                    INSERT INTO pharm_unidose_car_content ucc
                        (id_unidose_car, id_drug_req_det)
                    VALUES
                        (i_id_car, i_id_drd_id);
                EXCEPTION
                    WHEN dup_val_on_index THEN
                        NULL; --already exists
                END;
            ELSE
                --[MEDICATION_RULE] (10-09-2009) set new slots
                UPDATE pharm_unidose_car_slot s
                   SET s.id_patient = i_id_patient
                 WHERE s.id_unidose_car = i_id_car
                   AND s.slot_number IN (SELECT column_value
                                           FROM TABLE(i_id_slots));
            
                --[MEDICATION_RULE] (10-09-2009) set drug_req_det to slots
                FORALL i IN i_id_slots.first .. i_id_slots.last
                    INSERT INTO pharm_unidose_slot_content
                        (id_unidose_car, slot_number, id_drug_req_det)
                    VALUES
                        (i_id_car, i_id_slots(i), i_id_drd_id);
            END IF;
        END IF;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'set_car_slots', o_error);
            pk_utils.undo_changes();
            RETURN FALSE;
    END set_car_slots;

    /********************************************************************************************
    * alert.pk_pharmacy.get_orders_for_car (PIPELINED)
    *
    * @param  I_ID_UNIDOSE_CAR                IN    NUMBER(24)
    *
    * @return ALERT.T_TBL_PHARM_ORDER_FOR_CAR
    *
    * @author Rui Marante
    * @version  2.5.0.7
    * @since  2009-11-04
    *
    ********************************************************************************************/
    FUNCTION get_orders_for_car(i_id_unidose_car IN pharm_unidose_car.id_unidose_car%TYPE) RETURN t_tbl_pharm_order_for_car
        PIPELINED IS
    BEGIN
        FOR row_i IN (SELECT ucs.id_unidose_car, ucs.slot_number, usc.id_drug_req_det
                        FROM pharm_unidose_car_slot ucs
                       INNER JOIN pharm_unidose_slot_content usc
                          ON (ucs.id_unidose_car = usc.id_unidose_car AND ucs.slot_number = usc.slot_number)
                       WHERE ucs.id_unidose_car = i_id_unidose_car
                      UNION ALL
                      SELECT ucc.id_unidose_car, NULL slot_number, ucc.id_drug_req_det
                        FROM pharm_unidose_car_content ucc
                       WHERE ucc.id_unidose_car = i_id_unidose_car)
        LOOP
            PIPE ROW(t_rec_pharm_order_for_car(row_i.id_unidose_car, row_i.slot_number, row_i.id_drug_req_det));
        END LOOP;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_orders_for_car;

    /********************************************************************************************
    * alert.pk_pharmacy.get_order_car_allocation (PIPELINED)
    *
    * @param  I_ID_DRUG_REQ_DET               IN    NUMBER(24)
    *
    * @return ALERT.T_TBL_PHARM_ORDER_FOR_CAR
    *
    * @author Rui Marante
    * @version  2.5.0.7.4
    * @since  2009-12-07
    *
    ********************************************************************************************/
    FUNCTION get_order_car_allocation(i_id_drug_req_det IN drug_req_det.id_drug_req_det%TYPE)
        RETURN t_tbl_pharm_order_for_car
        PIPELINED IS
    BEGIN
        FOR row_i IN (SELECT ucs.id_unidose_car, ucs.slot_number, usc.id_drug_req_det
                        FROM pharm_unidose_car_slot ucs
                       INNER JOIN pharm_unidose_slot_content usc
                          ON (ucs.id_unidose_car = usc.id_unidose_car AND ucs.slot_number = usc.slot_number)
                       WHERE usc.id_drug_req_det = i_id_drug_req_det
                      UNION ALL
                      SELECT ucc.id_unidose_car, NULL slot_number, ucc.id_drug_req_det
                        FROM pharm_unidose_car_content ucc
                       WHERE ucc.id_drug_req_det = i_id_drug_req_det)
        LOOP
            PIPE ROW(t_rec_pharm_order_for_car(row_i.id_unidose_car, row_i.slot_number, row_i.id_drug_req_det));
        END LOOP;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_order_car_allocation;

    PROCEDURE set_pat_2check
    (
        i_lang             IN language.id_language%TYPE,
        i_prof             IN alert.profissional,
        i_drug_req_det     IN table_number,
        i_notes_physician  IN table_varchar,
        i_notes_pharmacist IN table_varchar,
        o_supplies         OUT table_table_number
    ) IS
        l_row_count           NUMBER := 0;
        l_pending_count       NUMBER := 0;
        l_drs_total_count     NUMBER := 0;
        l_state_transition_ok BOOLEAN := FALSE;
        l_current_req_state   drug_req_det.id_state%TYPE;
        l_datetime            drug_req_det.dt_last_change%TYPE;
        l_drs_id              drug_req_supply.id_drug_req_supply%TYPE;
        l_current_sup_state   drug_req_supply.id_state%TYPE;
        l_req_type            drug_req.flg_type%TYPE;
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'set_pat_2check';
        l_id_episode   episode.id_episode%TYPE;
        l_has_supplies BOOLEAN := FALSE;
        l_supplies     table_table_number := table_table_number();
        l_flg_uni_off  drug_req_det.flg_uni_out_off_car%TYPE;
        l_error        t_error_out;
    
        CURSOR req_supplies(id_req IN drug_req_det.id_drug_req_det%TYPE) IS
            SELECT drs.id_drug_req_supply, drs.id_state
              FROM drug_req_supply drs
             WHERE drs.id_drug_req_det = id_req
               AND drs.id_state = get_state_for_req_type(i_prof, NULL, g_drs_readyforvalid_st);
    
        PROCEDURE process_alerts
        (
            i_flg_alert    IN BOOLEAN,
            i_drug_req_det IN drug_req_det.id_drug_req_det%TYPE,
            i_drug_req_sup IN drug_req_supply.id_drug_req_supply%TYPE
        ) IS
            l_code_interv     VARCHAR2(24 CHAR) := 'PHARMACY_ALERT13_002';
            l_id_episode      episode.id_episode%TYPE;
            l_sys_alert_event sys_alert_event%ROWTYPE;
        BEGIN
            IF (i_flg_alert = TRUE)
            THEN
            
                set_pharmacy_log(l_db_object_name, 'process_alerts: l_code_interv=' || l_code_interv);
            
                SELECT dr.id_episode
                  INTO l_id_episode
                  FROM drug_req dr, drug_req_det drd
                 WHERE drd.id_drug_req = dr.id_drug_req
                   AND drd.id_drug_req_det = i_drug_req_det;
            
                IF NOT
                    pk_alerts.insert_sys_alert_event(i_lang                => i_lang,
                                                     i_prof                => i_prof,
                                                     i_sys_alert           => 13,
                                                     i_id_episode          => l_id_episode,
                                                     i_id_record           => i_drug_req_sup,
                                                     i_dt_record           => current_timestamp,
                                                     i_id_professional     => NULL,
                                                     i_id_room             => NULL,
                                                     i_id_clinical_service => NULL,
                                                     i_flg_type_dest       => 'C',
                                                     i_replace1            => pk_message.get_message(i_lang, l_code_interv),
                                                     o_error               => l_error)
                THEN
                    set_pharmacy_log(l_db_object_name, 'ERROR! (process_alerts) g_error=' || g_error);
                END IF;
            
                -- Remove o alerta 14 de requisio em atraso
                g_error                        := 'DELETE FROM SYS_ALERT_EVENT ALERT 72 SET_PAT_PREPARE';
                l_sys_alert_event.id_sys_alert := 73;
                l_sys_alert_event.id_episode   := l_id_episode;
                l_sys_alert_event.id_record    := i_drug_req_det;
            
                IF NOT pk_alerts.delete_sys_alert_event(i_lang            => i_lang,
                                                        i_prof            => i_prof,
                                                        i_sys_alert_event => l_sys_alert_event,
                                                        o_error           => l_error)
                THEN
                    set_pharmacy_log(l_db_object_name, 'ERROR! (process_alerts) g_error=' || g_error);
                END IF;
            
            END IF;
        
        EXCEPTION
            WHEN OTHERS THEN
                set_pharmacy_log(l_db_object_name, 'ERROR! process_alerts: ' || SQLERRM);
        END process_alerts;
        --
    BEGIN
        l_datetime  := current_timestamp;
        l_row_count := i_drug_req_det.count;
    
        g_error    := 'GET REQ TYPE';
        l_req_type := get_req_type(i_drug_req_det(1), NULL);
    
        FOR i IN 1 .. l_row_count
        LOOP
            l_has_supplies := FALSE;
        
            g_error := 'GET CURRENT REQ STATE';
            SELECT drd.id_state, drd.flg_uni_out_off_car
              INTO l_current_req_state, l_flg_uni_off
              FROM drug_req_det drd
             WHERE drd.id_drug_req_det = i_drug_req_det(i);
        
            l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                             i_prof,
                                                                             l_current_req_state,
                                                                             get_state_for_req_type(i_prof,
                                                                                                    l_req_type,
                                                                                                    g_drd_terminated_st));
        
            IF (l_state_transition_ok)
            THEN
                --[MEDICATION_RULE] (10-09-2009) verify the state transition for pharmacist double check
            
                OPEN req_supplies(i_drug_req_det(i));
                LOOP
                    FETCH req_supplies
                        INTO l_drs_id, l_current_sup_state;
                    EXIT WHEN req_supplies%NOTFOUND;
                
                    l_has_supplies := TRUE;
                
                    l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                                     i_prof,
                                                                                     l_current_sup_state,
                                                                                     get_state_for_req_type(i_prof,
                                                                                                            NULL,
                                                                                                            g_drs_readyfortransp_st));
                
                    IF (l_state_transition_ok)
                    THEN
                        --[MEDICATION_RULE] (10-09-2009) verify the state transition for every supply (there can be more than on suplly - partial supplies)
                    
                        UPDATE drug_req_supply drs
                           SET drs.id_state = get_state_for_req_type(i_prof, NULL, g_drs_readyfortransp_st)
                         WHERE drs.id_drug_req_supply = l_drs_id;
                    
                        INSERT INTO drug_req_sup_state_transition
                            (id_drug_req_supply, id_state, id_prof, dt_state, notes1, notes2)
                        VALUES
                            (l_drs_id,
                             get_state_for_req_type(i_prof, NULL, g_drs_readyfortransp_st),
                             i_prof.id,
                             l_datetime,
                             i_notes_physician(i),
                             i_notes_pharmacist(i));
                    
                        --update_grids
                        IF ((l_req_type = g_flg_adm) OR (l_flg_uni_off = g_yes AND l_req_type = g_flg_unidose))
                        THEN
                            SELECT dr.id_episode
                              INTO l_id_episode
                              FROM drug_req dr, drug_req_det drd
                             WHERE drd.id_drug_req = dr.id_drug_req
                               AND drd.id_drug_req_det = i_drug_req_det(i);
                        
                            g_error := 'CALL TO PK_PRESCRIPTION_INT.INSERT_DRUG_REQ_TASK';
                            IF NOT pk_prescription_int.insert_drug_req_task(i_lang          => i_lang,
                                                                            i_episode       => l_id_episode,
                                                                            i_prof          => i_prof,
                                                                            i_prof_cat_type => NULL,
                                                                            o_error         => l_error)
                            THEN
                                raise_application_error(-20001, l_error.ora_sqlerrm);
                            END IF;
                        
                            g_error := 'CALL TO PK_GRID.DELETE_EPIS_GRID_TASK';
                            IF NOT pk_grid.delete_epis_grid_task(i_lang    => i_lang,
                                                                 i_episode => l_id_episode,
                                                                 o_error   => l_error)
                            THEN
                                raise_application_error(-20001, l_error.ora_sqlerrm);
                            END IF;
                        END IF;
                    
                        --alertas
                        process_alerts(i_flg_alert    => TRUE,
                                       i_drug_req_det => i_drug_req_det(i),
                                       i_drug_req_sup => l_drs_id);
                    
                    ELSE
                        g_error := 'INVALID SUPPLY STATE';
                        RAISE g_ex_cannot_be_2checked;
                    END IF;
                END LOOP;
                CLOSE req_supplies;
            
                l_supplies.extend(1);
                IF (l_has_supplies)
                THEN
                    l_supplies(l_supplies.count) := table_number(i_drug_req_det(i), 1);
                ELSE
                    l_supplies(l_supplies.count) := table_number(i_drug_req_det(i), 0);
                END IF;
            
                SELECT COUNT(*)
                  INTO l_pending_count
                  FROM drug_req_supply drs
                 WHERE drs.id_drug_req_det = i_drug_req_det(i)
                   AND drs.id_state = get_state_for_req_type(i_prof, NULL, g_drs_preparing_st)
                   AND rownum = 1;
            
                SELECT COUNT(*)
                  INTO l_drs_total_count
                  FROM drug_req_supply drs
                 WHERE drs.id_drug_req_det = i_drug_req_det(i)
                   AND rownum = 1;
            
                IF (l_pending_count = 0 AND l_drs_total_count != 0)
                THEN
                    --[MEDICATION_RULE] (10-09-2009) check for pending quantity
                
                    UPDATE drug_req_det drd
                       SET drd.id_state            = get_state_for_req_type(i_prof, l_req_type, g_drd_terminated_st),
                           drd.dt_last_change      = l_datetime,
                           drd.id_prof_last_change = i_prof.id,
                           drd.id_sw_last_change   = i_prof.software,
                           drd.id_inst_last_change = i_prof.institution
                     WHERE drd.id_drug_req_det = i_drug_req_det(i);
                
                    IF (l_current_req_state != get_state_for_req_type(i_prof, l_req_type, g_drd_terminated_st))
                    THEN
                        INSERT INTO drug_req_det_state_transition
                            (id_drug_req_det, id_state, id_prof, dt_state, notes1, notes2)
                        VALUES
                            (i_drug_req_det(i),
                             get_state_for_req_type(i_prof, l_req_type, g_drd_terminated_st),
                             i_prof.id,
                             l_datetime,
                             i_notes_physician(i),
                             i_notes_pharmacist(i));
                    END IF;
                
                    --[MEDICATION_RULE] se a requisio est completamente concluida, verifica se todos as requisies do carro esto tb concluidas e caso estejam, coloca o carro como pronto para transporte.
                    /*if (l_req_type = g_flg_unidose) then
                      select usc.id_unidose_car
                      into l_id_unidose_car
                      from pharm_unidose_slot_content usc
                      where usc.id_drug_req_det = i_drug_req_det(i)
                        and rownum = 1;
                    
                      --verify if car is full and all orders are fulfilled! if so, automatically change the status of the car (OK to go)
                      set_car_ready_to_go(i_lang, i_prof, l_id_unidose_car);
                    end if;*/
                    --IMPORTANTE NOTE: 2009-11-04 RM
                    -- This is commented because this can no longer be done! Now, the car can be full but still carrie "things" outside the slots!
                    -- So, I cannot set the car ready to go automatically!
                
                END IF;
            ELSE
                g_error := 'INVALID REQ STATE';
                RAISE g_ex_cannot_be_2checked;
            END IF;
        
        END LOOP;
    
        --OUT
        o_supplies := l_supplies;
    
    EXCEPTION
        WHEN OTHERS THEN
            IF (req_supplies%ISOPEN)
            THEN
                CLOSE req_supplies;
            END IF;
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'set_pat_2check', l_error);
            RAISE;
    END set_pat_2check;

    PROCEDURE set_pat_2check
    (
        i_lang             IN language.id_language%TYPE,
        i_prof             IN alert.profissional,
        i_drug_req_det     IN table_number,
        i_notes_physician  IN table_varchar,
        i_notes_pharmacist IN table_varchar
    ) IS
        l_tbl_dummy table_table_number;
    BEGIN
        set_pat_2check(i_lang             => i_lang,
                       i_prof             => i_prof,
                       i_drug_req_det     => i_drug_req_det,
                       i_notes_physician  => i_notes_physician,
                       i_notes_pharmacist => i_notes_pharmacist,
                       o_supplies         => l_tbl_dummy);
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END set_pat_2check;

    /********************************************************************************************
    * alert.pk_pharmacy.set_pat_disp_transp  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_DRUG_REQ_DET                  IN        ALERT.TABLE_NUMBER
    * @param  I_FLG_FORCE                     IN        VARCHAR2
    * @param  O_MSG                           OUT       VARCHAR2
    *
    * @author Rui Marante
    * @version  2.5.0.7.7.2
    * @since  2010-05-21
    *
    * @notes  
    *
    ********************************************************************************************/
    PROCEDURE set_pat_disp_transp
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN alert.profissional,
        i_drug_req_det IN table_number,
        i_flg_force    IN VARCHAR2 DEFAULT 'N',
        o_msg          OUT VARCHAR2
    ) IS
        l_row_count           NUMBER := 0;
        l_count_allocation    NUMBER := 0;
        l_state_transition_ok BOOLEAN := FALSE;
        l_datetime            drug_req_det.dt_last_change%TYPE;
        l_drs_id              drug_req_supply.id_drug_req_supply%TYPE;
        l_current_sup_state   drug_req_supply.id_state%TYPE;
        l_next_sup_state      drug_req_supply.id_state%TYPE;
        l_req_type            drug_req.flg_type%TYPE;
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'set_pat_disp_transp';
        l_id_episode episode.id_episode%TYPE;
        l_error      t_error_out;
    
        CURSOR req_supplies(id_req IN drug_req_det.id_drug_req_det%TYPE) IS
            SELECT drs.id_drug_req_supply, drs.id_state
              FROM drug_req_supply drs
             WHERE drs.id_drug_req_det = id_req
               AND drs.id_state = get_state_for_req_type(i_prof, NULL, g_drs_readyfortransp_st);
    
        PROCEDURE process_alerts
        (
            i_flg_alert    IN BOOLEAN,
            i_drug_req_det IN drug_req_det.id_drug_req_det%TYPE,
            i_drug_req_sup IN drug_req_supply.id_drug_req_supply%TYPE,
            i_id_episode   IN episode.id_episode%TYPE
        ) IS
            l_code_interv     VARCHAR2(24 CHAR) := 'PHARMACY_ALERT13_002';
            l_sys_alert_event sys_alert_event%ROWTYPE;
        BEGIN
            IF (i_flg_alert = TRUE)
            THEN
            
                set_pharmacy_log(l_db_object_name, 'process_alerts: l_code_interv=' || l_code_interv);
            
                IF NOT
                    pk_alerts.insert_sys_alert_event(i_lang                => i_lang,
                                                     i_prof                => i_prof,
                                                     i_sys_alert           => 13,
                                                     i_id_episode          => i_id_episode,
                                                     i_id_record           => i_drug_req_sup,
                                                     i_dt_record           => current_timestamp,
                                                     i_id_professional     => NULL,
                                                     i_id_room             => NULL,
                                                     i_id_clinical_service => NULL,
                                                     i_flg_type_dest       => 'C',
                                                     i_replace1            => pk_message.get_message(i_lang, l_code_interv),
                                                     o_error               => l_error)
                THEN
                    set_pharmacy_log(l_db_object_name, 'ERROR! (process_alerts) g_error=' || g_error);
                END IF;
            
                -- Remove o alerta 14 de requisio em atraso
                g_error                        := 'DELETE FROM SYS_ALERT_EVENT ALERT 72 SET_PAT_PREPARE';
                l_sys_alert_event.id_sys_alert := 73;
                l_sys_alert_event.id_episode   := i_id_episode;
                l_sys_alert_event.id_record    := i_drug_req_det;
            
                IF NOT pk_alerts.delete_sys_alert_event(i_lang            => i_lang,
                                                        i_prof            => i_prof,
                                                        i_sys_alert_event => l_sys_alert_event,
                                                        o_error           => l_error)
                THEN
                    set_pharmacy_log(l_db_object_name, 'ERROR! (process_alerts) g_error=' || g_error);
                END IF;
            
            END IF;
        
        EXCEPTION
            WHEN OTHERS THEN
                set_pharmacy_log(l_db_object_name, 'ERROR! process_alerts: ' || SQLERRM);
        END process_alerts;
        --
    BEGIN
        l_datetime  := current_timestamp;
        l_row_count := i_drug_req_det.count;
        o_msg       := NULL;
    
        l_next_sup_state := get_state_for_req_type(i_prof, NULL, g_drs_uni_ready4transp_st);
    
        FOR i IN 1 .. l_row_count
        LOOP
        
            g_error    := 'GET REQ TYPE';
            l_req_type := get_req_type(i_drug_req_det(i), NULL);
        
            IF (l_req_type = g_flg_unidose)
            THEN
            
                IF (i_flg_force = g_no)
                THEN
                    --verify and get message
                    SELECT COUNT(1)
                      INTO l_count_allocation
                      FROM TABLE(pk_pharmacy.get_order_car_allocation(i_drug_req_det(i)))
                     WHERE rownum = 1;
                
                    IF (l_count_allocation > 0)
                    THEN
                        IF (i_drug_req_det.count > 1)
                        THEN
                            o_msg := pk_message.get_message(i_lang      => i_lang,
                                                            i_code_mess => 'PHARMACY_WARN_UNIDOSE_TRANSP_OUTSIDE_CAR_N');
                        ELSE
                            o_msg := pk_message.get_message(i_lang      => i_lang,
                                                            i_code_mess => 'PHARMACY_WARN_UNIDOSE_TRANSP_OUTSIDE_CAR_1');
                        END IF;
                    
                        RAISE g_ex_req_is_allocate2car;
                    END IF;
                END IF;
            
                UPDATE drug_req_det drd
                   SET drd.flg_uni_out_off_car = g_yes
                 WHERE drd.id_drug_req_det = i_drug_req_det(i);
            
                remove_drd_from_unidose_car(i_lang => i_lang, i_prof => i_prof, i_drug_req_det => i_drug_req_det(i));
            
                OPEN req_supplies(i_drug_req_det(i));
                LOOP
                    FETCH req_supplies
                        INTO l_drs_id, l_current_sup_state;
                    EXIT WHEN req_supplies%NOTFOUND;
                
                    l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                                     i_prof,
                                                                                     l_current_sup_state,
                                                                                     l_next_sup_state);
                
                    IF (l_state_transition_ok)
                    THEN
                    
                        UPDATE drug_req_supply drs
                           SET drs.id_state = l_next_sup_state
                         WHERE drs.id_drug_req_supply = l_drs_id;
                    
                        INSERT INTO drug_req_sup_state_transition
                            (id_drug_req_supply, id_state, id_prof, dt_state)
                        VALUES
                            (l_drs_id, l_next_sup_state, i_prof.id, l_datetime);
                    
                        --update_grids
                        SELECT dr.id_episode
                          INTO l_id_episode
                          FROM drug_req dr, drug_req_det drd
                         WHERE drd.id_drug_req = dr.id_drug_req
                           AND drd.id_drug_req_det = i_drug_req_det(i);
                    
                        g_error := 'CALL TO PK_PRESCRIPTION_INT.INSERT_DRUG_REQ_TASK';
                        IF NOT pk_prescription_int.insert_drug_req_task(i_lang          => i_lang,
                                                                        i_episode       => l_id_episode,
                                                                        i_prof          => i_prof,
                                                                        i_prof_cat_type => NULL,
                                                                        o_error         => l_error)
                        THEN
                            raise_application_error(-20001, l_error.ora_sqlerrm);
                        END IF;
                    
                        g_error := 'CALL TO PK_GRID.DELETE_EPIS_GRID_TASK';
                        IF NOT pk_grid.delete_epis_grid_task(i_lang    => i_lang,
                                                             i_episode => l_id_episode,
                                                             o_error   => l_error)
                        THEN
                            raise_application_error(-20001, l_error.ora_sqlerrm);
                        END IF;
                        --
                    
                        --alertas
                        process_alerts(i_flg_alert    => TRUE,
                                       i_drug_req_det => i_drug_req_det(i),
                                       i_drug_req_sup => l_drs_id,
                                       i_id_episode   => l_id_episode);
                    
                    ELSE
                        g_error := 'INVALID SUPPLY STATE';
                        RAISE g_ex_cannot_be_2checked;
                    END IF;
                
                END LOOP;
                CLOSE req_supplies;
            
            END IF; --g_flg_unidose
        
        END LOOP;
    
    EXCEPTION
        WHEN g_ex_req_is_allocate2car THEN
            RETURN;
        WHEN OTHERS THEN
            IF (req_supplies%ISOPEN)
            THEN
                CLOSE req_supplies;
            END IF;
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, l_error);
            RAISE;
    END set_pat_disp_transp;

    /********************************************************************************************
    * alert.pk_pharmacy.set_pat_disp_transp  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_DRUG_REQ_DET                  IN        ALERT.TABLE_NUMBER
    * @param  I_FLG_FORCE                     IN        VARCHAR2
    * @param  O_MSG                           OUT       VARCHAR2
    * @param  O_ERROR                         OUT       ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.7.2
    * @since  2010-05-21
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION set_pat_disp_transp
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN alert.profissional,
        i_drug_req_det IN table_number,
        i_flg_force    IN VARCHAR2 DEFAULT 'N',
        o_msg          OUT VARCHAR2,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'set_pat_disp_transp';
    BEGIN
        set_pat_disp_transp(i_lang         => i_lang,
                            i_prof         => i_prof,
                            i_drug_req_det => i_drug_req_det,
                            i_flg_force    => i_flg_force,
                            o_msg          => o_msg);
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_pat_disp_transp;

    /********************************************************************************************
    * alert.pk_pharmacy.set_car_transport
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_CAR                        IN    NUMBER(24)
    * @param  I_BEGIN_OR_END                  IN    VARCHAR2
    * @param  I_NOTES_JUSTIF                  IN    VARCHAR2
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  O_REQS_NOT_READY                OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-07-28
    *
    ********************************************************************************************/
    FUNCTION set_car_transport
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN alert.profissional,
        i_id_car         IN pharm_unidose_car.id_unidose_car%TYPE,
        i_begin_or_end   IN VARCHAR2 DEFAULT 'P', -- P=PREPARE TO TRANSPORT | B=BEGIN | E=END | (DEVELUTIONS) PD=PREPARE TO TRANSPORT DEV | BD=BEGIN DEV | ED=END DEV | TD=TERMINATE DEV
        i_notes_justif   IN VARCHAR2 DEFAULT NULL,
        i_get_headers    IN VARCHAR2 DEFAULT 'N',
        i_header_codes   IN table_varchar DEFAULT NULL,
        o_reqs_not_ready OUT pk_types.cursor_type,
        o_devs_in_car    OUT pk_types.cursor_type,
        o_headers        OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
        l_count_req_not_ready  NUMBER := 0;
        l_force_transport      BOOLEAN := FALSE;
        l_ok_to_transport      BOOLEAN := FALSE;
        l_state_transition_ok  BOOLEAN := FALSE;
        l_current_car_state    wfl_state.id_state%TYPE;
        l_next_car_state       wfl_state.id_state%TYPE;
        l_next_drs_state       wfl_state.id_state%TYPE;
        l_datetime             pharm_unidose_car.dt_car_begin%TYPE;
        l_2check_and_transport VARCHAR2(1 CHAR) := g_no;
        l_car_dep_clin_serv    pharm_unidose_car_model.id_dep_clin_serv%TYPE;
        l_tbl_supplies         table_table_number;
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'set_car_transport';
    
        --cursor de "entregas" (PHARMACY -> SERVICE) - not ready
        CURSOR c_drs(i_id IN pharm_unidose_car.id_unidose_car%TYPE) IS
            SELECT x1.id_unidose_car, x1.slot_number, drd.id_drug_req_det, drs.id_state, drs.id_drug_req_supply
              FROM pharm_unidose_car uc
             INNER JOIN TABLE(get_orders_for_car(i_id)) x1
                ON (uc.id_unidose_car = x1.id_unidose_car)
             INNER JOIN drug_req_det drd
                ON (x1.id_drug_req_det = drd.id_drug_req_det)
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             INNER JOIN patient p
                ON (dr.id_patient = p.id_patient)
              LEFT JOIN drug_req_supply drs
                ON (drd.id_drug_req_det = drs.id_drug_req_det AND
                   drs.id_state != get_state_for_req_type(i_prof, NULL, g_drs_readyfortransp_st))
             WHERE uc.id_unidose_car = i_id
               AND dr.flg_type = g_flg_unidose
               AND (drd.id_state != get_state_for_req_type(i_prof, g_flg_unidose, g_drd_terminated_st) OR
                   (drd.id_state = get_state_for_req_type(i_prof, g_flg_unidose, g_drd_terminated_st) AND
                   drs.id_state != get_state_for_req_type(i_prof, NULL, g_drs_readyfortransp_st)));
    
        --cursor de "entregas" (PHARMACY -> SERVICE) - ready for transport
        CURSOR c_drs_ready(i_id IN pharm_unidose_car.id_unidose_car%TYPE) IS
            SELECT x1.id_unidose_car, x1.slot_number, drd.id_drug_req_det, drs.id_state, drs.id_drug_req_supply
              FROM pharm_unidose_car uc
             INNER JOIN TABLE(get_orders_for_car(i_id)) x1
                ON (uc.id_unidose_car = x1.id_unidose_car)
             INNER JOIN drug_req_det drd
                ON (x1.id_drug_req_det = drd.id_drug_req_det)
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             INNER JOIN patient p
                ON (dr.id_patient = p.id_patient)
             INNER JOIN drug_req_supply drs
                ON (drd.id_drug_req_det = drs.id_drug_req_det)
             WHERE uc.id_unidose_car = i_id
               AND drd.id_state = get_state_for_req_type(i_prof, g_flg_unidose, g_drd_terminated_st)
               AND dr.flg_type = g_flg_unidose;
    
        --cursor de devolues (SERVICE -> PHARMACY)
        --begin transport
        CURSOR c_drds_begin(i_id IN pharm_unidose_car.id_unidose_car%TYPE) IS
            SELECT drsd.id_drug_req_supply_dev, drsd.id_state
              FROM drug_req_supply_dev drsd,
                   drug_req_sup_dev_state_trans drsdst,
                   drug_req_supply drs,
                   drug_req_det drd,
                   TABLE(get_orders_for_car(i_id)) x1
             WHERE drsd.id_drug_req_supply_dev = drsdst.id_drug_req_supply_dev
               AND drsdst.id_state = get_state_for_req_type(i_prof, NULL, g_drs_to_return_st)
               AND drsd.id_drug_req_supply = drs.id_drug_req_supply
               AND drs.id_drug_req_det = drd.id_drug_req_det
               AND drd.id_drug_req_det = x1.id_drug_req_det;
    
        --end transport
        CURSOR c_drds_end(i_id IN pharm_unidose_car.id_unidose_car%TYPE) IS
            SELECT drsd.id_drug_req_supply_dev, drsd.id_state
              FROM drug_req_supply_dev drsd,
                   drug_req_sup_dev_state_trans drsdst,
                   drug_req_supply drs,
                   drug_req_det drd,
                   TABLE(get_orders_for_car(i_id)) x1
             WHERE drsd.id_drug_req_supply_dev = drsdst.id_drug_req_supply_dev
               AND drsdst.id_state = get_state_for_req_type(i_prof, NULL, g_drs_returning_st)
               AND drsd.id_drug_req_supply = drs.id_drug_req_supply
               AND drs.id_drug_req_det = drd.id_drug_req_det
               AND drd.id_drug_req_det = x1.id_drug_req_det;
    
        --check if the car is empty (cannot transport an empty car to the service)
        FUNCTION car_is_empty(i_id_car IN pharm_unidose_car.id_unidose_car%TYPE) RETURN BOOLEAN IS
            l_count_drds_on_car NUMBER(1) := 0;
        BEGIN
            SELECT SUM(v1.n)
              INTO l_count_drds_on_car
              FROM (SELECT COUNT(1) n
                      FROM pharm_unidose_slot_content a
                     WHERE a.id_unidose_car = i_id_car
                       AND rownum = 1
                    UNION ALL
                    SELECT COUNT(1) n
                      FROM pharm_unidose_car_content b
                     WHERE b.id_unidose_car = i_id_car
                       AND rownum = 1) v1;
        
            RETURN(l_count_drds_on_car = 0);
        
        EXCEPTION
            WHEN OTHERS THEN
                RAISE;
        END;
        --
        PROCEDURE remove_order_from_car
        (
            i_id_car2 IN pharm_unidose_car.id_unidose_car%TYPE,
            i_id_drd2 IN drug_req_det.id_drug_req_det%TYPE
        ) IS
        BEGIN
            DELETE FROM pharm_unidose_slot_content usc
             WHERE usc.id_unidose_car = i_id_car2
               AND usc.id_drug_req_det = i_id_drd2;
        
            --order not in any slot but in the car
            DELETE FROM pharm_unidose_car_content ucc
             WHERE ucc.id_unidose_car = i_id_car2
               AND ucc.id_drug_req_det = i_id_drd2;
        
        EXCEPTION
            WHEN OTHERS THEN
                RAISE;
        END remove_order_from_car;
        --
    BEGIN
        g_error                := 'GET CONFIGS';
        l_2check_and_transport := nvl(pk_sysconfig.get_config(i_code_cf => 'PHARMACY_UNI_CAR_CAN_TRANSPORT_WITHOUT_2CHECK',
                                                              i_prof    => i_prof),
                                      g_no);
    
        l_datetime := current_timestamp;
    
        IF (i_begin_or_end = 'P')
        THEN
            --set car ready for transport PHARMACY -> SERVICE!
            --[MEDICATION_RULE] se for passado o parmetro a P o estado do carro unidose passa a pronto para transporte e necessita de nota de justificao para descartar as requisies no preparadas e seguirem as que j esto prontas.
        
            IF (i_notes_justif IS NULL)
            THEN
            
                --[MEDICATION_RULE] (10-09-2009) check if there are any orders not ready for transport
                SELECT COUNT(1)
                  INTO l_count_req_not_ready
                  FROM pharm_unidose_car uc
                 INNER JOIN TABLE(get_orders_for_car(i_id_car)) x1
                    ON (uc.id_unidose_car = x1.id_unidose_car)
                 INNER JOIN drug_req_det drd
                    ON (x1.id_drug_req_det = drd.id_drug_req_det)
                 INNER JOIN drug_req dr
                    ON (drd.id_drug_req = dr.id_drug_req)
                  LEFT JOIN drug_req_supply drsu
                    ON (drd.id_drug_req_det = drsu.id_drug_req_det AND
                       drsu.id_state != get_state_for_req_type(i_prof, NULL, g_drs_readyfortransp_st))
                 WHERE uc.id_unidose_car = i_id_car
                   AND dr.flg_type = g_flg_unidose
                   AND (drd.id_state != get_state_for_req_type(i_prof, g_flg_unidose, g_drd_terminated_st) OR
                       (drd.id_state = get_state_for_req_type(i_prof, g_flg_unidose, g_drd_terminated_st) AND
                       drsu.id_state != get_state_for_req_type(i_prof, NULL, g_drs_readyfortransp_st)))
                   AND rownum = 1;
            
                IF (l_count_req_not_ready != 0)
                THEN
                    --[MEDICATION_RULE] (10-09-2009) if some orders are not ready, remove them from unit dose slots/car
                    g_error := 'GET HEADERS';
                    get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
                
                    OPEN o_reqs_not_ready FOR
                        SELECT v1.name popup_name,
                               get_medication_name(i_lang,
                                                   i_prof,
                                                   v1.id_drug,
                                                   v1.vers,
                                                   g_flg_unidose,
                                                   v1.id_drug_presc_det,
                                                   g_yes,
                                                   v1.id_other_product) popup_pharm
                          FROM (SELECT get_pat_name(i_lang, i_prof, p.id_patient) name,
                                       pk_adt.get_pat_non_disc_options(i_lang, i_prof, p.id_patient) pat_ndo,
                                       pk_adt.get_pat_non_disclosure_icon(i_lang, i_prof, p.id_patient) pat_nd_icon,
                                       pk_patient.get_pat_name_to_sort(i_lang, i_prof, p.id_patient, dr.id_episode) pat_name_to_sort,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.id_drug_presc_det,
                                       drd.id_other_product
                                  FROM pharm_unidose_car uc
                                 INNER JOIN TABLE(get_orders_for_car(i_id_car)) x1
                                    ON (uc.id_unidose_car = x1.id_unidose_car)
                                 INNER JOIN drug_req_det drd
                                    ON (x1.id_drug_req_det = drd.id_drug_req_det)
                                 INNER JOIN drug_req dr
                                    ON (drd.id_drug_req = dr.id_drug_req)
                                 INNER JOIN patient p
                                    ON (dr.id_patient = p.id_patient)
                                  LEFT JOIN drug_req_supply drsu
                                    ON (drd.id_drug_req_det = drsu.id_drug_req_det AND
                                       drsu.id_state != get_state_for_req_type(i_prof, NULL, g_drs_readyfortransp_st))
                                 WHERE uc.id_unidose_car = i_id_car
                                   AND dr.flg_type = g_flg_unidose
                                   AND (drd.id_state !=
                                       get_state_for_req_type(i_prof, g_flg_unidose, g_drd_terminated_st) OR
                                       (drd.id_state =
                                       get_state_for_req_type(i_prof, g_flg_unidose, g_drd_terminated_st) AND
                                       drsu.id_state != get_state_for_req_type(i_prof, NULL, g_drs_readyfortransp_st)))
                                 GROUP BY p.id_patient,
                                          drd.id_drug,
                                          drd.vers,
                                          dr.id_drug_presc_det,
                                          drd.id_other_product,
                                          dr.id_episode) v1
                         ORDER BY v1.name;
                
                ELSE
                    l_ok_to_transport := TRUE;
                END IF;
            
            ELSE
                l_force_transport := TRUE;
            END IF;
        
            IF (l_ok_to_transport OR l_force_transport)
            THEN
                pk_types.open_my_cursor(o_reqs_not_ready);
                pk_types.open_my_cursor(o_headers);
            
                --[MEDICATION_RULE] (10-09-2009) check if the car has patients and orders (cannot transport an empty car!)
                IF (car_is_empty(i_id_car))
                THEN
                    RAISE g_ex_unidose_car_empty;
                END IF;
            
                SELECT uc.id_state, ucm.id_dep_clin_serv
                  INTO l_current_car_state, l_car_dep_clin_serv
                  FROM pharm_unidose_car uc, pharm_unidose_car_model ucm
                 WHERE uc.id_unidose_car = i_id_car
                   AND uc.id_car_model = ucm.id_unidose_car_model;
            
                l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                                 i_prof,
                                                                                 l_current_car_state,
                                                                                 get_state_for_req_type(i_prof,
                                                                                                        NULL,
                                                                                                        g_uni_car_ready4transp_st));
            
                IF (l_state_transition_ok)
                THEN
                    --[MEDICATION_RULE] (10-09-2009) if car state is ok then set the car ready for transport
                    UPDATE pharm_unidose_car uc
                       SET uc.id_state = get_state_for_req_type(i_prof, NULL, g_uni_car_ready4transp_st)
                     WHERE uc.id_unidose_car = i_id_car;
                
                    INSERT INTO pharm_unidose_car_state_trans
                        (id_unidose_car, id_state, id_prof, dt_state, notes1)
                    VALUES
                        (i_id_car,
                         get_state_for_req_type(i_prof, NULL, g_uni_car_ready4transp_st),
                         i_prof.id,
                         l_datetime,
                         i_notes_justif);
                
                    --[MEDICATION_RULE] (10-09-2009) check if all supplies in the car are ready for transport
                    FOR drs IN c_drs(i_id_car)
                    LOOP
                        IF (l_force_transport)
                        THEN
                            --[MEDICATION_RULE] (10-09-2009) if order not ready but the transport is forced by the pharmacist then remove not ready orders from car slot, set car ready for transport
                            -- order in slot
                            IF (l_2check_and_transport = g_no)
                            THEN
                                remove_order_from_car(i_id_car, drs.id_drug_req_det);
                            ELSE
                                --do the double check!
                                set_pharmacy_log(l_db_object_name,
                                                 'set_pat_2check: i_drug_req_det=' || drs.id_drug_req_det);
                            
                                IF (drs.id_state IS NULL OR
                                   drs.id_state = get_state_for_req_type(i_prof, NULL, g_drs_rejected_st))
                                THEN
                                    remove_order_from_car(i_id_car, drs.id_drug_req_det);
                                ELSE
                                
                                    set_pat_2check(i_lang             => i_lang,
                                                   i_prof             => i_prof,
                                                   i_drug_req_det     => table_number(drs.id_drug_req_det),
                                                   i_notes_physician  => table_varchar(NULL),
                                                   i_notes_pharmacist => table_varchar(i_notes_justif),
                                                   o_supplies         => l_tbl_supplies);
                                
                                    IF (l_tbl_supplies(1) (2) = 0)
                                    THEN
                                        --no supplies, so remove order from cart.
                                        remove_order_from_car(i_id_car, drs.id_drug_req_det);
                                    END IF;
                                END IF;
                            END IF;
                        ELSE
                            RAISE g_ex_unidose_car_not_ready;
                        END IF;
                    END LOOP;
                
                    IF (l_force_transport)
                    THEN
                        --[MEDICATION_RULE] (11-09-2009) remove patient from unit dose car if all patient orders had been removed from the car
                        UPDATE pharm_unidose_car_slot ucs
                           SET ucs.id_patient = NULL
                         WHERE ucs.id_unidose_car = i_id_car
                           AND ucs.id_patient IS NOT NULL
                           AND (ucs.id_unidose_car, ucs.slot_number) NOT IN
                               (SELECT usc.id_unidose_car, usc.slot_number
                                  FROM pharm_unidose_slot_content usc
                                 WHERE usc.id_unidose_car = i_id_car);
                    
                        --[MEDICATION_RULE] (10-09-2009) check if the car has patients and orders (cannot transport an empty car!), again, because of deletes!
                        IF (car_is_empty(i_id_car))
                        THEN
                            RAISE g_ex_unidose_car_empty;
                        END IF;
                    END IF;
                
                    --deactivate real time prescriptions -> pharmacy orders
                    set_auto_pharmacy_order_off(i_lang                => i_lang,
                                                i_prof                => i_prof,
                                                i_id_dep_clin_service => table_number(l_car_dep_clin_serv),
                                                o_error               => o_error);
                
                ELSE
                    RAISE g_ex_invalid_st_transition;
                END IF;
            
            END IF;
        
            pk_types.open_my_cursor(o_devs_in_car);
        
        ELSIF (i_begin_or_end = 'PD')
        THEN
            --PREPARE for devolution
        
            pk_types.open_my_cursor(o_reqs_not_ready);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_devs_in_car);
        
            SELECT uc.id_state
              INTO l_current_car_state
              FROM pharm_unidose_car uc
             WHERE uc.id_unidose_car = i_id_car;
        
            l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                             i_prof,
                                                                             l_current_car_state,
                                                                             get_state_for_req_type(i_prof,
                                                                                                    NULL,
                                                                                                    g_uni_car_ready4transp_dev_st));
        
            IF (l_state_transition_ok)
            THEN
                --[MEDICATION_RULE] (10-09-2009) set the car ready for transport back to the pharmacy
                UPDATE pharm_unidose_car uc
                   SET uc.id_state = get_state_for_req_type(i_prof, NULL, g_uni_car_ready4transp_dev_st)
                 WHERE uc.id_unidose_car = i_id_car;
            
                INSERT INTO pharm_unidose_car_state_trans
                    (id_unidose_car, id_state, id_prof, dt_state)
                VALUES
                    (i_id_car,
                     get_state_for_req_type(i_prof, NULL, g_uni_car_ready4transp_dev_st),
                     i_prof.id,
                     l_datetime);
            
            ELSE
                RAISE g_ex_invalid_st_transition;
            END IF;
        
        ELSIF (i_begin_or_end IN ('B', 'E', 'BD', 'ED'))
        THEN
            --BEGIN or END car transport (aux)
            --[MEDICATION_RULE] se for passado o parmetro a B (begin) ou E (end)  iniciado ou finalizado o transporte de um carro unidose.
        
            pk_types.open_my_cursor(o_reqs_not_ready);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_devs_in_car);
        
            IF (i_begin_or_end = 'B')
            THEN
                --BEGIN
                l_next_car_state := get_state_for_req_type(i_prof, NULL, g_uni_car_in_transit_st);
                l_next_drs_state := get_state_for_req_type(i_prof, NULL, g_drs_in_transit_st);
            ELSIF (i_begin_or_end = 'E')
            THEN
                --END
                l_next_car_state := get_state_for_req_type(i_prof, NULL, g_uni_car_delivered_st);
                l_next_drs_state := get_state_for_req_type(i_prof, NULL, g_drs_supplied_st);
            
            ELSIF (i_begin_or_end = 'BD')
            THEN
                --BEGIN TRANSPORT (DEVOLUTION)
                l_next_car_state := get_state_for_req_type(i_prof, NULL, g_uni_car_in_transit_dev_st);
                l_next_drs_state := get_state_for_req_type(i_prof, NULL, g_drs_returning_st);
            ELSIF (i_begin_or_end = 'ED')
            THEN
                --END TRANSPORT (DEVOLUTION)
                l_next_car_state := get_state_for_req_type(i_prof, NULL, g_uni_car_delivered_dev_st);
                l_next_drs_state := get_state_for_req_type(i_prof, NULL, g_drs_returned_st);
            END IF;
        
            SELECT uc.id_state
              INTO l_current_car_state
              FROM pharm_unidose_car uc
             WHERE uc.id_unidose_car = i_id_car;
        
            l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                             i_prof,
                                                                             l_current_car_state,
                                                                             l_next_car_state);
        
            IF (l_state_transition_ok)
            THEN
                --set car "in transit"
                UPDATE pharm_unidose_car uc
                   SET uc.id_state = l_next_car_state
                 WHERE uc.id_unidose_car = i_id_car;
            
                INSERT INTO pharm_unidose_car_state_trans
                    (id_unidose_car, id_state, id_prof, dt_state)
                VALUES
                    (i_id_car, l_next_car_state, i_prof.id, l_datetime);
            
                IF (i_begin_or_end IN ('B', 'E'))
                THEN
                    --[MEDICATION_RULE] (10-09-2009) check if all supplies are ready for transport
                    FOR drs IN c_drs_ready(i_id_car)
                    LOOP
                        l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                                         i_prof,
                                                                                         drs.id_state,
                                                                                         l_next_drs_state);
                    
                        IF (l_state_transition_ok)
                        THEN
                            UPDATE drug_req_supply drs1
                               SET drs1.id_state = l_next_drs_state
                             WHERE drs1.id_drug_req_supply = drs.id_drug_req_supply;
                        
                            INSERT INTO drug_req_sup_state_transition
                                (id_drug_req_supply, id_state, id_prof, dt_state)
                            VALUES
                                (drs.id_drug_req_supply, l_next_drs_state, i_prof.id, l_datetime);
                        ELSE
                            RAISE g_ex_invalid_st_transition;
                        END IF;
                    END LOOP;
                
                ELSIF (i_begin_or_end = 'BD')
                THEN
                    --[MEDICATION_RULE] (10-09-2009) check if all supplies are ready for transport (devolution)
                    FOR drsd IN c_drds_begin(i_id_car)
                    LOOP
                        l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                                         i_prof,
                                                                                         drsd.id_state,
                                                                                         l_next_drs_state);
                    
                        IF (l_state_transition_ok)
                        THEN
                            UPDATE drug_req_supply_dev drsd1
                               SET drsd1.id_state = l_next_drs_state
                             WHERE drsd1.id_drug_req_supply_dev = drsd.id_drug_req_supply_dev;
                        
                            INSERT INTO drug_req_sup_dev_state_trans
                                (id_drug_req_supply_dev, id_state, id_prof, dt_state)
                            VALUES
                                (drsd.id_drug_req_supply_dev, l_next_drs_state, i_prof.id, l_datetime);
                        ELSE
                            RAISE g_ex_invalid_st_transition;
                        END IF;
                    END LOOP;
                
                ELSIF (i_begin_or_end = 'ED')
                THEN
                    --[MEDICATION_RULE] (10-09-2009) check if all supplies are ready for transport - end (devolution)
                    FOR drsd IN c_drds_end(i_id_car)
                    LOOP
                        l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                                         i_prof,
                                                                                         drsd.id_state,
                                                                                         l_next_drs_state);
                    
                        IF (l_state_transition_ok)
                        THEN
                            UPDATE drug_req_supply_dev drsd1
                               SET drsd1.id_state = l_next_drs_state
                             WHERE drsd1.id_drug_req_supply_dev = drsd.id_drug_req_supply_dev;
                        
                            INSERT INTO drug_req_sup_dev_state_trans
                                (id_drug_req_supply_dev, id_state, id_prof, dt_state)
                            VALUES
                                (drsd.id_drug_req_supply_dev, l_next_drs_state, i_prof.id, l_datetime);
                        ELSE
                            RAISE g_ex_invalid_st_transition;
                        END IF;
                    END LOOP;
                END IF;
            
            ELSE
                RAISE g_ex_invalid_st_transition;
            END IF;
        
        ELSIF (i_begin_or_end = 'TD')
        THEN
            --terminate dev (unidose car)
        
            pk_types.open_my_cursor(o_reqs_not_ready);
            pk_types.open_my_cursor(o_headers);
        
            l_next_car_state := get_state_for_req_type(i_prof, NULL, g_uni_car_end_st);
        
            SELECT uc.id_state
              INTO l_current_car_state
              FROM pharm_unidose_car uc
             WHERE uc.id_unidose_car = i_id_car;
        
            l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                             i_prof,
                                                                             l_current_car_state,
                                                                             l_next_car_state);
        
            IF (l_state_transition_ok)
            THEN
                --end of car circuit!!
                UPDATE pharm_unidose_car uc
                   SET uc.id_state = l_next_car_state
                 WHERE uc.id_unidose_car = i_id_car;
            
                INSERT INTO pharm_unidose_car_state_trans
                    (id_unidose_car, id_state, id_prof, dt_state)
                VALUES
                    (i_id_car, l_next_car_state, i_prof.id, l_datetime);
            ELSE
                RAISE g_ex_invalid_st_transition;
            END IF;
        
            --in car devolutions (for popups)
            OPEN o_devs_in_car FOR
                SELECT /*+ cardinality (x1 1) */
                 drsd.id_drug_req_supply_dev, dr.id_episode
                  FROM drug_req_supply_dev drsd
                 INNER JOIN drug_req_supply drs
                    ON (drsd.id_drug_req_supply = drs.id_drug_req_supply)
                 INNER JOIN drug_req_det drd
                    ON (drs.id_drug_req_det = drd.id_drug_req_det)
                 INNER JOIN TABLE(get_orders_for_car(i_id_car)) x1
                    ON (drd.id_drug_req_det = x1.id_drug_req_det)
                 INNER JOIN drug_req dr
                    ON (drd.id_drug_req = dr.id_drug_req)
                 WHERE drsd.id_state = get_state_for_req_type(i_prof, NULL, g_drs_returned_st);
        
        END IF;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            IF (c_drs%ISOPEN)
            THEN
                CLOSE c_drs;
            END IF;
            IF (c_drs_ready%ISOPEN)
            THEN
                CLOSE c_drs_ready;
            END IF;
            IF (c_drds_begin%ISOPEN)
            THEN
                CLOSE c_drds_begin;
            END IF;
            IF (c_drds_end%ISOPEN)
            THEN
                CLOSE c_drds_end;
            END IF;
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'set_car_transport', o_error);
            pk_utils.undo_changes;
            pk_types.open_my_cursor(o_reqs_not_ready);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_devs_in_car);
            RETURN FALSE;
    END set_car_transport;

    /********************************************************************************************
    * alert.pk_pharmacy.get_status_pipe_str
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_STATE                      IN    NUMBER(5)
    * @param  I_PROF_CAT_TYPE                 IN    VARCHAR2
    * @param  I_DT                            IN    TIMESTAMP WITH LOCAL TIME ZONE
    * @param  I_SHORTCUT                      IN    VARCHAR2
    * @param  I_TEXT                          IN    VARCHAR2
    * @param  I_SEND_CURR_DT                  IN    VARCHAR2
    *
    * @return VARCHAR2
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-02
    *
    ********************************************************************************************/
    FUNCTION get_status_pipe_str
    (
        i_lang          IN language.id_language%TYPE,
        i_prof          IN profissional,
        i_id_state      IN wfl_state.id_state%TYPE,
        i_prof_cat_type IN VARCHAR2,
        i_dt            IN TIMESTAMP WITH LOCAL TIME ZONE DEFAULT NULL,
        i_shortcut      IN VARCHAR2 DEFAULT '',
        i_text          IN VARCHAR2 DEFAULT '',
        i_send_curr_dt  IN VARCHAR2 DEFAULT 'N'
    ) RETURN VARCHAR2 IS
        l_status             VARCHAR2(500 CHAR);
        l_pipe               VARCHAR2(1 CHAR) := '|';
        l_date               VARCHAR2(20 CHAR) := '';
        l_current_date       VARCHAR2(20 CHAR) := '';
        l_text_color_delayed VARCHAR2(10 CHAR) := '0xEBEBC8';
        l_text_color_early   VARCHAR2(10 CHAR) := '0x787864';
        l_text_color         VARCHAR2(10 CHAR) := '';
        l_current_tstz       TIMESTAMP WITH LOCAL TIME ZONE;
    BEGIN
        l_current_tstz := current_timestamp;
    
        IF (i_dt IS NOT NULL)
        THEN
            l_date := pk_date_utils.date_send_tsz(i_lang, i_dt, i_prof);
        END IF;
    
        IF (i_send_curr_dt = g_yes)
        THEN
            l_current_date := pk_date_utils.date_send_tsz(i_lang, l_current_tstz, i_prof);
        END IF;
    
        IF (i_dt IS NOT NULL AND i_send_curr_dt = g_yes)
        THEN
            IF (i_dt < l_current_tstz)
            THEN
                l_text_color := l_text_color_delayed;
            ELSE
                l_text_color := l_text_color_early;
            END IF;
        END IF;
    
        SELECT nvl(i_shortcut, '') || l_pipe || --shortcut
               wsd.icon_type || l_pipe || --display type [I | T | TI | D | DI ]
               l_date || l_pipe || --date
               i_text || l_pipe || --text  ???
               wsd.icon_name || l_pipe || --icon name
               wsd.icon_bg_color || l_pipe || --icon background color
               decode(wsd.icon_type,
                      'D',
                      'SmallWorkflowTime',
                      'TI',
                      'MedicationStatus',
                      'T',
                      'WorkflowMessageSelected',
                      'StatusMessage') || l_pipe || --message style
               decode(wsd.state_can_be_delayed, g_yes, l_text_color, l_text_color_early) || l_pipe || --message color
               '' || l_pipe || --icon color
               l_current_date -- current date time (date server)
          INTO l_status
          FROM wfl_state_detail wsd
         WHERE wsd.state = i_id_state
           AND wsd.prof_type = i_prof_cat_type;
    
        RETURN l_status;
    
    EXCEPTION
        WHEN no_data_found THEN
            RETURN NULL;
        WHEN OTHERS THEN
            RAISE;
    END get_status_pipe_str;

    /********************************************************************************************
    * alert.pk_pharmacy.get_icon_for_req_type
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_FLG_TYPE                      IN    VARCHAR2
    * @param  I_SHORTCUT                      IN    VARCHAR2
    *
    * @return VARCHAR2
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-02
    *
    ********************************************************************************************/
    FUNCTION get_icon_for_req_type
    (
        i_lang     IN language.id_language%TYPE,
        i_prof     IN profissional,
        i_flg_type IN drug_req.flg_type%TYPE,
        i_shortcut IN VARCHAR2
    ) RETURN VARCHAR2 DETERMINISTIC IS
        l_status    VARCHAR2(500 CHAR);
        l_pipe      VARCHAR2(1 CHAR) := '|';
        l_icon_name VARCHAR2(50 CHAR);
    BEGIN
        l_icon_name := CASE i_flg_type
                           WHEN 'A' THEN
                            'PharmOthers'
                           WHEN 'I' THEN
                            'LocalPharmacyIcon'
                           WHEN 'U' THEN
                            'PharmUnidose'
                           ELSE
                            ''
                       END;
    
        l_status := i_shortcut || l_pipe || 'I' || l_pipe || l_pipe || l_pipe || l_icon_name || l_pipe || l_pipe ||
                    l_pipe || l_pipe || l_pipe;
    
        RETURN l_status;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_icon_for_req_type;

    /********************************************************************************************
    * alert.pk_pharmacy.pharmacy_pending_list
    *
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    *
    * @return ALERT.T_TBL_PHARM_PEND
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-02
    *
    ********************************************************************************************/
    FUNCTION pharmacy_pending_list(i_prof IN alert.profissional) RETURN t_tbl_pharm_pend
        PIPELINED IS
        l_exec_state_adm wfl_state.id_state%TYPE;
        l_exec_state_int wfl_state.id_state%TYPE;
        l_exec_state_uni wfl_state.id_state%TYPE;
        l_dep_clin_servs table_number;
        l_dcs_count      NUMBER := 0;
        l_grid_states    table_number;
    BEGIN
        l_exec_state_adm := get_state_for_req_type(i_prof, g_flg_adm, g_drd_executing_st);
        l_exec_state_int := get_state_for_req_type(i_prof, g_flg_int, g_drd_executing_st);
        l_exec_state_uni := get_state_for_req_type(i_prof, g_flg_unidose, g_drd_executing_st);
    
        get_allocation_for_prof(i_prof, l_dep_clin_servs);
        l_dcs_count := l_dep_clin_servs.count;
    
        l_grid_states := get_states_for_req_type(i_prof, NULL, table_varchar(g_drs_preparing_st, g_drs_canceled_st));
    
        FOR row_i IN (SELECT v1.id_patient, v1.id_episode, v1.flg_type, v1.id_state, v1.dt_req
                        FROM (SELECT p.id_patient,
                                     e.id_episode,
                                     dr.flg_type,
                                     drs.id_state,
                                     MIN(dr.dt_drug_req_tstz) dt_req
                                FROM drug_req_supply drs, drug_req_det drd, drug_req dr, episode e, visit v, patient p
                               WHERE drs.id_drug_req_det = drd.id_drug_req_det
                                 AND drd.id_drug_req = dr.id_drug_req
                                 AND dr.id_episode = e.id_episode
                                 AND e.id_visit = v.id_visit
                                 AND dr.id_patient = p.id_patient
                                 AND drs.id_state IN (SELECT column_value
                                                        FROM TABLE(l_grid_states))
                                 AND v.id_institution = i_prof.institution
                                 AND v.flg_status != 'C' -- not canceled
                                 AND drd.id_state = l_exec_state_adm
                                 AND e.flg_status = decode(dr.flg_type, g_flg_int, e.flg_status, 'A') -- active episode whenever flg_type <> flg_int
                                 AND dr.flg_type = g_flg_adm
                                 AND get_grid_timeout(drs.id_state, i_prof, 'D') >
                                     pk_date_utils.get_timestamp_diff(current_timestamp, dr.dt_drug_req_tstz)
                               GROUP BY p.id_patient, e.id_episode, dr.flg_type, drs.id_state
                              UNION ALL
                              SELECT p.id_patient,
                                     e.id_episode,
                                     dr.flg_type,
                                     drs.id_state,
                                     MIN(dr.dt_drug_req_tstz) dt_req
                                FROM drug_req_supply drs, drug_req_det drd, drug_req dr, episode e, visit v, patient p
                               WHERE drs.id_drug_req_det = drd.id_drug_req_det
                                 AND drd.id_drug_req = dr.id_drug_req
                                 AND dr.id_episode = e.id_episode
                                 AND e.id_visit = v.id_visit
                                 AND dr.id_patient = p.id_patient
                                 AND drs.id_state IN (SELECT column_value
                                                        FROM TABLE(l_grid_states))
                                 AND v.id_institution = i_prof.institution
                                 AND v.flg_status != 'C' -- not canceled
                                 AND drd.id_state = l_exec_state_int
                                 AND e.flg_status = decode(dr.flg_type, g_flg_int, e.flg_status, 'A') -- active episode whenever flg_type <> flg_int
                                 AND dr.flg_type = g_flg_int
                                 AND get_grid_timeout(drs.id_state, i_prof, 'D') >
                                     pk_date_utils.get_timestamp_diff(current_timestamp, dr.dt_drug_req_tstz)
                               GROUP BY p.id_patient, e.id_episode, dr.flg_type, drs.id_state
                              UNION ALL
                              SELECT p.id_patient,
                                     e.id_episode,
                                     dr.flg_type,
                                     drs.id_state,
                                     MIN(dr.dt_drug_req_tstz) dt_req
                                FROM drug_req_supply drs, drug_req_det drd, drug_req dr, episode e, visit v, patient p
                               WHERE drs.id_drug_req_det = drd.id_drug_req_det
                                 AND drd.id_drug_req = dr.id_drug_req
                                 AND dr.id_episode = e.id_episode
                                 AND e.id_visit = v.id_visit
                                 AND dr.id_patient = p.id_patient
                                 AND drs.id_state IN (SELECT column_value
                                                        FROM TABLE(l_grid_states))
                                 AND v.id_institution = i_prof.institution
                                 AND v.flg_status != 'C' -- not canceled
                                 AND drd.id_state = l_exec_state_uni
                                 AND e.flg_status = decode(dr.flg_type, g_flg_int, e.flg_status, 'A') -- active episode whenever flg_type <> flg_int
                                 AND dr.flg_type = g_flg_unidose
                                 AND get_grid_timeout(drs.id_state, i_prof, 'D') >
                                     pk_date_utils.get_timestamp_diff(current_timestamp, dr.dt_drug_req_tstz)
                               GROUP BY p.id_patient, e.id_episode, dr.flg_type, drs.id_state) v1,
                             epis_info ei
                       WHERE
                      --filter orders by id_dep_clin_server (pharmacist allocation to departments/services)
                       v1.id_episode = ei.id_episode
                   AND (l_dcs_count = 0 OR ei.id_dep_clin_serv IS NULL OR
                       ei.id_dep_clin_serv IN (SELECT column_value
                                                  FROM TABLE(l_dep_clin_servs)))
                      --
                      )
        LOOP
            PIPE ROW(t_rec_pharm_pend(row_i.id_patient, row_i.id_episode, row_i.flg_type, row_i.id_state, row_i.dt_req));
        END LOOP;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END pharmacy_pending_list;

    /********************************************************************************************
    * alert.pk_pharmacy.pharmacy_list
    *
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_REQ_TYPE                      IN    VARCHAR2
    *
    * @return ALERT.T_TBL_PHARM_ADM_INT
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-02
    *
    ********************************************************************************************/
    FUNCTION pharmacy_list
    (
        i_prof             IN alert.profissional,
        i_req_type         IN drug_req.flg_type%TYPE,
        i_show_devolutions IN VARCHAR2 DEFAULT 'N'
    ) RETURN t_tbl_pharm_adm_int
        PIPELINED IS
        l_dep_clin_servs table_number;
        l_dcs_count      NUMBER := 0;
        l_grid_states    table_number;
    BEGIN
        get_allocation_for_prof(i_prof, l_dep_clin_servs);
        l_dcs_count := l_dep_clin_servs.count;
    
        l_grid_states := get_grid_allowed_states(i_prof, i_req_type, 'GRID_1');
    
        IF (i_show_devolutions = g_no)
        THEN
        
            FOR row_i IN (SELECT v1.id_patient,
                                 v1.id_episode,
                                 v1.flg_type,
                                 v1.x_state id_state,
                                 SUM(pharmacy_idx_func_dr_has_notes(v1.notes_req)) has_notes,
                                 MIN(v1.dt_state) dt_req
                            FROM (SELECT p.id_patient,
                                         e.id_episode,
                                         dr.flg_type,
                                         get_prioritary_state(i_prof, drd.id_drug_req_det, drd.id_state, i_req_type) x_state,
                                         dr.notes_req,
                                         drdst.dt_state
                                    FROM drug_req_det                  drd,
                                         drug_req                      dr,
                                         episode                       e,
                                         visit                         v,
                                         patient                       p,
                                         drug_req_det_state_transition drdst,
                                         epis_info                     ei
                                   WHERE drd.id_drug_req = dr.id_drug_req
                                     AND dr.id_episode = e.id_episode
                                     AND e.id_visit = v.id_visit
                                     AND dr.id_patient = p.id_patient
                                     AND v.id_institution = i_prof.institution
                                     AND v.flg_status != 'C' -- not canceled
                                     AND e.flg_status = decode(dr.flg_type, g_flg_int, e.flg_status, 'A') -- active episode whenever flg_type <> flg_int
                                     AND drd.id_state IN (SELECT column_value
                                                            FROM TABLE(l_grid_states))
                                     AND dr.flg_type = i_req_type
                                     AND drd.id_drug_req_det = drdst.id_drug_req_det
                                     AND drd.id_state = drdst.id_state
                                        --filter orders by id_dep_clin_server (pharmacist allocation to departments/services)
                                     AND e.id_episode = ei.id_episode
                                     AND (l_dcs_count = 0 OR ei.id_dep_clin_serv IS NULL OR
                                         ei.id_dep_clin_serv IN (SELECT column_value
                                                                    FROM TABLE(l_dep_clin_servs)))
                                  --
                                  ) v1
                           GROUP BY v1.id_patient, v1.id_episode, v1.flg_type, v1.x_state)
            LOOP
                PIPE ROW(t_rec_pharm_adm_int(row_i.id_patient,
                                             row_i.id_episode,
                                             row_i.flg_type,
                                             row_i.id_state,
                                             row_i.has_notes,
                                             row_i.dt_req));
            END LOOP;
        
        ELSE
        
            FOR row_i IN (SELECT v1.id_patient,
                                 v1.id_episode,
                                 v1.flg_type,
                                 v1.x_state id_state,
                                 SUM(pharmacy_idx_func_dr_has_notes(v1.notes_req)) has_notes,
                                 MIN(v1.dt_state) dt_req
                            FROM (SELECT p.id_patient,
                                         e.id_episode,
                                         dr.flg_type,
                                         get_prioritary_state(i_prof, drd.id_drug_req_det, drd.id_state, i_req_type) x_state,
                                         dr.notes_req,
                                         drdst.dt_state
                                    FROM drug_req_det                  drd,
                                         drug_req                      dr,
                                         episode                       e,
                                         visit                         v,
                                         patient                       p,
                                         drug_req_det_state_transition drdst,
                                         epis_info                     ei
                                   WHERE drd.id_drug_req = dr.id_drug_req
                                     AND dr.id_episode = e.id_episode
                                     AND e.id_visit = v.id_visit
                                     AND dr.id_patient = p.id_patient
                                     AND v.id_institution = i_prof.institution
                                     AND v.flg_status != 'C' -- not canceled
                                     AND e.flg_status = decode(dr.flg_type, g_flg_int, e.flg_status, 'A') -- active episode whenever flg_type <> flg_int
                                     AND drd.id_state IN (SELECT column_value
                                                            FROM TABLE(l_grid_states))
                                     AND dr.flg_type = i_req_type
                                     AND drd.id_drug_req_det = drdst.id_drug_req_det
                                     AND drd.id_state = drdst.id_state
                                        --filter orders by id_dep_clin_server (pharmacist allocation to departments/services)
                                     AND e.id_episode = ei.id_episode
                                     AND (l_dcs_count = 0 OR ei.id_dep_clin_serv IS NULL OR
                                         ei.id_dep_clin_serv IN (SELECT column_value
                                                                    FROM TABLE(l_dep_clin_servs)))
                                  --
                                  UNION ALL
                                  --"devolutions"
                                  SELECT p.id_patient,
                                         e.id_episode,
                                         dr.flg_type,
                                         get_prioritary_state(i_prof,
                                                              NULL,
                                                              drsd.id_state,
                                                              i_req_type,
                                                              drsd.id_drug_req_supply_dev) x_state,
                                         dr.notes_req,
                                         drsdst.dt_state
                                    FROM drug_req_supply_dev          drsd,
                                         drug_req_supply              drs,
                                         drug_req_det                 drd,
                                         drug_req                     dr,
                                         episode                      e,
                                         visit                        v,
                                         patient                      p,
                                         drug_req_sup_dev_state_trans drsdst,
                                         epis_info                    ei
                                   WHERE drsd.id_drug_req_supply = drs.id_drug_req_supply
                                     AND drs.id_drug_req_det = drd.id_drug_req_det
                                     AND drd.id_drug_req = dr.id_drug_req
                                     AND dr.id_episode = e.id_episode
                                     AND e.id_visit = v.id_visit
                                     AND dr.id_patient = p.id_patient
                                     AND v.id_institution = i_prof.institution
                                     AND v.flg_status != 'C' -- not canceled
                                     AND e.flg_status = decode(dr.flg_type, g_flg_int, e.flg_status, 'A') -- active episode whenever flg_type <> flg_int
                                     AND drd.id_state IN (SELECT column_value
                                                            FROM TABLE(l_grid_states))
                                     AND dr.flg_type = i_req_type
                                     AND drsd.id_drug_req_supply_dev = drsdst.id_drug_req_supply_dev
                                     AND drsd.id_state = drsdst.id_state
                                        --filter orders by id_dep_clin_server (pharmacist allocation to departments/services)
                                     AND e.id_episode = ei.id_episode
                                     AND (l_dcs_count = 0 OR ei.id_dep_clin_serv IS NULL OR
                                         ei.id_dep_clin_serv IN (SELECT column_value
                                                                    FROM TABLE(l_dep_clin_servs)))
                                  --
                                  ) v1
                           GROUP BY v1.id_patient, v1.id_episode, v1.flg_type, v1.x_state)
            LOOP
                PIPE ROW(t_rec_pharm_adm_int(row_i.id_patient,
                                             row_i.id_episode,
                                             row_i.flg_type,
                                             row_i.id_state,
                                             row_i.has_notes,
                                             row_i.dt_req));
            END LOOP;
        END IF;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END pharmacy_list;

    /********************************************************************************************
    * alert.pk_pharmacy.pharmacist_pend_grid
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_PROF_CAT_TYPE                 IN    VARCHAR2
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  O_REQ                           OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-02
    *
    ********************************************************************************************/
    FUNCTION pharmacist_pend_grid
    (
        i_lang          IN language.id_language%TYPE,
        i_prof          IN alert.profissional,
        i_prof_cat_type IN category.flg_type%TYPE,
        i_get_headers   IN VARCHAR2 DEFAULT 'N',
        i_header_codes  IN table_varchar DEFAULT NULL,
        o_req           OUT pk_types.cursor_type,
        o_headers       OUT pk_types.cursor_type,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
        l_shortcut sys_shortcut.id_sys_shortcut%TYPE;
    BEGIN
        g_error    := 'GET SHORTCUT';
        l_shortcut := get_shortcut(i_lang, i_prof, 'PHARMACIST_PENDENT');
    
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error := 'GET CURSOR';
        OPEN o_req FOR
            SELECT v1.id_patient,
                   get_pat_name(i_lang, i_prof, v1.id_patient) name,
                   pk_adt.get_pat_non_disc_options(i_lang, i_prof, v1.id_patient) pat_ndo,
                   pk_adt.get_pat_non_disclosure_icon(i_lang, i_prof, v1.id_patient) pat_nd_icon,
                   pk_patient.get_pat_name_to_sort(i_lang, i_prof, v1.id_patient, v1.id_episode) pat_name_to_sort,
                   p2.gender,
                   pk_patient.get_pat_age(i_lang, v1.id_patient, i_prof) pat_age,
                   pk_patphoto.get_pat_photo(i_lang, i_prof, v1.id_patient, v1.id_episode, NULL) photo,
                   get_pat_location(i_lang, i_prof, v1.id_episode, v1.id_patient) pat_location,
                   pk_date_utils.date_send_tsz(i_lang, v1.dt_req, i_prof) date_target,
                   get_icon_for_req_type(i_lang, i_prof, v1.flg_type, l_shortcut) flg_status,
                   get_status_pipe_str(i_lang, i_prof, v1.id_state, i_prof_cat_type, v1.dt_req, l_shortcut, '', g_yes) pend_status,
                   get_pat_clin_record(i_lang, p2.id_patient, i_prof.institution) num_clin_record,
                   v1.id_episode --para o header
              FROM patient p2, TABLE(pharmacy_pending_list(i_prof)) v1
             WHERE p2.id_patient = v1.id_patient
             ORDER BY pat_name_to_sort, v1.dt_req;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'PHARMACIST_PEND_GRID', o_error);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_req);
            RETURN FALSE;
    END pharmacist_pend_grid;

    /********************************************************************************************
    * alert.pk_pharmacy.get_pat_req_all
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PATIENT                       IN    NUMBER(24)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_PROF_CAT_TYPE                 IN    VARCHAR2
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  I_GET_ACTIONS                   IN    VARCHAR2
    * @param  I_FLG_HIST                      IN    VARCHAR2
    * @param  I_ID_EPISODE                    IN    NUMBER(24)
    * @param  O_FLG_OLD_EPIS                  OUT   VARCHAR2
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_ACTIONS                       OUT   REF CURSOR
    * @param  O_DRUG_ADM                      OUT   REF CURSOR
    * @param  O_DRUG_INT                      OUT   REF CURSOR
    * @param  O_DRUG_UNI                      OUT   REF CURSOR
    * @param  O_DRUG_PEND                     OUT   REF CURSOR
    * @param  O_DRUG_DEV_ADM                  OUT   REF CURSOR
    * @param  O_DRUG_DEV_INT                  OUT   REF CURSOR
    * @param  O_DRUG_DEV_UNI                  OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.7
    * @since  2010-02-24
    *
    ********************************************************************************************/
    FUNCTION get_pat_req_all
    (
        i_lang          IN language.id_language%TYPE,
        i_patient       IN patient.id_patient%TYPE,
        i_prof          IN alert.profissional,
        i_prof_cat_type IN category.flg_type%TYPE,
        i_get_headers   IN VARCHAR2 DEFAULT 'N',
        i_header_codes  IN table_varchar DEFAULT NULL,
        i_get_actions   IN VARCHAR2 DEFAULT 'N',
        i_flg_hist      IN VARCHAR2 DEFAULT 'N',
        i_id_episode    IN episode.id_episode%TYPE DEFAULT NULL,
        o_flg_old_epis  OUT VARCHAR2,
        o_headers       OUT pk_types.cursor_type,
        o_actions       OUT pk_types.cursor_type,
        o_drug_adm      OUT pk_types.cursor_type,
        o_drug_int      OUT pk_types.cursor_type,
        o_drug_uni      OUT pk_types.cursor_type,
        o_drug_pend     OUT pk_types.cursor_type,
        o_drug_dev_adm  OUT pk_types.cursor_type,
        o_drug_dev_int  OUT pk_types.cursor_type,
        o_drug_dev_uni  OUT pk_types.cursor_type,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
        l_ret_value    BOOLEAN := TRUE;
        l_empty_cursor pk_types.cursor_type;
        l_ex_err EXCEPTION;
        l_flg_hist VARCHAR2(1 CHAR);
        l_flg_epis episode.flg_status%TYPE;
    BEGIN
        --history and search
        l_flg_hist := nvl(i_flg_hist, g_no);
    
        --check if the episode is "old" or is the current active episode
        IF (l_flg_hist = g_no)
        THEN
            o_flg_old_epis := g_no;
        ELSE
            SELECT e.flg_status
              INTO l_flg_epis
              FROM episode e
             WHERE e.id_episode = i_id_episode;
        
            IF (l_flg_epis = 'A')
            THEN
                o_flg_old_epis := g_no;
            ELSE
                o_flg_old_epis := g_yes;
            END IF;
        END IF;
        --
    
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error := 'GET ACTIONS';
        get_pharmacy_actions(i_lang, i_prof, i_get_actions, g_grid_actions_all_pat, o_actions);
    
        l_ret_value :=    --ADM
         get_pat_req(i_lang          => i_lang,
                                   i_patient       => i_patient,
                                   i_req_type      => g_flg_adm,
                                   i_prof          => i_prof,
                                   i_prof_cat_type => i_prof_cat_type,
                                   i_flg_hist      => l_flg_hist,
                                   i_id_episode    => i_id_episode,
                                   o_drug          => o_drug_adm,
                                   o_drug_dev      => o_drug_dev_adm,
                                   o_drug_hist     => l_empty_cursor, --empty
                                   o_headers       => l_empty_cursor, --empty
                                   o_actions       => l_empty_cursor, --empty
                                   o_other_prescs  => l_empty_cursor, --empty
                                   o_error         => o_error) OR l_ret_value;
    
        l_ret_value :=    --INT
         get_pat_req(i_lang          => i_lang,
                                   i_patient       => i_patient,
                                   i_req_type      => g_flg_int,
                                   i_prof          => i_prof,
                                   i_prof_cat_type => i_prof_cat_type,
                                   i_flg_hist      => l_flg_hist,
                                   i_id_episode    => i_id_episode,
                                   o_drug          => o_drug_int,
                                   o_drug_dev      => o_drug_dev_int,
                                   o_drug_hist     => l_empty_cursor, --empty
                                   o_headers       => l_empty_cursor, --empty
                                   o_actions       => l_empty_cursor, --empty
                                   o_other_prescs  => l_empty_cursor, --empty
                                   o_error         => o_error) OR l_ret_value;
    
        l_ret_value :=    --UNIDOSE
         get_pat_req(i_lang          => i_lang,
                                   i_patient       => i_patient,
                                   i_req_type      => g_flg_unidose,
                                   i_prof          => i_prof,
                                   i_prof_cat_type => i_prof_cat_type,
                                   i_flg_hist      => l_flg_hist,
                                   i_id_episode    => i_id_episode,
                                   o_drug          => o_drug_uni,
                                   o_drug_dev      => o_drug_dev_uni,
                                   o_drug_hist     => l_empty_cursor, --empty
                                   o_headers       => l_empty_cursor, --empty
                                   o_actions       => l_empty_cursor, --empty
                                   o_other_prescs  => l_empty_cursor,
                                   o_error         => o_error) OR l_ret_value;
    
        l_ret_value :=    --PENDENTES
         get_pat_req_pend(i_lang          => i_lang,
                                        i_patient       => i_patient,
                                        i_prof          => i_prof,
                                        i_prof_cat_type => i_prof_cat_type,
                                        i_flg_hist      => l_flg_hist,
                                        i_id_episode    => i_id_episode,
                                        o_drug          => o_drug_pend,
                                        o_headers       => l_empty_cursor, --empty
                                        o_actions       => l_empty_cursor, --empty
                                        o_error         => o_error) OR l_ret_value;
    
        IF (NOT l_ret_value)
        THEN
            RAISE l_ex_err; --err (at least one of the functions returned false!)
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'GET_PAT_REQ_ALL', o_error);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_actions);
            pk_types.open_my_cursor(o_drug_adm);
            pk_types.open_my_cursor(o_drug_int);
            pk_types.open_my_cursor(o_drug_uni);
            pk_types.open_my_cursor(o_drug_pend);
            RETURN FALSE;
    END get_pat_req_all;

    /********************************************************************************************
    * alert.pk_pharmacy.get_pat_req
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PATIENT                       IN    NUMBER(24)
    * @param  I_REQ_TYPE                      IN    VARCHAR2
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_PROF_CAT_TYPE                 IN    VARCHAR2
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  I_GET_ACTIONS                   IN    VARCHAR2
    * @param  I_FLG_HIST                      IN    VARCHAR2
    * @param  I_ID_EPISODE                    IN    NUMBER(24)
    * @param  O_DRUG                          OUT   REF CURSOR
    * @param  O_DRUG_DEV                      OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_ACTIONS                       OUT   REF CURSOR
    * @param  O_OTHER_PRESCS                  OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7
    * @since  2009-11-10
    *
    ********************************************************************************************/
    FUNCTION get_pat_req
    (
        i_lang          IN language.id_language%TYPE,
        i_patient       IN patient.id_patient%TYPE,
        i_req_type      IN drug_req.flg_type%TYPE,
        i_prof          IN alert.profissional,
        i_prof_cat_type IN category.flg_type%TYPE,
        i_get_headers   IN VARCHAR2 DEFAULT 'N',
        i_header_codes  IN table_varchar DEFAULT NULL,
        i_get_actions   IN VARCHAR2 DEFAULT 'N',
        i_flg_hist      IN VARCHAR2 DEFAULT 'N',
        i_id_episode    IN episode.id_episode%TYPE DEFAULT NULL,
        o_drug          OUT pk_types.cursor_type,
        o_drug_dev      OUT pk_types.cursor_type,
        o_drug_hist     OUT pk_types.cursor_type,
        o_headers       OUT pk_types.cursor_type,
        o_actions       OUT pk_types.cursor_type,
        o_other_prescs  OUT pk_types.cursor_type,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
        l_prof_type     profile_template.flg_type%TYPE;
        l_flg_hist      VARCHAR2(1 CHAR);
        l_grid_states   table_number;
        l_grid_state_r  wfl_state.id_state%TYPE;
        l_grid_states_t table_number;
        l_grid_states_n table_number;
        l_grid_states_1 table_number;
        l_grid_states_2 table_number;
    BEGIN
        --history and search
        l_flg_hist := nvl(i_flg_hist, g_no);
    
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error := 'GET ACTIONS';
        get_pharmacy_actions(i_lang, i_prof, i_get_actions, get_grid_actions(i_req_type), o_actions);
    
        g_error     := 'GET PROF TYPE';
        l_prof_type := get_prof_type(i_prof);
    
        l_grid_states   := get_grid_allowed_states(i_prof, i_req_type, 'GRID_PAT');
        l_grid_state_r  := get_state_for_req_type(i_prof, i_req_type, g_drd_requested_st);
        l_grid_states_n := get_states_for_req_type(i_prof,
                                                   i_req_type,
                                                   table_varchar(g_drd_executing_st,
                                                                 g_drd_terminated_st,
                                                                 g_drd_rejected2prep_st,
                                                                 g_drd_validated_without_wf_st));
        l_grid_states_1 := get_states_for_req_type(i_prof, NULL, g_grid_pat_drs_adm_states);
        l_grid_states_2 := get_states_for_req_type(i_prof,
                                                   NULL,
                                                   table_varchar(g_drs_to_return_st,
                                                                 g_drs_returning_st,
                                                                 g_drs_returned_st,
                                                                 g_drs_return_end_st));
    
        IF (i_id_episode IS NULL)
        THEN
            --history
        
            g_error := 'QUERY O_DRUG';
            OPEN o_drug FOR
                SELECT v1.id_drug_req_det,
                       v1.id_state,
                       get_drug_desc_pharm(i_lang,
                                           i_prof,
                                           v1.id_episode,
                                           v1.id_drug_req_det,
                                           'N',
                                           'N',
                                           'PHARMACY_FORMAT') pharm,
                       get_status_pipe_str(i_lang,
                                           i_prof,
                                           v1.id_state,
                                           i_prof_cat_type,
                                           v1.drdst2_dt_state,
                                           '0',
                                           '',
                                           g_yes) desc_stat,
                       get_attention_pipe_str(i_lang, i_prof, v1.id_drug_req_det) attention,
                       pk_date_utils.date_send_tsz(i_lang, v1.drdst_dt_state, i_prof) req_date,
                       get_icon_for_req_type(i_lang, i_prof, i_req_type, '') flg_type_icon,
                       NULL pend_type, --needed by flash to merge cursors --get_pat_req_all
                       i_req_type flg_type_req,
                       'REQ' req_dev,
                       check_presc_justification(i_lang, i_prof, v1.id_drug_req_det) flg_justify,
                       check_presc_justification(i_lang, i_prof, v1.id_drug_req_det, g_yes) show_justify
                  FROM (SELECT v2.id_drug_req_det,
                               v2.id_state,
                               v2.id_episode,
                               v2.drdst_dt_state,
                               MAX(v2.drdst2_dt_state) drdst2_dt_state
                          FROM (SELECT drd.id_drug_req_det,
                                       drd.id_state,
                                       e.id_episode,
                                       drdst.dt_state      drdst_dt_state,
                                       drdst2.dt_state     drdst2_dt_state
                                  FROM drug_req_det                  drd,
                                       drug_req                      dr,
                                       episode                       e,
                                       visit                         v,
                                       patient                       p,
                                       drug_req_det_state_transition drdst,
                                       drug_req_det_state_transition drdst2
                                 WHERE drd.id_drug_req = dr.id_drug_req
                                   AND dr.id_episode = e.id_episode
                                   AND e.id_visit = v.id_visit
                                   AND dr.id_patient = p.id_patient
                                   AND v.id_institution = i_prof.institution
                                   AND v.flg_status != 'C' -- not canceled
                                   AND e.flg_status = decode(dr.flg_type, g_flg_int, e.flg_status, 'A') -- active episode whenever flg_type <> flg_int
                                   AND drd.id_state IN (SELECT column_value
                                                          FROM TABLE(l_grid_states))
                                   AND dr.flg_type = i_req_type
                                   AND p.id_patient = i_patient
                                   AND drd.id_drug_req_det = drdst.id_drug_req_det
                                   AND drdst.id_state = l_grid_state_r
                                   AND drd.id_drug_req_det = drdst2.id_drug_req_det(+)
                                   AND drd.id_state = drdst2.id_state(+)
                                   AND row_is_visible(drd.id_state,
                                                      i_prof,
                                                      'D',
                                                      current_timestamp,
                                                      drdst2.dt_state,
                                                      l_flg_hist) = g_yes) v2
                         GROUP BY v2.id_drug_req_det, v2.id_state, v2.id_episode, v2.drdst_dt_state --must get the recent one (drug_req_det_state_transition) --this is because loops on the workflow (reject > prepare > reject > prepara .. and so on)
                        UNION ALL
                        --executing with some supplies or terminated!
                        SELECT v3.id_drug_req_det,
                               v3.id_state,
                               v3.id_episode,
                               v3.drdst_dt_state,
                               MAX(v3.drdst2_dt_state) drdst2_dt_state
                          FROM (SELECT drd.id_drug_req_det,
                                       drs.id_state,
                                       e.id_episode,
                                       drdst.dt_state      drdst_dt_state,
                                       drdst2.dt_state     drdst2_dt_state
                                  FROM drug_req_supply               drs,
                                       drug_req_det                  drd,
                                       drug_req                      dr,
                                       episode                       e,
                                       visit                         v,
                                       patient                       p,
                                       drug_req_det_state_transition drdst,
                                       drug_req_det_state_transition drdst2
                                 WHERE drs.id_drug_req_det = drd.id_drug_req_det
                                   AND drd.id_drug_req = dr.id_drug_req
                                   AND dr.id_episode = e.id_episode
                                   AND e.id_visit = v.id_visit
                                   AND dr.id_patient = p.id_patient
                                   AND v.id_institution = i_prof.institution
                                   AND v.flg_status != 'C' -- not canceled
                                   AND e.flg_status = decode(dr.flg_type, g_flg_int, e.flg_status, 'A') -- active episode whenever flg_type <> flg_int
                                   AND drd.id_state IN (SELECT column_value
                                                          FROM TABLE(l_grid_states_n))
                                   AND dr.flg_type = i_req_type
                                   AND p.id_patient = i_patient
                                   AND drs.id_state IN (SELECT column_value
                                                          FROM TABLE(l_grid_states_1))
                                   AND drd.id_drug_req_det = drdst.id_drug_req_det
                                   AND drdst.id_state = l_grid_state_r
                                   AND drd.id_drug_req_det = drdst2.id_drug_req_det(+)
                                   AND drd.id_state = drdst2.id_state(+)
                                   AND row_is_visible(drd.id_state,
                                                      i_prof,
                                                      'D',
                                                      current_timestamp,
                                                      drdst2.dt_state,
                                                      l_flg_hist) = g_yes
                                 GROUP BY drd.id_drug_req_det,
                                          drs.id_state,
                                          dr.dt_drug_req_tstz,
                                          e.id_episode,
                                          drdst.dt_state,
                                          drdst2.dt_state --group multiple supplies into one request
                                ) v3
                         GROUP BY v3.id_drug_req_det, v3.id_state, v3.id_episode, v3.drdst_dt_state) v1,
                       wfl_state_detail wsd
                 WHERE v1.id_state = wsd.state
                   AND wsd.prof_type = l_prof_type
                 ORDER BY wsd.rank, v1.drdst_dt_state DESC;
        
            --order return
            g_error := 'QUERY O_DRUG_DEV';
            OPEN o_drug_dev FOR
                SELECT drd.id_drug_req_det,
                       drsd.id_state,
                       get_drug_desc_pharm(i_lang,
                                           i_prof,
                                           dr.id_episode,
                                           drd.id_drug_req_det,
                                           'N',
                                           'N',
                                           'PHARMACY_FORMAT') pharm,
                       get_status_pipe_str(i_lang,
                                           i_prof,
                                           drsd.id_state,
                                           i_prof_cat_type,
                                           drsdst.dt_state,
                                           '0',
                                           '',
                                           g_yes) desc_stat,
                       get_attention_pipe_str(i_lang, i_prof, drd.id_drug_req_det) attention,
                       pk_date_utils.date_send_tsz(i_lang, drdst.dt_state, i_prof) req_date,
                       get_icon_for_req_type(i_lang, i_prof, i_req_type, '') flg_type_icon,
                       NULL pend_type, --needed by flash to merge cursors --get_pat_req_all
                       dr.flg_type flg_type_req,
                       'DEV' req_dev,
                       drsd.id_drug_req_supply_dev
                  FROM drug_req_supply_dev           drsd,
                       drug_req_sup_dev_state_trans  drsdst,
                       drug_req_supply               drs,
                       drug_req_det                  drd,
                       drug_req                      dr,
                       episode                       e,
                       visit                         v,
                       drug_req_det_state_transition drdst,
                       wfl_state_detail              wsd
                 WHERE drsd.id_drug_req_supply_dev = drsdst.id_drug_req_supply_dev
                   AND drsd.id_state = drsdst.id_state
                   AND drsd.id_drug_req_supply = drs.id_drug_req_supply
                   AND drs.id_drug_req_det = drd.id_drug_req_det
                   AND drd.id_drug_req = dr.id_drug_req
                   AND dr.flg_type = i_req_type
                   AND dr.id_episode = e.id_episode
                   AND e.id_visit = v.id_visit
                   AND v.flg_status != 'C' -- not canceled
                   AND e.flg_status = decode(dr.flg_type, g_flg_int, e.flg_status, 'A') -- active episode whenever flg_type <> flg_int
                   AND drd.id_drug_req_det = drdst.id_drug_req_det
                   AND drdst.id_state = l_grid_state_r
                   AND drsd.id_state IN (SELECT column_value
                                           FROM TABLE(l_grid_states_2))
                   AND row_is_visible(drsd.id_state, i_prof, 'D', current_timestamp, drsdst.dt_state, l_flg_hist) =
                       g_yes
                   AND dr.id_patient = i_patient
                   AND drsd.id_state = wsd.state
                   AND wsd.prof_type = l_prof_type
                 ORDER BY wsd.rank, drsdst.dt_state DESC;
        
            IF (i_req_type = g_flg_int)
            THEN
                g_error := 'QUERY O_DRUG_HIST';
                OPEN o_drug_hist FOR
                    SELECT v1.id_drug_req_det,
                           v1.drs_id_state,
                           get_drug_desc_pharm(i_lang,
                                               i_prof,
                                               v1.id_episode,
                                               v1.id_drug_req_det,
                                               'N',
                                               'N',
                                               'PHARMACY_FORMAT') pharm,
                           get_status_pipe_str(i_lang,
                                               i_prof,
                                               v1.drs_id_state,
                                               i_prof_cat_type,
                                               v1.drdst_dt_state,
                                               '0',
                                               '',
                                               g_yes) desc_stat,
                           get_attention_pipe_str(i_lang, i_prof, v1.id_drug_req_det) attention,
                           pk_date_utils.date_send_tsz(i_lang, v1.drdst_dt_state, i_prof) req_date,
                           get_icon_for_req_type(i_lang, i_prof, i_req_type, '') flg_type_icon,
                           NULL pend_type, --needed by flash to merge cursors --get_pat_req_all
                           i_req_type flg_type_req,
                           'INT_HIST' req_dev,
                           check_presc_justification(i_lang, i_prof, v1.id_drug_req_det) flg_justify,
                           check_presc_justification(i_lang, i_prof, v1.id_drug_req_det, g_yes) show_justify
                      FROM (SELECT v2.id_drug_req_det,
                                   v2.id_state,
                                   v2.id_episode,
                                   v2.drdst_dt_state,
                                   MAX(v2.drdst2_dt_state) drdst2_dt_state,
                                   v2.drs_id_state
                              FROM (SELECT drd.id_drug_req_det,
                                           drd.id_state,
                                           e.id_episode,
                                           drdst.dt_state      drdst_dt_state,
                                           NULL                drdst2_dt_state,
                                           drs.id_state        drs_id_state
                                      FROM drug_req_det drd
                                     INNER JOIN drug_req dr
                                        ON (drd.id_drug_req = dr.id_drug_req)
                                     INNER JOIN patient p
                                        ON (dr.id_patient = p.id_patient)
                                     INNER JOIN episode e
                                        ON (dr.id_episode = e.id_episode)
                                     INNER JOIN drug_req_det_state_transition drdst
                                        ON (drd.id_drug_req_det = drdst.id_drug_req_det AND
                                           drdst.id_state = l_grid_state_r)
                                     INNER JOIN drug_req_supply drs
                                        ON (drd.id_drug_req_det = drs.id_drug_req_det)
                                     WHERE e.id_institution = i_prof.institution
                                       AND drs.id_state IN
                                           (SELECT column_value
                                              FROM TABLE(get_states_for_req_type(i_prof,
                                                                                 NULL,
                                                                                 table_varchar(g_drs_supplied_st,
                                                                                               g_drs_delivered2pat_st,
                                                                                               g_drs_readyfortransp_st,
                                                                                               g_drs_in_transit_st,
                                                                                               g_drs_uni_ready4transp_st))))
                                       AND dr.flg_type = g_flg_int
                                       AND p.id_patient = i_patient
                                       AND e.id_episode IN
                                           (SELECT column_value
                                              FROM TABLE(get_last_episodes(i_lang, i_prof, i_patient)))) v2
                             GROUP BY v2.id_drug_req_det, v2.id_state, v2.id_episode, v2.drdst_dt_state, v2.drs_id_state --must get the recent one (drug_req_det_state_transition) --this is because loops on the workflow (reject > prepare > reject > prepara .. and so on)
                            ) v1,
                           wfl_state_detail wsd
                     WHERE v1.id_state = wsd.state
                       AND wsd.prof_type = l_prof_type
                     ORDER BY wsd.rank, v1.drdst_dt_state DESC;
            ELSE
                pk_types.open_my_cursor(o_drug_hist);
            END IF;
        
        ELSE
        
            g_error := 'QUERY O_DRUG';
            OPEN o_drug FOR
                SELECT v1.id_drug_req_det,
                       v1.id_state,
                       get_drug_desc_pharm(i_lang,
                                           i_prof,
                                           v1.id_episode,
                                           v1.id_drug_req_det,
                                           'N',
                                           'N',
                                           'PHARMACY_FORMAT') pharm,
                       get_status_pipe_str(i_lang,
                                           i_prof,
                                           v1.id_state,
                                           i_prof_cat_type,
                                           v1.drdst2_dt_state,
                                           '0',
                                           '',
                                           g_yes) desc_stat,
                       get_attention_pipe_str(i_lang, i_prof, v1.id_drug_req_det) attention,
                       pk_date_utils.date_send_tsz(i_lang, v1.drdst_dt_state, i_prof) req_date,
                       get_icon_for_req_type(i_lang, i_prof, i_req_type, '') flg_type_icon,
                       NULL pend_type, --needed by flash to merge cursors --get_pat_req_all
                       i_req_type flg_type_req,
                       'REQ' req_dev,
                       check_presc_justification(i_lang, i_prof, v1.id_drug_req_det) flg_justify,
                       check_presc_justification(i_lang, i_prof, v1.id_drug_req_det, g_yes) show_justify
                  FROM (SELECT v2.id_drug_req_det,
                               v2.id_state,
                               v2.id_episode,
                               v2.drdst_dt_state,
                               MAX(v2.drdst2_dt_state) drdst2_dt_state
                          FROM (SELECT drd.id_drug_req_det,
                                       drd.id_state,
                                       e.id_episode,
                                       drdst.dt_state      drdst_dt_state,
                                       drdst2.dt_state     drdst2_dt_state
                                  FROM drug_req_det                  drd,
                                       drug_req                      dr,
                                       episode                       e,
                                       visit                         v,
                                       patient                       p,
                                       drug_req_det_state_transition drdst,
                                       drug_req_det_state_transition drdst2
                                 WHERE drd.id_drug_req = dr.id_drug_req
                                   AND dr.id_episode = e.id_episode
                                   AND e.id_visit = v.id_visit
                                   AND dr.id_patient = p.id_patient
                                   AND v.id_institution = i_prof.institution
                                   AND e.id_episode = i_id_episode --history episode
                                   AND drd.id_state IN (SELECT column_value
                                                          FROM TABLE(l_grid_states))
                                   AND dr.flg_type = i_req_type
                                   AND p.id_patient = i_patient
                                   AND drd.id_drug_req_det = drdst.id_drug_req_det
                                   AND drdst.id_state = l_grid_state_r
                                   AND drd.id_drug_req_det = drdst2.id_drug_req_det(+)
                                   AND drd.id_state = drdst2.id_state(+)
                                   AND row_is_visible(drd.id_state,
                                                      i_prof,
                                                      'D',
                                                      current_timestamp,
                                                      drdst2.dt_state,
                                                      l_flg_hist) = g_yes) v2
                         GROUP BY v2.id_drug_req_det, v2.id_state, v2.id_episode, v2.drdst_dt_state --must get the recent one (drug_req_det_state_transition) --this is because loops on the workflow (reject > prepare > reject > prepara .. and so on)
                        UNION ALL
                        --executing with some supplies or terminated!
                        SELECT v3.id_drug_req_det,
                               v3.id_state,
                               v3.id_episode,
                               v3.drdst_dt_state,
                               MAX(v3.drdst2_dt_state) drdst2_dt_state
                          FROM (SELECT drd.id_drug_req_det,
                                       drs.id_state,
                                       e.id_episode,
                                       drdst.dt_state      drdst_dt_state,
                                       drdst2.dt_state     drdst2_dt_state
                                  FROM drug_req_supply               drs,
                                       drug_req_det                  drd,
                                       drug_req                      dr,
                                       episode                       e,
                                       visit                         v,
                                       patient                       p,
                                       drug_req_det_state_transition drdst,
                                       drug_req_det_state_transition drdst2
                                 WHERE drs.id_drug_req_det = drd.id_drug_req_det
                                   AND drd.id_drug_req = dr.id_drug_req
                                   AND dr.id_episode = e.id_episode
                                   AND e.id_visit = v.id_visit
                                   AND dr.id_patient = p.id_patient
                                   AND v.id_institution = i_prof.institution
                                   AND e.id_episode = i_id_episode --history episode
                                   AND drd.id_state IN (SELECT column_value
                                                          FROM TABLE(l_grid_states_n))
                                   AND dr.flg_type = i_req_type
                                   AND p.id_patient = i_patient
                                   AND drs.id_state IN (SELECT column_value
                                                          FROM TABLE(l_grid_states_1))
                                   AND drd.id_drug_req_det = drdst.id_drug_req_det
                                   AND drdst.id_state = l_grid_state_r
                                   AND drd.id_drug_req_det = drdst2.id_drug_req_det(+)
                                   AND drd.id_state = drdst2.id_state(+)
                                   AND row_is_visible(drd.id_state,
                                                      i_prof,
                                                      'D',
                                                      current_timestamp,
                                                      drdst2.dt_state,
                                                      l_flg_hist) = g_yes
                                 GROUP BY drd.id_drug_req_det,
                                          drs.id_state,
                                          dr.dt_drug_req_tstz,
                                          e.id_episode,
                                          drdst.dt_state,
                                          drdst2.dt_state --group multiple supplies into one request
                                ) v3
                         GROUP BY v3.id_drug_req_det, v3.id_state, v3.id_episode, v3.drdst_dt_state) v1,
                       wfl_state_detail wsd
                 WHERE v1.id_state = wsd.state
                   AND wsd.prof_type = l_prof_type
                 ORDER BY wsd.rank, v1.drdst_dt_state DESC;
        
            --order return
            g_error := 'QUERY O_DRUG_DEV';
            OPEN o_drug_dev FOR
                SELECT drd.id_drug_req_det,
                       drsd.id_state,
                       get_drug_desc_pharm(i_lang,
                                           i_prof,
                                           dr.id_episode,
                                           drd.id_drug_req_det,
                                           'N',
                                           'N',
                                           'PHARMACY_FORMAT') pharm,
                       get_status_pipe_str(i_lang,
                                           i_prof,
                                           drsd.id_state,
                                           i_prof_cat_type,
                                           drsdst.dt_state,
                                           '0',
                                           '',
                                           g_yes) desc_stat,
                       get_attention_pipe_str(i_lang, i_prof, drd.id_drug_req_det) attention,
                       pk_date_utils.date_send_tsz(i_lang, drdst.dt_state, i_prof) req_date,
                       get_icon_for_req_type(i_lang, i_prof, i_req_type, '') flg_type_icon,
                       NULL pend_type, --needed by flash to merge cursors --get_pat_req_all
                       dr.flg_type flg_type_req,
                       'DEV' req_dev,
                       drsd.id_drug_req_supply_dev
                  FROM drug_req_supply_dev           drsd,
                       drug_req_sup_dev_state_trans  drsdst,
                       drug_req_supply               drs,
                       drug_req_det                  drd,
                       drug_req                      dr,
                       drug_req_det_state_transition drdst,
                       wfl_state_detail              wsd
                 WHERE drsd.id_drug_req_supply_dev = drsdst.id_drug_req_supply_dev
                   AND drsd.id_state = drsdst.id_state
                   AND drsd.id_drug_req_supply = drs.id_drug_req_supply
                   AND drs.id_drug_req_det = drd.id_drug_req_det
                   AND drd.id_drug_req = dr.id_drug_req
                   AND dr.flg_type = i_req_type
                   AND dr.id_episode = i_id_episode --history episode
                   AND drd.id_drug_req_det = drdst.id_drug_req_det
                   AND drdst.id_state = l_grid_state_r
                   AND drsd.id_state IN (SELECT column_value
                                           FROM TABLE(l_grid_states_2))
                   AND row_is_visible(drsd.id_state, i_prof, 'D', current_timestamp, drsdst.dt_state, l_flg_hist) =
                       g_yes
                   AND dr.id_patient = i_patient
                   AND drsd.id_state = wsd.state
                   AND wsd.prof_type = l_prof_type
                 ORDER BY wsd.rank, drsdst.dt_state DESC;
        
            pk_types.open_my_cursor(o_drug_hist);
        
        END IF;
    
        --prescriptions not automatically requested (the black list)
        IF (i_req_type = g_flg_unidose)
        THEN
        
            IF (l_flg_hist = g_no)
            THEN
            
                OPEN o_other_prescs FOR
                    SELECT NULL id_drug_req_det,
                           NULL id_state,
                           pk_medication_core.get_drug_desc(i_lang,
                                                            i_prof,
                                                            dp.id_episode,
                                                            dpd.id_drug_presc_det,
                                                            pk_medication_core.g_local,
                                                            'N',
                                                            'N') pharm,
                           '|T||N/A|||PRNStyle|||' desc_stat,
                           NULL attention,
                           NULL req_date,
                           NULL flg_type_icon,
                           NULL pend_type,
                           NULL flg_type_req,
                           'OTHER' req_dev,
                           NULL flg_justify,
                           NULL show_justify
                      FROM drug_prescription dp, drug_presc_det dpd, episode e
                     WHERE dp.id_drug_prescription = dpd.id_drug_prescription
                       AND pk_medication_core.is_active_prescription(i_lang, i_prof, dpd.id_drug_presc_det) = 1 --dpd.flg_status not in ('C', 'I', 'S', 'F', 'W', 'Y')
                       AND dp.id_episode = e.id_episode
                       AND e.flg_status = 'A'
                       AND e.id_institution = i_prof.institution
                       AND dpd.id_drug IS NOT NULL
                       AND dpd.vers IS NOT NULL
                       AND dp.id_patient = i_patient
                       AND (dpd.id_drug, dpd.vers) IN
                           (SELECT exm.id_drug, exm.vers
                              FROM pharm_unidose_exception_meds exm
                             WHERE (exm.id_institution = i_prof.institution OR exm.id_institution = 0))
                     ORDER BY pharm;
            
            ELSE
                --history
            
                OPEN o_other_prescs FOR
                    SELECT NULL id_drug_req_det,
                           NULL id_state,
                           pk_medication_core.get_drug_desc(i_lang,
                                                            i_prof,
                                                            dp.id_episode,
                                                            dpd.id_drug_presc_det,
                                                            pk_medication_core.g_local,
                                                            'N',
                                                            'N') pharm,
                           '|T||N/A|||PRNStyle|||' desc_stat,
                           NULL attention,
                           NULL req_date,
                           NULL flg_type_icon,
                           NULL pend_type,
                           NULL flg_type_req,
                           'OTHER' req_dev,
                           NULL flg_justify,
                           NULL show_justify
                      FROM drug_prescription dp, drug_presc_det dpd, episode e
                     WHERE dp.id_drug_prescription = dpd.id_drug_prescription
                       AND pk_medication_core.is_active_prescription(i_lang, i_prof, dpd.id_drug_presc_det) = 1 --dpd.flg_status not in ('C', 'I', 'S', 'F', 'W', 'Y')
                       AND dp.id_episode = e.id_episode
                       AND e.id_episode = i_id_episode --history episode
                       AND e.id_institution = i_prof.institution
                       AND dpd.id_drug IS NOT NULL
                       AND dpd.vers IS NOT NULL
                       AND dp.id_patient = i_patient
                       AND (dpd.id_drug, dpd.vers) IN
                           (SELECT exm.id_drug, exm.vers
                              FROM pharm_unidose_exception_meds exm
                             WHERE (exm.id_institution = i_prof.institution OR exm.id_institution = 0))
                     ORDER BY pharm;
            END IF;
        
        ELSE
            pk_types.open_my_cursor(o_other_prescs);
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'GET_PAT_REQ', o_error);
            pk_types.open_my_cursor(o_drug);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_actions);
            pk_types.open_my_cursor(o_drug_dev);
            pk_types.open_my_cursor(o_drug_hist);
            pk_types.open_my_cursor(o_other_prescs);
            RETURN FALSE;
    END get_pat_req;

    /********************************************************************************************
    * alert.pk_pharmacy.get_pat_req_pend
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PATIENT                       IN    NUMBER(24)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_PROF_CAT_TYPE                 IN    VARCHAR2
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  I_GET_ACTIONS                   IN    VARCHAR2
    * @param  I_FLG_HIST                      IN    VARCHAR2
    * @param  I_ID_EPISODE                    IN    NUMBER(24)
    * @param  O_DRUG                          OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_ACTIONS                       OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7
    * @since  2009-11-10
    *
    ********************************************************************************************/
    FUNCTION get_pat_req_pend
    (
        i_lang          IN language.id_language%TYPE,
        i_patient       IN patient.id_patient%TYPE,
        i_prof          IN alert.profissional,
        i_prof_cat_type IN category.flg_type%TYPE,
        i_get_headers   IN VARCHAR2 DEFAULT 'N',
        i_header_codes  IN table_varchar DEFAULT NULL,
        i_get_actions   IN VARCHAR2 DEFAULT 'N',
        i_flg_hist      IN VARCHAR2 DEFAULT 'N',
        i_id_episode    IN episode.id_episode%TYPE DEFAULT NULL,
        o_drug          OUT pk_types.cursor_type,
        o_headers       OUT pk_types.cursor_type,
        o_actions       OUT pk_types.cursor_type,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
        l_flg_hist    VARCHAR2(1 CHAR);
        l_grid_states table_number;
    BEGIN
        --history and search
        l_flg_hist := nvl(i_flg_hist, g_no);
    
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error := 'GET ACTIONS';
        get_pharmacy_actions(i_lang, i_prof, i_get_actions, g_grid_actions_all_pat, o_actions);
    
        l_grid_states := get_states_for_req_type(i_prof, NULL, table_varchar(g_drs_preparing_st, g_drs_canceled_st));
    
        IF (l_flg_hist = g_no)
        THEN
        
            OPEN o_drug FOR
                SELECT drd.id_drug_req_det,
                       drs.id_state,
                       get_drug_desc_pharm(i_lang,
                                           i_prof,
                                           e.id_episode,
                                           drd.id_drug_req_det,
                                           'N',
                                           'N',
                                           'PHARMACY_FORMAT') pharm,
                       get_medication_name(i_lang,
                                           i_prof,
                                           drd.id_drug,
                                           drd.vers,
                                           dr.flg_type,
                                           dr.id_drug_presc_det,
                                           g_yes,
                                           drd.id_other_product) short_pharm,
                       get_status_pipe_str(i_lang,
                                           i_prof,
                                           drs.id_state,
                                           i_prof_cat_type,
                                           drdst.dt_state,
                                           '0',
                                           '',
                                           g_yes) desc_stat,
                       get_attention_pipe_str(i_lang, i_prof, drd.id_drug_req_det) attention,
                       pk_date_utils.date_send_tsz(i_lang, drdst.dt_state, i_prof) req_date,
                       get_icon_for_req_type(i_lang, i_prof, dr.flg_type, '') flg_type_icon,
                       dr.flg_type pend_type,
                       'P' flg_type_req,
                       'REQ' req_dev,
                       ws.generic_name
                  FROM drug_req_supply               drs,
                       drug_req_det                  drd,
                       drug_req                      dr,
                       episode                       e,
                       visit                         v,
                       patient                       p,
                       drug_req_det_state_transition drdst,
                       drug_req_sup_state_transition drsst2,
                       wfl_state                     ws,
                       wfl_state_detail              wsd
                 WHERE drs.id_drug_req_det = drd.id_drug_req_det
                   AND drd.id_drug_req = dr.id_drug_req
                   AND dr.id_episode = e.id_episode
                   AND e.id_visit = v.id_visit
                   AND dr.id_patient = p.id_patient
                   AND v.id_institution = i_prof.institution
                   AND v.flg_status != 'C' -- not canceled
                   AND e.flg_status = decode(dr.flg_type, g_flg_int, e.flg_status, 'A') -- active episode whenever flg_type <> flg_int
                   AND drs.id_state IN (SELECT column_value
                                          FROM TABLE(l_grid_states))
                   AND p.id_patient = i_patient
                   AND drd.id_drug_req_det = drdst.id_drug_req_det
                   AND drdst.id_state = get_state_for_req_type(i_prof, dr.flg_type, g_drd_requested_st)
                   AND drs.id_drug_req_supply = drsst2.id_drug_req_supply
                   AND drs.id_state = drsst2.id_state
                   AND row_is_visible(drs.id_state, i_prof, 'D', current_timestamp, drsst2.dt_state, l_flg_hist) =
                       g_yes
                   AND drs.id_state = ws.id_state
                   AND ws.id_state = wsd.state
                   AND wsd.prof_type = i_prof_cat_type
                 ORDER BY wsd.rank, drdst.dt_state DESC;
        
        ELSE
            --history
        
            OPEN o_drug FOR
                SELECT drd.id_drug_req_det,
                       drs.id_state,
                       get_drug_desc_pharm(i_lang,
                                           i_prof,
                                           e.id_episode,
                                           drd.id_drug_req_det,
                                           'N',
                                           'N',
                                           'PHARMACY_FORMAT') pharm,
                       get_medication_name(i_lang,
                                           i_prof,
                                           drd.id_drug,
                                           drd.vers,
                                           dr.flg_type,
                                           dr.id_drug_presc_det,
                                           g_yes,
                                           drd.id_other_product) short_pharm,
                       get_status_pipe_str(i_lang,
                                           i_prof,
                                           drs.id_state,
                                           i_prof_cat_type,
                                           drdst.dt_state,
                                           '0',
                                           '',
                                           g_yes) desc_stat,
                       get_attention_pipe_str(i_lang, i_prof, drd.id_drug_req_det) attention,
                       pk_date_utils.date_send_tsz(i_lang, drdst.dt_state, i_prof) req_date,
                       get_icon_for_req_type(i_lang, i_prof, dr.flg_type, '') flg_type_icon,
                       dr.flg_type pend_type,
                       'P' flg_type_req,
                       'REQ' req_dev,
                       ws.generic_name
                  FROM drug_req_supply               drs,
                       drug_req_det                  drd,
                       drug_req                      dr,
                       episode                       e,
                       visit                         v,
                       patient                       p,
                       drug_req_det_state_transition drdst,
                       drug_req_sup_state_transition drsst2,
                       wfl_state                     ws,
                       wfl_state_detail              wsd
                 WHERE drs.id_drug_req_det = drd.id_drug_req_det
                   AND drd.id_drug_req = dr.id_drug_req
                   AND dr.id_episode = e.id_episode
                   AND e.id_visit = v.id_visit
                   AND dr.id_patient = p.id_patient
                   AND v.id_institution = i_prof.institution
                   AND e.id_episode = i_id_episode -- history
                   AND drs.id_state IN (SELECT column_value
                                          FROM TABLE(l_grid_states))
                   AND p.id_patient = i_patient
                   AND drd.id_drug_req_det = drdst.id_drug_req_det
                   AND drdst.id_state = get_state_for_req_type(i_prof, dr.flg_type, g_drd_requested_st)
                   AND drs.id_drug_req_supply = drsst2.id_drug_req_supply
                   AND drs.id_state = drsst2.id_state
                   AND row_is_visible(drs.id_state, i_prof, 'D', current_timestamp, drsst2.dt_state, l_flg_hist) =
                       g_yes
                   AND drs.id_state = ws.id_state
                   AND ws.id_state = wsd.state
                   AND wsd.prof_type = i_prof_cat_type
                 ORDER BY wsd.rank, drdst.dt_state DESC;
        
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_pat_req_pend', o_error);
            pk_types.open_my_cursor(o_drug);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_actions);
            RETURN FALSE;
    END get_pat_req_pend;

    /********************************************************************************************
    * alert.pk_pharmacy.check_presc_justification
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DRD                        IN    NUMBER(24)
    * @param  I_FLG_SHOW                      IN    VARCHAR2
    *
    * @return VARCHAR2
    *
    * @author Rui Marante
    * @version  2.5.0.7.4
    * @since  2009-12-10
    *
    ********************************************************************************************/
    FUNCTION check_presc_justification
    (
        i_lang     IN language.id_language%TYPE,
        i_prof     IN alert.profissional,
        i_id_drd   IN drug_presc_justification.id_drug_req_det%TYPE,
        i_flg_show IN VARCHAR2 DEFAULT 'N' -- Y | N
    ) RETURN VARCHAR2 IS
        l_flg_justify VARCHAR2(1 CHAR) := 'N';
        l_count       NUMBER(1) := 0;
    BEGIN
        IF (i_flg_show = g_no)
        THEN
            SELECT COUNT(1)
              INTO l_count
              FROM drug_presc_justification dpj
             WHERE dpj.id_drug_req_det = i_id_drd
               AND dpj.pharmacist_notes IS NULL --not yet read!
               AND rownum = 1;
        
            IF (l_count = 0)
            THEN
                SELECT COUNT(1)
                  INTO l_count
                  FROM drug_req_det drd, drug_req dr, drug_presc_det dpd, drug_presc_justification dpj
                 WHERE drd.id_drug_req = dr.id_drug_req
                   AND drd.id_drug_req_det = i_id_drd
                   AND dr.id_drug_presc_det = dpd.id_drug_presc_det
                   AND dpd.id_drug_presc_det = dpj.id_drug_presc_det
                   AND dpj.pharmacist_notes IS NULL --not yet read!
                   AND rownum = 1;
            END IF;
        ELSE
            -- Y
            SELECT COUNT(1)
              INTO l_count
              FROM drug_presc_justification dpj
             WHERE dpj.id_drug_req_det = i_id_drd
               AND rownum = 1;
        
            IF (l_count = 0)
            THEN
                SELECT COUNT(1)
                  INTO l_count
                  FROM drug_req_det drd, drug_req dr, drug_presc_det dpd, drug_presc_justification dpj
                 WHERE drd.id_drug_req = dr.id_drug_req
                   AND drd.id_drug_req_det = i_id_drd
                   AND dr.id_drug_presc_det = dpd.id_drug_presc_det
                   AND dpd.id_drug_presc_det = dpj.id_drug_presc_det
                   AND rownum = 1;
            END IF;
        END IF;
    
        IF (l_count = 0)
        THEN
            l_flg_justify := 'N';
        ELSE
            l_flg_justify := 'Y';
        END IF;
    
        RETURN l_flg_justify;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END check_presc_justification;

    /********************************************************************************************
    * alert.pk_pharmacy.get_presc_justification
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DRD                        IN    NUMBER(24)
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  O_PRESC_JUSTIF                  OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_HEADERS_JUSTIF                OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-09-08
    *
    ********************************************************************************************/
    FUNCTION get_presc_justification
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN alert.profissional,
        i_id_drd         IN drug_presc_justification.id_drug_req_det%TYPE,
        i_get_headers    IN VARCHAR2 DEFAULT 'N',
        i_header_codes   IN table_varchar DEFAULT NULL,
        o_presc_justif   OUT pk_types.cursor_type,
        o_headers        OUT pk_types.cursor_type,
        o_headers_justif OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
        l_header_codes table_varchar;
        l_count        NUMBER(1) := 0;
        l_dpd_id       drug_req.id_drug_presc_det%TYPE := NULL;
        l_prof_presc   VARCHAR2(4000 CHAR) := '';
        l_dt_req       VARCHAR2(20 CHAR) := '';
    BEGIN
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error        := 'GET HEADERS FOR JUSTIFICATION';
        l_header_codes := table_varchar('PHARMACIST_JUSTIFY_CLINICAL_INFO',
                                        'PHARMACIST_JUSTIFY_PRESC_JUSTIFICATION',
                                        'PHARMACIST_JUSTIFY_FLG_OTH_MED_SAME_PURPOSE',
                                        'PHARMACIST_JUSTIFY_OTHER_MED_JUSTIFICATION',
                                        'PHARMACIST_JUSTIFY_FLG_BACTERIOLOGICAL_STUDY',
                                        'PHARMACIST_JUSTIFY_BACTERIO_STUDY_JUSTIF',
                                        'PHARMACIST_JUSTIFY_BACTERIO_STUDY_RESULT',
                                        'PHARMACIST_JUSTIFY_PRESCRIBED_BY',
                                        'PHARMACIST_JUSTIFY_DT_REQ');
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, l_header_codes, o_headers_justif);
    
        SELECT COUNT(1)
          INTO l_count
          FROM drug_presc_justification dpj
         WHERE dpj.id_drug_req_det = i_id_drd
           AND rownum = 1;
    
        IF (l_count = 0)
        THEN
            SELECT dr.id_drug_presc_det
              INTO l_dpd_id
              FROM drug_req_det drd, drug_req dr
             WHERE drd.id_drug_req = dr.id_drug_req
               AND drd.id_drug_req_det = i_id_drd;
        END IF;
    
        IF (l_dpd_id IS NULL)
        THEN
        
            g_error := 'QUERY 1';
            SELECT pk_prof_utils.get_name(i_lang, dr.id_prof_req),
                   pk_date_utils.date_send_tsz(i_lang, dr.dt_drug_req_tstz, i_prof)
              INTO l_prof_presc, l_dt_req
              FROM drug_req_det drd
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             WHERE drd.id_drug_req_det = i_id_drd;
        
            g_error := 'QUERY 2';
            OPEN o_presc_justif FOR
                SELECT dpj.id_drug_presc_just,
                       dpj.id_drug_presc_det,
                       dpj.clinical_info,
                       dpj.presc_justification,
                       dpj.other_med_justification,
                       dpj.bacterio_study_justif,
                       dpj.bacterio_study_result,
                       l_prof_presc                prescribed_by,
                       l_dt_req                    dt_req
                  FROM drug_presc_justification dpj
                 WHERE dpj.id_drug_req_det = i_id_drd;
        
        ELSE
        
            g_error := 'QUERY 3';
            SELECT pk_prof_utils.get_name(i_lang, dp.id_professional),
                   pk_date_utils.date_send_tsz(i_lang, dr.dt_drug_req_tstz, i_prof)
              INTO l_prof_presc, l_dt_req
              FROM drug_presc_det dpd
             INNER JOIN drug_prescription dp
                ON (dpd.id_drug_prescription = dp.id_drug_prescription)
             INNER JOIN drug_req dr
                ON (dpd.id_drug_presc_det = dr.id_drug_presc_det)
             INNER JOIN drug_req_det drd
                ON (dr.id_drug_req = drd.id_drug_req)
             WHERE dpd.id_drug_presc_det = l_dpd_id
               AND drd.id_drug_req_det = i_id_drd;
        
            g_error := 'QUERY 4';
            OPEN o_presc_justif FOR
                SELECT dpj.id_drug_presc_just,
                       dpj.id_drug_presc_det,
                       dpj.clinical_info,
                       dpj.presc_justification,
                       dpj.other_med_justification,
                       dpj.bacterio_study_justif,
                       dpj.bacterio_study_result,
                       l_prof_presc                prescribed_by,
                       l_dt_req                    dt_req
                  FROM drug_presc_justification dpj
                 WHERE dpj.id_drug_presc_det = l_dpd_id;
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'get_presc_justification', o_error);
            pk_types.open_my_cursor(o_presc_justif);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_headers_justif);
            RETURN FALSE;
    END get_presc_justification;

    /********************************************************************************************
    * alert.pk_pharmacy.set_presc_justification
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DPJ                        IN    NUMBER(24)
    * @param  I_NOTES                         IN    VARCHAR2
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-09-08
    *
    ********************************************************************************************/
    FUNCTION set_presc_justification
    (
        i_lang   IN language.id_language%TYPE,
        i_prof   IN alert.profissional,
        i_id_dpj IN drug_presc_justification.id_drug_presc_just%TYPE,
        i_notes  IN drug_presc_justification.pharmacist_notes%TYPE,
        o_error  OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        UPDATE drug_presc_justification dpj
           SET dpj.pharmacist_notes = i_notes
         WHERE dpj.id_drug_presc_just = i_id_dpj;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'set_presc_justification', o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_presc_justification;

    /********************************************************************************************
    * alert.pk_pharmacy.get_pat_check
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_DRUG_REQ_DET                  IN    ALERT.TABLE_NUMBER
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  O_DRUG                          OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_CO_SIGN_PROFS                 OUT   REF CURSOR
    * @param  O_CO_SIGN_TYPES                 OUT   REF CURSOR
    * @param  O_DELIVER_AT_HOME               OUT   REF CURSOR
    * @param  O_UNITS                         OUT   REF CURSOR
    * @param  O_CHANGE_MED                    OUT   VARCHAR2
    * @param  O_CHANGE_INSTR                  OUT   VARCHAR2
    * @param  O_CHANGE_MED_NEW                OUT   VARCHAR2
    * @param  O_CO_SIGN                       OUT   VARCHAR2
    * @param  O_SHOW_DELIVER_HOME             OUT   VARCHAR2
    * @param  O_CO_SIGN_MINDATE               OUT   VARCHAR2
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7
    * @since  2009-11-06
    *
    ********************************************************************************************/
    FUNCTION get_pat_check
    (
        i_lang              IN language.id_language%TYPE,
        i_prof              IN alert.profissional,
        i_drug_req_det      IN table_number,
        i_get_headers       IN VARCHAR2 DEFAULT 'N',
        i_header_codes      IN table_varchar DEFAULT NULL,
        o_drug              OUT pk_types.cursor_type,
        o_headers           OUT pk_types.cursor_type,
        o_co_sign_profs     OUT pk_types.cursor_type,
        o_co_sign_types     OUT pk_types.cursor_type,
        o_deliver_at_home   OUT pk_types.cursor_type,
        o_units             OUT pk_types.cursor_type,
        o_change_med        OUT VARCHAR2,
        o_change_instr      OUT VARCHAR2,
        o_change_med_new    OUT VARCHAR2,
        o_co_sign           OUT VARCHAR2,
        o_show_deliver_home OUT VARCHAR2,
        o_co_sign_mindate   OUT VARCHAR2,
        o_error             OUT t_error_out
    ) RETURN BOOLEAN IS
        l_req_type      drug_req.flg_type%TYPE;
        l_id_patient    drug_req.id_patient%TYPE;
        l_id_episode    drug_req.id_episode%TYPE;
        l_prof_cat_type profile_template.flg_type%TYPE;
        l_dummy         BOOLEAN := FALSE;
    BEGIN
        g_error             := 'GET SYS CONFIGS';
        o_change_med        := nvl(pk_sysconfig.get_config(i_code_cf => 'PHARMACY_CAN_CHANGE_MEDICATION',
                                                           i_prof    => i_prof),
                                   g_no);
        o_change_instr      := nvl(pk_sysconfig.get_config(i_code_cf => 'PHARMACY_CAN_CHANGE_MEDICATION_INSTRUCTIONS',
                                                           i_prof    => i_prof),
                                   g_no);
        o_change_med_new    := nvl(pk_sysconfig.get_config(i_code_cf => 'PHARMACY_CAN_CHANGE_MEDICATION_TO_NEW_MED',
                                                           i_prof    => i_prof),
                                   g_no);
        o_co_sign           := nvl(pk_sysconfig.get_config(i_code_cf => 'PHARMACY_WITH_CO_SIGN', i_prof => i_prof),
                                   g_no);
        o_show_deliver_home := nvl(pk_sysconfig.get_config(i_code_cf => 'PHARMACY_CAN_DELIVER_AT_HOME_VISIBLE',
                                                           i_prof    => i_prof),
                                   g_yes);
    
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error    := 'GET REQ TYPE';
        l_req_type := get_req_type(i_drug_req_det(1), NULL); --all ids have to be of same req type!
    
        g_error := 'GET DISPENSE UNITS';
        l_dummy := get_dispense_units(i_lang, i_prof, o_units, o_error);
    
        IF (l_req_type = g_flg_adm)
        THEN
            --admin local
        
            OPEN o_drug FOR
                SELECT drd.id_drug_req_det,
                       nvl(drd.id_drug, g_id_other_product) id_drug, --other product
                       drd.vers,
                       get_medication_name(i_lang,
                                           i_prof,
                                           drd.id_drug,
                                           drd.vers,
                                           dr.flg_type,
                                           dr.id_drug_presc_det,
                                           g_yes,
                                           drd.id_other_product) pharm,
                       get_drug_desc_instr(i_lang, i_prof, dr.id_episode, drd.id_drug_req_det) instr,
                       get_attention_pipe_str(i_lang, i_prof, drd.id_drug_req_det) attention,
                       drd.qty_req,
                       drd.id_unit_measure,
                       pk_medication_core.get_unit_translation(i_lang, i_prof, drd.id_unit_measure, 3) qty_unit,
                       drd.qty_to_prep,
                       drd.id_unit_measure_prep,
                       pk_medication_core.get_unit_translation(i_lang, i_prof, drd.id_unit_measure_prep, 3) qty_unit_prep,
                       get_notes_from_drd(drd.id_drug_req_det,
                                          table_number(get_state_for_req_type(i_prof, l_req_type, g_drd_requested_st)),
                                          1,
                                          g_yes) physician_notes,
                       dr.id_drug_presc_det,
                       mmd.id_unit_dispense default_unit_dispense,
                       get_dispense_units_per_req(i_lang, i_prof, drd.id_drug_req_det) dispense_units,
                       dpd.id_presc_directions,
                       drd.id_other_product,
                       dpd.flg_free_text flg_free_text_drug,
                       dp.flg_free_text flg_free_text_instr,
                       pk_medication_current.check_editable_req(i_lang, i_prof, drd.id_drug_req_det) flg_editable,
                       decode(drd.generico, g_yes, g_no, g_yes) dispense_as_written,
                       get_refill(drd.id_drug_req_det) refill
                  FROM drug_req_det drd
                 INNER JOIN drug_req dr
                    ON (drd.id_drug_req = dr.id_drug_req)
                  LEFT JOIN mi_med_dosage mmd
                    ON (drd.id_drug = mmd.id_drug AND drd.vers = mmd.version)
                 INNER JOIN drug_presc_det dpd
                    ON (dr.id_drug_presc_det = dpd.id_drug_presc_det)
                  LEFT JOIN presc_directions dp
                    ON (dpd.id_presc_directions = dp.id_presc_directions)
                 WHERE drd.id_drug_req_det IN (SELECT column_value
                                                 FROM TABLE(i_drug_req_det))
                 ORDER BY pharm;
        
            pk_types.open_my_cursor(o_deliver_at_home);
        
        ELSIF (l_req_type = g_flg_int)
        THEN
            --ambulatorio
        
            l_prof_cat_type := get_prof_type(i_prof);
        
            OPEN o_drug FOR
                SELECT drd.id_drug_req_det,
                       nvl(drd.id_drug, g_id_other_product) id_drug, --other product
                       drd.vers,
                       get_medication_name(i_lang,
                                           i_prof,
                                           drd.id_drug,
                                           drd.vers,
                                           dr.flg_type,
                                           dr.id_drug_presc_det,
                                           g_yes,
                                           drd.id_other_product) pharm,
                       get_drug_desc_instr(i_lang, i_prof, dr.id_episode, drd.id_drug_req_det) instr,
                       get_attention_pipe_str(i_lang, i_prof, drd.id_drug_req_det) attention,
                       drd.qty_req,
                       drd.id_unit_measure,
                       pk_medication_core.get_unit_translation(i_lang, i_prof, drd.id_unit_measure, 3) qty_unit,
                       drd.qty_to_prep,
                       drd.id_unit_measure_prep,
                       pk_medication_core.get_unit_translation(i_lang, i_prof, drd.id_unit_measure_prep, 3) qty_unit_prep,
                       get_notes_from_drd(drd.id_drug_req_det,
                                          table_number(get_state_for_req_type(i_prof, l_req_type, g_drd_requested_st)),
                                          1,
                                          g_yes) physician_notes,
                       mr.suggested_descr recm,
                       pk_date_utils.date_send_tsz(i_lang,
                                                   get_next_appointment_date(i_lang,
                                                                             dr.id_patient,
                                                                             i_prof,
                                                                             l_prof_cat_type),
                                                   i_prof) dt_next_appointment,
                       dr.id_drug_presc_det,
                       mmd.id_unit_dispense default_unit_dispense,
                       get_dispense_units_per_req(i_lang, i_prof, drd.id_drug_req_det) dispense_units,
                       drd.id_presc_directions,
                       drd.id_other_product,
                       NULL flg_free_text_drug,
                       dp.flg_free_text flg_free_text_instr,
                       g_no flg_editable,
                       decode(drd.generico, g_yes, g_no, g_yes) dispense_as_written,
                       get_refill(drd.id_drug_req_det) refill
                  FROM drug_req_det drd
                 INNER JOIN drug_req dr
                    ON (drd.id_drug_req = dr.id_drug_req)
                  LEFT JOIN mi_regulation mr
                    ON (drd.regulation_id = mr.regulation_id AND drd.vers = mr.vers)
                  LEFT JOIN mi_med_dosage mmd
                    ON (drd.id_drug = mmd.id_drug AND drd.vers = mmd.version)
                  LEFT JOIN presc_directions dp
                    ON (drd.id_presc_directions = dp.id_presc_directions)
                 WHERE drd.id_drug_req_det IN (SELECT column_value
                                                 FROM TABLE(i_drug_req_det))
                 ORDER BY pharm;
        
            OPEN o_deliver_at_home FOR
                SELECT sd.val data, sd.desc_val label
                  FROM sys_domain sd
                 WHERE sd.code_domain = 'PHARMACY_REQ_DELIVER_AT_HOME'
                   AND sd.domain_owner = pk_sysdomain.k_default_schema
                   AND sd.id_language = i_lang
                   AND sd.rank < 3 --para nao aparecer o N/A
                 ORDER BY sd.rank;
        
        ELSIF (l_req_type = g_flg_unidose)
        THEN
            --unidose
        
            OPEN o_drug FOR
                SELECT drd.id_drug_req_det,
                       nvl(drd.id_drug, g_id_other_product) id_drug, --other product
                       drd.vers,
                       get_medication_name(i_lang,
                                           i_prof,
                                           drd.id_drug,
                                           drd.vers,
                                           dr.flg_type,
                                           dr.id_drug_presc_det,
                                           g_yes,
                                           drd.id_other_product) pharm,
                       get_drug_desc_instr(i_lang, i_prof, dr.id_episode, drd.id_drug_req_det) instr,
                       get_attention_pipe_str(i_lang, i_prof, drd.id_drug_req_det) attention,
                       drd.qty_req,
                       drd.id_unit_measure,
                       pk_medication_core.get_unit_translation(i_lang, i_prof, drd.id_unit_measure, 3) qty_unit,
                       drd.qty_to_prep,
                       drd.id_unit_measure_prep,
                       pk_medication_core.get_unit_translation(i_lang, i_prof, drd.id_unit_measure_prep, 3) qty_unit_prep,
                       get_notes_from_drd(drd.id_drug_req_det,
                                          table_number(get_state_for_req_type(i_prof, l_req_type, g_drd_requested_st)),
                                          1,
                                          g_yes) physician_notes,
                       pk_date_utils.date_send_tsz(i_lang,
                                                   get_next_appointment_date(i_lang,
                                                                             dr.id_patient,
                                                                             i_prof,
                                                                             l_prof_cat_type),
                                                   i_prof) dt_next_appointment,
                       dr.id_drug_presc_det,
                       mmd.id_unit_dispense default_unit_dispense,
                       get_dispense_units_per_req(i_lang, i_prof, drd.id_drug_req_det) dispense_units,
                       dpd.id_presc_directions,
                       drd.id_other_product,
                       dpd.flg_free_text flg_free_text_drug,
                       dp.flg_free_text flg_free_text_instr,
                       pk_medication_current.check_editable_req(i_lang, i_prof, drd.id_drug_req_det) flg_editable,
                       decode(drd.generico, g_yes, g_no, g_yes) dispense_as_written,
                       get_refill(drd.id_drug_req_det) refill
                  FROM drug_req_det drd
                 INNER JOIN drug_req dr
                    ON (drd.id_drug_req = dr.id_drug_req)
                  LEFT JOIN mi_med_dosage mmd
                    ON (drd.id_drug = mmd.id_drug AND drd.vers = mmd.version)
                 INNER JOIN drug_presc_det dpd
                    ON (dr.id_drug_presc_det = dpd.id_drug_presc_det)
                  LEFT JOIN presc_directions dp
                    ON (dpd.id_presc_directions = dp.id_presc_directions)
                 WHERE drd.id_drug_req_det IN (SELECT column_value
                                                 FROM TABLE(i_drug_req_det))
                 ORDER BY pharm;
        
            pk_types.open_my_cursor(o_deliver_at_home);
        
        END IF;
    
        IF (o_co_sign = g_yes)
        THEN
        
            SELECT dr.id_episode, dr.id_patient
              INTO l_id_episode, l_id_patient
              FROM drug_req_det drd, drug_req dr
             WHERE drd.id_drug_req = dr.id_drug_req
               AND drd.id_drug_req_det = i_drug_req_det(1); --basta o primeiro, mesmo que a colecao tenha mais ids
        
            IF NOT pk_prescription_int.get_cosign_data(i_lang            => i_lang,
                                                       i_prof            => i_prof,
                                                       i_id_patient      => l_id_patient,
                                                       i_id_episode      => l_id_episode,
                                                       o_co_sign_profs   => o_co_sign_profs,
                                                       o_co_sign_types   => o_co_sign_types,
                                                       o_co_sign_mindate => o_co_sign_mindate,
                                                       o_error           => o_error)
            THEN
                raise_application_error(-20001, o_error.err_desc);
            END IF;
        
        ELSE
            pk_types.open_my_cursor(o_co_sign_profs);
            pk_types.open_my_cursor(o_co_sign_types);
            o_co_sign_mindate := NULL;
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_pat_check', o_error);
            pk_types.open_my_cursor(o_drug);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_co_sign_profs);
            pk_types.open_my_cursor(o_co_sign_types);
            pk_types.open_my_cursor(o_deliver_at_home);
            RETURN FALSE;
    END get_pat_check;

    FUNCTION get_dispense_units
    (
        i_lang  IN language.id_language%TYPE,
        i_prof  IN alert.profissional,
        o_units OUT pk_types.cursor_type,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        g_error := 'GET HEADERS';
        OPEN o_units FOR
            SELECT u.id_unit_measure id,
                   pk_translation.get_translation(i_lang, u.code_unit_measure) label,
                   g_no flg_default
              FROM unit_measure u
             WHERE u.id_unit_measure_type = 1020 --Unidade de dispensa
               AND u.flg_available = g_yes
             ORDER BY label;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_dispense_units', o_error);
            pk_types.open_my_cursor(o_units);
            RETURN FALSE;
    END get_dispense_units;

    /********************************************************************************************
    * alert.pk_pharmacy.get_default_dispense_unit  (DETERMINISTIC)
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DRUG                       IN    VARCHAR2
    * @param  I_VERSION                       IN    VARCHAR2
    *
    * @return NUMBER(24)
    *
    * @author Rui Marante
    * @version  2.5.0.7.8
    * @since  2010-04-23
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_default_dispense_unit
    (
        i_lang    IN language.id_language%TYPE,
        i_prof    IN alert.profissional,
        i_id_drug IN mi_med_dosage.id_drug%TYPE,
        i_version IN mi_med_dosage.version%TYPE
    ) RETURN mi_med_dosage.id_unit_dispense%TYPE DETERMINISTIC IS
        l_id_unit mi_med_dosage.id_unit_dispense%TYPE := NULL;
        --
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'get_default_dispense_unit';
    BEGIN
        SELECT mmd.id_unit_dispense
          INTO l_id_unit
          FROM mi_med_dosage mmd
         WHERE mmd.id_drug = i_id_drug
           AND mmd.version = i_version
           AND rownum = 1;
    
        RETURN l_id_unit;
    
    EXCEPTION
        WHEN OTHERS THEN
            set_pharmacy_log(l_db_object_name, 'error:' || SQLERRM);
            RETURN NULL; --no_data_found
    END get_default_dispense_unit;

    /********************************************************************************************
    * alert.pk_pharmacy.get_packages_for_drug
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_DRUG_REQ_DET                  IN    NUMBER(24)
    * @param  O_PACKAGES                      OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-07-06
    *
    ********************************************************************************************/
    FUNCTION get_packages_for_drug
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN alert.profissional,
        i_drug_req_det IN drug_req_det.id_drug_req_det%TYPE,
        o_packages     OUT pk_types.cursor_type,
        o_error        OUT alert.t_error_out
    ) RETURN BOOLEAN IS
        l_id_drug drug_req_det.id_drug%TYPE;
        l_version drug_req_det.vers%TYPE;
    BEGIN
        SELECT drd.id_drug, drd.vers
          INTO l_id_drug, l_version
          FROM drug_req_det drd
         WHERE drd.id_drug_req_det = i_drug_req_det;
    
        OPEN o_packages FOR
            SELECT 1 data,
                   a.lot_number || '<br/><i>' ||
                   pk_date_utils.date_chr_short_read_tsz(i_lang, a.dt_expire, i_prof.institution, i_prof.software) ||
                   '</i>' label,
                   a.lot_number package_number,
                   pk_date_utils.date_send_tsz(i_lang, a.dt_expire, i_prof) dt_expire
              FROM mi_med_stock_info a
             WHERE a.id_drug = l_id_drug
               AND a.version = l_version
               AND a.id_institution = i_prof.institution
            UNION ALL
            SELECT -1 data,
                   pk_message.get_message(i_lang, 'PHARMACIST_REQ_GRID_099') label,
                   NULL package_number,
                   NULL dt_expire
              FROM dual
             ORDER BY data DESC, dt_expire NULLS LAST;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_packages_for_drug', o_error);
            pk_types.open_my_cursor(o_packages);
            RETURN FALSE;
    END get_packages_for_drug;

    /********************************************************************************************
    * alert.pk_pharmacy.get_unidose_order_allocation
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_DRUG_REQ_DET                  IN    NUMBER(24)
    *
    * @return ALERT.T_REC_PHARM_DRD_ALLOCATION
    *
    * @author Rui Marante
    * @version  2.5.0.7
    * @since  2009-11-04
    *
    ********************************************************************************************/
    FUNCTION get_unidose_order_allocation
    (
        i_lang         IN language.id_language%TYPE,
        i_drug_req_det IN drug_req_det.id_drug_req_det%TYPE
    ) RETURN t_rec_pharm_drd_allocation IS
        l_allocation  t_rec_pharm_drd_allocation := t_rec_pharm_drd_allocation(NULL, NULL, NULL, NULL);
        l_id_car      pharm_unidose_car.id_unidose_car%TYPE := NULL;
        l_slot_number pharm_unidose_slot_content.slot_number%TYPE := NULL;
    BEGIN
        --1) check if it is allocated to a car (not a slot)
        BEGIN
            SELECT ucc.id_unidose_car
              INTO l_id_car
              FROM pharm_unidose_car_content ucc
             WHERE ucc.id_drug_req_det = i_drug_req_det
               AND rownum = 1;
        EXCEPTION
            WHEN no_data_found THEN
                l_id_car := NULL;
        END;
    
        --2) check if it is allocated to a slot in a car (only if step 1 failed)
        IF (l_id_car IS NULL)
        THEN
            BEGIN
                SELECT usc.id_unidose_car, usc.slot_number
                  INTO l_id_car, l_slot_number
                  FROM pharm_unidose_slot_content usc
                 WHERE usc.id_drug_req_det = i_drug_req_det
                   AND rownum = 1;
            EXCEPTION
                WHEN no_data_found THEN
                    l_id_car      := NULL;
                    l_slot_number := NULL;
            END;
        END IF;
    
        --3) set the values of the type to return
        IF (l_id_car IS NULL)
        THEN
            --the order is not allocated, so, nothing to do!
            --this is here for readability only!!
            NULL;
        ELSE
            l_allocation.id_unidose_car := l_id_car;
        
            SELECT ucm.car_model_name
              INTO l_allocation.car_model_name
              FROM pharm_unidose_car uc
             INNER JOIN pharm_unidose_car_model ucm
                ON (uc.id_car_model = ucm.id_unidose_car_model)
             WHERE uc.id_unidose_car = l_id_car;
        
            l_allocation.slot_number := l_slot_number;
        
            IF (l_allocation.slot_number IS NOT NULL)
            THEN
                l_allocation.slot_name := pk_message.get_message(i_lang, 'PHARMACIST_UNIDOSE_DRAWER') || ' ' ||
                                          l_allocation.slot_number;
            END IF;
        END IF;
    
        RETURN l_allocation;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_unidose_order_allocation;

    /********************************************************************************************
    * alert.pk_pharmacy.get_pat_prepare
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_DRUG_REQ_DET                  IN    ALERT.TABLE_NUMBER
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  O_DRUG                          OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_PACKAGES                      OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-02
    *
    ********************************************************************************************/
    FUNCTION get_pat_prepare
    (
        i_lang              IN language.id_language%TYPE,
        i_prof              IN alert.profissional,
        i_drug_req_det      IN table_number,
        i_get_headers       IN VARCHAR2 DEFAULT 'N',
        i_header_codes      IN table_varchar DEFAULT NULL,
        o_drug              OUT pk_types.cursor_type,
        o_headers           OUT pk_types.cursor_type,
        o_units             OUT pk_types.cursor_type,
        o_show_deliver_home OUT VARCHAR2,
        o_error             OUT t_error_out
    ) RETURN BOOLEAN IS
        l_req_type      drug_req.flg_type%TYPE;
        l_prof_cat_type profile_template.flg_type%TYPE;
        l_dummy         BOOLEAN := FALSE;
    BEGIN
        g_error             := 'GET SYS CONFIGS';
        o_show_deliver_home := nvl(pk_sysconfig.get_config(i_code_cf => 'PHARMACY_CAN_DELIVER_AT_HOME_VISIBLE',
                                                           i_prof    => i_prof),
                                   g_yes);
    
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error    := 'GET REQ TYPE';
        l_req_type := get_req_type(i_drug_req_det(1), NULL);
    
        g_error := 'GET DISPENSE UNITS';
        l_dummy := get_dispense_units(i_lang, i_prof, o_units, o_error);
    
        IF (l_req_type = g_flg_adm)
        THEN
            --admin local
        
            OPEN o_drug FOR
                SELECT drd.id_drug_req_det,
                       get_medication_name(i_lang,
                                           i_prof,
                                           drd.id_drug,
                                           drd.vers,
                                           dr.flg_type,
                                           dr.id_drug_presc_det,
                                           g_yes,
                                           drd.id_other_product) pharm,
                       get_drug_desc_instr(i_lang, i_prof, dr.id_episode, drd.id_drug_req_det) instr,
                       get_attention_pipe_str(i_lang, i_prof, drd.id_drug_req_det) attention,
                       drd.qty_req,
                       drd.id_unit_measure,
                       get_qty_pending(i_prof, drd.id_drug_req_det) qty_to_prep,
                       drd.id_unit_measure_prep,
                       pk_medication_core.get_unit_translation(i_lang, i_prof, drd.id_unit_measure, 3) qty_unit,
                       pk_medication_core.get_unit_translation(i_lang, i_prof, drd.id_unit_measure_prep, 3) qty_unit_to_prep,
                       get_notes_from_drd(drd.id_drug_req_det,
                                          table_number(get_state_for_req_type(i_prof, l_req_type, g_drd_requested_st)),
                                          1,
                                          g_yes) physician_notes,
                       get_notes_from_drd(drd.id_drug_req_det,
                                          table_number(drd.id_state,
                                                       get_state_for_req_type(i_prof, l_req_type, g_drd_validated_st),
                                                       get_state_for_req_type(i_prof, l_req_type, g_drd_waiting_approv_st),
                                                       get_state_for_req_type(i_prof, l_req_type, g_drd_validated_sign_st),
                                                       get_state_for_req_type(i_prof, l_req_type, g_drd_rejected2prep_st)),
                                          2,
                                          g_yes) pharmacist_notes,
                       mmd.id_unit_dispense default_unit_dispense,
                       dpd.id_drug,
                       dpd.vers
                  FROM drug_req_det drd
                 INNER JOIN drug_req dr
                    ON (drd.id_drug_req = dr.id_drug_req)
                  LEFT JOIN mi_med_dosage mmd
                    ON (drd.id_drug = mmd.id_drug AND drd.vers = mmd.version)
                  LEFT JOIN drug_presc_det dpd
                    ON (dr.id_drug_presc_det = dpd.id_drug_presc_det)
                 WHERE drd.id_drug_req_det IN (SELECT column_value
                                                 FROM TABLE(i_drug_req_det))
                 ORDER BY pharm;
        
        ELSIF (l_req_type = g_flg_int)
        THEN
            --ambulatorio
        
            l_prof_cat_type := get_prof_type(i_prof);
        
            OPEN o_drug FOR
                SELECT drd.id_drug_req_det,
                       get_medication_name(i_lang,
                                           i_prof,
                                           drd.id_drug,
                                           drd.vers,
                                           dr.flg_type,
                                           dr.id_drug_presc_det,
                                           g_yes,
                                           drd.id_other_product) pharm,
                       get_drug_desc_instr(i_lang, i_prof, dr.id_episode, drd.id_drug_req_det) instr,
                       get_attention_pipe_str(i_lang, i_prof, drd.id_drug_req_det) attention,
                       drd.qty_req,
                       drd.id_unit_measure,
                       get_qty_pending(i_prof, drd.id_drug_req_det) qty_to_prep,
                       drd.id_unit_measure_prep,
                       pk_medication_core.get_unit_translation(i_lang, i_prof, drd.id_unit_measure, 3) qty_unit,
                       pk_medication_core.get_unit_translation(i_lang, i_prof, drd.id_unit_measure_prep, 3) qty_unit_to_prep,
                       get_notes_from_drd(drd.id_drug_req_det,
                                          table_number(get_state_for_req_type(i_prof, l_req_type, g_drd_requested_st)),
                                          1,
                                          g_yes) physician_notes,
                       get_notes_from_drd(drd.id_drug_req_det,
                                          table_number(drd.id_state,
                                                       get_state_for_req_type(i_prof, l_req_type, g_drd_validated_st),
                                                       get_state_for_req_type(i_prof, l_req_type, g_drd_waiting_approv_st),
                                                       get_state_for_req_type(i_prof, l_req_type, g_drd_validated_sign_st),
                                                       get_state_for_req_type(i_prof, l_req_type, g_drd_rejected2prep_st)),
                                          2,
                                          g_yes) pharmacist_notes,
                       mr.suggested_descr recm,
                       pk_date_utils.date_send_tsz(i_lang,
                                                   get_next_appointment_date(i_lang,
                                                                             dr.id_patient,
                                                                             i_prof,
                                                                             l_prof_cat_type),
                                                   i_prof) dt_next_appointment,
                       decode(drd.req_to_be_delivered_at_home,
                              g_yes,
                              pk_sysdomain.get_domain('PHARMACY_REQ_DELIVER_AT_HOME', g_yes, i_lang),
                              g_no,
                              pk_sysdomain.get_domain('PHARMACY_REQ_DELIVER_AT_HOME', g_no, i_lang),
                              pk_sysdomain.get_domain('PHARMACY_REQ_DELIVER_AT_HOME', '-', i_lang)) deliver_home,
                       mmd.id_unit_dispense default_unit_dispense,
                       dpd.id_drug,
                       dpd.vers
                  FROM drug_req_det drd
                 INNER JOIN drug_req dr
                    ON (drd.id_drug_req = dr.id_drug_req)
                  LEFT JOIN mi_regulation mr
                    ON (drd.regulation_id = mr.regulation_id AND drd.vers = mr.vers)
                  LEFT JOIN mi_med_dosage mmd
                    ON (drd.id_drug = mmd.id_drug AND drd.vers = mmd.version)
                  LEFT JOIN drug_presc_det dpd
                    ON (dr.id_drug_presc_det = dpd.id_drug_presc_det)
                 WHERE drd.id_drug_req_det IN (SELECT column_value
                                                 FROM TABLE(i_drug_req_det))
                 ORDER BY pharm;
        
        ELSIF (l_req_type = g_flg_unidose)
        THEN
            --unidose
        
            OPEN o_drug FOR
                SELECT v1.id_drug_req_det,
                       get_medication_name(i_lang,
                                           i_prof,
                                           v1.id_drug,
                                           v1.vers,
                                           v1.flg_type,
                                           v1.id_drug_presc_det,
                                           g_yes,
                                           v1.id_other_product) pharm,
                       get_drug_desc_instr(i_lang, i_prof, v1.id_episode, v1.id_drug_req_det) instr,
                       get_attention_pipe_str(i_lang, i_prof, v1.id_drug_req_det) attention,
                       v1.qty_req,
                       v1.id_unit_measure,
                       get_qty_pending(i_prof, v1.id_drug_req_det) qty_to_prep,
                       v1.id_unit_measure_prep,
                       pk_medication_core.get_unit_translation(i_lang, i_prof, v1.id_unit_measure, 3) qty_unit,
                       pk_medication_core.get_unit_translation(i_lang, i_prof, v1.id_unit_measure_prep, 3) qty_unit_to_prep,
                       get_notes_from_drd(v1.id_drug_req_det,
                                          table_number(get_state_for_req_type(i_prof, l_req_type, g_drd_requested_st)),
                                          1,
                                          g_yes) physician_notes,
                       get_notes_from_drd(v1.id_drug_req_det,
                                          table_number(v1.id_state,
                                                       get_state_for_req_type(i_prof, l_req_type, g_drd_validated_st),
                                                       get_state_for_req_type(i_prof, l_req_type, g_drd_waiting_approv_st),
                                                       get_state_for_req_type(i_prof, l_req_type, g_drd_validated_sign_st),
                                                       get_state_for_req_type(i_prof, l_req_type, g_drd_rejected2prep_st)),
                                          2,
                                          g_yes) pharmacist_notes,
                       v1.order_allocation.id_unidose_car id_unidose_car,
                       v1.order_allocation.car_model_name || ' ' ||
                       pk_date_utils.dt_chr(i_lang, uc.dt_car_begin, i_prof) ||
                       decode(uc.dt_car_end,
                              NULL,
                              '',
                              ' ' || pk_message.get_message(i_lang, 'PHARMACIST_UNIDOSE_CAR_DATE_INTERVAL') || ' ' ||
                              pk_date_utils.dt_chr(i_lang, uc.dt_car_end, i_prof)) car_model_name,
                       v1.order_allocation.slot_number slot_number,
                       nvl(v1.order_allocation.slot_name, '') slot_name,
                       mmd.id_unit_dispense default_unit_dispense,
                       dpd.id_drug,
                       dpd.vers
                  FROM (SELECT drd.id_drug_req_det,
                               drd.id_drug,
                               drd.vers,
                               drd.id_other_product,
                               drd.qty_req,
                               drd.id_unit_measure,
                               drd.id_unit_measure_prep,
                               drd.id_state,
                               dr.flg_type,
                               dr.id_drug_presc_det,
                               dr.id_episode,
                               get_unidose_order_allocation(i_lang, drd.id_drug_req_det) order_allocation
                          FROM drug_req_det drd, drug_req dr
                         WHERE drd.id_drug_req = dr.id_drug_req
                           AND drd.id_drug_req_det IN (SELECT column_value
                                                         FROM TABLE(i_drug_req_det))) v1
                  LEFT JOIN mi_med_dosage mmd
                    ON (v1.id_drug = mmd.id_drug AND v1.vers = mmd.version)
                  LEFT JOIN drug_presc_det dpd
                    ON (v1.id_drug_presc_det = dpd.id_drug_presc_det)
                  LEFT JOIN pharm_unidose_car uc
                    ON (v1.order_allocation.id_unidose_car = uc.id_unidose_car)
                 ORDER BY pharm;
        
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_pat_prepare', o_error);
            pk_types.open_my_cursor(o_drug);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_units);
            RETURN FALSE;
    END get_pat_prepare;

    /********************************************************************************************
    * alert.pk_pharmacy.get_pat_name
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_PATIENT                    IN    NUMBER(24)
    *
    * @return VARCHAR2
    *
    * @author Rui Marante
    * @version  2.5.0.7.7
    * @since  2010-02-25
    *
    ********************************************************************************************/
    FUNCTION get_pat_name
    (
        i_lang       IN language.id_language%TYPE,
        i_prof       IN alert.profissional,
        i_id_patient IN patient.id_patient%TYPE
    ) RETURN VARCHAR2 IS
        l_pat_name VARCHAR2(4000 CHAR);
        l_error    t_error_out;
    BEGIN
        g_error := 'GET_PAT_NAME';
        --TBD: mudar isto para usar as novas funcoes do ADT get_pat_name ... VIP ...
        l_pat_name := pk_adt.get_patient_name(i_lang         => i_lang,
                                              i_prof         => i_prof,
                                              i_patient      => i_id_patient,
                                              i_is_prof_resp => 0);
    
        RETURN l_pat_name;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_pat_name', l_error);
            RAISE;
    END get_pat_name;

    /********************************************************************************************
    * alert.pk_pharmacy.get_supply_slot
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DRUG_REQ_SUPPLY            IN    NUMBER(24)
    * @param  I_FORMAT                        IN    VARCHAR2
    *
    * @return VARCHAR2
    *
    * @author Rui Marante
    * @version  2.5.0.7.7
    * @since  2010-02-25
    *
    ********************************************************************************************/
    FUNCTION get_supply_slot
    (
        i_lang               IN language.id_language%TYPE,
        i_prof               IN alert.profissional,
        i_id_drug_req_supply IN drug_req_supply.id_drug_req_supply%TYPE,
        i_format             IN VARCHAR2 -- WITH_LABEL | WITHOUT_LABEL
    ) RETURN VARCHAR2 IS
        l_slot      pharm_unidose_slot_content.slot_number%TYPE;
        l_slot_name sys_message.desc_message%TYPE := '';
        l_slot_txt  VARCHAR2(4000 CHAR) := '';
        l_error     t_error_out;
    BEGIN
        g_error := 'GET_SUPPLY_SLOT';
        SELECT v1.slot_number
          INTO l_slot
          FROM (SELECT usc.slot_number
                  FROM drug_req_supply drs
                 INNER JOIN drug_req_det drd
                    ON (drs.id_drug_req_det = drs.id_drug_req_det)
                  LEFT JOIN pharm_unidose_slot_content usc
                    ON (drd.id_drug_req_det = usc.id_drug_req_det)
                 WHERE drs.id_drug_req_supply = i_id_drug_req_supply
                 ORDER BY usc.slot_number NULLS LAST) v1
         WHERE rownum = 1;
    
        l_slot_txt := to_char(l_slot);
    
        IF (l_slot IS NOT NULL AND i_format = 'WITH_LABEL')
        THEN
            l_slot_name := pk_message.get_message(i_lang, 'PHARMACIST_UNIDOSE_DRAWER');
            l_slot_txt  := l_slot_name || ' ' || l_slot_txt;
        END IF;
    
        RETURN l_slot_txt;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_supply_slot', l_error);
            RAISE;
    END get_supply_slot;

    /********************************************************************************************
    * alert.pk_pharmacy.set_pat_deliver
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_DRUG_REQ_DET                  IN    ALERT.TABLE_NUMBER
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-02
    *
    ********************************************************************************************/
    FUNCTION set_pat_deliver
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN alert.profissional,
        i_drug_req_det IN table_number,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
        l_state_transition_ok BOOLEAN := FALSE;
        l_datetime            drug_req_det.dt_last_change%TYPE;
        l_drs_id              drug_req_supply.id_drug_req_supply%TYPE;
        l_current_sup_state   drug_req_supply.id_state%TYPE;
        l_row_count           NUMBER := 0;
    
        CURSOR req_supplies(id_req IN drug_req_det.id_drug_req_det%TYPE) IS
            SELECT drs.id_drug_req_supply, drs.id_state
              FROM drug_req_supply drs
             WHERE drs.id_drug_req_det = id_req
               AND drs.id_state IN
                   (SELECT column_value
                      FROM TABLE(get_states_for_req_type(i_prof,
                                                         NULL,
                                                         table_varchar(g_drs_readyforvalid_st, g_drs_readyfortransp_st))));
    BEGIN
        l_datetime  := current_timestamp;
        l_row_count := i_drug_req_det.count;
    
        FOR i IN 1 .. l_row_count
        LOOP
        
            OPEN req_supplies(i_drug_req_det(i));
            LOOP
                FETCH req_supplies
                    INTO l_drs_id, l_current_sup_state;
                EXIT WHEN req_supplies%NOTFOUND;
            
                l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                                 i_prof,
                                                                                 l_current_sup_state,
                                                                                 get_state_for_req_type(i_prof,
                                                                                                        NULL,
                                                                                                        g_drs_delivered2pat_st));
            
                IF (l_state_transition_ok)
                THEN
                    UPDATE drug_req_supply drs
                       SET drs.id_state = get_state_for_req_type(i_prof, NULL, g_drs_delivered2pat_st)
                     WHERE drs.id_drug_req_supply = l_drs_id;
                
                    INSERT INTO drug_req_sup_state_transition
                        (id_drug_req_supply, id_state, id_prof, dt_state)
                    VALUES
                        (l_drs_id, get_state_for_req_type(i_prof, NULL, g_drs_delivered2pat_st), i_prof.id, l_datetime);
                ELSE
                    g_error := 'INVALID SUPPLY STATE';
                    RAISE g_ex_cannot_be_delivered;
                END IF;
            END LOOP;
            CLOSE req_supplies;
        
        END LOOP;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            IF (req_supplies%ISOPEN)
            THEN
                CLOSE req_supplies;
            END IF;
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'set_pat_deliver', o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_pat_deliver;

    /********************************************************************************************
    * alert.pk_pharmacy.set_pat_transport (overload 1)
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DRS                        IN    ALERT.TABLE_NUMBER
    * @param  I_BEGIN_OR_END                  IN    VARCHAR2
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @author Rui Marante
    * @version  2.5.0.7.4
    * @since  2009-12-07
    *
    ********************************************************************************************/
    PROCEDURE set_pat_transport
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN alert.profissional,
        i_id_drs       IN table_number,
        i_begin_or_end IN VARCHAR2 DEFAULT 'B', -- B=BEGIN | E=END
        o_error        OUT t_error_out
    ) IS
        l_state_transition_ok BOOLEAN := FALSE;
        l_datetime            drug_req_sup_state_transition.dt_state%TYPE;
        l_current_sup_state   drug_req_supply.id_state%TYPE;
        l_end_sup_state       drug_req_supply.id_state%TYPE;
        l_row_count           NUMBER := 0;
        l_sys_alert_event     sys_alert_event%ROWTYPE;
        l_id_episode          drug_req.id_episode%TYPE;
        l_flg_off_car         drug_req_det.flg_uni_out_off_car%TYPE;
    
        --
        CURSOR c_status(l_id_drs IN drug_req_supply.id_drug_req_supply%TYPE) IS
            SELECT p.flg_status_old AS l_old_status,
                   p.id_presc AS id_presc,
                   decode(dpd.flg_status, 'F', 'F', p.flg_status_old) AS dpd_l_old_status,
                   b.id_episode AS id_episode
              FROM prescription_instr_hist p,
                   drug_presc_det dpd,
                   (SELECT pih.id_presc, dr.id_episode, MAX(pih.id_prescription_instr_hist) AS id_max
                      FROM drug_req_supply         drs,
                           drug_req_det            drd,
                           drug_req                dr,
                           prescription_instr_hist pih,
                           drug_presc_det          dpd,
                           mi_med                  mi
                     WHERE drs.id_drug_req_supply = l_id_drs
                       AND drd.id_drug_req_det = drs.id_drug_req_det
                       AND dr.id_drug_req = drd.id_drug_req
                       AND dr.id_drug_presc_det = pih.id_presc
                       AND dpd.id_drug_presc_det = dr.id_drug_presc_det
                       AND pih.prescription_table = pk_medication_core.g_drug_presc_det_table
                       AND mi.id_drug = dpd.id_drug
                       AND mi.vers = pk_sysconfig.get_config('PRESCRIPTION_TYPE', i_prof)
                       AND pih.flg_status_new IN ('H', 'R')
                       AND pih.flg_status_old NOT IN ('S', 'H')
                       AND dpd.flg_status IN ('H', 'R')
                     GROUP BY pih.id_presc, dr.id_episode) b
             WHERE b.id_max = p.id_prescription_instr_hist
               AND dpd.id_drug_presc_det = p.id_presc
            
            UNION ALL
            --outros produtos
            SELECT p.flg_status_old AS l_old_status,
                   p.id_presc AS id_presc,
                   decode(dpd.flg_status, 'F', 'F', p.flg_status_old) AS dpd_l_old_status,
                   b.id_episode AS id_episode
              FROM prescription_instr_hist p,
                   drug_presc_det dpd,
                   (SELECT pih.id_presc, dr.id_episode, MAX(pih.id_prescription_instr_hist) AS id_max
                      FROM drug_req_supply         drs,
                           drug_req_det            drd,
                           drug_req                dr,
                           prescription_instr_hist pih,
                           drug_presc_det          dpd,
                           other_product           op
                     WHERE drs.id_drug_req_supply = l_id_drs
                       AND drd.id_drug_req_det = drs.id_drug_req_det
                       AND dr.id_drug_req = drd.id_drug_req
                       AND dr.id_drug_presc_det = pih.id_presc
                       AND dpd.id_drug_presc_det = dr.id_drug_presc_det
                       AND pih.prescription_table = pk_medication_core.g_drug_presc_det_table
                       AND op.id_other_product = dpd.id_other_product
                       AND op.vers = pk_sysconfig.get_config('PRESCRIPTION_TYPE', i_prof)
                       AND pih.flg_status_new IN ('H', 'R')
                       AND pih.flg_status_old NOT IN ('S', 'H')
                       AND dpd.flg_status IN ('H', 'R')
                     GROUP BY pih.id_presc, dr.id_episode) b
             WHERE b.id_max = p.id_prescription_instr_hist
               AND dpd.id_drug_presc_det = p.id_presc;
    
        r_status c_status%ROWTYPE;
        l_rows   table_varchar;
    BEGIN
    
        l_datetime  := current_timestamp;
        l_row_count := i_id_drs.count;
    
        FOR i IN 1 .. l_row_count
        LOOP
            IF (i_begin_or_end = 'B')
            THEN
                --begin transport
                get_flg_off_car(i_lang               => i_lang,
                                i_prof               => i_prof,
                                i_id_drug_req_supply => i_id_drs(i),
                                o_flg_off_car        => l_flg_off_car);
            
                IF (l_flg_off_car = 'N')
                THEN
                    l_end_sup_state := get_state_for_req_type(i_prof, NULL, g_drs_in_transit_st); -- from g_drs_readyfortransp_st
                ELSE
                    l_end_sup_state := get_state_for_req_type(i_prof, NULL, g_drs_uni_in_transit_st); -- from g_drs_readyfortransp_st
                END IF;
            ELSE
                --end transport
                l_end_sup_state := get_state_for_req_type(i_prof, NULL, g_drs_supplied_st); -- from g_drs_in_transit_st
            END IF;
        
            BEGIN
                SELECT dr.id_episode
                  INTO l_id_episode
                  FROM drug_req dr
                  JOIN drug_req_det drd
                    ON (dr.id_drug_req = drd.id_drug_req)
                  JOIN drug_req_supply drs
                    ON (drd.id_drug_req_det = drs.id_drug_req_det)
                 WHERE drs.id_drug_req_supply = i_id_drs(i);
            
            EXCEPTION
                WHEN no_data_found THEN
                    --l_id_episode := null;
                    RAISE;
            END;
        
            SELECT drs.id_state
              INTO l_current_sup_state
              FROM drug_req_supply drs
             WHERE drs.id_drug_req_supply = i_id_drs(i);
        
            l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                             i_prof,
                                                                             l_current_sup_state,
                                                                             l_end_sup_state);
        
            IF (l_state_transition_ok)
            THEN
                UPDATE drug_req_supply drs
                   SET drs.id_state = l_end_sup_state
                 WHERE drs.id_drug_req_supply = i_id_drs(i);
            
                INSERT INTO drug_req_sup_state_transition
                    (id_drug_req_supply, id_state, id_prof, dt_state)
                VALUES
                    (i_id_drs(i), l_end_sup_state, i_prof.id, l_datetime);
            
                --BEGIN update physician and nurse grids!
                OPEN c_status(i_id_drs(i));
                FETCH c_status
                    INTO r_status;
                g_found := c_status%FOUND;
                CLOSE c_status;
            
                IF (i_begin_or_end = 'E')
                THEN
                
                    ts_drug_presc_det.upd(id_drug_presc_det_in => r_status.id_presc,
                                          flg_status_in        => r_status.l_old_status,
                                          rows_out             => l_rows);
                
                    t_data_gov_mnt.process_update(i_lang,
                                                  i_prof,
                                                  'DRUG_PRESC_DET',
                                                  l_rows,
                                                  o_error,
                                                  table_varchar('FLG_STATUS'));
                ELSE
                    -- remover alerta 13 da tabela sys_alert_event --
                    g_error                        := 'DELETE FROM SYS_ALERT_EVENT';
                    l_sys_alert_event.id_sys_alert := 13;
                    l_sys_alert_event.id_episode   := nvl(r_status.id_episode, l_id_episode);
                    l_sys_alert_event.id_record    := i_id_drs(i);
                
                    IF NOT pk_alerts.delete_sys_alert_event(i_lang            => i_lang,
                                                            i_prof            => i_prof,
                                                            i_sys_alert_event => l_sys_alert_event,
                                                            o_error           => o_error)
                    THEN
                        pk_alertlog.log_error(g_error);
                    END IF;
                END IF;
                --END update_grids_physician_and_nurse
            
                --update_grids (main grids, including the anciliary grid)
                g_error := 'CALL TO PK_PRESCRIPTION_INT.INSERT_DRUG_REQ_TASK';
                IF NOT pk_prescription_int.insert_drug_req_task(i_lang          => i_lang,
                                                                i_episode       => nvl(r_status.id_episode, l_id_episode),
                                                                i_prof          => i_prof,
                                                                i_prof_cat_type => NULL,
                                                                o_error         => o_error)
                THEN
                    raise_application_error(-20001, o_error.ora_sqlerrm);
                END IF;
            
                g_error := 'CALL TO PK_GRID.DELETE_EPIS_GRID_TASK';
                IF NOT pk_grid.delete_epis_grid_task(i_lang    => i_lang,
                                                     i_episode => nvl(r_status.id_episode, l_id_episode),
                                                     o_error   => o_error)
                THEN
                    raise_application_error(-20001, o_error.ora_sqlerrm);
                END IF;
            
            ELSE
                g_error := 'INVALID SUPPLY STATE';
                RAISE g_ex_cannot_be_transported_drs;
            END IF;
        
        END LOOP;
    
    EXCEPTION
        WHEN OTHERS THEN
            IF (c_status%ISOPEN)
            THEN
                CLOSE c_status;
            END IF;
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'set_pat_transport', o_error);
            RAISE;
    END set_pat_transport;

    /********************************************************************************************
    * alert.pk_pharmacy.set_pat_transport (overload 2)
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DRS                        IN    ALERT.TABLE_NUMBER
    * @param  I_BEGIN_OR_END                  IN    VARCHAR2
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.4
    * @since  2009-12-07
    *
    ********************************************************************************************/
    FUNCTION set_pat_transport
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN alert.profissional,
        i_id_drs       IN table_number,
        i_begin_or_end IN VARCHAR2 DEFAULT 'B', -- B=BEGIN | E=END
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        g_error := 'SET_PAT_TRANSPORT';
        set_pat_transport(i_lang         => i_lang,
                          i_prof         => i_prof,
                          i_id_drs       => i_id_drs,
                          i_begin_or_end => i_begin_or_end,
                          o_error        => o_error);
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'set_pat_transport', o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_pat_transport;

    /********************************************************************************************
    * alert.pk_pharmacy.set_pat_transport_drd
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DRD                        IN    ALERT.TABLE_NUMBER
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.6.1
    * @since  2010-02-12
    *
    ********************************************************************************************/
    FUNCTION set_pat_transport_drd
    (
        i_lang   IN language.id_language%TYPE,
        i_prof   IN alert.profissional,
        i_id_drd IN table_number,
        o_error  OUT t_error_out
    ) RETURN BOOLEAN IS
        l_id_drs table_number := table_number();
    BEGIN
    
        FOR i IN 1 .. i_id_drd.count
        LOOP
            l_id_drs.delete;
        
            SELECT drs.id_drug_req_supply
              BULK COLLECT
              INTO l_id_drs
              FROM drug_req_supply drs
             WHERE drs.id_drug_req_det = i_id_drd(i)
               AND drs.id_state IN
                   (SELECT column_value
                      FROM TABLE(get_states_for_req_type(i_prof,
                                                         NULL,
                                                         table_varchar(g_drs_in_transit_st, g_drs_uni_in_transit_st))));
        
            IF (l_id_drs.count > 0)
            THEN
                g_error := 'SET_PAT_TRANSPORT';
                set_pat_transport(i_lang         => i_lang,
                                  i_prof         => i_prof,
                                  i_id_drs       => l_id_drs,
                                  i_begin_or_end => 'E',
                                  o_error        => o_error);
            END IF;
        
        END LOOP;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'set_pat_transport_drd', o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_pat_transport_drd;

    /********************************************************************************************
    * alert.pk_pharmacy.set_pat_transport_back
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DRS_DEV                    IN    ALERT.TABLE_NUMBER
    * @param  I_BEGIN_OR_END                  IN    VARCHAR2
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-07-09
    *
    ********************************************************************************************/
    FUNCTION set_pat_transport_back
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN alert.profissional,
        i_id_drs_dev   IN table_number,
        i_begin_or_end IN VARCHAR2 DEFAULT 'B', -- B=BEGIN | E=END
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
        l_state_transition_ok BOOLEAN := FALSE;
        l_datetime            drug_req_sup_dev_state_trans.dt_state%TYPE;
        l_current_dev_state   drug_req_supply_dev.id_state%TYPE;
        l_end_dev_state       drug_req_supply_dev.id_state%TYPE;
        l_row_count           NUMBER := 0;
        l_sys_alert_event     sys_alert_event%ROWTYPE;
        l_id_episode          episode.id_episode%TYPE;
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'set_pat_transport_back';
    BEGIN
        l_datetime  := current_timestamp;
        l_row_count := i_id_drs_dev.count;
    
        IF (i_begin_or_end = 'B')
        THEN
            --begin transport
            l_end_dev_state := get_state_for_req_type(i_prof, NULL, g_drs_returning_st); -- from g_drs_to_return_st
        ELSE
            --end transport
            l_end_dev_state := get_state_for_req_type(i_prof, NULL, g_drs_returned_st); --from g_drs_returning_st
        END IF;
    
        FOR i IN 1 .. l_row_count
        LOOP
            SELECT drsd.id_state
              INTO l_current_dev_state
              FROM drug_req_supply_dev drsd
             WHERE drsd.id_drug_req_supply_dev = i_id_drs_dev(i);
        
            l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                             i_prof,
                                                                             l_current_dev_state,
                                                                             l_end_dev_state);
        
            IF (l_state_transition_ok)
            THEN
                UPDATE drug_req_supply_dev drsd
                   SET drsd.id_state = l_end_dev_state
                 WHERE drsd.id_drug_req_supply_dev = i_id_drs_dev(i);
            
                INSERT INTO drug_req_sup_dev_state_trans
                    (id_drug_req_supply_dev, id_state, id_prof, dt_state)
                VALUES
                    (i_id_drs_dev(i), l_end_dev_state, i_prof.id, l_datetime);
            ELSE
                g_error := 'INVALID DEV STATE';
                RAISE g_ex_cannot_be_transported_drs;
            END IF;
        
            --remover o alerta de transporte de devoluo em atraso
            SELECT dr.id_episode
              INTO l_id_episode
              FROM drug_req_supply_dev drsd
             INNER JOIN drug_req_supply drs
                ON (drsd.id_drug_req_supply = drs.id_drug_req_supply)
             INNER JOIN drug_req_det drd
                ON (drs.id_drug_req_det = drd.id_drug_req_det)
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             WHERE drsd.id_drug_req_supply_dev = i_id_drs_dev(i);
        
            g_error                        := 'DELETE FROM SYS_ALERT_EVENT';
            l_sys_alert_event.id_sys_alert := 13;
            l_sys_alert_event.id_episode   := l_id_episode;
            l_sys_alert_event.id_record    := i_id_drs_dev(i);
        
            IF NOT pk_alerts.delete_sys_alert_event(i_lang            => i_lang,
                                                    i_prof            => i_prof,
                                                    i_sys_alert_event => l_sys_alert_event,
                                                    o_error           => o_error)
            THEN
                set_pharmacy_log(l_db_object_name, 'process_alerts: g_error=' || g_error);
                RAISE g_exception;
            END IF;
        
            IF (i_begin_or_end = 'E')
            THEN
                --update_grids (main grids, including the anciliary grid)
                g_error := 'CALL TO PK_PRESCRIPTION_INT.INSERT_DRUG_REQ_TASK';
                IF NOT pk_prescription_int.insert_drug_req_task(i_lang          => i_lang,
                                                                i_episode       => l_id_episode,
                                                                i_prof          => i_prof,
                                                                i_prof_cat_type => NULL,
                                                                o_error         => o_error)
                THEN
                    set_pharmacy_log(l_db_object_name, 'insert_drug_req_task: g_error=' || g_error);
                    raise_application_error(-20001, o_error.ora_sqlerrm);
                END IF;
            END IF;
        
        END LOOP;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'set_pat_transport_back', o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_pat_transport_back;

    /********************************************************************************************
    * alert.pk_pharmacy.get_pat_2check
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_DRUG_REQ_DET                  IN    ALERT.TABLE_NUMBER
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  O_DRUG                          OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-02
    *
    ********************************************************************************************/
    FUNCTION get_pat_2check
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN alert.profissional,
        i_drug_req_det IN table_number,
        i_get_headers  IN VARCHAR2 DEFAULT 'N',
        i_header_codes IN table_varchar DEFAULT NULL,
        o_drug         OUT pk_types.cursor_type,
        o_headers      OUT pk_types.cursor_type,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error := 'GET O_DRUG';
        OPEN o_drug FOR
            SELECT v1.id_drug_req_det,
                   get_medication_name(i_lang,
                                       i_prof,
                                       v1.id_drug,
                                       v1.vers,
                                       v1.flg_type,
                                       v1.id_drug_presc_det,
                                       g_yes,
                                       v1.id_other_product) pharm,
                   get_drug_desc_instr(i_lang, i_prof, v1.id_episode, v1.id_drug_req_det) instr,
                   get_attention_pipe_str(i_lang, i_prof, v1.id_drug_req_det) attention,
                   v1.qty_to_prep,
                   pk_medication_core.get_unit_translation(i_lang, i_prof, v1.id_unit_measure_prep, 3) qty_unit,
                   v1.qty_sup,
                   v1.flg_type flg_type,
                   get_notes_from_drs(v1.id_drug_req_det,
                                      table_number(get_state_for_req_type(i_prof, NULL, g_drs_readyforvalid_st)),
                                      1,
                                      'Y') notes_prepare
              FROM (SELECT drd.id_drug_req_det,
                           drd.id_drug,
                           drd.vers,
                           drd.qty_to_prep,
                           drd.id_unit_measure_prep,
                           dr.flg_type,
                           dr.id_drug_presc_det,
                           dr.id_episode,
                           SUM(drs.qty_supply) qty_sup,
                           drd.id_other_product
                      FROM drug_req_det drd, drug_req dr, drug_req_supply drs
                     WHERE drd.id_drug_req = dr.id_drug_req
                       AND drd.id_drug_req_det = drs.id_drug_req_det(+)
                       AND drd.id_drug_req_det IN (SELECT column_value
                                                     FROM TABLE(i_drug_req_det))
                       AND drs.id_state = get_state_for_req_type(i_prof, NULL, g_drs_readyforvalid_st)
                     GROUP BY drd.id_drug_req_det,
                              drd.id_drug,
                              drd.vers,
                              drd.qty_to_prep,
                              drd.id_unit_measure_prep,
                              dr.flg_type,
                              dr.id_drug_presc_det,
                              dr.id_episode,
                              drd.id_other_product) v1
             ORDER BY pharm;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_pat_2check_adm', o_error);
            pk_types.open_my_cursor(o_drug);
            pk_types.open_my_cursor(o_headers);
            RETURN FALSE;
    END get_pat_2check;

    /********************************************************************************************
    * alert.pk_pharmacy.set_pat_2check
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_DRUG_REQ_DET                  IN    ALERT.TABLE_NUMBER
    * @param  I_NOTES_PHYSICIAN               IN    ALERT.TABLE_VARCHAR
    * @param  I_NOTES_PHARMACIST              IN    ALERT.TABLE_VARCHAR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-02
    *
    ********************************************************************************************/
    FUNCTION set_pat_2check
    (
        i_lang             IN language.id_language%TYPE,
        i_prof             IN alert.profissional,
        i_drug_req_det     IN table_number,
        i_notes_physician  IN table_varchar,
        i_notes_pharmacist IN table_varchar,
        o_error            OUT t_error_out
    ) RETURN BOOLEAN IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'set_pat_2check';
        l_tbl_dummy table_table_number;
    BEGIN
        set_pat_2check(i_lang             => i_lang,
                       i_prof             => i_prof,
                       i_drug_req_det     => i_drug_req_det,
                       i_notes_physician  => i_notes_physician,
                       i_notes_pharmacist => i_notes_pharmacist,
                       o_supplies         => l_tbl_dummy);
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_pat_2check;

    /********************************************************************************************
    * This is a comment to be displayed in an html page.
    *
    * @param i_id_drug_req_det   drug_req_det identifier
    *
    *
    * @return                episode identifier or null
    *
    * @raises                InvalidRule Example on how an exception can be defined as being    raised
    *
    * @author                Pedro Santos
    * @version               2.5.0.8
    * @since                 2010/03/11
    * @dependents            <PACKAGE_NAME>.<FUNCTION_NAME>    <TEAM_TO_ADVISE>
    *********************************************************************************************/
    FUNCTION get_episode_drug_req_det(i_id_drug_req_det IN drug_req_det.id_drug_req_det%TYPE)
        RETURN drug_req.id_episode%TYPE IS
        l_id_episode drug_req.id_episode%TYPE;
    BEGIN
        SELECT id_episode
          INTO l_id_episode
          FROM drug_req dr, drug_req_det drd
         WHERE drd.id_drug_req = dr.id_drug_req
           AND drd.id_drug_req_det = i_id_drug_req_det;
    
        RETURN l_id_episode;
    
    EXCEPTION
        WHEN no_data_found THEN
            RETURN NULL;
        WHEN OTHERS THEN
            RAISE;
    END get_episode_drug_req_det;

    PROCEDURE dispense_zero
    (
        i_lang                 IN language.id_language%TYPE,
        i_prof                 IN alert.profissional,
        i_id_drug_req_det      IN drug_req_det.id_drug_req_det%TYPE,
        i_dt_last_change       IN drug_req_det.dt_last_change%TYPE,
        i_qty_to_prep          IN drug_req_det.qty_to_prep%TYPE,
        i_id_unit_measure_prep IN drug_req_det.id_unit_measure_prep%TYPE,
        i_flg_co_sign          IN drug_req_det.flg_co_sign%TYPE,
        i_dt_next_dispense     IN VARCHAR2,
        i_notes_physician      IN drug_req_det_state_transition.notes1%TYPE,
        i_notes_pharmacist     IN drug_req_det_state_transition.notes2%TYPE,
        o_error                OUT t_error_out
    ) IS
        l_state_transition_ok BOOLEAN := FALSE;
        l_current_req_state   drug_req_det.id_state%TYPE;
        l_drd_next_state_id   wfl_state.id_state%TYPE;
        l_req_type            drug_req.flg_type%TYPE;
        l_prof_type           category.flg_type%TYPE;
        l_dt_next_dispense    drug_req_det.dt_next_dispense%TYPE;
    BEGIN
    
        l_req_type := get_req_type(i_id_drug_req_det, NULL);
    
        SELECT drd.id_state
          INTO l_current_req_state
          FROM drug_req_det drd
         WHERE drd.id_drug_req_det = i_id_drug_req_det;
    
        l_drd_next_state_id   := get_state_for_req_type(i_prof, l_req_type, g_drd_validated_without_wf_st);
        l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                         i_prof,
                                                                         l_current_req_state,
                                                                         l_drd_next_state_id);
    
        IF (l_state_transition_ok)
        THEN
            UPDATE drug_req_det drd
               SET drd.id_state             = l_drd_next_state_id,
                   drd.dt_last_change       = i_dt_last_change,
                   drd.qty_to_prep          = i_qty_to_prep,
                   drd.id_unit_measure_prep = i_id_unit_measure_prep,
                   drd.flg_co_sign          = i_flg_co_sign,
                   drd.id_prof_last_change  = i_prof.id,
                   drd.id_sw_last_change    = i_prof.software,
                   drd.id_inst_last_change  = i_prof.institution
             WHERE drd.id_drug_req_det = i_id_drug_req_det;
        
            INSERT INTO drug_req_det_state_transition
                (id_drug_req_det, id_state, id_prof, dt_state, notes1, notes2)
            VALUES
                (i_id_drug_req_det,
                 l_drd_next_state_id,
                 i_prof.id,
                 i_dt_last_change,
                 i_notes_physician,
                 i_notes_pharmacist);
        
            IF i_dt_next_dispense IS NOT NULL
            THEN
                l_dt_next_dispense := pk_date_utils.get_string_tstz(i_lang, i_prof, i_dt_next_dispense, NULL);
                UPDATE drug_req_det drd
                   SET drd.dt_next_dispense = l_dt_next_dispense
                 WHERE drd.id_drug_req_det = i_id_drug_req_det;
            END IF;
        ELSE
            g_error := 'INVALID STATE TRANSITION';
            RAISE g_ex_cannot_be_checked;
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'DISPENSE_ZERO', o_error);
            RAISE;
    END dispense_zero;
    /********************************************************************************************
    * alert.pk_pharmacy.set_pat_check (overload 2)
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_DRUG_REQ_DET                  IN    ALERT.TABLE_NUMBER
    * @param  I_NOTES_PHYSICIAN               IN    ALERT.TABLE_VARCHAR
    * @param  I_NOTES_PHARMACIST              IN    ALERT.TABLE_VARCHAR
    * @param  I_MED_CHANGED                   IN    ALERT.TABLE_VARCHAR
    * @param  I_ID_DRUG                       IN    ALERT.TABLE_VARCHAR
    * @param  I_DRUG_VERS                     IN    ALERT.TABLE_VARCHAR
    * @param  I_QTY_REQ                       IN    ALERT.TABLE_NUMBER
    * @param  I_QTY_UNIT                      IN    ALERT.TABLE_NUMBER
    * @param  I_QTY_PREP                      IN    ALERT.TABLE_NUMBER
    * @param  I_QTY_PREP_UNIT                 IN    ALERT.TABLE_NUMBER
    * @param  I_WAIT_FOR_APPROV               IN    ALERT.TABLE_VARCHAR
    * @param  I_COSIGNED_BY                   IN    ALERT.TABLE_NUMBER
    * @param  I_COSIGNED_DATE                 IN    ALERT.TABLE_VARCHAR
    * @param  I_COSIGNED_TYPE                 IN    ALERT.TABLE_NUMBER
    * @param  I_COSIGNED_NOTES                IN    ALERT.TABLE_VARCHAR
    * @param  I_DELIVER_AT_HOME               IN    ALERT.TABLE_VARCHAR
    * @param  I_INSTR_CHANGED                 IN    ALERT.TABLE_VARCHAR
    * @param  I_DRUG_PRESC_DET_NEW            IN    ALERT.TABLE_NUMBER
    * @param  I_MED_CHANGED_TO_NEW            IN    ALERT.TABLE_VARCHAR
    * @param  I_DT_NEXT_DISPENSE              IN    ALERT.TABLE_VARCHAR
    * @param  I_ID_PRESC_DIRECTIONS           IN    ALERT.TABLE_NUMBER
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.8
    * @since  2010-03-29
    *
    * @notes
    *
    ********************************************************************************************/
    PROCEDURE set_pat_check
    (
        i_lang                IN language.id_language%TYPE,
        i_prof                IN alert.profissional,
        i_drug_req_det        IN table_number,
        i_notes_physician     IN table_varchar,
        i_notes_pharmacist    IN table_varchar,
        i_med_changed         IN table_varchar, --Y|N
        i_id_drug             IN table_varchar,
        i_drug_vers           IN table_varchar,
        i_qty_req             IN table_number,
        i_qty_unit            IN table_number,
        i_qty_prep            IN table_number,
        i_qty_prep_unit       IN table_number,
        i_wait_for_approv     IN table_varchar, --Y|N
        i_cosigned_by         IN table_number,
        i_cosigned_date       IN table_varchar,
        i_cosigned_type       IN table_number,
        i_cosigned_notes      IN table_varchar,
        i_deliver_at_home     IN table_varchar,
        i_instr_changed       IN table_varchar, --Y|N
        i_drug_presc_det_new  IN table_number,
        i_med_changed_to_new  IN table_varchar, --Y|N
        i_dt_next_dispense    IN table_varchar DEFAULT NULL,
        i_id_presc_directions IN table_number
    ) IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'set_pat_check';
        l_row_count           NUMBER := 0;
        l_state_transition_ok BOOLEAN := FALSE;
        l_current_req_state   drug_req_det.id_state%TYPE;
        l_drd_next_state_id   wfl_state.id_state%TYPE;
        l_datetime            drug_req_det.dt_last_change%TYPE;
        l_req_type            drug_req.flg_type%TYPE;
        l_error               t_error_out;
        --
        l_co_sign_active            VARCHAR2(1 CHAR) := g_no;
        l_med_can_be_changed        VARCHAR2(1 CHAR) := g_no;
        l_instr_can_be_changed      VARCHAR2(1 CHAR) := g_no;
        l_med_can_be_changed_to_new VARCHAR2(1 CHAR) := g_no;
        --
        l_dt_next_dispense drug_req_det.dt_next_dispense%TYPE;
        --alertas
        l_ready_for_prep BOOLEAN := TRUE;
        --
        PROCEDURE process_alerts
        (
            i_flg_alert    IN BOOLEAN,
            i_drug_req_det IN drug_req_det.id_drug_req_det%TYPE
        ) IS
            l_code_interv     mi_med.med_descr%TYPE;
            l_id_episode      episode.id_episode%TYPE;
            l_sys_alert_event sys_alert_event%ROWTYPE;
        BEGIN
        
            IF (i_flg_alert = TRUE)
            THEN
            
                set_pharmacy_log(l_db_object_name, 'process_alerts: l_code_interv=' || l_code_interv);
            
                SELECT mi.med_descr
                  INTO l_code_interv
                  FROM drug_req_det drd, mi_med mi
                 WHERE drd.id_drug = mi.id_drug
                   AND drd.vers = mi.vers
                   AND drd.id_drug_req_det = i_drug_req_det;
            
                SELECT dr.id_episode
                  INTO l_id_episode
                  FROM drug_req dr, drug_req_det drd
                 WHERE drd.id_drug_req = dr.id_drug_req
                   AND drd.id_drug_req_det = i_drug_req_det;
            
                IF NOT pk_alerts.insert_sys_alert_event(i_lang                => i_lang,
                                                        i_prof                => i_prof,
                                                        i_sys_alert           => 72,
                                                        i_id_episode          => l_id_episode,
                                                        i_id_record           => i_drug_req_det,
                                                        i_dt_record           => current_timestamp,
                                                        i_id_professional     => NULL,
                                                        i_id_room             => NULL,
                                                        i_id_clinical_service => NULL,
                                                        i_flg_type_dest       => 'C',
                                                        i_replace1            => l_code_interv,
                                                        i_replace2            => pk_sysconfig.get_config('ALERT_DRUG_PREP_TIMEOUT1',
                                                                                                         i_prof),
                                                        o_error               => l_error)
                THEN
                    set_pharmacy_log(l_db_object_name, 'ERROR! (process_alerts) g_error=' || g_error);
                END IF;
            
                -- Remove o alerta 14 de requisio em atraso
                g_error                        := 'DELETE FROM SYS_ALERT_EVENT ALERT 14 SET_PAT_PREPARE';
                l_sys_alert_event.id_sys_alert := 14;
                l_sys_alert_event.id_episode   := l_id_episode;
                l_sys_alert_event.id_record    := i_drug_req_det;
            
                IF NOT pk_alerts.delete_sys_alert_event(i_lang            => i_lang,
                                                        i_prof            => i_prof,
                                                        i_sys_alert_event => l_sys_alert_event,
                                                        o_error           => l_error)
                THEN
                    set_pharmacy_log(l_db_object_name, 'ERROR! (process_alerts) g_error=' || g_error);
                END IF;
            
            END IF;
        
        EXCEPTION
            WHEN OTHERS THEN
                set_pharmacy_log(l_db_object_name, 'ERROR! process_alerts: ' || SQLERRM);
        END process_alerts;
        --
        PROCEDURE set_co_sign
        (
            i_lang        IN language.id_language%TYPE,
            i_prof        IN alert.profissional,
            i_cosigned_by IN drug_req_det.id_prof_co_sign%TYPE,
            i_id_episode  IN drug_req.id_episode%TYPE,
            i_id_drd      IN drug_req_det.id_drug_req_det%TYPE,
            i_flg_type    IN VARCHAR2,
            i_dt_req      IN TIMESTAMP WITH LOCAL TIME ZONE
        ) IS
            l_ret   BOOLEAN := FALSE;
            l_error t_error_out;
            l_db_object_name CONSTANT user_objects.object_name%TYPE := 'set_pat_check.set_co_sign';
        BEGIN
            IF (i_cosigned_by IS NOT NULL)
            THEN
                g_error := 'pk_co_sign.set_co_sign_task';
                l_ret   := pk_co_sign.set_co_sign_task(i_lang      => i_lang,
                                                       i_prof      => i_prof,
                                                       i_prof_dest => i_cosigned_by,
                                                       i_episode   => i_id_episode,
                                                       i_id_task   => i_id_drd,
                                                       i_flg_type  => i_flg_type,
                                                       i_dt_reg    => i_dt_req,
                                                       o_error     => l_error);
            
                IF (NOT l_ret)
                THEN
                    RAISE g_ex_co_sign_task;
                END IF;
            END IF;
        
        EXCEPTION
            WHEN OTHERS THEN
                set_pharmacy_log(l_db_object_name, g_error);
                process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, l_error);
                RAISE g_ex_co_sign_task;
        END set_co_sign;
        --
    BEGIN
        l_datetime  := current_timestamp;
        l_row_count := i_drug_req_det.count;
    
        g_error                     := 'GET SYS CONFIGS';
        l_co_sign_active            := nvl(pk_sysconfig.get_config(i_code_cf => 'PHARMACY_WITH_CO_SIGN',
                                                                   i_prof    => i_prof),
                                           g_no);
        l_med_can_be_changed        := nvl(pk_sysconfig.get_config(i_code_cf => 'PHARMACY_CAN_CHANGE_MEDICATION',
                                                                   i_prof    => i_prof),
                                           g_no);
        l_instr_can_be_changed      := nvl(pk_sysconfig.get_config(i_code_cf => 'PHARMACY_CAN_CHANGE_MEDICATION_INSTRUCTIONS',
                                                                   i_prof    => i_prof),
                                           g_no);
        l_med_can_be_changed_to_new := nvl(pk_sysconfig.get_config(i_code_cf => 'PHARMACY_CAN_CHANGE_MEDICATION_TO_NEW_MED',
                                                                   i_prof    => i_prof),
                                           g_no);
    
        g_error    := 'GET REQ TYPE';
        l_req_type := get_req_type(i_drug_req_det(1), NULL);
    
        FOR i IN 1 .. l_row_count
        LOOP
            IF i_qty_prep(i) = 0
            THEN
                dispense_zero(i_lang                 => i_lang,
                              i_prof                 => i_prof,
                              i_id_drug_req_det      => i_drug_req_det(i),
                              i_dt_last_change       => l_datetime,
                              i_qty_to_prep          => 0,
                              i_id_unit_measure_prep => i_qty_prep_unit(i),
                              i_flg_co_sign          => g_no,
                              i_dt_next_dispense     => i_dt_next_dispense(i),
                              i_notes_physician      => i_notes_physician(i),
                              i_notes_pharmacist     => i_notes_pharmacist(i),
                              o_error                => l_error);
            ELSE
                --unidose: next dispense
                BEGIN
                    l_dt_next_dispense := pk_date_utils.get_string_tstz(i_lang, i_prof, i_dt_next_dispense(i), NULL);
                EXCEPTION
                    WHEN OTHERS THEN
                        l_dt_next_dispense := NULL;
                END;
            
                g_error := 'GET CURRENT REQ STATE';
                SELECT drd.id_state
                  INTO l_current_req_state
                  FROM drug_req_det drd
                 WHERE drd.id_drug_req_det = i_drug_req_det(i);
            
                IF ((i_med_changed(i) = g_yes AND l_med_can_be_changed = g_yes) OR
                   (i_instr_changed(i) = g_yes AND l_instr_can_be_changed = g_yes) OR
                   (i_med_changed_to_new(i) = g_yes AND l_med_can_be_changed_to_new = g_yes))
                THEN
                
                    IF (l_co_sign_active = g_no)
                    THEN
                        l_drd_next_state_id   := get_state_for_req_type(i_prof, l_req_type, g_drd_validated_st);
                        l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                                         i_prof,
                                                                                         l_current_req_state,
                                                                                         l_drd_next_state_id);
                    ELSE
                        --co-signed
                        l_drd_next_state_id   := get_state_for_req_type(i_prof, l_req_type, g_drd_validated_sign_st);
                        l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                                         i_prof,
                                                                                         l_current_req_state,
                                                                                         l_drd_next_state_id);
                    END IF;
                
                    IF (l_state_transition_ok)
                    THEN
                    
                        IF (i_med_changed_to_new(i) = g_yes AND l_med_can_be_changed_to_new = g_yes)
                        THEN
                        
                            g_error := 'UPDATE REQ: MED_CHANGED_TO_NEW!';
                            set_pharmacy_log('set_pat_check',
                                             'i_cosigned_by(i)=' || i_cosigned_by(i) || ' i_cosigned_type(i)=' ||
                                             i_cosigned_type(i) || ' i_cosigned_date(i)=' || i_cosigned_date(i) || '#' ||
                                             pk_date_utils.get_string_tstz(i_lang, i_prof, i_cosigned_date(i), NULL));
                        
                            UPDATE drug_req_det drd
                               SET drd.id_state                    = l_drd_next_state_id,
                                   drd.dt_last_change              = l_datetime,
                                   drd.qty_to_prep                 = i_qty_prep(i),
                                   drd.id_unit_measure_prep        = i_qty_prep_unit(i),
                                   drd.flg_co_sign                 = decode(i_wait_for_approv(i), g_yes, g_no, g_yes),
                                   drd.id_prof_co_sign             = i_cosigned_by(i),
                                   drd.id_type_co_sign             = i_cosigned_type(i),
                                   drd.dt_co_sign                  = pk_date_utils.get_string_tstz(i_lang,
                                                                                                   i_prof,
                                                                                                   i_cosigned_date(i),
                                                                                                   NULL),
                                   drd.notes_co_sign               = i_cosigned_notes(i),
                                   drd.id_prof_last_change         = i_prof.id,
                                   drd.id_sw_last_change           = i_prof.software,
                                   drd.id_inst_last_change         = i_prof.institution,
                                   drd.req_to_be_delivered_at_home = nvl(i_deliver_at_home(i), g_no),
                                   drd.dt_next_dispense            = l_dt_next_dispense
                             WHERE drd.id_drug_req_det = i_drug_req_det(i);
                        
                            -- ALERT-65653 invokes pk_co_sign api to display co-sign alerts (sys_alert 45) Pedro Martins Santos
                            g_error := 'set_co_sign_task - l_state_transition_not_ok';
                            set_co_sign(i_lang        => i_lang,
                                        i_prof        => i_prof,
                                        i_cosigned_by => i_cosigned_by(i),
                                        i_id_episode  => get_episode_drug_req_det(i_drug_req_det(i)),
                                        i_id_drd      => i_drug_req_det(i),
                                        i_flg_type    => 'DD',
                                        i_dt_req      => pk_date_utils.get_string_tstz(i_lang,
                                                                                       i_prof,
                                                                                       i_cosigned_date(i),
                                                                                       NULL));
                        
                        ELSE
                        
                            --registar valores antigos em historico de modificacoes
                            g_error := 'INSERT HIST PHARMACIST';
                            INSERT INTO drug_req_det_hist_modif
                                (id_drug_req_det,
                                 dt_modified,
                                 id_prof_modify,
                                 id_drug,
                                 vers,
                                 qty,
                                 id_unit_measure,
                                 id_presc_directions,
                                 id_other_product)
                                SELECT drd.id_drug_req_det,
                                       l_datetime,
                                       i_prof.id,
                                       drd.id_drug,
                                       drd.vers,
                                       drd.qty_req,
                                       drd.id_unit_measure,
                                       i_id_presc_directions(i),
                                       drd.id_other_product
                                  FROM drug_req_det drd
                                 WHERE drd.id_drug_req_det = i_drug_req_det(i);
                        
                            g_error := 'UPDATE REQ';
                            UPDATE drug_req_det drd
                               SET drd.id_state                    = l_drd_next_state_id,
                                   drd.dt_last_change              = l_datetime,
                                   drd.id_drug                     = i_id_drug(i),
                                   drd.vers                        = i_drug_vers(i),
                                   drd.qty_req                     = i_qty_req(i),
                                   drd.id_unit_measure             = i_qty_unit(i),
                                   drd.qty_to_prep                 = i_qty_prep(i),
                                   drd.id_unit_measure_prep        = i_qty_prep_unit(i),
                                   drd.flg_co_sign                 = decode(i_wait_for_approv(i), g_yes, g_no, g_yes),
                                   drd.id_prof_co_sign             = i_cosigned_by(i),
                                   drd.id_type_co_sign             = i_cosigned_type(i),
                                   drd.dt_co_sign                  = pk_date_utils.get_string_tstz(i_lang,
                                                                                                   i_prof,
                                                                                                   i_cosigned_date(i),
                                                                                                   NULL),
                                   drd.notes_co_sign               = i_cosigned_notes(i),
                                   drd.id_prof_last_change         = i_prof.id,
                                   drd.id_sw_last_change           = i_prof.software,
                                   drd.id_inst_last_change         = i_prof.institution,
                                   drd.req_to_be_delivered_at_home = nvl(i_deliver_at_home(i), g_no),
                                   drd.dt_next_dispense            = l_dt_next_dispense
                             WHERE drd.id_drug_req_det = i_drug_req_det(i);
                        
                            -- ALERT-65653 invokes pk_co_sign api to display co-sign alerts (sys_alert 45) Pedro Martins Santos
                            g_error := 'set_co_sign_task - l_state_transition_not_ok';
                            set_co_sign(i_lang        => i_lang,
                                        i_prof        => i_prof,
                                        i_cosigned_by => i_cosigned_by(i),
                                        i_id_episode  => get_episode_drug_req_det(i_drug_req_det(i)),
                                        i_id_drd      => i_drug_req_det(i),
                                        i_flg_type    => 'DD',
                                        i_dt_req      => pk_date_utils.get_string_tstz(i_lang,
                                                                                       i_prof,
                                                                                       i_cosigned_date(i),
                                                                                       NULL));
                        
                        END IF;
                    
                        g_error := 'INSERT DRD STATE TRANSITION';
                        INSERT INTO drug_req_det_state_transition
                            (id_drug_req_det, id_state, id_prof, dt_state, notes1, notes2)
                        VALUES
                            (i_drug_req_det(i),
                             l_drd_next_state_id,
                             i_prof.id,
                             l_datetime,
                             i_notes_physician(i),
                             i_notes_pharmacist(i));
                    
                    ELSE
                        g_error := 'INVALID STATE TRANSITION';
                        RAISE g_ex_cannot_be_checked;
                    END IF;
                
                ELSE
                    --ORDER NOT ALTERED!
                
                    --check if state transition is ok
                    l_drd_next_state_id   := get_state_for_req_type(i_prof, l_req_type, g_drd_validated_st);
                    l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                                     i_prof,
                                                                                     l_current_req_state,
                                                                                     l_drd_next_state_id);
                
                    IF (l_state_transition_ok)
                    THEN
                        g_error := 'UPDATE REQ';
                        UPDATE drug_req_det drd
                           SET drd.id_state                    = l_drd_next_state_id,
                               drd.dt_last_change              = l_datetime,
                               drd.qty_req                     = i_qty_req(i),
                               drd.id_unit_measure             = i_qty_unit(i),
                               drd.qty_to_prep                 = i_qty_prep(i),
                               drd.id_unit_measure_prep        = i_qty_prep_unit(i),
                               drd.id_prof_last_change         = i_prof.id,
                               drd.id_sw_last_change           = i_prof.software,
                               drd.id_inst_last_change         = i_prof.institution,
                               drd.req_to_be_delivered_at_home = nvl(i_deliver_at_home(i), g_no),
                               drd.dt_next_dispense            = l_dt_next_dispense
                         WHERE drd.id_drug_req_det = i_drug_req_det(i);
                    
                        g_error := 'INSERT DRD STATE TRANSITION';
                        INSERT INTO drug_req_det_state_transition
                            (id_drug_req_det, id_state, id_prof, dt_state, notes1, notes2)
                        VALUES
                            (i_drug_req_det(i),
                             l_drd_next_state_id,
                             i_prof.id,
                             l_datetime,
                             i_notes_physician(i),
                             i_notes_pharmacist(i));
                    
                    ELSE
                        g_error := 'INVALID STATE TRANSITION';
                        RAISE g_ex_cannot_be_checked;
                    END IF;
                
                END IF;
            
                --alertas
                process_alerts(i_flg_alert => l_ready_for_prep, i_drug_req_det => i_drug_req_det(i));
            END IF; --qty_prep
        END LOOP;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END set_pat_check;

    FUNCTION set_pat_check
    (
        i_lang                IN language.id_language%TYPE,
        i_prof                IN alert.profissional,
        i_drug_req_det        IN table_number,
        i_notes_physician     IN table_varchar,
        i_notes_pharmacist    IN table_varchar,
        i_med_changed         IN table_varchar, --Y|N
        i_id_drug             IN table_varchar,
        i_drug_vers           IN table_varchar,
        i_qty_req             IN table_number,
        i_qty_unit            IN table_number,
        i_qty_prep            IN table_number,
        i_qty_prep_unit       IN table_number,
        i_wait_for_approv     IN table_varchar, --Y|N
        i_cosigned_by         IN table_number,
        i_cosigned_date       IN table_varchar,
        i_cosigned_type       IN table_number,
        i_cosigned_notes      IN table_varchar,
        i_deliver_at_home     IN table_varchar,
        i_instr_changed       IN table_varchar, --Y|N
        i_drug_presc_det_new  IN table_number,
        i_med_changed_to_new  IN table_varchar, --Y|N
        i_dt_next_dispense    IN table_varchar DEFAULT NULL,
        i_id_presc_directions IN table_number,
        o_error               OUT t_error_out
    ) RETURN BOOLEAN IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'set_pat_check';
    BEGIN
    
        set_pat_check(i_lang                => i_lang,
                      i_prof                => i_prof,
                      i_drug_req_det        => i_drug_req_det,
                      i_notes_physician     => i_notes_physician,
                      i_notes_pharmacist    => i_notes_pharmacist,
                      i_med_changed         => i_med_changed,
                      i_id_drug             => i_id_drug,
                      i_drug_vers           => i_drug_vers,
                      i_qty_req             => i_qty_req,
                      i_qty_unit            => i_qty_unit,
                      i_qty_prep            => i_qty_prep,
                      i_qty_prep_unit       => i_qty_prep_unit,
                      i_wait_for_approv     => i_wait_for_approv,
                      i_cosigned_by         => i_cosigned_by,
                      i_cosigned_date       => i_cosigned_date,
                      i_cosigned_type       => i_cosigned_type,
                      i_cosigned_notes      => i_cosigned_notes,
                      i_deliver_at_home     => i_deliver_at_home,
                      i_instr_changed       => i_instr_changed,
                      i_drug_presc_det_new  => i_drug_presc_det_new,
                      i_med_changed_to_new  => i_med_changed_to_new,
                      i_dt_next_dispense    => i_dt_next_dispense,
                      i_id_presc_directions => i_id_presc_directions);
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_pat_check;

    /********************************************************************************************
    * alert.pk_pharmacy.set_pat_change_presc
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_DRUG_REQ_DET_OLD              IN    NUMBER(24)
    * @param  I_DRUG_PRESC_DET_NEW            IN    NUMBER(24)
    * @param  I_NOTES_PHYSICIAN               IN    VARCHAR2
    * @param  I_NOTES_PHARMACIST              IN    VARCHAR2
    * @param  I_QTY_TO_PREP                   IN    NUMBER(24,4)
    * @param  I_QTY_TO_PREP_UNIT              IN    NUMBER(24)
    * @param  I_WAIT_FOR_APPROV               IN    VARCHAR2
    * @param  I_COSIGNED_BY                   IN    NUMBER(24)
    * @param  I_COSIGNED_DATE                 IN    VARCHAR2
    * @param  I_COSIGNED_TYPE                 IN    NUMBER(12)
    * @param  I_ID_PRESC_DIRECTIONS           IN    ALERT.TABLE_NUMBER
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.8
    * @since  2010-03-29
    *
    * @notes
    *
    ********************************************************************************************/
    PROCEDURE set_pat_change_presc
    (
        i_lang                IN language.id_language%TYPE,
        i_prof                IN alert.profissional,
        i_drug_req_det_old    IN drug_req_det.id_drug_req_det%TYPE,
        i_drug_presc_det_new  IN drug_presc_det.id_drug_presc_det%TYPE,
        i_notes_physician     IN drug_req_det_state_transition.notes1%TYPE DEFAULT NULL,
        i_notes_pharmacist    IN drug_req_det_state_transition.notes1%TYPE DEFAULT NULL,
        i_qty_to_prep         IN drug_req_det.qty_to_prep%TYPE,
        i_qty_to_prep_unit    IN drug_req_det.id_unit_measure_prep%TYPE,
        i_wait_for_approv     IN VARCHAR2 DEFAULT 'N',
        i_cosigned_by         IN drug_req_det.id_prof_co_sign%TYPE DEFAULT NULL,
        i_cosigned_date       IN VARCHAR2 DEFAULT NULL,
        i_cosigned_type       IN drug_req_det.id_type_co_sign%TYPE DEFAULT NULL,
        i_cosigned_notes      IN drug_req_det.notes_co_sign%TYPE DEFAULT NULL,
        i_id_presc_directions IN table_number,
        o_error               OUT t_error_out
    ) IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'set_pat_change_presc';
        l_current_req_state   wfl_state.id_state%TYPE;
        l_next_req_state      wfl_state.id_state%TYPE;
        l_state_transition_ok BOOLEAN := FALSE;
        l_id_episode          episode.id_episode%TYPE;
        l_id_patient          patient.id_patient%TYPE;
        l_id_drug             drug_req_det.id_drug%TYPE;
        l_version             drug_req_det.vers%TYPE := NULL;
        l_qty_req             drug_req_det.qty_req%TYPE;
        l_unit_measure        drug_req_det.id_unit_measure%TYPE;
        l_tbl_drds            table_number;
        l_drug_presc_det_old  drug_req.id_drug_presc_det%TYPE;
        l_timestamp           TIMESTAMP WITH LOCAL TIME ZONE;
        l_ret                 BOOLEAN := FALSE;
        l_req_type            drug_req.flg_type%TYPE;
        l_rec_pharm_drd_alloc t_rec_pharm_drd_allocation;
        l_pucs_id_patient     pharm_unidose_car_slot.id_patient%TYPE;
        --
        l_prof_cat_type       category.flg_type%TYPE;
        l_flg_show            VARCHAR2(200 CHAR);
        l_msg_title           VARCHAR2(200 CHAR);
        l_msg                 VARCHAR2(200 CHAR);
        l_button              VARCHAR2(200 CHAR);
        l_dt_drd_new_order    drug_req.dt_drug_req_tstz%TYPE;
        l_dt_drd_cancel_order drug_req_det_state_transition.dt_state%TYPE;
        l_dt_drd_old_order    drug_req.dt_drug_req_tstz%TYPE;
        l_id_drug_req         drug_req.id_drug_req%TYPE;
    BEGIN
        l_timestamp := current_timestamp;
    
        set_pharmacy_log(l_db_object_name, '**** BEGIN ****');
    
        -- 1) cancel old drug_req_det
        SELECT drd.id_state,
               dr.id_episode,
               dr.id_patient,
               drd.qty_req,
               drd.id_unit_measure,
               dr.id_drug_presc_det,
               dr.flg_type,
               dr.id_drug_req
          INTO l_current_req_state,
               l_id_episode,
               l_id_patient,
               l_qty_req,
               l_unit_measure,
               l_drug_presc_det_old,
               l_req_type,
               l_id_drug_req
          FROM drug_req_det drd, drug_req dr
         WHERE drd.id_drug_req_det = i_drug_req_det_old
           AND drd.id_drug_req = dr.id_drug_req;
    
        set_pharmacy_log(l_db_object_name,
                         'l_drug_presc_det_old ->  ' || l_drug_presc_det_old || '    i_drug_presc_det_new -> ' ||
                         i_drug_presc_det_new);
    
        l_next_req_state      := get_state_for_req_type(i_prof, l_req_type, g_drd_canceled_st);
        l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                         i_prof,
                                                                         l_current_req_state,
                                                                         l_next_req_state);
    
        set_pharmacy_log(l_db_object_name,
                         'l_current_req_state=' || l_current_req_state || ' l_next_req_state=' || l_next_req_state ||
                         ' l_state_transition_ok=' || sys.diutil.bool_to_int(l_state_transition_ok));
    
        IF (l_state_transition_ok)
        THEN
            UPDATE drug_req_det drd
               SET drd.id_state            = l_next_req_state,
                   drd.dt_last_change      = l_timestamp,
                   drd.id_prof_last_change = i_prof.id,
                   drd.id_sw_last_change   = i_prof.software,
                   drd.id_inst_last_change = i_prof.institution
             WHERE drd.id_drug_req_det = i_drug_req_det_old;
        
            set_pharmacy_log(l_db_object_name,
                             'l_state_transition_ok - update drug_req_det done with: l_next_req_state:' ||
                             l_next_req_state || '; l_next_req_state: ' || l_next_req_state || '; i_drug_req_det_old:' ||
                             i_drug_req_det_old);
            --state history
            INSERT INTO drug_req_det_state_transition
                (id_drug_req_det, id_state, id_prof, dt_state)
            VALUES
                (i_drug_req_det_old, l_next_req_state, i_prof.id, l_timestamp);
        
            set_pharmacy_log(l_db_object_name,
                             'insert into drug_req_det_state_transition with: i_drug_req_det_old:' ||
                             i_drug_req_det_old || '; l_next_req_state: ' || l_next_req_state || '; l_timestamp:' ||
                             l_timestamp);
        ELSE
            RAISE g_ex_cannot_be_canceled_drs;
        END IF;
    
        set_pharmacy_log(l_db_object_name,
                         'select from drug_presc_det with i_drug_presc_det_new:' || i_drug_presc_det_new ||
                         '; l_next_req_state: ' || l_next_req_state || '; l_timestamp:' || l_timestamp);
    
        -- 2) create the new order from the new drug_presc_det
        g_error := 'checking new drug_presc_det - no i_drug_presc_det_new';
        BEGIN
            SELECT nvl(dpd.id_drug, dpd.id_other_product), dpd.vers
              INTO l_id_drug, l_version
              FROM drug_presc_det dpd
             WHERE dpd.id_drug_presc_det = i_drug_presc_det_new;
        EXCEPTION
            WHEN no_data_found THEN
                RAISE;
            WHEN OTHERS THEN
                RAISE;
        END;
    
        IF (l_version IS NULL)
        THEN
            l_version := pk_sysconfig.get_config('PRESCRIPTION_TYPE', i_prof);
        END IF;
    
        -- CANCEL OLD PRESCRIPTION
        IF (l_drug_presc_det_old != i_drug_presc_det_new)
        THEN
            set_pharmacy_log(l_db_object_name,
                             'PRESC CANCEL - old prescription - > ' || l_drug_presc_det_old || '  new prescription -> ' ||
                             i_drug_presc_det_new);
            l_ret := pk_prescription_int.set_cancel_presc(i_lang             => i_lang,
                                                          i_prof             => i_prof,
                                                          i_drug_presc_det   => table_number(l_drug_presc_det_old),
                                                          i_subject          => table_varchar(pk_medication_core.g_local),
                                                          i_notes            => NULL,
                                                          i_cancel_reason    => ' ', --? TBD
                                                          i_id_cancel_reason => pk_cancel_reason.c_reason_entered_in_error, --? TBD
                                                          o_error            => o_error);
        
            IF (l_ret = FALSE)
            THEN
                set_pharmacy_log(l_db_object_name, 'pk_prescription_int.set_cancel_presc: ERROR=' || o_error.err_desc);
                raise_application_error(-20001, 'pk_prescription_int.set_cancel_presc: ERROR=' || o_error.err_desc);
            END IF;
            --  PMS 06-JAN-2010
            --  Edition must also have the same behavior as other situations
        ELSIF (l_drug_presc_det_old = i_drug_presc_det_new)
        THEN
            set_pharmacy_log(l_db_object_name, 'PHARMACY ORDER CANCEL - cancel old pharmacy orders ');
            set_pharmacy_log(l_db_object_name,
                             'old prescription - > ' || l_drug_presc_det_old || '  new prescription -> ' ||
                             i_drug_presc_det_new);
            cancel_req_db(i_lang           => i_lang,
                          i_prof           => i_prof,
                          i_drug_presc_det => l_drug_presc_det_old,
                          i_notes_cancel   => NULL,
                          o_error          => o_error,
                          i_drug_req       => l_id_drug_req);
        
        ELSE
            NULL;
        END IF;
    
        IF (l_req_type = g_flg_adm)
        THEN
            set_pharmacy_log(l_db_object_name,
                             'create_req_pharm_adm: i_drug_presc_det_new=' || i_drug_presc_det_new || ' l_id_drug=' ||
                             l_id_drug || ' l_version=' || l_version);
            create_req_pharm_adm(i_lang            => i_lang,
                                 i_episode         => l_id_episode,
                                 i_patient         => l_id_patient,
                                 i_prof            => i_prof,
                                 i_drug_presc_det  => table_number(i_drug_presc_det_new),
                                 i_drug            => table_varchar(l_id_drug),
                                 i_version         => l_version,
                                 i_qty_req         => table_number(l_qty_req),
                                 i_unit_measure    => table_number(l_unit_measure),
                                 i_notes           => table_varchar(NULL),
                                 i_datetime        => l_timestamp,
                                 o_id_drug_req_det => l_tbl_drds,
                                 o_error           => o_error);
        
        ELSIF (l_req_type = g_flg_int)
        THEN
            set_pharmacy_log(l_db_object_name,
                             'create_req_pharm_int: i_drug_presc_det_new=' || i_drug_presc_det_new || ' l_id_drug=' ||
                             l_id_drug || ' l_version=' || l_version);
            create_req_pharm_int(i_lang            => i_lang,
                                 i_episode         => l_id_episode,
                                 i_patient         => l_id_patient,
                                 i_prof            => i_prof,
                                 i_drug_presc_det  => table_number(i_drug_presc_det_new),
                                 i_drug            => table_varchar(l_id_drug),
                                 i_version         => l_version,
                                 i_qty_req         => table_number(l_qty_req),
                                 i_unit_measure    => table_number(l_unit_measure),
                                 i_notes           => table_varchar(NULL),
                                 i_datetime        => l_timestamp,
                                 o_id_drug_req_det => l_tbl_drds,
                                 o_error           => o_error);
        
        ELSIF (l_req_type = g_flg_unidose)
        THEN
            set_pharmacy_log(l_db_object_name,
                             'create_req_pharm UNITDOSE: i_drug_presc_det_new=' || i_drug_presc_det_new ||
                             ' l_id_drug=' || l_id_drug || ' l_version=' || l_version);
            --PMS 05-jan-2010
            --used create_req_pharm instead of create_req_pharm_uni 
            --so that filtering cars by a certain date is possible
            l_prof_cat_type := get_prof_type(i_prof);
            IF NOT create_req_pharm(i_lang           => i_lang,
                                    i_episode        => l_id_episode,
                                    i_patient        => l_id_patient,
                                    i_prof           => i_prof,
                                    i_prof_cat_type  => l_prof_cat_type,
                                    i_flg_type       => table_varchar(g_flg_unidose),
                                    i_drug_presc_det => table_number(i_drug_presc_det_new),
                                    i_drug           => table_varchar(l_id_drug),
                                    i_qty_req        => table_number(l_qty_req),
                                    i_unit_measure   => table_number(l_unit_measure),
                                    i_notes          => table_varchar(NULL),
                                    i_commit         => g_no,
                                    o_id_drd         => l_tbl_drds,
                                    o_flg_show       => l_flg_show,
                                    o_msg_title      => l_msg_title,
                                    o_msg            => l_msg,
                                    o_button         => l_button,
                                    o_error          => o_error)
            THEN
                raise_application_error(-20001, o_error.ora_sqlerrm);
            END IF;
            -- PMS 05-jan-2010
            -- l_tbl_drds will possibly return as many results           
            -- as the number of cars already in preparation whose transport did not start yet
        
        ELSE
            set_pharmacy_log(l_db_object_name, 'set_pat_check: INVALID REQ TYPE! l_req_type=' || l_req_type);
            raise_application_error(-20001, 'INVALID REQ TYPE: ' || l_req_type);
        END IF;
    
        IF (l_tbl_drds.count > 0)
        THEN
            -- PMS 05-jan-2010
            -- because as mentioned above we can have more than a drd
            -- set_pat_check now must be performed inside a loop
            FOR i IN l_tbl_drds.first .. l_tbl_drds.count
            LOOP
            
                l_timestamp := pk_date_utils.add_to_ltstz(l_timestamp, 10, 'SECOND');
            
                -- 4) relate the old drug_req_det with the new drug_req_det
            
                -- 4.1) PMS 05-jan-2010
                --              detecting the order date of the new drug_req_det
                BEGIN
                    SELECT trunc(dr.dt_drug_req_tstz)
                      INTO l_dt_drd_new_order
                      FROM drug_req dr
                     INNER JOIN drug_req_det drd
                        ON (dr.id_drug_req = drd.id_drug_req)
                     WHERE drd.id_drug_req_det = l_tbl_drds(i);
                EXCEPTION
                    WHEN OTHERS THEN
                        l_dt_drd_new_order := NULL;
                END;
            
                -- 4.2) PMS 05-jan-2010    
                --              requires detecting all drug_req_dets that might had been associated with 
                --              the prescritption of this drug_req_det_old, order date and its id is picked up                
                --              which were cancelled a few minutes!!! ago
            
                SELECT current_timestamp - INTERVAL '10' minute
                  INTO l_dt_drd_cancel_order
                  FROM dual;
            
                -- PMS 05-jan-2010
                -- obtaining dt_order of i_drug_req_det_old
                BEGIN
                    SELECT trunc(dr.dt_drug_req_tstz)
                      INTO l_dt_drd_old_order
                      FROM drug_req dr
                     INNER JOIN drug_req_det drd
                        ON (dr.id_drug_req = drd.id_drug_req)
                     WHERE drd.id_drug_req_det = i_drug_req_det_old;
                EXCEPTION
                    WHEN OTHERS THEN
                        l_dt_drd_old_order := NULL;
                END;
                --               
                FOR l_drd_old IN (SELECT drd.id_drug_req_det id_drug_req_det, trunc(dr.dt_drug_req_tstz) dt_order
                                    FROM drug_req dr
                                   INNER JOIN drug_req_det drd
                                      ON (dr.id_drug_req = drd.id_drug_req)
                                   INNER JOIN drug_req_det_state_transition drdst
                                      ON (drd.id_drug_req_det = drdst.id_drug_req_det)
                                   WHERE dr.id_drug_presc_det IN
                                         (SELECT dr1.id_drug_presc_det
                                            FROM drug_req dr1
                                           INNER JOIN drug_req_det drd1
                                              ON (dr1.id_drug_req = drd1.id_drug_req)
                                           WHERE drd1.id_drug_req_det = i_drug_req_det_old)
                                     AND drd.id_state =
                                         pk_pharmacy.get_state_for_req_type(i_prof, dr.flg_type, g_drd_canceled_st)
                                     AND drdst.id_state =
                                         pk_pharmacy.get_state_for_req_type(i_prof, dr.flg_type, g_drd_canceled_st)
                                     AND drdst.dt_state >= l_dt_drd_cancel_order)
                LOOP
                
                    -- PMS 05-jan-2010 - 
                    -- necessary so that on pharmacy order details we can know which drug is the new 
                    -- and which drug is the old one 
                    IF l_dt_drd_new_order = l_drd_old.dt_order
                    THEN
                        INSERT INTO pharm_drd_switch
                            (id_drug_req_det_old, id_drug_req_det_new, id_prof, dt_drd_switch)
                        VALUES
                            (l_drd_old.id_drug_req_det, l_tbl_drds(i), i_prof.id, l_timestamp);
                        -- PMS 05-jan-2010
                        -- necessary in order to assure that only the order relative to the selected car will be edited validated
                        IF l_dt_drd_old_order = l_drd_old.dt_order
                        THEN
                            -- this validation shall only be made once
                            set_pharmacy_log(l_db_object_name, 'set_pat_check: id_drug_req_det_new=' || l_tbl_drds(i));
                            set_pat_check(i_lang                => i_lang,
                                          i_prof                => i_prof,
                                          i_drug_req_det        => table_number(l_tbl_drds(i)),
                                          i_notes_physician     => table_varchar(i_notes_physician),
                                          i_notes_pharmacist    => table_varchar(i_notes_pharmacist),
                                          i_med_changed         => table_varchar(g_no),
                                          i_id_drug             => table_varchar(NULL),
                                          i_drug_vers           => table_varchar(NULL),
                                          i_qty_req             => table_number(NULL),
                                          i_qty_unit            => table_number(NULL),
                                          i_qty_prep            => table_number(i_qty_to_prep),
                                          i_qty_prep_unit       => table_number(i_qty_to_prep_unit),
                                          i_wait_for_approv     => table_varchar(i_wait_for_approv),
                                          i_cosigned_by         => table_number(i_cosigned_by),
                                          i_cosigned_date       => table_varchar(i_cosigned_date),
                                          i_cosigned_type       => table_number(i_cosigned_type),
                                          i_cosigned_notes      => table_varchar(i_cosigned_notes),
                                          i_deliver_at_home     => table_varchar(NULL),
                                          i_instr_changed       => table_varchar(g_no),
                                          i_drug_presc_det_new  => table_number(NULL),
                                          i_med_changed_to_new  => table_varchar(g_yes),
                                          i_id_presc_directions => i_id_presc_directions);
                        END IF;
                    END IF;
                
                END LOOP;
            END LOOP;
        
        END IF;
    
        set_pharmacy_log(l_db_object_name, '**** END ****');
    
        --commit;
    
        --return true;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, o_error);
            --pk_utils.undo_changes;
            --return false;
            RAISE;
    END set_pat_change_presc;

    FUNCTION set_pat_change_presc
    (
        i_lang                IN language.id_language%TYPE,
        i_prof                IN alert.profissional,
        i_drug_req_det_old    IN drug_req_det.id_drug_req_det%TYPE,
        i_drug_presc_det_new  IN drug_presc_det.id_drug_presc_det%TYPE,
        i_notes_physician     IN drug_req_det_state_transition.notes1%TYPE DEFAULT NULL,
        i_notes_pharmacist    IN drug_req_det_state_transition.notes1%TYPE DEFAULT NULL,
        i_qty_to_prep         IN drug_req_det.qty_to_prep%TYPE,
        i_qty_to_prep_unit    IN drug_req_det.id_unit_measure_prep%TYPE,
        i_wait_for_approv     IN VARCHAR2 DEFAULT 'N',
        i_cosigned_by         IN drug_req_det.id_prof_co_sign%TYPE DEFAULT NULL,
        i_cosigned_date       IN VARCHAR2 DEFAULT NULL,
        i_cosigned_type       IN drug_req_det.id_type_co_sign%TYPE DEFAULT NULL,
        i_cosigned_notes      IN drug_req_det.notes_co_sign%TYPE DEFAULT NULL,
        i_id_presc_directions IN table_number,
        o_error               OUT t_error_out
    ) RETURN BOOLEAN IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'set_pat_change_presc';
    BEGIN
    
        set_pat_change_presc(i_lang                => i_lang,
                             i_prof                => i_prof,
                             i_drug_req_det_old    => i_drug_req_det_old,
                             i_drug_presc_det_new  => i_drug_presc_det_new,
                             i_notes_physician     => i_notes_physician,
                             i_notes_pharmacist    => i_notes_pharmacist,
                             i_qty_to_prep         => i_qty_to_prep,
                             i_qty_to_prep_unit    => i_qty_to_prep_unit,
                             i_wait_for_approv     => i_wait_for_approv,
                             i_cosigned_by         => i_cosigned_by,
                             i_cosigned_date       => i_cosigned_date,
                             i_cosigned_type       => i_cosigned_type,
                             i_cosigned_notes      => i_cosigned_notes,
                             i_id_presc_directions => i_id_presc_directions,
                             o_error               => o_error);
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_pat_change_presc;

    /********************************************************************************************
    * alert.pk_pharmacy.set_pat_edit_presc
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DRUG_PRESC_DET             IN    NUMBER(24)
    *
    * @author Rui Marante
    * @version  2.5.0.7.3
    * @since  2009-12-03
    *
    ********************************************************************************************/
    PROCEDURE set_pat_edit_presc
    (
        i_lang              IN language.id_language%TYPE,
        i_prof              IN alert.profissional,
        i_id_drug_presc_det IN drug_presc_det.id_drug_presc_det%TYPE
    ) IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'SET_PAT_EDIT_PRESC';
        l_id_drug             drug_req_det.id_drug%TYPE;
        l_version             drug_req_det.vers%TYPE := NULL;
        l_timestamp           table_timestamp_tz := table_timestamp_tz();
        l_ret                 BOOLEAN := FALSE;
        l_prof_cat            category.flg_type%TYPE;
        l_prof_cat_desc       pk_translation.t_desc_translation;
        l_error               t_error_out;
        l_tbl_drds            table_number := table_number();
        l_tbl_req_types       table_varchar := table_varchar();
        l_tbl_drds_new        table_number := table_number();
        l_tbl_episodes        table_number := table_number();
        l_tbl_patients        table_number := table_number();
        l_drd_canceled        BOOLEAN := FALSE;
        l_cur_timestamp       TIMESTAMP WITH LOCAL TIME ZONE;
        l_id_dep_clin_service dep_clin_serv.id_dep_clin_serv%TYPE := NULL;
        l_tbl_dt_begin        table_timestamp_tz := table_timestamp_tz();
        l_tbl_dt_end          table_timestamp_tz := table_timestamp_tz();
        l_id_epidose          episode.id_episode%TYPE;
        l_id_patient          patient.id_patient%TYPE;
        l_tbl_id_cars         table_number := table_number();
        l_old_drd             drug_req_det.id_drug_req_det%TYPE;
        l_dt_aux              TIMESTAMP WITH LOCAL TIME ZONE;
    BEGIN
        set_pharmacy_log(l_db_object_name, '**** BEGIN ****');
    
        l_cur_timestamp := current_timestamp;
    
        set_pharmacy_log(l_db_object_name, 'get_category_prof');
        l_ret := get_category_prof(i_lang     => i_lang,
                                   i_prof     => i_prof,
                                   i_id_prof  => i_prof.id,
                                   o_cat      => l_prof_cat_desc,
                                   o_flg_type => l_prof_cat,
                                   o_error    => l_error);
    
        set_pharmacy_log(l_db_object_name, 'get: l_id_drug, l_version');
        SELECT dpd.id_drug, dpd.vers
          INTO l_id_drug, l_version
          FROM drug_presc_det dpd
         WHERE dpd.id_drug_presc_det = i_id_drug_presc_det;
    
        IF (l_version IS NULL)
        THEN
            l_version := pk_sysconfig.get_config('PRESCRIPTION_TYPE', i_prof);
        END IF;
    
        set_pharmacy_log(l_db_object_name, 'get: bulk collect into l_tbl_drds, l_tbl_req_types');
        SELECT drd.id_drug_req_det, dr.flg_type, dr.id_episode, dr.id_patient, dr.dt_drug_req_tstz
          BULK COLLECT
          INTO l_tbl_drds, l_tbl_req_types, l_tbl_episodes, l_tbl_patients, l_timestamp
          FROM drug_req_det drd, drug_req dr
         WHERE drd.id_drug_req = dr.id_drug_req
           AND dr.id_drug_presc_det = i_id_drug_presc_det
           AND drd.id_state != get_state_for_req_type(i_prof, dr.flg_type, g_drd_canceled_st);
        --[ALERT-163260] filtering drug_req_dets which are not in canceled state
    
        FOR i IN 1 .. l_tbl_drds.count
        LOOP
            l_drd_canceled := FALSE;
        
            -- 1) cancel drug_req_det
            set_pharmacy_log(l_db_object_name, 'cancel_req_db: l_tbl_drds(i)=' || l_tbl_drds(i));
            BEGIN
                cancel_req_db(i_lang          => i_lang,
                              i_prof          => i_prof,
                              i_prof_cat_type => l_prof_cat,
                              i_drug_req_det  => l_tbl_drds(i),
                              i_notes_cancel  => NULL,
                              o_error         => l_error);
            
                l_drd_canceled := TRUE;
            EXCEPTION
                WHEN OTHERS THEN
                    set_pharmacy_log(l_db_object_name, 'cancel_req_db: NOT CANCELED!');
                    l_drd_canceled := FALSE;
            END;
        
            -- 2) if drd canceled OK
            -- if l_drd_canceled then
        
            --ALERT-161416 commented the above line because workflow did not allow cancelation of terminated state
            --ALERT-163260 workflow now allows cancelation of terminated states, however if in transport (drug_req_supply workflow) 
            --no cancelation shall occur, transportation shall continue and a new pharmacy order will be created
        
            set_pharmacy_log(l_db_object_name,
                             'create_req_pharm_xxx: i_drug_presc_det_new=' || i_id_drug_presc_det || ' l_tbl_drds=' ||
                             l_tbl_drds(i) || ' l_tbl_req_types=' || l_tbl_req_types(i) || ' l_id_drug=' || l_id_drug ||
                             ' l_version=' || l_version);
            IF (l_tbl_req_types(i) = g_flg_adm)
            THEN
                create_req_pharm_adm(i_lang            => i_lang,
                                     i_episode         => l_tbl_episodes(i),
                                     i_patient         => l_tbl_patients(i),
                                     i_prof            => i_prof,
                                     i_drug_presc_det  => table_number(i_id_drug_presc_det),
                                     i_drug            => table_varchar(l_id_drug),
                                     i_version         => l_version,
                                     i_qty_req         => table_number(NULL),
                                     i_unit_measure    => table_number(NULL),
                                     i_notes           => table_varchar(NULL),
                                     i_datetime        => l_timestamp(i),
                                     o_id_drug_req_det => l_tbl_drds_new,
                                     o_error           => l_error);
            
            ELSIF (l_tbl_req_types(i) = g_flg_int)
            THEN
                create_req_pharm_int(i_lang            => i_lang,
                                     i_episode         => l_tbl_episodes(i),
                                     i_patient         => l_tbl_patients(i),
                                     i_prof            => i_prof,
                                     i_drug_presc_det  => table_number(i_id_drug_presc_det),
                                     i_drug            => table_varchar(l_id_drug),
                                     i_version         => l_version,
                                     i_qty_req         => table_number(NULL),
                                     i_unit_measure    => table_number(NULL),
                                     i_notes           => table_varchar(NULL),
                                     i_datetime        => l_timestamp(i),
                                     o_id_drug_req_det => l_tbl_drds_new,
                                     o_error           => l_error);
            END IF;
        
            IF (nvl(cardinality(l_tbl_drds_new), 0) != 0)
            THEN
                -- relate the old drug_req_det with the new drug_req_det
                INSERT INTO pharm_drd_switch
                    (id_drug_req_det_old, id_drug_req_det_new, id_prof, dt_drd_switch)
                VALUES
                    (l_tbl_drds(i), l_tbl_drds_new(1), i_prof.id, l_cur_timestamp);
            END IF;
        
            l_tbl_drds_new.delete;
        
        --end if;
        
        END LOOP;
    
        --ALERT-168918
        BEGIN
            g_error := 'GET ID_DEP_CLIN_SERVICE';
            SELECT ei.id_dep_clin_serv
              INTO l_id_dep_clin_service
              FROM drug_presc_det dpd
             INNER JOIN drug_prescription dp
                ON (dpd.id_drug_prescription = dp.id_drug_prescription)
             INNER JOIN epis_info ei
                ON (dp.id_episode = ei.id_episode)
             INNER JOIN dep_clin_serv dcs
                ON (ei.id_dep_clin_serv = dcs.id_dep_clin_serv)
             INNER JOIN department d
                ON (dcs.id_department = d.id_department)
             WHERE dpd.id_drug_presc_det = i_id_drug_presc_det
               AND dcs.flg_available = g_yes
               AND d.id_institution = i_prof.institution
               AND d.flg_available = g_yes
               AND d.flg_unidose = g_yes
               AND rownum = 1;
        EXCEPTION
            WHEN no_data_found THEN
                l_id_dep_clin_service := NULL;
        END;
    
        IF (l_id_dep_clin_service IS NOT NULL)
        THEN
        
            g_error := 'GET CARS BULK';
            SELECT uc.id_unidose_car, uc.dt_car_begin, uc.dt_car_end
              BULK COLLECT
              INTO l_tbl_id_cars, l_tbl_dt_begin, l_tbl_dt_end
              FROM pharm_unidose_car uc
             INNER JOIN pharm_unidose_car_model ucm
                ON (uc.id_car_model = ucm.id_unidose_car_model)
             WHERE ucm.id_dep_clin_serv = l_id_dep_clin_service
               AND ucm.flg_active = g_yes
               AND uc.dt_car_end >= l_cur_timestamp
               AND uc.id_state IN
                   (SELECT v1.column_value
                      FROM TABLE(get_states_for_req_type(i_prof,
                                                         NULL,
                                                         table_varchar(g_uni_car_parked_st, g_uni_car_executing_st))) v1)
             ORDER BY uc.dt_car_begin;
        
        END IF;
    
        IF (nvl(cardinality(l_tbl_id_cars), 0) != 0)
        THEN
        
            g_error := 'L_TBL_DRDS_NEW.DELETE()';
            l_tbl_drds_new.delete();
        
            g_error := 'GET EPISODE, PATIENT, DRUG, DRUG VERSION';
            SELECT dp.id_episode, dp.id_patient, dpd.id_drug, dpd.vers
              INTO l_id_epidose, l_id_patient, l_id_drug, l_version
              FROM drug_presc_det dpd
             INNER JOIN drug_prescription dp
                ON (dpd.id_drug_prescription = dp.id_drug_prescription)
             WHERE dpd.id_drug_presc_det = i_id_drug_presc_det;
        
            IF (l_version IS NULL)
            THEN
                g_error   := 'GET VERSION';
                l_version := pk_sysconfig.get_config('PRESCRIPTION_TYPE', i_prof);
            END IF;
        
            g_error := 'FOR J IN 1 .. L_TBL_ID_CARS.COUNT';
            FOR j IN 1 .. l_tbl_id_cars.count
            LOOP
                IF (to_char(l_tbl_dt_begin(j), 'YYYYMMDD') = to_char(l_cur_timestamp, 'YYYYMMDD'))
                THEN
                    l_dt_aux := to_timestamp(to_char(l_tbl_dt_begin(j), 'YYYYMMDD') ||
                                             to_char(l_cur_timestamp, 'HH24MISS'),
                                             'YYYYMMDDHH24MISS');
                ELSE
                    l_dt_aux := l_tbl_dt_begin(j);
                END IF;
            
                create_req_pharm_uni(i_lang                  => i_lang,
                                     i_episode               => l_id_epidose,
                                     i_patient               => l_id_patient,
                                     i_prof                  => i_prof,
                                     i_drug_presc_det        => table_number(i_id_drug_presc_det),
                                     i_drug                  => table_varchar(l_id_drug),
                                     i_version               => l_version,
                                     i_qty_req               => table_number(NULL),
                                     i_unit_measure          => table_number(NULL),
                                     i_notes                 => table_varchar(NULL),
                                     i_datetime              => l_dt_aux,
                                     i_do_auto_dispense_calc => g_yes,
                                     i_id_unidose_car        => l_tbl_id_cars(j),
                                     i_dt_car_begin          => l_tbl_dt_begin(j),
                                     i_dt_car_end            => l_tbl_dt_end(j),
                                     o_id_drug_req_det       => l_tbl_drds_new,
                                     o_error                 => l_error);
            
                IF (nvl(cardinality(l_tbl_drds_new), 0) != 0)
                THEN
                    -- relate the old drug_req_det with the new drug_req_det
                    g_error := 'GET OLD DRD';
                    BEGIN
                        SELECT drd.id_drug_req_det
                          INTO l_old_drd
                          FROM drug_req_det drd
                         INNER JOIN drug_req dr
                            ON (drd.id_drug_req = dr.id_drug_req)
                         INNER JOIN drug_req_det_state_transition drdst_cancel
                            ON (drd.id_drug_req_det = drdst_cancel.id_drug_req_det AND
                               drdst_cancel.id_state = get_state_for_req_type(i_prof, dr.flg_type, g_drd_canceled_st))
                         INNER JOIN drug_req_det_state_transition drdst_create
                            ON (drd.id_drug_req_det = drdst_create.id_drug_req_det AND
                               drdst_create.id_state = get_state_for_req_type(i_prof, dr.flg_type, g_drd_requested_st))
                         WHERE dr.flg_type = g_flg_unidose
                           AND dr.id_drug_presc_det = i_id_drug_presc_det
                           AND dr.id_patient = l_id_patient
                           AND dr.id_episode = l_id_epidose
                           AND drdst_cancel.dt_state >= l_cur_timestamp
                           AND drdst_create.dt_state BETWEEN l_tbl_dt_begin(j) AND l_tbl_dt_end(j)
                           AND drd.id_drug_req_det IN (SELECT v1.column_value
                                                         FROM TABLE(l_tbl_drds) v1)
                           AND rownum = 1;
                    EXCEPTION
                        WHEN no_data_found THEN
                            l_old_drd := NULL;
                    END;
                
                    IF (l_old_drd IS NOT NULL)
                    THEN
                        INSERT INTO pharm_drd_switch
                            (id_drug_req_det_old, id_drug_req_det_new, id_prof, dt_drd_switch)
                        VALUES
                            (l_old_drd, l_tbl_drds_new(1), i_prof.id, l_cur_timestamp);
                    END IF;
                END IF;
            
                l_tbl_drds_new.delete();
                l_old_drd := NULL;
            
            END LOOP;
        
        END IF;
        --
    
        set_pharmacy_log(l_db_object_name, '**** END ****');
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, l_error);
            RAISE;
    END set_pat_edit_presc;

    /********************************************************************************************
    * alert.pk_pharmacy.remove_drd_from_unidose_car
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_DRUG_REQ_DET                IN    NUMBER(24)
    *
    * @author Rui Marante
    * @version  2.5.0.7.8
    * @since  2010-05-18
    *
    ********************************************************************************************/
    PROCEDURE remove_drd_from_unidose_car
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN alert.profissional,
        i_drug_req_det IN drug_req_det.id_drug_req_det%TYPE
    ) IS
        l_id_unidose_car table_number := table_number();
        l_slot_number    table_number := table_number();
        l_count          NUMBER(1) := 0;
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'remove_drd_from_unidose_car';
    BEGIN
        g_error := '1) remove from pharm_unidose_car_content';
        DELETE FROM pharm_unidose_car_content ucc
         WHERE ucc.id_drug_req_det = i_drug_req_det;
    
        g_error := '2)remove from pharm_unidose_slot_content';
        DELETE FROM pharm_unidose_slot_content usc
         WHERE usc.id_drug_req_det = i_drug_req_det
        RETURNING usc.id_unidose_car, usc.slot_number BULK COLLECT INTO l_id_unidose_car, l_slot_number;
    
        g_error := 'check if there are other drds in the same slot';
        IF (l_id_unidose_car.count > 0)
        THEN
        
            FOR i IN 1 .. l_id_unidose_car.count
            LOOP
                SELECT COUNT(1)
                  INTO l_count
                  FROM pharm_unidose_slot_content usc
                 WHERE usc.id_unidose_car = l_id_unidose_car(i)
                   AND usc.slot_number = l_slot_number(i)
                   AND rownum = 1;
            
                g_error := 'if not, release thar slot';
                IF (l_count = 0)
                THEN
                    UPDATE pharm_unidose_car_slot ucs
                       SET ucs.id_patient = NULL
                     WHERE ucs.id_unidose_car = l_id_unidose_car(i)
                       AND ucs.slot_number = l_slot_number(i);
                END IF;
            END LOOP;
        
        END IF;
    
    EXCEPTION
        WHEN OTHERS THEN
            set_pharmacy_log(l_db_object_name, 'g_error=' || g_error || 'sqlerrm=' || SQLERRM);
            RAISE;
    END remove_drd_from_unidose_car;

    PROCEDURE set_pat_prepare
    (
        i_lang              IN language.id_language%TYPE,
        i_prof              IN alert.profissional,
        i_drug_req_det      IN table_number,
        i_qty_req           IN table_number,
        i_qty_unit          IN table_number,
        i_qty_to_prep       IN table_number,
        i_qty_to_prep_unit  IN table_number,
        i_qty_prepared      IN table_number,
        i_package_number    IN table_varchar,
        i_package_expire_dt IN table_varchar,
        i_notes_prepare     IN table_varchar,
        i_unidose_car       IN table_number DEFAULT NULL,
        i_unidose_car_slot  IN table_number DEFAULT NULL
    ) IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'set_pat_prepare';
        l_row_count           NUMBER := 0;
        l_state_transition_ok BOOLEAN := FALSE;
        l_is_first_supply     BOOLEAN := FALSE;
        l_sup_ended           BOOLEAN := FALSE;
        l_current_req_state   drug_req_det.id_state%TYPE;
        l_drd_next_state_id   drug_req_det.id_state%TYPE;
        l_drs_next_state_id   drug_req_supply.id_state%TYPE;
        l_qty_to_prepare      drug_req_det.qty_to_prep%TYPE := 0;
        l_qty_sup             drug_req_supply.qty_supply%TYPE := 0;
        l_datetime            drug_req_det.dt_last_change%TYPE;
        l_drs_next_id         drug_req_supply.id_drug_req_supply%TYPE;
        l_req_type            drug_req.flg_type%TYPE;
        l_req_validated       BOOLEAN := TRUE;
        l_check_car_slot      NUMBER(1) := 0;
        l_id_patient          drug_req.id_patient%TYPE;
        l_error               t_error_out;
    
        --alertas
        l_flg_alert BOOLEAN := TRUE;
        --
        PROCEDURE process_alerts
        (
            i_flg_alert    IN BOOLEAN,
            i_drug_req_det IN drug_req_det.id_drug_req_det%TYPE
        ) IS
            l_code_interv     mi_med.med_descr%TYPE;
            l_id_episode      episode.id_episode%TYPE;
            l_sys_alert_event sys_alert_event%ROWTYPE;
        BEGIN
            IF (i_flg_alert = TRUE)
            THEN
            
                g_error := 'SET SYS_ALERT_EVENT PREPARE PHARM PHARMACY';
                SELECT mi.med_descr
                  INTO l_code_interv
                  FROM drug_req_det drd, mi_med mi
                 WHERE drd.id_drug = mi.id_drug
                   AND drd.vers = mi.vers
                   AND drd.id_drug_req_det = i_drug_req_det;
            
                set_pharmacy_log(l_db_object_name, 'process_alerts: l_code_interv=' || l_code_interv);
            
                SELECT dr.id_episode
                  INTO l_id_episode
                  FROM drug_req dr, drug_req_det drd
                 WHERE drd.id_drug_req = dr.id_drug_req
                   AND drd.id_drug_req_det = i_drug_req_det;
            
                IF NOT pk_alerts.insert_sys_alert_event(i_lang                => i_lang,
                                                        i_prof                => i_prof,
                                                        i_sys_alert           => 73,
                                                        i_id_episode          => l_id_episode,
                                                        i_id_record           => i_drug_req_det,
                                                        i_dt_record           => current_timestamp,
                                                        i_id_professional     => NULL,
                                                        i_id_room             => NULL,
                                                        i_id_clinical_service => NULL,
                                                        i_flg_type_dest       => 'C',
                                                        i_replace1            => l_code_interv,
                                                        i_replace2            => pk_sysconfig.get_config('ALERT_DRUG_2CHECK_TIMEOUT1',
                                                                                                         i_prof),
                                                        o_error               => l_error)
                THEN
                    set_pharmacy_log(l_db_object_name, 'ERROR! (process_alerts) g_error=' || g_error);
                END IF;
            
                -- remover alerta 72 da tabela sys_alert_event --
                g_error                        := 'DELETE FROM SYS_ALERT_EVENT ALERT 72 SET_PAT_PREPARE';
                l_sys_alert_event.id_sys_alert := 72;
                l_sys_alert_event.id_episode   := l_id_episode;
                l_sys_alert_event.id_record    := i_drug_req_det;
            
                IF NOT pk_alerts.delete_sys_alert_event(i_lang            => i_lang,
                                                        i_prof            => i_prof,
                                                        i_sys_alert_event => l_sys_alert_event,
                                                        o_error           => l_error)
                THEN
                    set_pharmacy_log(l_db_object_name, 'ERROR! (process_alerts) g_error=' || g_error);
                END IF;
            
            END IF;
        
        EXCEPTION
            WHEN OTHERS THEN
                set_pharmacy_log(l_db_object_name, 'ERROR! process_alerts: ' || SQLERRM);
        END process_alerts;
        --
    BEGIN
        l_datetime  := current_timestamp;
        l_row_count := i_drug_req_det.count;
    
        g_error    := 'GET REQ TYPE';
        l_req_type := get_req_type(i_drug_req_det(1), NULL);
    
        FOR i IN 1 .. l_row_count
        LOOP
            l_sup_ended := FALSE;
            --get the current state to check if the request was or not validated by the pharmacist
            SELECT drd.id_state, dr.id_patient
              INTO l_current_req_state, l_id_patient
              FROM drug_req_det drd, drug_req dr
             WHERE drd.id_drug_req_det = i_drug_req_det(i)
               AND drd.id_drug_req = dr.id_drug_req;
        
            --if prepare without pharmacist validation! (id_state_relation = 24 (1 -> 5) and flg_active = Y)
            IF (i_qty_to_prep IS NOT NULL AND i_qty_to_prep(i) IS NOT NULL AND
               l_current_req_state = get_state_for_req_type(i_prof, l_req_type, g_drd_requested_st))
            THEN
                UPDATE drug_req_det drd
                   SET drd.qty_req              = nvl(i_qty_req(i), drd.qty_req),
                       drd.id_unit_measure      = nvl(i_qty_unit(i), drd.id_unit_measure),
                       drd.qty_to_prep          = i_qty_to_prep(i),
                       drd.id_unit_measure_prep = i_qty_to_prep_unit(i)
                 WHERE drd.id_drug_req_det = i_drug_req_det(i);
            
                -- request not validated, direct prepare!!
                l_req_validated := FALSE;
            END IF;
        
            --current req state, qty_to_prepare, qty_sup
            SELECT drd.id_state, nvl(drd.qty_to_prep, 0), SUM(nvl(drs.qty_supply, 0))
              INTO l_current_req_state, l_qty_to_prepare, l_qty_sup
              FROM drug_req_det drd, drug_req_supply drs
             WHERE drd.id_drug_req_det = i_drug_req_det(i)
               AND drd.id_drug_req_det = drs.id_drug_req_det(+)
               AND drs.id_state(+) != get_state_for_req_type(i_prof, NULL, g_drs_rejected_st)
             GROUP BY drd.id_state, drd.qty_to_prep;
        
            IF ((l_qty_sup + i_qty_prepared(i)) > l_qty_to_prepare OR i_qty_prepared(i) <= 0)
            THEN
                RAISE g_ex_invalid_qty_sup;
            ELSE
            
                IF ((l_qty_sup + i_qty_prepared(i)) = l_qty_to_prepare)
                THEN
                    l_sup_ended         := TRUE;
                    l_drd_next_state_id := get_state_for_req_type(i_prof, l_req_type, g_drd_terminated_st);
                ELSE
                    l_drd_next_state_id := get_state_for_req_type(i_prof, l_req_type, g_drd_executing_st);
                END IF;
            
                IF (l_current_req_state = l_drd_next_state_id AND
                   l_current_req_state = get_state_for_req_type(i_prof, l_req_type, g_drd_executing_st))
                THEN
                    l_state_transition_ok := TRUE; --pode continuar em executing se nao for aviada a quantidade total (novamente)
                ELSE
                    l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                                     i_prof,
                                                                                     l_current_req_state,
                                                                                     l_drd_next_state_id);
                END IF;
            
                IF (l_state_transition_ok)
                THEN
                
                    UPDATE drug_req_det drd
                       SET drd.id_state            = l_drd_next_state_id,
                           drd.dt_last_change      = l_datetime,
                           drd.id_prof_last_change = i_prof.id,
                           drd.id_sw_last_change   = i_prof.software,
                           drd.id_inst_last_change = i_prof.institution
                     WHERE drd.id_drug_req_det = i_drug_req_det(i);
                
                    IF (l_current_req_state != l_drd_next_state_id)
                    THEN
                        INSERT INTO drug_req_det_state_transition
                            (id_drug_req_det, id_state, id_prof, dt_state)
                        VALUES
                            (i_drug_req_det(i), l_drd_next_state_id, i_prof.id, l_datetime);
                    END IF;
                
                    --sypply
                    BEGIN
                        SELECT drs.id_drug_req_supply
                          INTO l_drs_next_id
                          FROM drug_req_supply drs
                         WHERE drs.id_drug_req_det = i_drug_req_det(i)
                           AND drs.id_state = get_state_for_req_type(i_prof, NULL, g_drs_preparing_st)
                           AND rownum = 1;
                    EXCEPTION
                        WHEN no_data_found THEN
                            l_is_first_supply := TRUE;
                    END;
                
                    -- TBD: acabar isto!!!
                    -- se for preparao directa tm que
                
                    IF (l_req_validated)
                    THEN
                        --order validated
                        l_drs_next_state_id := get_state_for_req_type(i_prof, NULL, g_drs_readyforvalid_st);
                    ELSE
                        --direct preparation
                        l_drs_next_state_id := get_state_for_req_type(i_prof, NULL, g_drs_readyfortransp_st);
                    END IF;
                
                    IF (l_is_first_supply = TRUE)
                    THEN
                        SELECT seq_drug_req_supply.nextval
                          INTO l_drs_next_id
                          FROM dual;
                    
                        INSERT INTO drug_req_supply
                            (id_drug_req_supply, id_drug_req_det, qty_supply, dt_expire, package_number, id_state)
                        VALUES
                            (l_drs_next_id,
                             i_drug_req_det(i),
                             i_qty_prepared(i),
                             i_package_expire_dt(i),
                             i_package_number(i),
                             l_drs_next_state_id);
                    ELSE
                        UPDATE drug_req_supply drs
                           SET drs.qty_supply     = i_qty_prepared(i),
                               drs.dt_expire      = i_package_expire_dt(i),
                               drs.package_number = i_package_number(i),
                               drs.id_state       = l_drs_next_state_id
                         WHERE drs.id_drug_req_supply = l_drs_next_id;
                    END IF;
                
                    INSERT INTO drug_req_sup_state_transition
                        (id_drug_req_supply, id_state, id_prof, dt_state, notes1)
                    VALUES
                        (l_drs_next_id, l_drs_next_state_id, i_prof.id, l_datetime, i_notes_prepare(i));
                
                    --sypply not completed
                    IF (NOT l_sup_ended)
                    THEN
                        SELECT seq_drug_req_supply.nextval
                          INTO l_drs_next_id
                          FROM dual;
                    
                        INSERT INTO drug_req_supply
                            (id_drug_req_supply, id_drug_req_det, qty_supply, id_state)
                        VALUES
                            (l_drs_next_id,
                             i_drug_req_det(i),
                             0,
                             get_state_for_req_type(i_prof, NULL, g_drs_preparing_st));
                    
                        INSERT INTO drug_req_sup_state_transition
                            (id_drug_req_supply, id_state, id_prof, dt_state)
                        VALUES
                            (l_drs_next_id,
                             get_state_for_req_type(i_prof, NULL, g_drs_preparing_st),
                             i_prof.id,
                             l_datetime);
                    END IF;
                
                ELSE
                    RAISE g_ex_cannot_be_supplyed;
                END IF;
            
            END IF;
        
            IF (l_req_type = g_flg_unidose AND i_unidose_car IS NOT NULL AND i_unidose_car(i) IS NOT NULL)
            THEN
            
                IF (i_unidose_car(i) = -1)
                THEN
                    --ALERT-59101
                    remove_drd_from_unidose_car(i_lang         => i_lang,
                                                i_prof         => i_prof,
                                                i_drug_req_det => i_drug_req_det(i));
                
                    UPDATE drug_req_det drd
                       SET drd.flg_uni_out_off_car = g_yes
                     WHERE drd.id_drug_req_det = i_drug_req_det(i);
                
                ELSE
                
                    IF (nvl(i_unidose_car_slot(i), -1) = -1)
                    THEN
                    
                        BEGIN
                            INSERT INTO pharm_unidose_car_content
                                (id_unidose_car, id_drug_req_det)
                            VALUES
                                (i_unidose_car(i), i_drug_req_det(i));
                        EXCEPTION
                            WHEN dup_val_on_index THEN
                                NULL; --already there
                        END;
                    
                        --remove from slot
                        DELETE FROM pharm_unidose_slot_content usc
                         WHERE usc.id_drug_req_det = i_drug_req_det(i);
                    
                    ELSE
                        --set id_drug_req_det to unidose_slot
                        SELECT COUNT(1)
                          INTO l_check_car_slot
                          FROM pharm_unidose_car_slot ucs
                         WHERE ucs.id_unidose_car = i_unidose_car(i)
                           AND ucs.slot_number = i_unidose_car_slot(i)
                           AND (ucs.id_patient = l_id_patient OR ucs.id_patient IS NULL); --the slot belongs to the patient or the slot is free!
                    
                        IF (l_check_car_slot = 1)
                        THEN
                            UPDATE pharm_unidose_car_slot ucs
                               SET ucs.id_patient = l_id_patient
                             WHERE ucs.id_unidose_car = i_unidose_car(i)
                               AND ucs.slot_number = i_unidose_car_slot(i);
                        
                            BEGIN
                                INSERT INTO pharm_unidose_slot_content
                                    (id_unidose_car, slot_number, id_drug_req_det)
                                VALUES
                                    (i_unidose_car(i), i_unidose_car_slot(i), i_drug_req_det(i));
                            EXCEPTION
                                WHEN dup_val_on_index THEN
                                    NULL; --already there
                            END;
                        
                            --remove order from car (because the order is now related to one car slot)
                            DELETE FROM pharm_unidose_car_content ucc
                             WHERE ucc.id_drug_req_det = i_drug_req_det(i);
                        ELSE
                            RAISE g_ex_unidose_dup_val_slot;
                        END IF;
                    END IF;
                
                    UPDATE drug_req_det drd
                       SET drd.flg_uni_out_off_car = g_no
                     WHERE drd.id_drug_req_det = i_drug_req_det(i);
                
                END IF;
            
                --[MEDICATION_RULE] check if car is pending, if it is then change to preparing!
                g_error := 'CHECK CAR STATE TRANSITION';
                update_unidose_car_state(i_lang => i_lang, i_prof => i_prof, i_id_unidose_car => i_unidose_car(i));
            
            END IF;
        
            --alertas
            process_alerts(l_flg_alert, i_drug_req_det(i));
        
        END LOOP;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END set_pat_prepare;

    /********************************************************************************************
    * alert.pk_pharmacy.set_massive_prepare
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_DRUG_REQ_DET                  IN    ALERT.TABLE_TABLE_NUMBER
    * @param  I_QTY_TO_PREP                   IN    ALERT.TABLE_NUMBER
    * @param  I_QTY_TO_PREP_UNIT              IN    ALERT.TABLE_NUMBER
    * @param  I_QTY_PREPARED                  IN    ALERT.TABLE_NUMBER
    * @param  I_ID_UNIDOSE_CAR                IN    ALERT.TABLE_NUMBER
    * @param  I_FLG_QT_TO_PREP_CHANGED        IN    ALERT.TABLE_VARCHAR
    * @param  I_PACKAGE_NUMBER                IN    ALERT.TABLE_VARCHAR
    * @param  I_PACKAGE_EXPIRE_DT             IN    ALERT.TABLE_VARCHAR
    * @param  I_NOTES_JUSTIF                  IN    VARCHAR2
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.1
    * @since  2009-11-13
    *
    ********************************************************************************************/
    FUNCTION set_massive_prepare
    (
        i_lang                   IN language.id_language%TYPE,
        i_prof                   IN alert.profissional,
        i_drug_req_det           IN table_table_number,
        i_qty_to_prep            IN table_number,
        i_qty_to_prep_unit       IN table_number,
        i_qty_prepared           IN table_number,
        i_id_unidose_car         IN table_number,
        i_flg_qt_to_prep_changed IN table_varchar,
        i_package_number         IN table_varchar,
        i_package_expire_dt      IN table_varchar,
        i_notes_justif           IN VARCHAR2,
        o_error                  OUT t_error_out
    ) RETURN BOOLEAN IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'set_massive_prepare';
        l_qt_pending_drd    drug_req_det.qty_to_prep%TYPE;
        l_qt_delta          drug_req_det.qty_to_prep%TYPE;
        l_qt_to_go          drug_req_det.qty_to_prep%TYPE;
        l_qty_req           drug_req_det.qty_req%TYPE;
        l_qty_unit          drug_req_det.id_unit_measure%TYPE;
        l_qty_to_prep       drug_req_det.qty_to_prep%TYPE;
        l_qty_to_prep_unit  drug_req_det.id_unit_measure_prep%TYPE;
        l_flg_can_prep      sys_config.value%TYPE;
        l_current_drd_state drug_req_det.id_state%TYPE;
    BEGIN
        set_pharmacy_log(l_db_object_name, '***** BEGIN *****');
    
        g_error        := 'GET SYS CONFIGS';
        l_flg_can_prep := nvl(pk_sysconfig.get_config(i_code_cf => 'PHARMACY_UNI_CAN_PREPARE_NOT_VALIDATED',
                                                      i_prof    => i_prof),
                              g_no);
    
        FOR row_prep IN i_drug_req_det.first .. i_drug_req_det.last
        LOOP
            l_qt_delta := i_qty_prepared(row_prep);
            l_qt_to_go := 0;
        
            set_pharmacy_log(l_db_object_name, '==> FOR preps: l_qt_delta=' || l_qt_delta);
        
            FOR req IN i_drug_req_det(row_prep).first .. i_drug_req_det(row_prep).last
            LOOP
                set_pharmacy_log(l_db_object_name,
                                 '====> FOR reqs: i_drug_req_det(row_prep)(req)=' || i_drug_req_det(row_prep) (req));
            
                -- 1) check order state
                g_error := 'GET DRD STATE';
                SELECT drd.id_state
                  INTO l_current_drd_state
                  FROM drug_req_det drd
                 WHERE drd.id_drug_req_det = i_drug_req_det(row_prep) (req);
            
                -- if not validated and can be validated and *TBD (check if validation is needed) -validation is needed (workflow)-, validate
                IF (i_flg_qt_to_prep_changed(row_prep) = g_yes AND l_flg_can_prep = g_yes AND
                   l_current_drd_state =
                   get_state_for_req_type(i_prof         => i_prof,
                                           i_req_type     => g_flg_unidose,
                                           i_generic_name => g_drd_requested_st))
                THEN
                
                    set_pharmacy_log(l_db_object_name,
                                     '====> FOR reqs: (set_pat_check) i_drug_req_det(row_prep)(req)=' ||
                                     i_drug_req_det(row_prep) (req));
                
                    set_pat_check(i_lang                => i_lang,
                                  i_prof                => i_prof,
                                  i_drug_req_det        => table_number(i_drug_req_det(row_prep) (req)),
                                  i_notes_physician     => table_varchar(NULL),
                                  i_notes_pharmacist    => table_varchar(i_notes_justif),
                                  i_med_changed         => table_varchar(g_no),
                                  i_id_drug             => table_varchar(NULL),
                                  i_drug_vers           => table_varchar(NULL),
                                  i_qty_req             => table_number(NULL),
                                  i_qty_unit            => table_number(NULL),
                                  i_qty_prep            => table_number(i_qty_to_prep(row_prep)),
                                  i_qty_prep_unit       => table_number(i_qty_to_prep_unit(row_prep)),
                                  i_wait_for_approv     => table_varchar(NULL),
                                  i_cosigned_by         => table_number(NULL),
                                  i_cosigned_date       => table_varchar(NULL),
                                  i_cosigned_type       => table_number(NULL),
                                  i_cosigned_notes      => table_varchar(NULL),
                                  i_deliver_at_home     => table_varchar(NULL),
                                  i_instr_changed       => table_varchar(g_no),
                                  i_drug_presc_det_new  => table_number(NULL),
                                  i_med_changed_to_new  => table_varchar(g_no),
                                  i_id_presc_directions => table_number(NULL));
                
                END IF; --check
            
                -- 2) check qt pending
                l_qt_pending_drd := get_qty_pending(i_prof            => i_prof,
                                                    i_id_drug_req_det => i_drug_req_det(row_prep) (req),
                                                    i_flg_return_null => g_no);
            
                IF (l_qt_delta < l_qt_pending_drd)
                THEN
                    l_qt_to_go := l_qt_delta;
                ELSE
                    l_qt_to_go := l_qt_pending_drd;
                END IF;
            
                l_qt_delta := l_qt_delta - l_qt_to_go;
            
                --
                l_qty_req          := NULL;
                l_qty_unit         := NULL;
                l_qty_to_prep      := NULL;
                l_qty_to_prep_unit := NULL;
                --
            
                -- 3) prepare
                set_pharmacy_log(l_db_object_name,
                                 '====> FOR reqs: (set_pat_prepare) l_qt_pending_drd=' || l_qt_pending_drd ||
                                 '##l_qt_to_go=' || l_qt_to_go);
            
                IF (l_qt_to_go > 0)
                THEN
                    set_pat_prepare(i_lang              => i_lang,
                                    i_prof              => i_prof,
                                    i_drug_req_det      => table_number(i_drug_req_det(row_prep) (req)),
                                    i_qty_req           => table_number(l_qty_req),
                                    i_qty_unit          => table_number(l_qty_unit),
                                    i_qty_to_prep       => table_number(l_qty_to_prep),
                                    i_qty_to_prep_unit  => table_number(l_qty_to_prep_unit),
                                    i_qty_prepared      => table_number(l_qt_to_go),
                                    i_package_number    => table_varchar(i_package_number(row_prep)),
                                    i_package_expire_dt => table_varchar(i_package_expire_dt(row_prep)),
                                    i_notes_prepare     => table_varchar(NULL),
                                    i_unidose_car       => table_number(NULL),
                                    i_unidose_car_slot  => table_number(NULL));
                END IF;
            
            END LOOP; --reqs
        
        END LOOP; --rows
    
        set_pharmacy_log(l_db_object_name, '***** END *****');
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_massive_prepare;

    /********************************************************************************************
    * alert.pk_pharmacy.set_pat_prepare
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_DRUG_REQ_DET                  IN    ALERT.TABLE_NUMBER
    * @param  I_QTY_REQ                       IN    ALERT.TABLE_NUMBER
    * @param  I_QTY_UNIT                      IN    ALERT.TABLE_NUMBER
    * @param  I_QTY_TO_PREP                   IN    ALERT.TABLE_NUMBER
    * @param  I_QTY_TO_PREP_UNIT              IN    ALERT.TABLE_NUMBER
    * @param  I_QTY_PREPARED                  IN    ALERT.TABLE_NUMBER
    * @param  I_PACKAGE_NUMBER                IN    ALERT.TABLE_VARCHAR
    * @param  I_PACKAGE_EXPIRE_DT             IN    ALERT.TABLE_VARCHAR
    * @param  I_NOTES_PREPARE                 IN    ALERT.TABLE_VARCHAR
    * @param  I_UNIDOSE_CAR                   IN    ALERT.TABLE_NUMBER
    * @param  I_UNIDOSE_CAR_SLOT              IN    ALERT.TABLE_NUMBER
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-07-29
    *
    ********************************************************************************************/
    FUNCTION set_pat_prepare
    (
        i_lang              IN language.id_language%TYPE,
        i_prof              IN alert.profissional,
        i_drug_req_det      IN table_number,
        i_qty_req           IN table_number,
        i_qty_unit          IN table_number,
        i_qty_to_prep       IN table_number,
        i_qty_to_prep_unit  IN table_number,
        i_qty_prepared      IN table_number,
        i_package_number    IN table_varchar,
        i_package_expire_dt IN table_varchar,
        i_notes_prepare     IN table_varchar,
        i_unidose_car       IN table_number DEFAULT NULL,
        i_unidose_car_slot  IN table_number DEFAULT NULL,
        o_error             OUT t_error_out
    ) RETURN BOOLEAN IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'set_pat_prepare';
    BEGIN
        set_pat_prepare(i_lang              => i_lang,
                        i_prof              => i_prof,
                        i_drug_req_det      => i_drug_req_det,
                        i_qty_req           => i_qty_req,
                        i_qty_unit          => i_qty_unit,
                        i_qty_to_prep       => i_qty_to_prep,
                        i_qty_to_prep_unit  => i_qty_to_prep_unit,
                        i_qty_prepared      => i_qty_prepared,
                        i_package_number    => i_package_number,
                        i_package_expire_dt => i_package_expire_dt,
                        i_notes_prepare     => i_notes_prepare,
                        i_unidose_car       => i_unidose_car,
                        i_unidose_car_slot  => i_unidose_car_slot);
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_pat_prepare;

    /********************************************************************************************
    * alert.pk_pharmacy.format_qty_details
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_QT                            IN    NUMBER
    * @param  I_UNIT                          IN    NUMBER(24)
    * @param  I_FORMAT                        IN    NUMBER
    *
    * @return VARCHAR2
    *
    * @author Rui Marante
    * @version  2.5.0.7.8
    * @since  2010-03-29
    *
    * @notes
    *
    ********************************************************************************************/
    FUNCTION format_qty_details
    (
        i_lang   IN language.id_language%TYPE,
        i_prof   IN alert.profissional,
        i_qt     IN NUMBER,
        i_unit   IN unit_measure.id_unit_measure%TYPE,
        i_format IN NUMBER DEFAULT 4 --pk_medication_core.get_unit_translation
    ) RETURN VARCHAR2 IS
        l_result VARCHAR2(1000 CHAR) := '';
        l_error  t_error_out;
    BEGIN
        g_error := 'format_qty_details';
        IF (i_qt IS NULL OR i_unit IS NULL)
        THEN
            l_result := NULL;
        ELSE
            l_result := pk_utils.number_to_char(i_prof, i_qt) || ' ' ||
                        pk_medication_core.get_unit_translation(i_lang            => i_lang,
                                                                i_prof            => i_prof,
                                                                i_id_unit_measure => i_unit,
                                                                i_type            => i_format);
        END IF;
    
        RETURN l_result;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'format_qty_details', l_error);
            RAISE;
    END format_qty_details;

    /********************************************************************************************
    * alert.pk_pharmacy.get_req_details
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_DRUG_REQ_DET                  IN    NUMBER(24)
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  O_REQ_HEADER                    OUT   REF CURSOR
    * @param  O_REQ_DETAILS                   OUT   REF CURSOR
    * @param  O_WARNINGS_DETAILS              OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_HEADERS_DETAILS               OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-02
    *
    ********************************************************************************************/
    FUNCTION get_req_details
    (
        i_lang             IN language.id_language%TYPE,
        i_prof             IN alert.profissional,
        i_drug_req_det     IN drug_req_det.id_drug_req_det%TYPE,
        i_get_headers      IN VARCHAR2 DEFAULT 'N',
        i_header_codes     IN table_varchar DEFAULT NULL,
        o_req_header       OUT pk_types.cursor_type,
        o_req_details      OUT pk_types.cursor_type,
        o_warnings_details OUT pk_types.cursor_type,
        o_headers          OUT pk_types.cursor_type,
        o_headers_details  OUT pk_types.cursor_type,
        o_error            OUT t_error_out
    ) RETURN BOOLEAN IS
        l_header_codes table_varchar;
        l_req_type     drug_req.flg_type%TYPE;
        l_epis         episode.id_episode%TYPE;
    BEGIN
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error        := 'GET HEADERS FOR DETAILS';
        l_header_codes := table_varchar --label list for all kind of details
                          ('PHARMACIST_DETAIL_DCI',
                           'PHARMACIST_DETAIL_FORM_PHARM',
                           'PHARMACIST_DETAIL_CHNM',
                           'PHARMACIST_DETAIL_NOTES1',
                           'PHARMACIST_DETAIL_NOTES2',
                           'PHARMACIST_DETAIL_REFILL',
                           'PHARMACIST_DETAIL_PHARM_DESC',
                           'PHARMACIST_DETAIL_PHARM_DESC_OLD',
                           'PHARMACIST_DETAIL_PHARM_INSTR_OLD',
                           'PHARMACIST_DETAIL_QTY_TO_PREP_OLD',
                           'PHARMACIST_DETAIL_PHARM_DESC_NEW',
                           'PHARMACIST_DETAIL_PHARM_INSTR_NEW',
                           'PHARMACIST_DETAIL_QTY',
                           'PHARMACIST_DETAIL_QTY_REQ',
                           'PHARMACIST_DETAIL_QTY_TO_PREP',
                           'PHARMACIST_DETAIL_QTY_PREP',
                           'PHARMACIST_DETAIL_QTY_DEV',
                           'PHARMACIST_DETAIL_QTY_STOCK',
                           'PHARMACIST_DETAIL_QTY_TRASH',
                           'PHARMACIST_DETAIL_PACKAGE_NUMBER',
                           'PHARMACIST_DETAIL_DT_EXPIRE',
                           'PHARMACIST_DETAIL_DT_EXPIRE_SUPPLY',
                           'PHARMACIST_DETAIL_NOTES_JUSTIF',
                           'PHARMACIST_DETAIL_PROF_NAME_CO_SIGN',
                           'PHARMACIST_DETAIL_TYPE_CO_SIGN',
                           'PHARMACIST_DETAIL_HAS_DUPLICATES',
                           'PHARMACIST_DETAIL_RECM',
                           'PHARMACIST_DETAIL_NOTES_TO_PHYSICIAN',
                           'PHARMACIST_DETAIL_NOTES_TO_PHARM',
                           'PHARMACIST_DETAIL_NOTES_2CHECK',
                           'PHARMACIST_DETAIL_NOTES_REJECT',
                           'PHARMACIST_DETAIL_NOTES_PREPARATION',
                           'PHARMACIST_DETAIL_CLINICAL_INFO',
                           'PHARMACIST_DETAIL_PRESC_JUSTIFICATION',
                           'PHARMACIST_DETAIL_OTHER_MED_JUSTIFICATION',
                           'PHARMACIST_DETAIL_BACTERIO_STUDY_JUSTIF',
                           'PHARMACIST_DETAIL_BACTERIO_STUDY_RESULT',
                           'PHARMACIST_DETAIL_PHARM_SERVICES',
                           'PHARMACIST_DETAIL_CANCEL_REASON',
                           'PHARMACIST_DETAIL_FIRST_DOSE');
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, l_header_codes, o_headers_details);
    
        g_error    := 'GET REQ TYPE';
        l_req_type := get_req_type(i_drug_req_det, NULL);
        l_epis     := get_episode_drug_req_det(i_drug_req_det);
    
        --drug description
        OPEN o_req_header FOR
            SELECT decode(drd.id_drug,
                          g_drug_iv_fluid_constructed,
                          get_medication_name(i_lang,
                                              i_prof,
                                              drd.id_drug,
                                              drd.vers,
                                              dr.flg_type,
                                              dr.id_drug_presc_det,
                                              g_yes,
                                              drd.id_other_product),
                          nvl(mm.dci_descr,
                              get_medication_name(i_lang,
                                                  i_prof,
                                                  drd.id_drug,
                                                  drd.vers,
                                                  dr.flg_type,
                                                  dr.id_drug_presc_det,
                                                  g_yes,
                                                  drd.id_other_product))) dci,
                   mm.form_farm_descr form_pharm,
                   mm.chnm_id chnm,
                   decode(dr.flg_type, g_flg_int, pk_sysdomain.get_domain('YES_NO', drd.first_dose, i_lang), NULL) first_dose,
                   decode(length(TRIM(translate(drd.refill, ' +-.0123456789', ' '))), NULL, drd.refill, NULL) refill
              FROM drug_req_det drd
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
              LEFT JOIN mi_med mm
                ON (drd.id_drug = mm.id_drug AND drd.vers = mm.vers)
             WHERE drd.id_drug_req_det = i_drug_req_det;
    
        --details
        OPEN o_req_details FOR
        --REQUESTED
            SELECT pk_translation.get_translation(i_lang, s.code_state) state_name,
                   pk_medication_core.format_detail_date(i_lang, i_prof, drdst.dt_create /*drdst.dt_state*/) dt_state,
                   pk_prof_utils.get_name_signature(i_lang, i_prof, drdst.id_prof) prof_name,
                   pk_prof_utils.get_spec_signature(i_lang, i_prof, drdst.id_prof, drdst.dt_state, l_epis) spec_name,
                   drdst.dt_create dt,
                   NULL refill,
                   -- current/new medication block
                   decode(drdhm.id_drug,
                          NULL,
                          get_medication_name(i_lang,
                                              i_prof,
                                              drd.id_drug,
                                              drd.vers,
                                              dr.flg_type,
                                              dr.id_drug_presc_det,
                                              g_yes,
                                              drd.id_other_product),
                          get_medication_name(i_lang,
                                              i_prof,
                                              drdhm.id_drug,
                                              drdhm.vers,
                                              dr.flg_type,
                                              dr.id_drug_presc_det,
                                              g_yes,
                                              drdhm.id_other_product)) pharm_desc,
                   NULL pharm_desc_new,
                   NULL pharm_instr_new,
                   -- qtties
                   decode(drdhm.qty,
                          NULL,
                          format_qty_details(i_lang, i_prof, drd.qty_req, drd.id_unit_measure),
                          format_qty_details(i_lang, i_prof, drdhm.qty, drdhm.id_unit_measure)) qty,
                   NULL qty_req,
                   NULL qty_to_prep,
                   NULL qty_prep,
                   NULL qty_dev,
                   NULL qty_stock,
                   NULL qty_trash,
                   NULL prof_name_co_sign,
                   NULL type_co_sign,
                   -- old medication block           
                   NULL pharm_desc_old,
                   NULL pharm_instr_old,
                   NULL qty_to_prep_old,
                   drd.package_number package_number,
                   pk_date_utils.date_chr_short_read_tsz(i_lang,
                                                         drd.dt_expire_tstz,
                                                         i_prof.institution,
                                                         i_prof.software) dt_expire,
                   NULL dt_expire_supply,
                   NULL notes_justif,
                   NULL has_duplicates,
                   NULL recm,
                   NULL notes_to_physician,
                   NULL notes_to_pharm,
                   format_notes(table_varchar(drdst.notes1), g_no) notes1,
                   NULL notes_2check,
                   NULL notes_reject,
                   NULL notes_preparation,
                   --presc justification
                   dpj.clinical_info           clinical_info,
                   dpj.presc_justification     presc_justification,
                   dpj.other_med_justification other_med_justification,
                   dpj.bacterio_study_justif   bacterio_study_justif,
                   dpj.bacterio_study_result   bacterio_study_result,
                   NULL                        pharm_services,
                   NULL                        cancel_reason
              FROM drug_req_det                  drd,
                   drug_req                      dr,
                   drug_req_det_state_transition drdst,
                   wfl_state                     s,
                   drug_req_det_hist_modif       drdhm,
                   drug_presc_justification      dpj
             WHERE drd.id_drug_req_det = i_drug_req_det
               AND drd.id_drug_req = dr.id_drug_req
               AND drd.id_drug_req_det = drdst.id_drug_req_det
               AND drdst.id_state = s.id_state
               AND drdst.id_state = get_state_for_req_type(i_prof, l_req_type, g_drd_requested_st)
               AND drd.id_drug_req_det = drdhm.id_drug_req_det(+)
               AND dr.id_drug_presc_det = dpj.id_drug_presc_det(+)
            UNION ALL
            --VALIDATED
            SELECT pk_translation.get_translation(i_lang, s.code_state) state_name,
                   pk_medication_core.format_detail_date(i_lang, i_prof, drdst.dt_state) dt_state,
                   pk_prof_utils.get_name_signature(i_lang, i_prof, drdst.id_prof) prof_name,
                   pk_prof_utils.get_spec_signature(i_lang, i_prof, drdst.id_prof, drdst.dt_state, l_epis) spec_name,
                   drdst.dt_state dt,
                   NULL refill,
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.flg_type,
                                       dr.id_drug_presc_det,
                                       g_yes,
                                       drd.id_other_product) pharm_desc,
                   NULL pharm_desc_new,
                   NULL pharm_instr_new,
                   NULL qty,
                   NULL qty_req,
                   format_qty_details(i_lang, i_prof, drd.qty_to_prep, drd.id_unit_measure_prep) qty_to_prep,
                   NULL qty_prep,
                   NULL qty_dev,
                   NULL qty_stock,
                   NULL qty_trash,
                   NULL prof_name_co_sign,
                   NULL type_co_sign,
                   NULL pharm_desc_old,
                   NULL pharm_instr_old,
                   NULL qty_to_prep_old,
                   NULL package_number,
                   NULL dt_expire,
                   NULL dt_expire_supply,
                   NULL notes_justif,
                   decode(dr.flg_type, g_flg_int, decode(dr.flg_print_type, 'N', '1', 'V2', '2', 'R', '3', '--'), NULL) has_duplicates,
                   decode(dr.flg_type, g_flg_int, mr.suggested_descr, NULL) recm,
                   format_notes(table_varchar(drdst.notes1), g_no) notes_to_physician,
                   format_notes(table_varchar(drdst.notes2), g_no) notes_to_pharm,
                   NULL notes1,
                   NULL notes_2check,
                   NULL notes_reject,
                   NULL notes_preparation,
                   NULL clinical_info,
                   NULL presc_justification,
                   NULL other_med_justification,
                   NULL bacterio_study_justif,
                   NULL bacterio_study_result,
                   dpj.pharmacist_notes pharm_services,
                   NULL cancel_reason
              FROM drug_req_det drd
              LEFT JOIN mi_regulation mr
                ON (drd.regulation_id = mr.regulation_id AND drd.vers = mr.vers)
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             INNER JOIN drug_req_det_state_transition drdst
                ON (drd.id_drug_req_det = drdst.id_drug_req_det)
             INNER JOIN wfl_state s
                ON (drdst.id_state = s.id_state)
              LEFT JOIN drug_presc_justification dpj
                ON (dr.id_drug_presc_det = dpj.id_drug_presc_det)
             WHERE drd.id_drug_req_det = i_drug_req_det
               AND drdst.id_state IN
                   (SELECT column_value
                      FROM TABLE(get_states_for_req_type(i_prof,
                                                         l_req_type,
                                                         table_varchar(g_drd_validated_st, g_drd_validated_without_wf_st))))
            UNION ALL
            
            --VALIDATED WITH CO-SIGN (DRUG SWITCH)
            SELECT pk_translation.get_translation(i_lang, s.code_state) state_name,
                   pk_medication_core.format_detail_date(i_lang, i_prof, drdst.dt_state) dt_state,
                   pk_prof_utils.get_name_signature(i_lang, i_prof, drdst.id_prof) prof_name,
                   pk_prof_utils.get_spec_signature(i_lang, i_prof, drdst.id_prof, drdst.dt_state, l_epis) spec_name,
                   drdst.dt_state dt,
                   NULL refill,
                   NULL pharm_desc,
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd_new.id_drug,
                                       drd_new.vers,
                                       dr_new.flg_type,
                                       dr_new.id_drug_presc_det,
                                       g_yes,
                                       drd_new.id_other_product) pharm_desc_new,
                   get_drug_desc_instr(i_lang, i_prof, dr_new.id_episode, drd_new.id_drug_req_det) pharm_instr_new,
                   NULL qty,
                   NULL qty_req,
                   format_qty_details(i_lang, i_prof, drd_new.qty_to_prep, drd_new.id_unit_measure_prep) qty_to_prep,
                   NULL qty_prep,
                   NULL qty_dev,
                   NULL qty_stock,
                   NULL qty_trash,
                   pk_prof_utils.get_name_signature(i_lang, i_prof, drd_new.id_prof_co_sign) prof_name_co_sign,
                   pk_translation.get_translation(i_lang, ot.code_order_type) ||
                   format_notes(table_varchar(drd_new.notes_co_sign), g_no, g_no, ' / ') type_co_sign,
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd_old.id_drug,
                                       drd_old.vers,
                                       dr_old.flg_type,
                                       dr_old.id_drug_presc_det,
                                       g_yes,
                                       drd_old.id_other_product) pharm_desc_old,
                   get_drug_desc_instr(i_lang, i_prof, dr_old.id_episode, drd_old.id_drug_req_det) pharm_instr_old,
                   NULL qty_to_prep_old,
                   NULL package_number,
                   NULL dt_expire,
                   NULL dt_expire_supply,
                   NULL notes_justif,
                   NULL has_duplicates,
                   NULL recm,
                   format_notes(table_varchar(drdst.notes1), g_no) notes_to_physician,
                   format_notes(table_varchar(drdst.notes2), g_no) notes_to_pharm,
                   NULL notes1,
                   NULL notes_2check,
                   NULL notes_reject,
                   NULL notes_preparation,
                   NULL clinical_info,
                   NULL presc_justification,
                   NULL other_med_justification,
                   NULL bacterio_study_justif,
                   NULL bacterio_study_result,
                   NULL pharm_services,
                   NULL cancel_reason
              FROM pharm_drd_switch pds
             INNER JOIN drug_req_det drd_old
                ON (pds.id_drug_req_det_old = drd_old.id_drug_req_det)
             INNER JOIN drug_req dr_old
                ON (drd_old.id_drug_req = dr_old.id_drug_req)
             INNER JOIN drug_req_det drd_new
                ON (pds.id_drug_req_det_new = drd_new.id_drug_req_det)
             INNER JOIN drug_req dr_new
                ON (drd_new.id_drug_req = dr_new.id_drug_req)
              LEFT JOIN order_type ot
                ON (drd_new.id_type_co_sign = ot.id_order_type)
             INNER JOIN drug_req_det_state_transition drdst
                ON (drd_new.id_drug_req_det = drdst.id_drug_req_det)
             INNER JOIN wfl_state s
                ON (drdst.id_state = s.id_state)
             WHERE pds.id_drug_req_det_new = i_drug_req_det
               AND drdst.id_state IN
                   (SELECT column_value
                      FROM TABLE(get_states_for_req_type(i_prof,
                                                         l_req_type,
                                                         table_varchar(g_drd_validated_sign_st,
                                                                       g_drd_validated_without_wf_st))))
            UNION ALL
            
            --VALIDATED WITH CO-SIGN (DRUG MODIFICATIONS)
            SELECT pk_translation.get_translation(i_lang, s.code_state) state_name,
                   pk_medication_core.format_detail_date(i_lang, i_prof, drdst.dt_state) dt_state,
                   pk_prof_utils.get_name_signature(i_lang, i_prof, drdst.id_prof) prof_name,
                   pk_prof_utils.get_spec_signature(i_lang, i_prof, drdst.id_prof, drdst.dt_state, l_epis) spec_name,
                   drdst.dt_state dt,
                   NULL refill,
                   NULL pharm_desc,
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd_new.id_drug,
                                       drd_new.vers,
                                       dr_new.flg_type,
                                       dr_new.id_drug_presc_det,
                                       g_yes,
                                       drd_new.id_other_product) pharm_desc_new,
                   get_drug_desc_instr(i_lang, i_prof, dr_new.id_episode, drd_new.id_drug_req_det) pharm_instr_new,
                   NULL qty,
                   NULL qty_req,
                   format_qty_details(i_lang, i_prof, drd_new.qty_to_prep, drd_new.id_unit_measure_prep) qty_to_prep,
                   NULL qty_prep,
                   NULL qty_dev,
                   NULL qty_stock,
                   NULL qty_trash,
                   pk_prof_utils.get_name_signature(i_lang, i_prof, drd_new.id_prof_co_sign) prof_name_co_sign,
                   pk_translation.get_translation(i_lang, ot.code_order_type) ||
                   format_notes(table_varchar(drd_new.notes_co_sign), g_no, g_no, ' / ') type_co_sign,
                   get_medication_name(i_lang,
                                       i_prof,
                                       drdhm.id_drug,
                                       drdhm.vers,
                                       dr_new.flg_type,
                                       dr_new.id_drug_presc_det,
                                       g_yes,
                                       drdhm.id_other_product) pharm_desc_old,
                   get_drug_desc_instr(i_lang, i_prof, NULL, NULL, drdhm.id_presc_directions) pharm_instr_old,
                   --format_qty_details(i_lang, i_prof, drdhm.qty, drdhm.id_unit_measure) qty_to_prep_old,
                   NULL qty_to_prep_old,
                   NULL package_number,
                   NULL dt_expire,
                   NULL dt_expire_supply,
                   NULL notes_justif,
                   NULL has_duplicates,
                   NULL recm,
                   format_notes(table_varchar(drdst.notes1), g_no) notes_to_physician,
                   format_notes(table_varchar(drdst.notes2), g_no) notes_to_pharm,
                   NULL notes1,
                   NULL notes_2check,
                   NULL notes_reject,
                   NULL notes_preparation,
                   NULL clinical_info,
                   NULL presc_justification,
                   NULL other_med_justification,
                   NULL bacterio_study_justif,
                   NULL bacterio_study_result,
                   NULL pharm_services,
                   NULL cancel_reason
              FROM drug_req_det_hist_modif drdhm
             INNER JOIN drug_req_det drd_new
                ON (drdhm.id_drug_req_det = drd_new.id_drug_req_det)
             INNER JOIN drug_req dr_new
                ON (drd_new.id_drug_req = dr_new.id_drug_req)
              LEFT JOIN order_type ot
                ON (drd_new.id_type_co_sign = ot.id_order_type)
             INNER JOIN drug_req_det_state_transition drdst
                ON (drd_new.id_drug_req_det = drdst.id_drug_req_det)
             INNER JOIN wfl_state s
                ON (drdst.id_state = s.id_state)
             WHERE drdhm.id_drug_req_det = i_drug_req_det
               AND drdst.id_state IN
                   (SELECT column_value
                      FROM TABLE(get_states_for_req_type(i_prof,
                                                         l_req_type,
                                                         table_varchar(g_drd_validated_sign_st,
                                                                       g_drd_validated_without_wf_st))))
            UNION ALL
            
            --REJECTED AND OTHERS ***
            SELECT pk_translation.get_translation(i_lang, s.code_state) state_name,
                   pk_medication_core.format_detail_date(i_lang, i_prof, drdst.dt_state) dt_state,
                   pk_prof_utils.get_name_signature(i_lang, i_prof, drdst.id_prof) prof_name,
                   pk_prof_utils.get_spec_signature(i_lang, i_prof, drdst.id_prof, drdst.dt_state, l_epis) spec_name,
                   drdst.dt_state dt,
                   NULL refill,
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.flg_type,
                                       dr.id_drug_presc_det,
                                       g_yes,
                                       drd.id_other_product) pharm_desc,
                   NULL pharm_desc_new,
                   NULL pharm_instr_new,
                   NULL qty,
                   NULL qty_req,
                   NULL qty_to_prep,
                   NULL qty_prep,
                   NULL qty_dev,
                   NULL qty_stock,
                   NULL qty_trash,
                   NULL prof_name_co_sign,
                   NULL type_co_sign,
                   NULL pharm_desc_old,
                   NULL pharm_instr_old,
                   NULL qty_to_prep_old,
                   NULL package_number,
                   NULL dt_expire,
                   NULL dt_expire_supply,
                   NULL notes_justif,
                   NULL has_duplicates,
                   NULL recm,
                   NULL notes_to_physician,
                   NULL notes_to_pharm,
                   CASE
                       WHEN drdst.id_state != get_state_for_req_type(i_prof, l_req_type, g_drd_rejected_st) THEN
                        format_notes(table_varchar(drdst.notes1), g_no)
                       ELSE
                        NULL
                   END notes1,
                   NULL notes_2check,
                   CASE
                       WHEN drdst.id_state = get_state_for_req_type(i_prof, l_req_type, g_drd_rejected_st) THEN
                        format_notes(table_varchar(drdst.notes1), g_no)
                       ELSE
                        NULL
                   END notes_reject,
                   NULL notes_preparation,
                   NULL clinical_info,
                   NULL presc_justification,
                   NULL other_med_justification,
                   NULL bacterio_study_justif,
                   NULL bacterio_study_result,
                   NULL pharm_services,
                   NULL cancel_reason
              FROM drug_req_det drd
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             INNER JOIN drug_req_det_state_transition drdst
                ON (drd.id_drug_req_det = drdst.id_drug_req_det)
             INNER JOIN wfl_state s
                ON (drdst.id_state = s.id_state)
             WHERE drd.id_drug_req_det = i_drug_req_det
               AND drdst.id_state NOT IN
                   (SELECT column_value
                      FROM TABLE(get_states_for_req_type(i_prof,
                                                         l_req_type,
                                                         table_varchar(g_drd_requested_st,
                                                                       g_drd_validated_st,
                                                                       g_drd_validated_sign_st,
                                                                       g_drd_executing_st,
                                                                       g_drd_terminated_st,
                                                                       g_drd_validated_without_wf_st))))
            UNION ALL
            
            --CANCELED PENDING SUPPLY **
            SELECT pk_translation.get_translation(i_lang, s.code_state) state_name,
                   pk_medication_core.format_detail_date(i_lang, i_prof, drsst.dt_state) dt_state,
                   pk_prof_utils.get_name_signature(i_lang, i_prof, drsst.id_prof) prof_name,
                   pk_prof_utils.get_spec_signature(i_lang, i_prof, drsst.id_prof, drsst.dt_state, l_epis) spec_name,
                   drsst.dt_state dt,
                   NULL refill,
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.flg_type,
                                       dr.id_drug_presc_det,
                                       g_yes,
                                       drd.id_other_product) pharm_desc,
                   NULL pharm_desc_new,
                   NULL pharm_instr_new,
                   NULL qty,
                   NULL qty_req,
                   NULL qty_to_prep,
                   NULL qty_prep,
                   NULL qty_dev,
                   NULL qty_stock,
                   NULL qty_trash,
                   NULL prof_name_co_sign,
                   NULL type_co_sign,
                   NULL pharm_desc_old,
                   NULL pharm_instr_old,
                   NULL qty_to_prep_old,
                   NULL package_number,
                   NULL dt_expire,
                   NULL dt_expire_supply,
                   drsst.notes1 notes_justif,
                   NULL has_duplicates,
                   NULL recm,
                   NULL notes_to_physician,
                   NULL notes_to_pharm,
                   format_notes(table_varchar(drsst.notes2), g_no) notes1,
                   NULL notes_2check,
                   NULL notes_reject,
                   NULL notes_preparation,
                   NULL clinical_info,
                   NULL presc_justification,
                   NULL other_med_justification,
                   NULL bacterio_study_justif,
                   NULL bacterio_study_result,
                   NULL pharm_services,
                   drsst.notes1 cancel_reason
              FROM drug_req_det drd
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             INNER JOIN drug_req_supply drs
                ON (drd.id_drug_req_det = drs.id_drug_req_det)
             INNER JOIN drug_req_sup_state_transition drsst
                ON (drs.id_drug_req_supply = drsst.id_drug_req_supply)
             INNER JOIN wfl_state s
                ON (drsst.id_state = s.id_state)
             WHERE drd.id_drug_req_det = i_drug_req_det
               AND drsst.id_state = get_state_for_req_type(i_prof, NULL, g_drs_canceled_st)
            UNION ALL
            
            --SUPPLY PREPARED
            SELECT pk_translation.get_translation(i_lang, s.code_state) state_name,
                   pk_medication_core.format_detail_date(i_lang, i_prof, drsst.dt_state) dt_state,
                   pk_prof_utils.get_name_signature(i_lang, i_prof, drsst.id_prof) prof_name,
                   pk_prof_utils.get_spec_signature(i_lang, i_prof, drsst.id_prof, drsst.dt_state, l_epis) spec_name,
                   drsst.dt_state dt,
                   NULL refill,
                   
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.flg_type,
                                       dr.id_drug_presc_det,
                                       g_yes,
                                       drd.id_other_product) pharm_desc,
                   NULL pharm_desc_new,
                   NULL pharm_instr_new,
                   NULL qty,
                   format_qty_details(i_lang, i_prof, drd.qty_req, drd.id_unit_measure) qty_req,
                   format_qty_details(i_lang, i_prof, drd.qty_to_prep, drd.id_unit_measure_prep) qty_to_prep,
                   format_qty_details(i_lang, i_prof, drs.qty_supply, drd.id_unit_measure_prep) qty_prep,
                   NULL qty_dev,
                   NULL qty_stock,
                   NULL qty_trash,
                   NULL prof_name_co_sign,
                   NULL type_co_sign,
                   NULL pharm_desc_old,
                   NULL pharm_instr_old,
                   NULL qty_to_prep_old,
                   drs.package_number,
                   NULL dt_expire,
                   pk_date_utils.date_chr_short_read(i_lang, to_timestamp(drs.dt_expire, 'YYYYMMDDHH24MISS'), i_prof) dt_expire_supply,
                   NULL notes_justif,
                   NULL has_duplicates,
                   NULL recm,
                   NULL notes_to_physician,
                   NULL notes_to_pharm,
                   NULL notes1,
                   NULL notes_2check,
                   NULL notes_reject,
                   format_notes(table_varchar(drsst.notes1), g_no) notes_preparation,
                   NULL clinical_info,
                   NULL presc_justification,
                   NULL other_med_justification,
                   NULL bacterio_study_justif,
                   NULL bacterio_study_result,
                   NULL pharm_services,
                   NULL cancel_reason
              FROM drug_req_det drd
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             INNER JOIN drug_req_supply drs
                ON (drd.id_drug_req_det = drs.id_drug_req_det)
             INNER JOIN drug_req_sup_state_transition drsst
                ON (drs.id_drug_req_supply = drsst.id_drug_req_supply)
             INNER JOIN wfl_state s
                ON (drsst.id_state = s.id_state)
             WHERE drd.id_drug_req_det = i_drug_req_det
               AND drsst.id_state = get_state_for_req_type(i_prof, NULL, g_drs_readyforvalid_st)
            UNION ALL
            
            --TRANSPORT (PHARMACY -> SERVICE)
            SELECT pk_translation.get_translation(i_lang, s.code_state) state_name,
                   pk_medication_core.format_detail_date(i_lang, i_prof, drsst.dt_state) dt_state,
                   pk_prof_utils.get_name_signature(i_lang, i_prof, drsst.id_prof) prof_name,
                   pk_prof_utils.get_spec_signature(i_lang, i_prof, drsst.id_prof, drsst.dt_state, l_epis) spec_name,
                   drsst.dt_state dt,
                   NULL refill,
                   
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.flg_type,
                                       dr.id_drug_presc_det,
                                       g_yes,
                                       drd.id_other_product) pharm_desc,
                   NULL pharm_desc_new,
                   NULL pharm_instr_new,
                   format_qty_details(i_lang, i_prof, drs.qty_supply, drd.id_unit_measure_prep) qty,
                   NULL qty_req,
                   NULL qty_to_prep,
                   NULL qty_prep,
                   NULL qty_dev,
                   NULL qty_stock,
                   NULL qty_trash,
                   NULL prof_name_co_sign,
                   NULL type_co_sign,
                   NULL pharm_desc_old,
                   NULL pharm_instr_old,
                   NULL qty_to_prep_old,
                   NULL package_number,
                   NULL dt_expire,
                   NULL dt_expire_supply,
                   NULL notes_justif,
                   NULL has_duplicates,
                   NULL recm,
                   NULL notes_to_physician,
                   NULL notes_to_pharm,
                   '--' notes1,
                   NULL notes_2check,
                   NULL notes_reject,
                   NULL notes_preparation,
                   NULL clinical_info,
                   NULL presc_justification,
                   NULL other_med_justification,
                   NULL bacterio_study_justif,
                   NULL bacterio_study_result,
                   NULL pharm_services,
                   NULL cancel_reason
              FROM drug_req_det drd
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             INNER JOIN drug_req_supply drs
                ON (drd.id_drug_req_det = drs.id_drug_req_det)
             INNER JOIN drug_req_sup_state_transition drsst
                ON (drs.id_drug_req_supply = drsst.id_drug_req_supply)
             INNER JOIN wfl_state s
                ON (drsst.id_state = s.id_state)
             WHERE drd.id_drug_req_det = i_drug_req_det
               AND drsst.id_state NOT IN
                   (SELECT column_value
                      FROM TABLE(get_states_for_req_type(i_prof,
                                                         NULL,
                                                         table_varchar(g_drs_readyforvalid_st,
                                                                       g_drs_preparing_st,
                                                                       g_drs_rejected_st,
                                                                       g_drs_canceled_st,
                                                                       g_drs_uni_ready4transp_st))))
               AND dr.flg_type <> g_flg_int
            UNION ALL
            --PRESCRIPTION DELIVERED TO PATIENT
            SELECT pk_translation.get_translation(i_lang, s.code_state) state_name,
                   pk_medication_core.format_detail_date(i_lang, i_prof, drsst.dt_state) dt_state,
                   pk_prof_utils.get_name_signature(i_lang, i_prof, drsst.id_prof) prof_name,
                   pk_prof_utils.get_spec_signature(i_lang, i_prof, drsst.id_prof, drsst.dt_state, l_epis) spec_name,
                   drsst.dt_state dt,
                   NULL refill,
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.flg_type,
                                       dr.id_drug_presc_det,
                                       g_yes,
                                       drd.id_other_product) pharm_desc,
                   NULL pharm_desc_new,
                   NULL pharm_instr_new,
                   format_qty_details(i_lang, i_prof, drs.qty_supply, drd.id_unit_measure_prep) qty,
                   NULL qty_req,
                   NULL qty_to_prep,
                   NULL qty_prep,
                   NULL qty_dev,
                   NULL qty_stock,
                   NULL qty_trash,
                   NULL prof_name_co_sign,
                   NULL type_co_sign,
                   NULL pharm_desc_old,
                   NULL pharm_instr_old,
                   NULL qty_to_prep_old,
                   NULL package_number,
                   NULL dt_expire,
                   NULL dt_expire_supply,
                   NULL notes_justif,
                   NULL has_duplicates,
                   NULL recm,
                   NULL notes_to_physician,
                   NULL notes_to_pharm,
                   '--' notes1,
                   NULL notes_2check,
                   NULL notes_reject,
                   NULL notes_preparation,
                   NULL clinical_info,
                   NULL presc_justification,
                   NULL other_med_justification,
                   NULL bacterio_study_justif,
                   NULL bacterio_study_result,
                   NULL pharm_services,
                   NULL cancel_reason
              FROM drug_req_det drd
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             INNER JOIN drug_req_supply drs
                ON (drd.id_drug_req_det = drs.id_drug_req_det)
             INNER JOIN drug_req_sup_state_transition drsst
                ON (drs.id_drug_req_supply = drsst.id_drug_req_supply)
             INNER JOIN wfl_state s
                ON (drsst.id_state = s.id_state)
             WHERE drd.id_drug_req_det = i_drug_req_det
               AND drsst.id_state IN
                   (SELECT column_value
                      FROM TABLE(get_states_for_req_type(i_prof, NULL, table_varchar(g_drs_delivered2pat_st))))
            
            UNION ALL
            --DOUBLE CHECK
            SELECT pk_translation.get_translation(i_lang, 'PHARMACIST_DETAIL_DOUBLE_CHECK') state_name,
                   pk_medication_core.format_detail_date(i_lang, i_prof, drsst.dt_state) dt_state,
                   pk_prof_utils.get_name_signature(i_lang, i_prof, drsst.id_prof) prof_name,
                   pk_prof_utils.get_spec_signature(i_lang, i_prof, drsst.id_prof, drsst.dt_state, l_epis) spec_name,
                   drsst.dt_state - (((1 / 24) / 60) / 60) dt,
                   NULL refill,
                   
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.flg_type,
                                       dr.id_drug_presc_det,
                                       g_yes,
                                       drd.id_other_product) pharm_desc,
                   NULL pharm_desc_new,
                   NULL pharm_instr_new,
                   NULL qty,
                   NULL qty_req,
                   NULL qty_to_prep,
                   NULL qty_prep,
                   NULL qty_dev,
                   NULL qty_stock,
                   NULL qty_trash,
                   NULL prof_name_co_sign,
                   NULL type_co_sign,
                   NULL pharm_desc_old,
                   NULL pharm_instr_old,
                   NULL qty_to_prep_old,
                   NULL package_number,
                   NULL dt_expire,
                   NULL dt_expire_supply,
                   NULL notes_justif,
                   NULL has_duplicates,
                   NULL recm,
                   format_notes(table_varchar(drsst.notes1), g_no) notes_to_physician,
                   NULL notes_to_pharm,
                   NULL notes1,
                   format_notes(table_varchar(drsst.notes2), g_no) notes_2check,
                   NULL notes_reject,
                   NULL notes_preparation,
                   NULL clinical_info,
                   NULL presc_justification,
                   NULL other_med_justification,
                   NULL bacterio_study_justif,
                   NULL bacterio_study_result,
                   NULL pharm_services,
                   NULL cancel_reason
              FROM drug_req_det drd
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             INNER JOIN drug_req_supply drs
                ON (drd.id_drug_req_det = drs.id_drug_req_det)
             INNER JOIN drug_req_sup_state_transition drsst
                ON (drs.id_drug_req_supply = drsst.id_drug_req_supply)
             INNER JOIN wfl_state s
                ON (drsst.id_state = s.id_state)
             WHERE drd.id_drug_req_det = i_drug_req_det
               AND drsst.id_state = get_state_for_req_type(i_prof, NULL, g_drs_readyfortransp_st)
            UNION ALL
            
            --SUPPLIES RETURNING TO THE PHARMACY (TRANSPORT)
            SELECT pk_translation.get_translation(i_lang, s.code_state) state_name,
                   pk_medication_core.format_detail_date(i_lang, i_prof, drsds.dt_state) dt_state,
                   pk_prof_utils.get_name_signature(i_lang, i_prof, drsds.id_prof) prof_name,
                   pk_prof_utils.get_spec_signature(i_lang, i_prof, drsds.id_prof, drsds.dt_state, l_epis) spec_name,
                   drsds.dt_state dt,
                   NULL refill,
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.flg_type,
                                       dr.id_drug_presc_det,
                                       g_yes,
                                       drd.id_other_product) pharm_desc,
                   NULL pharm_desc_new,
                   NULL pharm_instr_new,
                   NULL qty,
                   NULL qty_req,
                   NULL qty_to_prep,
                   NULL qty_prep,
                   format_qty_details(i_lang, i_prof, drsd.qty_dev, drd.id_unit_measure_prep) qty_dev,
                   NULL qty_stock,
                   NULL qty_trash,
                   NULL prof_name_co_sign,
                   NULL type_co_sign,
                   NULL pharm_desc_old,
                   NULL pharm_instr_old,
                   NULL qty_to_prep_old,
                   NULL package_number,
                   NULL dt_expire,
                   NULL dt_expire_supply,
                   NULL notes_justif,
                   NULL has_duplicates,
                   NULL recm,
                   NULL notes_to_physician,
                   NULL notes_to_pharm,
                   '--' notes1,
                   NULL notes_2check,
                   NULL notes_reject,
                   NULL notes_preparation,
                   NULL clinical_info,
                   NULL presc_justification,
                   NULL other_med_justification,
                   NULL bacterio_study_justif,
                   NULL bacterio_study_result,
                   NULL pharm_services,
                   NULL cancel_reason
              FROM drug_req_det drd
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             INNER JOIN drug_req_supply drs
                ON (drd.id_drug_req_det = drs.id_drug_req_det)
             INNER JOIN drug_req_supply_dev drsd
                ON (drs.id_drug_req_supply = drsd.id_drug_req_supply)
             INNER JOIN drug_req_sup_dev_state_trans drsds
                ON (drsd.id_drug_req_supply_dev = drsds.id_drug_req_supply_dev)
             INNER JOIN wfl_state s
                ON (drsds.id_state = s.id_state)
             WHERE drd.id_drug_req_det = i_drug_req_det
               AND drsds.id_state IN
                   (SELECT column_value
                      FROM TABLE(get_states_for_req_type(i_prof,
                                                         NULL,
                                                         table_varchar(g_drs_returning_st, g_drs_returned_st))))
            UNION ALL
            
            --SUPPLIES RETURNING TO THE PHARMACY
            SELECT pk_translation.get_translation(i_lang, s.code_state) state_name,
                   pk_medication_core.format_detail_date(i_lang, i_prof, drsds.dt_state) dt_state,
                   pk_prof_utils.get_name_signature(i_lang, i_prof, drsds.id_prof) prof_name,
                   pk_prof_utils.get_spec_signature(i_lang, i_prof, drsds.id_prof, drsds.dt_state, l_epis) spec_name,
                   drsds.dt_state dt,
                   NULL refill,
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.flg_type,
                                       dr.id_drug_presc_det,
                                       g_yes,
                                       drd.id_other_product) pharm_desc,
                   NULL pharm_desc_new,
                   NULL pharm_instr_new,
                   NULL qty,
                   NULL qty_req,
                   NULL qty_to_prep,
                   NULL qty_prep,
                   format_qty_details(i_lang, i_prof, drsd.qty_dev, drd.id_unit_measure_prep) qty_dev,
                   NULL qty_stock,
                   NULL qty_trash,
                   NULL prof_name_co_sign,
                   NULL type_co_sign,
                   NULL pharm_desc_old,
                   NULL pharm_instr_old,
                   NULL qty_to_prep_old,
                   drsd.package_number package_number,
                   NULL dt_expire,
                   pk_date_utils.date_chr_short_read(i_lang, drsd.dt_package_expire, i_prof) dt_expire_supply,
                   drsd.notes_dev_justif notes_justif,
                   NULL has_duplicates,
                   NULL recm,
                   NULL notes_to_physician,
                   NULL notes_to_pharm,
                   format_notes(table_varchar(drsds.notes1), g_no) notes1,
                   NULL notes_2check,
                   NULL notes_reject,
                   NULL notes_preparation,
                   NULL clinical_info,
                   NULL presc_justification,
                   NULL other_med_justification,
                   NULL bacterio_study_justif,
                   NULL bacterio_study_result,
                   NULL pharm_services,
                   NULL cancel_reason
              FROM drug_req_det drd
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             INNER JOIN drug_req_supply drs
                ON (drd.id_drug_req_det = drs.id_drug_req_det)
             INNER JOIN drug_req_supply_dev drsd
                ON (drs.id_drug_req_supply = drsd.id_drug_req_supply)
             INNER JOIN drug_req_sup_dev_state_trans drsds
                ON (drsd.id_drug_req_supply_dev = drsds.id_drug_req_supply_dev)
             INNER JOIN wfl_state s
                ON (drsds.id_state = s.id_state)
             WHERE drd.id_drug_req_det = i_drug_req_det
               AND drsds.id_state = get_state_for_req_type(i_prof, NULL, g_drs_to_return_st)
            UNION ALL
            
            --SUPPLIES RETURNING TO THE PHARMACY
            SELECT pk_translation.get_translation(i_lang, s.code_state) state_name,
                   pk_medication_core.format_detail_date(i_lang, i_prof, drsds.dt_state) dt_state,
                   pk_prof_utils.get_name_signature(i_lang, i_prof, drsds.id_prof) prof_name,
                   pk_prof_utils.get_spec_signature(i_lang, i_prof, drsds.id_prof, drsds.dt_state, l_epis) spec_name,
                   drsds.dt_state dt,
                   NULL refill,
                   
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.flg_type,
                                       dr.id_drug_presc_det,
                                       g_yes,
                                       drd.id_other_product) pharm_desc,
                   NULL pharm_desc_new,
                   NULL pharm_instr_new,
                   NULL qty,
                   format_qty_details(i_lang, i_prof, drd.qty_req, drd.id_unit_measure) qty_req,
                   NULL qty_to_prep,
                   NULL qty_prep,
                   format_qty_details(i_lang, i_prof, drsd.qty_dev, drd.id_unit_measure_prep) qty_dev,
                   format_qty_details(i_lang, i_prof, drsd.qty_for_stock, drd.id_unit_measure_prep) qty_stock,
                   format_qty_details(i_lang, i_prof, drsd.qty_for_trash, drd.id_unit_measure_prep) qty_trash,
                   NULL prof_name_co_sign,
                   NULL type_co_sign,
                   NULL pharm_desc_old,
                   NULL pharm_instr_old,
                   NULL qty_to_prep_old,
                   drsd.package_number package_number,
                   NULL dt_expire,
                   pk_date_utils.date_chr_short_read(i_lang, drsd.dt_package_expire, i_prof) dt_expire_supply,
                   NULL notes_justif,
                   NULL has_duplicates,
                   NULL recm,
                   NULL notes_to_physician,
                   NULL notes_to_pharm,
                   format_notes(table_varchar(drsds.notes1), g_no) notes1,
                   NULL notes_2check,
                   NULL notes_reject,
                   NULL notes_preparation,
                   NULL clinical_info,
                   NULL presc_justification,
                   NULL other_med_justification,
                   NULL bacterio_study_justif,
                   NULL bacterio_study_result,
                   NULL pharm_services,
                   NULL cancel_reason
              FROM drug_req_det drd
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             INNER JOIN drug_req_supply drs
                ON (drd.id_drug_req_det = drs.id_drug_req_det)
             INNER JOIN drug_req_supply_dev drsd
                ON (drs.id_drug_req_supply = drsd.id_drug_req_supply)
             INNER JOIN drug_req_sup_dev_state_trans drsds
                ON (drsd.id_drug_req_supply_dev = drsds.id_drug_req_supply_dev)
             INNER JOIN wfl_state s
                ON (drsds.id_state = s.id_state)
             WHERE drd.id_drug_req_det = i_drug_req_det
               AND drsds.id_state = get_state_for_req_type(i_prof, NULL, g_drs_return_end_st)
            
            UNION ALL
            --AVAILABLE TO TRANSPORT
            SELECT pk_translation.get_translation(i_lang, s.code_state) state_name,
                   pk_medication_core.format_detail_date(i_lang, i_prof, drsst.dt_state) dt_state,
                   pk_prof_utils.get_name_signature(i_lang, i_prof, drsst.id_prof) prof_name,
                   pk_prof_utils.get_spec_signature(i_lang, i_prof, drsst.id_prof, drsst.dt_state, l_epis) spec_name,
                   drsst.dt_state dt,
                   NULL refill,
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.flg_type,
                                       dr.id_drug_presc_det,
                                       g_yes,
                                       drd.id_other_product) pharm_desc,
                   NULL pharm_desc_new,
                   NULL pharm_instr_new,
                   format_qty_details(i_lang, i_prof, drs.qty_supply, drd.id_unit_measure_prep) qty,
                   NULL qty_req,
                   NULL qty_to_prep,
                   NULL qty_prep,
                   NULL qty_dev,
                   NULL qty_stock,
                   NULL qty_trash,
                   NULL prof_name_co_sign,
                   NULL type_co_sign,
                   NULL pharm_desc_old,
                   NULL pharm_instr_old,
                   NULL qty_to_prep_old,
                   NULL package_number,
                   NULL dt_expire,
                   NULL dt_expire_supply,
                   NULL notes_justif,
                   NULL has_duplicates,
                   NULL recm,
                   NULL notes_to_physician,
                   NULL notes_to_pharm,
                   NULL notes1,
                   NULL notes_2check,
                   NULL notes_reject,
                   NULL notes_preparation,
                   NULL clinical_info,
                   NULL presc_justification,
                   NULL other_med_justification,
                   NULL bacterio_study_justif,
                   NULL bacterio_study_result,
                   NULL pharm_services,
                   NULL cancel_reason
              FROM drug_req_det drd
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             INNER JOIN drug_req_supply drs
                ON (drd.id_drug_req_det = drs.id_drug_req_det)
             INNER JOIN drug_req_sup_state_transition drsst
                ON (drs.id_drug_req_supply = drsst.id_drug_req_supply)
             INNER JOIN wfl_state s
                ON (drsst.id_state = s.id_state)
             WHERE drd.id_drug_req_det = i_drug_req_det
               AND drsst.id_state = get_state_for_req_type(i_prof, NULL, g_drs_uni_ready4transp_st)
               AND dr.flg_type = g_flg_unidose
            
             ORDER BY dt DESC;
    
        --medication justification
        OPEN o_warnings_details FOR
            SELECT dpj.id_drug_presc_just,
                   dpj.clinical_info,
                   dpj.presc_justification,
                   dpj.flg_oth_med_same_purpose,
                   dpj.other_med_justification,
                   dpj.flg_bacteriological_study,
                   dpj.bacterio_study_justif,
                   dpj.bacterio_study_result,
                   dpj.pharmacist_notes
              FROM drug_presc_justification dpj
             WHERE dpj.id_drug_req_det = i_drug_req_det;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_req_details', o_error);
            pk_types.open_my_cursor(o_req_header);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_headers_details);
            pk_types.open_my_cursor(o_req_details);
            pk_types.open_my_cursor(o_warnings_details);
            RETURN FALSE;
    END get_req_details;

    /********************************************************************************************
    * alert.pk_pharmacy.get_car_details
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_CAR                        IN    NUMBER(24)
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  O_CAR_HEADER                    OUT   REF CURSOR
    * @param  O_CAR_DETAILS                   OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_HEADERS_DETAILS               OUT   REF CURSOR
    * @param  O_CAR_LIST_PAT                  OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Pedro Martins Santos
    * @version  2.5.0.7.7.3
    * @since  20/05/2010
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_car_details
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN alert.profissional,
        i_id_car          IN pharm_unidose_car.id_unidose_car%TYPE,
        i_get_headers     IN VARCHAR2 DEFAULT 'N',
        i_header_codes    IN table_varchar DEFAULT NULL,
        o_car_header      OUT pk_types.cursor_type,
        o_car_details     OUT pk_types.cursor_type,
        o_headers         OUT pk_types.cursor_type,
        o_headers_details OUT pk_types.cursor_type,
        o_car_list_pat    OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
        l_header_codes table_varchar;
    BEGIN
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error        := 'GET HEADERS FOR DETAILS';
        l_header_codes := table_varchar('PHARMACIST_DETAIL_UNI_CAR_NAME_DT',
                                        'PHARMACIST_DETAIL_UNI_CAR_DEPT',
                                        'PHARMACIST_DETAIL_UNI_CAR_SERV',
                                        'PHARMACIST_DETAIL_UNI_CAR_SLOT_COUNT',
                                        'PHARMACIST_DETAIL_UNI_CAR_LOTATION',
                                        'PHARMACIST_DETAIL_UNI_CAR_LOCATION',
                                        'PHARMACIST_DETAIL_UNI_CAR_STATE_NAME',
                                        'PHARMACIST_DETAIL_UNI_CAR_PAT_LIST',
                                        'PHARMACIST_DETAIL_UNI_CAR_PAT_NAME',
                                        'PHARMACIST_DETAIL_UNI_CAR_PAT_BED',
                                        'PHARMACIST_DETAIL_UNI_CAR_PAT_SLOT'
                                        
                                        );
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, l_header_codes, o_headers_details);
    
        --unidose car
        OPEN o_car_header FOR
            SELECT ucm.car_model_name || ' (' || pk_date_utils.dt_chr(i_lang, uc.dt_car_begin, i_prof) ||
                   decode(uc.dt_car_end,
                          NULL,
                          '',
                          ' ' || pk_message.get_message(i_lang, 'PHARMACIST_UNIDOSE_CAR_DATE_INTERVAL') || ' ' ||
                          pk_date_utils.dt_chr(i_lang, uc.dt_car_end, i_prof)) || ')' uni_car_name_dt,
                   pk_translation.get_translation(i_lang, d.code_department) uni_car_dept,
                   pk_translation.get_translation(i_lang, cs.code_clinical_service) uni_car_serv,
                   ucm.number_of_slots uni_car_slot_count,
                   get_unidose_car_occupation(i_lang, i_id_car) uni_car_lotation,
                   get_unidose_car_location(i_lang,
                                            i_prof,
                                            s.id_state,
                                            pk_translation.get_translation(i_lang, d.code_department)) uni_car_location,
                   pk_translation.get_translation(i_lang, s.code_state) uni_car_state_name
              FROM pharm_unidose_car uc
              JOIN pharm_unidose_car_model ucm
                ON (uc.id_car_model = ucm.id_unidose_car_model)
              JOIN dep_clin_serv dcs
                ON (ucm.id_dep_clin_serv = dcs.id_dep_clin_serv)
              JOIN clinical_service cs
                ON (dcs.id_clinical_service = cs.id_clinical_service)
              JOIN department d
                ON (dcs.id_department = d.id_department)
              JOIN wfl_state s
                ON (s.id_state = uc.id_state)
             WHERE uc.id_unidose_car = i_id_car;
    
        --returns list of patients allocated to this unitdose car
        OPEN o_car_list_pat FOR
            SELECT DISTINCT get_pat_name(i_lang, i_prof, dr.id_patient) uni_car_pat_name,
                            get_pat_clin_record(i_lang, dr.id_patient, i_prof.institution) uni_car_pat_proc,
                            nvl(get_pat_location(i_lang, i_prof, dr.id_episode, dr.id_patient, 'TEXT', 'BED'), '--') uni_car_pat_bed,
                            get_unidose_pat_slots(i_id_car, dr.id_patient) uni_car_pat_slot
              FROM TABLE(get_orders_for_car(i_id_car)) oc
             INNER JOIN drug_req_det drd
                ON (oc.id_drug_req_det = drd.id_drug_req_det)
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req);
    
        --details for History section (updated - UNION ALL removed, added 2 more states)
        OPEN o_car_details FOR
            SELECT pk_translation.get_translation(i_lang, s.code_state) uni_car_action,
                   pk_medication_core.format_detail_date(i_lang, i_prof, st.dt_state) uni_car_action_dt,
                   pk_prof_utils.get_name_signature(i_lang, i_prof, st.id_prof) uni_car_action_prof,
                   pk_prof_utils.get_spec_signature(i_lang, i_prof, st.id_prof, st.dt_state, NULL) uni_car_action_spec
              FROM pharm_unidose_car uc
             INNER JOIN pharm_unidose_car_state_trans st
                ON (uc.id_unidose_car = st.id_unidose_car)
             INNER JOIN wfl_state s
                ON (st.id_state = s.id_state)
             WHERE uc.id_unidose_car = i_id_car
               AND s.id_state IN
                   (SELECT column_value
                      FROM TABLE(alert.pk_pharmacy.get_states_for_req_type(i_prof,
                                                                           NULL,
                                                                           table_varchar(g_uni_car_delivered_dev_st,
                                                                                         g_uni_car_in_transit_dev_st,
                                                                                         g_uni_car_delivered_st,
                                                                                         g_uni_car_in_transit_st,
                                                                                         g_uni_car_end_st,
                                                                                         g_uni_car_ready4transp_dev_st,
                                                                                         g_uni_car_ready4transp_st))))
             ORDER BY st.dt_state DESC;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_car_details', o_error);
            pk_types.open_my_cursor(o_car_header);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_headers_details);
            pk_types.open_my_cursor(o_car_details);
            pk_types.open_my_cursor(o_car_list_pat);
            RETURN FALSE;
    END get_car_details;

    /********************************************************************************************
        * Create new drug supply
        *
        * @param      I_LANG               Preferred language ID for this professional
        * @param      I_EPISODE            Episode's ID
        * @param      I_DRUG_REQ_DET       Request's detail ID
        * @param      I_QTY_REQ            Quantity requested
        * @param      I_QTY_SUPPLY         Quantity supplied
        * @param      I_PROF               Object (professional ID, institution ID, software ID)
        * @param      I_PROF_CAT_TYPE      Professional's category type
        * @param      O_ID_DRUG_REQ_SUPPLY Supply ID created
        * @param      O_ERROR              error
        *
        * @return                         true or false on success or error
        *
        * @author                         SS
        * @version                        0.1
        * @since                          2007/05/19
    *********************************************************************************************/
    PROCEDURE create_drug_supply_db
    (
        i_lang               IN language.id_language%TYPE,
        i_drug_req_det       IN drug_req_supply.id_drug_req_det%TYPE,
        i_qty_sup            IN drug_req_supply.qty_supply%TYPE,
        i_prof               IN alert.profissional,
        o_id_drug_req_supply OUT drug_req_supply.id_drug_req_supply%TYPE,
        o_error              OUT t_error_out
    ) IS
        l_episode       episode.id_episode%TYPE;
        l_prof_cat_type category.flg_type%TYPE;
        l_timestamp     TIMESTAMP WITH LOCAL TIME ZONE;
        l_next          drug_req_supply.id_drug_req_supply%TYPE;
    BEGIN
        l_timestamp := current_timestamp;
    
        /*--prof category type
        select c.flg_type
        into l_prof_cat_type
        from prof_cat p, category c
        where p.id_category = c.id_category
          and p.id_professional = i_prof.id
          and rownum = 1;
        
        --req episode
        select dr.id_episode
        into l_episode
        from drug_req_det drd, drug_req dr
        where drd.id_drug_req = dr.id_drug_req
          and drd.id_drug_req_det = i_drug_req_det;
        
        g_error := 'GET SEQ_DRUG_REQ_SUPPLY.NEXTVAL';
        select seq_drug_req_supply.nextval
        into l_next
        from dual;
        
            g_error := 'INSERT DRUG_REQ_SUPPLY';
        insert into drug_req_supply
          (id_drug_req_supply, dt_begin_supply_tstz, id_prof_begin_supply, id_drug_req_det, qty_supply, id_state)
        values
          (l_next, l_timestamp, i_prof.id, i_drug_req_det, i_qty_sup, g_drs_preparing_st);
        
            o_id_drug_req_supply := l_next;
        
            --actualiza dados das observacoes
            g_error := 'CALL TO pk_visit.set_first_obs';
            if not pk_visit.set_first_obs(i_lang                => i_lang,
                                          i_id_episode          => l_episode,
                                          i_pat                 => null,
                                          i_prof                => i_prof,
                                          i_prof_cat_type       => l_prof_cat_type,
                                          i_dt_last_interaction => l_timestamp,
                                          i_dt_first_obs        => l_timestamp,
                                          o_error               => o_error)
            then
          raise_application_error(-20001, o_error.ora_sqlerrm);
            end if;
        
            g_error := 'CALL TO PK_PRESCRIPTION_INT.UPDATE_DRUG_REQ_TASK';
            if not pk_prescription_int.update_drug_req_task(i_lang          => i_lang,
                                                            i_episode       => l_episode,
                                                            i_prof          => i_prof,
                                                            i_prof_cat_type => l_prof_cat_type,
                                                            o_error         => o_error)
            then
          raise_application_error(-20001, o_error.ora_sqlerrm);
            end if;*/
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END create_drug_supply_db;

    FUNCTION create_drug_supply
    (
        i_lang               IN language.id_language%TYPE,
        i_drug_req_det       IN drug_req_supply.id_drug_req_det%TYPE,
        i_qty_sup            IN drug_req_supply.qty_supply%TYPE,
        i_prof               IN alert.profissional,
        o_id_drug_req_supply OUT drug_req_supply.id_drug_req_supply%TYPE,
        o_error              OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
    
        create_drug_supply_db(i_lang               => i_lang,
                              i_drug_req_det       => i_drug_req_det,
                              i_qty_sup            => i_qty_sup,
                              i_prof               => i_prof,
                              o_id_drug_req_supply => o_id_drug_req_supply,
                              o_error              => o_error);
    
        COMMIT;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'CREATE_DRUG_SUPPLY', o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END create_drug_supply;

    PROCEDURE cancel_req_db
    (
        i_lang          IN language.id_language%TYPE,
        i_prof          IN profissional,
        i_prof_cat_type IN category.flg_type%TYPE,
        i_drug_req_det  IN drug_req_det.id_drug_req_det%TYPE,
        i_notes_cancel  IN drug_req_det.notes_cancel%TYPE,
        o_error         OUT t_error_out
    ) IS
        l_current_req_state       wfl_state.id_state%TYPE;
        l_next_req_state          wfl_state.id_state%TYPE;
        l_state_transition_ok     BOOLEAN := FALSE;
        l_state_transition_drs_ok BOOLEAN := FALSE;
        l_episode                 drug_req.id_episode%TYPE;
        l_timestamp               TIMESTAMP WITH LOCAL TIME ZONE;
        l_count_req               NUMBER(1) := 0;
        l_drug_req_id             drug_req.id_drug_req%TYPE;
        l_req_type                drug_req.flg_type%TYPE;
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'cancel_req_db';
        l_update_epis BOOLEAN := FALSE;
        l_allocation  t_rec_pharm_drd_allocation := t_rec_pharm_drd_allocation(NULL, NULL, NULL, NULL);
        l_car_state   pharm_unidose_car.id_state%TYPE;
        --  [ALERT-163260]
        --  validating state transition for all drug_req_supplies under a certain id_drug_req_det 
        FUNCTION validate_drs_trans RETURN BOOLEAN IS
            l_next_state    wfl_state_relate.next_state%TYPE;
            l_transition_ok BOOLEAN;
        BEGIN
            l_next_state := get_state_for_req_type(i_prof, NULL, g_drs_canceled_st);
        
            FOR rec_drs IN (SELECT drs.id_state
                              FROM drug_req_supply drs
                             WHERE drs.id_drug_req_det = i_drug_req_det
                               AND drs.id_state != l_next_state)
            LOOP
                l_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                           i_prof,
                                                                           rec_drs.id_state,
                                                                           l_next_state);
                IF NOT l_transition_ok
                THEN
                    RETURN FALSE;
                END IF;
            END LOOP;
        
            RETURN TRUE;
        
        EXCEPTION
            WHEN OTHERS THEN
                RAISE;
        END validate_drs_trans;
        --
        FUNCTION exist_supplies(i2_drug_req_det IN drug_req_det.id_drug_req_det%TYPE) RETURN BOOLEAN IS
            l2_count_drs NUMBER(1) := 0;
        BEGIN
            SELECT COUNT(1)
              INTO l2_count_drs
              FROM drug_req_supply drs
             WHERE drs.id_drug_req_det = i2_drug_req_det
               AND rownum = 1;
        
            set_pharmacy_log(l_db_object_name, '(exist_supplies) l2_count_drs=' || l2_count_drs);
        
            RETURN(l2_count_drs = 1);
        
        EXCEPTION
            WHEN OTHERS THEN
                RAISE;
        END exist_supplies;
        --
        PROCEDURE delete_supplies(i_drug_req_det IN drug_req_supply.id_drug_req_det%TYPE) IS
        BEGIN
            set_pharmacy_log(l_db_object_name, 'delete_supplies: ###i_drug_req_det:' || i_drug_req_det);
        
            DELETE FROM drug_req_sup_state_transition drsst
             WHERE drsst.id_drug_req_supply IN
                   (SELECT drs.id_drug_req_supply
                      FROM drug_req_supply drs
                     WHERE drs.id_state = pk_pharmacy.get_state_for_req_type(i_prof, NULL, g_drs_preparing_st)
                       AND drs.id_drug_req_det = i_drug_req_det);
        
            DELETE FROM drug_req_supply drs1
             WHERE drs1.id_drug_req_supply IN
                   (SELECT drs.id_drug_req_supply
                      FROM drug_req_supply drs
                     WHERE drs.id_state = pk_pharmacy.get_state_for_req_type(i_prof, NULL, g_drs_preparing_st)
                       AND drs.id_drug_req_det = i_drug_req_det);
        
            --
            INSERT INTO drug_req_sup_state_transition
                (id_drug_req_supply, id_state, id_prof, dt_state)
                SELECT drs.id_drug_req_supply,
                       pk_pharmacy.get_state_for_req_type(i_prof, NULL, g_drs_canceled_st),
                       i_prof.id,
                       l_timestamp
                  FROM drug_req_supply drs
                 WHERE drs.id_state IN
                       (SELECT column_value
                          FROM TABLE(pk_pharmacy.get_states_for_req_type(i_prof,
                                                                         NULL,
                                                                         table_varchar(g_drs_readyforvalid_st,
                                                                                       g_drs_readyfortransp_st))))
                   AND drs.id_drug_req_det = i_drug_req_det;
        
            UPDATE drug_req_supply drs2
               SET drs2.id_state = pk_pharmacy.get_state_for_req_type(i_prof, NULL, g_drs_canceled_st)
             WHERE drs2.id_drug_req_supply IN (SELECT drs.id_drug_req_supply
                                                 FROM drug_req_supply drs
                                                WHERE drs.id_state IN
                                                      (SELECT column_value
                                                         FROM TABLE(pk_pharmacy.get_states_for_req_type(i_prof,
                                                                                                        NULL,
                                                                                                        table_varchar(g_drs_readyforvalid_st,
                                                                                                                      g_drs_readyfortransp_st))))
                                                  AND drs.id_drug_req_det = i_drug_req_det);
            --
        
        EXCEPTION
            WHEN OTHERS THEN
                RAISE;
        END delete_supplies;
        --
    BEGIN
        l_timestamp := current_timestamp;
    
        g_error := 'get current_req_state, episode_id, drug_req_id';
        set_pharmacy_log(l_db_object_name, g_error);
        BEGIN
            SELECT drd.id_state, dr.id_episode, dr.id_drug_req, dr.flg_type
              INTO l_current_req_state, l_episode, l_drug_req_id, l_req_type
              FROM drug_req_det drd, drug_req dr
             WHERE drd.id_drug_req_det = i_drug_req_det
               AND drd.id_drug_req = dr.id_drug_req;
        EXCEPTION
            WHEN OTHERS THEN
                l_drug_req_id := NULL;
        END;
    
        set_pharmacy_log(l_db_object_name, 'l_req_type=' || l_req_type);
    
        l_allocation := get_unidose_order_allocation(i_lang, i_drug_req_det);
    
        IF (l_allocation.id_unidose_car IS NOT NULL)
        THEN
            SELECT puc.id_state
              INTO l_car_state
              FROM pharm_unidose_car puc
             WHERE puc.id_unidose_car = l_allocation.id_unidose_car;
        END IF;
    
        IF ((l_allocation.id_unidose_car IS NULL) OR
           (in_table(l_car_state,
                      get_states_for_req_type(i_prof, NULL, table_varchar(g_uni_car_executing_st, g_uni_car_parked_st)))))
        THEN
        
            IF (l_req_type IN (g_flg_unidose, g_flg_adm))
            THEN
            
                --[MEDICATION_RULE] if no supplies then cancel order
                l_next_req_state := get_state_for_req_type(i_prof, l_req_type, g_drd_canceled_st);
            
                l_state_transition_ok     := pk_medication_workflow.is_state_related(i_lang,
                                                                                     i_prof,
                                                                                     l_current_req_state,
                                                                                     l_next_req_state);
                l_state_transition_drs_ok := validate_drs_trans();
            
                set_pharmacy_log(l_db_object_name,
                                 'l_current_req_state=' || l_current_req_state || ' l_next_req_state=' ||
                                 l_next_req_state || ' l_state_transition_ok=' ||
                                 sys.diutil.bool_to_int(l_state_transition_ok) || ' l_state_transition_drs_ok=' ||
                                 sys.diutil.bool_to_int(l_state_transition_drs_ok));
            
                IF (l_state_transition_ok AND l_state_transition_drs_ok)
                THEN
                    --  [ALERT-163260] we must ensure that not only drug_req_det state transitions are allowed but also supplies 
                    --  if ready for transportation, they shall continue like that, so no cancelation shall occur
                    IF (exist_supplies(i_drug_req_det))
                    THEN
                    
                        set_pharmacy_log(l_db_object_name, 'DELETE 1');
                        delete_supplies(i_drug_req_det);
                    
                    END IF;
                
                    UPDATE drug_req_det drd
                       SET drd.id_state            = l_next_req_state,
                           drd.dt_last_change      = l_timestamp,
                           drd.id_prof_last_change = i_prof.id,
                           drd.id_sw_last_change   = i_prof.software,
                           drd.id_inst_last_change = i_prof.institution,
                           drd.flg_status          = 'C'
                     WHERE drd.id_drug_req_det = i_drug_req_det;
                
                    remove_drd_from_unidose_car(i_lang, i_prof, i_drug_req_det);
                
                    --state history
                    INSERT INTO drug_req_det_state_transition
                        (id_drug_req_det, id_state, id_prof, dt_state, notes1)
                    VALUES
                        (i_drug_req_det, l_next_req_state, i_prof.id, l_timestamp, i_notes_cancel);
                
                    l_update_epis := TRUE;
                ELSE
                    RAISE g_ex_cannot_be_canceled_drs;
                END IF;
            
            ELSIF (l_drug_req_id IS NOT NULL AND l_req_type = g_flg_int)
            THEN
            
                IF (l_current_req_state = get_state_for_req_type(i_prof, l_req_type, g_drd_temporary_st))
                THEN
                    -- TEMP (receita temp. -- pode ser eliminada)
                
                    g_error := 'DRD - CANCEL';
                    set_pharmacy_log(l_db_object_name, g_error);
                
                    --eliminar os warnings relacionados com esta receita temporaria
                    DELETE FROM presc_attention_det pad
                     WHERE pad.id_drug_req_det = i_drug_req_det;
                
                    DELETE FROM presc_pat_problem_hist ppph
                     WHERE ppph.id_drug_req_det = i_drug_req_det;
                
                    DELETE FROM presc_pat_problem ppp
                     WHERE ppp.id_drug_req_det = i_drug_req_det;
                
                    DELETE FROM presc_interactions_hist pih
                     WHERE pih.id_drug_req_det_source = i_drug_req_det
                        OR pih.id_drug_req_det_dest = i_drug_req_det;
                
                    DELETE FROM presc_interactions pi
                     WHERE pi.id_drug_req_det_source = i_drug_req_det
                        OR pi.id_drug_req_det_dest = i_drug_req_det;
                
                    DELETE FROM drug_req_det_state_transition a
                     WHERE a.id_drug_req_det = i_drug_req_det;
                
                    DELETE FROM drug_req_det drd
                     WHERE drd.id_drug_req_det = i_drug_req_det;
                
                    SELECT COUNT(*)
                      INTO l_count_req
                      FROM drug_req_det drd
                     WHERE drd.id_drug_req = l_drug_req_id
                       AND rownum = 1;
                
                    IF (l_count_req = 0)
                    THEN
                        g_error := 'DR - CANCEL';
                        set_pharmacy_log(l_db_object_name, g_error);
                        DELETE FROM drug_req dr
                         WHERE dr.id_drug_req = l_drug_req_id;
                    END IF;
                
                    l_update_epis := TRUE;
                
                ELSE
                
                    --[MEDICATION_RULE] if no supplies then cancel order
                    l_next_req_state := get_state_for_req_type(i_prof, l_req_type, g_drd_canceled_st);
                
                    l_state_transition_ok     := pk_medication_workflow.is_state_related(i_lang,
                                                                                         i_prof,
                                                                                         l_current_req_state,
                                                                                         l_next_req_state);
                    l_state_transition_drs_ok := validate_drs_trans();
                
                    set_pharmacy_log(l_db_object_name,
                                     'l_current_req_state=' || l_current_req_state || ' l_next_req_state=' ||
                                     l_next_req_state || ' l_state_transition_ok=' ||
                                     sys.diutil.bool_to_int(l_state_transition_ok) || ' l_state_transition_drs_ok=' ||
                                     sys.diutil.bool_to_int(l_state_transition_drs_ok));
                
                    IF (l_state_transition_ok AND l_state_transition_drs_ok)
                    THEN
                    
                        IF (exist_supplies(i_drug_req_det))
                        THEN
                        
                            set_pharmacy_log(l_db_object_name, 'DELETE 2');
                            delete_supplies(i_drug_req_det);
                        
                        END IF;
                    
                        UPDATE drug_req_det drd
                           SET drd.id_state            = l_next_req_state,
                               drd.dt_last_change      = l_timestamp,
                               drd.id_prof_last_change = i_prof.id,
                               drd.id_sw_last_change   = i_prof.software,
                               drd.id_inst_last_change = i_prof.institution,
                               drd.flg_status          = 'C'
                         WHERE drd.id_drug_req_det = i_drug_req_det;
                    
                        --state history
                        INSERT INTO drug_req_det_state_transition
                            (id_drug_req_det, id_state, id_prof, dt_state, notes1)
                        VALUES
                            (i_drug_req_det, l_next_req_state, i_prof.id, l_timestamp, i_notes_cancel);
                    
                        l_update_epis := TRUE;
                    ELSE
                        RAISE g_ex_cannot_be_canceled_drs;
                    END IF;
                
                END IF;
            
            END IF;
        
            IF (l_update_epis)
            THEN
                g_error := 'L_UPDATE_EPIS';
                set_pharmacy_log(l_db_object_name, g_error);
                -- ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** -
                IF NOT pk_visit.set_first_obs(i_lang                => i_lang,
                                              i_id_episode          => l_episode,
                                              i_pat                 => NULL,
                                              i_prof                => i_prof,
                                              i_prof_cat_type       => i_prof_cat_type,
                                              i_dt_last_interaction => l_timestamp,
                                              i_dt_first_obs        => l_timestamp,
                                              o_error               => o_error)
                THEN
                    raise_application_error(-20001, o_error.ora_sqlerrm);
                END IF;
            
                IF NOT pk_prescription_int.update_drug_req_task(i_lang          => i_lang,
                                                                i_episode       => l_episode,
                                                                i_prof          => i_prof,
                                                                i_prof_cat_type => i_prof_cat_type,
                                                                o_error         => o_error)
                THEN
                    raise_application_error(-20001, o_error.ora_sqlerrm);
                END IF;
            
                IF NOT pk_grid.delete_epis_grid_task(i_lang => i_lang, i_episode => l_episode, o_error => o_error)
                THEN
                    raise_application_error(-20001, o_error.ora_sqlerrm);
                END IF;
                -- ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** - ***** -
            END IF;
        
        ELSE
            RAISE g_ex_cannot_be_canceled_drs;
        END IF;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'CANCEL_REQ_DB', o_error);
            RAISE;
    END cancel_req_db;

    PROCEDURE cancel_req_db
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN profissional,
        i_drug_presc_det IN drug_presc_det.id_drug_presc_det%TYPE,
        i_notes_cancel   IN drug_req_det.notes_cancel%TYPE,
        o_error          OUT t_error_out,
        i_drug_req       IN drug_req.id_drug_req%TYPE DEFAULT NULL
    ) IS
        l_drds          table_number;
        l_prof_cat_type category.flg_type%TYPE;
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'cancel_req_db';
    BEGIN
        g_error         := 'GET PROF TYPE';
        l_prof_cat_type := get_prof_type(i_prof);
    
        --[MEDICATION_RULE] get all orders for the prescription
        IF (i_drug_presc_det IS NOT NULL)
        THEN
            SELECT drd.id_drug_req_det
              BULK COLLECT
              INTO l_drds
              FROM drug_req_det drd, drug_req dr
             WHERE drd.id_drug_req = dr.id_drug_req
               AND dr.id_drug_presc_det = i_drug_presc_det
               AND drd.id_state IN
                   (SELECT column_value
                      FROM TABLE(get_states_for_req_type(i_prof,
                                                         dr.flg_type,
                                                         table_varchar(g_drd_requested_st,
                                                                       g_drd_validated_st,
                                                                       g_drd_executing_st))));
        ELSE
            SELECT drd.id_drug_req_det
              BULK COLLECT
              INTO l_drds
              FROM drug_req_det drd, drug_req dr
             WHERE drd.id_drug_req = dr.id_drug_req
               AND dr.id_drug_req = i_drug_req
               AND drd.id_state IN
                   (SELECT column_value
                      FROM TABLE(get_states_for_req_type(i_prof,
                                                         dr.flg_type,
                                                         table_varchar(g_drd_requested_st,
                                                                       g_drd_validated_st,
                                                                       g_drd_executing_st))));
        END IF;
    
        FOR l_row IN 1 .. l_drds.count
        LOOP
            set_pharmacy_log(l_db_object_name, 'id_drug_req_det=' || l_drds(l_row));
        
            cancel_req_db(i_lang          => i_lang,
                          i_prof          => i_prof,
                          i_prof_cat_type => l_prof_cat_type,
                          i_drug_req_det  => l_drds(l_row),
                          i_notes_cancel  => i_notes_cancel,
                          o_error         => o_error);
        END LOOP;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, o_error);
            RAISE;
    END cancel_req_db;

    FUNCTION cancel_req
    (
        i_lang          IN language.id_language%TYPE,
        i_prof          IN profissional,
        i_prof_cat_type IN category.flg_type%TYPE,
        i_drug_req_det  IN drug_req_det.id_drug_req_det%TYPE,
        i_notes_cancel  IN drug_req_det.notes_cancel%TYPE,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
    
        cancel_req_db(i_lang          => i_lang,
                      i_prof          => i_prof,
                      i_prof_cat_type => i_prof_cat_type,
                      i_drug_req_det  => i_drug_req_det,
                      i_notes_cancel  => i_notes_cancel,
                      o_error         => o_error);
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'CANCEL_REQ', o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END cancel_req;

    /********************************************************************************************
    * alert.pk_pharmacy.get_pat_cancel_pend
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_DRUG_REQ_DET                  IN    NUMBER(24)
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  I_GET_MOTIVES                   IN    VARCHAR2
    * @param  O_DRUG                          OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_HEADERS_DETAILS               OUT   REF CURSOR
    * @param  O_MOTIVES                       OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-02
    *
    ********************************************************************************************/
    FUNCTION get_pat_cancel_pend
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN profissional,
        i_drug_req_det    IN drug_req_det.id_drug_req_det%TYPE,
        i_get_headers     IN VARCHAR2 DEFAULT 'N',
        i_header_codes    IN table_varchar DEFAULT NULL,
        i_get_motives     IN VARCHAR2 DEFAULT 'N',
        o_drug            OUT pk_types.cursor_type,
        o_headers         OUT pk_types.cursor_type,
        o_headers_details OUT pk_types.cursor_type,
        o_motives         OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
        l_header_codes table_varchar;
        l_prof_type    profile_template.flg_type%TYPE;
        l_ret_value    BOOLEAN;
        ex_cancel_reasons EXCEPTION;
    BEGIN
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error        := 'GET HEADERS FOR DETAILS';
        l_header_codes := table_varchar --label list for all kind of details
                          ('PHARMACIST_CANCEL_MED',
                           'PHARMACIST_CANCEL_INSTR',
                           'PHARMACIST_CANCEL_REQ_TYPE',
                           'PHARMACIST_CANCEL_REQ_DATE',
                           'PHARMACIST_CANCEL_QTY',
                           'PHARMACIST_CANCEL_DATE_NEXT_APPOINTMENT',
                           'PHARMACIST_CANCEL_NOTES');
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, l_header_codes, o_headers_details);
    
        g_error     := 'GET PROF TYPE';
        l_prof_type := get_prof_type(i_prof);
    
        --drug description
        OPEN o_drug FOR
            SELECT drd.id_drug_req_det,
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.flg_type,
                                       dr.id_drug_presc_det,
                                       g_yes,
                                       drd.id_other_product) med,
                   get_drug_desc_instr(i_lang, i_prof, dr.id_episode, drd.id_drug_req_det) instr,
                   pk_message.get_message(i_lang, 'PHARMACIST_CANCEL_REQ_TYPE_' || dr.flg_type) req_type,
                   pk_date_utils.date_send_tsz(i_lang, drdst.dt_state, i_prof) req_date,
                   format_qty_details(i_lang,
                                      i_prof,
                                      get_qty_pending(i_prof, drd.id_drug_req_det),
                                      drd.id_unit_measure_prep) qty,
                   pk_date_utils.date_send_tsz(i_lang,
                                               get_next_appointment_date(i_lang, dr.id_patient, i_prof, l_prof_type),
                                               i_prof) date_next_appointment,
                   drdst.notes1 notes
              FROM drug_req_det drd, drug_req dr, drug_req_det_state_transition drdst
             WHERE drd.id_drug_req_det = i_drug_req_det
               AND drd.id_drug_req = dr.id_drug_req
               AND drd.id_drug_req_det = drdst.id_drug_req_det
               AND drdst.id_state = get_state_for_req_type(i_prof, dr.flg_type, g_drd_requested_st);
    
        IF (i_get_motives = g_yes)
        THEN
            g_error     := 'GET CANCEL REASONS';
            l_ret_value := pk_cancel_reason.get_cancel_reason_list(i_lang,
                                                                   i_prof,
                                                                   'MEDICATION_CANCEL',
                                                                   o_motives,
                                                                   o_error);
            IF (NOT l_ret_value)
            THEN
                RAISE ex_cancel_reasons;
            END IF;
        ELSE
            pk_types.open_my_cursor(o_motives);
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_pat_cancel_pend', o_error);
            RETURN FALSE;
    END get_pat_cancel_pend;

    /********************************************************************************************
    * alert.pk_pharmacy.set_pat_cancel_pend
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_DRUG_REQ_DET                  IN    NUMBER(24)
    * @param  I_ID_MOTIVE                     IN    NUMBER
    * @param  I_NOTES_MOTIVE                  IN    VARCHAR2
    * @param  I_NOTES_CANCEL                  IN    VARCHAR2
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-02
    *
    ********************************************************************************************/
    FUNCTION set_pat_cancel_pend
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN profissional,
        i_drug_req_det IN drug_req_det.id_drug_req_det%TYPE,
        i_id_motive    IN NUMBER, --TBD!!
        i_notes_motive IN drug_req_sup_state_transition.notes1%TYPE,
        i_notes_cancel IN drug_req_sup_state_transition.notes2%TYPE,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
        l_current_req_state   wfl_state.id_state%TYPE;
        l_next_req_state      wfl_state.id_state%TYPE;
        l_current_drs_state   wfl_state.id_state%TYPE;
        l_datetime            TIMESTAMP WITH LOCAL TIME ZONE;
        l_req_type            drug_req.flg_type%TYPE;
        l_state_transition_ok BOOLEAN := FALSE;
        l_qty_req             drug_req_det.qty_req%TYPE := 0;
        l_qty_sup             drug_req_supply.qty_supply%TYPE := 0;
        l_drs_id              drug_req_supply.id_drug_req_supply%TYPE;
    BEGIN
        l_datetime := current_timestamp;
    
        g_error    := 'GET REQ TYPE';
        l_req_type := get_req_type(i_drug_req_det, NULL);
    
        g_error := 'GET DRD STATE, QTY_REQ, QTY_SUP';
        SELECT drd.id_state, nvl(drd.qty_req, 0), SUM(nvl(drs.qty_supply, 0))
          INTO l_current_req_state, l_qty_req, l_qty_sup
          FROM drug_req_det drd
          LEFT JOIN drug_req_supply drs
            ON (drd.id_drug_req_det = drs.id_drug_req_det)
          LEFT JOIN (SELECT column_value
                       FROM TABLE(get_states_for_req_type(i_prof,
                                                          NULL,
                                                          table_varchar(g_drs_canceled_st, g_drs_rejected_st)))) x
            ON (drs.id_state = x.column_value)
         WHERE drd.id_drug_req_det = i_drug_req_det
         GROUP BY drd.id_state, drd.qty_req;
    
        g_error := 'GET DRS ID, STATE';
        SELECT drs.id_drug_req_supply, drs.id_state
          INTO l_drs_id, l_current_drs_state
          FROM drug_req_supply drs
         WHERE drs.id_drug_req_det = i_drug_req_det
           AND drs.id_state = get_state_for_req_type(i_prof, NULL, g_drs_preparing_st)
           AND rownum = 1;
    
        l_next_req_state := get_state_for_req_type(i_prof, l_req_type, g_drd_terminated_st);
    
        l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                         i_prof,
                                                                         l_current_req_state,
                                                                         l_next_req_state) AND
                                 pk_medication_workflow.is_state_related(i_lang,
                                                                         i_prof,
                                                                         l_current_drs_state,
                                                                         get_state_for_req_type(i_prof,
                                                                                                NULL,
                                                                                                g_drs_canceled_st));
    
        IF (l_state_transition_ok)
        THEN
            --DRS
            UPDATE drug_req_supply drs
               SET drs.id_state   = get_state_for_req_type(i_prof, NULL, g_drs_canceled_st),
                   drs.qty_supply =
                   (l_qty_req - l_qty_sup)
             WHERE drs.id_drug_req_supply = l_drs_id;
        
            --state history
            INSERT INTO drug_req_sup_state_transition
                (id_drug_req_supply, id_state, id_prof, dt_state, notes1, notes2)
            VALUES
                (l_drs_id,
                 get_state_for_req_type(i_prof, NULL, g_drs_canceled_st),
                 i_prof.id,
                 l_datetime,
                 i_notes_motive,
                 i_notes_cancel);
        
            --DRD
            UPDATE drug_req_det drd
               SET drd.id_state            = l_next_req_state,
                   drd.dt_last_change      = l_datetime,
                   drd.id_prof_last_change = i_prof.id,
                   drd.id_sw_last_change   = i_prof.software,
                   drd.id_inst_last_change = i_prof.institution
             WHERE drd.id_drug_req_det = i_drug_req_det;
        
            --state history
            INSERT INTO drug_req_det_state_transition
                (id_drug_req_det, id_state, id_prof, dt_state)
            VALUES
                (i_drug_req_det, l_next_req_state, i_prof.id, l_datetime);
        ELSE
            RAISE g_ex_cannot_be_canceled_drs;
        END IF;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'set_pat_cancel_pend', o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_pat_cancel_pend;

    /********************************************************************************************
    * alert.pk_pharmacy.set_pat_reject
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_PROF_CAT_TYPE                 IN    VARCHAR2
    * @param  I_DRUG_REQ_DET                  IN    ALERT.TABLE_NUMBER
    * @param  I_NOTES_REJECT                  IN    ALERT.TABLE_VARCHAR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-02
    *
    ********************************************************************************************/
    FUNCTION set_pat_reject
    (
        i_lang          IN language.id_language%TYPE,
        i_prof          IN profissional,
        i_prof_cat_type IN category.flg_type%TYPE,
        i_drug_req_det  IN table_number,
        i_notes_reject  IN table_varchar,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'set_pat_reject';
        l_current_req_state   wfl_state.id_state%TYPE;
        l_next_state_id       wfl_state.id_state%TYPE := NULL;
        l_state_transition_ok BOOLEAN := FALSE;
        l_datetime            TIMESTAMP WITH LOCAL TIME ZONE;
        l_req_count           NUMBER := 0;
        l_req_type            drug_req.flg_type%TYPE;
        l_error               t_error_out;
        l_allocation          t_rec_pharm_drd_allocation := t_rec_pharm_drd_allocation(NULL, NULL, NULL, NULL);
        l_car_state           pharm_unidose_car.id_state%TYPE;
    
        --alertas
        l_flg_alert BOOLEAN := FALSE;
        --
        PROCEDURE process_alerts
        (
            i_flg_alert     IN BOOLEAN,
            i_drug_req_det  IN drug_req_det.id_drug_req_det%TYPE,
            i_next_state_id IN drug_req_det_state_transition.id_state%TYPE
        ) IS
            l_code_interv      mi_med.med_descr%TYPE;
            l_id_episode       episode.id_episode%TYPE;
            l_id_patient       drug_req.id_patient%TYPE;
            l_flg_type         drug_req.flg_type%TYPE;
            l_id_dpd           drug_req.id_drug_presc_det%TYPE;
            l_id_drug          drug_req_det.id_drug%TYPE;
            l_id_other_product drug_req_det.id_other_product%TYPE;
            l_vers             drug_req_det.vers%TYPE;
            l_sys_alert_event  sys_alert_event%ROWTYPE;
            l_hand_off_type    sys_config.value%TYPE;
            physicians_ids     table_number;
            nurse_ids          table_number;
            l_prof             epis_info.id_professional%TYPE;
            l_flg_pend_p       BOOLEAN;
            l_flg_pend_n       BOOLEAN;
            l_flg_prof         BOOLEAN;
            l_flg_right        BOOLEAN := TRUE;
            l_issue_p          pending_issue.id_pending_issue%TYPE := NULL;
            l_issue_n          pending_issue.id_pending_issue%TYPE := NULL;
            l_pat_name         patient.name%TYPE;
            subject_pend_issue sys_message.desc_message%TYPE;
            message_pend_issue sys_message.desc_message%TYPE;
        
        BEGIN
            IF (i_flg_alert = TRUE)
            THEN
            
                SELECT dr.id_episode,
                       dr.id_patient,
                       dr.flg_type,
                       drd.id_drug,
                       drd.id_other_product,
                       drd.vers,
                       dr.id_prof_req,
                       dr.id_drug_presc_det
                  INTO l_id_episode, l_id_patient, l_flg_type, l_id_drug, l_id_other_product, l_vers, l_prof, l_id_dpd
                  FROM drug_req_det drd
                 INNER JOIN drug_req dr
                    ON (drd.id_drug_req = dr.id_drug_req)
                 INNER JOIN epis_info ei
                    ON (dr.id_episode = ei.id_episode)
                 WHERE drd.id_drug_req_det = i_drug_req_det;
            
                l_code_interv := get_medication_name(i_lang             => i_lang,
                                                     i_prof             => i_prof,
                                                     i_id_drug          => l_id_drug,
                                                     i_version          => l_vers,
                                                     i_dr_flg_type      => l_flg_type,
                                                     i_id_dpd           => l_id_dpd,
                                                     i_id_other_product => l_id_other_product);
            
                l_flg_prof := get_prof_previous_state(i_lang            => i_lang,
                                                      i_prof            => i_prof,
                                                      i_id_drug_req_det => i_drug_req_det,
                                                      i_id_state        => i_next_state_id,
                                                      o_id_prof         => l_prof,
                                                      o_error           => l_error);
            
                subject_pend_issue := pk_message.get_message(i_lang      => i_lang,
                                                             i_code_mess => 'PENDING_ISSUE_PHARM_TITLE');
                message_pend_issue := pk_message.get_message(i_lang => i_lang, i_code_mess => 'PENDING_ISSUE_PHARM_MSG');
            
                l_pat_name         := get_pat_name(i_lang => i_lang, i_prof => i_prof, i_id_patient => l_id_patient);
                message_pend_issue := REPLACE(message_pend_issue, '[MED]', l_code_interv);
                message_pend_issue := REPLACE(message_pend_issue, '[PAT]', l_pat_name);
            
                IF l_flg_prof
                THEN
                    IF NOT pk_alerts.insert_sys_alert_event(i_lang                => i_lang,
                                                            i_prof                => i_prof,
                                                            i_sys_alert           => 75,
                                                            i_id_episode          => l_id_episode,
                                                            i_id_record           => i_drug_req_det,
                                                            i_dt_record           => current_timestamp,
                                                            i_id_professional     => l_prof,
                                                            i_id_room             => NULL,
                                                            i_id_clinical_service => NULL,
                                                            i_flg_type_dest       => 'C',
                                                            i_replace1            => l_code_interv,
                                                            i_replace2            => pk_sysconfig.get_config('ALERT_DRUG_REJECT_TIMEOUT1',
                                                                                                             i_prof),
                                                            o_error               => l_error)
                    THEN
                        set_pharmacy_log(l_db_object_name, 'ERROR! g_error=' || g_error);
                        l_flg_right := FALSE;
                    END IF;
                END IF;
            
                IF (i_next_state_id = get_state_for_req_type(i_prof, l_req_type, g_drd_rejected_st))
                THEN
                
                    pk_hand_off_core.get_hand_off_type(i_lang           => i_lang,
                                                       i_prof           => i_prof,
                                                       io_hand_off_type => l_hand_off_type);
                
                    physicians_ids := pk_hand_off_core.get_responsibles_id(i_lang          => i_lang,
                                                                           i_prof          => i_prof,
                                                                           i_id_episode    => l_id_episode,
                                                                           i_prof_cat      => 'D', --Physician category
                                                                           i_hand_off_type => l_hand_off_type);
                
                    nurse_ids := pk_hand_off_core.get_responsibles_id(i_lang          => i_lang,
                                                                      i_prof          => i_prof,
                                                                      i_id_episode    => l_id_episode,
                                                                      i_prof_cat      => 'N', --Nurse category
                                                                      i_hand_off_type => l_hand_off_type);
                
                    IF (physicians_ids.count > 0)
                    THEN
                    
                        FOR i IN 1 .. physicians_ids.count
                        LOOP
                            IF (physicians_ids(i) IS NOT NULL)
                            THEN
                                IF (physicians_ids(i) != l_prof OR l_flg_right = FALSE)
                                THEN
                                    IF NOT pk_alerts.insert_sys_alert_event(i_lang                => i_lang,
                                                                            i_prof                => i_prof,
                                                                            i_sys_alert           => 75,
                                                                            i_id_episode          => l_id_episode,
                                                                            i_id_record           => i_drug_req_det,
                                                                            i_dt_record           => current_timestamp,
                                                                            i_id_professional     => physicians_ids(i),
                                                                            i_id_room             => NULL,
                                                                            i_id_clinical_service => NULL,
                                                                            i_flg_type_dest       => 'C',
                                                                            i_replace1            => l_code_interv,
                                                                            i_replace2            => pk_sysconfig.get_config('ALERT_DRUG_REJECT_TIMEOUT1',
                                                                                                                             i_prof),
                                                                            o_error               => l_error)
                                    THEN
                                        set_pharmacy_log(l_db_object_name, 'ERROR! g_error=' || g_error);
                                    END IF;
                                END IF;
                            
                                l_flg_pend_p := pk_pending_issues.set_issue_prof_group(i_lang    => i_lang,
                                                                                       i_prof    => i_prof,
                                                                                       i_issue   => l_issue_p,
                                                                                       i_title   => subject_pend_issue,
                                                                                       i_patient => l_id_patient,
                                                                                       i_episode => l_id_episode,
                                                                                       i_group   => table_number(),
                                                                                       i_profs   => table_number(physicians_ids(i)),
                                                                                       i_status  => 'O',
                                                                                       i_subject => subject_pend_issue,
                                                                                       i_message => message_pend_issue,
                                                                                       o_error   => l_error);
                            END IF;
                        END LOOP;
                    END IF;
                
                    IF (nurse_ids.count > 0)
                    THEN
                    
                        FOR i IN 1 .. nurse_ids.count
                        LOOP
                            IF (nurse_ids(i) IS NOT NULL)
                            THEN
                                IF NOT pk_alerts.insert_sys_alert_event(i_lang                => i_lang,
                                                                        i_prof                => i_prof,
                                                                        i_sys_alert           => 75,
                                                                        i_id_episode          => l_id_episode,
                                                                        i_id_record           => i_drug_req_det,
                                                                        i_dt_record           => current_timestamp,
                                                                        i_id_professional     => nurse_ids(i),
                                                                        i_id_room             => NULL,
                                                                        i_id_clinical_service => NULL,
                                                                        i_flg_type_dest       => 'C',
                                                                        i_replace1            => l_code_interv,
                                                                        i_replace2            => pk_sysconfig.get_config('ALERT_DRUG_REJECT_TIMEOUT1',
                                                                                                                         i_prof),
                                                                        o_error               => l_error)
                                THEN
                                    set_pharmacy_log(l_db_object_name, 'ERROR! g_error=' || g_error);
                                END IF;
                            
                                l_flg_pend_n := pk_pending_issues.set_issue_prof_group(i_lang    => i_lang,
                                                                                       i_prof    => i_prof,
                                                                                       i_issue   => l_issue_n,
                                                                                       i_title   => subject_pend_issue,
                                                                                       i_patient => l_id_patient,
                                                                                       i_episode => l_id_episode,
                                                                                       i_group   => table_number(),
                                                                                       i_profs   => table_number(nurse_ids(i)),
                                                                                       i_status  => 'O',
                                                                                       i_subject => subject_pend_issue,
                                                                                       i_message => message_pend_issue,
                                                                                       o_error   => l_error);
                            END IF;
                        END LOOP;
                    END IF;
                END IF;
            
            END IF;
        
        EXCEPTION
            WHEN OTHERS THEN
                set_pharmacy_log('process_alerts', 'ERROR! process_alerts: ' || SQLERRM);
        END process_alerts;
    
        PROCEDURE delete_alerts
        (
            i_lang         IN language.id_language%TYPE,
            i_prof         IN profissional,
            i_flg_alert    IN BOOLEAN,
            i_drug_req_det IN drug_req_det.id_drug_req_det%TYPE
        ) IS
            l_id_episode      episode.id_episode%TYPE;
            l_sys_alert_event sys_alert_event%ROWTYPE;
        BEGIN
            IF (i_flg_alert = TRUE)
            THEN
            
                SELECT dr.id_episode
                  INTO l_id_episode
                  FROM drug_req dr, drug_req_det drd
                 WHERE drd.id_drug_req = dr.id_drug_req
                   AND drd.id_drug_req_det = i_drug_req_det;
            
                -- Remove o alerta 14 de requisio em atraso
                g_error                        := 'DELETE FROM SYS_ALERT_EVENT ALERT 14 SET_PAT_CHECK';
                l_sys_alert_event.id_sys_alert := 14;
                l_sys_alert_event.id_episode   := l_id_episode;
                l_sys_alert_event.id_record    := i_drug_req_det;
            
                IF NOT pk_alerts.delete_sys_alert_event(i_lang            => i_lang,
                                                        i_prof            => i_prof,
                                                        i_sys_alert_event => l_sys_alert_event,
                                                        o_error           => l_error)
                THEN
                    set_pharmacy_log(l_db_object_name, 'ERROR! (process_alerts) g_error=' || g_error);
                END IF;
            
                -- remover alerta 72 da tabela sys_alert_event --
                g_error                        := 'DELETE FROM SYS_ALERT_EVENT ALERT 72 SET_PAT_PREPARE';
                l_sys_alert_event.id_sys_alert := 72;
            
                IF NOT pk_alerts.delete_sys_alert_event(i_lang            => i_lang,
                                                        i_prof            => i_prof,
                                                        i_sys_alert_event => l_sys_alert_event,
                                                        o_error           => l_error)
                THEN
                    set_pharmacy_log(l_db_object_name, 'ERROR! (process_alerts) g_error=' || g_error);
                END IF;
            
                -- Remove o alerta 14 de requisio em atraso
                g_error                        := 'DELETE FROM SYS_ALERT_EVENT ALERT 73 SET_PAT_2CHECK';
                l_sys_alert_event.id_sys_alert := 73;
            
                IF NOT pk_alerts.delete_sys_alert_event(i_lang            => i_lang,
                                                        i_prof            => i_prof,
                                                        i_sys_alert_event => l_sys_alert_event,
                                                        o_error           => l_error)
                THEN
                    set_pharmacy_log(l_db_object_name, 'ERROR! (process_alerts) g_error=' || g_error);
                END IF;
            
            END IF;
        
        EXCEPTION
            WHEN OTHERS THEN
                set_pharmacy_log('process_alerts', 'ERROR! process_alerts: ' || SQLERRM);
            
        END delete_alerts;
    
        --
    BEGIN
        l_req_count := i_drug_req_det.count;
        l_datetime  := current_timestamp;
    
        FOR i IN 1 .. l_req_count
        LOOP
            g_error := 'GET REQ STATE';
            SELECT drd.id_state
              INTO l_current_req_state
              FROM drug_req_det drd
             WHERE drd.id_drug_req_det = i_drug_req_det(i);
        
            g_error    := 'GET REQ TYPE';
            l_req_type := get_req_type(i_drug_req_det(i), NULL);
        
            g_error := 'IN_TABLE: l_req_type=' || l_req_type;
            IF (in_table(l_current_req_state,
                         get_states_for_req_type(i_prof,
                                                 l_req_type,
                                                 table_varchar(g_drd_requested_st,
                                                               g_drd_validated_st,
                                                               g_drd_validated_sign_st,
                                                               g_drd_rejected2pharm_st,
                                                               g_drd_rejected2prep_st))))
            THEN
            
                g_error         := 'L_NEXT_STATE_ID';
                l_next_state_id := CASE l_current_req_state
                                   --drd
                                       WHEN get_state_for_req_type(i_prof, l_req_type, g_drd_requested_st) THEN
                                        get_state_for_req_type(i_prof, l_req_type, g_drd_rejected_st)
                                       WHEN get_state_for_req_type(i_prof, l_req_type, g_drd_validated_st) THEN
                                        get_state_for_req_type(i_prof, l_req_type, g_drd_rejected2pharm_st)
                                       WHEN get_state_for_req_type(i_prof, l_req_type, g_drd_validated_sign_st) THEN
                                        get_state_for_req_type(i_prof, l_req_type, g_drd_rejected2pharm_st)
                                       WHEN get_state_for_req_type(i_prof, l_req_type, g_drd_rejected2prep_st) THEN
                                        get_state_for_req_type(i_prof, l_req_type, g_drd_rejected2pharm_st)
                                       WHEN get_state_for_req_type(i_prof, l_req_type, g_drd_rejected2pharm_st) THEN
                                        get_state_for_req_type(i_prof, l_req_type, g_drd_rejected_st)
                                   --err!!
                                       ELSE
                                        g_state_err
                                   END;
            
                l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                                 i_prof,
                                                                                 l_current_req_state,
                                                                                 l_next_state_id);
            
                g_error := 'IF (L_STATE_TRANSITION_OK) THEN';
                IF (l_state_transition_ok)
                THEN
                
                    UPDATE drug_req_det drd
                       SET drd.id_state            = l_next_state_id,
                           drd.id_prof_last_change = i_prof.id,
                           drd.id_sw_last_change   = i_prof.software,
                           drd.id_inst_last_change = i_prof.institution
                     WHERE drd.id_drug_req_det = i_drug_req_det(i);
                
                    INSERT INTO drug_req_det_state_transition
                        (id_drug_req_det, id_state, id_prof, dt_state, notes1)
                    VALUES
                        (i_drug_req_det(i), l_next_state_id, i_prof.id, l_datetime, i_notes_reject(i));
                
                    l_flg_alert := TRUE;
                
                ELSE
                    RAISE g_ex_cannot_be_rejected;
                END IF;
            
            ELSIF (in_table(l_current_req_state,
                            get_states_for_req_type(i_prof,
                                                    l_req_type,
                                                    table_varchar(g_drd_executing_st, g_drd_terminated_st))))
            THEN
            
                --rejecting suplies = g_drs_readyforvalid_state_id
                l_state_transition_ok := pk_medication_workflow.is_state_related(i_lang,
                                                                                 i_prof,
                                                                                 get_state_for_req_type(i_prof,
                                                                                                        NULL,
                                                                                                        g_drs_readyforvalid_st),
                                                                                 get_state_for_req_type(i_prof,
                                                                                                        NULL,
                                                                                                        g_drs_rejected_st));
            
                g_error := 'IF (L_STATE_TRANSITION_OK) THEN 2';
                IF (l_state_transition_ok)
                THEN
                
                    --supplies become invalid!!
                    INSERT INTO drug_req_sup_state_transition
                        (id_drug_req_supply, id_state, id_prof, dt_state, notes1)
                        SELECT drs.id_drug_req_supply,
                               get_state_for_req_type(i_prof, NULL, g_drs_rejected_st),
                               i_prof.id,
                               l_datetime,
                               i_notes_reject(i)
                          FROM drug_req_supply drs
                         WHERE drs.id_drug_req_det = i_drug_req_det(i)
                           AND drs.id_state = get_state_for_req_type(i_prof, NULL, g_drs_readyforvalid_st);
                
                    UPDATE drug_req_supply drs
                       SET drs.id_state = get_state_for_req_type(i_prof, NULL, g_drs_rejected_st)
                     WHERE drs.id_drug_req_det = i_drug_req_det(i)
                       AND drs.id_state = get_state_for_req_type(i_prof, NULL, g_drs_readyforvalid_st);
                
                    DELETE FROM drug_req_supply drs
                     WHERE drs.id_drug_req_det = i_drug_req_det(i)
                       AND drs.id_state = get_state_for_req_type(i_prof, NULL, g_drs_preparing_st);
                
                    --update request to state g_drd_rejected2prep_st, technician has to prepare again!!
                    UPDATE drug_req_det drd
                       SET drd.id_state            = get_state_for_req_type(i_prof, l_req_type, g_drd_rejected2prep_st),
                           drd.dt_last_change      = l_datetime,
                           drd.id_prof_last_change = i_prof.id,
                           drd.id_sw_last_change   = i_prof.software,
                           drd.id_inst_last_change = i_prof.institution
                     WHERE drd.id_drug_req_det = i_drug_req_det(i);
                
                    INSERT INTO drug_req_det_state_transition
                        (id_drug_req_det, id_state, id_prof, dt_state, notes1)
                    VALUES
                        (i_drug_req_det(i),
                         get_state_for_req_type(i_prof, l_req_type, g_drd_rejected2prep_st),
                         i_prof.id,
                         l_datetime,
                         i_notes_reject(i));
                
                    l_flg_alert     := TRUE;
                    l_next_state_id := get_state_for_req_type(i_prof, l_req_type, g_drd_rejected2prep_st);
                
                ELSE
                    RAISE g_ex_cannot_be_rejected;
                END IF;
            
            ELSE
                RAISE g_ex_cannot_be_rejected;
            END IF;
        
            IF (l_next_state_id = get_state_for_req_type(i_prof, l_req_type, g_drd_rejected_st))
            THEN
            
                l_allocation := get_unidose_order_allocation(i_lang, i_drug_req_det(i));
            
                IF (l_allocation.id_unidose_car IS NOT NULL)
                THEN
                    SELECT puc.id_state
                      INTO l_car_state
                      FROM pharm_unidose_car puc
                     WHERE puc.id_unidose_car = l_allocation.id_unidose_car;
                END IF;
            
                IF ((l_allocation.id_unidose_car IS NOT NULL) AND
                   (in_table(l_car_state,
                              get_states_for_req_type(i_prof,
                                                      NULL,
                                                      table_varchar(g_uni_car_executing_st, g_uni_car_parked_st)))))
                THEN
                    remove_drd_from_unidose_car(i_lang, i_prof, i_drug_req_det(i));
                END IF;
            END IF;
        
            --alertas
            process_alerts(i_flg_alert     => l_flg_alert,
                           i_drug_req_det  => i_drug_req_det(i),
                           i_next_state_id => l_next_state_id);
            delete_alerts(i_lang         => i_lang,
                          i_prof         => i_prof,
                          i_flg_alert    => l_flg_alert,
                          i_drug_req_det => i_drug_req_det(i));
        
        END LOOP;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'set_pat_reject', o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_pat_reject;

    --BEGIN: AUX functions (perfil do auxiliar) ***** - ***** - ***** - ***** - ***** - ***** - ***** - *****

    /********************************************************************************************
    * alert.pk_pharmacy.get_meds_2transp
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_PROF_CAT_TYPE                 IN    VARCHAR2
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  I_GET_ACTIONS                   IN    VARCHAR2
    * @param  O_DRUG                          OUT   REF CURSOR
    * @param  O_DRUG_DEV                      OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_ACTIONS                       OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-07-09
    *
    ********************************************************************************************/
    FUNCTION get_meds_2transp
    (
        i_lang          IN language.id_language%TYPE,
        i_prof          IN alert.profissional,
        i_prof_cat_type IN category.flg_type%TYPE,
        i_patient_id    IN drug_req.id_patient%TYPE,
        i_get_headers   IN VARCHAR2 DEFAULT 'N',
        i_header_codes  IN table_varchar DEFAULT NULL,
        i_get_actions   IN VARCHAR2 DEFAULT 'N',
        o_drug          OUT pk_types.cursor_type,
        o_drug_dev      OUT pk_types.cursor_type,
        o_headers       OUT pk_types.cursor_type,
        o_actions       OUT pk_types.cursor_type,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
        l_prof_type           profile_template.flg_type%TYPE;
        l_drs_ready4transp_st wfl_state.id_state%TYPE;
    BEGIN
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error := 'GET ACTIONS';
        get_pharmacy_actions(i_lang, i_prof, i_get_actions, get_grid_actions(g_flg_aux_dev), o_actions);
    
        g_error     := 'GET PROF TYPE';
        l_prof_type := get_prof_type(i_prof);
    
        g_error               := 'GET GET_STATE_FOR_REQ_TYPE';
        l_drs_ready4transp_st := get_state_for_req_type(i_prof, NULL, g_drs_uni_ready4transp_st);
    
        g_error := 'QUERY - TRANSPORT FROM PHARMACY TO DEPARTMENT/SERVICE (PATIENT LOCATION)';
        OPEN o_drug FOR
            SELECT drs.id_drug_req_supply id,
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.flg_type,
                                       dr.id_drug_presc_det,
                                       g_yes,
                                       drd.id_other_product) short_pharm,
                   pk_translation.get_translation(i_lang, 'PHARMACY_NAME_001') from_location,
                   get_pat_location(i_lang, i_prof, dr.id_episode, dr.id_patient) to_location,
                   get_status_pipe_str(i_lang, i_prof, drs.id_state, i_prof_cat_type, drss.dt_state, NULL, '', g_yes) state,
                   drs.id_state,
                   dr.flg_type flg_type_req,
                   'REQ' dev_req,
                   drd.id_drug_req_det
              FROM drug_req_supply               drs,
                   drug_req_sup_state_transition drss,
                   drug_req_det                  drd,
                   drug_req                      dr,
                   episode                       e,
                   visit                         v,
                   wfl_state                     ws,
                   wfl_state_detail              wsd
             WHERE drs.id_drug_req_supply = drss.id_drug_req_supply
               AND drs.id_state = drss.id_state
               AND drs.id_drug_req_det = drd.id_drug_req_det
               AND drd.id_drug_req = dr.id_drug_req
               AND dr.id_episode = e.id_episode
               AND e.id_visit = v.id_visit
               AND drs.id_state = ws.id_state
               AND ws.id_state = wsd.state
               AND wsd.prof_type = l_prof_type
               AND drs.id_state IN
                   (SELECT column_value
                      FROM TABLE(get_states_for_req_type(i_prof,
                                                         NULL,
                                                         table_varchar(g_drs_readyfortransp_st,
                                                                       g_drs_in_transit_st,
                                                                       g_drs_uni_in_transit_st,
                                                                       g_drs_supplied_st,
                                                                       g_drs_uni_ready4transp_st))))
               AND drd.id_state != get_state_for_req_type(i_prof, dr.flg_type, g_drd_canceled_st)
                  --and e.flg_status = 'A' -- (ALERT-59265)
               AND v.flg_status != 'C'
               AND dr.id_patient = i_patient_id
               AND (dr.flg_type = g_flg_adm OR
                   --ALERT-59101
                   (dr.flg_type = g_flg_unidose AND drd.flg_uni_out_off_car = g_yes AND
                   drs.id_state IN
                   (SELECT column_value
                        FROM TABLE(get_states_for_req_type(i_prof,
                                                           NULL,
                                                           table_varchar(g_drs_in_transit_st,
                                                                         g_drs_uni_in_transit_st,
                                                                         g_drs_supplied_st,
                                                                         g_drs_uni_ready4transp_st))))))
               AND get_grid_timeout(drs.id_state, i_prof, 'D') >
                   pk_date_utils.get_timestamp_diff(current_timestamp, drss.dt_state)
             ORDER BY wsd.rank, drss.dt_state;
    
        g_error := 'QUERY - TRANSPORT FROM DEPARTMENT/SERVICE (PATIENT LOCATION) TO PHARMACY';
        OPEN o_drug_dev FOR
            SELECT drsd.id_drug_req_supply_dev id,
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.flg_type,
                                       dr.id_drug_presc_det,
                                       g_yes,
                                       drd.id_other_product) short_pharm,
                   get_pat_location(i_lang, i_prof, dr.id_episode, dr.id_patient) from_location,
                   pk_translation.get_translation(i_lang, 'PHARMACY_NAME_001') to_location,
                   get_status_pipe_str(i_lang, i_prof, drsd.id_state, i_prof_cat_type, drsds.dt_state, NULL, '', g_yes) state,
                   drsd.id_state,
                   dr.flg_type flg_type_req,
                   'DEV' dev_req,
                   drd.id_drug_req_det
              FROM drug_req_supply_dev          drsd,
                   drug_req_sup_dev_state_trans drsds,
                   drug_req_supply              drs,
                   drug_req_det                 drd,
                   drug_req                     dr,
                   episode                      e,
                   visit                        v,
                   wfl_state                    ws,
                   wfl_state_detail             wsd
             WHERE drsd.id_drug_req_supply_dev = drsds.id_drug_req_supply_dev
               AND drsd.id_state = drsds.id_state
               AND drsd.id_drug_req_supply = drs.id_drug_req_supply
               AND drs.id_drug_req_det = drd.id_drug_req_det
               AND drd.id_drug_req = dr.id_drug_req
               AND dr.id_episode = e.id_episode
               AND e.id_visit = v.id_visit
               AND drsd.id_state = ws.id_state
               AND ws.id_state = wsd.state
               AND wsd.prof_type = l_prof_type
               AND drsd.id_state IN
                   (SELECT column_value
                      FROM TABLE(get_states_for_req_type(i_prof,
                                                         NULL,
                                                         table_varchar(g_drs_to_return_st,
                                                                       g_drs_returning_st,
                                                                       g_drs_returned_st))))
                  --and e.flg_status = 'A' -- (ALERT-59265)
               AND v.flg_status != 'C'
               AND dr.id_patient = i_patient_id
               AND (dr.flg_type = g_flg_adm OR
                   --ALERT-59101
                   drd.flg_uni_out_off_car = g_yes)
               AND get_grid_timeout(drsd.id_state, i_prof, 'D') >
                   pk_date_utils.get_timestamp_diff(current_timestamp, drsds.dt_state)
             ORDER BY wsd.rank, drsds.dt_state;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_meds_2transp', o_error);
            pk_types.open_my_cursor(o_drug);
            pk_types.open_my_cursor(o_drug_dev);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_actions);
            RETURN FALSE;
    END get_meds_2transp;

    /********************************************************************************************
    * alert.pk_pharmacy.get_cars_2transp
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_PROF_CAT_TYPE                 IN    VARCHAR2
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  I_GET_ACTIONS                   IN    VARCHAR2
    * @param  O_CARS                          OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_ACTIONS                       OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-08-27
    *
    ********************************************************************************************/
    FUNCTION get_cars_2transp
    (
        i_lang          IN language.id_language%TYPE,
        i_prof          IN alert.profissional,
        i_prof_cat_type IN category.flg_type%TYPE,
        i_get_headers   IN VARCHAR2 DEFAULT 'N',
        i_header_codes  IN table_varchar DEFAULT NULL,
        i_get_actions   IN VARCHAR2 DEFAULT 'N',
        o_cars          OUT pk_types.cursor_type,
        o_headers       OUT pk_types.cursor_type,
        o_actions       OUT pk_types.cursor_type,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error := 'GET ACTIONS';
        get_pharmacy_actions(i_lang, i_prof, i_get_actions, get_grid_actions(g_flg_aux_car), o_actions);
    
        g_error := 'QUERY - TRANSPORT FROM PHARMACY TO DEPARTMENT/SERVICE';
        OPEN o_cars FOR
            SELECT v1.id_unidose_car,
                   v1.car_model_name,
                   v1.dept_serv,
                   v1.number_of_slots,
                   SUM(v1.has_patient) patient_count,
                   v1.car_location,
                   v1.id_state,
                   get_status_pipe_str(i_lang, i_prof, v1.id_state, i_prof_cat_type, v1.dt_state, '', '', g_yes) status,
                   sd.rank,
                   v1.dt_car_begin,
                   'TRANSP' transp_type
              FROM (SELECT uc.id_unidose_car,
                           ucm.car_model_name || '<br/>' || pk_date_utils.dt_chr(i_lang, uc.dt_car_begin, i_prof) ||
                           decode(uc.dt_car_end,
                                  NULL,
                                  '',
                                  ' ' || pk_message.get_message(i_lang, 'PHARMACIST_UNIDOSE_CAR_DATE_INTERVAL') || ' ' ||
                                  pk_date_utils.dt_chr(i_lang, uc.dt_car_end, i_prof)) car_model_name,
                           ucm.number_of_slots,
                           '<b>' || pk_translation.get_translation(i_lang, d.code_department) || '</b><br/>' ||
                           pk_translation.get_translation(i_lang, cs.code_clinical_service) dept_serv,
                           get_unidose_car_location(i_lang,
                                                    i_prof,
                                                    uc.id_state,
                                                    pk_translation.get_translation(i_lang, d.code_department)) car_location,
                           uc.id_state,
                           ucst.dt_state,
                           decode(ucs.id_patient, NULL, 0, 1) has_patient,
                           uc.dt_car_begin
                      FROM pharm_unidose_car_slot        ucs,
                           pharm_unidose_car             uc,
                           pharm_unidose_car_state_trans ucst,
                           pharm_unidose_car_model       ucm,
                           dep_clin_serv                 dcs,
                           clinical_service              cs,
                           department                    d
                     WHERE ucs.id_unidose_car = uc.id_unidose_car
                       AND uc.id_unidose_car = ucst.id_unidose_car
                       AND uc.id_state = ucst.id_state
                       AND uc.id_car_model = ucm.id_unidose_car_model
                       AND ucm.id_dep_clin_serv = dcs.id_dep_clin_serv
                       AND dcs.id_clinical_service = cs.id_clinical_service
                       AND dcs.id_department = d.id_department
                       AND get_grid_timeout(uc.id_state, i_prof, 'D') >
                           pk_date_utils.get_timestamp_diff(current_timestamp, ucst.dt_state)
                       AND ucm.flg_active = g_yes
                       AND uc.id_state IN
                           (SELECT column_value
                              FROM TABLE(get_states_for_req_type(i_prof,
                                                                 NULL,
                                                                 table_varchar(g_uni_car_ready4transp_st,
                                                                               g_uni_car_in_transit_st,
                                                                               g_uni_car_delivered_st))))
                       AND d.id_institution = i_prof.institution) v1,
                   wfl_state_detail sd
             WHERE v1.id_state = sd.state(+)
               AND i_prof_cat_type = sd.prof_type(+)
             GROUP BY v1.id_unidose_car,
                      v1.car_model_name,
                      v1.dept_serv,
                      v1.number_of_slots,
                      v1.car_location,
                      v1.id_state,
                      v1.dt_state,
                      v1.dt_car_begin,
                      sd.rank
            UNION ALL
            -- g_error := 'QUERY - TRANSPORT FROM DEPARTMENT/SERVICE TO PHARMACY';
            SELECT v1.id_unidose_car,
                   v1.car_model_name,
                   v1.dept_serv,
                   v1.number_of_slots,
                   SUM(v1.has_patient) patient_count,
                   v1.car_location,
                   v1.id_state,
                   get_status_pipe_str(i_lang, i_prof, v1.id_state, i_prof_cat_type, v1.dt_state, '', '', g_yes) status,
                   sd.rank,
                   v1.dt_car_begin,
                   'DEV' transp_type
              FROM (SELECT uc.id_unidose_car,
                           ucm.car_model_name || '<br/>' || pk_date_utils.dt_chr(i_lang, uc.dt_car_begin, i_prof) ||
                           decode(uc.dt_car_end,
                                  NULL,
                                  '',
                                  ' ' || pk_message.get_message(i_lang, 'PHARMACIST_UNIDOSE_CAR_DATE_INTERVAL') || ' ' ||
                                  pk_date_utils.dt_chr(i_lang, uc.dt_car_end, i_prof)) car_model_name,
                           ucm.number_of_slots,
                           '<b>' || pk_translation.get_translation(i_lang, d.code_department) || '</b><br/>' ||
                           pk_translation.get_translation(i_lang, cs.code_clinical_service) dept_serv,
                           get_unidose_car_location(i_lang,
                                                    i_prof,
                                                    uc.id_state,
                                                    pk_translation.get_translation(i_lang, d.code_department)) car_location,
                           uc.id_state,
                           ucst.dt_state,
                           decode(ucs.id_patient, NULL, 0, 1) has_patient,
                           uc.dt_car_begin
                      FROM pharm_unidose_car_slot        ucs,
                           pharm_unidose_car             uc,
                           pharm_unidose_car_state_trans ucst,
                           pharm_unidose_car_model       ucm,
                           dep_clin_serv                 dcs,
                           clinical_service              cs,
                           department                    d
                     WHERE ucs.id_unidose_car = uc.id_unidose_car
                       AND uc.id_unidose_car = ucst.id_unidose_car
                       AND uc.id_state = ucst.id_state
                       AND uc.id_car_model = ucm.id_unidose_car_model
                       AND ucm.id_dep_clin_serv = dcs.id_dep_clin_serv
                       AND dcs.id_clinical_service = cs.id_clinical_service
                       AND dcs.id_department = d.id_department
                       AND get_grid_timeout(uc.id_state, i_prof, 'D') >
                           pk_date_utils.get_timestamp_diff(current_timestamp, ucst.dt_state)
                       AND ucm.flg_active = g_yes
                       AND uc.id_state IN
                           (SELECT column_value
                              FROM TABLE(get_states_for_req_type(i_prof,
                                                                 NULL,
                                                                 table_varchar(g_uni_car_ready4transp_dev_st,
                                                                               g_uni_car_in_transit_dev_st,
                                                                               g_uni_car_delivered_dev_st))))
                       AND d.id_institution = i_prof.institution) v1,
                   wfl_state_detail sd
             WHERE v1.id_state = sd.state(+)
               AND i_prof_cat_type = sd.prof_type(+)
             GROUP BY v1.id_unidose_car,
                      v1.car_model_name,
                      v1.dept_serv,
                      v1.number_of_slots,
                      v1.car_location,
                      v1.id_state,
                      v1.dt_state,
                      v1.dt_car_begin,
                      sd.rank
             ORDER BY rank, dt_car_begin, car_model_name;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_cars_2transp', o_error);
            pk_types.open_my_cursor(o_cars);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_actions);
            RETURN FALSE;
    END get_cars_2transp;

    --END: AUX functions (perfil do auxiliar) ***** - ***** - ***** - ***** - ***** - ***** - ***** - *****

    /********************************************************************************************
    * alert.pk_pharmacy.get_conf_unidose_cars
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  I_GET_ACTIONS                   IN    VARCHAR2
    * @param  O_CARS                          OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_ACTIONS                       OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-07-28
    *
    ********************************************************************************************/
    FUNCTION get_conf_unidose_cars
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN alert.profissional,
        i_get_headers  IN VARCHAR2 DEFAULT 'N',
        i_header_codes IN table_varchar DEFAULT NULL,
        i_get_actions  IN VARCHAR2 DEFAULT 'N',
        o_cars         OUT pk_types.cursor_type,
        o_headers      OUT pk_types.cursor_type,
        o_actions      OUT pk_types.cursor_type,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        IF (i_get_actions = g_yes)
        THEN
            OPEN o_actions FOR
                SELECT sd.val id_action, sd.desc_val desc_action, NULL icon, NULL flg_type, NULL from_state
                  FROM sys_domain sd
                 WHERE sd.code_domain IN ('PHARMACIST_UNIDOSE_EDIT_EDIT_CAR', 'PHARMACIST_UNIDOSE_EDIT_CANCEL_CAR')
                   AND sd.domain_owner = pk_sysdomain.k_default_schema
                   AND sd.id_language = i_lang
                 ORDER BY sd.rank;
        END IF;
    
        g_error := 'GET CURSOR';
        OPEN o_cars FOR
            SELECT ucm.id_unidose_car_model,
                   ucm.car_model_name,
                   ucm.number_of_slots,
                   pk_translation.get_translation(i_lang, d.code_department) department,
                   pk_translation.get_translation(i_lang, cs.code_clinical_service) clinical_service,
                   ucm.flg_active cart_state
              FROM pharm_unidose_car_model ucm, dep_clin_serv dcs, department d, clinical_service cs
             WHERE ucm.flg_active != 'D' --deleted!
               AND ucm.id_dep_clin_serv = dcs.id_dep_clin_serv
               AND dcs.id_department = d.id_department
               AND dcs.id_clinical_service = cs.id_clinical_service
               AND d.id_institution = i_prof.institution
             ORDER BY ucm.flg_active DESC, ucm.car_model_name;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_conf_unidose_cars', o_error);
            pk_types.open_my_cursor(o_cars);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_actions);
            RETURN FALSE;
    END get_conf_unidose_cars;

    /********************************************************************************************
    * alert.pk_pharmacy.get_cars
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DRUG_REQ_DET               IN    NUMBER(24)
    * @param  O_CARS                          OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-07-29
    *
    ********************************************************************************************/
    FUNCTION get_cars
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN alert.profissional,
        i_id_drug_req_det IN drug_req_det.id_drug_req_det%TYPE,
        o_cars            OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
        l_id_dep_clin_serv pharm_unidose_car_model.id_dep_clin_serv%TYPE;
        l_dt_req           drug_req.dt_drug_req_tstz%TYPE;
    BEGIN
        g_error := 'GET ID_DEP_CLIN_SERV';
        SELECT ei.id_dep_clin_serv, dr.dt_drug_req_tstz
          INTO l_id_dep_clin_serv, l_dt_req
          FROM drug_req_det drd, drug_req dr, epis_info ei
         WHERE drd.id_drug_req = dr.id_drug_req
           AND dr.id_episode = ei.id_episode
           AND drd.id_drug_req_det = i_id_drug_req_det
           AND rownum = 1;
    
        g_error := 'GET CURSOR (CARS)';
        OPEN o_cars FOR
            SELECT uc.id_unidose_car data,
                   ucm.car_model_name || ' ' || pk_date_utils.dt_chr(i_lang, uc.dt_car_begin, i_prof) ||
                   decode(uc.dt_car_end,
                          NULL,
                          '',
                          ' ' || pk_message.get_message(i_lang, 'PHARMACIST_UNIDOSE_CAR_DATE_INTERVAL') || ' ' ||
                          pk_date_utils.dt_chr(i_lang, uc.dt_car_end, i_prof)) label,
                   ucm.car_model_name,
                   uc.dt_car_begin
              FROM pharm_unidose_car uc, pharm_unidose_car_model ucm
             WHERE uc.id_car_model = ucm.id_unidose_car_model
               AND ucm.id_dep_clin_serv = l_id_dep_clin_serv
               AND ucm.flg_active = g_yes
               AND uc.id_state IN
                   (SELECT column_value
                      FROM TABLE(get_states_for_req_type(i_prof,
                                                         NULL,
                                                         table_varchar(g_uni_car_parked_st, g_uni_car_executing_st))))
               AND uc.dt_car_begin BETWEEN (l_dt_req - 1) AND (l_dt_req + 15)
            UNION
            SELECT uc.id_unidose_car data,
                   ucm.car_model_name || ' ' || pk_date_utils.dt_chr(i_lang, uc.dt_car_begin, i_prof) ||
                   decode(uc.dt_car_end,
                          NULL,
                          '',
                          ' ' || pk_message.get_message(i_lang, 'PHARMACIST_UNIDOSE_CAR_DATE_INTERVAL') || ' ' ||
                          pk_date_utils.dt_chr(i_lang, uc.dt_car_end, i_prof)) label,
                   ucm.car_model_name,
                   uc.dt_car_begin
              FROM TABLE(get_order_car_allocation(i_id_drug_req_det)) v1
             INNER JOIN pharm_unidose_car uc
                ON (v1.id_unidose_car = uc.id_unidose_car)
             INNER JOIN pharm_unidose_car_model ucm
                ON (uc.id_car_model = ucm.id_unidose_car_model)
            --ALERT-59101
            UNION ALL
            SELECT -1 data,
                   pk_message.get_message(i_lang, 'PHARMACY_NOT_APP') label,
                   NULL car_model_name,
                   NULL dt_car_begin
              FROM dual
            --
             ORDER BY car_model_name NULLS LAST, dt_car_begin;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'get_cars', o_error);
            pk_types.open_my_cursor(o_cars);
            RETURN FALSE;
    END get_cars;

    /********************************************************************************************
    * alert.pk_pharmacy.get_conf_unidose_car
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  O_SLOTS                         OUT   REF CURSOR
    * @param  O_DEPTS                         OUT   REF CURSOR
    * @param  O_ACTIVE                        OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-22
    *
    ********************************************************************************************/
    FUNCTION get_conf_unidose_car
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN alert.profissional,
        i_get_headers  IN VARCHAR2 DEFAULT 'N',
        i_header_codes IN table_varchar DEFAULT NULL,
        o_slots        OUT pk_types.cursor_type,
        o_depts        OUT pk_types.cursor_type,
        o_active       OUT pk_types.cursor_type,
        o_headers      OUT pk_types.cursor_type,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error := 'GET SLOTS';
        OPEN o_slots FOR
            SELECT cc.id_container_config data,
                   cc.total_containers label,
                   cc.total_containers || ' (' || cc.lines || 'x' || cc.columns || ')' containers_desc
              FROM container_config cc
             ORDER BY cc.total_containers;
    
        g_error := 'GET DEPARTMENTS';
        OPEN o_depts FOR
            SELECT d.id_department data, pk_translation.get_translation(i_lang, d.code_department) label
              FROM department d
             WHERE d.id_institution = i_prof.institution
               AND d.flg_available = g_yes
               AND d.flg_unidose = g_yes
             ORDER BY label;
    
        g_error := 'GET ACTIVE/NOT ACTIVE (for multichoice)';
        OPEN o_active FOR
            SELECT sd.val data, sd.desc_val label
              FROM sys_domain sd
             WHERE sd.code_domain LIKE 'PHARMACIST_UNIDOSE_CART_ACTIVE__'
               AND sd.id_language = i_lang
             ORDER BY sd.rank;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_conf_unidose_car', o_error);
            pk_types.open_my_cursor(o_slots);
            pk_types.open_my_cursor(o_depts);
            pk_types.open_my_cursor(o_active);
            pk_types.open_my_cursor(o_headers);
            RETURN FALSE;
    END get_conf_unidose_car;

    /********************************************************************************************
    * alert.pk_pharmacy.get_conf_upd_unidose_car
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  I_ID_CAR_MODEL                  IN    NUMBER(24)
    * @param  O_ACTIVE                        OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_CAR_MODEL                     OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-07-28
    *
    ********************************************************************************************/
    FUNCTION get_conf_upd_unidose_car
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN alert.profissional,
        i_get_headers  IN VARCHAR2 DEFAULT 'N',
        i_header_codes IN table_varchar DEFAULT NULL,
        i_id_car_model IN pharm_unidose_car_model.id_unidose_car_model%TYPE,
        o_active       OUT pk_types.cursor_type,
        o_headers      OUT pk_types.cursor_type,
        o_car_model    OUT pk_types.cursor_type,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error := 'GET CAR';
        OPEN o_car_model FOR
            SELECT ucm.id_unidose_car_model,
                   ucm.car_model_name,
                   ucm.number_of_slots,
                   ucm.id_dep_clin_serv,
                   pk_translation.get_translation(i_lang, d.code_department) department,
                   pk_translation.get_translation(i_lang, cs.code_clinical_service) clinical_service,
                   ucm.flg_active cart_state,
                   pk_sysdomain.get_domain('PHARMACIST_UNIDOSE_CART_ACTIVE_' || ucm.flg_active, ucm.flg_active, i_lang) state_desc,
                   ucm.notes
              FROM pharm_unidose_car_model ucm, dep_clin_serv dcs, department d, clinical_service cs
             WHERE ucm.id_unidose_car_model = i_id_car_model
               AND ucm.id_dep_clin_serv = dcs.id_dep_clin_serv
               AND dcs.id_department = d.id_department
               AND dcs.id_clinical_service = cs.id_clinical_service;
    
        g_error := 'GET ACTIVE/NOT ACTIVE (for multichoice)';
        OPEN o_active FOR
            SELECT sd.val data, sd.desc_val label
              FROM sys_domain sd
             WHERE sd.code_domain LIKE 'PHARMACIST_UNIDOSE_CART_ACTIVE__'
               AND sd.id_language = i_lang
             ORDER BY sd.rank;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_conf_upd_unidose_car', o_error);
            pk_types.open_my_cursor(o_car_model);
            pk_types.open_my_cursor(o_active);
            pk_types.open_my_cursor(o_headers);
            RETURN FALSE;
    END get_conf_upd_unidose_car;

    /********************************************************************************************
    * alert.pk_pharmacy.get_clin_serv_4dept
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_DEPARTMENT                    IN    NUMBER(24)
    * @param  O_CLIN_SERVS                    OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-22
    *
    ********************************************************************************************/
    FUNCTION get_clin_serv_4dept
    (
        i_lang       IN language.id_language%TYPE,
        i_prof       IN alert.profissional,
        i_department IN dep_clin_serv.id_department%TYPE,
        o_clin_servs OUT pk_types.cursor_type,
        o_error      OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        g_error := 'GET CLINICAL SERVICES FOR DEPARTMENT';
        OPEN o_clin_servs FOR
            SELECT dcs.id_clinical_service data, pk_translation.get_translation(i_lang, cs.code_clinical_service) label
              FROM dep_clin_serv dcs, clinical_service cs
             WHERE dcs.id_clinical_service = cs.id_clinical_service
               AND dcs.id_department = i_department
               AND dcs.flg_available = g_yes
               AND cs.flg_available = g_yes
             ORDER BY label;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_clin_serv_4dept', o_error);
            pk_types.open_my_cursor(o_clin_servs);
            RETURN FALSE;
    END get_clin_serv_4dept;

    /********************************************************************************************
    * alert.pk_pharmacy.set_conf_unidose_car
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_CAR_MODEL_NAME                IN    VARCHAR2
    * @param  I_CAR_DEPT                      IN    NUMBER(24)
    * @param  I_CAR_CLIN_SERV                 IN    NUMBER(12)
    * @param  I_CAR_SLOTS                     IN    NUMBER(3)
    * @param  I_NOTES                         IN    VARCHAR2
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-22
    *
    ********************************************************************************************/
    FUNCTION set_conf_unidose_car
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN alert.profissional,
        i_car_model_name IN pharm_unidose_car_model.car_model_name%TYPE,
        i_car_dept       IN dep_clin_serv.id_department%TYPE,
        i_car_clin_serv  IN dep_clin_serv.id_clinical_service%TYPE,
        i_car_slots      IN pharm_unidose_car_model.number_of_slots%TYPE,
        i_notes          IN pharm_unidose_car_model.notes%TYPE,
        i_flg_active     IN VARCHAR2 DEFAULT 'Y',
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
        l_id_dep_clin_serv dep_clin_serv.id_dep_clin_serv%TYPE;
        l_datetime         pharm_unidose_car_model.car_model_date%TYPE;
        l_count            NUMBER;
    BEGIN
        l_datetime := current_timestamp;
    
        g_error := 'GET ID_DEP_CLIN_SERV';
        SELECT dcs.id_dep_clin_serv
          INTO l_id_dep_clin_serv
          FROM dep_clin_serv dcs
         WHERE dcs.id_clinical_service = i_car_clin_serv
           AND dcs.id_department = i_car_dept
           AND dcs.flg_available = g_yes
           AND rownum = 1;
    
        SELECT COUNT(*)
          INTO l_count
          FROM pharm_unidose_auto_order puao
         WHERE puao.id_dep_clin_serv = l_id_dep_clin_serv;
    
        g_error := 'SET CAR MODEL';
        INSERT INTO pharm_unidose_car_model
            (id_unidose_car_model,
             car_model_name,
             id_dep_clin_serv,
             number_of_slots,
             flg_active,
             notes,
             id_prof_upd,
             car_model_date)
        VALUES
            (seq_pharm_unidose_car_model.nextval,
             i_car_model_name,
             l_id_dep_clin_serv,
             i_car_slots,
             i_flg_active,
             i_notes,
             i_prof.id,
             l_datetime);
    
        IF (l_count = 0)
        THEN
            INSERT INTO pharm_unidose_auto_order
                (id_dep_clin_serv, flg_auto_pharmacy_order)
            VALUES
                (l_id_dep_clin_serv, g_yes);
        END IF;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'set_conf_unidose_car', o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_conf_unidose_car;

    /********************************************************************************************
    * alert.pk_pharmacy.set_conf_upd_unidose_car
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_CAR_MODEL                  IN    NUMBER(24)
    * @param  I_CAR_MODEL_NAME                IN    VARCHAR2
    * @param  I_NOTES                         IN    VARCHAR2
    * @param  I_FLG_ACTIVE                    IN    VARCHAR2
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-08-26
    *
    ********************************************************************************************/
    FUNCTION set_conf_upd_unidose_car
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN alert.profissional,
        i_id_car_model   IN pharm_unidose_car_model.id_unidose_car_model%TYPE,
        i_car_model_name IN pharm_unidose_car_model.car_model_name%TYPE,
        i_notes          IN pharm_unidose_car_model.notes%TYPE,
        i_flg_active     IN VARCHAR2 DEFAULT 'Y',
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
        l_datetime  pharm_unidose_car_model.car_model_date%TYPE;
        l_car_count NUMBER := 0;
    BEGIN
        l_datetime := current_timestamp;
    
        SELECT COUNT(1)
          INTO l_car_count
          FROM pharm_unidose_car uc
         WHERE uc.id_car_model = i_id_car_model
           AND uc.id_state NOT IN
               (SELECT column_value
                  FROM TABLE(get_states_for_req_type(i_prof, NULL, table_varchar(g_uni_car_parked_st, g_uni_car_end_st))))
           AND rownum = 1;
    
        --[MEDICATION_RULE] (10-09-2009) check if car is idle in the pharmacy and empty!
        IF (l_car_count = 0)
        THEN
            g_error := 'UPDATE CAR MODEL';
            UPDATE pharm_unidose_car_model c
               SET c.car_model_name = i_car_model_name,
                   c.flg_active     = i_flg_active,
                   c.notes          = i_notes,
                   c.id_prof_upd    = i_prof.id,
                   c.car_model_date = l_datetime
             WHERE c.id_unidose_car_model = i_id_car_model;
        ELSE
            g_error := 'INVALID UNIDOSE CAR STATE';
            RAISE g_ex_cannot_alter_car;
        END IF;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'set_conf_upd_unidose_car', o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_conf_upd_unidose_car;

    /********************************************************************************************
    * alert.pk_pharmacy.set_conf_cancel_unidose_car
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_CAR_ID                        IN    NUMBER(24)
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-06-23
    *
    ********************************************************************************************/
    FUNCTION set_conf_cancel_unidose_car
    (
        i_lang   IN language.id_language%TYPE,
        i_prof   IN alert.profissional,
        i_car_id IN pharm_unidose_car_model.id_unidose_car_model%TYPE,
        o_error  OUT t_error_out
    ) RETURN BOOLEAN IS
        l_car_count NUMBER := 0;
    BEGIN
        SELECT COUNT(1)
          INTO l_car_count
          FROM pharm_unidose_car uc
         WHERE uc.id_car_model = i_car_id
           AND uc.id_state NOT IN
               (SELECT column_value
                  FROM TABLE(get_states_for_req_type(i_prof, NULL, table_varchar(g_uni_car_parked_st, g_uni_car_end_st))))
           AND rownum = 1;
    
        --validar se o carro esta "estacionado" na farmacia sem nada "por resolver"
        IF (l_car_count = 0)
        THEN
            --[MEDICATION_RULE] se o carro unidose est na farmcia e sem nenhum paciente associado ento o caso  desactivado
            g_error := 'SET CANCEL CAR MODEL';
            UPDATE pharm_unidose_car_model a
               SET a.flg_active = 'D' --deleted
             WHERE a.id_unidose_car_model = i_car_id
               AND a.flg_active != g_yes; --has to be "not active"!
        ELSE
            --[MEDICATION_RULE] se o carro est ser utilizado ento no pode ser desactivado
            g_error := 'INVALID UNIDOSE CAR STATE';
            RAISE g_ex_cannot_alter_car;
        END IF;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'set_conf_cancel_unidose_car', o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_conf_cancel_unidose_car;

    /********************************************************************************************
    * alert.pk_pharmacy.get_allocations_for_prof
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_DEPARTMENT                    IN    NUMBER(24)
    * @param  O_DEP_SERVS                     OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7
    * @since  2009-10-23
    *
    ********************************************************************************************/
    FUNCTION get_allocations_for_prof
    (
        i_lang       IN language.id_language%TYPE,
        i_prof       IN alert.profissional,
        i_department IN department.id_department%TYPE,
        o_dep_servs  OUT pk_types.cursor_type,
        o_error      OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        g_error := 'GET O_DEP_SERVS';
        OPEN o_dep_servs FOR
            SELECT DISTINCT c.id_dept, c.id_department id_service, NULL flg_favorite
              FROM pharm_service_allocation a
             INNER JOIN dep_clin_serv b
                ON (a.id_dep_clin_serv = b.id_dep_clin_serv)
             INNER JOIN department c
                ON (b.id_department = c.id_department)
             WHERE a.id_prof = i_prof.id
               AND a.id_institution = i_prof.institution
               AND b.flg_available = g_yes;
        --and c.id_dept = i_department;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_allocations_for_prof', o_error);
            pk_types.open_my_cursor(o_dep_servs);
            RETURN FALSE;
    END get_allocations_for_prof;

    /********************************************************************************************
    * alert.pk_pharmacy.set_allocations_for_prof
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_CLIN_SERVS                    IN    ALERT.TABLE_TABLE_NUMBER
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7
    * @since  2009-10-24
    *
    ********************************************************************************************/
    FUNCTION set_allocations_for_prof
    (
        i_lang       IN language.id_language%TYPE,
        i_prof       IN alert.profissional,
        i_clin_servs IN table_table_number,
        o_error      OUT t_error_out
    ) RETURN BOOLEAN IS
        l_id_dep_clin_serv table_number;
        l_id_department    dep_clin_serv.id_department%TYPE := NULL;
    BEGIN
    
        IF (i_clin_servs IS NULL OR
           (i_clin_servs(1) (1) IS NULL AND i_clin_servs(1) (2) IS NULL AND i_clin_servs(1) (3) IS NULL))
        THEN
            DELETE FROM pharm_service_allocation a
             WHERE a.id_prof = i_prof.id
               AND a.id_institution = i_prof.institution;
        ELSE
        
            DELETE FROM pharm_service_allocation a
             WHERE a.id_prof = i_prof.id
               AND a.id_institution = i_prof.institution;
        
            FOR i IN i_clin_servs.first .. i_clin_servs.last
            LOOP
            
                IF (l_id_department IS NULL OR l_id_department != i_clin_servs(i) (1))
                THEN
                    l_id_department := i_clin_servs(i) (1);
                
                    --clean
                    DELETE FROM pharm_service_allocation a
                     WHERE a.id_prof = i_prof.id
                       AND a.id_institution = i_prof.institution
                       AND a.id_dep_clin_serv IN (SELECT dcs.id_dep_clin_serv
                                                    FROM department d
                                                   INNER JOIN dep_clin_serv dcs
                                                      ON (d.id_department = dcs.id_department)
                                                   WHERE d.id_dept = l_id_department
                                                     AND d.id_institution = i_prof.institution);
                END IF;
            
                g_error := 'GET ID_DEP_CLIN_SERV';
                SELECT dcs.id_dep_clin_serv
                  BULK COLLECT
                  INTO l_id_dep_clin_serv
                  FROM department d
                 INNER JOIN dep_clin_serv dcs
                    ON (d.id_department = dcs.id_department)
                 WHERE d.id_department = i_clin_servs(i) (2)
                   AND d.id_dept = i_clin_servs(i) (1)
                   AND d.id_institution = i_prof.institution
                   AND d.flg_available = g_yes
                   AND dcs.flg_available = g_yes;
            
                FORALL i_dcs IN l_id_dep_clin_serv.first .. l_id_dep_clin_serv.last
                    INSERT INTO pharm_service_allocation
                        (id_prof, id_institution, id_dep_clin_serv)
                    VALUES
                        (i_prof.id, i_prof.institution, l_id_dep_clin_serv(i_dcs));
            
            END LOOP;
        
        END IF;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'set_allocations_for_prof', o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_allocations_for_prof;

    /********************************************************************************************
    * alert.pk_pharmacy.get_date_for_reports
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  O_DT_BEGIN                      OUT   VARCHAR2
    * @param  O_DT_END                        OUT   VARCHAR2
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.2
    * @since  2009-11-17
    *
    ********************************************************************************************/
    FUNCTION get_date_for_reports
    (
        i_lang     IN language.id_language%TYPE,
        i_prof     IN alert.profissional,
        o_dt_begin OUT VARCHAR2,
        o_dt_end   OUT VARCHAR2,
        o_error    OUT t_error_out
    ) RETURN BOOLEAN IS
        l_dt_current           TIMESTAMP WITH LOCAL TIME ZONE;
        l_institution_schedule VARCHAR2(5 CHAR) := '';
    BEGIN
        g_error                := 'GET default time for the institution';
        l_institution_schedule := nvl(pk_sysconfig.get_config('PHARMACY_UNIDOSE_INSTITUTION_24H_INTERVAL_START', i_prof),
                                      '');
    
        set_pharmacy_log('get_date_for_reports', 'l_institution_schedule=' || l_institution_schedule);
    
        IF (l_institution_schedule IS NULL)
        THEN
            l_dt_current := current_timestamp;
        ELSE
            g_error      := 'compute date';
            l_dt_current := to_timestamp(to_char(current_timestamp, 'YYYY-MM-DD') || ' ' || l_institution_schedule,
                                         'YYYY-MM-DD HH24:MI');
        END IF;
    
        set_pharmacy_log('get_date_for_reports',
                         'l_dt_current=' || to_char(current_timestamp, 'YYYY-MM-DD') || ' ' || l_institution_schedule);
    
        o_dt_begin := pk_date_utils.date_send_tsz(i_lang, l_dt_current, i_prof);
        o_dt_end   := pk_date_utils.date_send_tsz(i_lang, (l_dt_current + 1), i_prof);
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_date_for_reports', o_error);
            RETURN FALSE;
    END get_date_for_reports;

    --interoperability functions: BEGIN
    /********************************************************************************************
    * alert.pk_pharmacy.get_interop_supplies
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF_INSTITUTION              IN    NUMBER(24)
    * @param  I_ID_DRUG_REQ_SUPPLY            IN    NUMBER(24)
    * @param  O_SUPPLIES                      OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-09-15
    *
    ********************************************************************************************/
    FUNCTION get_interop_supplies
    (
        i_lang               IN language.id_language%TYPE,
        i_prof_institution   IN institution.id_institution%TYPE,
        i_id_drug_req_supply IN drug_req_supply.id_drug_req_supply%TYPE,
        o_supplies           OUT pk_types.cursor_type,
        o_error              OUT t_error_out
    ) RETURN BOOLEAN IS
        l_id_market market.id_market%TYPE;
        l_prof      profissional;
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'get_interop_supplies';
    BEGIN
        g_error := 'CREATE PROF';
        l_prof  := profissional(0, i_prof_institution, 0);
    
        g_error := 'QUERY GET MARKET ID';
        SELECT m.id_market
          INTO l_id_market
          FROM market m
         WHERE m.desc_market = pk_sysconfig.get_config(pk_medication_core.g_prescription_type, l_prof)
           AND rownum = 1;
    
        g_error := 'QUERY';
        OPEN o_supplies FOR
            SELECT drs.id_drug_req_supply,
                   drs.id_drug_req_det,
                   drsst.dt_state dt_dispensa_tstz,
                   drd.id_drug codigo_artigo,
                   drd.vers versao,
                   get_drug_desc_pharm(i_lang, l_prof, ep.id_episode, drd.id_drug_req_det, 'GET_NAME') descricao_artigo,
                   mi.flg_type tipo_artigo,
                   drs.qty_supply qty_disp,
                   drd.id_unit_measure_prep id_unit_disp,
                   pk_medication_core.get_unit_translation(i_lang, l_prof, drd.id_unit_measure_prep, 3) descr_unit_disp,
                   drs.package_number lote,
                   drs.dt_expire prazo_validade,
                   ep.id_clinical_service,
                   ep.id_episode,
                   drsst.id_prof id_prof_disp,
                   dr.id_patient,
                   l_id_market id_market
              FROM drug_req_supply drs
             INNER JOIN drug_req_sup_state_transition drsst
                ON (drs.id_drug_req_supply = drsst.id_drug_req_supply)
             INNER JOIN drug_req_det drd
                ON (drs.id_drug_req_det = drd.id_drug_req_det)
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             INNER JOIN episode ep
                ON (dr.id_episode = ep.id_episode)
             INNER JOIN mi_med mi
                ON (drd.id_drug = mi.id_drug AND drd.vers = mi.vers)
             WHERE drsst.id_state = get_state_for_req_type(l_prof, NULL, g_drs_readyfortransp_st)
               AND drs.id_drug_req_supply = i_id_drug_req_supply
            UNION ALL
            --other products
            SELECT drs.id_drug_req_supply,
                   drs.id_drug_req_det,
                   drsst.dt_state dt_dispensa_tstz,
                   to_char(drd.id_other_product) codigo_artigo,
                   drd.vers versao,
                   get_medication_name(i_lang,
                                       l_prof,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.flg_type,
                                       dr.id_drug_presc_det,
                                       g_yes,
                                       drd.id_other_product) descricao_artigo,
                   pk_medication_core.g_type_o tipo_artigo,
                   drs.qty_supply qty_disp,
                   drd.id_unit_measure_prep id_unit_disp,
                   pk_medication_core.get_unit_translation(i_lang, l_prof, drd.id_unit_measure_prep, 3) descr_unit_disp,
                   drs.package_number lote,
                   drs.dt_expire prazo_validade,
                   ep.id_clinical_service,
                   ep.id_episode,
                   drsst.id_prof id_prof_disp,
                   dr.id_patient,
                   l_id_market id_market
              FROM drug_req_supply drs
             INNER JOIN drug_req_sup_state_transition drsst
                ON (drs.id_drug_req_supply = drsst.id_drug_req_supply)
             INNER JOIN drug_req_det drd
                ON (drs.id_drug_req_det = drd.id_drug_req_det)
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             INNER JOIN episode ep
                ON (dr.id_episode = ep.id_episode)
             INNER JOIN other_product op
                ON (drd.id_other_product = op.id_other_product AND drd.vers = op.vers)
             WHERE drsst.id_state = get_state_for_req_type(l_prof, NULL, g_drs_readyfortransp_st)
               AND drs.id_drug_req_supply = i_id_drug_req_supply;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, o_error);
            pk_types.open_my_cursor(o_supplies);
            RETURN FALSE;
    END get_interop_supplies;

    /********************************************************************************************
    * alert.pk_pharmacy.get_interop_devolutions
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF_INSTITUTION              IN    NUMBER(24)
    * @param  I_ID_DRUG_REQ_SUPPLY_DEV        IN    NUMBER(24)
    * @param  O_DEVS                          OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  1.0
    * @since  2009-09-15
    *
    ********************************************************************************************/
    FUNCTION get_interop_devolutions
    (
        i_lang                   IN language.id_language%TYPE,
        i_prof_institution       IN institution.id_institution%TYPE,
        i_id_drug_req_supply_dev IN drug_req_supply_dev.id_drug_req_supply_dev%TYPE,
        o_devs                   OUT pk_types.cursor_type,
        o_error                  OUT t_error_out
    ) RETURN BOOLEAN IS
        l_prof profissional;
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'get_interop_devolutions';
    BEGIN
        g_error := 'CREATE PROF';
        l_prof  := profissional(0, i_prof_institution, 0);
    
        g_error := 'QUERY';
        OPEN o_devs FOR
            SELECT drsd.id_drug_req_supply_dev,
                   drsd.id_drug_req_supply,
                   drsdst2.dt_state dt_drug_supply_dev,
                   drd.id_drug codigo_artigo,
                   drd.vers versao,
                   mi.flg_type tipo_artigo,
                   get_drug_desc_pharm(i_lang, l_prof, dr.id_episode, drd.id_drug_req_det, 'GET_NAME') descricao_artigo,
                   drsd.qty_dev,
                   drsd.qty_for_trash,
                   drsd.qty_for_stock,
                   drd.id_unit_measure_prep id_unit_dev,
                   pk_medication_core.get_unit_translation(i_lang, l_prof, drd.id_unit_measure_prep, 3) descr_unit_dev,
                   drsd.package_number lote,
                   drsd.dt_package_expire prazo_validade,
                   ep.id_clinical_service,
                   dr.id_episode,
                   dr.id_patient,
                   drsdst2.id_prof id_prof_dev,
                   drsdst.id_state state
              FROM drug_req_supply_dev drsd
             INNER JOIN drug_req_sup_dev_state_trans drsdst
                ON (drsd.id_drug_req_supply_dev = drsdst.id_drug_req_supply_dev)
             INNER JOIN drug_req_sup_dev_state_trans drsdst2
                ON (drsd.id_drug_req_supply_dev = drsdst2.id_drug_req_supply_dev)
             INNER JOIN drug_req_supply drs
                ON (drsd.id_drug_req_supply = drs.id_drug_req_supply)
             INNER JOIN drug_req_det drd
                ON (drs.id_drug_req_det = drd.id_drug_req_det)
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             INNER JOIN episode ep
                ON (dr.id_episode = ep.id_episode)
             INNER JOIN mi_med mi
                ON (drd.id_drug = mi.id_drug AND drd.vers = mi.vers)
             WHERE drsdst.id_state = get_state_for_req_type(l_prof, NULL, g_drs_return_end_st)
               AND drsdst2.id_state = get_state_for_req_type(l_prof, NULL, g_drs_to_return_st)
               AND drsd.id_drug_req_supply_dev = i_id_drug_req_supply_dev
            UNION ALL
            --other products
            SELECT drsd.id_drug_req_supply_dev,
                   drsd.id_drug_req_supply,
                   drsdst2.dt_state dt_drug_supply_dev,
                   to_char(drd.id_other_product) codigo_artigo,
                   drd.vers versao,
                   pk_medication_core.g_type_o tipo_artigo,
                   get_medication_name(i_lang,
                                       l_prof,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.flg_type,
                                       dr.id_drug_presc_det,
                                       g_yes,
                                       drd.id_other_product) descricao_artigo,
                   drsd.qty_dev,
                   drsd.qty_for_trash,
                   drsd.qty_for_stock,
                   drd.id_unit_measure_prep id_unit_dev,
                   pk_medication_core.get_unit_translation(i_lang, l_prof, drd.id_unit_measure_prep, 3) descr_unit_dev,
                   drsd.package_number lote,
                   drsd.dt_package_expire prazo_validade,
                   ep.id_clinical_service,
                   dr.id_episode,
                   dr.id_patient,
                   drsdst2.id_prof id_prof_dev,
                   drsdst.id_state state
              FROM drug_req_supply_dev drsd
             INNER JOIN drug_req_sup_dev_state_trans drsdst
                ON (drsd.id_drug_req_supply_dev = drsdst.id_drug_req_supply_dev)
             INNER JOIN drug_req_sup_dev_state_trans drsdst2
                ON (drsd.id_drug_req_supply_dev = drsdst2.id_drug_req_supply_dev)
             INNER JOIN drug_req_supply drs
                ON (drsd.id_drug_req_supply = drs.id_drug_req_supply)
             INNER JOIN drug_req_det drd
                ON (drs.id_drug_req_det = drd.id_drug_req_det)
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             INNER JOIN episode ep
                ON (dr.id_episode = ep.id_episode)
             INNER JOIN other_product op
                ON (drd.id_other_product = op.id_other_product AND drd.vers = op.vers)
             WHERE drsdst.id_state = get_state_for_req_type(l_prof, NULL, g_drs_return_end_st)
               AND drsdst2.id_state = get_state_for_req_type(l_prof, NULL, g_drs_to_return_st)
               AND drsd.id_drug_req_supply_dev = i_id_drug_req_supply_dev;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, o_error);
            pk_types.open_my_cursor(o_devs);
            RETURN FALSE;
    END get_interop_devolutions;
    --interoperability functions: END

    /********************************************************************************************
    * alert.pk_pharmacy.get_pat_dev
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_EPISODE                    IN    NUMBER(24)
    * @param  I_ID_DRUG_REQ_DET               IN    ALERT.TABLE_NUMBER
    * @param  I_GET_HEADERS                   IN
    * @param  I_HEADER_CODES                  IN
    * @param  O_DRUG                          OUT
    * @param  O_HEADERS                       OUT
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rafael Santos
    * @version  1.0
    * @since  2009-06-25
    *
    ********************************************************************************************/
    FUNCTION get_pat_dev
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN alert.profissional,
        i_id_episode      IN episode.id_episode%TYPE,
        i_id_drug_req_det IN table_number,
        i_get_headers     IN VARCHAR2 DEFAULT 'N',
        i_header_codes    IN table_varchar DEFAULT NULL,
        o_drug            OUT pk_types.cursor_type,
        o_dev_notes       OUT pk_types.cursor_type,
        o_headers         OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error := 'GET DEV NOTES';
        OPEN o_dev_notes FOR
            SELECT sd.val data, sd.desc_val label
              FROM sys_domain sd
             WHERE sd.code_domain = 'DRUG_REQ_SUPPLY_DEV.NOTES_DEV_JUSITF'
               AND sd.domain_owner = pk_sysdomain.k_default_schema
               AND sd.id_language = i_lang
               AND sd.flg_available = g_yes
             ORDER BY sd.rank;
    
        g_error := 'GET CURSOR';
        OPEN o_drug FOR
            SELECT drs.id_drug_req_det,
                   drs.id_drug_req_supply,
                   drd.id_drug,
                   drs.id_state,
                   get_drug_desc_pharm(i_lang, i_prof, i_id_episode, drd.id_drug_req_det, g_no, g_no, 'PHARMACY_FORMAT') pharm,
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.flg_type,
                                       dr.id_drug_presc_det,
                                       g_yes,
                                       drd.id_other_product) short_pharm,
                   decode(get_sum_qty_dev(i_lang, i_prof, drs.id_drug_req_supply),
                          0,
                          drs.qty_supply,
                          (drs.qty_supply - get_sum_qty_dev(i_lang, i_prof, drs.id_drug_req_supply))) qty_supply,
                   (drs.qty_supply - (SELECT SUM(drsd.qty_dev)
                                        FROM drug_req_supply_dev drsd
                                       WHERE drsd.id_drug_req_supply = drs.id_drug_req_supply)) qty_dev,
                   drd.id_unit_measure_prep id_unit_measure,
                   pk_medication_core.get_unit_translation(i_lang, i_prof, drd.id_unit_measure_prep, 3) qty_unit,
                   get_attention_pipe_str(i_lang, i_prof, drd.id_drug_req_det) attention,
                   get_icon_for_req_type(i_lang, i_prof, g_flg_adm, '') flg_type_icon,
                   drs.package_number,
                   pk_date_utils.date_send_tsz(i_lang, to_timestamp(drs.dt_expire, 'YYYYMMDDHH24MISS'), i_prof) dt_expire
              FROM drug_req_det drd, drug_req_supply drs, drug_req dr
             WHERE drd.id_drug_req_det = drs.id_drug_req_det
               AND drd.id_drug_req = dr.id_drug_req
               AND drs.id_drug_req_det IN (SELECT column_value
                                             FROM TABLE(i_id_drug_req_det))
               AND drs.id_state = get_state_for_req_type(i_prof, NULL, g_drs_supplied_st);
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_pat_dev', o_error);
            pk_types.open_my_cursor(o_drug);
            pk_types.open_my_cursor(o_headers);
            RETURN FALSE;
    END get_pat_dev;

    /********************************************************************************************
    * alert.pk_pharmacy.get_sum_qty_dev
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DRUG_REQ_SUPPLY_DEV        IN    NUMBER(24)
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rafael Santos
    * @version  1.0
    * @since  2009-07-01
    *
    ********************************************************************************************/
    FUNCTION get_sum_qty_dev
    (
        i_lang               IN language.id_language%TYPE,
        i_prof               IN alert.profissional,
        i_id_drug_req_supply IN drug_req_supply.id_drug_req_supply%TYPE
    ) RETURN NUMBER IS
    
        sum_dev NUMBER(24) := 0;
    
    BEGIN
    
        g_error := 'GET SUM_DEV';
    
        SELECT SUM(drsd.qty_dev)
          INTO sum_dev
          FROM drug_req_supply_dev drsd
         WHERE drsd.id_drug_req_supply = i_id_drug_req_supply;
    
        IF sum_dev IS NULL
        THEN
            sum_dev := 0;
        END IF;
    
        RETURN sum_dev;
    
    EXCEPTION
        WHEN OTHERS THEN
            --process_error(i_lang, sqlcode, sqlerrm, g_error, 'GET_SUM_QTY_DEV', o_error);
            RAISE;
    END get_sum_qty_dev;

    /********************************************************************************************
    * alert.pk_pharmacy.get_pat_dev_qt
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_EPISODE                    IN    NUMBER(24)
    * @param  I_ID_DRUG_REQ_SUPPLY_DEV        IN    ALERT.TABLE_NUMBER
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  O_DRUG                          OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_HEADERS_DETAILS               OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.6
    * @since  2010-01-12
    *
    ********************************************************************************************/
    FUNCTION get_pat_dev_qt
    (
        i_lang                   IN language.id_language%TYPE,
        i_prof                   IN alert.profissional,
        i_id_episode             IN episode.id_episode%TYPE,
        i_id_drug_req_supply_dev IN table_number,
        i_get_headers            IN VARCHAR2 DEFAULT 'N',
        i_header_codes           IN table_varchar DEFAULT NULL,
        o_drug                   OUT pk_types.cursor_type,
        o_headers                OUT pk_types.cursor_type,
        o_headers_details        OUT pk_types.cursor_type,
        o_error                  OUT t_error_out
    ) RETURN BOOLEAN IS
        l_header_codes table_varchar;
    BEGIN
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error        := 'GET HEADERS FOR DETAILS';
        l_header_codes := table_varchar --label list for all kind of details
                          ('PHARMACIST_DETAIL_PAT_NAME',
                           'PHARMACIST_DETAIL_PAT_BED',
                           'PHARMACIST_DETAIL_PAT_SLOT',
                           'PHARMACIST_DETAIL_PHARM_DESC',
                           'PHARMACIST_DETAIL_INST',
                           'PHARMACIST_DETAIL_ORDER_BY',
                           'PHARMACIST_DETAIL_QTY_SUPPLY',
                           'PHARMACIST_DETAIL_REQ_NOTES',
                           'PHARMACIST_DETAIL_DEV_BY',
                           'PHARMACIST_DETAIL_QTY_DEV',
                           'PHARMACIST_DETAIL_NOTES_JUSTIF',
                           'PHARMACIST_DETAIL_PACKAGE_NUMBER',
                           'PHARMACIST_DETAIL_DEV_NOTES',
                           'PHARMACIST_DETAIL_PAT_BED',
                           'PHARMACIST_DETAIL_PAT_NAME',
                           'PHARMACIST_DETAIL_PAT_SLOT',
                           'PHARMACIST_REQ_GRID_051');
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, l_header_codes, o_headers_details);
    
        g_error := 'GET CURSOR';
        OPEN o_drug FOR
            SELECT dr.id_drug_req,
                   drd.id_drug_req_det,
                   drs.id_drug_req_supply,
                   drsd.id_drug_req_supply_dev,
                   get_pat_name(i_lang, i_prof, dr.id_patient) pat_name,
                   pk_adt.get_pat_non_disc_options(i_lang, i_prof, dr.id_patient) pat_ndo,
                   pk_adt.get_pat_non_disclosure_icon(i_lang, i_prof, dr.id_patient) pat_nd_icon,
                   pk_patient.get_pat_name_to_sort(i_lang, i_prof, dr.id_patient, dr.id_episode) pat_name_to_sort,
                   get_pat_location(i_lang, i_prof, dr.id_episode, dr.id_patient, 'NO_SPACE', 'BED') pat_bed,
                   get_supply_slot(i_lang, i_prof, drs.id_drug_req_supply, 'WITH_LABEL') pat_slot,
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.flg_type,
                                       dr.id_drug_presc_det,
                                       g_yes,
                                       drd.id_other_product) pharm_desc,
                   get_drug_desc_instr(i_lang, i_prof, dr.id_episode, drd.id_drug_req_det) inst,
                   pk_prof_utils.get_name_signature(i_lang, i_prof, drdst.id_prof) order_by,
                   pk_medication_core.get_unit_translation(i_lang, i_prof, drd.id_unit_measure_prep, 3) qty_unit,
                   pk_utils.number_to_char(i_prof, drs.qty_supply) || ' ' ||
                   pk_medication_core.get_unit_translation(i_lang, i_prof, drd.id_unit_measure_prep, 3) qty_supply,
                   drs.qty_supply qty_sup,
                   pk_prof_utils.get_name_signature(i_lang, i_prof, drsdst.id_prof) dev_by,
                   pk_utils.number_to_char(i_prof, drsd.qty_dev) || ' ' ||
                   pk_medication_core.get_unit_translation(i_lang, i_prof, drd.id_unit_measure_prep, 3) qty_dev,
                   drsd.qty_dev qty_dev_sup,
                   drd.id_unit_measure_prep id_unit_measure,
                   pk_medication_core.get_unit_translation(i_lang, i_prof, drd.id_unit_measure_prep, 3) qty_unit,
                   decode(drsd.notes_dev_justif, NULL, g_null_notes, drsd.notes_dev_justif) notes_dev_justif,
                   drsd.package_number || ' ' || pk_date_utils.dt_chr(i_lang, drsd.dt_package_expire, i_prof) package_number,
                   decode(drsdst.notes1, NULL, g_null_notes, drsdst.notes1) dev_notes
              FROM drug_req_supply_dev drsd
             INNER JOIN drug_req_sup_dev_state_trans drsdst
                ON (drsd.id_drug_req_supply_dev = drsdst.id_drug_req_supply_dev)
             INNER JOIN drug_req_supply drs
                ON (drsd.id_drug_req_supply = drs.id_drug_req_supply)
             INNER JOIN drug_req_det drd
                ON (drs.id_drug_req_det = drd.id_drug_req_det)
             INNER JOIN drug_req_det_state_transition drdst
                ON (drd.id_drug_req_det = drdst.id_drug_req_det)
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
              LEFT JOIN drug_presc_det dpd
                ON (dr.id_drug_presc_det = dpd.id_drug_presc_det)
             WHERE drsd.id_drug_req_supply_dev IN
                   (SELECT column_value
                      FROM TABLE(i_id_drug_req_supply_dev))
               AND drsdst.id_state = get_state_for_req_type(i_prof, NULL, g_drs_to_return_st)
               AND drdst.id_state = get_state_for_req_type(i_prof, dr.flg_type, g_drd_requested_st);
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_pat_dev_qt', o_error);
            pk_types.open_my_cursor(o_drug);
            RETURN FALSE;
    END get_pat_dev_qt;

    /********************************************************************************************
    * alert.pk_pharmacy.set_pat_dev  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_ID_DRUG_REQ_SUPPLY            IN        ALERT.TABLE_NUMBER
    * @param  I_QTY_DEV                       IN        ALERT.TABLE_NUMBER
    * @param  I_PACKAGE_NUMBER                IN        ALERT.TABLE_VARCHAR
    * @param  I_DT_PACKAGE_EXPIRE             IN        ALERT.TABLE_VARCHAR
    * @param  I_ID_NOTE_JUSTIF                IN        ALERT.TABLE_VARCHAR
    * @param  I_NOTES_DEV_JUSTIF              IN        ALERT.TABLE_VARCHAR
    * @param  I_NOTES_DEV                     IN        ALERT.TABLE_VARCHAR
    * @param  O_ERROR                         OUT       ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.8
    * @since  2010-06-18
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION set_pat_dev
    (
        i_lang               IN language.id_language%TYPE,
        i_prof               IN alert.profissional,
        i_id_drug_req_supply IN table_number,
        i_qty_dev            IN table_number,
        i_package_number     IN table_varchar,
        i_dt_package_expire  IN table_varchar,
        i_id_note_justif     IN table_varchar,
        i_notes_dev_justif   IN table_varchar,
        i_notes_dev          IN table_varchar,
        o_error              OUT t_error_out
    ) RETURN BOOLEAN IS
        l_id_drug_req_supply_dev NUMBER(24);
        l_code_interv            VARCHAR2(24 CHAR) := 'PHARMACY_ALERT13_001';
        l_req_type               drug_req.flg_type%TYPE;
        l_id_episode             drug_req.id_episode%TYPE;
        l_flg_uni_off            drug_req_det.flg_uni_out_off_car%TYPE := g_no;
    BEGIN
    
        g_error := 'SET CURSOR DRUG_REQ_SUPPLY_DEV';
        FOR i IN 1 .. i_id_drug_req_supply.count
        LOOP
            SELECT dr.flg_type, dr.id_episode, drd.flg_uni_out_off_car
              INTO l_req_type, l_id_episode, l_flg_uni_off
              FROM drug_req_supply drs, drug_req_det drd, drug_req dr
             WHERE drs.id_drug_req_supply = i_id_drug_req_supply(i)
               AND drs.id_drug_req_det = drd.id_drug_req_det
               AND drd.id_drug_req = dr.id_drug_req
               AND rownum = 1;
        
            SELECT seq_drug_req_supply_dev.nextval
              INTO l_id_drug_req_supply_dev
              FROM dual;
        
            INSERT INTO drug_req_supply_dev
                (id_drug_req_supply_dev,
                 id_drug_req_supply,
                 qty_dev,
                 package_number,
                 dt_package_expire,
                 id_note_justif,
                 notes_dev_justif,
                 id_state)
            VALUES
                (l_id_drug_req_supply_dev,
                 i_id_drug_req_supply(i),
                 i_qty_dev(i),
                 i_package_number(i),
                 pk_date_utils.get_string_tstz(i_lang, i_prof, i_dt_package_expire(i), NULL),
                 i_id_note_justif(i),
                 i_notes_dev_justif(i),
                 get_state_for_req_type(i_prof, NULL, g_drs_to_return_st));
        
            g_error := 'SET CURSOR DRUG_REQ_SUP_DEV_STATE_TRANS';
            INSERT INTO drug_req_sup_dev_state_trans
                (id_drug_req_supply_dev, id_state, id_prof, dt_state, notes1)
            VALUES
                (l_id_drug_req_supply_dev,
                 get_state_for_req_type(i_prof, NULL, g_drs_to_return_st),
                 i_prof.id,
                 current_timestamp,
                 i_notes_dev(i));
        
            g_error := 'SET SYS_ALERT_EVENT DEV TO PHARMACY';
            IF NOT pk_alerts.insert_sys_alert_event(i_lang                => i_lang,
                                                    i_prof                => i_prof,
                                                    i_sys_alert           => 13,
                                                    i_id_episode          => l_id_episode,
                                                    i_id_record           => l_id_drug_req_supply_dev,
                                                    i_dt_record           => current_timestamp,
                                                    i_id_professional     => NULL,
                                                    i_id_room             => NULL,
                                                    i_id_clinical_service => NULL,
                                                    i_flg_type_dest       => 'C',
                                                    i_replace1            => pk_message.get_message(i_lang, l_code_interv),
                                                    o_error               => o_error)
            THEN
                raise_application_error(-20001, o_error.ora_sqlerrm);
                pk_alertlog.log_error(g_error);
            END IF;
        
            --update_grids
            IF ((l_req_type = g_flg_adm) OR (l_flg_uni_off = g_yes AND l_req_type = g_flg_unidose))
            THEN
                g_error := 'CALL TO PK_PRESCRIPTION_INT.INSERT_DRUG_REQ_TASK';
                IF NOT pk_prescription_int.insert_drug_req_task(i_lang          => i_lang,
                                                                i_episode       => l_id_episode,
                                                                i_prof          => i_prof,
                                                                i_prof_cat_type => NULL,
                                                                o_error         => o_error)
                THEN
                    raise_application_error(-20001, o_error.ora_sqlerrm);
                END IF;
            
                g_error := 'CALL TO PK_GRID.DELETE_EPIS_GRID_TASK';
                IF NOT pk_grid.delete_epis_grid_task(i_lang => i_lang, i_episode => l_id_episode, o_error => o_error)
                THEN
                    raise_application_error(-20001, o_error.ora_sqlerrm);
                END IF;
            END IF;
        
        END LOOP;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'set_pat_dev', o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_pat_dev;

    /********************************************************************************************
    * alert.pk_pharmacy.set_pat_dev_qt
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DRUG                       IN    NUMBER(24)
    * @param  O_DRUG                          OUT
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rafael Santos
    * @version  1.0
    * @since  2009-07-01
    *
    ********************************************************************************************/
    FUNCTION set_pat_dev_qt
    (
        i_lang                   IN language.id_language%TYPE,
        i_prof                   IN alert.profissional,
        i_id_drug_req_supply_dev IN drug_req_supply.id_drug_req_supply%TYPE,
        i_qty_for_stock          IN drug_req_supply_dev.qty_for_stock%TYPE,
        i_qty_for_trash          IN drug_req_supply_dev.qty_for_trash%TYPE,
        i_notes_dev              IN drug_req_sup_dev_state_trans.notes1%TYPE,
        o_error                  OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
    
        g_error := 'SET CURSOR';
    
        UPDATE drug_req_supply_dev drsd
           SET drsd.id_state      = get_state_for_req_type(i_prof, NULL, g_drs_return_end_st),
               drsd.qty_for_stock = i_qty_for_stock,
               drsd.qty_for_trash = i_qty_for_trash
         WHERE drsd.id_drug_req_supply_dev = i_id_drug_req_supply_dev;
    
        g_error := 'SET CURSOR DRUG_REQ_SUP_DEV_STATE_TRANS';
        INSERT INTO drug_req_sup_dev_state_trans
            (id_drug_req_supply_dev, id_state, id_prof, dt_state, notes1)
        VALUES
            (i_id_drug_req_supply_dev,
             get_state_for_req_type(i_prof, NULL, g_drs_return_end_st),
             i_prof.id,
             current_timestamp,
             i_notes_dev);
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'set_pat_dev_qt', o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_pat_dev_qt;

    /********************************************************************************************
    * alert.pk_pharmacy.create_unidose_for_dep
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rafael Santos
    * @version  1.0
    * @since  2009-08-21
    *
    ********************************************************************************************/
    PROCEDURE create_unidose_for_dep
    (
        i_lang IN language.id_language%TYPE,
        i_prof IN alert.profissional
    ) AS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'CREATE_UNIDOSE_FOR_DEP';
        --
    
        CURSOR c_uni IS
            SELECT dcs.id_dep_clin_serv
              FROM department d, dep_clin_serv dcs
             WHERE d.id_department = dcs.id_department
               AND d.flg_unidose = g_yes
               AND d.id_institution = decode(i_prof.institution, 0, d.id_institution, i_prof.institution)
               AND d.flg_available = g_yes
               AND dcs.flg_available = g_yes
             ORDER BY d.id_department, dcs.id_dep_clin_serv;
    
        l_error          t_error_out;
        l_dt_current     TIMESTAMP WITH LOCAL TIME ZONE := NULL;
        l_pharmacy_is_on VARCHAR2(1 CHAR) := g_no;
        l_update_count   NUMBER(1) := 0;
    
        -- ***** - ***** - ***** - ***** - ***** - ***** -
        FUNCTION is_it_time_to_run
        (
            i_lang             IN language.id_language%TYPE,
            i_prof             IN alert.profissional,
            i_id_dep_clin_serv IN dep_clin_serv.id_dep_clin_serv%TYPE
        ) RETURN BOOLEAN IS
            l_default_time_to_run    sys_config.value%TYPE := '04:00';
            l_dep_clin_serv_schedule sys_config.value%TYPE := '';
            l_go_unidose             NUMBER(1) := 0;
        BEGIN
            g_error                  := 'GET time of the day that the pharmacy orders should be generated';
            l_dep_clin_serv_schedule := pk_sysconfig.get_config('PHARMACY_UNIDOSE_DEP_CLIN_SERV_SCHEDULE__' ||
                                                                i_id_dep_clin_serv,
                                                                i_prof);
        
            IF (l_dep_clin_serv_schedule IS NULL)
            THEN
                g_error                  := 'GET default time for the institution';
                l_dep_clin_serv_schedule := nvl(pk_sysconfig.get_config('PHARMACY_UNIDOSE_INSTITUTION_SCHEDULE', i_prof),
                                                l_default_time_to_run);
            END IF;
        
            g_error      := 'compute date';
            l_dt_current := to_timestamp(to_char(current_timestamp, 'YYYY-MM-DD') || ' ' || l_dep_clin_serv_schedule,
                                         'YYYY-MM-DD HH24:MI');
        
            g_error := 'CHECK IF IT IS TIME!';
            SELECT COUNT(1)
              INTO l_go_unidose
              FROM dual
             WHERE current_timestamp BETWEEN (l_dt_current) AND (l_dt_current + INTERVAL '60' minute);
        
            RETURN(l_go_unidose = 1);
        
        EXCEPTION
            WHEN OTHERS THEN
                l_dt_current := NULL;
                process_error(i_lang, SQLCODE, SQLERRM, g_error, 'IS_IT_TIME_TO_RUN', l_error);
                RETURN FALSE;
        END is_it_time_to_run;
        -- ***** - ***** - ***** - ***** - ***** - ***** -
    BEGIN
        --
        g_error          := 'PHARMACY_ENABLED';
        l_pharmacy_is_on := nvl(pk_sysconfig.get_config('PHARMACY_ENABLED', i_prof), g_no);
        IF (l_pharmacy_is_on = g_no)
        THEN
            set_pharmacy_log(l_db_object_name, 'PHARMACY_ENABLED=FALSE!!!');
            RETURN;
        END IF;
        --
    
        g_error := 'CREATE_UNIDOSE_FOR_DEP CREATE UNIDOSE TODAY';
        set_pharmacy_log(l_db_object_name, g_error || ' NOW=' || to_char(current_timestamp, 'YYYY-MM-DD HH24:MI:SS'));
    
        FOR l_uni IN c_uni
        LOOP
            IF (is_it_time_to_run(i_lang, i_prof, l_uni.id_dep_clin_serv))
            THEN
                set_pharmacy_log(l_db_object_name,
                                 'IS_IT_TIME_TO_RUN=YES! NOW=' || to_char(current_timestamp, 'YYYY-MM-DD HH24:MI:SS') ||
                                 ' RUN@=' || to_char(l_dt_current, 'YYYY-MM-DD HH24:MI:SS') || ' DEP_CLIN_SERV=' ||
                                 l_uni.id_dep_clin_serv);
            
                IF NOT create_unidose_today(i_lang             => i_lang,
                                            i_prof             => i_prof,
                                            i_id_dep_clin_serv => l_uni.id_dep_clin_serv,
                                            i_dt_car           => current_timestamp,
                                            o_error            => l_error)
                THEN
                    set_pharmacy_log(l_db_object_name, g_error || ' - ' || l_error.err_desc);
                END IF;
            
                --activate the real time prescription -> pharmacy order
                UPDATE pharm_unidose_auto_order ao
                   SET ao.flg_auto_pharmacy_order = g_yes
                 WHERE ao.id_dep_clin_serv = l_uni.id_dep_clin_serv
                RETURNING COUNT(1) INTO l_update_count;
            
                IF (l_update_count = 0)
                THEN
                    INSERT INTO pharm_unidose_auto_order
                        (id_dep_clin_serv, flg_auto_pharmacy_order)
                    VALUES
                        (l_uni.id_dep_clin_serv, g_yes);
                END IF;
                --
            ELSE
                set_pharmacy_log(l_db_object_name,
                                 'IS_IT_TIME_TO_RUN=NO!  NOW=' || to_char(current_timestamp, 'YYYY-MM-DD HH24:MI:SS') ||
                                 ' RUN@=' || to_char(l_dt_current, 'YYYY-MM-DD HH24:MI:SS') || ' DEP_CLIN_SERV=' ||
                                 l_uni.id_dep_clin_serv);
            END IF;
        END LOOP;
    
    EXCEPTION
        WHEN OTHERS THEN
            IF (c_uni%ISOPEN)
            THEN
                CLOSE c_uni;
            END IF;
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, l_error);
    END create_unidose_for_dep;

    /********************************************************************************************
    * alert.pk_pharmacy.get_pat_search_screen
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Pedro Albuquerque
    * @version  1.0
    * @since  2009-11-04
    *
    ********************************************************************************************/
    FUNCTION get_pat_search_screen
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN profissional,
        i_get_headers  IN VARCHAR2 DEFAULT 'N',
        i_header_codes IN table_varchar DEFAULT NULL,
        o_headers      OUT pk_types.cursor_type,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_pat_search_screen', o_error);
            RETURN FALSE;
    END get_pat_search_screen;

    /********************************************************************************************
    * alert.pk_pharmacy.get_inactive_epis_warn
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Pedro Albuquerque
    * @version  1.0
    * @since  2009-11-10
    *
    ********************************************************************************************/
    FUNCTION get_inactive_epis_warn
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN profissional,
        i_get_headers  IN VARCHAR2 DEFAULT 'N',
        i_header_codes IN table_varchar DEFAULT NULL,
        o_headers      OUT pk_types.cursor_type,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_inactive_epis_warn', o_error);
            RETURN FALSE;
    END get_inactive_epis_warn;

    /********************************************************************************************
    * alert.pk_pharmacy.pharmacist_unidose_print_grid
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_REQ_TYPE                      IN    VARCHAR2
    * @param  O_REQ                           OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Pedro Albuquerque
    * @version  1.0
    * @since  2009-11-02
    *
    ********************************************************************************************/
    FUNCTION pharmacist_unidose_print_grid
    (
        i_lang     IN language.id_language%TYPE,
        i_prof     IN alert.profissional,
        i_req_type IN drug_req.flg_type%TYPE,
        o_req      OUT pk_types.cursor_type,
        o_error    OUT t_error_out
    ) RETURN BOOLEAN IS
        l_shortcut       sys_shortcut.id_sys_shortcut%TYPE;
        l_shortcut_name  sys_shortcut.intern_name%TYPE;
        l_prof_type      profile_template.flg_type%TYPE;
        l_dep_clin_servs table_number;
        l_dcs_count      NUMBER := 0;
    BEGIN
        g_error         := 'GET SHORTCUT';
        l_shortcut_name := CASE i_req_type
                               WHEN g_flg_adm THEN
                                'PHARMACIST_ADM'
                               WHEN g_flg_int THEN
                                'PHARMACIST_INT'
                               WHEN g_flg_unidose THEN
                                'PHARMACIST_UNIDOSE'
                           END;
        l_shortcut      := get_shortcut(i_lang, i_prof, l_shortcut_name);
    
        g_error     := 'GET PROF TYPE';
        l_prof_type := get_prof_type(i_prof);
    
        IF (i_req_type = g_flg_unidose)
        THEN
        
            get_allocation_for_prof(i_prof, l_dep_clin_servs);
            l_dcs_count := l_dep_clin_servs.count;
        
            g_error := 'GET CURSOR (UNIDOSE)';
            OPEN o_req FOR
                SELECT p.id_patient,
                       get_pat_name(i_lang, i_prof, p.id_patient) name,
                       p.gender,
                       pk_patient.get_pat_age(i_lang, p.id_patient, i_prof) pat_age,
                       get_pat_location(i_lang, i_prof, dr.id_episode, v1.id_patient, 1, 'FULL') pat_location,
                       get_clinical_service_id(i_lang, i_prof, dr.id_episode, v1.id_patient) clinical_service_id,
                       e.id_episode, --para o header
                       v1.car_slots,
                       decode(get_pat_location(i_lang, i_prof, dr.id_episode, v1.id_patient, 'TEXT', 'BED'),
                              NULL,
                              g_no,
                              g_yes) has_bed
                  FROM (SELECT dr.id_patient,
                               MIN(drd.id_drug_req_det) min_drd,
                               MAX(drd.id_drug_req_det) max_drd,
                               pharmacy_uni_type2varchar(pharmacy_tbl_uni_car_drawers(t_rec_pharm_uni_car_drawer(uc.id_unidose_car,
                                                                                                                 NULL,
                                                                                                                 ucm.car_model_name,
                                                                                                                 NULL))) car_slots,
                               pharmacy_min_dt_state(t_rec_pharm_state_dt_rank(nvl(drs.id_state, drd.id_state),
                                                                               nvl(drsst.dt_state, drdst.dt_state),
                                                                               nvl(wsd2.rank, wsd.rank))) st
                          FROM drug_req_det drd
                         INNER JOIN drug_req dr
                            ON (drd.id_drug_req = dr.id_drug_req)
                         INNER JOIN episode e
                            ON (dr.id_episode = e.id_episode)
                         INNER JOIN epis_info ei
                            ON (e.id_episode = ei.id_episode)
                         INNER JOIN visit v
                            ON (e.id_visit = v.id_visit)
                          LEFT JOIN pharm_unidose_slot_content usc
                            ON (drd.id_drug_req_det = usc.id_drug_req_det)
                          LEFT JOIN pharm_unidose_car_slot ucs
                            ON (usc.id_unidose_car = ucs.id_unidose_car AND usc.slot_number = ucs.slot_number)
                          LEFT JOIN pharm_unidose_car uc
                            ON (ucs.id_unidose_car = uc.id_unidose_car)
                          LEFT JOIN pharm_unidose_car_model ucm
                            ON (uc.id_car_model = ucm.id_unidose_car_model)
                         INNER JOIN wfl_state ws
                            ON (drd.id_state = ws.id_state)
                         INNER JOIN wfl_state_detail wsd
                            ON (ws.id_state = wsd.state)
                         INNER JOIN drug_req_det_state_transition drdst
                            ON (drd.id_drug_req_det = drdst.id_drug_req_det AND drd.id_state = drdst.id_state)
                          LEFT JOIN drug_req_supply drs
                            ON (drd.id_drug_req_det = drs.id_drug_req_det AND
                               drs.id_state IN
                               (SELECT column_value
                                   FROM TABLE(get_states_for_req_type(i_prof, NULL, g_grid_pat_drs_adm_states))))
                          LEFT JOIN drug_req_sup_state_transition drsst
                            ON (drs.id_drug_req_supply = drsst.id_drug_req_supply AND drs.id_state = drsst.id_state)
                          LEFT JOIN wfl_state ws2
                            ON (drs.id_state = ws2.id_state)
                          LEFT JOIN wfl_state_detail wsd2
                            ON (ws2.id_state = wsd2.state AND wsd2.prof_type = l_prof_type)
                         WHERE dr.flg_type = i_req_type
                           AND v.id_institution = i_prof.institution
                           AND v.flg_status != 'C' -- not canceled
                           AND e.flg_status = 'A' -- active episode
                           AND wsd.prof_type = l_prof_type
                           AND drd.id_state IN
                               (SELECT column_value
                                  FROM TABLE(get_grid_allowed_states(i_prof, i_req_type, 'GRID_1')))
                           AND get_grid_timeout(drd.id_state, i_prof, 'D') >
                               pk_date_utils.get_timestamp_diff(current_timestamp, drdst.dt_state)
                              --filter orders by id_dep_clin_server (pharmacist allocation to departments/services)
                           AND (l_dcs_count = 0 OR ei.id_dep_clin_serv IS NULL OR
                               ei.id_dep_clin_serv IN (SELECT column_value
                                                          FROM TABLE(l_dep_clin_servs)))
                        --
                         GROUP BY dr.id_patient) v1,
                       patient p,
                       drug_req_det min_drd,
                       drug_req_det max_drd,
                       drug_req dr,
                       drug_req min_dr,
                       drug_req max_dr,
                       episode e,
                       wfl_state ws,
                       wfl_state_detail wsd
                 WHERE v1.id_patient = p.id_patient
                   AND v1.max_drd = max_drd.id_drug_req_det
                   AND v1.min_drd = min_drd.id_drug_req_det
                   AND min_drd.id_drug_req = dr.id_drug_req
                   AND dr.id_episode = e.id_episode
                   AND max_drd.id_drug_req = max_dr.id_drug_req
                   AND min_drd.id_drug_req = min_dr.id_drug_req
                   AND v1.st.state = ws.id_state
                   AND ws.id_state = wsd.state
                   AND wsd.prof_type = l_prof_type
                 ORDER BY wsd.rank, min_dr.dt_drug_req_tstz, v1.st.dt_state, name;
        
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'PHARMACIST_UNIDOSE_PRINT_GRID', o_error);
            pk_types.open_my_cursor(o_req);
            RETURN FALSE;
    END pharmacist_unidose_print_grid;

    /********************************************************************************************
    * alert.pk_pharmacy.get_clinical_service_id
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_ID_EPISODE                    IN    NUMBER(24)
    * @param  I_ID_PATIENT                    IN    NUMBER(24)
    *
    * @return NUMBER
    *
    * @author Pedro Albuquerque
    * @version  1.0
    * @since  2009-11-12
    *
    ********************************************************************************************/
    FUNCTION get_clinical_service_id
    (
        i_lang       IN language.id_language%TYPE,
        i_prof       IN alert.profissional,
        i_id_episode IN episode.id_episode%TYPE,
        i_id_patient IN patient.id_patient%TYPE
    ) RETURN NUMBER IS
        l_location  pk_translation.t_desc_translation;
        l_dept_id   dept.id_dept%TYPE;
        l_episode   episode.id_episode%TYPE;
        l_separator VARCHAR2(10 CHAR);
        --bed
        l_error         t_error_out;
        l_ret_out       BOOLEAN := TRUE;
        l_c_beds        pk_types.cursor_type;
        l_id_department bmng_bed_ea.id_department%TYPE;
        l_desc_service  pk_translation.t_desc_translation;
        l_id_room       bmng_bed_ea.id_room%TYPE;
        l_desc_room     pk_translation.t_desc_translation;
        l_id_bed        bmng_bed_ea.id_bed%TYPE;
        l_desc_bed      pk_translation.t_desc_translation;
        l_flg_bed_type  bmng_bed_ea.flg_bed_type%TYPE;
    BEGIN
        --TBD: change this function to use the pk_bmng_pbl.get_epis_bed_allocation or another pk_bmng_pbl function.
        l_location := '';
        l_episode  := i_id_episode;
        l_dept_id  := NULL;
    
        IF (l_episode IS NULL)
        THEN
            BEGIN
                SELECT MAX(e.id_episode)
                  INTO l_episode
                  FROM episode e
                 WHERE e.id_patient = i_id_patient
                   AND e.flg_status = 'A'; --active
            EXCEPTION
                WHEN no_data_found THEN
                    raise_application_error(-20001, 'episode id?');
            END;
        END IF;
        BEGIN
        
            SELECT cs.id_clinical_service
              INTO l_dept_id
              FROM episode e, clinical_service cs
             WHERE e.id_episode = i_id_episode
               AND e.id_clinical_service = cs.id_clinical_service
               AND rownum = 1;
        
        EXCEPTION
            WHEN no_data_found THEN
                l_dept_id := NULL;
        END;
    
        RETURN l_dept_id;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_clinical_service_id;

    /********************************************************************************************
    * alert.pk_pharmacy.get_uni_car_edit_print_tool
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_CAR                        IN    NUMBER(24)
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  O_CAR_PATIENTS                  OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Pedro Albuquerque
    * @version  1.0
    * @since  2009-11-11
    *
    ********************************************************************************************/
    FUNCTION get_uni_car_edit_print_tool
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN alert.profissional,
        i_id_car       IN pharm_unidose_car.id_unidose_car%TYPE,
        i_get_headers  IN VARCHAR2 DEFAULT 'N',
        i_header_codes IN table_varchar DEFAULT NULL,
        i_get_options  IN VARCHAR2 DEFAULT 'N',
        o_car_patients OUT pk_types.cursor_type,
        o_headers      OUT pk_types.cursor_type,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
        l_prof_type profile_template.flg_type%TYPE;
    BEGIN
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error     := 'GET PROF TYPE';
        l_prof_type := get_prof_type(i_prof);
    
        OPEN o_car_patients FOR
            SELECT p.id_patient,
                   get_pat_name(i_lang, i_prof, p.id_patient) name,
                   --p.gender,
                   dr.id_episode,
                   --to_char(sysdate, 'DD-MM-YY HH24:MI') date_impr,
                   --pk_patient.get_pat_age(i_lang, p.id_patient, i_prof) pat_age,
                   --get_pat_location(i_lang, i_prof, dr.id_episode, p.id_patient, null, 'BED') bed, --get patient bed
                   get_pat_location(i_lang, i_prof, dr.id_episode, p.id_patient, NULL, 'CLIN_SERV') clin_serv --,
            --get_pat_location(i_lang, i_prof, dr.id_episode, p.id_patient, null, 'ROOM_BED') full1,
            --get_pat_location(i_lang, i_prof, dr.id_episode, p.id_patient, null, 'DEP_SER_SPE') dep_ser_spe,
            --get_pat_clin_record(i_lang, p.id_patient, i_prof.institution) num_clin_record
              FROM (SELECT v1.id_patient, v1.id_unidose_car, v1.id_drug_req_det
                      FROM (
                            --orders allocated to slots of the car
                            SELECT ucs1.id_unidose_car, ucs1.id_patient, usc1.slot_number, usc1.id_drug_req_det
                              FROM pharm_unidose_car_slot ucs1, pharm_unidose_slot_content usc1
                             WHERE ucs1.id_unidose_car = i_id_car
                               AND ucs1.id_unidose_car = usc1.id_unidose_car
                               AND ucs1.slot_number = usc1.slot_number
                               AND rownum = 1
                            UNION ALL
                            --orders allocated to car, but not to slots
                            SELECT ucc2.id_unidose_car, dr2.id_patient, NULL slot_number, ucc2.id_drug_req_det
                              FROM pharm_unidose_car_content ucc2, drug_req_det drd2, drug_req dr2
                             WHERE ucc2.id_unidose_car = i_id_car
                               AND ucc2.id_drug_req_det = drd2.id_drug_req_det
                               AND drd2.id_drug_req = dr2.id_drug_req
                               AND rownum = 1) v1
                     GROUP BY v1.id_patient, v1.id_unidose_car, v1.id_drug_req_det) v2,
                   patient p,
                   pharm_unidose_car uc,
                   dep_clin_serv dcs,
                   clinical_service cs,
                   pharm_unidose_car_model ucm,
                   drug_req dr,
                   drug_req_det drd,
                   episode e
             WHERE v2.id_patient = p.id_patient
               AND v2.id_unidose_car = uc.id_unidose_car
               AND uc.id_car_model = ucm.id_unidose_car_model
               AND ucm.id_dep_clin_serv = dcs.id_dep_clin_serv
               AND dcs.id_clinical_service = cs.id_clinical_service
               AND drd.id_drug_req_det = v2.id_drug_req_det
               AND drd.id_drug_req = dr.id_drug_req
               AND dr.id_patient = p.id_patient
               AND dr.id_episode = e.id_episode;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'get_uni_car_edit_print_tool', o_error);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_car_patients);
            RETURN FALSE;
    END get_uni_car_edit_print_tool;

    /********************************************************************************************
    * alert.pk_pharmacy.get_info_for_print_tool
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_PATIENT                    IN    TABLE_NUMBER
    * @param  I_ID_EPISODE                    IN    TABLE_NUMBER
    * @param  O_INFO_LABEL                  OUT   TABLE_VARCHAR
    * @param  O_PRINTER                   OUT   VARCHAR2
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Pedro Albuquerque
    * @version  1.0
    * @since  2009-11-12
    *
    ********************************************************************************************/
    FUNCTION get_info_for_print_tool
    (
        i_lang       IN language.id_language%TYPE,
        i_prof       IN alert.profissional,
        i_id_patient IN table_number,
        i_id_episode IN table_number,
        o_label      OUT table_varchar,
        o_printer    OUT VARCHAR2,
        o_error      OUT t_error_out
    ) RETURN BOOLEAN IS
        l_prof_type    profile_template.flg_type%TYPE;
        l_barcode_med  sys_config.value%TYPE;
        l_barcode_conf sys_config.id_sys_config%TYPE := 'BARCODE_MEDICATION';
        l_printer      sys_config.id_sys_config%TYPE := 'BARCODE_PRINTER_HARV';
        --
    
        l_name_tbl                 table_varchar := table_varchar();
        l_gender_tbl               table_varchar := table_varchar();
        l_episode_tbl              table_number := table_number();
        l_episode_desc_tbl         table_varchar := table_varchar();
        l_barcode_tbl              table_varchar := table_varchar();
        l_date_impr_tbl            table_varchar := table_varchar();
        l_pat_age_tbl              table_varchar := table_varchar();
        l_room_tbl                 table_varchar := table_varchar();
        l_room_desc_tbl            table_varchar := table_varchar();
        l_dep_tbl                  table_varchar := table_varchar();
        l_dep_desc_tbl             table_varchar := table_varchar();
        l_ser_spe_tbl              table_varchar := table_varchar();
        l_ser_spe_desc_tbl         table_varchar := table_varchar();
        l_num_clin_record_tbl      table_varchar := table_varchar();
        l_num_clin_record_desc_tbl table_varchar := table_varchar();
        l_label                    table_varchar := table_varchar();
        l_bed_tbl                  table_varchar := table_varchar();
        l_bed_desc_tbl             table_varchar := table_varchar();
    
    BEGIN
    
        l_barcode_med := pk_sysconfig.get_config(i_code_cf => l_barcode_conf, i_prof => i_prof);
        o_printer     := pk_sysconfig.get_config(i_code_cf => l_printer, i_prof => i_prof);
    
        SELECT get_pat_name(i_lang, i_prof, p.id_patient) name,
               p.gender,
               e.id_episode,
               pk_message.get_message(i_lang, 'PHARMACY_PRINT_TOOL_EPIS') episode_desc,
               pk_barcode.get_pat_barcode(i_lang, i_prof, e.id_episode, e.id_patient, e.barcode, cr.num_clin_record),
               to_char(SYSDATE, 'DD-MM-YY HH24:MI') date_impr,
               pk_patient.get_pat_age(i_lang, p.id_patient, i_prof) pat_age,
               get_pat_location(i_lang, i_prof, e.id_episode, p.id_patient, 'NO_SPACE', 'ROOM') room,
               pk_message.get_message(i_lang, 'PHARMACY_PRINT_TOOL_ROOM') room_desc,
               get_pat_location(i_lang, i_prof, e.id_episode, p.id_patient, 'NO_SPACE', 'DEP') dep,
               pk_message.get_message(i_lang, 'PHARMACY_PRINT_TOOL_DEP') dep_desc,
               get_pat_location(i_lang, i_prof, e.id_episode, p.id_patient, 'NO_SPACE', 'SER_ABBREV') clin_serv,
               pk_message.get_message(i_lang, 'PHARMACY_PRINT_TOOL_SER') clin_serv_desc,
               get_pat_clin_record(i_lang, p.id_patient, i_prof.institution) num_clin_record,
               pk_message.get_message(i_lang, 'PHARMACY_PRINT_TOOL_PROC') num_clin_record_desc,
               get_pat_location(i_lang, i_prof, e.id_episode, p.id_patient, 'NO_SPACE', 'BED') room,
               pk_message.get_message(i_lang, 'PHARMACY_PRINT_TOOL_BED') room_desc
          BULK COLLECT
          INTO l_name_tbl,
               l_gender_tbl,
               l_episode_tbl,
               l_episode_desc_tbl,
               l_barcode_tbl,
               l_date_impr_tbl,
               l_pat_age_tbl,
               l_room_tbl,
               l_room_desc_tbl,
               l_dep_tbl,
               l_dep_desc_tbl,
               l_ser_spe_tbl,
               l_ser_spe_desc_tbl,
               l_num_clin_record_tbl,
               l_num_clin_record_desc_tbl,
               l_bed_tbl,
               l_bed_desc_tbl
          FROM patient p
         INNER JOIN episode e
            ON (p.id_patient = e.id_patient)
          LEFT JOIN clin_record cr
            ON (p.id_patient = cr.id_patient)
         WHERE e.id_episode IN (SELECT column_value
                                  FROM TABLE(i_id_episode))
           AND cr.id_institution = i_prof.institution;
    
        FOR i IN 1 .. l_name_tbl.count
        LOOP
            l_barcode_med := pk_sysconfig.get_config(i_code_cf => l_barcode_conf, i_prof => i_prof);
            l_label.extend;
            l_label(i) := REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(l_barcode_med,
                                                                                                  '@9',
                                                                                                  l_ser_spe_desc_tbl(i) || ': ' ||
                                                                                                  l_ser_spe_tbl(i)),
                                                                                          '@8',
                                                                                          l_num_clin_record_desc_tbl(i) || ': ' ||
                                                                                          l_num_clin_record_tbl(i)),
                                                                                  '@7',
                                                                                  l_episode_desc_tbl(i) || ': ' ||
                                                                                  l_episode_tbl(i)),
                                                                          '@6',
                                                                          l_dep_desc_tbl(i) || ': ' || l_dep_tbl(i)),
                                                                  '@5',
                                                                  l_room_desc_tbl(i) || ' ' || l_room_tbl(i)),
                                                          '@4',
                                                          l_gender_tbl(i) || '/' || l_pat_age_tbl(i)),
                                                  '@3',
                                                  l_name_tbl(i)),
                                          '@2',
                                          l_bed_desc_tbl(i) || ' ' || l_bed_tbl(i)),
                                  '@1',
                                  l_barcode_tbl(i));
        END LOOP;
    
        o_label := l_label;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'get_info_for_print_tool', o_error);
            RETURN FALSE;
    END get_info_for_print_tool;

    /********************************************************************************************
    * alert.pk_pharmacy.get_automated_reports_screen
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_INFO              OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Pedro Albuquerque
    * @version  1.0
    * @since  2009-11-13
    *
    ********************************************************************************************/
    FUNCTION get_automated_reports_screen
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN alert.profissional,
        i_get_headers  IN VARCHAR2 DEFAULT 'N',
        i_header_codes IN table_varchar DEFAULT NULL,
        o_headers      OUT pk_types.cursor_type,
        o_info         OUT pk_types.cursor_type,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
        l_prof_type profile_template.flg_type%TYPE;
    BEGIN
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error := 'GET_UNIDOSE_DEPARTMENTS';
        IF NOT get_unidose_services(i_lang => i_lang, i_prof => i_prof, o_info => o_info, o_error => o_error)
        THEN
            raise_application_error(-20001, o_error.ora_sqlerrm);
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'get_automated_reports_screen', o_error);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_info);
            RETURN FALSE;
    END get_automated_reports_screen;

    /********************************************************************************************
    * alert.pk_pharmacy.get_unidose_services
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  O_INFO                          OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.3
    * @since  2009-11-26
    *
    ********************************************************************************************/
    FUNCTION get_unidose_services
    (
        i_lang  IN language.id_language%TYPE,
        i_prof  IN alert.profissional,
        o_info  OUT pk_types.cursor_type,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
        l_prof_type profile_template.flg_type%TYPE;
    BEGIN
    
        OPEN o_info FOR
            SELECT dcs.id_dep_clin_serv,
                   pk_translation.get_translation(i_lang, cs.code_clinical_service) clin_serv_desc
              FROM dep_clin_serv dcs, clinical_service cs, department d
             WHERE dcs.id_clinical_service = cs.id_clinical_service
               AND dcs.id_department = d.id_department
               AND d.flg_unidose = g_yes
               AND d.flg_available = g_yes
               AND dcs.flg_available = g_yes
               AND cs.flg_available = g_yes
               AND d.id_institution = i_prof.institution
             ORDER BY clin_serv_desc;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'get_unidose_departments', o_error);
            pk_types.open_my_cursor(o_info);
            RETURN FALSE;
    END get_unidose_services;

    /********************************************************************************************
    * alert.pk_pharmacy.physician_co_sign_grid
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_EPISODE                    IN    NUMBER(24)
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  I_GET_ACTIONS                   IN    VARCHAR2
    * @param  O_REQ                           OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_ACTIONS                       OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.6
    * @since  2010-01-21
    *
    ********************************************************************************************/
    FUNCTION physician_co_sign_grid
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN alert.profissional,
        i_id_episode   IN drug_req.id_episode%TYPE,
        i_get_headers  IN VARCHAR2 DEFAULT 'N',
        i_header_codes IN table_varchar DEFAULT NULL,
        i_get_actions  IN VARCHAR2 DEFAULT 'N',
        o_req          OUT pk_types.cursor_type,
        o_headers      OUT pk_types.cursor_type,
        o_actions      OUT pk_types.cursor_type,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
        l_sep                VARCHAR2(5 CHAR) := '<br/>';
        l_pipe               VARCHAR2(1 CHAR) := '|';
        l_text_color_delayed VARCHAR2(10 CHAR) := '0xEBEBC8';
        l_text_color_early   VARCHAR2(10 CHAR) := '0x787864';
        l_icon_waiting       VARCHAR2(15 CHAR) := 'WaitingIcon';
        l_icon_check         VARCHAR2(15 CHAR) := 'CheckIcon';
        l_current_tstz       TIMESTAMP WITH LOCAL TIME ZONE;
    BEGIN
        l_current_tstz := current_timestamp;
    
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        IF (i_get_actions = g_yes)
        THEN
            g_error := 'GET ACTIONS';
            OPEN o_actions FOR
                SELECT sd.val id_action, sd.desc_val desc_action, NULL icon, NULL flg_type, NULL from_state
                  FROM sys_domain sd
                 WHERE sd.code_domain = 'PHARMACY_PHYSICIAN_CO_SIGN'
                   AND sd.domain_owner = pk_sysdomain.k_default_schema
                   AND sd.id_language = i_lang
                 ORDER BY sd.rank;
        ELSE
            pk_types.open_my_cursor(o_actions);
        END IF;
    
        g_error := 'QUERY';
        OPEN o_req FOR
            SELECT drd.id_drug_req_det,
                   ctype.icon order_type_icon,
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.flg_type,
                                       dr.id_drug_presc_det,
                                       g_yes,
                                       drd.id_other_product) desc_co_sign,
                   get_drug_desc_instr(i_lang, i_prof, dr.id_episode, drd.id_drug_req_det) desc_co_sign_det,
                   pk_prof_utils.get_name(i_lang, drdst1.id_prof) nick_name,
                   pk_date_utils.date_send_tsz(i_lang, drdst1.dt_state, i_prof) dt_order_co_sign,
                   --
                   '' || l_pipe || decode(drd.flg_co_sign_ok, g_no, 'DI', 'I') || l_pipe ||
                   pk_date_utils.date_send_tsz(i_lang, current_timestamp, i_prof) || l_pipe || '' || l_pipe ||
                   decode(drd.flg_co_sign_ok, g_no, l_icon_waiting, l_icon_check) || l_pipe ||
                   decode(drd.flg_co_sign_ok, g_no, '', '') || l_pipe ||
                   decode(drd.flg_co_sign_ok, 'Y', 'SmallWorkflowTime', 'StatusMessage') || l_pipe ||
                   decode(drd.flg_co_sign_ok, g_no, l_text_color_delayed, l_text_color_early) || l_pipe || '' || l_pipe ||
                   l_current_tstz desc_stat,
                   --
                   drd.flg_co_sign_ok flg_co_sign,
                   NULL with_notes,
                   NULL co_sign_type,
                   'PHARMACY' flg_type,
                   decode(drd.notes_co_sign_ok, NULL, '', pk_message.get_message(i_lang, 'CO_SIGN_M002')) with_notes
              FROM drug_req_det drd
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             INNER JOIN drug_req_det_state_transition drdst1
                ON (drd.id_drug_req_det = drdst1.id_drug_req_det AND
                   drdst1.id_state = get_state_for_req_type(i_prof, dr.flg_type, g_drd_validated_sign_st))
              LEFT JOIN (SELECT ot.id_order_type,
                                pk_translation.get_translation(i_lang, ot.code_order_type) label,
                                ot.icon_name icon
                           FROM order_type ot
                         UNION ALL
                         SELECT -1 id_order_type,
                                pk_message.get_message(i_lang, 'COMMON_M036') desc_order_type,
                                NULL icon
                           FROM dual) ctype
                ON (drd.id_type_co_sign = ctype.id_order_type)
             WHERE drd.flg_co_sign = g_yes
               AND drd.id_prof_co_sign = i_prof.id
               AND dr.id_episode = i_id_episode
             ORDER BY drd.flg_co_sign_ok, drdst1.dt_state;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'physician_co_sign_grid', o_error);
            pk_types.open_my_cursor(o_req);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_actions);
            RETURN FALSE;
    END physician_co_sign_grid;

    /********************************************************************************************
    * alert.pk_pharmacy.get_pat_check_cosigns_pend
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_EPISODE                    IN    NUMBER(24)
    * @param  I_ID_PATIENT                    IN    NUMBER(24)
    *
    * @return NUMBER
    *
    * @author Rui Marante
    * @version  2.5.0.7.7
    * @since  2010-03-12
    *
    * @notes  ALERT-75431: check if patient has co-signs not validated by the physician
    ********************************************************************************************/
    FUNCTION get_pat_check_cosigns_pend
    (
        i_lang       IN language.id_language%TYPE,
        i_prof       IN alert.profissional,
        i_id_episode IN drug_req.id_episode%TYPE,
        i_id_patient IN drug_req.id_patient%TYPE
    ) RETURN NUMBER -- 1 | 0
     IS
        l_count NUMBER := 0;
    BEGIN
        g_error := 'query';
        SELECT COUNT(1)
          INTO l_count
          FROM drug_req_det drd
         INNER JOIN drug_req dr
            ON (drd.id_drug_req = dr.id_drug_req)
         INNER JOIN drug_req_det_state_transition drdst1
            ON (drd.id_drug_req_det = drdst1.id_drug_req_det AND
               drdst1.id_state = get_state_for_req_type(i_prof, dr.flg_type, g_drd_validated_sign_st))
         WHERE drd.flg_co_sign = g_yes
           AND drd.flg_co_sign_ok != g_yes
           AND dr.id_episode = i_id_episode
           AND dr.id_patient = i_id_patient
           AND rownum = 1;
    
        RETURN l_count;
    
    EXCEPTION
        WHEN OTHERS THEN
            set_pharmacy_log('get_pat_check_cosigns_pend', 'ERROR!: ' || SQLERRM);
            RAISE;
    END get_pat_check_cosigns_pend;

    /********************************************************************************************
    * alert.pk_pharmacy.set_physician_co_sign
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DRD                        IN    ALERT.TABLE_NUMBER
    * @param  I_NOTES                         IN    ALERT.TABLE_VARCHAR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.7
    * @since  2010-03-11
    *
    ********************************************************************************************/
    FUNCTION set_physician_co_sign
    (
        i_lang   IN language.id_language%TYPE,
        i_prof   IN alert.profissional,
        i_id_drd IN table_number,
        i_notes  IN table_varchar,
        o_error  OUT t_error_out
    ) RETURN BOOLEAN IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'set_physician_co_sign';
    BEGIN
        g_error := 'SET_PHYSICIAN_CO_SIGN';
        FOR i IN 1 .. i_id_drd.count
        LOOP
            UPDATE drug_req_det drd
               SET drd.flg_co_sign_ok = g_yes, drd.dt_co_sign_ok = current_timestamp, drd.notes_co_sign_ok = i_notes(i)
             WHERE drd.id_drug_req_det = i_id_drd(i);
        
            IF NOT pk_co_sign.remove_co_sign_task(i_lang     => i_lang,
                                                  i_prof     => i_prof,
                                                  i_episode  => get_episode_drug_req_det(i_id_drd(i)),
                                                  i_id_task  => i_id_drd(i),
                                                  i_flg_type => 'DD', -- drug_req_det na tabela co_sign_task
                                                  o_error    => o_error)
            THEN
                set_pharmacy_log(l_db_object_name, g_error);
                RAISE g_ex_co_sign_task;
            END IF;
        
        END LOOP;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'set_physician_co_sign', o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_physician_co_sign;

    /********************************************************************************************
    * alert.pk_pharmacy.get_co_sign_details
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_DRUG_REQ_DET                  IN    NUMBER(24)
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  O_CO_SIGN_DETAILS               OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_HEADERS_DETAILS               OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.6
    * @since  2010-01-22
    *
    ********************************************************************************************/
    FUNCTION get_co_sign_details
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN alert.profissional,
        i_drug_req_det    IN drug_req_det.id_drug_req_det%TYPE,
        i_get_headers     IN VARCHAR2 DEFAULT 'N',
        i_header_codes    IN table_varchar DEFAULT NULL,
        o_co_sign_details OUT pk_types.cursor_type,
        o_headers         OUT pk_types.cursor_type,
        o_headers_details OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
        l_header_codes table_varchar;
    BEGIN
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error        := 'GET HEADERS FOR DETAILS';
        l_header_codes := table_varchar('PHARMACIST_DETAIL_OLD_MED',
                                        'PHARMACIST_DETAIL_OLD_INSTR',
                                        'PHARMACIST_DETAIL_OLD_DT_INI',
                                        'PHARMACIST_DETAIL_OLD_DT_EDN',
                                        'PHARMACIST_DETAIL_PRESCRIBED_BY',
                                        'PHARMACIST_DETAIL_DT_REQ',
                                        'PHARMACIST_DETAIL_NEW_MED',
                                        'PHARMACIST_DETAIL_NEW_INSTR',
                                        'PHARMACIST_DETAIL_NEW_DT_INI',
                                        'PHARMACIST_DETAIL_NEW_DT_END',
                                        'PHARMACIST_DETAIL_DT_CO_SIGN',
                                        'PHARMACIST_DETAIL_REQUESTED_BY',
                                        'PHARMACIST_DETAIL_DT_REQUEST',
                                        'PHARMACIST_DETAIL_PROF_NAME_CO_SIGN',
                                        'PHARMACIST_DETAIL_TYPE_CO_SIGN',
                                        'PHARMACIST_DETAIL_NOTES_CO_SIGN');
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, l_header_codes, o_headers_details);
    
        --details
        g_error := 'QUERY';
        OPEN o_co_sign_details FOR
            SELECT get_medication_name(i_lang,
                                       i_prof,
                                       drdhm.id_drug,
                                       drdhm.vers,
                                       dr.flg_type,
                                       dr.id_drug_presc_det,
                                       g_yes,
                                       drdhm.id_other_product) old_med,
                   get_drug_desc_instr(i_lang, i_prof, dr.id_episode, drd.id_drug_req_det, drdhm.id_presc_directions) old_instr,
                   pk_date_utils.date_send_tsz(i_lang, dpd.dt_begin_tstz, i_prof) old_dt_ini,
                   pk_date_utils.date_send_tsz(i_lang, dpd.dt_end_tstz, i_prof) old_dt_edn,
                   --
                   pk_prof_utils.get_name(i_lang, dp.id_professional) prescribed_by,
                   pk_date_utils.date_send_tsz(i_lang, drdst1.dt_state, i_prof) dt_req,
                   --
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.flg_type,
                                       dr.id_drug_presc_det,
                                       g_yes,
                                       drd.id_other_product) new_med,
                   get_drug_desc_instr(i_lang, i_prof, dr.id_episode, drd.id_drug_req_det) new_instr,
                   pk_date_utils.date_send_tsz(i_lang, dpd.dt_begin_tstz, i_prof) new_dt_ini,
                   pk_date_utils.date_send_tsz(i_lang, dpd.dt_end_tstz, i_prof) new_dt_end,
                   --
                   pk_prof_utils.get_name(i_lang, drd.id_prof_co_sign) prof_name_co_sign,
                   pk_date_utils.date_send_tsz(i_lang, drd.dt_co_sign_ok, i_prof) dt_co_sign,
                   ctype.label || format_notes(table_varchar(drd.notes_co_sign), g_no, g_no, ' / ') type_co_sign,
                   drd.notes_co_sign_ok notes_co_sign,
                   --
                   pk_prof_utils.get_name(i_lang, drdhm.id_prof_modify) requested_by,
                   pk_date_utils.date_send_tsz(i_lang, drdhm.dt_modified, i_prof) dt_request
              FROM drug_req_det_hist_modif drdhm
             INNER JOIN drug_req_det drd
                ON (drdhm.id_drug_req_det = drd.id_drug_req_det)
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
              LEFT JOIN drug_presc_det dpd
                ON (dr.id_drug_presc_det = dpd.id_drug_presc_det)
              LEFT JOIN drug_prescription dp
                ON (dpd.id_drug_prescription = dp.id_drug_prescription)
             INNER JOIN drug_req_det_state_transition drdst1
                ON (drd.id_drug_req_det = drdst1.id_drug_req_det AND
                   drdst1.id_state = get_state_for_req_type(i_prof, dr.flg_type, g_drd_requested_st))
              LEFT JOIN (SELECT ot.id_order_type,
                                pk_translation.get_translation(i_lang, ot.code_order_type) label,
                                ot.icon_name icon
                           FROM order_type ot
                         UNION ALL
                         SELECT -1 id_order_type,
                                pk_message.get_message(i_lang, 'COMMON_M036') desc_order_type,
                                NULL icon
                           FROM dual) ctype
                ON (drd.id_type_co_sign = ctype.id_order_type)
             WHERE drdhm.id_drug_req_det = i_drug_req_det
            UNION ALL
            SELECT
            -- old medication block
             get_medication_name(i_lang,
                                 i_prof,
                                 drd_old.id_drug,
                                 drd_old.vers,
                                 dr_old.flg_type,
                                 dr_old.id_drug_presc_det,
                                 g_yes,
                                 drd_old.id_other_product) old_med,
             get_drug_desc_instr(i_lang,
                                 i_prof,
                                 dr_old.id_episode,
                                 drd_old.id_drug_req_det,
                                 drd_old.id_presc_directions) old_instr,
             pk_date_utils.date_send_tsz(i_lang, dpd_old.dt_begin_tstz, i_prof) old_dt_ini,
             pk_date_utils.date_send_tsz(i_lang, dpd_old.dt_end_tstz, i_prof) old_dt_edn,
             -- who prescribed 
             pk_prof_utils.get_name(i_lang, dp_old.id_professional) prescribed_by,
             pk_date_utils.date_send_tsz(i_lang, drdst.dt_state, i_prof) dt_req,
             -- new medication block
             get_medication_name(i_lang,
                                 i_prof,
                                 drd_new.id_drug,
                                 drd_new.vers,
                                 dr_new.flg_type,
                                 dr_new.id_drug_presc_det,
                                 g_yes,
                                 drd_new.id_other_product) new_med,
             get_drug_desc_instr(i_lang, i_prof, dr_new.id_episode, drd_new.id_drug_req_det) new_instr,
             pk_date_utils.date_send_tsz(i_lang, dpd_new.dt_begin_tstz, i_prof) new_dt_ini,
             pk_date_utils.date_send_tsz(i_lang, dpd_new.dt_end_tstz, i_prof) new_dt_end,
             -- co_sign details
             pk_prof_utils.get_name(i_lang, drd_new.id_prof_co_sign) prof_name_co_sign,
             pk_date_utils.date_send_tsz(i_lang, drd_new.dt_co_sign_ok, i_prof) dt_co_sign,
             pk_translation.get_translation(i_lang, ot.code_order_type) ||
             format_notes(table_varchar(drd_new.notes_co_sign), g_no, g_no, ' / ') type_co_sign,
             drd_new.notes_co_sign_ok notes_co_sign,
             -- who ordered 
             pk_prof_utils.get_name(i_lang, pds.id_prof) requested_by,
             pk_date_utils.date_send_tsz(i_lang, pds.dt_drd_switch, i_prof) dt_request
              FROM pharm_drd_switch pds
             INNER JOIN drug_req_det drd_old
                ON (pds.id_drug_req_det_old = drd_old.id_drug_req_det)
             INNER JOIN drug_req dr_old
                ON (drd_old.id_drug_req = dr_old.id_drug_req)
              LEFT JOIN drug_presc_det dpd_old
                ON (dr_old.id_drug_presc_det = dpd_old.id_drug_presc_det)
              LEFT JOIN drug_prescription dp_old
                ON (dpd_old.id_drug_prescription = dp_old.id_drug_prescription)
             INNER JOIN drug_req_det drd_new
                ON (pds.id_drug_req_det_new = drd_new.id_drug_req_det)
             INNER JOIN drug_req dr_new
                ON (drd_new.id_drug_req = dr_new.id_drug_req)
              LEFT JOIN order_type ot
                ON (drd_new.id_type_co_sign = ot.id_order_type)
              LEFT JOIN drug_presc_det dpd_new
                ON (dr_new.id_drug_presc_det = dpd_new.id_drug_presc_det)
              LEFT JOIN drug_prescription dp_new
                ON (dpd_new.id_drug_prescription = dp_new.id_drug_prescription)
             INNER JOIN drug_req_det_state_transition drdst
                ON (drd_new.id_drug_req_det = drdst.id_drug_req_det)
             INNER JOIN wfl_state s
                ON (drdst.id_state = s.id_state)
             WHERE pds.id_drug_req_det_new = i_drug_req_det
               AND drdst.id_state = get_state_for_req_type(i_prof, dr_new.flg_type, g_drd_requested_st);
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_co_sign_details', o_error);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_headers_details);
            pk_types.open_my_cursor(o_co_sign_details);
            RETURN FALSE;
    END get_co_sign_details;

    /********************************************************************************************
    * alert.pk_pharmacy.get_departments
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  O_INFO                      OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Pedro Albuquerque
    * @version  1.0
    * @since  2009-11-13
    *
    ********************************************************************************************/
    FUNCTION get_departments
    (
        i_lang  IN language.id_language%TYPE,
        i_prof  IN alert.profissional,
        o_info  OUT pk_types.cursor_type,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
    
        OPEN o_info FOR
            SELECT d.id_department department_id,
                   pk_translation.get_translation(i_lang, d.code_department) department_desc
              FROM department d
             WHERE d.id_institution = i_prof.institution
               AND d.flg_available = g_yes
             ORDER BY department_desc;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'get_departments', o_error);
            pk_types.open_my_cursor(o_info);
            RETURN FALSE;
    END get_departments;

    /********************************************************************************************
    * alert.pk_pharmacy.get_unidose_clinical_services
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DEPARTMENTS                IN    TABLE_NUMBER
    * @param  O_INFO                      OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Pedro Albuquerque
    * @version  1.0
    * @since  2009-11-13
    *
    ********************************************************************************************/
    FUNCTION get_unidose_clinical_services
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN alert.profissional,
        i_id_departments IN table_number,
        o_info           OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
    
        OPEN o_info FOR
            SELECT v1.id_clinical_service clin_serv_id,
                   pk_translation.get_translation(i_lang, v1.code_clinical_service) clin_serv_desc,
                   v1.id_department
              FROM (SELECT cs.id_clinical_service, cs.code_clinical_service, d.id_department
                      FROM department d, clinical_service cs, dep_clin_serv dcs
                     WHERE d.id_department IN (SELECT column_value
                                                 FROM TABLE(i_id_departments))
                       AND d.id_department = dcs.id_department
                       AND dcs.id_clinical_service = cs.id_clinical_service
                     GROUP BY cs.id_clinical_service, cs.code_clinical_service, d.id_department) v1
             ORDER BY clin_serv_desc;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'get_unidose_clinical_services', o_error);
            pk_types.open_my_cursor(o_info);
            RETURN FALSE;
    END get_unidose_clinical_services;

    /********************************************************************************************
    * alert.pk_pharmacy.get_pat_list_print_tool
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_CLIN_SERV                  IN    REF CURSOR
    * @param  I_ID_DEPARTMENT                 IN    REF CURSOR
    * @param  O_INFO                      OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Pedro Albuquerque
    * @version  1.0
    * @since  2009-11-13
    *
    ********************************************************************************************/
    FUNCTION get_pat_list_print_tool
    (
        i_lang          IN language.id_language%TYPE,
        i_prof          IN alert.profissional,
        i_id_clin_serv  IN table_number,
        i_id_department IN table_number,
        o_info          OUT pk_types.cursor_type,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        OPEN o_info FOR
            SELECT DISTINCT get_pat_name(i_lang, i_prof, p.id_patient) AS pat_name,
                            dr.id_episode,
                            '(' || p.gender || '/' || pk_patient.get_pat_age(i_lang, p.id_patient, i_prof) || ')' AS gender_age,
                            d.id_department,
                            cs.id_clinical_service
              FROM department d
             INNER JOIN dep_clin_serv dcs
                ON (d.id_department = dcs.id_department)
             INNER JOIN clinical_service cs
                ON (dcs.id_clinical_service = cs.id_clinical_service)
             INNER JOIN pharm_unidose_car_model ucm
                ON (dcs.id_dep_clin_serv = ucm.id_dep_clin_serv)
             INNER JOIN pharm_unidose_car uc
                ON (ucm.id_unidose_car_model = uc.id_car_model)
             INNER JOIN TABLE(pk_pharmacy.get_orders_for_car(uc.id_unidose_car)) x1
                ON (uc.id_unidose_car = x1.id_unidose_car)
             INNER JOIN drug_req_det drd
                ON (x1.id_drug_req_det = drd.id_drug_req_det)
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             INNER JOIN patient p
                ON (dr.id_patient = p.id_patient)
             WHERE d.id_department IN (SELECT column_value
                                         FROM TABLE(i_id_department))
               AND cs.id_clinical_service IN (SELECT column_value
                                                FROM TABLE(i_id_clin_serv))
               AND d.id_institution = i_prof.institution
             ORDER BY pat_name;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'get_pat_list_print_tool', o_error);
            pk_types.open_my_cursor(o_info);
            RETURN FALSE;
    END get_pat_list_print_tool;

    /********************************************************************************************
    * alert.pk_pharmacy.get_pat_list_dep_print_tool
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_SERVICE                    IN    ALERT.TABLE_NUMBER
    * @param  O_INFO                          OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.3
    * @since  2009-11-26
    *
    ********************************************************************************************/
    FUNCTION get_pat_list_dep_print_tool
    (
        i_lang       IN language.id_language%TYPE,
        i_prof       IN alert.profissional,
        i_id_service IN table_number,
        o_info       OUT pk_types.cursor_type,
        o_error      OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        OPEN o_info FOR
            SELECT DISTINCT get_pat_name(i_lang, i_prof, x.id_patient) pat_name,
                            x.id_episode,
                            '(' || p.gender || '/' || pk_patient.get_pat_age(i_lang, p.id_patient, i_prof) || ')' AS gender_age,
                            ei.id_dep_clin_serv
              FROM TABLE(pk_pharmacy.pharmacy_list(i_prof, g_flg_unidose)) x
             INNER JOIN patient p
                ON (x.id_patient = p.id_patient)
             INNER JOIN epis_info ei
                ON (x.id_episode = ei.id_episode)
             WHERE ei.id_dep_clin_serv IN (SELECT column_value
                                             FROM TABLE(i_id_service))
             ORDER BY pat_name;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'get_pat_list_dep_print_tool', o_error);
            pk_types.open_my_cursor(o_info);
            RETURN FALSE;
    END get_pat_list_dep_print_tool;

    /********************************************************************************************
    * alert.pk_pharmacy.get_iv_mix_doses  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_ID_DRUG_PRESC_DET             IN        NUMBER(24)
    * @param  I_DEFAULT_VALUE                 IN        VARCHAR2
    *
    * @return VARCHAR2
    *
    * @author Rui Marante
    * @version  2.6.0.4
    * @since  2010-10-26
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_iv_mix_doses
    (
        i_lang              IN language.id_language%TYPE,
        i_prof              IN profissional,
        i_id_drug_presc_det IN drug_presc_det.id_drug_presc_det%TYPE,
        i_default_value     IN VARCHAR2
    ) RETURN VARCHAR2 IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'GET_IV_MIX_DOSES';
        --
        l_div      VARCHAR2(3 CHAR) := ' + ';
        l_tbl_info table_varchar;
    BEGIN
    
        SELECT decode(pk_utils.number_to_char(i_prof, fpd.qty1) || ' ' ||
                      pk_medication_core.get_unit_translation(i_lang, i_prof, fpd.id_measure_unit1, 3),
                      ' ',
                      pk_utils.number_to_char(i_prof, fpd.qty2) || ' ' ||
                      pk_medication_core.get_unit_translation(i_lang, i_prof, fpd.id_measure_unit2, 3),
                      pk_utils.number_to_char(i_prof, fpd.qty1) || ' ' ||
                      pk_medication_core.get_unit_translation(i_lang, i_prof, fpd.id_measure_unit1, 3))
          BULK COLLECT
          INTO l_tbl_info
          FROM fluids_presc_det fpd
         INNER JOIN mi_med mi
            ON (fpd.id_drug = mi.id_drug AND fpd.vers = mi.vers)
         WHERE fpd.id_drug_presc_det = i_id_drug_presc_det
         ORDER BY fpd.rank;
    
        RETURN nvl(pharmacy_tbl2varchar(i_tbl => l_tbl_info, i_sep => l_div), i_default_value);
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_iv_mix_doses;

    /********************************************************************************************
    * alert.pk_pharmacy.get_presc_irregular_frequency  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_ID_DRUG_PRESC_DET             IN        NUMBER(24)
    *
    * @return VARCHAR2
    *
    * @author Rui Marante
    * @version  2.6.0.4
    * @since  2010-10-27
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_presc_irregular_frequency
    (
        i_lang              IN language.id_language%TYPE,
        i_id_drug_presc_det IN drug_presc_det.id_drug_presc_det%TYPE
    ) RETURN VARCHAR2 IS
        l_desc_frequency VARCHAR2(4000 CHAR);
    BEGIN
        SELECT pk_translation.get_translation(i_lang, if.code_irregular_frequency)
          INTO l_desc_frequency
          FROM drug_presc_det dpd
         INNER JOIN irregular_interval ii
            ON (dpd.id_irregular_directions = ii.id_irregular_interval)
         INNER JOIN irregular_frequency IF
            ON (ii.id_irregular_frequency = if.id_irregular_frequency)
         WHERE dpd.id_drug_presc_det = i_id_drug_presc_det;
    
        RETURN l_desc_frequency;
    
    EXCEPTION
        WHEN no_data_found THEN
            RETURN NULL;
        WHEN OTHERS THEN
            RAISE;
    END get_presc_irregular_frequency;

    /********************************************************************************************
    * alert.pk_pharmacy.get_iv_info  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN      ALERT.PROFISSIONAL
    * @param  I_ID_INSTITUTION                IN        NUMBER(24)
    * @param  I_ID_DRUG_PRESC_DET             IN        NUMBER(24)
    *
    * @return ALERT.T_REC_PHARM_IV_DETAILS
    *
    * @author Rui Marante
    * @version  2.6.0.4
    * @since  2010-10-25
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_iv_info
    (
        i_lang              IN language.id_language%TYPE,
        i_prof              IN profissional,
        i_id_institution    IN institution.id_institution%TYPE,
        i_id_drug_presc_det IN drug_presc_det.id_drug_presc_det%TYPE
    ) RETURN t_rec_pharm_iv_details IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'GET_IV_INFO';
        --
        l_ret     BOOLEAN;
        l_iv_info t_rec_pharm_iv_details;
        l_div     VARCHAR2(3 CHAR) := ' + ';
        l_info    VARCHAR2(4000 CHAR);
        l_error   t_error_out;
    BEGIN
        --init
        l_iv_info := t_rec_pharm_iv_details(i_id_drug_presc_det,
                                            NULL,
                                            NULL,
                                            NULL,
                                            NULL,
                                            NULL,
                                            NULL,
                                            NULL,
                                            NULL,
                                            NULL,
                                            NULL,
                                            NULL,
                                            NULL,
                                            NULL,
                                            NULL,
                                            NULL,
                                            NULL);
    
        SELECT dpd.id_drug,
               dpd.vers,
               get_medication_name(i_lang,
                                   i_prof,
                                   dpd.id_drug,
                                   dpd.vers,
                                   g_flg_unidose,
                                   dpd.id_drug_presc_det,
                                   g_no,
                                   dpd.id_other_product),
               get_drug_iv_instr(i_lang, i_prof, dpd.id_drug_presc_det),
               --dose
               get_iv_mix_doses(i_lang,
                                i_prof,
                                i_id_drug_presc_det,
                                pk_utils.number_to_char(i_prof, dpd.qty) || ' ' ||
                                pk_medication_core.get_unit_translation(i_lang, i_prof, dpd.id_unit_measure, 3)) adm_dose,
               -- bolus
               pk_utils.number_to_char(i_prof, dpd.value_bolus) || ' ' ||
               pk_medication_core.get_unit_translation(i_lang, i_prof, dpd.id_unit_measure_bolus, 3),
               -- route
               nvl(mr.route_abrv, mr.route_descr),
               -- drip
               pk_utils.number_to_char(i_prof, dpd.value_drip) || ' ' ||
               pk_medication_core.get_unit_translation(i_lang, i_prof, dpd.id_unit_measure_drip, 3),
               -- freq
               CASE
                   WHEN dpd.flg_take_type = pk_medication_core.g_presc_take_irre
                        AND dpd.id_presc_directions IS NULL THEN
                    get_presc_irregular_frequency(i_lang, dpd.id_drug_presc_det)
                   ELSE
                    pk_utils.number_to_char(i_prof, dpd.frequency) || ' ' ||
                    pk_medication_core.get_unit_translation(i_lang, i_prof, dpd.id_unit_measure_freq, 3)
               END,
               --schedule
               CASE
                   WHEN dpd.flg_take_type = pk_medication_core.g_presc_take_irre
                        AND dpd.id_presc_directions IS NULL THEN
                    pk_prescription_directions.get_irregular_interval_descr(i_lang, i_prof, dpd.id_irregular_directions)
                   ELSE
                    NULL
               END,
               -- qty
               pk_utils.number_to_char(i_prof, dpd.qty) || ' ' ||
               pk_medication_core.get_unit_translation(i_lang, i_prof, dpd.id_unit_measure, 3),
               --notes
               dpd.notes,
               -- start - end
               dpd.dt_begin_tstz,
               dpd.dt_end_presc_tstz,
               --prescriber
               dp.id_professional,
               dp.dt_drug_prescription_tstz
          INTO l_iv_info.id_drug,
               l_iv_info.version,
               l_iv_info.desc_iv,
               l_iv_info.desc_instr,
               l_iv_info.dose,
               l_iv_info.bolus,
               l_iv_info.route,
               l_iv_info.drip,
               l_iv_info.freq,
               l_iv_info.schedule,
               l_iv_info.qty,
               l_iv_info.notes,
               l_iv_info.dt_begin,
               l_iv_info.dt_end,
               l_iv_info.id_prof_prescriber,
               l_iv_info.dt_prescription
          FROM drug_presc_det dpd
         INNER JOIN drug_prescription dp
            ON (dpd.id_drug_prescription = dp.id_drug_prescription)
         INNER JOIN mi_med mm
            ON (dpd.id_drug = mm.id_drug AND dpd.vers = mm.vers)
          LEFT JOIN mi_route mr
            ON (dpd.route_id = mr.route_id AND dpd.vers = mr.vers)
         WHERE dpd.id_drug_presc_det = i_id_drug_presc_det;
    
        /*
            g_error := 'PK_API_DRUG.GET_INTEROP_PRESC_STRUCT';
            l_ret := pk_api_drug.get_interop_presc_struct(
                          i_lang        => i_lang,
                          i_prof_institution  => i_id_institution,
                                            i_id_drug_presc_det => table_number(i_id_drug_presc_det),
                                            o_presc_info    => l_presc_info,
                                            o_error       => l_error);
        
            for i in 1 .. l_presc_info.count
            loop
              --ONLY 1 LOOP (bacause only one id_drug_presc_det)
              l_iv_info.id_drug   := l_presc_info(i).id_item;
              l_iv_info.version   := l_presc_info(i).vers;
              l_iv_info.desc_iv   := l_presc_info(i).desc_item;
              l_iv_info.desc_instr  := l_presc_info(i).freetext_instr;
              l_iv_info.bolus     := l_presc_info(i).value_bolus || ' ' || l_presc_info(i).descr_unit_measure_bolus;
              l_iv_info.route     := l_presc_info(i).desc_drug_route;
              if (l_presc_info(i).value_drip != -1) then
                l_iv_info.drip      := l_presc_info(i).value_drip || ' ' || l_presc_info(i).descr_unit_measure_drip;
              end if;
        
              --
              for j in 1 .. l_presc_info(i).interval_tbl.count
              loop
                l_info := 
                    l_presc_info(i).interval_tbl(j).dt_begin_tstz || ' $ ' ||
                    l_presc_info(i).interval_tbl(j).dt_end_tstz || ' $ ' ||
                    l_presc_info(i).interval_tbl(j).duration || ' $ ' ||
                    l_presc_info(i).interval_tbl(j).descr_unit_measure_dur;
                if (j = 1) then
                  l_iv_info.schedule := l_info;
                else
                  l_iv_info.schedule := l_iv_info.schedule || l_div || l_info;
                end if;
        
                l_info := '';
        
                for k in 1 .. l_presc_info(i).interval_tbl(j).qty_freq_inst.count
                loop
                            l_info := l_info || 
                                l_presc_info(i).interval_tbl(j).qty_freq_inst(k).flg_freq_type || ' $ ' ||
                                l_presc_info(i).interval_tbl(j).qty_freq_inst(k).frequency || ' ' || l_presc_info(i).interval_tbl(j).qty_freq_inst(k).descr_unit_measure_freq || ' $ ' ||
        
                    l_presc_info(i).interval_tbl(j).qty_freq_inst(k).id_presc_dir_freq || ' $ ' ||
                    l_presc_info(i).interval_tbl(j).qty_freq_inst(k).df_id_freq || ' $ ' ||
                    l_presc_info(i).interval_tbl(j).qty_freq_inst(k).flg_meal_related || '$$' ||
                    l_presc_info(i).interval_tbl(j).qty_freq_inst(k).id_presc_dir_freq || '$$';
        
                  for l in 1 .. l_presc_info(i).interval_tbl(j).qty_freq_inst(k).explicit_times.count
                  loop
                    l_info := l_info ||
                      l_presc_info(i).interval_tbl(j).qty_freq_inst(k).explicit_times(l).monthday_interval || ':' ||
                      l_presc_info(i).interval_tbl(j).qty_freq_inst(k).explicit_times(l).weekday_interval || ':' ||
                      l_presc_info(i).interval_tbl(j).qty_freq_inst(k).explicit_times(l).hour_interval || ':' ||
                      l_presc_info(i).interval_tbl(j).qty_freq_inst(k).explicit_times(l).min_interval || ':' ||
                      l_presc_info(i).interval_tbl(j).qty_freq_inst(k).explicit_times(l).sec_interval || '---';
                  end loop;
        
                  for h in 1 .. l_presc_info(i).interval_tbl(j).qty_freq_inst(k).meal.count
                  loop
                    l_info := l_info ||
                      l_presc_info(i).interval_tbl(j).qty_freq_inst(k).meal(h).flg_meal_time || ':' ||
                      l_presc_info(i).interval_tbl(j).qty_freq_inst(k).meal(h).meal;
        
                  end loop;
        
                  for g in 1 .. l_presc_info(i).interval_tbl(j).qty_freq_inst(k).qty_inst.count
                  loop
                    l_info := l_info ||
                      l_presc_info(i).interval_tbl(j).qty_freq_inst(k).qty_inst(g).flg_type || '\' ||
                      l_presc_info(i).interval_tbl(j).qty_freq_inst(k).qty_inst(g).qty_min || '\' ||
                      l_presc_info(i).interval_tbl(j).qty_freq_inst(k).qty_inst(g).qty_max || '\' ||
                      l_presc_info(i).interval_tbl(j).qty_freq_inst(k).qty_inst(g).descr_unit_measure_qty_min || '\' ||
                      l_presc_info(i).interval_tbl(j).qty_freq_inst(k).qty_inst(g).descr_unit_measure_qty_max || '\' ||
                      l_presc_info(i).interval_tbl(j).qty_freq_inst(k).qty_inst(g).desc_sliding_scale;
                  end loop;
        
                  if (k = 1) then
                                l_iv_info.freq := l_info;
                            else
                                l_iv_info.freq := l_iv_info.freq || l_div || l_info;
                            end if;
                end loop;
        
              end loop;
              --
        
              l_iv_info.dose      := 'DOSE ??';
        --      l_iv_info.freq      := 'FREQ ??';
        --      l_iv_info.schedule    := 'SCHEDULE ??';
              l_iv_info.qty     := 'QTY ??';
        
            end loop; --l_presc_info
        */
        RETURN l_iv_info;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, l_error.err_desc, l_db_object_name, l_error);
            RAISE;
    END get_iv_info;

    /********************************************************************************************
    * alert.pk_pharmacy.get_auto_report_med_print_tool
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_EPISODE                  IN    TABLE_NUMBER
    * @param  I_ID_DEPARTMENT                 IN    REF CURSOR
    * @param  I_ID_DATE_BEGIN         IN    VARCHAR2
    * @param  I_ID_DATE_END         IN    VARCHAR2
    * @param  I_ID_DATE_MOD         IN    VARCHAR2
    * @param  O_CONTEXT                   OUT   REF CURSOR
    * @param  O_PATIENTS            OUT   REF CURSOR
    * @param  O_MED_BY_PAT          OUT   REF CURSOR
    * @param  O_MED_IV_BY_PAT                 OUT     REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Pedro Albuquerque
    * @version  1.0
    * @since  2009-11-13
    *
    ********************************************************************************************/
    FUNCTION get_auto_report_med_print_tool
    (
        i_lang          IN language.id_language%TYPE,
        i_prof          IN alert.profissional,
        i_episode       IN table_number,
        i_id_date_begin IN VARCHAR2 DEFAULT NULL,
        i_id_date_end   IN VARCHAR2 DEFAULT NULL,
        i_id_date_mod   IN VARCHAR2 DEFAULT NULL,
        o_context       OUT pk_types.cursor_type,
        o_patients      OUT pk_types.cursor_type,
        o_med_by_pat    OUT pk_types.cursor_type,
        o_med_iv_by_pat OUT pk_types.cursor_type,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
        l_prof_type       profile_template.flg_type%TYPE;
        l_date_begin_tstz TIMESTAMP WITH LOCAL TIME ZONE;
        l_date_end_tstz   TIMESTAMP WITH LOCAL TIME ZONE;
        l_date_mod_tstz   TIMESTAMP WITH LOCAL TIME ZONE;
    BEGIN
    
        g_error     := 'GET PROF TYPE';
        l_prof_type := get_prof_type(i_prof);
    
        IF i_id_date_mod IS NOT NULL
        THEN
        
            l_date_begin_tstz := pk_date_utils.get_string_tstz(i_lang, i_prof, i_id_date_begin, NULL);
            l_date_end_tstz   := pk_date_utils.get_string_tstz(i_lang, i_prof, i_id_date_end, NULL);
            l_date_mod_tstz   := pk_date_utils.get_string_tstz(i_lang, i_prof, i_id_date_mod, NULL);
        
            g_error := 'QUERY O_CONTEXT';
            OPEN o_context FOR
                SELECT v1.id_episode id_epis,
                       get_pat_location(i_lang, i_prof, v1.id_episode, v1.id_patient, 1) pat_location,
                       to_char(l_date_begin_tstz, 'HH24:MI DD-MON-YYYY') || ' / ' ||
                       to_char(l_date_end_tstz, 'HH24:MI DD-MON-YYYY') unidose_dates,
                       to_char(l_date_mod_tstz, 'HH24:MI DD-MON-YYYY') date_mod
                  FROM (SELECT p.id_patient, e.id_episode
                          FROM patient p, episode e
                         WHERE e.id_episode IN (SELECT column_value
                                                  FROM TABLE(i_episode))
                           AND p.id_patient = e.id_patient) v1;
        
            g_error := 'QUERY O_PATIENTS';
            OPEN o_patients FOR
                SELECT DISTINCT v4.id_epis,
                                v4.id_patient,
                                v4.num_clin_record,
                                v4.pat_age,
                                v4.pat_gender,
                                v4.pat_name,
                                v4.room_bed,
                                v4.room_bed_desc
                  FROM (SELECT v1.id_episode id_epis,
                               v1.id_patient,
                               get_pat_clin_record(i_lang, v1.id_patient, i_prof.institution) num_clin_record,
                               pk_patient.get_pat_age(i_lang, v1.id_patient, i_prof) pat_age,
                               p3.gender pat_gender,
                               get_pat_name(i_lang, i_prof, p3.id_patient) pat_name,
                               get_pat_location(i_lang, i_prof, v1.id_episode, v1.id_patient, NULL, 'ROOM_BED') room_bed,
                               pk_message.get_message(i_lang, 'PHARMACY_PRINT_TOOL_ROOM_BED') room_bed_desc
                          FROM (SELECT v2.id_drug_req_det,
                                       v2.id_state,
                                       v2.id_episode,
                                       v2.drdst_dt_state,
                                       v2.drdst2_dt_state,
                                       v2.id_patient
                                  FROM (SELECT drd.id_drug_req_det,
                                               drd.id_state,
                                               e.id_episode,
                                               drdst.dt_state      drdst_dt_state,
                                               drdst2.dt_state     drdst2_dt_state,
                                               p.id_patient
                                          FROM drug_req_det                  drd,
                                               drug_req                      dr,
                                               episode                       e,
                                               visit                         v,
                                               patient                       p,
                                               drug_req_det_state_transition drdst,
                                               drug_req_det_state_transition drdst2,
                                               drug_presc_det                dpd,
                                               prescription_instr_hist       pih
                                         WHERE drd.id_drug_req = dr.id_drug_req
                                           AND dr.id_episode = e.id_episode
                                           AND e.id_episode IN (SELECT column_value
                                                                  FROM TABLE(i_episode)) ----------
                                           AND e.id_visit = v.id_visit
                                           AND dr.id_patient = p.id_patient
                                           AND v.id_institution = i_prof.institution
                                           AND v.flg_status != 'C' -- not canceled
                                           AND e.flg_status = 'A' -- active episode
                                           AND drd.id_state IN
                                               (SELECT column_value
                                                  FROM TABLE(get_grid_allowed_states(i_prof, g_flg_unidose, 'GRID_PAT')))
                                           AND dr.flg_type = g_flg_unidose
                                           AND p.id_patient = e.id_patient
                                           AND drd.id_drug_req_det = drdst.id_drug_req_det
                                           AND drdst.id_state =
                                               get_state_for_req_type(i_prof, g_flg_unidose, g_drd_requested_st)
                                           AND drd.id_drug_req_det = drdst2.id_drug_req_det(+)
                                           AND drd.id_state = drdst2.id_state(+)
                                           AND get_grid_timeout(drd.id_state, i_prof, 'D') >
                                               pk_date_utils.get_timestamp_diff(current_timestamp, drdst2.dt_state)
                                           AND drdst.dt_state BETWEEN l_date_begin_tstz AND l_date_end_tstz
                                           AND dpd.id_drug_presc_det = dr.id_drug_presc_det
                                           AND dpd.id_drug_presc_det = pih.id_presc
                                           AND (dpd.flg_status = 'R' OR (pih.flg_status_old != pih.flg_status_new))
                                           AND pih.last_update_tstz > l_date_mod_tstz
                                         ORDER BY pih.id_prescription_instr_hist DESC) v2
                                --where rownum = 1
                                ) v1,
                               wfl_state_detail wsd,
                               patient p3
                         WHERE v1.id_state = wsd.state
                           AND wsd.prof_type = l_prof_type
                           AND p3.id_patient = v1.id_patient
                         ORDER BY wsd.rank, v1.drdst_dt_state DESC) v4;
        
            g_error := 'QUERY O_MED_BY_PAT';
            OPEN o_med_by_pat FOR
                SELECT DISTINCT v4.id_drug,
                                v4.vers,
                                v4.id_drug_presc_det,
                                get_medication_name(i_lang,
                                                    i_prof,
                                                    v4.id_drug,
                                                    v4.vers,
                                                    NULL,
                                                    v4.id_drug_presc_det,
                                                    g_no,
                                                    v4.id_other_product) med_descr,
                                tf.id_presc_dir_interval id_presc_dir_interval,
                                tf.dt_begin dtbegin,
                                tf.dt_end dtend,
                                tf.dose dose,
                                tf.route route,
                                tf.frequency_desc freq,
                                tf.hours hours,
                                tf.duration duration,
                                tf.notes notes,
                                v4.total_qty_to_prep,
                                pk_medication_core.get_unit_translation(i_lang, i_prof, v4.id_unit_measure_prep, NULL) unit_translation,
                                --get_notes_from_drd(v4.id_drug_req_det, get_states_for_req_type(i_prof, g_flg_unidose, table_varchar(g_drd_validated_st)), 2) notes,
                                v4.id_episode,
                                get_chnm_id(v4.id_drug, v4.vers) chnm_id
                  FROM (SELECT v1.id_drug,
                               v1.vers,
                               v1.id_drug_presc_det,
                               SUM(drd3.qty_to_prep) total_qty_to_prep,
                               drd3.id_unit_measure_prep,
                               v1.id_drug_req_det,
                               v1.id_episode,
                               v1.flg_status,
                               v1.id_presc_directions,
                               drd3.id_other_product
                          FROM (SELECT v2.id_drug_req_det,
                                       v2.id_state,
                                       v2.id_episode,
                                       v2.drdst_dt_state,
                                       v2.drdst2_dt_state,
                                       v2.id_patient,
                                       v2.id_drug,
                                       v2.vers,
                                       v2.id_drug_presc_det,
                                       v2.flg_status,
                                       v2.id_presc_directions
                                  FROM (SELECT drd.id_drug_req_det,
                                               drd.id_state,
                                               e.id_episode,
                                               drdst.dt_state          drdst_dt_state,
                                               drdst2.dt_state         drdst2_dt_state,
                                               p.id_patient,
                                               drd.id_drug,
                                               drd.vers,
                                               dpd.id_drug_presc_det,
                                               dpd.flg_status,
                                               drd.id_presc_directions
                                          FROM drug_req_det                  drd,
                                               drug_req                      dr,
                                               episode                       e,
                                               visit                         v,
                                               patient                       p,
                                               drug_req_det_state_transition drdst,
                                               drug_req_det_state_transition drdst2,
                                               drug_presc_det                dpd,
                                               prescription_instr_hist       pih
                                         WHERE drd.id_drug_req = dr.id_drug_req
                                           AND dr.id_episode = e.id_episode
                                           AND e.id_episode IN (SELECT column_value
                                                                  FROM TABLE(i_episode)) ----------
                                           AND e.id_visit = v.id_visit
                                           AND dr.id_patient = p.id_patient
                                           AND v.id_institution = i_prof.institution
                                           AND v.flg_status != 'C' -- not canceled
                                           AND e.flg_status = 'A' -- active episode
                                           AND drd.id_state IN
                                               (SELECT column_value
                                                  FROM TABLE(get_grid_allowed_states(i_prof, g_flg_unidose, 'GRID_PAT')))
                                           AND dr.flg_type = g_flg_unidose
                                           AND p.id_patient = e.id_patient
                                           AND drd.id_drug_req_det = drdst.id_drug_req_det
                                           AND drdst.id_state =
                                               get_state_for_req_type(i_prof, g_flg_unidose, g_drd_requested_st)
                                           AND drd.id_drug_req_det = drdst2.id_drug_req_det(+)
                                           AND drd.id_state = drdst2.id_state(+)
                                           AND get_grid_timeout(drd.id_state, i_prof, 'D') >
                                               pk_date_utils.get_timestamp_diff(current_timestamp, drdst2.dt_state)
                                           AND drdst.dt_state BETWEEN l_date_begin_tstz AND l_date_end_tstz
                                           AND dpd.id_drug_presc_det = dr.id_drug_presc_det
                                           AND dpd.id_drug_presc_det = pih.id_presc
                                           AND (dpd.flg_status = 'R' OR (pih.flg_status_old != pih.flg_status_new))
                                           AND pih.last_update_tstz > l_date_mod_tstz
                                         ORDER BY pih.id_prescription_instr_hist DESC) v2
                                --where rownum = 1
                                ) v1,
                               wfl_state_detail wsd,
                               drug_req dr3,
                               drug_req_det drd3
                         WHERE v1.id_state = wsd.state
                           AND wsd.prof_type = l_prof_type
                           AND v1.id_drug_req_det = drd3.id_drug_req_det
                           AND drd3.id_drug_req = dr3.id_drug_req
                         GROUP BY v1.id_drug,
                                  v1.vers,
                                  v1.id_drug_presc_det,
                                  drd3.id_unit_measure_prep,
                                  v1.id_drug_req_det,
                                  v1.id_episode,
                                  v1.flg_status,
                                  v1.id_presc_directions,
                                  drd3.id_other_product) v4
                  LEFT JOIN mi_med mi
                    ON (v4.id_drug = mi.id_drug AND v4.vers = mi.vers)
                --This JOIN was changed because the function pk_prescription_directions.get_pharmacy_unidose_info wasn't returning the correct values [ALERT-108734]
                  LEFT JOIN (SELECT pd.id_presc_directions AS id_presc_directions,
                                    pdi.id_presc_dir_interval AS id_presc_dir_interval,
                                    nvl2(pdi.dt_begin, to_char(pdi.dt_begin, 'HH24:MI DD-MON-YYYY'), pdi.dt_begin) AS dt_begin,
                                    nvl2(pdi.dt_end, to_char(pdi.dt_end, 'HH24:MI DD-MON-YYYY'), pdi.dt_end) AS dt_end,
                                    nvl2(pdi.duration,
                                         pk_utils.number_to_char(i_prof, pdi.duration) || ' ' ||
                                         pk_prescription_directions.get_unit_measure_description(i_lang,
                                                                                                 pdi.id_unit_duration),
                                         pdi.duration) AS duration,
                                    pk_prescription_directions.get_dose_string(i_lang,
                                                                               i_prof,
                                                                               pddf.id_presc_dir_dosefreq) AS dose,
                                    pk_prescription_directions.get_frequency_string(i_lang,
                                                                                    i_prof,
                                                                                    pddf.id_presc_dir_dosefreq,
                                                                                    pd.flg_take_type) AS frequency_desc,
                                    pk_prescription_directions.get_hours_string(i_lang,
                                                                                i_prof,
                                                                                pddf.id_presc_dir_dosefreq) AS hours,
                                    pd.notes AS notes,
                                    pk_prescription_directions.get_route_description(i_lang, i_prof, 'L', pd.id_route) AS route
                             -- get each day frequency -> count(detalhes da frequencia para os tipos de frequencia em cada dia e quando no so outras frequencias)
                               FROM presc_directions pd
                              INNER JOIN presc_dir_interval pdi
                                 ON (pdi.id_presc_directions = pd.id_presc_directions)
                              INNER JOIN presc_dir_dosefreq pddf
                                 ON (pddf.id_presc_dir_interval = pdi.id_presc_dir_interval)) tf
                    ON (v4.id_presc_directions = tf.id_presc_directions)
                 WHERE (mi.flg_type IS NULL OR mi.flg_type NOT IN ('F', 'C', 'N')); --iv_fluids
        
            --IV
            g_error := 'QUERY O_MED_IV_BY_PAT';
            OPEN o_med_iv_by_pat FOR
                SELECT v5.id_drug,
                       v5.vers,
                       v5.id_drug_presc_det,
                       v5.med_descr,
                       --IV INFO
                       v5.iv_info.dose adm_dose,
                       v5.iv_info.bolus adm_bolus,
                       v5.iv_info.route adm_route,
                       v5.iv_info.drip adm_speed,
                       v5.iv_info.freq adm_freq,
                       v5.iv_info.schedule adm_schedule,
                       v5.iv_info.qty adm_qty,
                       v5.iv_info.notes presc_notes,
                       v5.iv_info.dt_begin presc_begin,
                       v5.iv_info.dt_end presc_end,
                       pk_prof_utils.get_name_signature(i_lang, i_prof, v5.iv_info.id_prof_prescriber) prof_name,
                       pk_prof_utils.get_spec_signature(i_lang,
                                                        i_prof,
                                                        v5.iv_info.id_prof_prescriber,
                                                        v5.iv_info.dt_prescription,
                                                        v5.id_episode) spec_name,
                       v5.iv_info.dt_prescription presc_dt,
                       --
                       v5.total_qty_to_prep,
                       v5.unit_translation,
                       v5.id_episode,
                       v5.chnm_id
                  FROM (SELECT v4.id_drug,
                               v4.vers,
                               v4.id_drug_presc_det,
                               get_medication_name(i_lang,
                                                   i_prof,
                                                   v4.id_drug,
                                                   v4.vers,
                                                   NULL,
                                                   v4.id_drug_presc_det,
                                                   g_no,
                                                   v4.id_other_product) med_descr,
                               v4.total_qty_to_prep,
                               pk_medication_core.get_unit_translation(i_lang, i_prof, v4.id_unit_measure_prep, NULL) unit_translation,
                               v4.id_episode,
                               get_chnm_id(v4.id_drug, v4.vers) chnm_id,
                               get_iv_info(i_lang, i_prof, i_prof.institution, v4.id_drug_presc_det) iv_info
                          FROM (SELECT v1.id_drug,
                                       v1.vers,
                                       v1.id_drug_presc_det,
                                       SUM(drd3.qty_to_prep) total_qty_to_prep,
                                       drd3.id_unit_measure_prep,
                                       v1.id_drug_req_det,
                                       v1.id_episode,
                                       v1.flg_status,
                                       v1.id_presc_directions,
                                       drd3.id_other_product
                                  FROM (SELECT v2.id_drug_req_det,
                                               v2.id_state,
                                               v2.id_episode,
                                               v2.drdst_dt_state,
                                               v2.drdst2_dt_state,
                                               v2.id_patient,
                                               v2.id_drug,
                                               v2.vers,
                                               v2.id_drug_presc_det,
                                               v2.flg_status,
                                               v2.id_presc_directions
                                          FROM (SELECT drd.id_drug_req_det,
                                                       drd.id_state,
                                                       e.id_episode,
                                                       drdst.dt_state          drdst_dt_state,
                                                       drdst2.dt_state         drdst2_dt_state,
                                                       p.id_patient,
                                                       drd.id_drug,
                                                       drd.vers,
                                                       dpd.id_drug_presc_det,
                                                       dpd.flg_status,
                                                       drd.id_presc_directions
                                                  FROM drug_req_det                  drd,
                                                       drug_req                      dr,
                                                       episode                       e,
                                                       visit                         v,
                                                       patient                       p,
                                                       drug_req_det_state_transition drdst,
                                                       drug_req_det_state_transition drdst2,
                                                       drug_presc_det                dpd,
                                                       prescription_instr_hist       pih
                                                 WHERE drd.id_drug_req = dr.id_drug_req
                                                   AND dr.id_episode = e.id_episode
                                                   AND e.id_episode IN (SELECT column_value
                                                                          FROM TABLE(i_episode)) ----------
                                                   AND e.id_visit = v.id_visit
                                                   AND dr.id_patient = p.id_patient
                                                   AND v.id_institution = i_prof.institution
                                                   AND v.flg_status != 'C' -- not canceled
                                                   AND e.flg_status = 'A' -- active episode
                                                   AND drd.id_state IN
                                                       (SELECT column_value
                                                          FROM TABLE(get_grid_allowed_states(i_prof,
                                                                                             g_flg_unidose,
                                                                                             'GRID_PAT')))
                                                   AND dr.flg_type = g_flg_unidose
                                                   AND p.id_patient = e.id_patient
                                                   AND drd.id_drug_req_det = drdst.id_drug_req_det
                                                   AND drdst.id_state =
                                                       get_state_for_req_type(i_prof, g_flg_unidose, g_drd_requested_st)
                                                   AND drd.id_drug_req_det = drdst2.id_drug_req_det(+)
                                                   AND drd.id_state = drdst2.id_state(+)
                                                   AND get_grid_timeout(drd.id_state, i_prof, 'D') >
                                                       pk_date_utils.get_timestamp_diff(current_timestamp, drdst2.dt_state)
                                                   AND drdst.dt_state BETWEEN l_date_begin_tstz AND l_date_end_tstz
                                                   AND dpd.id_drug_presc_det = dr.id_drug_presc_det
                                                   AND dpd.id_drug_presc_det = pih.id_presc
                                                   AND (dpd.flg_status = 'R' OR (pih.flg_status_old != pih.flg_status_new))
                                                   AND pih.last_update_tstz > l_date_mod_tstz
                                                 ORDER BY pih.id_prescription_instr_hist DESC) v2) v1,
                                       wfl_state_detail wsd,
                                       drug_req dr3,
                                       drug_req_det drd3
                                 WHERE v1.id_state = wsd.state
                                   AND wsd.prof_type = l_prof_type
                                   AND v1.id_drug_req_det = drd3.id_drug_req_det
                                   AND drd3.id_drug_req = dr3.id_drug_req
                                 GROUP BY v1.id_drug,
                                          v1.vers,
                                          v1.id_drug_presc_det,
                                          drd3.id_unit_measure_prep,
                                          v1.id_drug_req_det,
                                          v1.id_episode,
                                          v1.flg_status,
                                          v1.id_presc_directions,
                                          drd3.id_other_product) v4
                         INNER JOIN mi_med mi
                            ON (v4.id_drug = mi.id_drug AND v4.vers = mi.vers)
                         WHERE mi.flg_type IN ('F', 'C', 'N') --iv_fluids
                        ) v5;
        
            --apenas data de inicio e fim preenchidas (relatorio sem alterao de prescrio)
        ELSE
        
            l_date_begin_tstz := pk_date_utils.get_string_tstz(i_lang, i_prof, i_id_date_begin, NULL);
            l_date_end_tstz   := pk_date_utils.get_string_tstz(i_lang, i_prof, i_id_date_end, NULL);
        
            g_error := 'QUERY O_CONTEXT';
            OPEN o_context FOR
            
                SELECT v1.id_episode id_epis,
                       get_pat_location(i_lang, i_prof, v1.id_episode, v1.id_patient, 1) pat_location,
                       to_char(l_date_begin_tstz, 'HH24:MI DD-MON-YYYY') || ' / ' ||
                       to_char(l_date_end_tstz, 'HH24:MI DD-MON-YYYY') unidose_dates
                  FROM (SELECT p.id_patient, e.id_episode
                          FROM patient p, episode e
                         WHERE e.id_episode IN (SELECT column_value
                                                  FROM TABLE(i_episode))
                           AND p.id_patient = e.id_patient) v1;
        
            g_error := 'QUERY O_PATIENTS';
            OPEN o_patients FOR
                SELECT DISTINCT v4.id_epis,
                                v4.id_patient,
                                v4.num_clin_record,
                                v4.pat_age,
                                v4.pat_gender,
                                v4.pat_name,
                                v4.room_bed,
                                v4.room_bed_desc
                  FROM (SELECT v1.id_episode id_epis,
                               v1.id_patient id_patient,
                               get_pat_clin_record(i_lang, v1.id_patient, i_prof.institution) num_clin_record,
                               pk_patient.get_pat_age(i_lang, v1.id_patient, i_prof) pat_age,
                               p3.gender pat_gender,
                               get_pat_name(i_lang, i_prof, p3.id_patient) pat_name,
                               get_pat_location(i_lang, i_prof, v1.id_episode, v1.id_patient, NULL, 'ROOM_BED') room_bed,
                               pk_message.get_message(i_lang, 'PHARMACY_PRINT_TOOL_ROOM_BED') room_bed_desc
                          FROM (SELECT v2.id_drug_req_det,
                                       v2.id_state,
                                       v2.id_episode,
                                       v2.drdst_dt_state,
                                       v2.drdst2_dt_state,
                                       v2.id_patient
                                  FROM (SELECT drd.id_drug_req_det,
                                               drd.id_state,
                                               e.id_episode,
                                               drdst.dt_state      drdst_dt_state,
                                               drdst2.dt_state     drdst2_dt_state,
                                               p.id_patient
                                          FROM drug_req_det                  drd,
                                               drug_req                      dr,
                                               episode                       e,
                                               visit                         v,
                                               patient                       p,
                                               drug_req_det_state_transition drdst,
                                               drug_req_det_state_transition drdst2
                                         WHERE drd.id_drug_req = dr.id_drug_req
                                           AND dr.id_episode = e.id_episode
                                           AND e.id_episode IN (SELECT column_value
                                                                  FROM TABLE(i_episode)) ----------
                                           AND e.id_visit = v.id_visit
                                           AND dr.id_patient = p.id_patient
                                           AND v.id_institution = i_prof.institution
                                           AND v.flg_status != 'C' -- not canceled
                                           AND e.flg_status = 'A' -- active episode
                                           AND drd.id_state IN
                                               (SELECT column_value
                                                  FROM TABLE(get_grid_allowed_states(i_prof,
                                                                                     g_flg_unidose,
                                                                                     'GRID_PAT_REPORT')))
                                           AND dr.flg_type = g_flg_unidose
                                           AND p.id_patient = e.id_patient
                                           AND drd.id_drug_req_det = drdst.id_drug_req_det
                                           AND drdst.id_state =
                                               get_state_for_req_type(i_prof, g_flg_unidose, g_drd_requested_st)
                                           AND drd.id_drug_req_det = drdst2.id_drug_req_det(+)
                                           AND drd.id_state = drdst2.id_state(+)
                                           AND get_grid_timeout(drd.id_state, i_prof, 'D') >
                                               pk_date_utils.get_timestamp_diff(current_timestamp, drdst2.dt_state)
                                           AND drdst.dt_state BETWEEN l_date_begin_tstz AND l_date_end_tstz) v2
                                 GROUP BY v2.id_drug_req_det,
                                          v2.id_state,
                                          v2.id_episode,
                                          v2.drdst_dt_state,
                                          v2.drdst2_dt_state,
                                          v2.id_patient --must get the recent one (drug_req_det_state_transition) --this is because loops on the workflow (reject > prepare > reject > prepara .. and so on)
                                UNION ALL
                                --executing with some supplies or terminated!
                                SELECT v3.id_drug_req_det,
                                       v3.id_state,
                                       v3.id_episode,
                                       v3.drdst_dt_state,
                                       MAX(v3.drdst2_dt_state) drdst2_dt_state,
                                       v3.id_patient
                                  FROM (SELECT drd.id_drug_req_det,
                                               drs.id_state,
                                               e.id_episode,
                                               drdst.dt_state      drdst_dt_state,
                                               drdst2.dt_state     drdst2_dt_state,
                                               p.id_patient
                                          FROM drug_req_supply               drs,
                                               drug_req_det                  drd,
                                               drug_req                      dr,
                                               episode                       e,
                                               visit                         v,
                                               patient                       p,
                                               drug_req_det_state_transition drdst,
                                               drug_req_det_state_transition drdst2
                                         WHERE drs.id_drug_req_det = drd.id_drug_req_det
                                           AND drd.id_drug_req = dr.id_drug_req
                                           AND dr.id_episode = e.id_episode
                                           AND e.id_episode IN (SELECT column_value
                                                                  FROM TABLE(i_episode)) ----------
                                           AND e.id_visit = v.id_visit
                                           AND dr.id_patient = p.id_patient
                                           AND v.id_institution = i_prof.institution
                                           AND v.flg_status != 'C' -- not canceled
                                           AND e.flg_status = 'A' -- active episode
                                           AND drd.id_state IN
                                               (SELECT column_value
                                                  FROM TABLE(get_states_for_req_type(i_prof,
                                                                                     g_flg_unidose,
                                                                                     table_varchar(g_drd_executing_st,
                                                                                                   g_drd_terminated_st,
                                                                                                   g_drd_rejected2prep_st))))
                                           AND dr.flg_type = g_flg_unidose
                                           AND p.id_patient = e.id_patient
                                           AND drs.id_state IN
                                               (SELECT column_value
                                                  FROM TABLE(get_states_for_req_type(i_prof,
                                                                                     NULL,
                                                                                     g_grid_pat_drs_adm_states)))
                                           AND drd.id_drug_req_det = drdst.id_drug_req_det
                                           AND drdst.id_state =
                                               get_state_for_req_type(i_prof, g_flg_unidose, g_drd_requested_st)
                                           AND drd.id_drug_req_det = drdst2.id_drug_req_det(+)
                                           AND drd.id_state = drdst2.id_state(+)
                                           AND get_grid_timeout(drd.id_state, i_prof, 'D') >
                                               pk_date_utils.get_timestamp_diff(current_timestamp, drdst2.dt_state)
                                           AND drdst.dt_state BETWEEN l_date_begin_tstz AND l_date_end_tstz
                                         GROUP BY drd.id_drug_req_det,
                                                  drs.id_state,
                                                  dr.dt_drug_req_tstz,
                                                  e.id_episode,
                                                  drdst.dt_state,
                                                  drdst2.dt_state,
                                                  p.id_patient --group multiple supplies into one request
                                        ) v3
                                 GROUP BY v3.id_drug_req_det,
                                          v3.id_state,
                                          v3.id_episode,
                                          v3.drdst_dt_state,
                                          v3.id_patient) v1,
                               wfl_state_detail wsd,
                               patient p3
                         WHERE v1.id_state = wsd.state
                           AND wsd.prof_type = l_prof_type
                           AND p3.id_patient = v1.id_patient
                         ORDER BY wsd.rank, v1.drdst_dt_state DESC) v4;
        
            g_error := 'QUERY O_MED_BY_PAT';
            OPEN o_med_by_pat FOR
                SELECT DISTINCT v4.id_drug,
                                v4.vers,
                                v4.id_drug_presc_det,
                                get_medication_name(i_lang,
                                                    i_prof,
                                                    v4.id_drug,
                                                    v4.vers,
                                                    NULL,
                                                    v4.id_drug_presc_det,
                                                    g_no,
                                                    v4.id_other_product) med_descr,
                                tf.id_presc_dir_interval id_presc_dir_interval,
                                tf.dt_begin dtbegin,
                                tf.dt_end dtend,
                                tf.dose dose,
                                tf.route route,
                                tf.frequency_desc freq,
                                tf.hours hours,
                                tf.duration duration,
                                tf.notes notes,
                                v4.total_qty_to_prep,
                                pk_medication_core.get_unit_translation(i_lang, i_prof, v4.id_unit_measure_prep, NULL) unit_translation,
                                --get_notes_from_drd(v4.id_drug_req_det, get_states_for_req_type(i_prof, g_flg_unidose, table_varchar(g_drd_validated_st)), 2) notes,
                                v4.id_episode,
                                get_chnm_id(v4.id_drug, v4.vers) chnm_id
                  FROM (SELECT v1.id_drug,
                               v1.vers,
                               v1.id_drug_presc_det,
                               SUM(drd3.qty_to_prep) total_qty_to_prep,
                               drd3.id_unit_measure_prep,
                               v1.id_episode,
                               v1.id_drug_req_det,
                               v1.id_presc_directions,
                               drd3.id_other_product
                          FROM (SELECT v2.id_drug_req_det,
                                       v2.id_state,
                                       v2.id_episode,
                                       v2.drdst_dt_state,
                                       v2.drdst2_dt_state,
                                       v2.id_drug,
                                       v2.vers,
                                       v2.id_drug_presc_det,
                                       v2.id_presc_directions
                                  FROM (SELECT drd.id_drug_req_det,
                                               drd.id_state,
                                               e.id_episode,
                                               drdst.dt_state          drdst_dt_state,
                                               drdst2.dt_state         drdst2_dt_state,
                                               drd.id_drug,
                                               drd.vers,
                                               dr.id_drug_presc_det,
                                               drd.id_presc_directions
                                          FROM drug_req_det                  drd,
                                               drug_req                      dr,
                                               episode                       e,
                                               visit                         v,
                                               patient                       p,
                                               drug_req_det_state_transition drdst,
                                               drug_req_det_state_transition drdst2
                                         WHERE drd.id_drug_req = dr.id_drug_req
                                           AND dr.id_episode = e.id_episode
                                           AND e.id_episode IN (SELECT column_value
                                                                  FROM TABLE(i_episode)) ----------
                                           AND e.id_visit = v.id_visit
                                           AND dr.id_patient = p.id_patient
                                           AND v.id_institution = i_prof.institution
                                           AND v.flg_status != 'C' -- not canceled
                                           AND e.flg_status = 'A' -- active episode
                                           AND drd.id_state IN
                                               (SELECT column_value
                                                  FROM TABLE(get_grid_allowed_states(i_prof,
                                                                                     g_flg_unidose,
                                                                                     'GRID_PAT_REPORT')))
                                           AND dr.flg_type = g_flg_unidose
                                           AND p.id_patient = e.id_patient
                                           AND drd.id_drug_req_det = drdst.id_drug_req_det
                                           AND drdst.id_state =
                                               get_state_for_req_type(i_prof, g_flg_unidose, g_drd_requested_st)
                                           AND drd.id_drug_req_det = drdst2.id_drug_req_det(+)
                                           AND drd.id_state = drdst2.id_state(+)
                                           AND get_grid_timeout(drd.id_state, i_prof, 'D') >
                                               pk_date_utils.get_timestamp_diff(current_timestamp, drdst2.dt_state)
                                           AND drdst.dt_state BETWEEN l_date_begin_tstz AND l_date_end_tstz) v2
                                 GROUP BY v2.id_drug_req_det,
                                          v2.id_state,
                                          v2.id_episode,
                                          v2.drdst_dt_state,
                                          v2.drdst2_dt_state,
                                          v2.id_drug,
                                          v2.vers,
                                          v2.id_drug_presc_det,
                                          v2.id_presc_directions --must get the recent one (drug_req_det_state_transition) --this is because loops on the workflow (reject > prepare > reject > prepara .. and so on)
                                UNION ALL
                                --executing with some supplies or terminated!
                                SELECT v3.id_drug_req_det,
                                       v3.id_state,
                                       v3.id_episode,
                                       v3.drdst_dt_state,
                                       MAX(v3.drdst2_dt_state) drdst2_dt_state,
                                       v3.id_drug,
                                       v3.vers,
                                       v3.id_drug_presc_det,
                                       v3.id_presc_directions
                                  FROM (SELECT drd.id_drug_req_det,
                                               drs.id_state,
                                               e.id_episode,
                                               drdst.dt_state          drdst_dt_state,
                                               drdst2.dt_state         drdst2_dt_state,
                                               drd.id_drug,
                                               drd.vers,
                                               dr.id_drug_presc_det,
                                               drd.id_presc_directions
                                          FROM drug_req_supply               drs,
                                               drug_req_det                  drd,
                                               drug_req                      dr,
                                               episode                       e,
                                               visit                         v,
                                               patient                       p,
                                               drug_req_det_state_transition drdst,
                                               drug_req_det_state_transition drdst2
                                         WHERE drs.id_drug_req_det = drd.id_drug_req_det
                                           AND drd.id_drug_req = dr.id_drug_req
                                           AND dr.id_episode = e.id_episode
                                           AND e.id_episode IN (SELECT column_value
                                                                  FROM TABLE(i_episode)) ----------
                                           AND e.id_visit = v.id_visit
                                           AND dr.id_patient = p.id_patient
                                           AND v.id_institution = i_prof.institution
                                           AND v.flg_status != 'C' -- not canceled
                                           AND e.flg_status = 'A' -- active episode
                                           AND drd.id_state IN
                                               (SELECT column_value
                                                  FROM TABLE(get_states_for_req_type(i_prof,
                                                                                     g_flg_unidose,
                                                                                     table_varchar(g_drd_executing_st,
                                                                                                   g_drd_terminated_st,
                                                                                                   g_drd_rejected2prep_st))))
                                           AND dr.flg_type = g_flg_unidose
                                           AND p.id_patient = e.id_patient
                                           AND drs.id_state IN
                                               (SELECT column_value
                                                  FROM TABLE(get_states_for_req_type(i_prof,
                                                                                     NULL,
                                                                                     g_grid_pat_drs_adm_states)))
                                           AND drd.id_drug_req_det = drdst.id_drug_req_det
                                           AND drdst.id_state =
                                               get_state_for_req_type(i_prof, g_flg_unidose, g_drd_requested_st)
                                           AND drd.id_drug_req_det = drdst2.id_drug_req_det(+)
                                           AND drd.id_state = drdst2.id_state(+)
                                           AND get_grid_timeout(drd.id_state, i_prof, 'D') >
                                               pk_date_utils.get_timestamp_diff(current_timestamp, drdst2.dt_state)
                                           AND drdst.dt_state BETWEEN l_date_begin_tstz AND l_date_end_tstz
                                         GROUP BY drd.id_drug_req_det,
                                                  drs.id_state,
                                                  dr.dt_drug_req_tstz,
                                                  e.id_episode,
                                                  drdst.dt_state,
                                                  drdst2.dt_state,
                                                  drd.id_drug,
                                                  drd.vers,
                                                  dr.id_drug_presc_det,
                                                  drd.id_presc_directions --group multiple supplies into one request
                                        ) v3
                                 GROUP BY v3.id_drug_req_det,
                                          v3.id_state,
                                          v3.id_episode,
                                          v3.drdst_dt_state,
                                          v3.id_drug,
                                          v3.vers,
                                          v3.id_drug_presc_det,
                                          v3.id_presc_directions) v1,
                               wfl_state_detail wsd,
                               drug_req dr3,
                               drug_req_det drd3
                         WHERE v1.id_state = wsd.state
                           AND wsd.prof_type = l_prof_type
                           AND v1.id_drug_req_det = drd3.id_drug_req_det
                           AND drd3.id_drug_req = dr3.id_drug_req
                         GROUP BY v1.id_drug,
                                  v1.vers,
                                  v1.id_drug_presc_det,
                                  drd3.id_unit_measure_prep,
                                  v1.id_episode,
                                  v1.id_drug_req_det,
                                  v1.id_presc_directions,
                                  drd3.id_other_product) v4
                  LEFT JOIN mi_med mi
                    ON (v4.id_drug = mi.id_drug AND v4.vers = mi.vers)
                --This JOIN was changed because the function pk_prescription_directions.get_pharmacy_unidose_info wasn't returning the correct values [ALERT-108734]
                  LEFT JOIN (SELECT pd.id_presc_directions AS id_presc_directions,
                                    pdi.id_presc_dir_interval AS id_presc_dir_interval,
                                    nvl2(pdi.dt_begin, to_char(pdi.dt_begin, 'HH24:MI DD-MON-YYYY'), pdi.dt_begin) AS dt_begin,
                                    nvl2(pdi.dt_end, to_char(pdi.dt_end, 'HH24:MI DD-MON-YYYY'), pdi.dt_end) AS dt_end,
                                    nvl2(pdi.duration,
                                         pk_utils.number_to_char(i_prof, pdi.duration) || ' ' ||
                                         pk_prescription_directions.get_unit_measure_description(i_lang,
                                                                                                 pdi.id_unit_duration),
                                         pdi.duration) AS duration,
                                    pk_prescription_directions.get_dose_string(i_lang,
                                                                               i_prof,
                                                                               pddf.id_presc_dir_dosefreq) AS dose,
                                    pk_prescription_directions.get_frequency_string(i_lang,
                                                                                    i_prof,
                                                                                    pddf.id_presc_dir_dosefreq,
                                                                                    pd.flg_take_type) AS frequency_desc,
                                    pk_prescription_directions.get_hours_string(i_lang,
                                                                                i_prof,
                                                                                pddf.id_presc_dir_dosefreq) AS hours,
                                    pd.notes AS notes,
                                    pk_prescription_directions.get_route_description(i_lang, i_prof, 'L', pd.id_route) AS route
                             -- get each day frequency -> count(detalhes da frequencia para os tipos de frequencia em cada dia e quando no so outras frequencias)
                               FROM presc_directions pd
                              INNER JOIN presc_dir_interval pdi
                                 ON (pdi.id_presc_directions = pd.id_presc_directions)
                              INNER JOIN presc_dir_dosefreq pddf
                                 ON (pddf.id_presc_dir_interval = pdi.id_presc_dir_interval)) tf
                    ON (v4.id_presc_directions = tf.id_presc_directions)
                 WHERE (mi.flg_type IS NULL OR mi.flg_type NOT IN ('F', 'C', 'N')); --iv_fluids
        
            --IV
            g_error := 'QUERY O_MED_IV_BY_PAT';
            OPEN o_med_iv_by_pat FOR
                SELECT v5.id_drug,
                       v5.vers,
                       v5.id_drug_presc_det,
                       v5.med_descr,
                       --IV INFO
                       v5.iv_info.dose adm_dose,
                       v5.iv_info.bolus adm_bolus,
                       v5.iv_info.route adm_route,
                       v5.iv_info.drip adm_speed,
                       v5.iv_info.freq adm_freq,
                       v5.iv_info.schedule adm_schedule,
                       v5.iv_info.qty adm_qty,
                       v5.iv_info.notes presc_notes,
                       v5.iv_info.dt_begin presc_begin,
                       v5.iv_info.dt_end presc_end,
                       pk_prof_utils.get_name_signature(i_lang, i_prof, v5.iv_info.id_prof_prescriber) prof_name,
                       pk_prof_utils.get_spec_signature(i_lang,
                                                        i_prof,
                                                        v5.iv_info.id_prof_prescriber,
                                                        v5.iv_info.dt_prescription,
                                                        v5.id_episode) spec_name,
                       v5.iv_info.dt_prescription presc_dt,
                       --
                       v5.total_qty_to_prep,
                       v5.unit_translation,
                       v5.id_episode,
                       v5.chnm_id
                  FROM (SELECT v4.id_drug,
                               v4.vers,
                               v4.id_drug_presc_det,
                               get_medication_name(i_lang,
                                                   i_prof,
                                                   v4.id_drug,
                                                   v4.vers,
                                                   NULL,
                                                   v4.id_drug_presc_det,
                                                   g_no,
                                                   v4.id_other_product) med_descr,
                               v4.total_qty_to_prep,
                               pk_medication_core.get_unit_translation(i_lang, i_prof, v4.id_unit_measure_prep, NULL) unit_translation,
                               v4.id_episode,
                               get_chnm_id(v4.id_drug, v4.vers) chnm_id,
                               get_iv_info(i_lang, i_prof, i_prof.institution, v4.id_drug_presc_det) iv_info
                          FROM (SELECT v1.id_drug,
                                       v1.vers,
                                       v1.id_drug_presc_det,
                                       SUM(drd3.qty_to_prep) total_qty_to_prep,
                                       drd3.id_unit_measure_prep,
                                       v1.id_episode,
                                       v1.id_drug_req_det,
                                       v1.id_presc_directions,
                                       drd3.id_other_product
                                  FROM (SELECT v2.id_drug_req_det,
                                               v2.id_state,
                                               v2.id_episode,
                                               v2.drdst_dt_state,
                                               v2.drdst2_dt_state,
                                               v2.id_drug,
                                               v2.vers,
                                               v2.id_drug_presc_det,
                                               v2.id_presc_directions
                                          FROM (SELECT drd.id_drug_req_det,
                                                       drd.id_state,
                                                       e.id_episode,
                                                       drdst.dt_state          drdst_dt_state,
                                                       drdst2.dt_state         drdst2_dt_state,
                                                       drd.id_drug,
                                                       drd.vers,
                                                       dr.id_drug_presc_det,
                                                       drd.id_presc_directions
                                                  FROM drug_req_det                  drd,
                                                       drug_req                      dr,
                                                       episode                       e,
                                                       visit                         v,
                                                       patient                       p,
                                                       drug_req_det_state_transition drdst,
                                                       drug_req_det_state_transition drdst2
                                                 WHERE drd.id_drug_req = dr.id_drug_req
                                                   AND dr.id_episode = e.id_episode
                                                   AND e.id_episode IN (SELECT column_value
                                                                          FROM TABLE(i_episode)) ----------
                                                   AND e.id_visit = v.id_visit
                                                   AND dr.id_patient = p.id_patient
                                                   AND v.id_institution = i_prof.institution
                                                   AND v.flg_status != 'C' -- not canceled
                                                   AND e.flg_status = 'A' -- active episode
                                                   AND drd.id_state IN
                                                       (SELECT column_value
                                                          FROM TABLE(get_grid_allowed_states(i_prof,
                                                                                             g_flg_unidose,
                                                                                             'GRID_PAT_REPORT')))
                                                   AND dr.flg_type = g_flg_unidose
                                                   AND p.id_patient = e.id_patient
                                                   AND drd.id_drug_req_det = drdst.id_drug_req_det
                                                   AND drdst.id_state =
                                                       get_state_for_req_type(i_prof, g_flg_unidose, g_drd_requested_st)
                                                   AND drd.id_drug_req_det = drdst2.id_drug_req_det(+)
                                                   AND drd.id_state = drdst2.id_state(+)
                                                   AND get_grid_timeout(drd.id_state, i_prof, 'D') >
                                                       pk_date_utils.get_timestamp_diff(current_timestamp, drdst2.dt_state)
                                                   AND drdst.dt_state BETWEEN l_date_begin_tstz AND l_date_end_tstz) v2
                                         GROUP BY v2.id_drug_req_det,
                                                  v2.id_state,
                                                  v2.id_episode,
                                                  v2.drdst_dt_state,
                                                  v2.drdst2_dt_state,
                                                  v2.id_drug,
                                                  v2.vers,
                                                  v2.id_drug_presc_det,
                                                  v2.id_presc_directions --must get the recent one (drug_req_det_state_transition) --this is because loops on the workflow (reject > prepare > reject > prepara .. and so on)
                                        UNION ALL
                                        --executing with some supplies or terminated!
                                        SELECT v3.id_drug_req_det,
                                               v3.id_state,
                                               v3.id_episode,
                                               v3.drdst_dt_state,
                                               MAX(v3.drdst2_dt_state) drdst2_dt_state,
                                               v3.id_drug,
                                               v3.vers,
                                               v3.id_drug_presc_det,
                                               v3.id_presc_directions
                                          FROM (SELECT drd.id_drug_req_det,
                                                       drs.id_state,
                                                       e.id_episode,
                                                       drdst.dt_state          drdst_dt_state,
                                                       drdst2.dt_state         drdst2_dt_state,
                                                       drd.id_drug,
                                                       drd.vers,
                                                       dr.id_drug_presc_det,
                                                       drd.id_presc_directions
                                                  FROM drug_req_supply               drs,
                                                       drug_req_det                  drd,
                                                       drug_req                      dr,
                                                       episode                       e,
                                                       visit                         v,
                                                       patient                       p,
                                                       drug_req_det_state_transition drdst,
                                                       drug_req_det_state_transition drdst2
                                                 WHERE drs.id_drug_req_det = drd.id_drug_req_det
                                                   AND drd.id_drug_req = dr.id_drug_req
                                                   AND dr.id_episode = e.id_episode
                                                   AND e.id_episode IN (SELECT column_value
                                                                          FROM TABLE(i_episode)) ----------
                                                   AND e.id_visit = v.id_visit
                                                   AND dr.id_patient = p.id_patient
                                                   AND v.id_institution = i_prof.institution
                                                   AND v.flg_status != 'C' -- not canceled
                                                   AND e.flg_status = 'A' -- active episode
                                                   AND drd.id_state IN
                                                       (SELECT column_value
                                                          FROM TABLE(get_states_for_req_type(i_prof,
                                                                                             g_flg_unidose,
                                                                                             table_varchar(g_drd_executing_st,
                                                                                                           g_drd_terminated_st,
                                                                                                           g_drd_rejected2prep_st))))
                                                   AND dr.flg_type = g_flg_unidose
                                                   AND p.id_patient = e.id_patient
                                                   AND drs.id_state IN
                                                       (SELECT column_value
                                                          FROM TABLE(get_states_for_req_type(i_prof,
                                                                                             NULL,
                                                                                             g_grid_pat_drs_adm_states)))
                                                   AND drd.id_drug_req_det = drdst.id_drug_req_det
                                                   AND drdst.id_state =
                                                       get_state_for_req_type(i_prof, g_flg_unidose, g_drd_requested_st)
                                                   AND drd.id_drug_req_det = drdst2.id_drug_req_det(+)
                                                   AND drd.id_state = drdst2.id_state(+)
                                                   AND get_grid_timeout(drd.id_state, i_prof, 'D') >
                                                       pk_date_utils.get_timestamp_diff(current_timestamp, drdst2.dt_state)
                                                   AND drdst.dt_state BETWEEN l_date_begin_tstz AND l_date_end_tstz
                                                 GROUP BY drd.id_drug_req_det,
                                                          drs.id_state,
                                                          dr.dt_drug_req_tstz,
                                                          e.id_episode,
                                                          drdst.dt_state,
                                                          drdst2.dt_state,
                                                          drd.id_drug,
                                                          drd.vers,
                                                          dr.id_drug_presc_det,
                                                          drd.id_presc_directions --group multiple supplies into one request
                                                ) v3
                                         GROUP BY v3.id_drug_req_det,
                                                  v3.id_state,
                                                  v3.id_episode,
                                                  v3.drdst_dt_state,
                                                  v3.id_drug,
                                                  v3.vers,
                                                  v3.id_drug_presc_det,
                                                  v3.id_presc_directions) v1,
                                       wfl_state_detail wsd,
                                       drug_req dr3,
                                       drug_req_det drd3
                                 WHERE v1.id_state = wsd.state
                                   AND wsd.prof_type = l_prof_type
                                   AND v1.id_drug_req_det = drd3.id_drug_req_det
                                   AND drd3.id_drug_req = dr3.id_drug_req
                                 GROUP BY v1.id_drug,
                                          v1.vers,
                                          v1.id_drug_presc_det,
                                          drd3.id_unit_measure_prep,
                                          v1.id_episode,
                                          v1.id_drug_req_det,
                                          v1.id_presc_directions,
                                          drd3.id_other_product) v4
                         INNER JOIN mi_med mi
                            ON (v4.id_drug = mi.id_drug AND v4.vers = mi.vers)
                         WHERE mi.flg_type IN ('F', 'C', 'N') --iv_fluids
                        ) v5;
        
        END IF;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'get_auto_report_med_print_tool', o_error);
            pk_types.open_my_cursor(o_context);
            pk_types.open_my_cursor(o_patients);
            pk_types.open_my_cursor(o_med_by_pat);
            pk_types.open_my_cursor(o_med_iv_by_pat);
            RETURN FALSE;
    END get_auto_report_med_print_tool;

    /********************************************************************************************
    * alert.pk_pharmacy.get_physician_list
    *
    * @param  i_lang        in  language.id_language%type,
    * @param  i_prof        in  alert.profissional,
    * @param  o_info        out pk_types.cursor_type,
    * @param  o_error       out t_error_out
    *
    * @return NUMBER
    *
    * @author Pedro Albuquerque
    * @version  1.0
    * @since  2009-11-12
    *
    ********************************************************************************************/
    FUNCTION get_physician_list
    (
        i_lang  IN language.id_language%TYPE,
        i_prof  IN alert.profissional,
        o_info  OUT pk_types.cursor_type,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
    
        OPEN o_info FOR
            SELECT p1.name prof_name, v1.prof_id prof_id
              FROM (SELECT p.id_professional AS prof_id
                      FROM prof_soft_inst psi, professional p
                     WHERE psi.id_professional = p.id_professional
                       AND psi.id_institution = i_prof.institution
                       AND pk_medication_current.get_prof_cat(alert.profissional(p.id_professional,
                                                                                 i_prof.institution,
                                                                                 0)) = 'D'
                     GROUP BY p.id_professional) v1,
                   professional p1
             WHERE p1.id_professional = v1.prof_id;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_types.open_my_cursor(o_info);
            RAISE;
            RETURN FALSE;
    END get_physician_list;

    /**********************************************************************************************
    * This function returns prescription values, according input parameter I_PARAM_TYPE
    *
    * @param i_lang                          Language ID
    * @param i_prof                          Profissional array
    * @param i_id_drug_presc_det             Drug_Presc_Det ID
    * @param i_param_type                    Parameter Type: ROUTE / DOSE / FREQ / DTBEGIN
    *
    * @return                                Presciption attribute
    *
    * @author                                Nuno Miguel Ferreira
    * @version                               2.5
    * @since                                 2009/11/16
    **********************************************************************************************/
    FUNCTION get_presc_dyn_data
    (
        i_lang              IN language.id_language%TYPE,
        i_prof              IN profissional,
        i_id_drug_presc_det drug_presc_det.id_drug_presc_det%TYPE,
        i_param_type        IN VARCHAR2
    ) RETURN VARCHAR2 IS
        l_dpd_row              drug_presc_det%ROWTYPE;
        l_route                VARCHAR2(100);
        l_dose                 VARCHAR2(100);
        l_id_unit_dose         drug_presc_det.id_unit_measure%TYPE;
        l_dt_begin             VARCHAR2(100);
        l_duration             VARCHAR2(100);
        l_id_unit_measure_dur  drug_presc_det.id_unit_measure_dur%TYPE;
        l_frequency            VARCHAR2(100);
        l_id_unit_measure_freq drug_presc_det.id_unit_measure_freq%TYPE;
        l_frequency_string     VARCHAR2(4000);
        l_hours_string         VARCHAR2(4000);
    
    BEGIN
    
        g_error := 'GET DRUG_PRESC_DET REGISTER';
        SELECT *
          INTO l_dpd_row
          FROM drug_presc_det
         WHERE id_drug_presc_det = i_id_drug_presc_det;
    
        IF i_param_type = 'ROUTE'
        THEN
            g_error := 'GET ROUTE';
            BEGIN
                SELECT mr.route_descr
                  INTO l_route
                  FROM alert.mi_route mr, mi_med m
                 WHERE m.id_drug = l_dpd_row.id_drug
                   AND mr.route_id = m.route_id
                   AND mr.vers = l_dpd_row.vers
                   AND m.vers = l_dpd_row.vers;
            EXCEPTION
                WHEN OTHERS THEN
                    NULL;
            END;
        END IF;
    
        g_error := 'Dose / ID_Dose_unit / Frequency';
        IF l_dpd_row.id_presc_directions IS NULL
        THEN
            -- Simple Instructions
            IF i_param_type = 'DTBEGIN'
            THEN
                g_error    := 'DT BEGIN';
                l_dt_begin := to_char(l_dpd_row.dt_begin_tstz, 'HH24:MI DD-MON-YYYY');
            
            ELSIF i_param_type = 'DOSE'
            THEN
            
                g_error        := 'DOSE';
                l_dose         := nvl(l_dpd_row.qty, l_dpd_row.qty_inst);
                l_id_unit_dose := nvl(l_dpd_row.id_unit_measure, l_dpd_row.unit_measure_inst);
            
            ELSIF i_param_type = 'DURATION'
            THEN
            
                g_error               := 'DURATION';
                l_duration            := l_dpd_row.duration;
                l_id_unit_measure_dur := l_dpd_row.id_unit_measure_dur;
            
                SELECT decode(l_duration,
                              NULL,
                              NULL,
                              l_duration || ' ' ||
                              alert.pk_unit_measure.get_uom_abbreviation(i_lang, i_prof, l_id_unit_measure_dur))
                  INTO l_duration
                  FROM dual;
            
            ELSIF i_param_type = 'FREQ'
            THEN
            
                -- Irregular Directions Instructions
                IF l_dpd_row.id_irregular_directions IS NOT NULL
                THEN
                    g_error := 'IRREGULAR INTERVAL';
                    SELECT pk_translation.get_translation(i_lang, irr_freq.code_irregular_frequency), -- || ' - ' ||
                           pk_translation.get_translation(i_lang, irr_int.code_irregular_interval)
                      INTO l_frequency_string, l_hours_string
                      FROM alert.irregular_interval irr_int
                     INNER JOIN alert.irregular_frequency irr_freq
                        ON irr_int.id_irregular_frequency = irr_freq.id_irregular_frequency
                     WHERE irr_int.id_irregular_interval = l_dpd_row.id_irregular_directions;
                ELSE
                    g_error                := 'FREQUENCY';
                    l_frequency            := l_dpd_row.frequency;
                    l_id_unit_measure_freq := l_dpd_row.id_unit_measure_freq;
                
                    l_frequency_string := l_frequency || ' ' ||
                                          alert.pk_unit_measure.get_uom_abbreviation(i_lang         => i_lang,
                                                                                     i_prof         => i_prof,
                                                                                     i_unit_measure => l_id_unit_measure_freq);
                
                END IF;
            ELSIF i_param_type = 'HOURS'
            THEN
                IF l_dpd_row.id_irregular_directions IS NOT NULL
                THEN
                    g_error := 'IRREGULAR INTERVAL';
                    SELECT pk_translation.get_translation(i_lang, irr_freq.code_irregular_frequency), -- || ' - ' ||
                           pk_translation.get_translation(i_lang, irr_int.code_irregular_interval)
                      INTO l_frequency_string, l_hours_string
                      FROM alert.irregular_interval irr_int
                     INNER JOIN alert.irregular_frequency irr_freq
                        ON irr_int.id_irregular_frequency = irr_freq.id_irregular_frequency
                     WHERE irr_int.id_irregular_interval = l_dpd_row.id_irregular_directions;
                ELSE
                    g_error                := 'FREQUENCY';
                    l_frequency            := l_dpd_row.frequency;
                    l_id_unit_measure_freq := l_dpd_row.id_unit_measure_freq;
                
                    l_frequency_string := l_frequency || ' ' ||
                                          alert.pk_unit_measure.get_uom_abbreviation(i_lang         => i_lang,
                                                                                     i_prof         => i_prof,
                                                                                     i_unit_measure => l_id_unit_measure_freq);
                
                END IF;
            END IF;
        
        ELSE
        
            -- NEW Popup Instructions
            IF i_param_type = 'DURATION'
            THEN
                g_error := 'DURATION';
                SELECT duration_value, duration_value_unit, to_char(date_begin, 'DD-MON-YYYY HH24:MI') --pk_date_utils.date_send_tsz(i_lang, date_begin, i_prof)
                  INTO l_duration, l_id_unit_measure_dur, l_dt_begin
                  FROM alert.presc_duration pd
                 WHERE pd.id_presc_instr_det = l_dpd_row.id_presc_instr_det;
            ELSIF i_param_type = 'DOSE'
            THEN
                g_error := 'DOSE';
                SELECT dose_value, dose_value_unit
                  INTO l_dose, l_id_unit_dose
                  FROM alert.presc_dose pd
                 WHERE pd.id_presc_instr_det = l_dpd_row.id_presc_instr_det;
            ELSIF i_param_type = 'FREQ'
            THEN
                g_error := 'FREQUENCY';
                SELECT pk_translation.get_translation(i_lang, pf.code_presc_frequency)
                  INTO l_frequency_string
                  FROM alert.presc_instr_freq pif
                 INNER JOIN alert.presc_freq_det pfd
                    ON pif.id_presc_instr_freq = pfd.id_presc_instr_freq
                 INNER JOIN alert.presc_frequency pf
                    ON pfd.id_presc_frequency = pf.id_presc_frequency
                 WHERE pif.id_presc_instr_det = l_dpd_row.id_presc_instr_det;
            ELSIF i_param_type = 'DTBEGIN'
            THEN
                g_error    := 'DT BEGIN';
                l_dt_begin := to_char(l_dpd_row.dt_begin_tstz, 'HH24:MI DD-MON-YYYY');
            ELSIF i_param_type = 'HOURS'
            THEN
                g_error := 'IRREGULAR INTERVAL';
                SELECT pk_translation.get_translation(i_lang, irr_freq.code_irregular_frequency), -- || ' - ' ||
                       pk_translation.get_translation(i_lang, irr_int.code_irregular_interval)
                  INTO l_frequency_string, l_hours_string
                  FROM alert.irregular_interval irr_int
                 INNER JOIN alert.irregular_frequency irr_freq
                    ON irr_int.id_irregular_frequency = irr_freq.id_irregular_frequency
                 WHERE irr_int.id_irregular_interval = l_dpd_row.id_irregular_directions;
            END IF;
        
        END IF;
    
        --get frequency = SOS or Unitario
        g_error := 'get frequency = SOS or Unitario';
        IF l_dpd_row.flg_take_type = pk_prescription_int.g_drug_presc_det_u
        THEN
            l_frequency_string := pk_sysdomain.get_domain(i_code_dom => 'DRUG_PRESC_DET.FLG_TAKE_TYPE',
                                                          i_val      => pk_prescription_int.g_drug_presc_det_u,
                                                          i_lang     => i_lang);
        ELSIF l_dpd_row.flg_take_type = pk_prescription_int.g_drug_presc_det_s
        THEN
            l_frequency_string := pk_sysdomain.get_domain(i_code_dom => 'DRUG_PRESC_DET.FLG_TAKE_TYPE',
                                                          i_val      => pk_prescription_int.g_drug_presc_det_s,
                                                          i_lang     => i_lang);
        END IF;
    
        -- Funciton Return Values
        IF i_param_type = 'ROUTE'
        THEN
            RETURN l_route;
        ELSIF i_param_type = 'DOSE'
        THEN
            SELECT decode(l_dose,
                          NULL,
                          NULL,
                          l_dose || ' ' || alert.pk_unit_measure.get_uom_abbreviation(i_lang, i_prof, l_id_unit_dose))
              INTO l_dose
              FROM dual;
        
            RETURN l_dose;
        
        ELSIF i_param_type = 'FREQ'
        THEN
            RETURN l_frequency_string;
        ELSIF i_param_type = 'HOURS'
        THEN
            RETURN l_hours_string;
        ELSIF i_param_type = 'DTBEGIN'
        THEN
            RETURN l_dt_begin;
        ELSIF i_param_type = 'DURATION'
        THEN
            SELECT decode(l_duration,
                          NULL,
                          NULL,
                          l_duration || ' ' ||
                          alert.pk_unit_measure.get_uom_abbreviation(i_lang, i_prof, l_id_unit_measure_dur))
              INTO l_duration
              FROM dual;
        
            RETURN l_duration;
        END IF;
    
        RETURN NULL;
    
    EXCEPTION
        WHEN OTHERS THEN
            RETURN NULL;
    END get_presc_dyn_data;

    /********************************************************************************************
    * alert.pk_pharmacy.get_pat_list_car_print_tool
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_SERVICE                  IN    REF CURSOR
    * @param  O_INFO                      OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Pedro Albuquerque
    * @version  1.0
    * @since  2009-11-13
    *
    ********************************************************************************************/
    FUNCTION get_pat_list_car_print_tool
    (
        i_lang       IN language.id_language%TYPE,
        i_prof       IN alert.profissional,
        i_id_service IN table_number,
        o_info       OUT pk_types.cursor_type,
        o_error      OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        OPEN o_info FOR
            SELECT get_pat_name(i_lang, i_prof, v1.id_patient) pat_name,
                   v1.id_episode,
                   v1.id_dep_clin_serv,
                   v1.cars,
                   decode(get_pat_location(i_lang, i_prof, v1.id_episode, v1.id_patient, 'TEXT', 'BED'),
                          NULL,
                          g_no,
                          g_yes) has_bed
              FROM (SELECT dr.id_patient,
                           dr.id_episode,
                           dcs.id_dep_clin_serv,
                           pharmacy_tbl2varchar(pharmacy_aggr_str_distinct(ucm.car_model_name)) cars
                      FROM department d
                     INNER JOIN dep_clin_serv dcs
                        ON (d.id_department = dcs.id_department)
                     INNER JOIN clinical_service cs
                        ON (dcs.id_clinical_service = cs.id_clinical_service)
                     INNER JOIN pharm_unidose_car_model ucm
                        ON (dcs.id_dep_clin_serv = ucm.id_dep_clin_serv)
                     INNER JOIN pharm_unidose_car uc
                        ON (ucm.id_unidose_car_model = uc.id_car_model)
                     INNER JOIN TABLE(pk_pharmacy.get_orders_for_car(uc.id_unidose_car)) x1
                        ON (uc.id_unidose_car = x1.id_unidose_car)
                     INNER JOIN drug_req_det drd
                        ON (x1.id_drug_req_det = drd.id_drug_req_det)
                     INNER JOIN drug_req dr
                        ON (drd.id_drug_req = dr.id_drug_req)
                     INNER JOIN episode e
                        ON (dr.id_episode = e.id_episode)
                     WHERE dcs.id_dep_clin_serv IN (SELECT column_value
                                                      FROM TABLE(i_id_service))
                       AND d.id_institution = i_prof.institution
                       AND e.flg_status = 'A' --active
                       AND uc.id_state IN
                           (SELECT column_value
                              FROM TABLE(get_states_for_req_type(i_prof,
                                                                 NULL,
                                                                 table_varchar(g_uni_car_parked_st,
                                                                               g_uni_car_executing_st,
                                                                               g_uni_car_ready4transp_st))))
                     GROUP BY dr.id_patient, dr.id_episode, dcs.id_dep_clin_serv) v1
             ORDER BY pat_name;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, o_error.err_desc, 'get_pat_list_car_print_tool', o_error);
            pk_types.open_my_cursor(o_info);
            RETURN FALSE;
    END get_pat_list_car_print_tool;

    /********************************************************************************************
    * alert.pk_pharmacy.get_interop_car_info
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_INSTANCE_CAR               IN    NUMBER(24)
    * @param  O_CAR_SUPPLIES                  OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Srgio Cunha
    * @version  2.5.0.7.4
    * @since  2009-12-11
    *
    ********************************************************************************************/
    FUNCTION get_interop_car_info
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN alert.profissional,
        i_id_instance_car IN drug_req_supply_dev.id_drug_req_supply_dev%TYPE,
        o_car_supplies    OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'get_interop_car_info';
    BEGIN
    
        g_error := 'QUERY o_car_supplies';
        OPEN o_car_supplies FOR
            SELECT x.id_unidose_car id_instance_car,
                   drdst.dt_state dt_validated_tstz,
                   drdst.id_prof id_prof_disp,
                   drd.id_drug_req_det,
                   nvl(drd.id_drug, drd.id_other_product) id_item,
                   get_medication_name(i_lang,
                                       i_prof,
                                       drd.id_drug,
                                       drd.vers,
                                       dr.flg_type,
                                       dr.id_drug_presc_det,
                                       g_yes,
                                       drd.id_other_product) desc_item,
                   drd.vers,
                   decode(drd.id_drug,
                          NULL,
                          'O',
                          (SELECT mi.flg_type
                             FROM mi_med mi
                            WHERE mi.id_drug = drd.id_drug
                              AND mi.vers = drd.vers)) flg_item_type,
                   drd.qty_to_prep qty_disp,
                   drd.id_unit_measure_prep id_unit_disp,
                   pk_medication_core.get_unit_translation(i_lang, i_prof, drd.id_unit_measure_prep, 2) descr_unit_disp,
                   drd.package_number lote,
                   drd.dt_expire_tstz prazo_validade,
                   dr.id_episode id_episodio,
                   dr.id_patient
              FROM TABLE(pk_pharmacy.get_orders_for_car(i_id_instance_car)) x
             INNER JOIN drug_req_det drd
                ON (x.id_drug_req_det = drd.id_drug_req_det)
             INNER JOIN drug_req dr
                ON (drd.id_drug_req = dr.id_drug_req)
             INNER JOIN drug_req_det_state_transition drdst
                ON (drd.id_drug_req_det = drdst.id_drug_req_det AND drd.id_state = drdst.id_state)
             WHERE drd.id_state = pk_pharmacy.get_state_for_req_type(i_prof, 'U', pk_pharmacy.g_drd_validated_st);
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, o_error);
            pk_types.open_my_cursor(o_car_supplies);
            RETURN FALSE;
    END get_interop_car_info;

    /********************************************************************************************
    * alert.pk_pharmacy.set_kardex_success
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_UNIDOSE_CAR                IN    NUMBER(24)
    * @param  I_COMMIT                        IN    VARCHAR2
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Srgio Cunha
    * @version  2.5.0.7.4
    * @since  2009-12-11
    *
    ********************************************************************************************/
    FUNCTION set_kardex_success
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN alert.profissional,
        i_id_unidose_car IN pharm_unidose_car.id_unidose_car%TYPE,
        i_commit         IN VARCHAR2,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'set_kardex_success';
    BEGIN
    
        g_error := 'UPDATE PHARM_UNIDOSE_CAR SUCCESS';
        UPDATE pharm_unidose_car puc
           SET puc.flg_kardex_success = pk_alert_constant.g_yes, puc.dt_kardex_success = current_timestamp
         WHERE puc.id_unidose_car = i_id_unidose_car;
    
        IF i_commit = pk_alert_constant.g_yes
        THEN
            COMMIT;
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, o_error);
        
            RETURN FALSE;
    END set_kardex_success;

    /********************************************************************************************
    * alert.pk_pharmacy.set_send_to_kardex
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_CARS                       IN    ALERT.TABLE_NUMBER
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Rui Marante
    * @version  2.5.0.7.4
    * @since  2009-12-11
    *
    ********************************************************************************************/
    FUNCTION set_send_to_kardex
    (
        i_lang    IN language.id_language%TYPE,
        i_prof    IN profissional,
        i_id_cars IN table_number,
        o_error   OUT t_error_out
    ) RETURN BOOLEAN IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'set_send_to_kardex';
        l_ret   BOOLEAN := FALSE;
        l_error VARCHAR2(4000 CHAR) := '';
    BEGIN
        IF (i_id_cars.count > 0)
        THEN
            FOR i IN i_id_cars.first .. i_id_cars.last
            LOOP
                l_ret := pk_ia_event_prescription.pharmacy_car_validated_v2(i_id_institution => i_prof.institution,
                                                                            i_id_unidose_car => i_id_cars(i),
                                                                            o_error          => l_error);
                IF (NOT l_ret)
                THEN
                    set_pharmacy_log(l_db_object_name,
                                     'i_prof.institution=' || i_prof.institution || ' i_id_cars(i)=' || i_id_cars(i) ||
                                     ' error=' || l_error);
                    raise_application_error(-20099, l_error);
                END IF;
            END LOOP;
        END IF;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, l_error, l_db_object_name, o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_send_to_kardex;

    /********************************************************************************************
    * alert.pk_pharmacy.create_mi_med_dosage  
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_DRUG                          IN    VARCHAR2
    * @param  I_VERSION                       IN    VARCHAR2
    * @param  I_ID_FORM_FARM                  IN    VARCHAR2
    * @param  I_QTY_DOS_DEN                   IN    NUMBER(24,2)
    * @param  I_ID_UNIT_DOS_DEN               IN    NUMBER(24)
    * @param  I_QTY_EMB                       IN    NUMBER(24,2)
    * @param  I_ID_UNIT_EMB                   IN    NUMBER(24)
    * @param  I_FLG_AVAILABLE                 IN    VARCHAR2
    * @param  I_QTY_DOS_NUM                   IN    NUMBER(24,2)
    * @param  I_ID_UNIT_DOS_NUM               IN    NUMBER(24)
    * @param  I_FLG_FRACTION                  IN    VARCHAR2
    * @param  I_ID_UNIT_DISPENSE              IN    NUMBER(24)
    * @param    I_FLG_UPD_NULL                  IN      VARCHAR2 DEFAULT 'N'
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Pedro Martins Santos
    * @version  2.5.0.7.8
    * @since  2010-04-26
    *
    * @notes  
    *
    ********************************************************************************************/
    PROCEDURE create_mi_med_dosage
    (
        i_lang             IN language.id_language%TYPE,
        i_prof             IN alert.profissional,
        i_drug             IN mi_med_dosage.id_drug%TYPE,
        i_version          IN mi_med_dosage.version%TYPE,
        i_id_form_farm     IN mi_med_dosage.id_form_farm%TYPE,
        i_qty_dos_den      IN mi_med_dosage.qty_dosage_denom%TYPE,
        i_id_unit_dos_den  IN mi_med_dosage.id_unit_dosage_denom%TYPE,
        i_qty_emb          IN mi_med_dosage.qty_emb%TYPE,
        i_id_unit_emb      IN mi_med_dosage.id_unit_emb%TYPE,
        i_flg_available    IN mi_med_dosage.flg_available%TYPE,
        i_qty_dos_num      IN mi_med_dosage.qty_dosage_numer%TYPE,
        i_id_unit_dos_num  IN mi_med_dosage.id_unit_dosage_numer%TYPE,
        i_flg_fraction     IN mi_med_dosage.flg_fractionable%TYPE,
        i_id_unit_dispense IN mi_med_dosage.id_unit_dispense%TYPE,
        i_flg_upd_null     IN VARCHAR2 DEFAULT 'N'
    ) IS
        l_count NUMBER(1) := 0;
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'create_mi_med_dosage';
        l_ex_err EXCEPTION;
    BEGIN
        IF (i_drug IS NULL OR i_version IS NULL)
        THEN
            RAISE l_ex_err;
        END IF;
    
        IF i_flg_upd_null = g_no
        THEN
            UPDATE mi_med_dosage mmd
               SET mmd.id_form_farm         = nvl(i_id_form_farm, mmd.id_form_farm),
                   mmd.qty_dosage_denom     = nvl(i_qty_dos_den, mmd.qty_dosage_denom),
                   mmd.id_unit_dosage_denom = nvl(i_id_unit_dos_den, mmd.id_unit_dosage_denom),
                   mmd.qty_emb              = nvl(i_qty_emb, mmd.qty_emb),
                   mmd.id_unit_emb          = nvl(i_id_unit_emb, mmd.id_unit_emb),
                   mmd.flg_available        = nvl(i_flg_available, mmd.flg_available),
                   mmd.qty_dosage_numer     = nvl(i_qty_dos_num, mmd.qty_dosage_numer),
                   mmd.id_unit_dosage_numer = nvl(i_id_unit_dos_num, mmd.id_unit_dosage_numer),
                   mmd.flg_fractionable     = nvl(i_flg_fraction, mmd.flg_fractionable),
                   mmd.id_unit_dispense     = nvl(i_id_unit_dispense, mmd.id_unit_dispense)
             WHERE mmd.id_drug = i_drug
               AND mmd.version = i_version
            RETURNING COUNT(1) INTO l_count;
        ELSE
            UPDATE mi_med_dosage mmd
               SET mmd.id_form_farm         = i_id_form_farm,
                   mmd.qty_dosage_denom     = i_qty_dos_den,
                   mmd.id_unit_dosage_denom = i_id_unit_dos_den,
                   mmd.qty_emb              = i_qty_emb,
                   mmd.id_unit_emb          = i_id_unit_emb,
                   mmd.flg_available        = i_flg_available,
                   mmd.qty_dosage_numer     = i_qty_dos_num,
                   mmd.id_unit_dosage_numer = i_id_unit_dos_num,
                   mmd.flg_fractionable     = i_flg_fraction,
                   mmd.id_unit_dispense     = i_id_unit_dispense
             WHERE mmd.id_drug = i_drug
               AND mmd.version = i_version
            RETURNING COUNT(1) INTO l_count;
        END IF;
    
        -- if = 0 - update else insert
        IF (l_count = 0)
        THEN
            g_error := 'Insert into mi_med_dosage';
            set_pharmacy_log(l_db_object_name, g_error);
        
            INSERT INTO mi_med_dosage
                (id_drug,
                 version,
                 id_form_farm,
                 qty_dosage_denom,
                 id_unit_dosage_denom,
                 qty_emb,
                 id_unit_emb,
                 flg_available,
                 qty_dosage_numer,
                 id_unit_dosage_numer,
                 flg_fractionable,
                 id_unit_dispense)
            VALUES
                (i_drug,
                 i_version,
                 i_id_form_farm,
                 i_qty_dos_den,
                 i_id_unit_dos_den,
                 i_qty_emb,
                 i_id_unit_emb,
                 i_flg_available,
                 i_qty_dos_num,
                 i_id_unit_dos_num,
                 i_flg_fraction,
                 i_id_unit_dispense);
        END IF;
    
    EXCEPTION
        WHEN OTHERS THEN
            set_pharmacy_log(l_db_object_name,
                             'id_drug=' || i_drug || '###version=' || i_version || '###error=' || SQLERRM);
            RAISE;
    END create_mi_med_dosage;

    FUNCTION get_clin_serv_from_drd
    (
        i_lang              IN language.id_language%TYPE,
        i_prof              IN alert.profissional,
        i_id_drug_presc_det IN drug_presc_det.id_drug_presc_det%TYPE
    ) RETURN dep_clin_serv.id_clinical_service%TYPE IS
        l_id_clinical_service dep_clin_serv.id_clinical_service%TYPE := NULL;
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'get_clin_serv_from_drd';
    BEGIN
        BEGIN
            SELECT dcs.id_clinical_service
              INTO l_id_clinical_service
              FROM TABLE(pk_pharmacy.get_order_car_allocation(i_id_drug_presc_det)) drdalloc
              LEFT JOIN pharm_unidose_car uc
                ON (drdalloc.id_unidose_car = uc.id_unidose_car)
              LEFT JOIN pharm_unidose_car_model ucm
                ON (uc.id_car_model = ucm.id_unidose_car_model)
              LEFT JOIN dep_clin_serv dcs
                ON (ucm.id_dep_clin_serv = dcs.id_dep_clin_serv)
             WHERE rownum = 1;
        EXCEPTION
            WHEN no_data_found THEN
                l_id_clinical_service := NULL;
        END;
    
        RETURN l_id_clinical_service;
    
    EXCEPTION
        WHEN OTHERS THEN
            set_pharmacy_log(l_db_object_name, 'i_id_drug_presc_det=' || i_id_drug_presc_det || '###error=' || SQLERRM);
            RAISE;
    END get_clin_serv_from_drd;

    /********************************************************************************************
    * alert.pk_pharmacy.supplied_drugs (PIPELINED) 
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_DRUG_PRESC_DET             IN    NUMBER(24)
    *
    * @return ALERT.T_TBL_PHARM_SUPPLY
    *
    * @author Pedro Miranda
    * @version  2.5.0.7.7.2
    * @since  2010-05-06
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION supplied_drugs
    (
        i_lang              IN language.id_language%TYPE,
        i_prof              IN alert.profissional,
        i_id_drug_presc_det IN drug_presc_det.id_drug_presc_det%TYPE
    ) RETURN t_tbl_pharm_supply_car
        PIPELINED IS
        l_req_type_state NUMBER(24);
        --
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'supplied_drugs';
    BEGIN
        l_req_type_state := pk_pharmacy.get_state_for_req_type(i_prof, NULL, g_drs_supplied_st);
    
        FOR row_i IN (SELECT drd.id_drug id_drug,
                             drd.vers version,
                             drs.qty_supply qty_disp,
                             drd.id_unit_measure_prep id_unit_disp,
                             drs.package_number lot_number,
                             drs.dt_expire dt_expire,
                             drs.id_drug_req_supply drug_req_supply,
                             dr.id_drug_presc_det id_drug_presc_det,
                             drd.id_other_product id_other_product,
                             get_dept_clin_serv_from_drd(i_lang, i_prof, drd.id_drug_req_det) id_dep_clin_serv,
                             nvl(pucm2.id_unidose_car_model, pucm.id_unidose_car_model) id_car_model,
                             nvl(pucm2.car_model_name, pucm.car_model_name) car_name
                        FROM drug_req dr
                        LEFT JOIN drug_req_det drd
                          ON (dr.id_drug_req = drd.id_drug_req)
                        LEFT JOIN drug_req_supply drs
                          ON (drd.id_drug_req_det = drs.id_drug_req_det)
                        LEFT JOIN drug_req_sup_state_transition drss
                          ON (drs.id_drug_req_supply = drss.id_drug_req_supply)
                      --
                        LEFT JOIN pharm_unidose_car_content pucc
                          ON (drd.id_drug_req_det = pucc.id_drug_req_det)
                        LEFT JOIN pharm_unidose_car puc
                          ON (pucc.id_unidose_car = puc.id_unidose_car)
                        LEFT JOIN pharm_unidose_car_model pucm
                          ON (puc.id_car_model = pucm.id_unidose_car_model)
                        LEFT JOIN pharm_unidose_slot_content pusc
                          ON (drd.id_drug_req_det = pusc.id_drug_req_det)
                        LEFT JOIN pharm_unidose_car puc2
                          ON (pusc.id_unidose_car = puc2.id_unidose_car)
                        LEFT JOIN pharm_unidose_car_model pucm2
                          ON (puc2.id_car_model = pucm2.id_unidose_car_model)
                       WHERE dr.id_drug_presc_det = i_id_drug_presc_det
                         AND drss.id_state = l_req_type_state)
        LOOP
            PIPE ROW(t_rec_pharm_supply_car(row_i.id_drug,
                                            row_i.version,
                                            row_i.id_unit_disp,
                                            row_i.qty_disp,
                                            row_i.lot_number,
                                            row_i.dt_expire,
                                            row_i.drug_req_supply,
                                            row_i.id_drug_presc_det,
                                            row_i.id_other_product,
                                            row_i.id_dep_clin_serv,
                                            row_i.id_car_model,
                                            row_i.car_name));
        END LOOP;
    
    EXCEPTION
        WHEN OTHERS THEN
            set_pharmacy_log(l_db_object_name,
                             'i_id_drug_presc_det=' || i_id_drug_presc_det || '###l_req_type_state=' ||
                             l_req_type_state || '###error=' || SQLERRM);
            RAISE;
    END supplied_drugs;

    /********************************************************************************************
    * alert.pk_pharmacy.calc_takes_and_dispense  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_ID_PRESC_INSTR_DET            IN        NUMBER(24)
    * @param  I_DRUG                          IN        VARCHAR2
    * @param  I_VERSION                       IN        VARCHAR2
    * @param  I_FLG_TYPE                      IN        VARCHAR2
    * @param  I_DO_AUTO_DISPENSE_CALC         IN        VARCHAR2
    * @param  I_DT_BEGIN                      IN        TIMESTAMP WITH LOCAL TIME ZONE
    * @param  I_DT_END                        IN        TIMESTAMP WITH LOCAL TIME ZONE
    * @param  IO_QTY_REQ                      IN/OUT    NUMBER(24,4)
    * @param  IO_UNIT_MEASURE                 IN/OUT    NUMBER(24)
    * @param  IO_DISPENSE                     IN/OUT    NUMBER(24,4)
    * @param  IO_UNIT_MEASURE_DISPENSE        IN/OUT    NUMBER(24)
    * @param  O_HAS_TAKES                     OUT       VARCHAR2
    * @param  O_ERROR                         OUT       ALERT.T_ERROR_OUT
    *
    * @author Pedro Martins Santos
    * @version  2.5.0.7.7.2
    * @since  2010-05-20
    *
    * @notes  
    *
    ********************************************************************************************/
    PROCEDURE calc_takes_and_dispense
    (
        i_lang                   IN language.id_language%TYPE,
        i_prof                   IN alert.profissional,
        i_id_presc_instr_det     IN presc_directions.id_presc_directions%TYPE,
        i_drug                   IN drug_req_det.id_drug%TYPE,
        i_version                IN drug_req_det.vers%TYPE,
        i_flg_type               IN drug_req.flg_type%TYPE, -- U - unidose; I - prescription (receita)
        i_do_auto_dispense_calc  IN VARCHAR2 DEFAULT 'N', --unidose
        i_dt_begin               IN TIMESTAMP WITH LOCAL TIME ZONE DEFAULT NULL,
        i_dt_end                 IN TIMESTAMP WITH LOCAL TIME ZONE DEFAULT NULL,
        io_qty_req               IN OUT drug_req_det.qty_req%TYPE,
        io_unit_measure          IN OUT drug_req_det.id_unit_measure%TYPE,
        io_dispense              IN OUT drug_req_det.dispense%TYPE,
        io_unit_measure_dispense IN OUT drug_req_det.unit_measure_dispense%TYPE,
        o_has_takes              OUT VARCHAR2,
        o_error                  OUT t_error_out
    ) IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'CALC_TAKES_AND_DISPENSE';
        --
        l_ret                   BOOLEAN := FALSE;
        l_qty_req               drug_req_det.qty_req%TYPE;
        l_unit_measure          drug_req_det.id_unit_measure%TYPE;
        l_dispense              NUMBER;
        l_unit_measure_dispense NUMBER;
        --**********************
        l_dt_begin TIMESTAMP WITH LOCAL TIME ZONE;
        l_dt_end   TIMESTAMP WITH LOCAL TIME ZONE;
        --**********************
        l_tbl_takes    t_tbl_pharm_takes := t_tbl_pharm_takes();
        l_tbl_dispense t_tbl_pharm_dispense_takes := t_tbl_pharm_dispense_takes();
        l_tbl_takes2   table_table_number;
        l_has_takes    VARCHAR2(1 CHAR) := g_yes;
        --
        l_auto_disp_calc      VARCHAR2(1 CHAR) := g_no;
        l_id_dep_clin_service epis_info.id_dep_clin_serv%TYPE;
        --
    BEGIN
        l_auto_disp_calc := nvl(pk_sysconfig.get_config('PHARMACY_AUTOMATIC_DISPENSE_CALCULATION', i_prof), g_no);
    
        IF (l_auto_disp_calc = g_yes)
        THEN
            IF (i_do_auto_dispense_calc = g_yes)
            THEN
                set_pharmacy_log(l_db_object_name,
                                 'BEGIN! #########i_do_auto_dispense_calc=' || i_do_auto_dispense_calc ||
                                 '###i_id_presc_instr_det=' || i_id_presc_instr_det || '###i_drug=' || i_drug || ' ' ||
                                 i_version || '###i_flg_type=' || i_flg_type || '###io_qty_req=' || io_qty_req);
            
                IF (i_id_presc_instr_det IS NOT NULL)
                THEN
                
                    l_has_takes := g_no;
                
                    IF (i_flg_type = g_flg_unidose AND i_dt_begin IS NULL AND i_dt_end IS NULL)
                    THEN
                        --if flg_type = U and the dates are null, then it's a prescription auto requested (tbl pharm_unidose_auto_order = Y for this dep_clin_serv)
                        --we need to get the dates from the unit-dose cart!
                        BEGIN
                            SELECT ei.id_dep_clin_serv
                              INTO l_id_dep_clin_service
                              FROM drug_presc_det dpd
                             INNER JOIN drug_prescription dp
                                ON (dpd.id_drug_prescription = dp.id_drug_prescription)
                             INNER JOIN epis_info ei
                                ON (dp.id_episode = ei.id_episode)
                             INNER JOIN dep_clin_serv dcs
                                ON (ei.id_dep_clin_serv = dcs.id_dep_clin_serv)
                             INNER JOIN department d
                                ON (dcs.id_department = d.id_department)
                             WHERE dpd.id_presc_directions = i_id_presc_instr_det
                               AND dcs.flg_available = g_yes
                               AND d.id_institution = i_prof.institution
                               AND d.flg_available = g_yes
                               AND d.flg_unidose = g_yes;
                        EXCEPTION
                            WHEN no_data_found THEN
                                l_id_dep_clin_service := NULL;
                        END;
                    
                        IF (l_id_dep_clin_service IS NOT NULL)
                        THEN
                            BEGIN
                                SELECT v2.dt_car_begin, v2.dt_car_end
                                  INTO l_dt_begin, l_dt_end
                                  FROM (SELECT uc.dt_car_begin, uc.dt_car_end
                                          FROM pharm_unidose_car uc
                                         INNER JOIN pharm_unidose_car_model ucm
                                            ON (uc.id_car_model = ucm.id_unidose_car_model)
                                         WHERE ucm.id_dep_clin_serv = l_id_dep_clin_service
                                           AND ucm.flg_active = g_yes
                                           AND uc.id_state IN
                                               (SELECT v1.column_value
                                                  FROM TABLE(get_states_for_req_type(i_prof,
                                                                                     NULL,
                                                                                     table_varchar(g_uni_car_parked_st,
                                                                                                   g_uni_car_executing_st))) v1)
                                         ORDER BY uc.dt_car_begin DESC) v2
                                 WHERE rownum = 1;
                            EXCEPTION
                                WHEN no_data_found THEN
                                    l_dt_begin := NULL;
                                    l_dt_end   := NULL;
                            END;
                        END IF;
                    
                    ELSE
                        l_dt_begin := i_dt_begin;
                        l_dt_end   := i_dt_end;
                    END IF;
                
                    g_error := 'pk_prescription_directions.check_take_for_date';
                    set_pharmacy_log(l_db_object_name,
                                     g_error || '###i_id_presc_instr_det=' || i_id_presc_instr_det || '###l_dt_begin=' ||
                                     to_char(l_dt_begin, 'YYYYMMDDHH24MISS') || '###l_dt_end=' ||
                                     to_char(l_dt_end, 'YYYYMMDDHH24MISS'));
                
                    l_ret := pk_prescription_directions.check_take_for_date(i_lang                => i_lang,
                                                                            i_prof                => i_prof,
                                                                            i_id_presc_directions => i_id_presc_instr_det,
                                                                            i_date_begin          => l_dt_begin,
                                                                            i_date_end            => l_dt_end,
                                                                            o_tab_takes           => l_tbl_takes2, -- num takes | qt | id unit
                                                                            o_error               => o_error);
                
                    --*** DEBUG
                    IF (NOT l_ret)
                    THEN
                        set_pharmacy_log(l_db_object_name,
                                         '------ ERROR!! ' || g_error || ' | o_error.log_id: ' || o_error.log_id);
                    END IF;
                
                    IF (nvl(cardinality(l_tbl_takes2), 0) = 0)
                    THEN
                        set_pharmacy_log(l_db_object_name, '------ ZERO TOMAS!!!!!!! ------');
                    END IF;
                    --*** DEBUG END
                
                    IF (l_ret = TRUE AND nvl(cardinality(l_tbl_takes2), 0) > 0)
                    THEN
                        --tem tomas
                        l_has_takes := g_yes;
                    
                        l_tbl_dispense.delete; --clear collection
                        l_tbl_takes.delete; --clear collection
                    
                        --*for backward compatibility
                        l_tbl_takes.extend(l_tbl_takes2.count);
                        FOR tk IN 1 .. l_tbl_takes2.count
                        LOOP
                            l_tbl_takes(tk) := t_rec_pharm_takes(l_tbl_takes2(tk) (2),
                                                                 l_tbl_takes2(tk) (3),
                                                                 l_tbl_takes2(tk) (1));
                            set_pharmacy_log(l_db_object_name,
                                             '### iteration nr: ' || tk || ' ###takes:' || l_tbl_takes(tk).takes ||
                                             ' ### qt:' || l_tbl_takes(tk).qt || ' ### unit:' || l_tbl_takes(tk).unit);
                        END LOOP;
                        --*
                    
                        --conversao de unidades de prescicao em unidades de dispensa
                        process_unit_conversion(i_id_drug       => i_drug,
                                                i_version       => i_version,
                                                i_doses         => l_tbl_takes,
                                                io_tbl_dispense => l_tbl_dispense);
                    
                        IF (l_tbl_dispense.count > 0)
                        THEN
                            --TBD: isto vai ter de ser alterado!! e no caso de prescricoes com multiplas doses = dispensas diferentes ??? problem!!
                            l_qty_req               := l_tbl_dispense(1).qt_presc;
                            l_unit_measure          := l_tbl_dispense(1).unit_presc;
                            l_dispense              := 0;
                            l_unit_measure_dispense := l_tbl_dispense(1).unit_disp;
                        
                            FOR x IN 1 .. l_tbl_dispense.count
                            LOOP
                                l_dispense := l_dispense + (l_tbl_dispense(x).takes * l_tbl_dispense(x).qt_disp);
                            END LOOP;
                        
                            io_qty_req               := l_qty_req;
                            io_unit_measure          := l_unit_measure;
                            io_dispense              := l_dispense;
                            io_unit_measure_dispense := l_unit_measure_dispense;
                        END IF;
                    
                    END IF;
                
                END IF; --i_id_presc_instr_det
            
                set_pharmacy_log(l_db_object_name,
                                 'END! #########l_dispense=' || l_dispense || '###l_unit_measure_dispense=' ||
                                 l_unit_measure_dispense);
            
            END IF; --i_do_auto_dispense_calc
        
        ELSE
            set_pharmacy_log(l_db_object_name, 'Automatic dispense calculation is not enabled in this institution');
        END IF;
    
        o_has_takes := l_has_takes;
    
    EXCEPTION
        WHEN OTHERS THEN
            set_pharmacy_log(l_db_object_name,
                             'i_id_presc_instr_det=' || i_id_presc_instr_det || '####error=' || SQLERRM);
            RAISE;
    END calc_takes_and_dispense;

    /********************************************************************************************
    * alert.pk_pharmacy.update_req_det_dispense  
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_DRUG_REQ_DET                  IN    NUMBER(24)
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @author Pedro Martins Santos
    * @version  2.5.0.7.7.2
    * @since  2010-05-12
    *
    * @notes  
    *
    ********************************************************************************************/
    PROCEDURE update_req_det_dispense
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN alert.profissional,
        i_drug_req_det IN drug_req_det.id_drug_req_det%TYPE,
        o_error        OUT t_error_out
    ) IS
        l_id_presc_directions   drug_req_det.id_presc_directions%TYPE;
        l_id_state              drug_req_det.id_state%TYPE;
        l_qty_req               drug_req_det.qty_req%TYPE := NULL;
        l_unit_measure          drug_req_det.id_unit_measure%TYPE := NULL;
        l_id_drug               drug_req_det.id_drug%TYPE;
        l_vers                  drug_req_det.vers%TYPE;
        l_dispense              drug_req_det.dispense%TYPE;
        l_unit_measure_dispense drug_req_det.unit_measure_dispense%TYPE;
        --
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'update_req_det_dispense';
        l_count NUMBER(1) := 0;
        --
        l_pharmacy_is_on VARCHAR2(1 CHAR) := g_no;
        l_auto_disp_calc VARCHAR2(1 CHAR) := g_no;
        l_has_takes      VARCHAR2(1 CHAR) := g_no;
    BEGIN
        set_pharmacy_log(l_db_object_name, ' ### id_drug_req_det: ' || i_drug_req_det);
    
        g_error          := 'PHARMACY_ENABLED';
        l_pharmacy_is_on := nvl(pk_sysconfig.get_config('PHARMACY_ENABLED', i_prof), g_no);
        l_auto_disp_calc := nvl(pk_sysconfig.get_config('PHARMACY_AUTOMATIC_DISPENSE_CALCULATION', i_prof), g_no);
    
        IF (l_pharmacy_is_on = g_yes AND l_auto_disp_calc = g_yes)
        THEN
            SELECT drd.id_presc_directions, drd.id_drug, drd.vers, drd.id_state
              INTO l_id_presc_directions, l_id_drug, l_vers, l_id_state
              FROM drug_req_det drd
             WHERE drd.id_drug_req_det = i_drug_req_det;
        
            IF (l_id_state = get_state_for_req_type(i_prof, g_flg_int, g_drd_temporary_st))
            THEN
            
                g_error := 'calc_takes_and_dispense';
                calc_takes_and_dispense(i_lang                   => i_lang,
                                        i_prof                   => i_prof,
                                        i_id_presc_instr_det     => l_id_presc_directions,
                                        i_drug                   => l_id_drug,
                                        i_version                => l_vers,
                                        i_flg_type               => g_flg_int,
                                        i_do_auto_dispense_calc  => g_yes,
                                        io_qty_req               => l_qty_req,
                                        io_unit_measure          => l_unit_measure,
                                        io_dispense              => l_dispense,
                                        io_unit_measure_dispense => l_unit_measure_dispense,
                                        o_has_takes              => l_has_takes,
                                        o_error                  => o_error);
            
                g_error := 'update drug_req_det';
                set_pharmacy_log(l_db_object_name, g_error);
            
                UPDATE drug_req_det drd
                   SET drd.dispense              = l_dispense,
                       drd.unit_measure_dispense = l_unit_measure_dispense,
                       drd.qty_to_prep           = l_dispense,
                       drd.id_unit_measure_prep  = l_unit_measure_dispense
                 WHERE drd.id_drug_req_det = i_drug_req_det
                   AND drd.id_state = get_state_for_req_type(i_prof, g_flg_int, g_drd_temporary_st)
                RETURNING COUNT(1) INTO l_count;
            
                set_pharmacy_log(l_db_object_name,
                                 ' ### id_drug_req_det: ' || i_drug_req_det || ' ### l_dispense: ' || l_dispense ||
                                 ' ##" nr of updated records:  ' || l_count);
            ELSE
                set_pharmacy_log(l_db_object_name, 'INVALID STATE!! a receita nao pode ser alterada!!');
            END IF;
        ELSE
            set_pharmacy_log(l_db_object_name,
                             'PHARMACY_ENABLED=FALSE! OR PHARMACY_ENABLED=TRUE WITH AUTOMATIC DISP CALCS DISABLED');
        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            set_pharmacy_log(l_db_object_name, 'i_id_drug_req_det=' || i_drug_req_det || '####error=' || SQLERRM);
            RAISE;
    END update_req_det_dispense;

    /********************************************************************************************
    * alert.pk_pharmacy.get_car_model_details  
    *
    * @param  I_LANG                          IN    NUMBER(6)
    * @param  I_PROF                          IN    ALERT.PROFISSIONAL
    * @param  I_ID_CAR_MODEL                  IN    NUMBER(24)
    * @param  I_GET_HEADERS                   IN    VARCHAR2
    * @param  I_HEADER_CODES                  IN    ALERT.TABLE_VARCHAR
    * @param  O_CAR_DETAILS                   OUT   REF CURSOR
    * @param  O_HEADERS                       OUT   REF CURSOR
    * @param  O_HEADERS_DETAILS               OUT   REF CURSOR
    * @param  O_ERROR                         OUT   ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Pedro Martins Santos
    * @version  2.5.0.7.7.3
    * @since  20/05/2010
    *
    * @notes  
    *
    ********************************************************************************************/

    FUNCTION get_car_model_details
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN alert.profissional,
        i_id_car_model    IN pharm_unidose_car_model.id_unidose_car_model%TYPE,
        i_get_headers     IN VARCHAR2 DEFAULT 'N',
        i_header_codes    IN table_varchar DEFAULT NULL,
        o_car_details     OUT pk_types.cursor_type,
        o_headers         OUT pk_types.cursor_type,
        o_headers_details OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
        l_header_codes table_varchar;
    BEGIN
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error        := 'GET HEADERS FOR DETAILS';
        l_header_codes := table_varchar('PHARMACIST_DETAIL_MODEL_PROF_NAME',
                                        'PHARMACIST_DETAIL_MODEL_CAR_DT_CREATION',
                                        'PHARMACIST_DETAIL_MODEL_CAR_NAME',
                                        'PHARMACIST_DETAIL_MODEL_CAR_DEPT',
                                        'PHARMACIST_DETAIL_MODEL_CAR_SERV',
                                        'PHARMACIST_DETAIL_MODEL_CAR_SLOT_NR',
                                        'PHARMACIST_DETAIL_MODEL_CAR_STATE',
                                        'PHARMACIST_DETAIL_MODEL_CAR_NOTES');
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, l_header_codes, o_headers_details);
    
        --unidose car model details
        OPEN o_car_details FOR
            SELECT pk_prof_utils.get_name_signature(i_lang, i_prof, ucm.id_prof_upd) prof_name,
                   pk_prof_utils.get_spec_signature(i_lang, i_prof, ucm.id_prof_upd, ucm.car_model_date, NULL) prof_spec,
                   pk_date_utils.dt_chr(i_lang, ucm.car_model_date, i_prof) car_dt_creation,
                   ucm.car_model_name car_name,
                   pk_translation.get_translation(i_lang, d.code_department) car_dept,
                   pk_translation.get_translation(i_lang, cs.code_clinical_service) car_serv,
                   ucm.number_of_slots car_slot_nr,
                   CASE
                        WHEN ucm.flg_active = 'Y' THEN
                         pk_message.get_message(i_lang, 'PHARMACIST_UNIDOSE_CART_ACTIVE')
                        WHEN ucm.flg_active = 'N' THEN
                         pk_message.get_message(i_lang, 'PHARMACIST_UNIDOSE_CART_NOT_ACTIVE')
                    END car_state,
                   nvl(ucm.notes, g_null_notes) car_notes
              FROM pharm_unidose_car_model ucm
              JOIN dep_clin_serv dcs
                ON (ucm.id_dep_clin_serv = dcs.id_dep_clin_serv)
              JOIN clinical_service cs
                ON (dcs.id_clinical_service = cs.id_clinical_service)
              JOIN department d
                ON (dcs.id_department = d.id_department)
             WHERE ucm.id_unidose_car_model = i_id_car_model;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_car_model_details', o_error);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_headers_details);
            pk_types.open_my_cursor(o_car_details);
            RETURN FALSE;
    END get_car_model_details;

    /********************************************************************************************
    * alert.pk_pharmacy.get_dept_clin_serv_from_drd  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_ID_DRUG_PRESC_DET             IN        NUMBER(24)
    *
    * @return NUMBER(12)
    *
    * @author Andr Grilo
    * @version  2.5.0.7.8
    * @since  2010-06-07
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_dept_clin_serv_from_drd
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN alert.profissional,
        i_id_drug_req_det IN drug_req_det.id_drug_req_det%TYPE
    ) RETURN dep_clin_serv.id_clinical_service%TYPE IS
        l_id_dept_clinical_service dep_clin_serv.id_dep_clin_serv%TYPE := NULL;
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'get_clin_serv_from_drd';
        l_flg_type   drug_req.flg_type%TYPE;
        l_id_episode drug_req.id_episode%TYPE;
        l_id_patient drug_req.id_patient%TYPE;
    BEGIN
        BEGIN
            SELECT dr.flg_type, dr.id_episode, dr.id_patient
              INTO l_flg_type, l_id_episode, l_id_patient
              FROM drug_req dr
             INNER JOIN drug_req_det drd
                ON (dr.id_drug_req = drd.id_drug_req)
             WHERE drd.id_drug_req_det = i_id_drug_req_det;
        
            IF (l_flg_type = 'U')
            THEN
                SELECT dcs.id_dep_clin_serv
                  INTO l_id_dept_clinical_service
                  FROM TABLE(pk_pharmacy.get_order_car_allocation(i_id_drug_req_det)) drdalloc
                  LEFT JOIN pharm_unidose_car uc
                    ON (drdalloc.id_unidose_car = uc.id_unidose_car)
                  LEFT JOIN pharm_unidose_car_model ucm
                    ON (uc.id_car_model = ucm.id_unidose_car_model)
                  LEFT JOIN dep_clin_serv dcs
                    ON (ucm.id_dep_clin_serv = dcs.id_dep_clin_serv)
                 WHERE rownum = 1;
            ELSE
                l_id_dept_clinical_service := get_pat_location_id(i_lang       => i_lang,
                                                                  i_prof       => i_prof,
                                                                  i_id_episode => l_id_episode,
                                                                  i_id_patient => l_id_patient,
                                                                  i_type       => 'DEP_CLIN_SERV_ID');
            END IF;
        
        EXCEPTION
            WHEN no_data_found THEN
                l_id_dept_clinical_service := NULL;
        END;
    
        RETURN l_id_dept_clinical_service;
    
    EXCEPTION
        WHEN OTHERS THEN
            set_pharmacy_log(l_db_object_name, 'i_id_drug_req_det=' || i_id_drug_req_det || '###error=' || SQLERRM);
            RAISE;
    END get_dept_clin_serv_from_drd;

    /********************************************************************************************
    * alert.pk_pharmacy.get_chnm_id  
    *
    * @param  I_ID_DRUG                       IN        VARCHAR2
    * @param  I_VERS                          IN        VARCHAR2
    *
    * @return VARCHAR2
    *
    * @author Pedro Miranda
    * @version  2.5.0.8
    * @since  2010-07-14
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_chnm_id
    (
        i_id_drug IN drug_req_det.id_drug%TYPE,
        i_vers    IN drug_req_det.vers%TYPE
    ) RETURN mi_med.chnm_id%TYPE IS
        l_return_value mi_med.chnm_id%TYPE;
    BEGIN
    
        IF (i_id_drug IS NULL)
        THEN
            l_return_value := NULL;
        ELSE
            SELECT mm.chnm_id
              INTO l_return_value
              FROM mi_med mm
             WHERE mm.id_drug = i_id_drug
               AND mm.vers = i_vers;
        END IF;
    
        RETURN l_return_value;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
        
    END get_chnm_id;

    /********************************************************************************************
    * alert.pk_pharmacy.get_dispense_units_per_req  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_DRUG_REQ_DET                  IN        NUMBER(24)
    *
    * @return ALERT.TABLE_NUMBER
    *
    * @author Pedro Miranda
    * @version  2.5.1
    * @since  2010-07-26
    *
    * @notes  
    *
    ********************************************************************************************/

    FUNCTION get_dispense_units_per_req
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN alert.profissional,
        i_drug_req_det IN drug_req_det.id_drug_req_det%TYPE
    ) RETURN table_number IS
        l_units       table_number;
        l_flg_default VARCHAR2(1 CHAR) := g_no;
        l_id_drug     drug_req_det.id_drug%TYPE;
    BEGIN
    
        l_flg_default := pk_sysconfig.get_config(i_code_cf => 'PHARMACY_DEFAULT_UNITS', i_prof => i_prof);
    
        SELECT drd.id_drug
          INTO l_id_drug
          FROM drug_req_det drd
         WHERE drd.id_drug_req_det = i_drug_req_det;
    
        IF (l_flg_default = g_yes)
        THEN
        
            IF (l_id_drug IS NOT NULL)
            THEN
                g_error := 'MI_MED_DOSAGE';
                SELECT mmd.id_unit_dispense
                  BULK COLLECT
                  INTO l_units
                  FROM drug_req_det drd
                 INNER JOIN mi_med_dosage mmd
                    ON (drd.id_drug = mmd.id_drug AND drd.vers = mmd.version)
                 WHERE drd.id_drug_req_det = i_drug_req_det
                   AND mmd.flg_available = g_yes;
            ELSE
                g_error := 'OTHER_PRODUCT';
                SELECT op.id_unit_dispense
                  BULK COLLECT
                  INTO l_units
                  FROM drug_req_det drd
                 INNER JOIN other_product op
                    ON (drd.id_other_product = op.id_other_product AND drd.vers = op.vers)
                 WHERE drd.id_drug_req_det = i_drug_req_det
                   AND op.flg_available = 'Y';
            END IF;
        
        END IF;
    
        IF (l_flg_default != g_yes OR nvl(cardinality(l_units), 0) = 0)
        THEN
        
            g_error := 'GET HEADERS';
            SELECT u.id_unit_measure
              BULK COLLECT
              INTO l_units
              FROM unit_measure u
             WHERE u.id_unit_measure_type = 1020 --Unidade de dispensa
               AND u.flg_available = g_yes;
        
        END IF;
    
        RETURN l_units;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_dispense_units_per_req;

    /********************************************************************************************
    * alert.pk_pharmacy.get_last_episodes  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_PATIENT                       IN        NUMBER(24)
    *
    * @return ALERT.TABLE_NUMBER
    *
    * @author Pedro Miranda
    * @version  2.6.0.4
    * @since  2010-07-22
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_last_episodes
    (
        i_lang    IN language.id_language%TYPE,
        i_prof    IN alert.profissional,
        i_patient IN patient.id_patient%TYPE
    ) RETURN table_number IS
        l_epis_num NUMBER;
        l_epis     alert.table_number;
    BEGIN
    
        l_epis_num := to_number(pk_sysconfig.get_config(i_code_cf => 'PHARMACY_NUMBER_EPISODES', i_prof => i_prof));
    
        SELECT v1.id_episode
          BULK COLLECT
          INTO l_epis
          FROM (SELECT e.id_episode
                  FROM episode e
                 WHERE e.id_patient = i_patient
                   AND e.id_institution = i_prof.institution
                 ORDER BY e.dt_begin_tstz DESC) v1
         WHERE rownum < l_epis_num + 1;
    
        RETURN l_epis;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_last_episodes;

    /********************************************************************************************
    * alert.pk_pharmacy.get_pat_req_hist  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PATIENT                       IN        NUMBER(24)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_PROF_CAT_TYPE                 IN        VARCHAR2
    * @param  I_GET_HEADERS                   IN        VARCHAR2
    * @param  I_HEADER_CODES                  IN        ALERT.TABLE_VARCHAR
    * @param  I_ID_EPISODE                    IN        NUMBER(24)
    * @param  O_HEADERS                       OUT       REF CURSOR
    * @param  O_DRUG_ADM_HIST                 OUT       REF CURSOR
    * @param  O_DRUG_INT_HIST                 OUT       REF CURSOR
    * @param  O_DRUG_UNI_HIST                 OUT       REF CURSOR
    * @param  O_ERROR                         OUT       ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Pedro Miranda
    * @version  2.6.0.4
    * @since  2010-07-22
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_pat_req_hist
    (
        i_lang          IN language.id_language%TYPE,
        i_patient       IN patient.id_patient%TYPE,
        i_prof          IN alert.profissional,
        i_prof_cat_type IN category.flg_type%TYPE,
        i_get_headers   IN VARCHAR2 DEFAULT 'N',
        i_header_codes  IN table_varchar DEFAULT NULL,
        i_id_episode    IN episode.id_episode%TYPE DEFAULT NULL,
        o_headers       OUT pk_types.cursor_type,
        o_drug_adm_hist OUT pk_types.cursor_type,
        o_drug_int_hist OUT pk_types.cursor_type,
        o_drug_uni_hist OUT pk_types.cursor_type,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
        l_prof_type profile_template.flg_type%TYPE;
    BEGIN
    
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error     := 'GET PROF TYPE';
        l_prof_type := get_prof_type(i_prof);
    
        --ADM
        g_error := 'QUERY O_DRUG_ADM_HIST';
        OPEN o_drug_adm_hist FOR
            SELECT v1.id_drug_req_det,
                   v1.drs_id_state,
                   get_drug_desc_pharm(i_lang, i_prof, v1.id_episode, v1.id_drug_req_det, 'N', 'N', 'PHARMACY_FORMAT') pharm,
                   get_status_pipe_str(i_lang,
                                       i_prof,
                                       v1.drs_id_state,
                                       i_prof_cat_type,
                                       v1.drdst_dt_state,
                                       '0',
                                       '',
                                       g_yes) desc_stat,
                   get_attention_pipe_str(i_lang, i_prof, v1.id_drug_req_det) attention,
                   pk_date_utils.date_send_tsz(i_lang, v1.drdst_dt_state, i_prof) req_date,
                   get_icon_for_req_type(i_lang, i_prof, v1.flg_type, '') flg_type_icon,
                   NULL pend_type, --needed by flash to merge cursors --get_pat_req_all
                   v1.flg_type flg_type_req,
                   'HIST' req_dev,
                   check_presc_justification(i_lang, i_prof, v1.id_drug_req_det) flg_justify,
                   check_presc_justification(i_lang, i_prof, v1.id_drug_req_det, g_yes) show_justify
              FROM (SELECT v2.id_drug_req_det,
                           v2.id_state,
                           v2.id_episode,
                           v2.drdst_dt_state,
                           MAX(v2.drdst_dt_state) drdst2_dt_state,
                           v2.flg_type,
                           v2.drs_id_state drs_id_state
                      FROM (SELECT drd.id_drug_req_det,
                                   drd.id_state,
                                   e.id_episode,
                                   drdst.dt_state      drdst_dt_state,
                                   NULL                drdst2_dt_state,
                                   dr.flg_type,
                                   drs.id_state        drs_id_state
                              FROM drug_req_det drd
                             INNER JOIN drug_req dr
                                ON (drd.id_drug_req = dr.id_drug_req)
                             INNER JOIN patient p
                                ON (dr.id_patient = p.id_patient)
                             INNER JOIN episode e
                                ON (dr.id_episode = e.id_episode)
                             INNER JOIN drug_req_det_state_transition drdst
                                ON (drd.id_drug_req_det = drdst.id_drug_req_det AND
                                   drdst.id_state = get_state_for_req_type(i_prof, dr.flg_type, g_drd_requested_st))
                             INNER JOIN drug_req_supply drs
                                ON (drd.id_drug_req_det = drs.id_drug_req_det)
                             WHERE e.id_institution = i_prof.institution
                               AND drs.id_state IN
                                   (SELECT column_value
                                      FROM TABLE(get_states_for_req_type(i_prof,
                                                                         NULL,
                                                                         table_varchar(g_drs_supplied_st,
                                                                                       g_drs_delivered2pat_st,
                                                                                       g_drs_readyfortransp_st,
                                                                                       g_drs_in_transit_st,
                                                                                       g_drs_uni_ready4transp_st))))
                               AND dr.flg_type = g_flg_adm
                               AND p.id_patient = i_patient
                               AND e.flg_status = 'A') v2
                     GROUP BY v2.id_drug_req_det,
                              v2.id_state,
                              v2.id_episode,
                              v2.drdst_dt_state,
                              v2.flg_type,
                              v2.drs_id_state --must get the recent one (drug_req_det_state_transition) --this is because loops on the workflow (reject > prepare > reject > prepara .. and so on)
                    ) v1,
                   wfl_state_detail wsd
             WHERE v1.id_state = wsd.state
               AND wsd.prof_type = l_prof_type
             ORDER BY wsd.rank, v1.drdst_dt_state DESC;
    
        --INT
        g_error := 'QUERY O_DRUG_INT_HIST';
        OPEN o_drug_int_hist FOR
            SELECT v1.id_drug_req_det,
                   v1.drs_id_state,
                   get_drug_desc_pharm(i_lang, i_prof, v1.id_episode, v1.id_drug_req_det, 'N', 'N', 'PHARMACY_FORMAT') pharm,
                   get_status_pipe_str(i_lang,
                                       i_prof,
                                       v1.drs_id_state,
                                       i_prof_cat_type,
                                       v1.drdst_dt_state,
                                       '0',
                                       '',
                                       g_yes) desc_stat,
                   get_attention_pipe_str(i_lang, i_prof, v1.id_drug_req_det) attention,
                   pk_date_utils.date_send_tsz(i_lang, v1.drdst_dt_state, i_prof) req_date,
                   get_icon_for_req_type(i_lang, i_prof, v1.flg_type, '') flg_type_icon,
                   NULL pend_type, --needed by flash to merge cursors --get_pat_req_all
                   v1.flg_type flg_type_req,
                   'HIST' req_dev,
                   check_presc_justification(i_lang, i_prof, v1.id_drug_req_det) flg_justify,
                   check_presc_justification(i_lang, i_prof, v1.id_drug_req_det, g_yes) show_justify
              FROM (SELECT v2.id_drug_req_det,
                           v2.id_state,
                           v2.id_episode,
                           v2.drdst_dt_state,
                           MAX(v2.drdst_dt_state) drdst2_dt_state,
                           v2.flg_type,
                           v2.drs_id_state drs_id_state
                      FROM (SELECT drd.id_drug_req_det,
                                   drd.id_state,
                                   e.id_episode,
                                   drdst.dt_state      drdst_dt_state,
                                   NULL                drdst2_dt_state,
                                   dr.flg_type,
                                   drs.id_state        drs_id_state
                              FROM drug_req_det drd
                             INNER JOIN drug_req dr
                                ON (drd.id_drug_req = dr.id_drug_req)
                             INNER JOIN patient p
                                ON (dr.id_patient = p.id_patient)
                             INNER JOIN episode e
                                ON (dr.id_episode = e.id_episode)
                             INNER JOIN drug_req_det_state_transition drdst
                                ON (drd.id_drug_req_det = drdst.id_drug_req_det AND
                                   drdst.id_state = get_state_for_req_type(i_prof, dr.flg_type, g_drd_requested_st))
                             INNER JOIN drug_req_supply drs
                                ON (drd.id_drug_req_det = drs.id_drug_req_det)
                             WHERE e.id_institution = i_prof.institution
                               AND drs.id_state IN
                                   (SELECT column_value
                                      FROM TABLE(get_states_for_req_type(i_prof,
                                                                         NULL,
                                                                         table_varchar(g_drs_supplied_st,
                                                                                       g_drs_delivered2pat_st,
                                                                                       g_drs_readyfortransp_st,
                                                                                       g_drs_in_transit_st,
                                                                                       g_drs_uni_ready4transp_st))))
                               AND dr.flg_type = g_flg_int
                               AND p.id_patient = i_patient
                               AND e.flg_status = 'A') v2
                     GROUP BY v2.id_drug_req_det,
                              v2.id_state,
                              v2.id_episode,
                              v2.drdst_dt_state,
                              v2.flg_type,
                              v2.drs_id_state --must get the recent one (drug_req_det_state_transition) --this is because loops on the workflow (reject > prepare > reject > prepara .. and so on)
                    ) v1,
                   wfl_state_detail wsd
             WHERE v1.id_state = wsd.state
               AND wsd.prof_type = l_prof_type
             ORDER BY wsd.rank, v1.drdst_dt_state DESC;
    
        --UNIDOSE
        g_error := 'QUERY O_DRUG_UNI_HIST';
        OPEN o_drug_uni_hist FOR
            SELECT v1.id_drug_req_det,
                   v1.drs_id_state,
                   get_drug_desc_pharm(i_lang, i_prof, v1.id_episode, v1.id_drug_req_det, 'N', 'N', 'PHARMACY_FORMAT') pharm,
                   get_status_pipe_str(i_lang,
                                       i_prof,
                                       v1.drs_id_state,
                                       i_prof_cat_type,
                                       v1.drdst_dt_state,
                                       '0',
                                       '',
                                       g_yes) desc_stat,
                   get_attention_pipe_str(i_lang, i_prof, v1.id_drug_req_det) attention,
                   pk_date_utils.date_send_tsz(i_lang, v1.drdst_dt_state, i_prof) req_date,
                   get_icon_for_req_type(i_lang, i_prof, v1.flg_type, '') flg_type_icon,
                   NULL pend_type, --needed by flash to merge cursors --get_pat_req_all
                   v1.flg_type flg_type_req,
                   'HIST' req_dev,
                   check_presc_justification(i_lang, i_prof, v1.id_drug_req_det) flg_justify,
                   check_presc_justification(i_lang, i_prof, v1.id_drug_req_det, g_yes) show_justify
              FROM (SELECT v2.id_drug_req_det,
                           v2.id_state,
                           v2.id_episode,
                           v2.drdst_dt_state,
                           MAX(v2.drdst_dt_state) drdst2_dt_state,
                           v2.flg_type,
                           v2.drs_id_state drs_id_state
                      FROM (SELECT drd.id_drug_req_det,
                                   drd.id_state,
                                   e.id_episode,
                                   drdst.dt_state      drdst_dt_state,
                                   NULL                drdst2_dt_state,
                                   dr.flg_type,
                                   drs.id_state        drs_id_state
                              FROM drug_req_det drd
                             INNER JOIN drug_req dr
                                ON (drd.id_drug_req = dr.id_drug_req)
                             INNER JOIN patient p
                                ON (dr.id_patient = p.id_patient)
                             INNER JOIN episode e
                                ON (dr.id_episode = e.id_episode)
                             INNER JOIN drug_req_det_state_transition drdst
                                ON (drd.id_drug_req_det = drdst.id_drug_req_det AND
                                   drdst.id_state = get_state_for_req_type(i_prof, dr.flg_type, g_drd_requested_st))
                             INNER JOIN drug_req_supply drs
                                ON (drd.id_drug_req_det = drs.id_drug_req_det)
                             WHERE e.id_institution = i_prof.institution
                               AND drs.id_state IN
                                   (SELECT column_value
                                      FROM TABLE(get_states_for_req_type(i_prof,
                                                                         NULL,
                                                                         table_varchar(g_drs_supplied_st,
                                                                                       g_drs_delivered2pat_st,
                                                                                       g_drs_readyfortransp_st,
                                                                                       g_drs_in_transit_st,
                                                                                       g_drs_uni_ready4transp_st))))
                               AND dr.flg_type = g_flg_unidose
                               AND p.id_patient = i_patient
                               AND e.flg_status = 'A') v2
                     GROUP BY v2.id_drug_req_det,
                              v2.id_state,
                              v2.id_episode,
                              v2.drdst_dt_state,
                              v2.flg_type,
                              v2.drs_id_state --must get the recent one (drug_req_det_state_transition) --this is because loops on the workflow (reject > prepare > reject > prepara .. and so on)
                    ) v1,
                   wfl_state_detail wsd
             WHERE v1.id_state = wsd.state
               AND wsd.prof_type = l_prof_type
             ORDER BY wsd.rank, v1.drdst_dt_state DESC;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'GET_PAT_REQ_HIST', o_error);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_drug_adm_hist);
            pk_types.open_my_cursor(o_drug_int_hist);
            pk_types.open_my_cursor(o_drug_uni_hist);
            RETURN FALSE;
    END get_pat_req_hist;

    /********************************************************************************************
    * alert.pk_pharmacy.get_actions_exception_avl  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_ACTION                        IN        NUMBER
    *
    * @return VARCHAR2
    *
    * @author Pedro Miranda
    * @version  2.6.0.4
    * @since  2010-09-15
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_actions_exception_avl
    (
        i_lang   IN language.id_language%TYPE,
        i_prof   IN alert.profissional,
        i_action IN action.id_action%TYPE
    ) RETURN VARCHAR2 IS
    
        l_error            t_error_out;
        l_action_available action_exception.flg_available%TYPE;
    BEGIN
    
        g_error := 'GET action_exception parametrization';
        SELECT ae.flg_available
          INTO l_action_available
          FROM action_exception ae
         WHERE ae.id_action = i_action
           AND ((ae.id_category = pk_prof_utils.get_id_category(i_lang, i_prof) OR
               ae.id_profile_template = pk_prof_utils.get_prof_profile_template(i_prof) OR
               ae.id_profissional = i_prof.id))
           AND ae.id_software = i_prof.software;
    
        RETURN l_action_available;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang     => i_lang,
                                              i_sqlcode  => SQLCODE,
                                              i_sqlerrm  => SQLERRM,
                                              i_message  => NULL,
                                              i_owner    => 'ALERT',
                                              i_package  => 'PK_PHARMACY',
                                              i_function => 'GET_ACTIONS_EXCEPTION_FOR_PRESCRIPTION',
                                              o_error    => l_error);
            pk_alert_exceptions.reset_error_state;
            RETURN NULL;
    END get_actions_exception_avl;
    --

    /********************************************************************************************
    * alert.pk_pharmacy.get_action_for_prescription  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_ID_STATE                      IN        VARCHAR2
    * @param  O_ACTION                        OUT       REF CURSOR
    * @param  O_ERROR                         OUT       ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Pedro Miranda
    * @version  2.6.0.4
    * @since  2010-09-15
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_action_for_prescription
    (
        i_lang     IN language.id_language%TYPE,
        i_prof     IN profissional,
        i_id_state IN action.from_state%TYPE,
        o_action   OUT pk_types.cursor_type,
        o_error    OUT t_error_out
    ) RETURN BOOLEAN IS
        l_cat_type        category.flg_type%TYPE;
        l_error           VARCHAR2(2500);
        l_version         VARCHAR2(10) := pk_sysconfig.get_config(pk_medication_current.g_presc_type, i_prof);
        l_inactive_action VARCHAR2(1) := pk_sysconfig.get_config(pk_medication_current.g_inactive_action, i_prof);
        l_institution     prescription_type_access.id_institution%TYPE;
        l_subject         table_varchar := alert.table_varchar(pk_medication_current.g_local,
                                                               pk_medication_current.g_hospital,
                                                               pk_medication_current.g_dietetico,
                                                               pk_medication_current.g_manipulados,
                                                               pk_medication_current.g_exterior,
                                                               pk_medication_current.g_relatos_ext,
                                                               pk_medication_current.g_outros,
                                                               pk_medication_current.g_relatos_int,
                                                               pk_medication_current.g_other_prod,
                                                               pk_medication_current.g_soro,
                                                               'COMPOUND',
                                                               pk_medication_core.g_no_medication,
                                                               pk_medication_core.g_no_id_medication,
                                                               pk_medication_current.g_exterior_chronic);
    BEGIN
        g_error := 'get cursor';
    
        pk_alertlog.log_debug(g_error, pk_medication_current.g_log_object_name);
        l_cat_type := pk_tools.get_prof_cat(i_prof => i_prof);
    
        BEGIN
            SELECT pta.id_institution
              INTO l_institution
              FROM prescription_type_access pta
             WHERE pta.flg_cat_type = l_cat_type
               AND pta.id_institution = i_prof.institution
               AND pta.id_software = i_prof.software;
        EXCEPTION
            WHEN OTHERS THEN
                l_institution := 0;
        END;
    
        OPEN o_action FOR
        
            SELECT *
              FROM (SELECT subject,
                           id_action,
                           pk_translation.get_translation(i_lang, code_action) AS action_desc,
                           decode(icon,
                                  NULL,
                                  decode(subject,
                                         pk_medication_current.g_exterior_chronic,
                                         (SELECT img_name
                                            FROM sys_domain
                                           WHERE code_domain = pk_medication_core.g_prescr_status
                                             AND domain_owner = pk_sysdomain.k_default_schema
                                             AND id_language = i_lang
                                             AND val = to_state),
                                         (SELECT img_name
                                            FROM sys_domain
                                           WHERE code_domain = pk_medication_current.g_domain_relatos
                                             AND domain_owner = pk_sysdomain.k_default_schema
                                             AND id_language = i_lang
                                             AND val = to_state)),
                                  icon) icon,
                           from_state,
                           to_state,
                           flg_default,
                           flg_active, --act.flg_status flg_active,
                           nvl(get_actions_exception_avl(i_lang, i_prof, id_action), 'Y') flg_available,
                           rank
                      FROM (SELECT subject,
                                   act.id_action,
                                   code_action,
                                   icon,
                                   from_state,
                                   to_state,
                                   flg_default,
                                   decode(act.to_state,
                                          l_inactive_action,
                                          'I',
                                          nvl(pk_action.get_actions_exception(i_lang, i_prof, act.id_action),
                                              act.flg_status)) flg_active, --act.flg_status flg_active,
                                   act.rank rank
                              FROM action act,
                                   TABLE(l_subject) t_subject,
                                   prescription_type pt,
                                   prescription_type_access pta,
                                   prof_profile_template ppt
                             WHERE t_subject.column_value = act.subject
                               AND pta.id_prescription_type = pt.id_prescription_type
                               AND (pta.id_professional = i_prof.id OR pta.id_professional = 0)
                               AND ppt.id_professional = i_prof.id
                               AND ppt.id_software = i_prof.software
                               AND ppt.id_institution = i_prof.institution
                               AND ppt.id_software = pta.id_software
                               AND pta.id_institution = l_institution
                               AND ((instr(pta.flg_cat_type, l_cat_type) != 0 AND pta.id_profile_template IS NULL) OR
                                   pta.id_profile_template = ppt.id_profile_template)
                               AND (act.id_prescription_type IS NOT NULL AND pta.flg_type_access = 'A')
                               AND decode(nvl(pta.id_software, 0), 0, i_prof.software, pta.id_software) = i_prof.software
                               AND decode(nvl(pta.id_institution, 0), 0, i_prof.institution, pta.id_institution) =
                                   i_prof.institution
                               AND act.id_prescription_type = pt.id_prescription_type
                               AND act.from_state = nvl(i_id_state, act.from_state)
                            UNION
                            SELECT subject,
                                   act.id_action,
                                   code_action,
                                   icon,
                                   from_state,
                                   to_state,
                                   flg_default,
                                   'i' flg_active,
                                   act.rank rank
                              FROM alert.action act,
                                   TABLE(l_subject) t_subject,
                                   prescription_type pt,
                                   prescription_type_access pta,
                                   prof_profile_template ppt
                             WHERE t_subject.column_value = act.subject
                               AND pta.id_prescription_type = pt.id_prescription_type
                               AND (pta.id_professional = i_prof.id OR pta.id_professional = 0)
                               AND ppt.id_professional = i_prof.id
                               AND ppt.id_software = i_prof.software
                               AND ppt.id_institution = i_prof.institution
                               AND ppt.id_software = pta.id_software
                               AND pta.id_institution = l_institution
                               AND act.id_prescription_type IS NOT NULL
                               AND act.id_prescription_type = pt.id_prescription_type
                               AND act.from_state = nvl(i_id_state, act.from_state)
                               AND ((instr(pta.flg_cat_type, l_cat_type) = 0 AND pta.id_profile_template IS NULL) OR
                                   ppt.id_profile_template != pta.id_profile_template)
                               AND decode(nvl(pta.id_software, 0), 0, i_prof.software, pta.id_software) !=
                                   i_prof.software
                               AND decode(nvl(pta.id_institution, 0), 0, i_prof.institution, pta.id_institution) !=
                                   i_prof.institution
                            UNION
                            SELECT subject,
                                   act.id_action,
                                   code_action,
                                   icon,
                                   from_state,
                                   to_state,
                                   flg_default,
                                   decode(act.to_state,
                                          l_inactive_action,
                                          'I',
                                          nvl(pk_action.get_actions_exception(i_lang, i_prof, act.id_action),
                                              act.flg_status)) flg_active, --act.flg_status flg_active,
                                   act.rank rank
                              FROM action act,
                                   TABLE(l_subject) t_subject,
                                   prescription_type pt,
                                   prescription_type_access pta,
                                   prof_profile_template ppt
                             WHERE t_subject.column_value = act.subject
                               AND pta.id_prescription_type = pt.id_prescription_type
                               AND (pta.id_professional = i_prof.id OR pta.id_professional = 0)
                               AND ppt.id_professional = i_prof.id
                               AND ppt.id_software = i_prof.software
                               AND ppt.id_institution = i_prof.institution
                               AND ppt.id_software = pta.id_software
                               AND pta.id_institution = l_institution
                               AND act.to_state NOT IN
                                   (SELECT sc.value
                                      FROM sys_config sc
                                     WHERE sc.id_institution =
                                           decode(sc.id_institution, 0, sc.id_institution, i_prof.institution)
                                       AND sc.id_software = decode(sc.id_software, 0, sc.id_software, i_prof.software)
                                       AND sc.id_sys_config = 'ACTION_TO_STATE')
                               AND act.id_prescription_type IS NULL)
                     WHERE rownum > 0) actions
             WHERE actions.flg_available = g_yes
             ORDER BY action_desc, rank;
    
        RETURN TRUE;
    EXCEPTION
        -- on any error
    
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang     => i_lang,
                                              i_sqlcode  => SQLCODE,
                                              i_sqlerrm  => SQLERRM,
                                              i_message  => g_error,
                                              i_owner    => 'alert',
                                              i_package  => 'pk_parmacy',
                                              i_function => 'get_action',
                                              o_error    => o_error);
            RETURN FALSE;
    END get_action_for_prescription;
    --

    /********************************************************************************************
    * alert.pk_pharmacy.get_multiple_action_presc  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_SUBJECT                       IN        ALERT.TABLE_VARCHAR
    * @param  I_ID_STATE                      IN        ALERT.TABLE_VARCHAR
    * @param  O_ACTION                        OUT       REF CURSOR
    * @param  O_ERROR                         OUT       ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Pedro Miranda
    * @version  2.6.0.4
    * @since  2010-09-15
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_multiple_action_presc
    (
        i_lang     IN language.id_language%TYPE,
        i_prof     IN profissional,
        i_subject  IN table_varchar,
        i_id_state IN table_varchar,
        o_action   OUT pk_types.cursor_type,
        o_error    OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_cat_type        category.flg_type%TYPE;
        l_error           VARCHAR2(2500);
        l_inactive_action VARCHAR2(1) := pk_sysconfig.get_config(pk_medication_current.g_inactive_action, i_prof);
        l_institution     prescription_type_access.id_institution%TYPE;
    
        CURSOR c_x
        (
            in_subject    action.subject%TYPE,
            in_from_state action.from_state%TYPE
        ) IS
            SELECT ROWID
              FROM action a
             WHERE subject = in_subject
               AND from_state = in_from_state;
    
        l_cur_data_temp table_varchar2;
        l_cur_data      table_varchar2 := table_varchar2();
        l_version       VARCHAR2(10) := pk_sysconfig.get_config(pk_medication_current.g_presc_type, i_prof);
    
        inact_all table_varchar;
    
        l_inact_l_h VARCHAR2(1);
        l_inact_e   VARCHAR2(1);
        l_vers_type VARCHAR2(1) := pk_medication_core.get_version_type(i_lang, i_prof);
    
    BEGIN
    
        l_cat_type := pk_tools.get_prof_cat(i_prof => i_prof);
    
        FOR i IN i_subject.first .. i_subject.last
        
        LOOP
        
            OPEN c_x(i_subject(i), i_id_state(i));
            FETCH c_x BULK COLLECT
                INTO l_cur_data_temp;
            CLOSE c_x;
        
            l_cur_data := l_cur_data MULTISET UNION ALL l_cur_data_temp;
        
        END LOOP;
    
        IF l_vers_type = pk_medication_core.g_vers_type_a
        THEN
        
            SELECT decode(COUNT(*), 0, g_no, g_yes)
              INTO l_inact_l_h
              FROM action a
             WHERE a.subject = pk_medication_core.g_exterior
               AND a.rowid IN (SELECT column_value
                                 FROM TABLE(l_cur_data));
        
            SELECT decode(COUNT(*), 0, g_no, g_yes)
              INTO l_inact_e
              FROM action a
             WHERE a.subject IN (pk_medication_core.g_local, pk_medication_core.g_hospital)
               AND a.rowid IN (SELECT column_value
                                 FROM TABLE(l_cur_data));
        
            IF l_inact_l_h = g_yes
            THEN
            
                inact_all := table_varchar('R', 'F', 'M', 'L', 'H');
            
                IF l_inact_e = g_yes
                THEN
                
                    inact_all := table_varchar('R', 'F', 'M', 'E', 'L', 'H');
                
                END IF;
            
            ELSE
            
                IF l_inact_e = g_yes
                THEN
                
                    inact_all := table_varchar('F', 'M', 'E');
                
                END IF;
            
            END IF;
        
        ELSE
        
            inact_all := table_varchar('R', 'F', 'M', 'L', 'H');
        
        END IF;
    
        BEGIN
            SELECT pta.id_institution
              INTO l_institution
              FROM prescription_type_access pta
             WHERE pta.flg_cat_type = l_cat_type
               AND pta.id_institution = i_prof.institution
               AND pta.id_software = i_prof.software;
        EXCEPTION
            WHEN OTHERS THEN
                l_institution := 0;
        END;
    
        OPEN o_action FOR
            SELECT *
              FROM (SELECT DISTINCT NULL subject,
                                    NULL id_action,
                                    action_desc,
                                    decode(icon,
                                           NULL,
                                           (SELECT img_name
                                              FROM sys_domain
                                             WHERE code_domain = pk_medication_current.g_domain_relatos
                                               AND domain_owner = pk_sysdomain.k_default_schema
                                               AND id_language = i_lang
                                               AND val = to_state),
                                           icon) icon,
                                    NULL from_state,
                                    to_state,
                                    NULL flg_default,
                                    flg_active,
                                    nvl(get_actions_exception_avl(i_lang, i_prof, id_action), 'Y') flg_available,
                                    rank
                      FROM (SELECT NULL subject,
                                   all_info_for_ptnn_1.id_action id_action,
                                   pk_translation.get_translation(i_lang, all_info_for_ptnn_1.code_action) action_desc,
                                   all_info_for_ptnn_1.icon icon,
                                   NULL from_state,
                                   all_info_for_ptnn_1.to_state to_state,
                                   NULL flg_default,
                                   decode(all_info_for_ptnn_1.to_state,
                                          repeted_dif_is_inact.to_state,
                                          'I',
                                          inactive.column_value,
                                          'I',
                                          l_inactive_action,
                                          'I',
                                          nvl(pk_action.get_actions_exception(i_lang,
                                                                              i_prof,
                                                                              all_info_for_ptnn_1.id_action),
                                              all_info_for_ptnn_1.flg_status)) AS flg_active,
                                   all_info_for_ptnn_1.rank rank
                              FROM (SELECT /*+use_nl(t a pt pta)*/
                                    DISTINCT a.to_state,
                                             a.icon,
                                             a.id_action,
                                             a.flg_status,
                                             a.id_prescription_type,
                                             a.rank,
                                             a.code_action,
                                             a.subject
                                      FROM prescription_type pt,
                                           prescription_type_access pta,
                                           prof_profile_template ppt,
                                           action a,
                                           (SELECT column_value
                                              FROM TABLE(l_cur_data)) t
                                     WHERE pta.id_prescription_type = pt.id_prescription_type
                                       AND pta.id_institution = l_institution
                                       AND decode(nvl(pta.id_software, 0), 0, i_prof.software, pta.id_software) =
                                           i_prof.software
                                       AND ((instr(pta.flg_cat_type, l_cat_type) != 0 AND pta.id_profile_template IS NULL) OR
                                           pta.id_profile_template = ppt.id_profile_template AND
                                           pta.id_professional = i_prof.id)
                                       AND a.id_prescription_type = pt.id_prescription_type
                                       AND a.rowid = t.column_value
                                       AND a.id_prescription_type IS NOT NULL) all_info_for_ptnn_1,
                                   (SELECT to_state
                                      FROM (SELECT /*+use_nl(t a pt pta)*/
                                            DISTINCT a.to_state, a.icon, a.flg_status, a.id_prescription_type
                                              FROM prescription_type pt,
                                                   prescription_type_access pta,
                                                   prof_profile_template ppt,
                                                   action a,
                                                   (SELECT column_value
                                                      FROM TABLE(l_cur_data)) t
                                             WHERE pta.id_prescription_type = pt.id_prescription_type
                                               AND pta.id_institution = l_institution
                                               AND decode(nvl(pta.id_software, 0), 0, i_prof.software, pta.id_software) =
                                                   i_prof.software
                                               AND ((instr(pta.flg_cat_type, l_cat_type) != 0 AND
                                                   pta.id_profile_template IS NULL) OR
                                                   pta.id_profile_template = ppt.id_profile_template AND
                                                   pta.id_professional = i_prof.id)
                                               AND a.id_prescription_type = pt.id_prescription_type
                                               AND a.rowid = t.column_value
                                               AND a.id_prescription_type IS NOT NULL) all_info_for_ptnn
                                     GROUP BY to_state
                                    HAVING COUNT(*) > 1) repeted_dif_is_inact,
                                   TABLE(inact_all) inactive
                             WHERE repeted_dif_is_inact.to_state(+) = all_info_for_ptnn_1.to_state
                               AND inactive.column_value(+) = all_info_for_ptnn_1.to_state
                            UNION
                            SELECT NULL subject,
                                   all_info_for_ptn_1.id_action id_action,
                                   pk_translation.get_translation(i_lang, all_info_for_ptn_1.code_action) action_desc,
                                   all_info_for_ptn_1.icon icon,
                                   NULL from_state,
                                   all_info_for_ptn_1.to_state to_state,
                                   NULL flg_default,
                                   decode(all_info_for_ptn_1.to_state,
                                          repeted_dif_is_inact.to_state,
                                          'I',
                                          inactive.column_value,
                                          'I',
                                          l_inactive_action,
                                          'I',
                                          nvl(pk_action.get_actions_exception(i_lang, i_prof, all_info_for_ptn_1.id_action),
                                              all_info_for_ptn_1.flg_status)) AS flg_active,
                                   all_info_for_ptn_1.rank
                              FROM (SELECT /*+use_nl(t a)*/
                                    DISTINCT a.to_state,
                                             a.icon,
                                             a.id_action,
                                             a.flg_status,
                                             a.id_prescription_type,
                                             a.rank,
                                             a.code_action,
                                             a.subject
                                      FROM action a,
                                           (SELECT column_value
                                              FROM TABLE(l_cur_data)) t
                                     WHERE a.rowid = t.column_value
                                       AND a.id_prescription_type IS NULL) all_info_for_ptn_1,
                                   (SELECT to_state
                                      FROM (SELECT /*+use_nl(t a)*/
                                             a.to_state, a.icon, a.flg_status, a.id_prescription_type
                                              FROM action a,
                                                   (SELECT column_value
                                                      FROM TABLE(l_cur_data)) t
                                             WHERE a.rowid = t.column_value
                                               AND a.id_prescription_type IS NULL)
                                     GROUP BY to_state
                                    HAVING COUNT(*) > 1) repeted_dif_is_inact,
                                   TABLE(inact_all) inactive
                             WHERE repeted_dif_is_inact.to_state(+) = all_info_for_ptn_1.to_state
                               AND inactive.column_value(+) = all_info_for_ptn_1.to_state)
                     WHERE rownum > 0) actions
             WHERE actions.flg_available = g_yes
             ORDER BY action_desc, rank;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang     => i_lang,
                                              i_sqlcode  => SQLCODE,
                                              i_sqlerrm  => SQLERRM,
                                              i_message  => g_error,
                                              i_owner    => 'alert',
                                              i_package  => 'pk_pharmacy',
                                              i_function => 'get_multiple_action_presc',
                                              o_error    => o_error);
            pk_types.open_my_cursor(o_action);
            RETURN FALSE;
    END get_multiple_action_presc;

    /********************************************************************************************
    * alert.pk_pharmacy.get_domain  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_CODE_DOMAIN                   IN        ALERT.TABLE_VARCHAR
    * @param  I_GET_DOMAIN                    IN        VARCHAR2
    * @param  O_DOMAIN                        OUT       REF CURSOR
    *
    * @author Pedro Miranda
    * @version  2.6.0.4
    * @since  2010-09-21
    *
    * @notes  
    *
    ********************************************************************************************/
    PROCEDURE get_domain
    (
        i_lang        IN language.id_language%TYPE,
        i_prof        IN profissional,
        i_code_domain IN table_varchar,
        i_get_domain  IN VARCHAR2 DEFAULT 'N',
        o_domain      OUT pk_types.cursor_type
    ) IS
        l_tbl_domain t_tbl_pharm_vision := t_tbl_pharm_vision();
    BEGIN
    
        IF (i_get_domain = g_yes)
        THEN
        
            SELECT t_rec_pharm_vision(sd.val, NULL, sd.desc_val, NULL, 'A', sd.rank, NULL)
              BULK COLLECT
              INTO l_tbl_domain
              FROM sys_domain sd
             WHERE sd.code_domain IN (SELECT column_value
                                        FROM TABLE(i_code_domain))
               AND sd.domain_owner = pk_sysdomain.k_default_schema
               AND sd.id_language = i_lang
             ORDER BY sd.rank;
        
            OPEN o_domain FOR
                SELECT *
                  FROM TABLE(l_tbl_domain) t;
        
        ELSE
            pk_types.open_my_cursor(o_domain);
        END IF;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_domain;

    /********************************************************************************************
    * alert.pk_pharmacy.get_pat_location_id  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_ID_EPISODE                    IN        NUMBER(24)
    * @param  I_ID_PATIENT                    IN        NUMBER(24)
    * @param  I_TYPE                          IN        VARCHAR2
    *
    * @return NUMBER
    *
    * @author Pedro Miranda
    * @version  2.5.1
    * @since  2011-01-12
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_pat_location_id
    (
        i_lang       IN language.id_language%TYPE,
        i_prof       IN alert.profissional,
        i_id_episode IN episode.id_episode%TYPE,
        i_id_patient IN patient.id_patient%TYPE,
        i_type       IN VARCHAR2 DEFAULT 'CLIN_SERV_ID'
    ) RETURN NUMBER IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'get_pat_location';
        --
        l_location NUMBER;
        l_episode  episode.id_episode%TYPE;
        l_error    t_error_out;
    
    BEGIN
    
        l_episode := i_id_episode;
    
        IF (l_episode IS NULL)
        THEN
            BEGIN
                SELECT MAX(e.id_episode)
                  INTO l_episode
                  FROM episode e
                 WHERE e.id_patient = i_id_patient
                   AND e.flg_status = 'A'; --active
            EXCEPTION
                WHEN no_data_found THEN
                    set_pharmacy_log(l_db_object_name, 'episode id?');
                    raise_application_error(-20001, 'episode id?');
            END;
        END IF;
    
        BEGIN
        
            IF i_type = 'CLIN_SERV_ID'
            THEN
                --clinical service
                SELECT cs.id_clinical_service
                  INTO l_location
                  FROM episode e, clinical_service cs
                 WHERE e.id_episode = i_id_episode
                   AND e.id_clinical_service = cs.id_clinical_service
                   AND rownum = 1;
            
            ELSIF i_type = 'DEP_CLIN_SERV_ID'
            THEN
                -- dep_clin_serv
                SELECT ei.id_dep_clin_serv
                  INTO l_location
                  FROM epis_info ei
                 WHERE ei.id_episode = i_id_episode;
            
            ELSE
                l_location := NULL;
            END IF;
        
        EXCEPTION
            WHEN no_data_found THEN
                l_location := NULL;
        END;
    
        RETURN l_location;
    
    END get_pat_location_id;

    /********************************************************************************************
    * alert.pk_pharmacy.get_car_name  
    *
    * @param  I_ID_DRUG_REQ_DET               IN        NUMBER(24)
    *
    * @return VARCHAR2
    *
    * @author Pedro Miranda
    * @version  2.5.1
    * @since  2011-01-12
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_car_name(i_id_drug_req_det IN drug_req_det.id_drug_req_det%TYPE)
        RETURN pharm_unidose_car_model.car_model_name%TYPE IS
    
        l_car_name pharm_unidose_car_model.car_model_name%TYPE;
    
    BEGIN
        SELECT ucm.car_model_name
          INTO l_car_name
          FROM TABLE(pk_pharmacy.get_order_car_allocation(i_id_drug_req_det)) drdalloc
          LEFT JOIN pharm_unidose_car uc
            ON (drdalloc.id_unidose_car = uc.id_unidose_car)
          LEFT JOIN pharm_unidose_car_model ucm
            ON (uc.id_car_model = ucm.id_unidose_car_model)
         WHERE rownum = 1;
    
        RETURN l_car_name;
    
    EXCEPTION
        WHEN no_data_found THEN
            l_car_name := '';
            RETURN l_car_name;
        
    END get_car_name;

    /********************************************************************************************
    * alert.pk_pharmacy.get_notes  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_ID_DRUG_RET                   IN        NUMBER(24)
    * @param  O_ALL_NOTES                     OUT       REF CURSOR
    * @param  O_NOTES_4PHYSICIAN              OUT       REF CURSOR
    * @param  O_REJECT_NOTES                  OUT       REF CURSOR
    * @param  O_ERROR                         OUT       ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Pedro Miranda
    * @version  2.5.1.2
    * @since  2010-10-29
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_notes
    (
        i_lang             IN language.id_language%TYPE,
        i_prof             IN alert.profissional,
        i_id_drug_req_det  IN drug_req_det.id_drug_req_det%TYPE,
        o_all_notes        OUT pk_types.cursor_type,
        o_notes_4physician OUT pk_types.cursor_type,
        o_reject_notes     OUT pk_types.cursor_type,
        o_error            OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
    
        g_error := 'All Notes';
        OPEN o_all_notes FOR
            SELECT drd.id_drug_req_det, drdst.notes1 notes1, drdst.notes2 notes2
              FROM drug_req_det drd
             INNER JOIN drug_req_det_state_transition drdst
                ON (drd.id_drug_req_det = drdst.id_drug_req_det)
             WHERE drd.id_drug_req_det = i_id_drug_req_det
               AND (drdst.notes1 IS NOT NULL OR drdst.notes2 IS NOT NULL)
            UNION ALL
            SELECT drd.id_drug_req_det, drsst.notes1 notes1, drsst.notes2 notes2
              FROM drug_req_det drd
             INNER JOIN drug_req_supply drs
                ON (drd.id_drug_req_det = drs.id_drug_req_det)
             INNER JOIN drug_req_sup_state_transition drsst
                ON (drs.id_drug_req_supply = drsst.id_drug_req_supply)
             WHERE drd.id_drug_req_det = i_id_drug_req_det
               AND (drsst.notes1 IS NOT NULL OR drsst.notes2 IS NOT NULL);
    
        g_error := 'Physician Notes';
        OPEN o_notes_4physician FOR
            SELECT drd.id_drug_req_det, drdst.notes1 notes1, drdst.notes2 notes2
              FROM drug_req_det drd
             INNER JOIN drug_req_det_state_transition drdst
                ON (drd.id_drug_req_det = drdst.id_drug_req_det)
             WHERE drd.id_drug_req_det = i_id_drug_req_det
               AND (drdst.notes1 IS NOT NULL OR drdst.notes2 IS NOT NULL)
            UNION ALL
            SELECT drd.id_drug_req_det, drsst.notes1 notes1, drsst.notes2 notes2
              FROM drug_req_det drd
             INNER JOIN drug_req_supply drs
                ON (drd.id_drug_req_det = drs.id_drug_req_det)
             INNER JOIN drug_req_sup_state_transition drsst
                ON (drs.id_drug_req_supply = drsst.id_drug_req_supply)
             WHERE drd.id_drug_req_det = i_id_drug_req_det
               AND drsst.id_state != pk_pharmacy.get_state_for_req_type(i_prof, NULL, g_drs_readyforvalid_st)
               AND (drsst.notes1 IS NOT NULL OR drsst.notes2 IS NOT NULL);
    
        g_error := 'Rejection Notes';
        OPEN o_reject_notes FOR
            SELECT drd.id_drug_req_det, drdst.notes1
              FROM drug_req dr
             INNER JOIN drug_req_det drd
                ON (dr.id_drug_req = drd.id_drug_req)
             INNER JOIN drug_req_det_state_transition drdst
                ON (drd.id_drug_req_det = drdst.id_drug_req_det)
             WHERE drd.id_drug_req_det = i_id_drug_req_det
               AND drdst.id_state = pk_pharmacy.get_state_for_req_type(i_prof, dr.flg_type, g_drd_rejected_st);
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_notes', o_error);
            RETURN FALSE;
    END get_notes;

    /********************************************************************************************
    * alert.pk_pharmacy.get_formated_notes  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_ID_DRUG_REQ                   IN        NUMBER(24)
    * @param  O_FORMATED_A_NOTES              OUT       VARCHAR2
    * @param  O_FORMATED_P_NOTES              OUT       VARCHAR2
    * @param  O_FORMATED_R_NOTES              OUT       VARCHAR2
    *
    * @author Pedro Miranda
    * @version  2.5.1.2
    * @since  2010-10-29
    *
    * @notes  
    *
    ********************************************************************************************/
    PROCEDURE get_formated_notes
    (
        i_lang             IN language.id_language%TYPE,
        i_prof             IN alert.profissional,
        i_id_drug_req      IN drug_req_det.id_drug_req_det%TYPE,
        o_formated_a_notes OUT VARCHAR2,
        o_formated_p_notes OUT VARCHAR2,
        o_formated_r_notes OUT VARCHAR2
    ) IS
        a_notes           pk_types.cursor_type;
        p_notes           pk_types.cursor_type;
        r_notes           pk_types.cursor_type;
        l_error           t_error_out;
        l_break           VARCHAR2(5) := '<br>';
        l_flg             BOOLEAN;
        l_id_drug_req_det drug_req_det.id_drug_req_det%TYPE;
        notes1            drug_req_det_state_transition.notes1%TYPE;
        notes2            drug_req_det_state_transition.notes2%TYPE;
        notes             drug_req_det_state_transition.notes1%TYPE;
    BEGIN
        o_formated_a_notes := '';
        o_formated_p_notes := '';
        o_formated_r_notes := '';
    
        l_flg := get_notes(i_lang             => i_lang,
                           i_prof             => i_prof,
                           i_id_drug_req_det  => i_id_drug_req,
                           o_all_notes        => a_notes,
                           o_notes_4physician => p_notes,
                           o_reject_notes     => r_notes,
                           o_error            => l_error);
    
        g_error := 'A_NOTES';
        IF (l_flg AND a_notes%ISOPEN)
        THEN
            LOOP
                FETCH a_notes
                    INTO l_id_drug_req_det, notes1, notes2;
                EXIT WHEN a_notes%NOTFOUND;
                o_formated_a_notes := notes1 || l_break || notes2 || l_break || o_formated_a_notes || l_break;
            END LOOP;
        
            CLOSE a_notes;
        END IF;
    
        g_error := 'P_NOTES';
        IF (l_flg AND p_notes%ISOPEN)
        THEN
            LOOP
                FETCH p_notes
                    INTO l_id_drug_req_det, notes1, notes2;
                EXIT WHEN p_notes%NOTFOUND;
                o_formated_p_notes := notes1 || l_break || notes2 || l_break || o_formated_p_notes || l_break;
            END LOOP;
        
            CLOSE p_notes;
        END IF;
    
        g_error := 'R_NOTES';
        IF (l_flg AND r_notes%ISOPEN)
        THEN
            LOOP
                FETCH r_notes
                    INTO l_id_drug_req_det, notes;
                EXIT WHEN r_notes%NOTFOUND;
                o_formated_r_notes := notes || l_break || o_formated_r_notes || l_break;
            END LOOP;
        
            CLOSE r_notes;
        END IF;
    
    EXCEPTION
        WHEN OTHERS THEN
            IF (a_notes%ISOPEN)
            THEN
                CLOSE a_notes;
            END IF;
            IF (p_notes%ISOPEN)
            THEN
                CLOSE p_notes;
            END IF;
            IF (r_notes%ISOPEN)
            THEN
                CLOSE r_notes;
            END IF;
        
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_formated_noted', l_error);
            RAISE;
    END get_formated_notes;

    FUNCTION get_pharm_order_details
    (
        i_lang               IN language.id_language%TYPE,
        i_prof               IN alert.profissional,
        i_id_drug_presc_det  IN drug_presc_det.id_drug_presc_det%TYPE,
        flg_only_most_recent IN VARCHAR2 DEFAULT 'N',
        i_id_drug_req_det    IN drug_req_det.id_drug_req_det%TYPE DEFAULT NULL,
        flg_into_type        IN VARCHAR2 DEFAULT 'ALL',
        i_get_headers        IN VARCHAR2 DEFAULT 'N',
        i_header_codes       IN table_varchar DEFAULT NULL,
        o_details            OUT pk_types.cursor_type,
        o_req_header         OUT pk_types.cursor_type,
        o_warnings_details   OUT pk_types.cursor_type,
        o_headers            OUT pk_types.cursor_type,
        o_headers_details    OUT pk_types.cursor_type,
        o_error              OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_header_codes    table_varchar;
        l_id_drug_req_det drug_req_det.id_drug_req_det%TYPE;
        l_epis            drug_req.id_episode%TYPE;
        all_notes         VARCHAR2(4000);
        physician_notes   VARCHAR2(4000);
        rejection_notes   VARCHAR2(4000);
    BEGIN
    
        g_error := 'GET HEADERS';
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, i_header_codes, o_headers);
    
        g_error        := 'GET HEADERS FOR DETAILS';
        l_header_codes := table_varchar --label list for all kind of details
                          ('PHARMACIST_DETAIL_DCI', --
                           'PHARMACIST_DETAIL_FORM_PHARM', --
                           'PHARMACIST_DETAIL_CHNM', --
                           'PHARMACIST_DETAIL_PHARM_DESC', --
                           'PHARMACIST_DETAIL_PHARM_DESC_OLD', --
                           'PHARMACIST_DETAIL_PHARM_INSTR_OLD', --
                           'PHARMACIST_DETAIL_QTY_TO_PREP_OLD',
                           'PHARMACIST_DETAIL_PHARM_DESC_NEW', --
                           'PHARMACIST_DETAIL_PHARM_INSTR_NEW', --
                           'PHARMACIST_DETAIL_QTY_PREP', --
                           'PHARMACIST_DETAIL_PACKAGE_NUMBER', --
                           'PHARMACIST_DETAIL_DT_EXPIRE', --
                           'PHARMACIST_DETAIL_NOTES_TO_PHYSICIAN', --
                           'PHARMACIST_DETAIL_NOTES_REJECT' --
                           
                           );
        get_pharmacy_headers_labels(i_lang, i_prof, i_get_headers, l_header_codes, o_headers_details);
    
        g_error := 'GET ORDERS DETAILS';
    
        IF (i_id_drug_presc_det IS NOT NULL AND i_id_drug_req_det IS NULL AND flg_only_most_recent = 'N')
        THEN
        
            FOR c_cur_orders IN (SELECT drd.id_drug_req_det
                                   FROM drug_req_det drd
                                  INNER JOIN drug_req dr
                                     ON (drd.id_drug_req = dr.id_drug_req)
                                  INNER JOIN drug_presc_det dpd
                                     ON (dr.id_drug_presc_det = dpd.id_drug_presc_det)
                                  WHERE dpd.id_drug_presc_det = i_id_drug_presc_det
                                  ORDER BY dr.dt_drug_req_tstz)
            LOOP
            
                l_epis := get_episode_drug_req_det(c_cur_orders.id_drug_req_det);
            
                --drug description
                OPEN o_req_header FOR
                    SELECT decode(drd.id_drug,
                                  g_drug_iv_fluid_constructed,
                                  get_medication_name(i_lang,
                                                      i_prof,
                                                      drd.id_drug,
                                                      drd.vers,
                                                      dr.flg_type,
                                                      dr.id_drug_presc_det,
                                                      g_yes,
                                                      drd.id_other_product),
                                  nvl(mm.dci_descr,
                                      get_medication_name(i_lang,
                                                          i_prof,
                                                          drd.id_drug,
                                                          drd.vers,
                                                          dr.flg_type,
                                                          dr.id_drug_presc_det,
                                                          g_yes,
                                                          drd.id_other_product))) dci,
                           mm.form_farm_descr form_pharm,
                           mm.chnm_id chnm
                      FROM drug_req_det drd
                     INNER JOIN drug_req dr
                        ON (drd.id_drug_req = dr.id_drug_req)
                      LEFT JOIN mi_med mm
                        ON (drd.id_drug = mm.id_drug AND drd.vers = mm.vers)
                     WHERE drd.id_drug_req_det = c_cur_orders.id_drug_req_det;
            
                IF (flg_into_type = 'MINIMAL')
                THEN
                
                    OPEN o_details FOR
                        SELECT pk_translation.get_translation(i_lang, ws.code_state) state_name,
                               pk_medication_core.format_detail_date(i_lang, i_prof, drdst.dt_create /*drdst.dt_state*/) dt_state,
                               pk_prof_utils.get_name_signature(i_lang, i_prof, drdst.id_prof) prof_name,
                               pk_prof_utils.get_spec_signature(i_lang, i_prof, drdst.id_prof, drdst.dt_state, l_epis) spec_name,
                               drdst.dt_create dt
                          FROM drug_req_det drd
                         INNER JOIN drug_req dr
                            ON (drd.id_drug_req = dr.id_drug_req)
                         INNER JOIN drug_req_det_state_transition drdst
                            ON (drd.id_drug_req_det = drdst.id_drug_req_det)
                         INNER JOIN wfl_state ws
                            ON (drdst.id_state = ws.id_state)
                         WHERE drd.id_drug_req_det = c_cur_orders.id_drug_req_det
                           AND drdst.id_state =
                               pk_pharmacy.get_state_for_req_type(i_prof, dr.flg_type, g_drd_rejected_st)
                        UNION ALL
                        SELECT pk_translation.get_translation(i_lang, ws.code_state) state_name,
                               pk_medication_core.format_detail_date(i_lang, i_prof, drsst.dt_state /*drdst.dt_state*/) dt_state,
                               pk_prof_utils.get_name_signature(i_lang, i_prof, drsst.id_prof) prof_name,
                               pk_prof_utils.get_spec_signature(i_lang, i_prof, drsst.id_prof, drsst.dt_state, l_epis) spec_name,
                               drsst.dt_state dt
                          FROM drug_req_det drd
                         INNER JOIN drug_req_supply drs
                            ON (drd.id_drug_req_det = drs.id_drug_req_det)
                         INNER JOIN drug_req_sup_state_transition drsst
                            ON (drs.id_drug_req_supply = drsst.id_drug_req_supply)
                         INNER JOIN wfl_state ws
                            ON (drsst.id_state = ws.id_state)
                         WHERE drd.id_drug_req_det = c_cur_orders.id_drug_req_det
                           AND drsst.id_state = pk_pharmacy.get_state_for_req_type(i_prof, NULL, g_drs_supplied_st);
                
                ELSIF (flg_into_type = 'DETAILED')
                THEN
                
                    get_formated_notes(i_lang             => i_lang,
                                       i_prof             => i_prof,
                                       i_id_drug_req      => c_cur_orders.id_drug_req_det,
                                       o_formated_a_notes => all_notes,
                                       o_formated_p_notes => physician_notes,
                                       o_formated_r_notes => rejection_notes);
                
                    OPEN o_details FOR
                        SELECT physician_notes  notes_to_physician,
                               rejection_notes  notes_reject,
                               drd.qty_supplied qty_prep,
                               NULL             package_number,
                               NULL             dt_expire
                          FROM drug_req_det drd
                         INNER JOIN drug_req dr
                            ON (drd.id_drug_req = dr.id_drug_req)
                         INNER JOIN drug_req_det_state_transition drdst
                            ON (drd.id_drug_req_det = drdst.id_drug_req_det)
                         INNER JOIN wfl_state ws
                            ON (drdst.id_state = ws.id_state)
                         WHERE drd.id_drug_req_det = c_cur_orders.id_drug_req_det
                           AND drdst.id_state =
                               pk_pharmacy.get_state_for_req_type(i_prof, dr.flg_type, g_drd_rejected_st)
                        UNION ALL
                        SELECT physician_notes    notes_to_physician,
                               rejection_notes    notes_reject,
                               drs.qty_supply     qty_prep,
                               drs.package_number package_number,
                               drs.dt_expire      dt_expire
                          FROM drug_req_det drd
                         INNER JOIN drug_req_supply drs
                            ON (drd.id_drug_req_det = drs.id_drug_req_det)
                         INNER JOIN drug_req_sup_state_transition drsst
                            ON (drs.id_drug_req_supply = drsst.id_drug_req_supply)
                         INNER JOIN wfl_state ws
                            ON (drsst.id_state = ws.id_state)
                         WHERE drd.id_drug_req_det = c_cur_orders.id_drug_req_det
                           AND drsst.id_state = get_state_for_req_type(i_prof, NULL, g_drs_supplied_st);
                
                ELSIF (flg_into_type = 'ALL')
                THEN
                
                    get_formated_notes(i_lang             => i_lang,
                                       i_prof             => i_prof,
                                       i_id_drug_req      => c_cur_orders.id_drug_req_det,
                                       o_formated_a_notes => all_notes,
                                       o_formated_p_notes => physician_notes,
                                       o_formated_r_notes => rejection_notes);
                
                    OPEN o_details FOR
                        SELECT pk_translation.get_translation(i_lang, ws.code_state) state_name,
                               pk_medication_core.format_detail_date(i_lang, i_prof, drdst.dt_create /*drdst.dt_state*/) dt_state,
                               pk_prof_utils.get_name_signature(i_lang, i_prof, drdst.id_prof) prof_name,
                               pk_prof_utils.get_spec_signature(i_lang, i_prof, drdst.id_prof, drdst.dt_state, l_epis) spec_name,
                               drdst.dt_create dt,
                               physician_notes notes_to_physician,
                               rejection_notes notes_reject,
                               drd.qty_supplied qty_prep,
                               NULL package_number,
                               NULL dt_expire
                          FROM drug_req_det drd
                         INNER JOIN drug_req dr
                            ON (drd.id_drug_req = dr.id_drug_req)
                         INNER JOIN drug_req_det_state_transition drdst
                            ON (drd.id_drug_req_det = drdst.id_drug_req_det)
                         INNER JOIN wfl_state ws
                            ON (drdst.id_state = ws.id_state)
                         WHERE drd.id_drug_req_det = c_cur_orders.id_drug_req_det
                           AND drdst.id_state =
                               pk_pharmacy.get_state_for_req_type(i_prof, dr.flg_type, g_drd_rejected_st)
                        UNION ALL
                        SELECT pk_translation.get_translation(i_lang, ws.code_state) state_name,
                               pk_medication_core.format_detail_date(i_lang, i_prof, drsst.dt_state /*drdst.dt_state*/) dt_state,
                               pk_prof_utils.get_name_signature(i_lang, i_prof, drsst.id_prof) prof_name,
                               pk_prof_utils.get_spec_signature(i_lang, i_prof, drsst.id_prof, drsst.dt_state, l_epis) spec_name,
                               drsst.dt_state dt,
                               physician_notes notes_to_physician,
                               rejection_notes notes_reject,
                               drs.qty_supply qty_prep,
                               drs.package_number package_number,
                               drs.dt_expire dt_expire
                          FROM drug_req_det drd
                         INNER JOIN drug_req_supply drs
                            ON (drd.id_drug_req_det = drs.id_drug_req_det)
                         INNER JOIN drug_req_sup_state_transition drsst
                            ON (drs.id_drug_req_supply = drsst.id_drug_req_supply)
                         INNER JOIN wfl_state ws
                            ON (drsst.id_state = ws.id_state)
                         WHERE drd.id_drug_req_det = c_cur_orders.id_drug_req_det
                           AND drsst.id_state = get_state_for_req_type(i_prof, NULL, g_drs_supplied_st);
                END IF;
            
                OPEN o_warnings_details FOR
                    SELECT dpj.id_drug_presc_just,
                           dpj.clinical_info,
                           dpj.presc_justification,
                           dpj.flg_oth_med_same_purpose,
                           dpj.other_med_justification,
                           dpj.flg_bacteriological_study,
                           dpj.bacterio_study_justif,
                           dpj.bacterio_study_result,
                           dpj.pharmacist_notes
                      FROM drug_presc_justification dpj
                     WHERE dpj.id_drug_req_det = c_cur_orders.id_drug_req_det;
            
            END LOOP;
        
        ELSE
        
            IF (flg_only_most_recent = g_yes)
            THEN
            
                l_id_drug_req_det := get_last_order_for_presc(i_prof, i_id_drug_presc_det);
            ELSE
                l_id_drug_req_det := i_id_drug_req_det;
            END IF;
        
            l_epis := get_episode_drug_req_det(l_id_drug_req_det);
        
            OPEN o_warnings_details FOR
                SELECT dpj.id_drug_presc_just,
                       dpj.clinical_info,
                       dpj.presc_justification,
                       dpj.flg_oth_med_same_purpose,
                       dpj.other_med_justification,
                       dpj.flg_bacteriological_study,
                       dpj.bacterio_study_justif,
                       dpj.bacterio_study_result,
                       dpj.pharmacist_notes
                  FROM drug_presc_justification dpj
                 WHERE dpj.id_drug_req_det = l_id_drug_req_det;
        
            --drug description
            OPEN o_req_header FOR
                SELECT decode(drd.id_drug,
                              g_drug_iv_fluid_constructed,
                              get_medication_name(i_lang,
                                                  i_prof,
                                                  drd.id_drug,
                                                  drd.vers,
                                                  dr.flg_type,
                                                  dr.id_drug_presc_det,
                                                  g_yes,
                                                  drd.id_other_product),
                              nvl(mm.dci_descr,
                                  get_medication_name(i_lang,
                                                      i_prof,
                                                      drd.id_drug,
                                                      drd.vers,
                                                      dr.flg_type,
                                                      dr.id_drug_presc_det,
                                                      g_yes,
                                                      drd.id_other_product))) dci,
                       mm.form_farm_descr form_pharm,
                       mm.chnm_id chnm
                  FROM drug_req_det drd
                 INNER JOIN drug_req dr
                    ON (drd.id_drug_req = dr.id_drug_req)
                  LEFT JOIN mi_med mm
                    ON (drd.id_drug = mm.id_drug AND drd.vers = mm.vers)
                 WHERE drd.id_drug_req_det = l_id_drug_req_det;
        
            IF (flg_into_type = 'MINIMAL')
            THEN
            
                OPEN o_details FOR
                    SELECT pk_translation.get_translation(i_lang, ws.code_state) state_name,
                           pk_medication_core.format_detail_date(i_lang, i_prof, drdst.dt_create /*drdst.dt_state*/) dt_state,
                           pk_prof_utils.get_name_signature(i_lang, i_prof, drdst.id_prof) prof_name,
                           pk_prof_utils.get_spec_signature(i_lang, i_prof, drdst.id_prof, drdst.dt_state, l_epis) spec_name,
                           drdst.dt_create dt
                      FROM drug_req_det drd
                     INNER JOIN drug_req dr
                        ON (drd.id_drug_req = dr.id_drug_req)
                     INNER JOIN drug_req_det_state_transition drdst
                        ON (drd.id_drug_req_det = drdst.id_drug_req_det)
                     INNER JOIN wfl_state ws
                        ON (drdst.id_state = ws.id_state)
                     WHERE drd.id_drug_req_det = l_id_drug_req_det
                       AND drdst.id_state = pk_pharmacy.get_state_for_req_type(i_prof, dr.flg_type, g_drd_rejected_st)
                    UNION ALL
                    SELECT pk_translation.get_translation(i_lang, ws.code_state) state_name,
                           pk_medication_core.format_detail_date(i_lang, i_prof, drsst.dt_state /*drdst.dt_state*/) dt_state,
                           pk_prof_utils.get_name_signature(i_lang, i_prof, drsst.id_prof) prof_name,
                           pk_prof_utils.get_spec_signature(i_lang, i_prof, drsst.id_prof, drsst.dt_state, l_epis) spec_name,
                           drsst.dt_state dt
                      FROM drug_req_det drd
                     INNER JOIN drug_req_supply drs
                        ON (drd.id_drug_req_det = drs.id_drug_req_det)
                     INNER JOIN drug_req_sup_state_transition drsst
                        ON (drs.id_drug_req_supply = drsst.id_drug_req_supply)
                     INNER JOIN wfl_state ws
                        ON (drsst.id_state = ws.id_state)
                     WHERE drd.id_drug_req_det = l_id_drug_req_det
                       AND drsst.id_state = get_state_for_req_type(i_prof, NULL, g_drs_supplied_st);
            
            ELSIF (flg_into_type = 'DETAILED')
            THEN
            
                get_formated_notes(i_lang             => i_lang,
                                   i_prof             => i_prof,
                                   i_id_drug_req      => l_id_drug_req_det,
                                   o_formated_a_notes => all_notes,
                                   o_formated_p_notes => physician_notes,
                                   o_formated_r_notes => rejection_notes);
            
                OPEN o_details FOR
                    SELECT physician_notes  notes_to_physician,
                           rejection_notes  notes_reject,
                           drd.qty_supplied qty_prep,
                           NULL             package_number,
                           NULL             dt_expire
                      FROM drug_req_det drd
                     INNER JOIN drug_req dr
                        ON (drd.id_drug_req = dr.id_drug_req)
                     INNER JOIN drug_req_det_state_transition drdst
                        ON (drd.id_drug_req_det = drdst.id_drug_req_det)
                     INNER JOIN wfl_state ws
                        ON (drdst.id_state = ws.id_state)
                     WHERE drd.id_drug_req_det = l_id_drug_req_det
                       AND drdst.id_state = pk_pharmacy.get_state_for_req_type(i_prof, dr.flg_type, g_drd_rejected_st)
                    UNION ALL
                    SELECT physician_notes    notes_to_physician,
                           rejection_notes    notes_reject,
                           drs.qty_supply     qty_prep,
                           drs.package_number package_number,
                           drs.dt_expire      dt_expire
                      FROM drug_req_det drd
                     INNER JOIN drug_req_supply drs
                        ON (drd.id_drug_req_det = drs.id_drug_req_det)
                     INNER JOIN drug_req_sup_state_transition drsst
                        ON (drs.id_drug_req_supply = drsst.id_drug_req_supply)
                     INNER JOIN wfl_state ws
                        ON (drsst.id_state = ws.id_state)
                     WHERE drd.id_drug_req_det = l_id_drug_req_det
                       AND drsst.id_state = get_state_for_req_type(i_prof, NULL, g_drs_supplied_st);
            
            ELSIF (flg_into_type = 'ALL')
            THEN
            
                get_formated_notes(i_lang             => i_lang,
                                   i_prof             => i_prof,
                                   i_id_drug_req      => l_id_drug_req_det,
                                   o_formated_a_notes => all_notes,
                                   o_formated_p_notes => physician_notes,
                                   o_formated_r_notes => rejection_notes);
            
                OPEN o_details FOR
                    SELECT pk_translation.get_translation(i_lang, ws.code_state) state_name,
                           pk_medication_core.format_detail_date(i_lang, i_prof, drdst.dt_create /*drdst.dt_state*/) dt_state,
                           pk_prof_utils.get_name_signature(i_lang, i_prof, drdst.id_prof) prof_name,
                           pk_prof_utils.get_spec_signature(i_lang, i_prof, drdst.id_prof, drdst.dt_state, l_epis) spec_name,
                           drdst.dt_create dt,
                           physician_notes notes_to_physician,
                           rejection_notes notes_reject,
                           drd.qty_supplied qty_prep,
                           NULL package_number,
                           NULL dt_expire
                      FROM drug_req_det drd
                     INNER JOIN drug_req dr
                        ON (drd.id_drug_req = dr.id_drug_req)
                     INNER JOIN drug_req_det_state_transition drdst
                        ON (drd.id_drug_req_det = drdst.id_drug_req_det)
                     INNER JOIN wfl_state ws
                        ON (drdst.id_state = ws.id_state)
                     WHERE drd.id_drug_req_det = l_id_drug_req_det
                       AND drdst.id_state = pk_pharmacy.get_state_for_req_type(i_prof, dr.flg_type, g_drd_rejected_st)
                    UNION ALL
                    SELECT pk_translation.get_translation(i_lang, ws.code_state) state_name,
                           pk_medication_core.format_detail_date(i_lang, i_prof, drsst.dt_state /*drdst.dt_state*/) dt_state,
                           pk_prof_utils.get_name_signature(i_lang, i_prof, drsst.id_prof) prof_name,
                           pk_prof_utils.get_spec_signature(i_lang, i_prof, drsst.id_prof, drsst.dt_state, l_epis) spec_name,
                           drsst.dt_state dt,
                           physician_notes notes_to_physician,
                           rejection_notes notes_reject,
                           drs.qty_supply qty_prep,
                           drs.package_number package_number,
                           drs.dt_expire dt_expire
                      FROM drug_req_det drd
                     INNER JOIN drug_req_supply drs
                        ON (drd.id_drug_req_det = drs.id_drug_req_det)
                     INNER JOIN drug_req_sup_state_transition drsst
                        ON (drs.id_drug_req_supply = drsst.id_drug_req_supply)
                     INNER JOIN wfl_state ws
                        ON (drsst.id_state = ws.id_state)
                     WHERE drd.id_drug_req_det = l_id_drug_req_det
                       AND drsst.id_state = get_state_for_req_type(i_prof, NULL, g_drs_supplied_st);
            END IF;
        END IF;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_pharm_order_details', o_error);
            pk_types.open_my_cursor(o_details);
            pk_types.open_my_cursor(o_headers);
            pk_types.open_my_cursor(o_headers_details);
            pk_types.open_my_cursor(o_req_header);
            pk_types.open_my_cursor(o_warnings_details);
            RETURN FALSE;
    END get_pharm_order_details;

    /********************************************************************************************
    * alert.pk_pharmacy.get_prof_previous_state  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_ID_DRUG_REQ_DET               IN        NUMBER(24)
    * @param  I_ID_STATE                      IN        NUMBER(24)
    * @param  O_ID_PROF                       OUT       NUMBER(24)
    * @param  O_ERROR                         OUT       ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Pedro Miranda
    * @version  2.5.1.2
    * @since  2010-11-23
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_prof_previous_state
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN alert.profissional,
        i_id_drug_req_det IN drug_req_det.id_drug_req_det%TYPE,
        i_id_state        IN wfl_state.id_state%TYPE,
        o_id_prof         OUT drug_req_det_state_transition.id_prof%TYPE,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'NO PREVIOUS STATE';
        SELECT v.id_prof
          INTO o_id_prof
          FROM (SELECT drdst.id_prof id_prof
                  FROM drug_req_det_state_transition drdst
                 INNER JOIN wfl_state ws
                    ON (drdst.id_state = ws.id_state)
                 WHERE drdst.id_drug_req_det = i_id_drug_req_det
                   AND drdst.id_state != i_id_state
                   AND drdst.dt_state <= current_timestamp
                 ORDER BY drdst.dt_state DESC) v
         WHERE rownum = 1;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, 'get_prof_previous_state', o_error);
            RETURN FALSE;
    END get_prof_previous_state;

    /********************************************************************************************
    * alert.pk_pharmacy.get_refill  
    *
    * @param  I_ID_DRUG_REQ_DET               IN        NUMBER(24)
    *
    * @return NUMBER
    *
    * @author Pedro Miranda
    * @version  2.6.0.4
    * @since  2010-10-21
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_refill(i_id_drug_req_det IN drug_req_det.id_drug_req_det%TYPE) RETURN NUMBER IS
        l_refill_char drug_presc_det.refill%TYPE;
        l_refill_num  NUMBER;
    
    BEGIN
    
        SELECT drd.refill
          INTO l_refill_char
          FROM drug_req_det drd
         WHERE drd.id_drug_req_det = i_id_drug_req_det;
    
        BEGIN
            l_refill_num := to_number(l_refill_char);
        EXCEPTION
            WHEN OTHERS THEN
                l_refill_num := NULL;
        END;
    
        RETURN l_refill_num;
    END get_refill;

    /********************************************************************************************
    * alert.pk_pharmacy.set_change_prescription  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_PROF_CAT_TYPE                 IN        VARCHAR2
    * @param  I_EPISODE                       IN        NUMBER(24)
    * @param  I_PATIENT                       IN        NUMBER(24)
    * @param  I_ID_DRUG                       IN        ALERT.TABLE_VARCHAR
    * @param  I_ID_OTHER_PRODUCT              IN        ALERT.TABLE_NUMBER
    * @param  I_DESC_OTHER_PRODUCT            IN        ALERT.TABLE_VARCHAR
    * @param  I_FLG_FREE_TEXT                 IN        ALERT.TABLE_VARCHAR
    * @param  I_PRESC_DIRECTIONS              IN        ALERT.TABLE_TABLE_VARCHAR
    * @param  I_PRESC_DIR_INTERVAL            IN        ALERT.TABLE_TABLE_VARCHAR
    * @param  I_PRESC_DIR_DOSEFREQ            IN        ALERT.TABLE_TABLE_VARCHAR
    * @param  I_PRESC_DIR_FREQDET             IN        ALERT.TABLE_TABLE_VARCHAR
    * @param  I_NOTES                         IN        ALERT.TABLE_VARCHAR
    * @param  I_ID_POSTERIORI_JUST            IN        ALERT.TABLE_NUMBER
    * @param  I_DESC_POSTERIORI_JUST          IN        ALERT.TABLE_VARCHAR
    * @param  I_FLG_IS_POST_PRESC             IN        ALERT.TABLE_VARCHAR
    * @param  I_ID_DPD                        IN        ALERT.TABLE_NUMBER
    * @param  I_CLINICAL_INFO                 IN        ALERT.TABLE_VARCHAR
    * @param  I_PRESC_JUSTIFICATION           IN        ALERT.TABLE_VARCHAR
    * @param  I_FLG_OTH_MED_SAME_PURPOSE      IN        ALERT.TABLE_VARCHAR
    * @param  I_OTHER_MED_JUSTIFICATION       IN        ALERT.TABLE_VARCHAR
    * @param  I_FLG_BACTERIOLOGICAL_STUDY     IN        ALERT.TABLE_VARCHAR
    * @param  I_BACTERIO_STUDY_JUSTIF         IN        ALERT.TABLE_VARCHAR
    * @param  I_BACTERIO_STUDY_RESULT         IN        ALERT.TABLE_VARCHAR
    * @param  I_FLG_JUSTIFY                   IN        ALERT.TABLE_VARCHAR
    * @param  I_PROF_CO_SIGN                  IN        ALERT.TABLE_NUMBER
    * @param  I_FLG_CO_SIGN                   IN        ALERT.TABLE_VARCHAR
    * @param  I_DT_CO_SIGN                    IN        ALERT.TABLE_VARCHAR
    * @param  I_NOTES_CO_SIGN                 IN        ALERT.TABLE_VARCHAR
    * @param  I_ORDER_TYPE_CO_SIGN            IN        ALERT.TABLE_NUMBER
    * @param  I_FLG_DRAFT                     IN        VARCHAR2
    * @param  I_FLG_NO_UPD_PHARM              IN        VARCHAR2
    * @param  I_DRUG_REQ_DET_OLD              IN        NUMBER(24)
    * @param  I_NOTES_PHYSICIAN               IN        VARCHAR2
    * @param  I_NOTES_PHARMACIST              IN        VARCHAR2
    * @param  I_QTY_TO_PREP                   IN        NUMBER(24,4)
    * @param  I_QTY_TO_PREP_UNIT              IN        NUMBER(24)
    * @param  I_WAIT_FOR_APPROV               IN        VARCHAR2
    * @param  I_COSIGNED_BY                   IN        NUMBER(24)
    * @param  I_COSIGNED_DATE                 IN        VARCHAR2
    * @param  I_COSIGNED_TYPE                 IN        NUMBER(12)
    * @param  I_COSIGNED_NOTES                IN        VARCHAR2
    * @param  I_ID_PRESC_DIRECTIONS           IN        ALERT.TABLE_NUMBER
    * @param  O_ID_DRUG_PRESC_DET             OUT       ALERT.TABLE_NUMBER
    * @param  O_ID_PRESC_DIRECTIONS           OUT       ALERT.TABLE_NUMBER
    * @param  O_FLG_SHOW                      OUT       VARCHAR2
    * @param  O_MSG                           OUT       VARCHAR2
    * @param  O_MSG_TITLE                     OUT       VARCHAR2
    * @param  O_BUTTON                        OUT       VARCHAR2
    * @param  O_ERROR                         OUT       ALERT.T_ERROR_OUT
    *
    * @return BOOLEAN
    *
    * @author Pedro Miranda
    * @version  2.5.1.2
    * @since  2010-11-24
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION set_change_prescription
    (
        i_lang                      IN language.id_language%TYPE,
        i_prof                      IN alert.profissional,
        i_prof_cat_type             IN category.flg_type%TYPE,
        i_episode                   IN episode.id_episode%TYPE,
        i_patient                   IN patient.id_patient%TYPE,
        i_id_drug                   IN table_varchar,
        i_id_other_product          IN table_number,
        i_desc_other_product        IN table_varchar,
        i_flg_free_text             IN table_varchar,
        i_presc_directions          IN table_table_varchar,
        i_presc_dir_interval        IN table_table_varchar,
        i_presc_dir_dosefreq        IN table_table_varchar,
        i_presc_dir_freqdet         IN table_table_varchar,
        i_notes                     IN table_varchar,
        i_id_posteriori_just        IN table_number,
        i_desc_posteriori_just      IN table_varchar,
        i_flg_is_post_presc         IN table_varchar DEFAULT NULL,
        i_id_dpd                    IN table_number DEFAULT NULL,
        i_clinical_info             IN table_varchar DEFAULT NULL,
        i_presc_justification       IN table_varchar DEFAULT NULL,
        i_flg_oth_med_same_purpose  IN table_varchar DEFAULT NULL,
        i_other_med_justification   IN table_varchar DEFAULT NULL,
        i_flg_bacteriological_study IN table_varchar DEFAULT NULL,
        i_bacterio_study_justif     IN table_varchar DEFAULT NULL,
        i_bacterio_study_result     IN table_varchar DEFAULT NULL,
        i_flg_justify               IN table_varchar DEFAULT NULL,
        i_prof_co_sign              IN table_number,
        i_flg_co_sign               IN table_varchar,
        i_dt_co_sign                IN table_varchar,
        i_notes_co_sign             IN table_varchar,
        i_order_type_co_sign        IN table_number,
        i_flg_draft                 IN table_varchar,
        i_flg_no_upd_pharm          IN VARCHAR2 DEFAULT 'N',
        i_execution_episode         IN table_number,
        i_id_cdr_call               IN table_number,
        --
        i_drug_req_det_old IN drug_req_det.id_drug_req_det%TYPE,
        --i_drug_presc_det_new    in  drug_presc_det.id_drug_presc_det%type,
        i_notes_physician     IN drug_req_det_state_transition.notes1%TYPE DEFAULT NULL,
        i_notes_pharmacist    IN drug_req_det_state_transition.notes1%TYPE DEFAULT NULL,
        i_qty_to_prep         IN drug_req_det.qty_to_prep%TYPE,
        i_qty_to_prep_unit    IN drug_req_det.id_unit_measure_prep%TYPE,
        i_wait_for_approv     IN VARCHAR2 DEFAULT 'N',
        i_cosigned_by         IN drug_req_det.id_prof_co_sign%TYPE DEFAULT NULL,
        i_cosigned_date       IN VARCHAR2 DEFAULT NULL,
        i_cosigned_type       IN drug_req_det.id_type_co_sign%TYPE DEFAULT NULL,
        i_cosigned_notes      IN drug_req_det.notes_co_sign%TYPE DEFAULT NULL,
        i_id_presc_directions IN table_number,
        o_id_drug_presc_det   OUT table_number,
        o_id_presc_directions OUT table_number,
        o_flg_show            OUT VARCHAR2,
        o_msg                 OUT VARCHAR2,
        o_msg_title           OUT VARCHAR2,
        o_button              OUT VARCHAR2,
        o_error               OUT t_error_out
    ) RETURN BOOLEAN IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'SET_CHANGE_PRESCRIPTION';
        --
        l_ret_presc BOOLEAN := FALSE;
    BEGIN
        set_pharmacy_log(l_db_object_name, 'set_prescription (id_drug_presc_det): ' || i_id_dpd(1));
    
        g_error     := 'pk_prescription_directions.set_prescription';
        l_ret_presc := pk_prescription_directions.set_prescription(i_lang                      => i_lang,
                                                                   i_prof                      => i_prof,
                                                                   i_prof_cat_type             => i_prof_cat_type,
                                                                   i_episode                   => i_episode,
                                                                   i_patient                   => i_patient,
                                                                   i_id_drug                   => i_id_drug,
                                                                   i_id_other_product          => i_id_other_product,
                                                                   i_desc_other_product        => i_desc_other_product,
                                                                   i_flg_free_text             => i_flg_free_text,
                                                                   i_presc_directions          => i_presc_directions,
                                                                   i_presc_dir_interval        => i_presc_dir_interval,
                                                                   i_presc_dir_dosefreq        => i_presc_dir_dosefreq,
                                                                   i_presc_dir_freqdet         => i_presc_dir_freqdet,
                                                                   i_notes                     => i_notes,
                                                                   i_id_posteriori_just        => i_id_posteriori_just,
                                                                   i_desc_posteriori_just      => i_desc_posteriori_just,
                                                                   i_flg_is_post_presc         => i_flg_is_post_presc,
                                                                   i_id_dpd                    => i_id_dpd,
                                                                   i_clinical_info             => i_clinical_info,
                                                                   i_presc_justification       => i_presc_justification,
                                                                   i_flg_oth_med_same_purpose  => i_flg_oth_med_same_purpose,
                                                                   i_other_med_justification   => i_other_med_justification,
                                                                   i_flg_bacteriological_study => i_flg_bacteriological_study,
                                                                   i_bacterio_study_justif     => i_bacterio_study_justif,
                                                                   i_bacterio_study_result     => i_bacterio_study_result,
                                                                   i_flg_justify               => i_flg_justify,
                                                                   i_prof_co_sign              => i_prof_co_sign,
                                                                   i_flg_co_sign               => i_flg_co_sign,
                                                                   i_dt_co_sign                => i_dt_co_sign,
                                                                   i_notes_co_sign             => i_notes_co_sign,
                                                                   i_order_type_co_sign        => i_order_type_co_sign,
                                                                   i_flg_draft                 => i_flg_draft,
                                                                   i_flg_no_upd_pharm          => i_flg_no_upd_pharm,
                                                                   i_execution_episode         => i_execution_episode,
                                                                   i_commit                    => g_no, --must be NO so it doens't commit
                                                                   i_id_cdr_call               => i_id_cdr_call,
                                                                   o_id_drug_presc_det         => o_id_drug_presc_det,
                                                                   o_id_presc_directions       => o_id_presc_directions,
                                                                   o_flg_show                  => o_flg_show,
                                                                   o_msg                       => o_msg,
                                                                   o_msg_title                 => o_msg_title,
                                                                   o_button                    => o_button,
                                                                   o_error                     => o_error);
    
        IF (l_ret_presc = TRUE AND (o_flg_show = g_no OR o_flg_show IS NULL))
        THEN
        
            FOR i IN 1 .. o_id_drug_presc_det.count
            LOOP
                set_pharmacy_log(l_db_object_name,
                                 'set_pat_change_presc (id_drug_presc_det): ' || o_id_drug_presc_det(1));
                g_error := 'set_pat_change_presc';
                set_pat_change_presc(i_lang                => i_lang,
                                     i_prof                => i_prof,
                                     i_drug_req_det_old    => i_drug_req_det_old,
                                     i_drug_presc_det_new  => o_id_drug_presc_det(i), --set_prescription could be used to more then 1 prescription (although in this case is always only just 1), so the value used is always the first from the table_number!
                                     i_notes_physician     => i_notes_physician,
                                     i_notes_pharmacist    => i_notes_pharmacist,
                                     i_qty_to_prep         => i_qty_to_prep,
                                     i_qty_to_prep_unit    => i_qty_to_prep_unit,
                                     i_wait_for_approv     => i_wait_for_approv,
                                     i_cosigned_by         => i_cosigned_by,
                                     i_cosigned_date       => i_cosigned_date,
                                     i_cosigned_type       => i_cosigned_type,
                                     i_cosigned_notes      => i_cosigned_notes,
                                     i_id_presc_directions => i_id_presc_directions,
                                     o_error               => o_error);
            END LOOP;
        
        ELSIF (l_ret_presc = TRUE AND o_flg_show = g_yes)
        THEN
            RAISE g_ex_presc_validate_true;
        ELSIF (l_ret_presc = FALSE)
        THEN
            RAISE g_ex_presc_validate;
        END IF;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN g_ex_presc_validate THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, o_error);
            pk_utils.undo_changes;
            o_error.ora_sqlerrm := o_error.ora_sqlerrm ||
                                   pk_pharmacy.get_drug_desc_pharm(i_lang       => i_lang,
                                                                   i_prof       => i_prof,
                                                                   i_id_episode => NULL,
                                                                   i_id_drd     => i_drug_req_det_old);
            RETURN FALSE;
        
        WHEN g_ex_presc_validate_true THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, o_error);
            pk_utils.undo_changes;
            RETURN TRUE;
        
        WHEN OTHERS THEN
            process_error(i_lang, SQLCODE, SQLERRM, g_error, l_db_object_name, o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_change_prescription;

    /********************************************************************************************
    * alert.pk_pharmacy.get_flg_off_car  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_ID_DRUG_REQ_SUPPLY            IN        NUMBER(24)
    * @param  O_FLG_OFF_CAR                   OUT       VARCHAR2
    *
    * @author Pedro Miranda
    * @version  2.5.1.3
    * @since  2010-12-07
    *
    * @notes  
    *
    ********************************************************************************************/
    PROCEDURE get_flg_off_car
    (
        i_lang               IN language.id_language%TYPE,
        i_prof               IN alert.profissional,
        i_id_drug_req_supply IN drug_req_supply.id_drug_req_supply%TYPE,
        o_flg_off_car        OUT drug_req_det.flg_uni_out_off_car%TYPE
    ) IS
    
    BEGIN
    
        SELECT drd.flg_uni_out_off_car
          INTO o_flg_off_car
          FROM drug_req_det drd
         INNER JOIN drug_req_supply drs
            ON (drd.id_drug_req_det = drs.id_drug_req_det)
         WHERE drs.id_drug_req_supply = i_id_drug_req_supply;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_flg_off_car;

    /********************************************************************************************
    * alert.pk_pharmacy.get_prof_presc_4rejected  
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_ID_EPISODE                    IN        NUMBER(24)
    * @param  O_ERROR                         OUT       ALERT.T_ERROR_OUT
    *
    * @return ALERT.TABLE_NUMBER
    *
    * @author Pedro Miranda
    * @version  2.5.1.3
    * @since  2010-12-10
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_prof_presc_4rejected
    (
        i_lang       IN language.id_language%TYPE,
        i_prof       IN alert.profissional,
        i_id_episode IN episode.id_episode%TYPE
    ) RETURN table_number IS
    
        l_req_type drug_req.flg_type%TYPE;
        l_id_prof  table_number;
    BEGIN
        g_error := 'GET_PROF_REQUEST';
    
        SELECT dp.id_professional
          BULK COLLECT
          INTO l_id_prof
          FROM drug_presc_det dpd
         INNER JOIN drug_prescription dp
            ON (dpd.id_drug_prescription = dp.id_drug_prescription)
         WHERE dpd.id_drug_presc_det IN
               (SELECT dr.id_drug_presc_det
                  FROM drug_req dr
                 INNER JOIN drug_req_det drd
                    ON (dr.id_drug_req = drd.id_drug_req)
                 WHERE dr.id_episode = i_id_episode
                   AND drd.id_state = get_state_for_req_type(i_prof, dr.flg_type, g_drd_rejected_st));
    
        RETURN l_id_prof;
    
    EXCEPTION
        WHEN OTHERS THEN
            RETURN NULL;
    END get_prof_presc_4rejected;

    /********************************************************************************************
    * alert.pk_pharmacy.get_car_for_presc (PIPELINED) 
    *
    * @param  I_LANG                          IN        NUMBER(6)
    * @param  I_PROF                          IN        ALERT.PROFISSIONAL
    * @param  I_ID_DRUG_PRESC_DET             IN        NUMBER(24)
    *
    * @return ALERT.T_TBL_PHARM_CARS
    *
    * @author Pedro Miranda
    * @version  2.5.1
    * @since  2011-01-13
    *
    * @notes  
    *
    ********************************************************************************************/
    FUNCTION get_car_for_presc
    (
        i_lang              IN language.id_language%TYPE,
        i_prof              IN alert.profissional,
        i_id_drug_presc_det IN drug_presc_det.id_drug_presc_det%TYPE
    ) RETURN t_tbl_pharm_cars
        PIPELINED IS
        l_db_object_name CONSTANT user_objects.object_name%TYPE := 'get_car_for_presc';
    BEGIN
    
        FOR row_i IN (SELECT drd.id_drug_req_det,
                             puc.id_car_model,
                             pucm.id_dep_clin_serv,
                             pk_pharmacy.get_car_name(drd.id_drug_req_det) car_name
                        FROM pharm_unidose_car puc
                       INNER JOIN (SELECT pucc.id_unidose_car, pucc.id_drug_req_det
                                    FROM pharm_unidose_car_content pucc
                                  UNION ALL
                                  SELECT pusc.id_unidose_car, pusc.id_drug_req_det
                                    FROM pharm_unidose_slot_content pusc) v1
                          ON (puc.id_unidose_car = v1.id_unidose_car)
                       INNER JOIN drug_req_det drd
                          ON (v1.id_drug_req_det = drd.id_drug_req_det)
                       INNER JOIN drug_req dr
                          ON (drd.id_drug_req = dr.id_drug_req)
                       INNER JOIN pharm_unidose_car_model pucm
                          ON (puc.id_car_model = pucm.id_unidose_car_model)
                       WHERE dr.id_drug_presc_det = i_id_drug_presc_det)
        LOOP
            PIPE ROW(t_rec_pharm_cars(row_i.id_drug_req_det,
                                      row_i.id_car_model,
                                      row_i.id_dep_clin_serv,
                                      row_i.car_name));
        END LOOP;
    
    EXCEPTION
        WHEN OTHERS THEN
            set_pharmacy_log(l_db_object_name, 'i_id_drug_presc_det=' || i_id_drug_presc_det || '###error=' || SQLERRM);
            RAISE;
    END get_car_for_presc;

BEGIN
    --INIT LOG SYSTEM!
    pk_alertlog.log_init(g_package_name);

END pk_pharmacy;
/
