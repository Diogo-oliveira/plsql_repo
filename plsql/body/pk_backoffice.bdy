CREATE OR REPLACE PACKAGE BODY pk_backoffice AS
    k_owner        CONSTANT VARCHAR2(0200 CHAR) := 'ALERT';
    k_package_name CONSTANT VARCHAR2(0200 CHAR) := 'PK_BACKOFFICE';

    TYPE t_tab_string_token IS TABLE OF VARCHAR(20) INDEX BY BINARY_INTEGER;

    -- Private methods
    /********************************************************************************************
    * Returns the list of unavailable dep_clin_servs for a given list o combinations between 
    * clinical services and departments
    *
    * @param      i_lang                     Language identification
    * @param      i_prof                     Professional identification Array
    * @param      i_id_department_del        Identifier output
    * @param      i_id_clin_service_del      Identifier output
    * @param      o_error                    Error
    *
    * @return                                List of unavailable dep_clin_serv ids
    *
    * @author                          Rui Gomes
    * @version                         2.6.4.1.1
    * @since                           2014/08/22
    * @since                           2014/08/22
    **********************************************************************************************/
    FUNCTION get_unavail_dcs_id
    (
        i_lang                IN language.id_language%TYPE,
        i_prof                IN profissional,
        i_id_department_del   IN table_number,
        i_id_clin_service_del IN table_number,
        o_error               OUT t_error_out
    ) RETURN table_number IS
        l_temp_array table_number := table_number();
        l_dcs_del    table_number := table_number();
    BEGIN
        g_error := 'i_id_department_del (rows) ' || i_id_department_del.count;
    
        <<lup_thru_department>>
        FOR i IN 1 .. i_id_department_del.count
        LOOP
            g_error := 'Get Dcs Ids for service ' || i_id_department_del(i) || ' and speciality ' ||
                       i_id_clin_service_del(i);
            SELECT dcs.id_dep_clin_serv
              BULK COLLECT
              INTO l_temp_array
              FROM dep_clin_serv dcs
             WHERE dcs.id_department = i_id_department_del(i)
               AND dcs.id_clinical_service = i_id_clin_service_del(i)
               AND dcs.flg_available = pk_alert_constant.get_no;
        
            g_error   := 'Add New values to final array';
            l_dcs_del := l_dcs_del MULTISET UNION l_temp_array;
        
            g_error      := 'Clear auxiliar values';
            l_temp_array := table_number();
        
        END LOOP lup_thru_department;
    
        RETURN l_dcs_del;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_UNAVAIL_DCS_ID',
                                              o_error);
            RETURN table_number();
    END get_unavail_dcs_id;
    /********************************************************************************************
    * Delete Professional association with unavailable Dep_clin_serv identifiers
    *
    * @param      i_lang                     Language identification
    * @param      i_prof                     Professional identification Array
    * @param      i_id_department_del        Identifier output
    * @param      i_id_clin_service_del      Identifier output
    * @param      o_error                    Error
    *
    * @return                         true or false on success or error
    *
    * @author                          Rui Gomes
    * @version                         2.6.4.1.1
    * @since                           2014/08/22
    **********************************************************************************************/
    FUNCTION del_prof_dcs_cfg
    (
        i_lang                IN language.id_language%TYPE,
        i_prof                IN profissional,
        i_id_department_del   IN table_number,
        i_id_clin_service_del IN table_number,
        o_error               OUT t_error_out
    ) RETURN BOOLEAN IS
        l_dcs_del table_number := table_number();
    BEGIN
    
        g_error   := 'get dcs identifiers(pk)';
        l_dcs_del := get_unavail_dcs_id(i_lang, i_prof, i_id_department_del, i_id_clin_service_del, o_error);
        g_error   := l_dcs_del.count || ' to be deleted';
        FOR i IN 1 .. l_dcs_del.count
        LOOP
            g_error := 'deleting (dcs)' || l_dcs_del(i);
            DELETE FROM prof_dep_clin_serv pdcs
             WHERE pdcs.id_dep_clin_serv = l_dcs_del(i);
        END LOOP;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            dbms_output.put_line('Error: ' || o_error.log_id);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'DEL_PROF_DCS_CFG',
                                              o_error);
            RETURN FALSE;
    END del_prof_dcs_cfg;
    /********************************************************************************************
    * List professionals and respective template
    *
    * @param i_lang          Preferred language ID
    * @param i_flg_type      Professional category
    * @param i_prof_adm      Object (professional ID, institution ID, software ID)
    * @param o_list          Professionals and templates
    * @param o_error         Error
    * 
    * @value i_prof_adm      {*} 'D' Doctor {*} 'I' Nurses' {*} 'P' Pharmaceutical {*} 'X' Assistant {*} 'A' Administrative {*} 'T' Technical {*} 'S' Social Assistent
    *
    * @return                true or false on success or error
    * 
    *
    * @author                SS
    *                        (CRS 2006/03/15  User institution and software filter )
    *                        (JTS 2007/03/22  Template recognition)
    * @version               0.1
    * @since                 2005/08/18
    ********************************************************************************************/

    FUNCTION get_prof_template
    (
        i_lang     IN language.id_language%TYPE,
        i_flg_type IN profile_template.flg_type%TYPE,
        i_prof_adm IN profissional,
        o_list     OUT pk_types.cursor_type,
        o_error    OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        g_error := 'GET CURSOR';
        OPEN o_list FOR
            SELECT psi.id_professional,
                   p.name,
                   pt.intern_name_templ templ,
                   pk_sysdomain.get_domain('PROF_INSTITUTION.FLG_STATE', nvl(pi.flg_state, 'A'), i_lang) state
              FROM prof_soft_inst psi,
                   professional p,
                   prof_profile_template ppt,
                   profile_template pt,
                   prof_institution pi,
                   (SELECT *
                      FROM prof_soft_inst
                     WHERE id_professional = i_prof_adm.id) psi_prof
             WHERE psi_prof.id_professional = i_prof_adm.id
               AND psi.id_institution = psi_prof.id_institution
               AND p.id_professional = psi.id_professional
               AND nvl(p.flg_prof_test, pk_alert_constant.get_no) = pk_alert_constant.get_no
               AND ppt.id_professional = p.id_professional
               AND ppt.id_institution = psi.id_institution
               AND ppt.id_software = psi.id_software
               AND ((pt.flg_type = i_flg_type AND i_flg_type IS NOT NULL) OR i_flg_type IS NULL)
               AND pt.id_profile_template = ppt.id_profile_template
               AND pt.flg_available = 'Y'
               AND pt.id_software = psi.id_software
               AND pi.id_professional = p.id_professional
               AND pi.id_institution = psi.id_institution
            UNION
            SELECT p.id_professional,
                   p.name,
                   '' templ,
                   pk_sysdomain.get_domain('PROF_INSTITUTION.FLG_STATE', nvl(pi.flg_state, 'A'), i_lang) state
              FROM professional p,
                   prof_soft_inst psi,
                   prof_institution pi,
                   (SELECT *
                      FROM prof_soft_inst
                     WHERE id_professional = i_prof_adm.id) psi_prof
             WHERE psi_prof.id_professional = i_prof_adm.id
               AND psi.id_institution = psi_prof.id_institution
               AND psi.id_professional = p.id_professional
               AND p.id_professional NOT IN (SELECT id_professional
                                               FROM prof_profile_template
                                              WHERE id_institution = i_prof_adm.institution)
               AND pi.id_professional = p.id_professional
               AND pi.id_institution = psi.id_institution
               AND nvl(p.flg_prof_test, pk_alert_constant.get_no) = pk_alert_constant.get_no
               AND i_flg_type IS NULL
             ORDER BY id_professional, templ;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            DECLARE
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_PROF_TEMPLATE');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_types.open_my_cursor(o_list);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END;

    FUNCTION get_prof_template_det
    (
        i_lang    IN language.id_language%TYPE,
        i_id_prof IN professional.id_professional%TYPE,
        o_detail  OUT pk_types.cursor_type,
        o_error   OUT t_error_out
    ) RETURN BOOLEAN IS
        /******************************************************************************************************
           OBJECTIVO: Obter detalhe do profissional    
           PARAMETROS:  Entrada: I_LANG - Língua registada como preferência do profissional 
                       I_ID_PROF - profissional  
                Saída:   O_DETAIL - detalhe do profissional 
                     O_ERROR - erro 
          CRIAÇÃO: SS 2005/08/18  
          ALTERAÇÃO: SS 2005/11/03
            RdSN 2007/01/09 Added TITLE and SHORT_NAME value      
          NOTAS:  
        ******************************************************************************************************/
        i_prof profissional;
    BEGIN
    
        i_prof  := profissional(i_id_prof, NULL, NULL);
        g_error := 'GET CURSOR';
        OPEN o_detail FOR
            SELECT DISTINCT p.id_professional,
                            p.num_order,
                            p.nick_name,
                            p.name,
                            pk_translation.get_translation(i_lang, s.code_speciality) spec,
                            p.id_speciality,
                            to_char(p.dt_birth, 'YYYYMMDD') string_birth,
                            pk_date_utils.dt_chr(i_lang, p.dt_birth, i_prof) date_birth,
                            pk_sysdomain.get_domain('PROFESSIONAL.GENDER', p.gender, i_lang) desc_gender,
                            p.gender,
                            pk_sysdomain.get_domain('PROFESSIONAL.MARITAL_STATUS', p.marital_status, i_lang) desc_marital_status,
                            p.marital_status,
                            p.num_contact,
                            p.address,
                            p.zip_code,
                            p.city,
                            p.district,
                            pk_translation.get_translation(i_lang, c.code_country) countr,
                            p.id_country,
                            pk_date_utils.dt_chr(i_lang, p.adw_last_update, i_prof) date_creation,
                            p.title flg_title,
                            p.short_name,
                            get_prof_title_desc(i_lang, p.title) title
              FROM professional p, speciality s, country c
             WHERE p.id_professional = i_id_prof
               AND p.id_country = c.id_country(+)
               AND p.id_speciality = s.id_speciality(+)
               AND nvl(p.flg_prof_test, pk_alert_constant.get_no) = pk_alert_constant.get_no;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_lang     => i_lang,
                                              i_sqlcode  => SQLCODE,
                                              i_sqlerrm  => SQLERRM,
                                              i_message  => g_error,
                                              i_owner    => k_owner,
                                              i_package  => k_package_name,
                                              i_function => 'GET_PROF_TEMPLATE_DET',
                                              o_error    => o_error);
            pk_types.open_my_cursor(o_detail);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END;

    /*****************************************************************************************
    * Public Function. Get Institution Type List
    *
    * @param      I_LANG                     Language identification
    * @param      o_prof_state               Cursor
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/04/17
    ******************************************************************************************/
    FUNCTION get_professional_state_list
    (
        i_lang       IN language.id_language%TYPE,
        o_prof_state OUT pk_types.cursor_type,
        o_error      OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET PROFESSIONAL STATE CURSOR';
        OPEN o_prof_state FOR
            SELECT val, desc_val, img_name icon
              FROM sys_domain
             WHERE code_domain = 'PROF_INSTITUTION.FLG_STATE'
               AND flg_available = g_flg_available
               AND domain_owner = pk_sysdomain.k_default_schema
               AND id_language = i_lang
             ORDER BY rank;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_PROFESSIONAL_STATE_LIST');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_types.open_my_cursor(o_prof_state);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_professional_state_list;

    FUNCTION get_institution_list
    (
        i_lang     IN language.id_language%TYPE,
        i_prof_adm IN profissional,
        o_list     OUT pk_types.cursor_type,
        o_error    OUT t_error_out
    ) RETURN BOOLEAN IS
        /******************************************************************************************************
           OBJECTIVO: Obter listagem das instituições para as quais o Administrador est?parametrizado.      
           PARAMETROS:  Entrada: I_LANG - Língua registada como preferência do profissional 
                       I_PROF_ADM - ID, instituição e software do Administrador    
                Saída:   O_LIST - listagem 
                     O_ERROR - erro 
          CRIAÇÃO: SS 2005/11/03 
          NOTAS:  
        ******************************************************************************************************/
    
    BEGIN
    
        g_error := 'GET CURSOR';
        OPEN o_list FOR
            SELECT pi.id_institution, pk_translation.get_translation(i_lang, i.code_institution) desc_institution
              FROM prof_institution pi, institution i
             WHERE pi.id_professional = i_prof_adm.id
               AND pi.flg_state = g_active
               AND i.id_institution = pi.id_institution
               AND i.flg_available = g_flg_avail
             ORDER BY desc_institution;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_INSTITUTION_LIST');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_types.open_my_cursor(o_list);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END;

    FUNCTION get_software_list
    (
        i_lang  IN language.id_language%TYPE,
        i_inst  IN institution.id_institution%TYPE,
        o_list  OUT pk_types.cursor_type,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
        /******************************************************************************************************
           OBJECTIVO: Obter listagem das aplicações existentes na instituição       
           PARAMETROS:  Entrada: I_LANG - Língua registada como preferência do profissional 
                       I_INST - ID da instituição   
                Saída:   O_LIST - listagem 
                     O_ERROR - erro 
          CRIAÇÃO: SS 2005/11/03 
          NOTAS:  
        ******************************************************************************************************/
    
    BEGIN
    
        g_error := 'GET CURSOR';
        OPEN o_list FOR
            SELECT s.id_software id,
                   s.name name,
                   'HandSelectedIcon' flg_icon,
                   decode((SELECT s1.id_software
                            FROM software s1, software_institution si1
                           WHERE si1.id_institution = i_inst
                             AND s1.id_software = si1.id_software
                             AND s1.id_software = s.id_software),
                          NULL,
                          'I',
                          'A') flg_status
              FROM software s
             WHERE s.flg_mni = g_flg_avail
               AND s.flg_viewer = 'N'
               AND s.id_software != 26
             ORDER BY name;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_SOFTWARE_LIST');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_types.open_my_cursor(o_list);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END;

    FUNCTION get_prof_institution
    (
        i_lang           IN language.id_language%TYPE,
        i_id_prof        IN professional.id_professional%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        o_info           OUT pk_types.cursor_type,
        o_dep            OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
        /******************************************************************************************************
           OBJECTIVO: Obter detalhe do profissional  
           PARAMETROS:  Entrada: I_LANG - Língua registada como preferência do profissional 
                   I_ID_PROF - ID do profissional 
                 I_ID_INSTITUTION - ID da instituição: se for NULL, retorna tudo.
                                    
                Saída:   O_INFO - info sobre categoria, num_mecan, língua e estado    
                     O_DEP - departamentos da instituição escolhida       
                     O_ERROR - erro 
          CRIAÇÃO: SS 2005/11/03   
          NOTAS:  
        ******************************************************************************************************/
    BEGIN
    
        g_error := 'GET CURSOR O_INFO';
        OPEN o_info FOR
            SELECT DISTINCT pi.id_institution,
                            pk_translation.get_translation(i_lang, i.code_institution) desc_instit,
                            pc.id_category,
                            pk_translation.get_translation(i_lang, c.code_category) desc_cat,
                            pc.id_category_sub,
                            pk_translation.get_translation(i_lang, cs.code_category_sub) desc_cat_sub,
                            pp.id_language,
                            l.desc_language,
                            pi.num_mecan,
                            pi.flg_state,
                            pk_sysdomain.get_domain('PROF_INSTITUTION.FLG_STATE', pi.flg_state, i_lang) desc_state,
                            prof.num_order
              FROM prof_institution pi,
                   institution      i,
                   prof_cat         pc,
                   category         c,
                   prof_preferences pp,
                   LANGUAGE         l,
                   category_sub     cs,
                   professional     prof
             WHERE pi.id_professional = i_id_prof
               AND prof.id_professional = pi.id_professional
               AND nvl(prof.flg_prof_test, pk_alert_constant.get_no) = pk_alert_constant.get_no
               AND pi.id_institution LIKE nvl(to_char(i_id_institution), '%')
               AND i.id_institution = pi.id_institution
               AND i.flg_available = g_flg_avail
               AND pc.id_professional = i_id_prof
               AND pc.id_institution LIKE nvl(to_char(i_id_institution), '%')
               AND pc.id_category = c.id_category
               AND pp.id_professional = i_id_prof
               AND pp.id_institution LIKE nvl(to_char(i_id_institution), '%')
               AND pp.id_language = l.id_language
               AND pc.id_category_sub = cs.id_category_sub(+);
    
        g_error := 'GET CURSOR O_DEP';
        OPEN o_dep FOR
            SELECT d.id_dept, pk_translation.get_translation(i_lang, d.code_dept) desc_dep
              FROM dept d
             WHERE d.id_institution = i_id_institution
               AND d.flg_available = g_flg_available
             ORDER BY desc_dep;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_PROF_INSTITUTION');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END;

    FUNCTION get_prof_clin_serv
    (
        i_lang    IN language.id_language%TYPE,
        i_id_prof IN professional.id_professional%TYPE,
        i_id_dep  IN department.id_department%TYPE,
        o_dcs     OUT pk_types.cursor_type,
        o_error   OUT t_error_out
    ) RETURN BOOLEAN IS
        /******************************************************************************************************
           OBJECTIVO: Obter serviços clínicos do profissional    
           PARAMETROS:  Entrada: I_LANG - Língua registada como preferência do profissional 
                       I_ID_PROF - ID do profissional 
                     I_ID_DEP - ID do departamento  
                Saída:   O_DCS - serviços clínicos          
                     O_ERROR - erro 
          CRIAÇÃO: SS 2005/11/03   
          NOTAS:  JS (2006-12-15): Retorna o id_funcionality (sys_functionality) associado ao profissional/dep_clin_serv
              JS (2006-12-15): Adicionei o distinct
              JS (2007-05-28): O sub query que retorna a funcionalidade est?fixo com valor 4 porque actualmente
              s?o software P1 usa funcionalidade por dep_clin_serv. Sedr?corrigido na próxima versão do backoffice,
              esta função dever?passar a ter o id_software nos parametros de entrada.
        ******************************************************************************************************/
    BEGIN
    
        g_error := 'GET CURSOR O_DCS';
        OPEN o_dcs FOR
            SELECT DISTINCT id_dep_clin_serv, desc_clin_serv, flg_select, id_functionality
              FROM (SELECT dcs.id_dep_clin_serv,
                           pk_translation.get_translation(i_lang, cs.code_clinical_service) desc_clin_serv,
                           decode(pdcs.id_dep_clin_serv, NULL, 'N', 'Y') flg_select,
                           (SELECT pf.id_functionality
                              FROM prof_func pf, sys_functionality sf
                             WHERE pf.id_professional = pdcs.id_professional
                               AND pf.id_dep_clin_serv = dcs.id_dep_clin_serv
                               AND sf.id_functionality = pf.id_functionality
                               AND sf.id_software = 4) id_functionality
                      FROM clinical_service cs, dep_clin_serv dcs, prof_dep_clin_serv pdcs
                     WHERE pdcs.id_professional(+) = i_id_prof
                       AND pdcs.id_dep_clin_serv(+) = dcs.id_dep_clin_serv
                       AND dcs.id_department = i_id_dep
                       AND dcs.id_clinical_service = cs.id_clinical_service
                       AND dcs.flg_available = g_flg_available
                       AND cs.flg_available = pk_alert_constant.g_available)
             WHERE desc_clin_serv IS NOT NULL
             ORDER BY desc_clin_serv;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_dcs);
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_PROF_CLIN_SERV');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            
            END;
        
    END;

    FUNCTION set_prof_institution
    (
        i_lang             IN language.id_language%TYPE,
        i_id_prof          IN professional.id_professional%TYPE,
        i_id_institution   IN institution.id_institution%TYPE,
        i_id_cat           IN category.id_category%TYPE,
        i_num_mecan        IN prof_institution.num_mecan%TYPE,
        i_id_language      IN language.id_language%TYPE,
        i_state            IN prof_institution.flg_state%TYPE,
        i_id_dep_clin_serv IN table_number,
        i_flg              IN table_varchar,
        i_cat_sub          IN category_sub.id_category_sub%TYPE,
        i_num_order        IN professional.num_order%TYPE,
        o_error            OUT t_error_out
    ) RETURN BOOLEAN IS
        /************************************************************************************************* 
           OBJECTIVO:   Registar info do profissional 
           PARAMETROS:  Entrada: I_LANG - Língua registada como preferência do profissional 
                       I_ID_PROF - ID do profissional. 
                     I_ID_INSTITUTION - instituição  
                     I_ID_CAT - categoria   
                     I_NUM_MECAN - num mecanográfico  
                     I_ID_LANGUAGE - língua   
                     I_STATE - estado                
                     I_ID_DEP_CLIN_SERV - departamentos e serviços clínicos 
                     I_FLG - array com indicação se ?SELECCIONADO (Y) ou ELIMINADO(N)  
                                             I_CAT_SUB - Categoria do profissional no bloco operatório               
                  Saida:   O_ERROR - erro 
          CRIAÇÃO: SS 2005/11/03  
          ALTERAÇÃO: CRS 2006/06/23 Mapeamento dos médicos para Sonho 
              RdSN 2006/12/21 Introdução da actualização do NUM_ORDER neste ecr?
          NOTAS: 
        ***************************************************************************************************/
        CURSOR c_cat IS
            SELECT cat.id_category, cat.flg_type, pc.id_category_sub
              FROM prof_cat pc, category cat
             WHERE pc.id_professional = i_id_prof
               AND pc.id_institution = i_id_institution
               AND cat.id_category = pc.id_category;
    
        CURSOR c_inst IS
            SELECT p_inst.id_prof_institution
              FROM (SELECT x.*
                      FROM prof_institution x
                     WHERE x.id_institution = i_id_institution
                       AND x.id_professional = i_id_prof
                     ORDER BY x.dt_end_tstz DESC) p_inst
             WHERE rownum = 1;
    
        CURSOR c_pref IS
            SELECT 'X'
              FROM prof_preferences pp
             WHERE pp.id_professional = i_id_prof
               AND pp.id_institution = i_id_institution;
    
        CURSOR c_prof IS
            SELECT num_order
              FROM professional
             WHERE id_professional = i_id_prof
               AND nvl(num_order, '0') != '0';
    
        CURSOR c_inst_type IS
            SELECT i.flg_type
              FROM institution i
             WHERE i.id_institution = i_id_institution;
    
        CURSOR c_pdcs(x dep_clin_serv.id_dep_clin_serv%TYPE) IS
            SELECT 'X'
              FROM prof_dep_clin_serv pdcs
             WHERE pdcs.id_professional = i_id_prof
               AND pdcs.id_dep_clin_serv = x;
    
        l_cat       category.id_category%TYPE;
        l_inst      prof_institution.id_prof_institution%TYPE := NULL;
        l_pref      VARCHAR2(1);
        l_software  software_institution.id_software%TYPE;
        l_type      category.flg_type%TYPE;
        l_num_order professional.num_order%TYPE;
        l_cat_sub   prof_cat.id_category_sub%TYPE;
    
        l_inst_type VARCHAR2(1);
    
        l_pdcs VARCHAR2(1);
    
        l_rowids table_varchar;
    
        -- core tables new params
        l_soft_inst_pk     ab_soft_inst_user_info.id_ab_software_institution%TYPE := 0;
        l_role_sw_inst_pk  ab_soft_inst_user_info.id_ab_software_inst_role%TYPE := 0;
        l_role_id          ab_soft_inst_user_info.id_ab_role%TYPE := 0;
        l_comp_id          VARCHAR2(200) := '';
        l_prof_institution NUMBER := 0;
        l_si_user_info     NUMBER := 0;
        l_professional_id  professional.id_professional%TYPE;
    
    BEGIN
        g_sysdate := SYSDATE;
    
        g_error := 'OPEN C_CAT';
        OPEN c_cat;
        FETCH c_cat
            INTO l_cat, l_type, l_cat_sub;
        g_found := c_cat%NOTFOUND;
        CLOSE c_cat;
    
        IF g_found
        THEN
            g_error := 'INSERT INTO PROF_CAT';
            INSERT INTO prof_cat
                (id_prof_cat, id_professional, id_category, id_institution, id_category_sub)
            VALUES
                (seq_prof_cat.nextval, i_id_prof, i_id_cat, i_id_institution, i_cat_sub);
        ELSE
            g_error := 'UPDATE PROF_CAT';
            UPDATE prof_cat
               SET id_category = i_id_cat, id_category_sub = i_cat_sub
             WHERE id_professional = i_id_prof
               AND id_institution = i_id_institution;
        END IF;
    
        g_error := 'OPEN C_CAT(2)';
        OPEN c_cat;
        FETCH c_cat
            INTO l_cat, l_type, l_cat_sub;
        CLOSE c_cat;
    
        g_error := 'OPEN C_PROF';
        OPEN c_prof;
        FETCH c_prof
            INTO l_num_order;
        g_found := c_prof%NOTFOUND;
        CLOSE c_prof;
    
        IF l_type = g_cat_type_doc
        THEN
            IF g_found
            THEN
                NULL;
            ELSE
            
                g_error := 'GET CURSOR C_INST_TYPE';
                OPEN c_inst_type;
                FETCH c_inst_type
                    INTO l_inst_type;
                CLOSE c_inst_type;
            END IF;
        
        ELSE
            IF NOT g_found
            THEN
                NULL;
            END IF;
        END IF;
    
        OPEN c_inst;
        FETCH c_inst
            INTO l_inst;
        g_found := c_inst%NOTFOUND;
        CLOSE c_inst;
    
        -- INSTITUTION
        pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_inst,
                                                       i_id_professional     => i_id_prof,
                                                       i_id_institution      => i_id_institution,
                                                       i_flg_state           => i_state,
                                                       i_num_mecan           => i_num_mecan,
                                                       i_dt_begin_tstz       => current_timestamp,
                                                       o_id_prof_institution => l_prof_institution);
    
        g_error := 'REMOVE PROFESSIONAL MEC NUMBER';
        IF i_num_mecan IS NULL
        THEN
            pk_api_ab_tables.remove_prof_inst_num_mec(i_id_prof_inst => l_prof_institution);
        END IF;
    
        -- Miss ab_user_info!!!!!!
        g_error := 'UPDATE PROFESSIONAL';
        pk_api_ab_tables.upd_ins_into_ab_user_info(i_id_ab_user_info    => i_id_prof,
                                                   i_login              => NULL,
                                                   i_password           => NULL,
                                                   i_import_code        => NULL,
                                                   i_record_status      => i_state,
                                                   i_institution_key    => i_id_institution,
                                                   i_flg_is_enable      => i_state,
                                                   i_first_name         => NULL,
                                                   i_last_name          => NULL,
                                                   i_full_name          => NULL,
                                                   i_external_system    => NULL,
                                                   i_external_system_id => NULL,
                                                   i_secret_quest       => NULL,
                                                   i_secret_answ        => NULL,
                                                   i_id_language        => NULL,
                                                   i_flg_temporary      => 'N',
                                                   i_date_creation_tstz => NULL,
                                                   o_id_ab_user_info    => l_professional_id);
        UPDATE professional
           SET flg_state = i_state, num_order = i_num_order
         WHERE id_professional = i_id_prof;
    
        g_error := 'SET PROFESSIONAL HISTORY';
        ins_professional_hist(i_id_professional => i_id_prof, i_operation_type => g_prof_hist_oper_u);
    
        g_error := 'GET SOFTWARE_INSTITUTION ID';
        SELECT nvl((SELECT si.id_software_institution
                     FROM software_institution si
                    WHERE si.id_software = l_software
                      AND si.id_institution = i_id_institution),
                   0)
          INTO l_soft_inst_pk
          FROM dual;
        g_error := 'GET DEFAULT COMPONENT ID';
        pk_api_ab_tables.get_component_from_si(profissional(0, i_id_institution, l_software), l_comp_id);
        g_error := 'SET PROFESSIONAL CONFIGURATION (PROF_PREFERENCES)';
        pk_api_ab_tables.upd_ins_into_ab_sw_ins_usr_inf(i_prof                       => profissional(i_id_prof,
                                                                                                     i_id_institution,
                                                                                                     l_software),
                                                        i_id_ab_soft_inst_user_info  => NULL,
                                                        i_import_code                => NULL,
                                                        i_record_status              => 'A',
                                                        i_id_ab_software_institution => l_soft_inst_pk,
                                                        i_id_ab_software_inst_role   => l_role_sw_inst_pk,
                                                        i_id_ab_institution          => i_id_institution,
                                                        i_id_ab_software             => l_software,
                                                        i_id_ab_user_info            => i_id_prof,
                                                        i_id_ab_role                 => l_role_id,
                                                        i_id_ab_component            => to_number(l_comp_id),
                                                        i_id_ab_language             => i_id_language,
                                                        i_flg_log                    => NULL,
                                                        i_id_department              => NULL,
                                                        i_dt_log_tstz                => NULL,
                                                        i_timeout                    => NULL,
                                                        i_first_screen               => NULL,
                                                        o_id_ab_soft_inst_user_info  => l_si_user_info);
    
        -- LANGUAGE                  
        FOR i IN 1 .. i_id_dep_clin_serv.count
        LOOP
        
            IF i_flg(i) = 'N'
            THEN
                g_error := 'DELETE PROF_DEP_CLIN_SERV';
            
                ts_prof_dep_clin_serv.del_pdcs_prf_dcs_i(id_professional_in  => i_id_prof,
                                                         id_dep_clin_serv_in => i_id_dep_clin_serv(i));
            
            ELSE
                OPEN c_pdcs(i_id_dep_clin_serv(i));
                FETCH c_pdcs
                    INTO l_pdcs;
                g_found := c_pdcs%FOUND;
                CLOSE c_pdcs;
            
                IF NOT g_found
                THEN
                    g_error := 'INSERT INTO PROF_DEP_CLIN_SERV';
                
                    SELECT id_software
                      INTO l_software
                      FROM dep_clin_serv dcs, department d
                     WHERE d.id_department = dcs.id_department
                       AND d.id_institution = i_id_institution
                       AND dcs.id_dep_clin_serv = i_id_dep_clin_serv(i);
                
                    ts_prof_dep_clin_serv.ins(id_prof_dep_clin_serv_in => ts_prof_dep_clin_serv.next_key,
                                              id_professional_in       => i_id_prof,
                                              id_dep_clin_serv_in      => i_id_dep_clin_serv(i),
                                              flg_status_in            => g_status_pdcs_s,
                                              flg_default_in           => 'N',
                                              id_institution_in        => i_id_institution,
                                              dt_creation_in           => current_timestamp,
                                              rows_out                 => l_rowids);
                
                END IF;
            END IF;
        
        END LOOP;
    
        COMMIT;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
            
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'SET_PROF_INSTITUTION');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END;

    /********************************************************************************************
    * Set Institution Professional state
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_professional       Professional ID
    * @param i_id_institution        Institution ID
    * @param i_flg_state             Professional state
    * @param i_num_mecan             Mecan. Number
    * @param o_flg_state             Professional state
    * @param o_icon                  Professional state icon
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      JTS
    * @version                     0.1
    * @since                       2008/06/02
    ********************************************************************************************/
    FUNCTION set_prof_institution_state
    (
        i_lang            IN language.id_language%TYPE,
        i_id_professional IN prof_institution.id_professional%TYPE,
        i_id_institution  IN prof_institution.id_institution%TYPE,
        i_flg_state       IN prof_institution.flg_state%TYPE,
        i_num_mecan       IN prof_institution.num_mecan%TYPE,
        o_flg_state       OUT prof_institution.flg_state%TYPE,
        o_icon            OUT VARCHAR2,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_state               prof_institution.flg_state%TYPE;
        l_id_prof_institution prof_institution.id_prof_institution%TYPE;
        l_num_mecano          prof_institution.num_mecan%TYPE;
        l_dt_end_tstz         TIMESTAMP(6) WITH LOCAL TIME ZONE;
    
    BEGIN
    
        g_error := 'GET PROF_INSTITUTION STATE';
        SELECT decode((SELECT COUNT(pi.flg_state)
                        FROM prof_institution pi
                       WHERE pi.id_institution = i_id_institution
                         AND pi.id_professional = i_id_professional
                         AND pi.dt_end_tstz IS NULL),
                      0,
                      (SELECT pi.flg_state
                         FROM prof_institution pi
                        WHERE pi.id_professional = i_id_professional
                          AND pi.id_institution = i_id_institution
                          AND pi.dt_end_tstz = (SELECT MAX(pi2.dt_end_tstz)
                                                  FROM prof_institution pi2
                                                 WHERE pi2.id_institution = i_id_institution
                                                   AND pi2.id_professional = i_id_professional)),
                      (SELECT pi.flg_state
                         FROM prof_institution pi
                        WHERE pi.id_institution = i_id_institution
                          AND pi.id_professional = i_id_professional
                          AND pi.dt_end_tstz IS NULL))
          INTO l_state
          FROM dual;
        g_error := 'GET PROF_INSTITUTION PK';
        BEGIN
            SELECT pi.id_prof_institution
              INTO l_id_prof_institution
              FROM prof_institution pi
             WHERE pi.id_professional = i_id_professional
               AND pi.id_institution = i_id_institution
               AND pi.flg_state = l_state
               AND pi.dt_end_tstz IS NULL;
        EXCEPTION
            WHEN no_data_found THEN
                l_id_prof_institution := NULL;
        END;
        IF i_flg_state = 'A'
           AND l_state != 'A'
        THEN
        
            g_error := 'UPDATE PROF_INSTITUTION';
            --
            pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_id_prof_institution,
                                                           i_id_professional     => i_id_professional,
                                                           i_id_institution      => i_id_institution,
                                                           i_flg_state           => l_state,
                                                           i_dt_end_tstz         => g_sysdate_tstz,
                                                           o_id_prof_institution => l_id_prof_institution);
        
            g_error := 'INSERT INTO PROF_INSTITUTION';
            pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                           i_id_professional     => i_id_professional,
                                                           i_id_institution      => i_id_institution,
                                                           i_flg_state           => i_flg_state,
                                                           i_num_mecan           => i_num_mecan,
                                                           i_dt_begin_tstz       => g_sysdate_tstz,
                                                           o_id_prof_institution => l_id_prof_institution);
        
        ELSIF i_flg_state = 'A'
              AND l_state = 'A'
        THEN
            g_error := 'GET PROF_INSTITUTION PK';
            BEGIN
                SELECT pi.id_prof_institution
                  INTO l_id_prof_institution
                  FROM prof_institution pi
                 WHERE pi.id_professional = i_id_professional
                   AND pi.id_institution = i_id_institution
                   AND pi.flg_state = i_flg_state
                   AND pi.dt_end_tstz IS NULL;
            EXCEPTION
                WHEN no_data_found THEN
                    l_id_prof_institution := NULL;
            END;
            g_error := 'GET PROF_INSTITUTION NUM_MECAN';
            SELECT decode((SELECT pi.num_mecan
                          
                            FROM prof_institution pi
                           WHERE pi.id_professional = i_id_professional
                             AND pi.id_institution = i_id_institution
                             AND pi.flg_state = i_flg_state
                             AND pi.dt_end_tstz IS NULL),
                          
                          NULL,
                          NULL,
                          (SELECT pi.num_mecan
                           
                             FROM prof_institution pi
                            WHERE pi.id_professional = i_id_professional
                              AND pi.id_institution = i_id_institution
                              AND pi.flg_state = i_flg_state
                              AND pi.dt_end_tstz IS NULL))
              INTO l_num_mecano
              FROM dual;
        
            IF l_num_mecano != i_num_mecan
            THEN
                g_error := 'UPDATE PROF_INSTITUTION';
                pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_id_prof_institution,
                                                               i_id_professional     => i_id_professional,
                                                               i_id_institution      => i_id_institution,
                                                               i_flg_state           => i_flg_state,
                                                               i_dt_end_tstz         => g_sysdate_tstz,
                                                               o_id_prof_institution => l_id_prof_institution);
            
                g_error := 'INSERT INTO PROF_INSTITUTION';
                pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                               i_id_professional     => i_id_professional,
                                                               i_id_institution      => i_id_institution,
                                                               i_flg_state           => i_flg_state,
                                                               i_num_mecan           => i_num_mecan,
                                                               i_dt_begin_tstz       => g_sysdate_tstz,
                                                               o_id_prof_institution => l_id_prof_institution);
            
            END IF;
        
        ELSIF (i_flg_state = 'I' OR i_flg_state = 'S')
        THEN
        
            IF l_state = 'A'
            THEN
                g_error := 'GET PROF_INSTITUTION PK';
                BEGIN
                    SELECT pi.id_prof_institution
                      INTO l_id_prof_institution
                      FROM prof_institution pi
                     WHERE pi.id_professional = i_id_professional
                       AND pi.id_institution = i_id_institution
                       AND pi.flg_state = g_status_a
                       AND pi.dt_end_tstz IS NULL;
                EXCEPTION
                    WHEN no_data_found THEN
                        l_id_prof_institution := NULL;
                END;
                g_error := 'UPDATE PROF_INSTITUTION';
                pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_id_prof_institution,
                                                               i_id_professional     => i_id_professional,
                                                               i_id_institution      => i_id_institution,
                                                               i_flg_state           => g_status_a,
                                                               i_dt_end_tstz         => g_sysdate_tstz,
                                                               o_id_prof_institution => l_id_prof_institution);
            
                g_error := 'INSERT INTO PROF_INSTITUTION';
                pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                               i_id_professional     => i_id_professional,
                                                               i_id_institution      => i_id_institution,
                                                               i_flg_state           => i_flg_state,
                                                               i_num_mecan           => i_num_mecan,
                                                               i_dt_begin_tstz       => g_sysdate_tstz,
                                                               o_id_prof_institution => l_id_prof_institution);
            
            ELSE
            
                IF i_flg_state = l_state
                THEN
                    g_error := 'GET PROF_INSTITUTION PK';
                    BEGIN
                        SELECT pi.id_prof_institution
                          INTO l_id_prof_institution
                          FROM prof_institution pi
                         WHERE pi.id_professional = i_id_professional
                           AND pi.id_institution = i_id_institution
                           AND pi.flg_state = i_flg_state
                           AND pi.dt_end_tstz IS NULL;
                    EXCEPTION
                        WHEN no_data_found THEN
                            l_id_prof_institution := NULL;
                    END;
                    SELECT decode((SELECT MAX(pi.dt_end_tstz)
                                    FROM prof_institution pi
                                   WHERE pi.id_professional = i_id_professional
                                     AND pi.id_institution = i_id_institution
                                     AND pi.flg_state = i_flg_state),
                                  NULL,
                                  NULL,
                                  (SELECT MAX(pi.dt_end_tstz)
                                     FROM prof_institution pi
                                    WHERE pi.id_professional = i_id_professional
                                      AND pi.id_institution = i_id_institution
                                      AND pi.flg_state = i_flg_state))
                      INTO l_dt_end_tstz
                      FROM dual;
                
                    IF l_dt_end_tstz IS NULL
                    THEN
                    
                        g_error := 'GET PROF_INSTITUTION NUM_MECAN';
                        SELECT decode((SELECT pi.num_mecan
                                      
                                        FROM prof_institution pi
                                       WHERE pi.id_professional = i_id_professional
                                         AND pi.id_institution = i_id_institution
                                         AND pi.flg_state = i_flg_state
                                         AND pi.dt_end_tstz IS NULL),
                                      
                                      NULL,
                                      NULL,
                                      (SELECT pi.num_mecan
                                       
                                         FROM prof_institution pi
                                        WHERE pi.id_professional = i_id_professional
                                          AND pi.id_institution = i_id_institution
                                          AND pi.flg_state = i_flg_state
                                          AND pi.dt_end_tstz IS NULL))
                          INTO l_num_mecano
                          FROM dual;
                    
                        IF l_num_mecano != i_num_mecan
                        THEN
                            g_error := 'UPDATE PROF_INSTITUTION';
                            pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_id_prof_institution,
                                                                           i_id_professional     => i_id_professional,
                                                                           i_id_institution      => i_id_institution,
                                                                           i_flg_state           => i_flg_state,
                                                                           i_dt_end_tstz         => g_sysdate_tstz,
                                                                           o_id_prof_institution => l_id_prof_institution);
                        
                            g_error := 'INSERT INTO PROF_INSTITUTION';
                            pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                                           i_id_professional     => i_id_professional,
                                                                           i_id_institution      => i_id_institution,
                                                                           i_flg_state           => i_flg_state,
                                                                           i_num_mecan           => i_num_mecan,
                                                                           i_dt_begin_tstz       => g_sysdate_tstz,
                                                                           o_id_prof_institution => l_id_prof_institution);
                        END IF;
                    ELSE
                        g_error := 'GET PROF_INSTITUTION PK';
                        BEGIN
                            SELECT pi.id_prof_institution
                              INTO l_id_prof_institution
                              FROM prof_institution pi
                             WHERE pi.id_professional = i_id_professional
                               AND pi.id_institution = i_id_institution
                               AND pi.flg_state = l_state
                               AND pi.dt_end_tstz IS NULL;
                        EXCEPTION
                            WHEN no_data_found THEN
                                l_id_prof_institution := NULL;
                        END;
                        g_error := 'GET PROF_INSTITUTION NUM_MECAN';
                        SELECT decode((SELECT pi.num_mecan
                                      
                                        FROM prof_institution pi
                                       WHERE pi.id_professional = i_id_professional
                                         AND pi.id_institution = i_id_institution
                                         AND pi.flg_state = i_flg_state
                                         AND pi.dt_end_tstz = l_dt_end_tstz),
                                      
                                      NULL,
                                      NULL,
                                      (SELECT pi.num_mecan
                                       
                                         FROM prof_institution pi
                                        WHERE pi.id_professional = i_id_professional
                                          AND pi.id_institution = i_id_institution
                                          AND pi.flg_state = i_flg_state
                                          AND pi.dt_end_tstz = l_dt_end_tstz))
                          INTO l_num_mecano
                          FROM dual;
                    
                        IF l_num_mecano != i_num_mecan
                        THEN
                            g_error := 'UPDATE PROF_INSTITUTION';
                            pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_id_prof_institution,
                                                                           i_id_professional     => i_id_professional,
                                                                           i_id_institution      => i_id_institution,
                                                                           i_flg_state           => i_flg_state,
                                                                           i_dt_end_tstz         => g_sysdate_tstz,
                                                                           o_id_prof_institution => l_id_prof_institution);
                        
                            g_error := 'INSERT INTO PROF_INSTITUTION';
                            pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                                           i_id_professional     => i_id_professional,
                                                                           i_id_institution      => i_id_institution,
                                                                           i_flg_state           => i_flg_state,
                                                                           i_num_mecan           => i_num_mecan,
                                                                           i_dt_begin_tstz       => g_sysdate_tstz,
                                                                           o_id_prof_institution => l_id_prof_institution);
                        
                        END IF;
                    
                    END IF;
                
                ELSE
                    g_error := 'UPDATE PROF_INSTITUTION';
                    pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_id_prof_institution,
                                                                   i_id_professional     => i_id_professional,
                                                                   i_id_institution      => i_id_institution,
                                                                   i_flg_state           => l_state,
                                                                   i_dt_end_tstz         => g_sysdate_tstz,
                                                                   o_id_prof_institution => l_id_prof_institution);
                
                    g_error := 'INSERT INTO PROF_INSTITUTION';
                    pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                                   i_id_professional     => i_id_professional,
                                                                   i_id_institution      => i_id_institution,
                                                                   i_flg_state           => i_flg_state,
                                                                   i_num_mecan           => i_num_mecan,
                                                                   i_dt_begin_tstz       => g_sysdate_tstz,
                                                                   o_id_prof_institution => l_id_prof_institution);
                
                END IF;
            
            END IF;
        
        END IF;
        g_error := 'REMOVE PROFESSIONAL MEC NUMBER';
        IF i_num_mecan IS NULL
        THEN
            pk_api_ab_tables.remove_prof_inst_num_mec(i_id_prof_inst => l_id_prof_institution);
        END IF;
    
        o_flg_state := i_flg_state;
        o_icon      := pk_sysdomain.get_img(i_lang, 'PROF_INSTITUTION.FLG_STATE', o_flg_state);
    
        COMMIT;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'SET_PROF_INSTITUTION_STATE');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
            
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END set_prof_institution_state;

    FUNCTION get_template_list
    (
        i_lang        IN language.id_language%TYPE,
        i_id_prof     IN professional.id_professional%TYPE,
        i_inst        IN prof_profile_template.id_institution%TYPE,
        i_soft        IN prof_profile_template.id_software%TYPE,
        o_avail_templ OUT pk_types.cursor_type,
        o_sel_templ   OUT pk_types.cursor_type,
        o_error       OUT t_error_out
    ) RETURN BOOLEAN IS
        /******************************************************************************************************
           OBJECTIVO: Obter listagem dos templates disponíveis e escolhidos   
           PARAMETROS:  Entrada: I_LANG - Língua registada como preferência do profissional 
                   I_ID_PROF - ID do profissional.
                 I_INST - ID  da instituição onde o profissional tem templates 
                 I_SOFT - ID  do software onde o profissional tem templates 
                Saída:   O_AVAIL_TEMPL - listagem dos templates disponíveis para escolha 
                     O_SEL_TEMPL - listagem dos templates escolhidos pelo profissional  
                     O_ERROR - erro 
          CRIAÇÃO: SS 2005/08/19 
          NOTAS: 
        ******************************************************************************************************/
        l_instit prof_institution.id_institution%TYPE;
        CURSOR c_inst IS
            SELECT id_institution
              FROM prof_institution
             WHERE id_professional = i_id_prof;
    BEGIN
        g_error := 'OPEN C_INST';
        OPEN c_inst;
        FETCH c_inst
            INTO l_instit;
        CLOSE c_inst;
    
        g_error := 'GET AVAIL_TEMPL';
        OPEN o_avail_templ FOR
            SELECT pt.id_profile_template, pt.intern_name_templ
              FROM profile_template pt
             WHERE pt.id_profile_template NOT IN (SELECT ppt.id_profile_template
                                                    FROM prof_profile_template ppt
                                                   WHERE ppt.id_professional = i_id_prof
                                                     AND ppt.id_institution = l_instit)
               AND pt.flg_available = 'Y'
               AND nvl(pt.id_institution, i_inst) LIKE nvl(to_char(i_inst), '%')
             ORDER BY intern_name_templ;
    
        g_error := 'GET SEL_TEMPL';
        OPEN o_sel_templ FOR
            SELECT pt.id_profile_template, pt.intern_name_templ
              FROM profile_template pt, prof_profile_template ppt
             WHERE ppt.id_professional = i_id_prof
               AND ppt.id_profile_template = pt.id_profile_template
               AND pt.flg_available = 'Y'
               AND ppt.id_institution = l_instit
             ORDER BY intern_name_templ;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_TEMPLATE_LIST');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_types.open_my_cursor(o_avail_templ);
                pk_types.open_my_cursor(o_sel_templ);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
    END;

    FUNCTION get_template
    (
        i_lang    IN language.id_language%TYPE,
        i_id_prof IN professional.id_professional%TYPE,
        i_inst    IN prof_profile_template.id_institution%TYPE,
        i_soft    IN prof_profile_template.id_software%TYPE,
        o_templ   OUT pk_types.cursor_type,
        o_soft    OUT prof_profile_template.id_software%TYPE,
        o_error   OUT t_error_out
    ) RETURN BOOLEAN IS
        /******************************************************************************************************
           OBJECTIVO: Obter listagem dos templates disponíveis e escolhidos   
           PARAMETROS:  Entrada: I_LANG - Língua registada como preferência do profissional 
                   I_ID_PROF - ID do profissional.
                 I_INST - ID da instituição onde o profissional tem templates 
                 I_SOFT - ID do software escolhido 
                Saída:   O_TEMPL - listagem dos templates 
                 O_SOFT - ID do software escolhido 
                 O_ERROR - erro 
          CRIAÇÃO: SS 2006/06/19 
          NOTAS: 
        ******************************************************************************************************/
    
        l_profiles NUMBER(12) := 0;
    
        l_market NUMBER;
    BEGIN
        SELECT COUNT(pti.id_profile_template)
          INTO l_profiles
          FROM profile_template_inst pti
         WHERE pti.id_institution = i_inst;
    
        SELECT nvl((SELECT i.id_market
                     FROM institution i
                    WHERE i.id_institution = i_inst),
                   0)
          INTO l_market
          FROM dual;
    
        IF l_profiles = 0
        THEN
            g_error := 'GET O_TEMPL';
            OPEN o_templ FOR
                SELECT DISTINCT pt.id_profile_template,
                                decode(ptm.id_market,
                                       0,
                                       pk_message.get_message(i_lang, pt.code_profile_template),
                                       pk_message.get_message(i_lang, pt.code_profile_template) || ' (' ||
                                       pk_utils.query_to_string('SELECT pk_translation.get_translation(' || i_lang ||
                                                                ', m.code_market) 
                               FROM market m WHERE m.id_market =' ||
                                                                ptm.id_market || '',
                                                                ',') || ')') intern_name_templ,
                                decode(ppt.id_professional, NULL, 'N', 'Y') flg_selected,
                                pt.id_category
                  FROM profile_template          pt,
                       prof_profile_template     ppt,
                       profile_template_category ptc,
                       profile_template_inst     pti,
                       profile_template_market   ptm
                 WHERE ppt.id_professional(+) = i_id_prof
                   AND ppt.id_institution(+) = i_inst
                   AND ppt.id_software(+) = i_soft
                   AND ppt.id_profile_template(+) = pt.id_profile_template
                   AND pt.flg_available = 'Y'
                   AND pt.id_software = i_soft
                   AND nvl(pt.id_institution, i_inst) LIKE nvl(to_char(i_inst), '%')
                   AND pt.id_profile_template = ptc.id_profile_template
                   AND ptc.id_category = (SELECT pc.id_category
                                            FROM prof_cat pc
                                           WHERE pc.id_professional = i_id_prof
                                             AND pc.id_institution = i_inst)
                      
                   AND ptc.id_profile_template = pti.id_profile_template
                   AND pti.id_institution = 0
                   AND pt.id_profile_template = ptm.id_profile_template
                   AND ptm.id_market IN (l_market, 0)
                   AND (NOT EXISTS (SELECT 'X'
                           FROM profile_template pt2
                          WHERE pt2.id_profile_template_appr = pt.id_profile_template) OR
                        ppt.id_professional IS NOT NULL)
                 ORDER BY intern_name_templ;
        
        ELSE
            g_error := 'GET O_TEMPL';
            OPEN o_templ FOR
                SELECT DISTINCT pt.id_profile_template,
                                decode(ptm.id_market,
                                       0,
                                       pk_message.get_message(i_lang, pt.code_profile_template),
                                       pk_message.get_message(i_lang, pt.code_profile_template) || ' (' ||
                                       pk_utils.query_to_string('SELECT pk_translation.get_translation(' || i_lang ||
                                                                ', m.code_market) 
                               FROM market m WHERE m.id_market =' ||
                                                                ptm.id_market || '',
                                                                ',') || ')') intern_name_templ,
                                decode(ppt.id_professional, NULL, 'N', 'Y') flg_selected,
                                pt.id_category
                  FROM profile_template          pt,
                       prof_profile_template     ppt,
                       profile_template_category ptc,
                       profile_template_inst     pti,
                       profile_template_market   ptm
                 WHERE ppt.id_professional(+) = i_id_prof
                   AND ppt.id_institution(+) = i_inst
                   AND ppt.id_software(+) = i_soft
                   AND ppt.id_profile_template(+) = pt.id_profile_template
                   AND pt.flg_available = 'Y'
                   AND pt.id_software = i_soft
                   AND nvl(pt.id_institution, i_inst) LIKE nvl(to_char(i_inst), '%')
                   AND pt.id_profile_template = ptc.id_profile_template
                   AND ptc.id_category = (SELECT pc.id_category
                                            FROM prof_cat pc
                                           WHERE pc.id_professional = i_id_prof
                                             AND pc.id_institution = i_inst)
                      
                   AND ptc.id_profile_template = pti.id_profile_template
                   AND pti.id_institution = i_inst
                      --
                   AND ptm.id_market IN (l_market, 0)
                   AND pt.id_profile_template = ptm.id_profile_template
                   AND (NOT EXISTS (SELECT 'X'
                           FROM profile_template pt2
                          WHERE pt2.id_profile_template_appr = pt.id_profile_template) OR
                        ppt.id_professional IS NOT NULL)
                 ORDER BY intern_name_templ;
        
        END IF;
    
        o_soft := i_soft;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_templ);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_TEMPLATE',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
    END;

    FUNCTION set_template_list
    (
        i_lang             IN language.id_language%TYPE,
        i_id_prof          IN professional.id_professional%TYPE,
        i_inst             IN table_number,
        i_soft             IN table_number,
        i_id_dep_clin_serv IN dep_clin_serv.id_dep_clin_serv%TYPE,
        i_templ            IN table_number,
        i_commit_at_end    IN BOOLEAN,
        o_error            OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_error          t_error_out := NULL;
        l_prof           profissional;
        l_id_templ_assoc profile_template.id_templ_assoc%TYPE;
        l_id_software    profile_template.id_software%TYPE;
        l_exist          VARCHAR2(1);
    
        l_func VARCHAR2(200);
    
        l_prof_schedulable    NUMBER := 0;
        l_id_prof_institution prof_institution.id_prof_institution%TYPE;
    
        CURSOR c_templ
        (
            l_templ IN profile_template.id_profile_template%TYPE,
            x_inst  IN institution.id_institution%TYPE
        ) IS
            SELECT id_templ_assoc, id_software
              FROM profile_template
             WHERE id_profile_template = l_templ
               AND nvl(id_institution, x_inst) LIKE nvl(to_char(x_inst), '%');
    
        CURSOR c_del_profile(l_soft IN prof_profile_template.id_software%TYPE) IS
            SELECT pt.id_profile_template
              FROM prof_profile_template ppt, profile_template pt
             WHERE id_professional = i_id_prof
               AND pt.id_profile_template = ppt.id_profile_template
               AND ppt.id_software = l_soft
               AND ppt.id_software = pt.id_software;
    
        CURSOR c_func
        (
            l_func IN prof_func.id_functionality%TYPE,
            x_inst IN institution.id_institution%TYPE
        ) IS
            SELECT 'X'
              FROM prof_func
             WHERE id_professional = i_id_prof
               AND id_institution = x_inst
               AND id_functionality = l_func;
        my_exception EXCEPTION;
    
        l_id_languge prof_preferences.id_language%TYPE;
        -- core tables new params
        l_soft_inst_pk         ab_soft_inst_user_info.id_ab_software_institution%TYPE := NULL;
        l_role_sw_inst_pk      ab_soft_inst_user_info.id_ab_software_inst_role%TYPE := NULL;
        l_role_id              ab_soft_inst_user_info.id_ab_role%TYPE := NULL;
        l_comp_id              VARCHAR2(200) := '';
        l_si_user_info         NUMBER := 0;
        l_prof_pref_pk         prof_preferences.id_prof_preferences%TYPE := NULL;
        l_extra_sw_list        table_number := table_number();
        l_sw_list_aux          table_number := table_number();
        l_profile_template_aux table_number := table_number();
        l_prof_templ           profile_template.id_profile_template%TYPE := 0;
        l_count                NUMBER(24);
        l_id_category          category.id_category%TYPE;
        l_market               market.id_market%TYPE;
    BEGIN
        --DELETE ALL PROFILE TEMPLATES FOR USER
        FOR i IN 1 .. i_inst.count
        LOOP
            l_market               := pk_utils.get_institution_market(i_lang, i_inst(i));
            l_extra_sw_list        := table_number();
            l_sw_list_aux          := table_number();
            l_profile_template_aux := table_number();
            g_error                := 'SET PROFISSIONAL';
            l_prof                 := profissional(i_id_prof, i_inst(i), i_soft(i));
            l_id_category          := pk_prof_utils.get_id_category(i_lang => i_lang, i_prof => l_prof);
        
            g_error := 'CALL TO Pk_Access.DEL_PROF_ALERTS';
            IF NOT pk_access.del_prof_alerts(i_lang                => i_lang,
                                             i_id_prof             => l_prof,
                                             i_id_profile_template => i_templ(i),
                                             o_error               => l_error)
            THEN
                RAISE my_exception;
            
            END IF;
            IF i_templ(i) IS NULL
            THEN
                OPEN c_del_profile(i_soft(i));
                FETCH c_del_profile
                    INTO l_prof_templ;
                CLOSE c_del_profile;
                l_extra_sw_list := pk_api_ab_tables.get_dependant_sw_list(i_id_ab_institution => i_inst(i),
                                                                          i_profile_template  => table_number(l_prof_templ));
                --begin hammer
            
                SELECT ppt.id_profile_template
                  BULK COLLECT
                  INTO l_profile_template_aux
                  FROM software_institution si
                  JOIN software s
                    ON (s.id_software = si.id_software)
                  JOIN prof_profile_template ppt
                    ON (ppt.id_institution = si.id_institution AND ppt.id_software = s.id_software)
                  JOIN profile_template pt
                    ON (pt.id_profile_template = ppt.id_profile_template AND pt.flg_available = g_flg_avail AND
                       pt.id_software = s.id_software)
                  JOIN profile_template_market ptm
                    ON (ptm.id_profile_template = pt.id_profile_template)
                 WHERE ppt.id_professional = i_id_prof
                   AND si.id_institution = i_inst(i)
                   AND ppt.id_profile_template NOT IN (l_prof_templ)
                   AND (ptm.id_market = l_market OR (ptm.id_market != l_market AND ptm.id_market = 0));
            
                l_sw_list_aux := pk_api_ab_tables.get_dependant_sw_list(i_id_ab_institution => i_inst(i),
                                                                        i_profile_template  => l_profile_template_aux);
            
                FOR k IN 1 .. l_sw_list_aux.count
                LOOP
                    l_extra_sw_list := pk_utils.remove_element(l_extra_sw_list, l_sw_list_aux(k));
                END LOOP;
                --end hammer                                                                                         
            
            ELSE
                l_extra_sw_list := pk_api_ab_tables.get_dependant_sw_list(i_id_ab_institution => i_inst(i),
                                                                          i_profile_template  => table_number(i_templ(i)));
            END IF;
        
            g_error := 'DELETE PROF_SOFT_INST';
            pk_api_ab_tables.del_from_ab_sw_ins_usr_inf('id_ab_user_info = ' || i_id_prof || '
               AND id_ab_institution = ' || i_inst(i) || '
               AND id_ab_software = ' || i_soft(i));
        
            IF l_extra_sw_list.exists(1)
            THEN
                FOR a IN 1 .. l_extra_sw_list.count
                LOOP
                    g_error := 'DELETE PROF_SOFT_INST NCD SW';
                    pk_api_ab_tables.del_from_ab_sw_ins_usr_inf('id_ab_user_info = ' || i_id_prof || '
               AND id_ab_institution = ' || i_inst(i) || '
               AND id_ab_software = ' ||
                                                                l_extra_sw_list(a));
                END LOOP;
            END IF;
        
            g_error          := 'OPEN C_TEMPL';
            l_id_templ_assoc := NULL;
            OPEN c_templ(i_templ(i), i_inst(i));
            FETCH c_templ
                INTO l_id_templ_assoc, l_id_software;
            CLOSE c_templ;
        
            g_error := 'DELETE FROM PROF_PROFILE_TEMPLATE';
            DELETE FROM prof_profile_template
             WHERE id_professional = i_id_prof
               AND id_institution = i_inst(i)
               AND id_software IN (i_soft(i), l_id_software);
        
        END LOOP;
    
        ---INSERT NEW PROFILE TEMPLATES        
        FOR i IN 1 .. i_inst.count
        LOOP
            g_error       := 'SET PROFISSIONAL';
            l_prof        := profissional(i_id_prof, i_inst(i), i_soft(i));
            l_id_category := pk_prof_utils.get_id_category(i_lang => i_lang, i_prof => l_prof);
        
            IF nvl(i_templ(i), 0) != 0
            THEN
                g_error := 'INSERT INTO PROF_PROFILE_TEMPLATE';
                INSERT INTO prof_profile_template
                    (id_prof_profile_template, id_profile_template, id_professional, id_institution, id_software)
                VALUES
                    (get_next_value('PROF_PROFILE_TEMPLATE', i_inst(i)), i_templ(i), i_id_prof, i_inst(i), i_soft(i));
            END IF;
        
            IF i_templ(i) IS NOT NULL
            THEN
            
                g_error := 'UPDATE OR INSERT PROF_PREFERENCES';
                SELECT nvl((SELECT pp.id_prof_preferences
                             FROM prof_preferences pp
                            WHERE pp.id_professional = i_id_prof
                              AND pp.id_software = 0
                              AND pp.id_institution = i_inst(i)),
                           NULL)
                  INTO l_prof_pref_pk
                  FROM dual;
                g_error := 'GET PROFESSIONAL PREFERED LANGUAGE';
                SELECT nvl((SELECT pp.id_language
                             FROM prof_preferences pp
                            WHERE pp.id_professional = i_id_prof
                              AND pp.id_institution = i_inst(i)
                              AND pp.id_software = 0
                              AND rownum = 1),
                           i_lang)
                  INTO l_id_languge
                  FROM dual;
            
                g_error := 'INSERT INTO PROF_PREFERENCES';
                g_error := 'GET PROFESSIONAL SOFTWARE_INSTITUTION';
                SELECT nvl((SELECT si.id_software_institution
                             FROM software_institution si
                            WHERE si.id_software = i_soft(i)
                              AND si.id_institution = i_inst(i)),
                           0)
                  INTO l_soft_inst_pk
                  FROM dual;
                g_error := 'GET DEFAULT COMPONENT ID';
                pk_api_ab_tables.get_component_from_si(profissional(0, i_inst(i), i_soft(i)), l_comp_id);
            
                g_error := 'INSERT INTO PROF_PREFERENCES INSERT INTO PROF_SOFT_INST';
                pk_api_ab_tables.upd_ins_into_ab_sw_ins_usr_inf(i_prof                       => profissional(i_id_prof,
                                                                                                             i_inst(i),
                                                                                                             i_soft(i)),
                                                                i_id_ab_soft_inst_user_info  => l_prof_pref_pk,
                                                                i_import_code                => NULL,
                                                                i_record_status              => 'A',
                                                                i_id_ab_software_institution => l_soft_inst_pk,
                                                                i_id_ab_software_inst_role   => l_role_sw_inst_pk,
                                                                i_id_ab_institution          => i_inst(i),
                                                                i_id_ab_software             => i_soft(i),
                                                                i_id_ab_user_info            => i_id_prof,
                                                                i_id_ab_role                 => l_role_id,
                                                                i_id_ab_component            => to_number(l_comp_id),
                                                                i_id_ab_language             => l_id_languge,
                                                                i_flg_log                    => g_flg_avail,
                                                                i_id_department              => NULL,
                                                                i_dt_log_tstz                => NULL,
                                                                i_timeout                    => NULL,
                                                                i_first_screen               => NULL,
                                                                o_id_ab_soft_inst_user_info  => l_si_user_info);
            
            END IF;
            IF instr(pk_sysconfig.get_config('PROF_REOPEN_EPISODE', i_inst(i), i_soft(i)), '|' || i_templ(i) || '|') > 0
            THEN
            
                l_func := pk_sysconfig.get_config('FUNCTIONALITY_REOPEN', i_inst(i), i_soft(i));
            
                g_error := 'OPEN C_FUNC';
                OPEN c_func(l_func, i_inst(i));
                FETCH c_func
                    INTO l_exist;
                g_found := c_func%NOTFOUND;
                CLOSE c_func;
            
                IF g_found
                THEN
                    g_error := 'INSERT INTO PROF_FUNC - REOPEN EPISODE ';
                    INSERT INTO prof_func
                        (id_prof_func, id_functionality, id_professional, id_institution)
                    VALUES
                        (seq_prof_func.nextval, l_func, i_id_prof, i_inst(i));
                END IF;
            END IF;
        
            g_error := 'SET PROFISSIONAL';
            l_prof  := profissional(i_id_prof, i_inst(i), i_soft(i));
        
            g_error := 'CALL TO Pk_Access.SET_PROF_ALERTS';
            IF NOT pk_access.set_prof_alerts(i_lang                => i_lang,
                                             i_id_prof             => l_prof,
                                             i_id_profile_template => i_templ(i),
                                             o_error               => l_error)
            THEN
                RAISE my_exception;
            END IF;
        
            IF i_templ(i) = pk_sysconfig.get_config('PROF_OPINION', i_inst(i), i_soft(i))
            THEN
                l_func := pk_sysconfig.get_config('FUNCTIONALITY_OPINION', i_inst(i), i_soft(i));
            
                g_error := 'OPEN C_FUNC';
                OPEN c_func(l_func, i_inst(i));
                FETCH c_func
                    INTO l_exist;
                g_found := c_func%NOTFOUND;
                CLOSE c_func;
            
                IF g_found
                THEN
                    g_error := 'INSERT INTO PROF_FUNC - OPINION ';
                    INSERT INTO prof_func
                        (id_prof_func, id_functionality, id_professional, id_institution)
                    VALUES
                        (seq_prof_func.nextval, l_func, i_id_prof, i_inst(i));
                END IF;
            END IF;
        
            IF i_templ(i) = pk_sysconfig.get_config('PROF_CONSULT_REQ', i_inst(i), i_soft(i))
            THEN
                l_func  := pk_sysconfig.get_config('FUNCTIONALITY_CONSULT_REQ', i_inst(i), i_soft(i));
                g_error := 'OPEN C_FUNC';
                OPEN c_func(l_func, i_inst(i));
                FETCH c_func
                    INTO l_exist;
                g_found := c_func%NOTFOUND;
                CLOSE c_func;
            
                IF g_found
                THEN
                    g_error := 'INSERT INTO PROF_FUNC - CONSULT REQ ';
                    INSERT INTO prof_func
                        (id_prof_func, id_functionality, id_professional, id_institution)
                    
                    VALUES
                        (seq_prof_func.nextval, l_func, i_id_prof, i_inst(i));
                END IF;
            END IF;
        
            IF instr(pk_sysconfig.get_config('CATEGORY_PRINT_LIST_CAN_PRINT', l_prof.institution, l_prof.software),
                     '|' || l_id_category || '|') > 0
            THEN
                l_func  := pk_sysconfig.get_config('FUNCTIONALITY_PRINT_LIST_CAN_PRINT',
                                                   l_prof.institution,
                                                   l_prof.software);
                g_error := 'OPEN C_FUNC';
                OPEN c_func(l_func, l_prof.institution);
                FETCH c_func
                    INTO l_exist;
                g_found := c_func%NOTFOUND;
                CLOSE c_func;
            
                IF g_found
                THEN
                    g_error := 'INSERT INTO PROF_FUNC - PRINT_LIST_CAN_PRINT ';
                    INSERT INTO prof_func
                        (id_prof_func, id_functionality, id_professional, id_institution)
                    
                    VALUES
                        (seq_prof_func.nextval, l_func, l_prof.id, l_prof.institution);
                END IF;
            END IF;
        
            IF instr(pk_sysconfig.get_config('CATEGORY_PRINT_LIST_CAN_ADD', l_prof.institution, l_prof.software),
                     '|' || l_id_category || '|') > 0
            THEN
                l_func  := pk_sysconfig.get_config('FUNCTIONALITY_PRINT_LIST_CAN_ADD',
                                                   l_prof.institution,
                                                   l_prof.software);
                g_error := 'OPEN C_FUNC';
                OPEN c_func(l_func, l_prof.institution);
                FETCH c_func
                    INTO l_exist;
                g_found := c_func%NOTFOUND;
                CLOSE c_func;
            
                IF g_found
                THEN
                    g_error := 'INSERT INTO PROF_FUNC - PRINT_LIST_CAN_ADD ';
                    INSERT INTO prof_func
                        (id_prof_func, id_functionality, id_professional, id_institution)
                    
                    VALUES
                        (seq_prof_func.nextval, l_func, l_prof.id, l_prof.institution);
                END IF;
            END IF;
        
            g_error := 'COUNT NUMBER OF SCHEDULABLE PROFILES';
            pk_alertlog.log_debug('PK_BACKOFFICE.set_template_list ' || g_error);
            SELECT COUNT(pt.id_profile_template)
              INTO l_prof_schedulable
              FROM profile_template pt, software s
             WHERE pt.id_profile_template IN (SELECT ppt.id_profile_template
                                                FROM prof_profile_template ppt
                                               WHERE ppt.id_professional = i_id_prof
                                                 AND ppt.id_institution = i_inst(i))
               AND pt.flg_available = g_flg_available
               AND pt.id_software = s.id_software
               AND s.flg_viewer = pk_alert_constant.get_no
               AND pt.flg_schedulable = pk_alert_constant.get_yes;
        
            g_error := 'GET ID_PROF_INSTITUTION FROM ID_INSTITUTION = ' || i_inst(i) || ' AND ID_PROFESSIONAL = ' ||
                       i_id_prof;
            pk_alertlog.log_debug('PK_BACKOFFICE.set_template_list ' || g_error);
            SELECT pi.id_prof_institution
              INTO l_id_prof_institution
              FROM prof_institution pi
             WHERE pi.id_professional = i_id_prof
               AND pi.id_institution = i_inst(i)
               AND pi.dt_end_tstz IS NULL
               AND rownum = 1;
        
            g_error := 'IF ID_PROFESSIONAL = ' || i_id_prof || 'IS SCHEDULABLE IN ID_INSTITUTION = ' || i_inst(i);
            pk_alertlog.log_debug('PK_BACKOFFICE.set_template_list ' || g_error);
            IF l_prof_schedulable > 0
            THEN
            
                g_error := 'UPDATE FLG_SCHEDULABLE TO YES FOR ID_PROFESSIONAL = ' || i_id_prof ||
                           'IN ID_INSTITUTION = ' || i_inst(i);
                pk_alertlog.log_debug('PK_BACKOFFICE.set_template_list ' || g_error);
                pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_id_prof_institution,
                                                               i_id_professional     => i_id_prof,
                                                               i_id_institution      => i_inst(i),
                                                               i_flg_state           => 'A',
                                                               i_flg_schedulable     => pk_alert_constant.get_yes,
                                                               o_id_prof_institution => l_id_prof_institution);
            
            ELSE
            
                g_error := 'UPDATE FLG_SCHEDULABLE TO NO FOR ID_PROFESSIONAL = ' || i_id_prof || 'IN ID_INSTITUTION = ' ||
                           i_inst(i);
                pk_alertlog.log_debug('PK_BACKOFFICE.set_template_list ' || g_error);
                pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_id_prof_institution,
                                                               i_id_professional     => i_id_prof,
                                                               i_id_institution      => i_inst(i),
                                                               i_flg_state           => 'A',
                                                               i_flg_schedulable     => pk_alert_constant.get_no,
                                                               o_id_prof_institution => l_id_prof_institution);
            
            END IF;
        
            g_error := 'UPDATE ALERT_INTER PROFESSIONAL SCHEDULE INFO FOR ID_PROFESSIONAL = ' || i_id_prof ||
                       'IN ID_INSTITUTION = ' || i_inst(i);
            pk_alertlog.log_debug('PK_BACKOFFICE.set_template_list ' || g_error);
            alert_inter.pk_ia_event_backoffice.prof_schedule_info_update(l_id_prof_institution, i_inst(i));
        
        END LOOP;
    
        IF i_commit_at_end
        THEN
            COMMIT;
        END IF;
        RETURN TRUE;
    
    EXCEPTION
        WHEN my_exception THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error || ' / ' || l_error.err_desc,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_TEMPLATE_LIST',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_TEMPLATE_LIST',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
    END set_template_list;

    /** @headcom
    * Public Function. Get professional insitutions list
    *
    * @param      I_LANG                               Language identification
    * @param      I_PROF                               Professional identification 
    * @param      O_INFO                               Cursor with relations between professional and institution  
    * @param      O_ERROR                              Error 
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/04/27
    */
    FUNCTION get_instit_list
    (
        i_lang  IN language.id_language%TYPE,
        i_prof  IN professional.id_professional%TYPE,
        o_info  OUT pk_types.cursor_type,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET CURSOR';
        OPEN o_info FOR
            SELECT i.id_institution, pk_translation.get_translation(i_lang, i.code_institution) desc_instit
              FROM institution i, prof_institution pi
             WHERE pi.id_professional = i_prof
               AND i.id_institution = pi.id_institution
               AND pi.flg_state = 'A'
             ORDER BY desc_instit;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
            
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_INSTIT_LIST');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_types.open_my_cursor(o_info);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_instit_list;

    FUNCTION get_prof_photo
    (
        i_lang  IN language.id_language%TYPE,
        i_prof  IN profissional,
        o_photo OUT VARCHAR2,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
        /******************************************************************************************************
           OBJECTIVO: Obter URL da foto do profissional        
           PARAMETROS:  Entrada: I_LANG - Língua registada como preferência do profissional 
                       I_PROF - profissional   
                Saída:   O_LIST - listagem 
                     O_ERROR - erro 
          CRIAÇÃO: SS 2005/11/03   
          NOTAS:  
        ******************************************************************************************************/
    
    BEGIN
    
        BEGIN
            g_error := 'GET PHOTO';
            SELECT pk_profphoto.get_prof_photo(i_prof)
              INTO o_photo
              FROM dual;
        
        END;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            DECLARE
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_PROF_PHOTO');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END;

    FUNCTION get_cat_sub_list
    (
        i_lang  IN language.id_language%TYPE,
        i_cat   IN category.id_category%TYPE,
        o_cat   OUT pk_types.cursor_type,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
        /******************************************************************************
           OBJECTIVO:   Obter lista de categorias 
           PARAMETROS:  Entrada: I_LANG - Língua registada como preferência do profissional 
                   I_CAT - ID da categoria do profissional 
                  Saida: O_CAT - categorias 
                 O_ERROR - erro 
          
          CRIAÇÃO: CRS 2006/06/23  
          NOTAS: 
        *********************************************************************************/
    BEGIN
        g_error := 'GET CURSOR';
        OPEN o_cat FOR
            SELECT id_category_sub, 0 rank, pk_translation.get_translation(i_lang, code_category_sub) cat
              FROM category_sub
             WHERE flg_available = g_flg_avail
               AND id_category = nvl(i_cat, id_category)
            UNION ALL
            SELECT -1 id_category_sub, -1 rank, pk_message.get_message(i_lang, 'COMMON_M002') cat
              FROM dual
             WHERE i_cat IN (SELECT id_category
                               FROM category_sub)
             ORDER BY rank, cat;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
            
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_CAT_SUB_LIST');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_types.open_my_cursor(o_cat);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END;

    FUNCTION get_service
    (
        i_lang  IN language.id_language%TYPE,
        i_prof  IN profissional,
        i_dep   IN dept.id_dept%TYPE,
        o_list  OUT pk_types.cursor_type,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
        /******************************************************************************************************
           OBJECTIVO: Obter listagem dos serviços do departamento seleccionada     
           PARAMETROS:  Entrada: I_LANG - Língua registada como preferência do profissional 
                 I_PROF - profissional (ID, INSTITUTION, SOFTWARE)  
                 I_INST - instituição seleccionada    
              Saída: O_LIST - listagem 
                 O_ERROR - erro 
          CRIAÇÃO: CRS 2006/11/11 
          NOTAS: 
        ******************************************************************************************************/
    BEGIN
        g_error := 'GET CURSOR';
        OPEN o_list FOR
            SELECT d.id_department id_service, pk_translation.get_translation(i_lang, d.code_department) desc_service
              FROM department d
             WHERE d.id_dept = i_dep
               AND d.flg_available = 'Y'
             ORDER BY desc_service;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            DECLARE
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
            
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_SERVICE');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_types.open_my_cursor(o_list);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
    END;

    /**
    * Get sys_functionalities available for the software
    *
    * @param   I_LANG language associated to the professional executing the request 
    * @param   I_PROF  professional, institution and software ids
    * @param   O_LIST  return list
    * @param   O_ERROR an error message, set when return=false 
    *
    * @RETURN  TRUE if sucess, FALSE otherwise 
    * @author  João S?
    * @version 1.0 
    * @since   14-12-2006 
    */
    FUNCTION get_functionality
    (
        i_lang  IN language.id_language%TYPE,
        i_prof  IN profissional,
        o_list  OUT pk_types.cursor_type,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
    
        g_error := 'GET CURSOR';
        OPEN o_list FOR
            SELECT sf.id_functionality, pk_translation.get_translation(i_lang, sf.code_functionality) desc_func
              FROM sys_functionality sf
             WHERE sf.id_software = i_prof.software;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
            
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_FUNCTIONALITY');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_types.open_my_cursor(o_list);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END;

    /********************************************************************************************
    * Get Aplication Functionalities filtered by professional category
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_software           Software ID
    * @param i_id_professional       Professional ID
    * @param i_id_professional       Institution ID
    * @param o_list                  Cursor with funcionalities list
    * @param o_error                 Error    
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      Tércio Soares
    * @version                     0.1
    * @since                       2010/01/04
    ********************************************************************************************/
    FUNCTION get_soft_functionality
    (
        i_lang            IN language.id_language%TYPE,
        i_id_software     IN sys_functionality.id_software%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        i_id_institution  IN institution.id_institution%TYPE,
        o_list            OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_category category.id_category%TYPE;
    
    BEGIN
    
        SELECT pc.id_category
          INTO l_category
          FROM prof_cat pc
         WHERE pc.id_professional = i_id_professional
           AND pc.id_institution = i_id_institution;
    
        g_error := 'GET CURSOR';
        OPEN o_list FOR
            SELECT DISTINCT sf.id_functionality,
                            pk_translation.get_translation(i_lang, sf.code_functionality) desc_func
              FROM sys_functionality sf, sys_func_category sfc
             WHERE sfc.id_category = l_category
               AND sfc.id_sys_functionality = sf.id_functionality
               AND sf.id_software = i_id_software
               AND sf.flg_available = g_flg_available
               AND sfc.flg_available = g_flg_available
            UNION
            SELECT DISTINCT sf.id_functionality,
                            pk_translation.get_translation(i_lang, sf.code_functionality) desc_func
              FROM sys_functionality sf
             WHERE sf.id_functionality NOT IN (SELECT DISTINCT sfc.id_sys_functionality
                                                 FROM sys_func_category sfc
                                                WHERE sfc.flg_available = g_flg_available)
               AND sf.id_software = i_id_software
               AND sf.flg_available = g_flg_available
             ORDER BY desc_func;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_types.open_my_cursor(o_list);
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_SOFT_FUNCTIONALITY',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
    END get_soft_functionality;

    /** @headcom
    * Public Function. Get Aplication Functionalities
    *
    * @param      I_LANG                               Language identification
    * @param      I_ID_PROFESSIONAL                    Professional identification
    * @param      I_ID_INSTITUTION                     Institution identification
    * @param      I_ID_SOFTWARE                        Software identification
    * @param      O_PROF_FUNC                          Cursor with the relation between professionals and funcionalitys
    * @param      O_ERROR                              Error 
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/04/27
    */
    FUNCTION get_prof_func
    (
        i_lang            IN language.id_language%TYPE,
        i_id_professional IN prof_func.id_professional%TYPE,
        i_id_institution  IN prof_func.id_institution%TYPE,
        i_id_software     IN software.id_software%TYPE,
        o_prof_func       OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET PROF_FUNC CURSOR';
        OPEN o_prof_func FOR
            SELECT DISTINCT pf.id_functionality, pk_translation.get_translation(i_lang, sf.code_functionality) func
              FROM prof_func pf, sys_functionality sf
             WHERE pf.id_professional = i_id_professional
               AND pf.id_institution = i_id_institution
               AND sf.id_software IN (i_id_software, 0)
               AND sf.id_functionality = pf.id_functionality
               AND sf.flg_available = pk_alert_constant.g_available;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_prof_func);
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_PROF_FUNC');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_prof_func;

    /**
    * Get sys_functionalities available for the software
    * TODO: usar table_table_number em vez do table_table_varchar
    *
    * @param   I_LANG               language associated to the professional executing the request 
    * @param   I_PROF               professional, institution and software ids
    * @param   i_id_professional    Professional identification
    * @param   i_id_institution     Institution identification
    * @param   i_args               Argument
    * @param   O_ERROR              an error message, set when return=false 
    *
    * @RETURN  TRUE if sucess, FALSE otherwise 
    * @author  João S?
    * @version 1.0 
    * @since   14-12-2006 
    */
    FUNCTION set_prof_func
    (
        i_lang            IN language.id_language%TYPE DEFAULT NULL,
        i_prof            IN profissional,
        i_id_professional IN professional.id_professional%TYPE,
        i_id_institution  IN institution.id_institution%TYPE,
        i_args            IN table_table_varchar,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
        CURSOR c_pf
        (
            x_inst         institution.id_institution%TYPE,
            x_professional professional.id_professional%TYPE,
            x_func         sys_functionality.id_functionality%TYPE,
            x_dcs          dep_clin_serv.id_dep_clin_serv%TYPE
        ) IS
            SELECT s.id_functionality, pf.id_prof_func
              FROM prof_func pf, sys_functionality s
             WHERE pf.id_functionality = s.id_functionality
               AND s.id_software = i_prof.software
               AND pf.id_institution = x_inst
               AND pf.id_professional = x_professional
               AND pf.id_dep_clin_serv = x_dcs;
    
        idx_dcs        NUMBER;
        idx_func       NUMBER;
        l_id_prof_func prof_func.id_prof_func%TYPE;
        l_func         sys_functionality.id_functionality%TYPE;
        c_found        BOOLEAN;
    BEGIN
        idx_dcs  := 1;
        idx_func := 2;
        c_found  := FALSE;
    
        FOR i IN 1 .. i_args.count
        LOOP
        
            OPEN c_pf(i_id_institution,
                      i_id_professional,
                      to_number(i_args(i) (idx_func)),
                      to_number(i_args(i) (idx_dcs)));
            FETCH c_pf
                INTO l_func, l_id_prof_func;
            c_found := c_pf%FOUND;
            CLOSE c_pf;
        
            IF c_found
            THEN
                IF to_number(nvl(i_args(i) (idx_func), '0')) = 0
                THEN
                    g_error := 'DELETE FROM PROF_FUNC';
                    DELETE FROM prof_func
                     WHERE id_prof_func = l_id_prof_func;
                ELSE
                    g_error := 'UPDATE PROF_FUNC';
                    UPDATE prof_func
                       SET id_functionality = to_number(i_args(i) (idx_func)),
                           id_professional  = i_id_professional,
                           id_dep_clin_serv = to_number(i_args(i) (idx_dcs)),
                           id_institution   = i_id_institution
                     WHERE id_prof_func = l_id_prof_func;
                END IF;
            ELSE
                IF to_number(nvl(i_args(i) (idx_func), '0')) != 0
                THEN
                    g_error := 'INSERT INTO PROF_FUNC';
                    INSERT INTO prof_func
                        (id_prof_func, id_functionality, id_professional, id_dep_clin_serv, id_institution)
                    VALUES
                        (seq_prof_func.nextval,
                         to_number(i_args(i) (idx_func)),
                         i_id_professional,
                         to_number(i_args(i) (idx_dcs)),
                         i_id_institution);
                END IF;
            END IF;
        END LOOP;
    
        COMMIT;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'SET_PROF_FUNC');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END;

    /** @headcom
    * Public Function. Get Aplication Functionalities
    *
    * @param      I_LANG                               Language identification
    * @param      I_PROF                               Object: Profissional (professional identification, institution identification, software identification)
    * @param      I_ID_PROFESSIONAL                    Professional identification
    * @param      I_INSTITUTION                        Institution identification
    * @param      I_FUNC                               Funcionalitys list
    * @param      i_change                             Change                             
    * @param      i_commit_at_end                      Commit at the end
    * @param      O_ID_PROF_FUNC                       Cursor with the relation between professionals and funcionalitys
    * @param      O_ERROR                              Error 
    *
    * @value      i_change                             {*} 'Y' Yes {*} 'N' No
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/04/30
    */
    FUNCTION set_prof_func_all
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN profissional,
        i_id_professional IN prof_func.id_professional%TYPE,
        i_institution     IN table_number,
        i_func            IN table_number,
        i_change          IN table_varchar,
        i_commit_at_end   IN BOOLEAN,
        o_id_prof_func    OUT table_number,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
        e_delete EXCEPTION;
    
    BEGIN
        g_sysdate := SYSDATE;
    
        o_id_prof_func := table_number();
    
        FOR i IN 1 .. i_institution.count
        LOOP
            o_id_prof_func.extend;
        
            IF i_change(i) = 'Y'
            THEN
                g_error := 'GET SEQ_PROF_FUNC.NEXTVAL';
                SELECT seq_prof_func.nextval
                  INTO o_id_prof_func(i)
                  FROM dual;
            
                g_error := 'INSERT INTO PROF_FUNC';
                INSERT INTO prof_func
                    (id_prof_func, id_functionality, id_professional, id_institution)
                VALUES
                    (o_id_prof_func(i), i_func(i), i_id_professional, i_institution(i));
            
            ELSE
            
                g_error := 'DELETE FROM PROF_FUNC';
                DELETE FROM prof_func
                 WHERE id_professional = i_id_professional
                   AND id_institution = i_institution(i)
                   AND id_functionality = i_func(i);
            
            END IF;
        
        END LOOP;
    
        IF i_commit_at_end
        THEN
            COMMIT;
        END IF;
        RETURN TRUE;
    
    EXCEPTION
    
        WHEN OTHERS THEN
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'SET_PROF_FUNC_ALL');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END set_prof_func_all;

    FUNCTION get_prof_title_list
    (
        i_lang  IN language.id_language%TYPE,
        o_title OUT pk_types.cursor_type,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
        /******************************************************************************************************
           OBJECTIVO: Obter titulos possiveis para o profissional  
           PARAMETROS:  Entrada: I_LANG - Língua registada como preferência do profissional 
                Saída:   O_DETAIL - detalhe do profissional 
                     O_ERROR - erro 
          CRIAÇÃO: RdSN 2006/12/26    
          NOTAS:  
        ******************************************************************************************************/
    
    BEGIN
    
        g_error := 'GET CURSOR';
        OPEN o_title FOR
            SELECT val, desc_val, 0 AS rank
              FROM sys_domain
             WHERE code_domain = 'PROFESSIONAL.TITLE'
               AND flg_available = g_flg_available
               AND domain_owner = pk_sysdomain.k_default_schema
               AND id_language = i_lang
            UNION
            SELECT '-1' AS val, sm.desc_message, 10 AS rank
              FROM sys_message sm
             WHERE sm.code_message = 'COMMON_M041'
               AND sm.id_language = i_lang
             ORDER BY rank, desc_val;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_PROF_TITLE_LIST');
            
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_types.open_my_cursor(o_title);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END;

    /** @headcom
    * Public Function. Insert New Institution OR Update Institution Information
    *
    * @param      I_LANG                               Language identification
    * @param      I_ID_INSTITUTION                     Institution identification
    * @param      I_DESC                               Institution description
    * @param      I_FLG_TYPE                           Institution type: H - Hospital, C - Primary Care, P - Private Practice
    * @param      I_FLG_AVAILABLE                      Flag available
    * @param      I_BARCODE                            Barcode
    * @param      I_ABBREVIATION                       Abreviation
    * @param      I_LOCATION                           Location
    * @param      I_INE_LOCATION                       Institution location (code INE)
    * @param      I_ID_PARENT                          Parent institution identification
    * @param      I_PHONE_NUMBER                       Phone number
    * @param      I_EXT_CODE                           SONHO Institution code 
    * @param      O_ID_INSTITUTION                     Institution identification
    * @param      O_ERROR                              Error
    *
    * @value      I_FLG_TYPE                           {*} 'H' Hospital {*} 'C' Primary Care {*} 'P' Private Practice
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/03/21
    */
    FUNCTION set_institution
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        i_desc           IN VARCHAR2,
        i_flg_type       IN institution.flg_type%TYPE,
        i_flg_available  IN institution.flg_available%TYPE,
        i_barcode        IN institution.barcode%TYPE,
        i_abbreviation   IN institution.abbreviation%TYPE,
        i_location       IN institution.location%TYPE,
        i_ine_location   IN institution.ine_location%TYPE,
        i_id_parent      IN institution.id_parent%TYPE,
        i_phone_number   IN institution.phone_number%TYPE,
        i_ext_code       IN institution.ext_code%TYPE,
        o_id_institution OUT institution.id_institution%TYPE,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
        g_error VARCHAR2(4000);
        my_exception EXCEPTION;
        l_code_trl translation.code_translation%TYPE := 'AB_INSTITUTION.CODE_INSTITUTION.';
    
    BEGIN
        g_sysdate := SYSDATE;
    
        IF i_desc IS NULL
        THEN
            g_error := 'Invalid Institution Name';
            RAISE my_exception;
        ELSIF i_flg_type IS NULL
        THEN
            g_error := 'Invalid Type of Insitution';
            RAISE my_exception;
        ELSIF i_flg_available IS NULL
        THEN
            g_error := 'Please Choose Available: Y/N';
            RAISE my_exception;
        
        ELSIF i_id_institution IS NULL
        THEN
            g_error := 'INSERT INTO INSTITUTION';
            pk_api_ab_tables.upd_ins_into_ab_institution(i_id_ab_institution          => i_id_institution,
                                                         i_import_code                => NULL,
                                                         i_record_status              => 'A',
                                                         i_id_ab_market               => NULL,
                                                         i_code                       => NULL,
                                                         i_description                => i_desc,
                                                         i_alt_description            => NULL,
                                                         i_shortname                  => i_abbreviation,
                                                         i_vat_registration           => NULL,
                                                         i_timezone_region_code       => NULL,
                                                         i_rb_country_key             => NULL, --id_country
                                                         i_rb_regional_classifier_key => NULL,
                                                         i_id_ab_institution_parent   => i_id_parent,
                                                         i_flg_type                   => i_flg_type,
                                                         i_address1                   => NULL,
                                                         i_address2                   => NULL,
                                                         i_address3                   => NULL,
                                                         i_zip_code                   => NULL,
                                                         i_zip_code_description       => NULL,
                                                         i_fax_number                 => NULL,
                                                         i_phone_number               => i_phone_number,
                                                         i_email                      => NULL,
                                                         i_logo                       => NULL,
                                                         i_web_site                   => NULL,
                                                         i_geo_location_key           => NULL,
                                                         i_flg_external               => NULL,
                                                         i_code_institution           => l_code_trl || i_id_institution,
                                                         i_flg_available              => i_flg_available,
                                                         i_rank                       => 1,
                                                         i_barcode                    => i_barcode,
                                                         i_ine_location               => i_ine_location,
                                                         i_id_timezone_region         => 'N/A',
                                                         i_ext_code                   => i_ext_code,
                                                         i_dn_flg_status              => NULL,
                                                         i_adress_type                => NULL,
                                                         i_contact_det                => NULL,
                                                         o_id_ab_institution          => o_id_institution);
        ELSE
            pk_api_ab_tables.upd_ab_institution(id_ab_institution_in         => i_id_institution,
                                                shortname_in                 => i_abbreviation,
                                                shortname_nin                => FALSE,
                                                description_in               => i_desc,
                                                description_nin              => FALSE,
                                                id_ab_institution_parent_in  => i_id_parent,
                                                id_ab_institution_parent_nin => FALSE,
                                                flg_type_in                  => i_flg_type,
                                                flg_type_nin                 => FALSE,
                                                phone_number_in              => i_phone_number,
                                                phone_number_nin             => FALSE,
                                                flg_available_in             => i_flg_available,
                                                flg_available_nin            => FALSE,
                                                barcode_in                   => i_barcode,
                                                barcode_nin                  => FALSE,
                                                ine_location_in              => i_ine_location,
                                                ine_location_nin             => FALSE,
                                                ext_code_in                  => i_ext_code,
                                                ext_code_nin                 => FALSE);
        
        END IF;
        o_id_institution := i_id_institution;
    
        pk_translation.insert_into_translation(i_lang, l_code_trl || o_id_institution || '', i_desc);
    
        COMMIT;
        RETURN TRUE;
    
    EXCEPTION
        WHEN my_exception THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_INSTITUTION',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
        WHEN OTHERS THEN
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'SET_INSTITUTION');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END set_institution;

    /** @headcom
    * Public Function. Get Institution Information
    *
    * @param      I_LANG                     Language identification
    * @param      I_ID_INSTITUTION           Institution identification
    * @param      O_INSTITUTION              Cursor with institution information
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/03/21
    */
    FUNCTION get_institution
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        o_institution    OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET INSTITUTION CURSOR';
        OPEN o_institution FOR
            SELECT pk_translation.get_translation(i_lang, i.code_institution) institution_name,
                   pk_sysdomain.get_domain('AB_INSTITUTION.FLG_TYPE', nvl(i.flg_type, NULL), i_lang) institution_type,
                   pk_sysdomain.get_domain('YES_NO', nvl(i.flg_available, 'Y'), i_lang) institution_available,
                   i.barcode,
                   i.abbreviation,
                   i.location,
                   i.ine_location,
                   pk_translation.get_translation(i_lang,
                                                  (SELECT code_institution
                                                     FROM institution
                                                    WHERE id_institution = i.id_parent)) institution_parent,
                   i.phone_number,
                   i.ext_code,
                   i.flg_type,
                   i.flg_available,
                   i.id_parent
              FROM institution i
             WHERE id_institution = i_id_institution;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_INSTITUTION');
            
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_types.open_my_cursor(o_institution);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_institution;

    /** @headcom
    * Public Function. Get Institution Information List
    *
    * @param      I_LANG                     Language identification
    * @param      I_FLG_TYPE                 Institution type
    * @param      O_INST_LIST                Cursor with institution information
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/04/09
    */
    FUNCTION get_institution_list
    (
        i_lang      IN language.id_language%TYPE,
        i_flg_type  IN institution.flg_type%TYPE,
        o_inst_list OUT pk_types.cursor_type,
        o_error     OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET INSTITUTION CURSOR';
        OPEN o_inst_list FOR
            SELECT i.id_institution id,
                   pk_translation.get_translation(i_lang, i.code_institution) name,
                   pk_translation.get_translation(i_lang,
                                                  (SELECT code_institution
                                                     FROM institution
                                                    WHERE id_institution = i.id_parent)) PARENT,
                   pk_sysdomain.get_domain('AB_INSTITUTION.FLG_TYPE', nvl(i.flg_type, NULL), i_lang) TYPE,
                   i.ext_code code,
                   i.flg_available,
                   pk_sysdomain.get_domain('YES_NO', nvl(i.flg_available, 'Y'), i_lang) state
              FROM institution i
             WHERE ((i.flg_type = i_flg_type AND i_flg_type IS NOT NULL) OR i_flg_type IS NULL)
             ORDER BY name;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_INSTITUTION_LIST');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
            
                pk_types.open_my_cursor(o_inst_list);
            
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_institution_list;

    /** @headcom
    * Public Function. Insert New nstitution State OR Update Institution State
    *
    * @param      I_LANG                               Language identification
    * @param      I_ID_INSTITUTION                     Institution identification
    * @param      I_FLG_STATE                          Status: Active /Inactive
    * @param      O_ERROR                              Error 
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/04/24
    */
    FUNCTION set_institution_state
    (
        i_lang          IN language.id_language%TYPE,
        i_id_insitution IN institution.id_institution%TYPE,
        i_flg_state     IN institution.flg_available%TYPE,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
        l_institution institution.id_institution%TYPE := 0;
    BEGIN
    
        g_error := 'UPDATE INSTITUTION';
        pk_api_ab_tables.upd_ins_into_ab_institution(i_id_ab_institution          => i_id_insitution,
                                                     i_import_code                => NULL,
                                                     i_record_status              => i_flg_state,
                                                     i_id_ab_market               => NULL,
                                                     i_code                       => NULL,
                                                     i_description                => NULL,
                                                     i_alt_description            => NULL,
                                                     i_shortname                  => NULL,
                                                     i_vat_registration           => NULL,
                                                     i_timezone_region_code       => NULL,
                                                     i_rb_country_key             => NULL, --id_country
                                                     i_rb_regional_classifier_key => NULL,
                                                     i_id_ab_institution_parent   => NULL,
                                                     i_flg_type                   => NULL,
                                                     i_address1                   => NULL,
                                                     i_address2                   => NULL,
                                                     i_address3                   => NULL,
                                                     i_zip_code                   => NULL,
                                                     i_zip_code_description       => NULL,
                                                     i_fax_number                 => NULL,
                                                     i_phone_number               => NULL,
                                                     i_email                      => NULL,
                                                     i_logo                       => NULL,
                                                     i_web_site                   => NULL,
                                                     i_geo_location_key           => NULL,
                                                     i_flg_external               => NULL,
                                                     i_code_institution           => NULL,
                                                     i_flg_available              => NULL,
                                                     i_rank                       => NULL,
                                                     i_barcode                    => NULL,
                                                     i_ine_location               => NULL,
                                                     i_id_timezone_region         => NULL,
                                                     i_ext_code                   => NULL,
                                                     i_dn_flg_status              => NULL,
                                                     i_adress_type                => NULL,
                                                     i_contact_det                => NULL,
                                                     o_id_ab_institution          => l_institution);
    
        COMMIT;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'SET_INSTITUTION_STATE');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
            
                RETURN FALSE;
            END;
        
    END set_institution_state;

    /** @headcom
    * Public Function. Insert New Department OR Update Department Information
    *
    * @param      I_LANG                               Language identification
    * @param      I_ID_DEPT                            Department identification
    * @param      I_DESC                               Department description
    * @param      I_ID_INSTITUTION                     Institution identification
    * @param      i_abbreviation                       Department abbreviation
    * @param      i_software                           Software identification
    * @param      i_change                             Change
    * @param      O_ID_DEPT                            Department identification
    * @param      O_ERROR                              Error
    *
    * @value      i_change                             {*} 'Y' Yes {*} 'N' No
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/03/21
    */
    FUNCTION set_dept
    (
        i_lang           IN language.id_language%TYPE,
        i_id_dept        IN dept.id_dept%TYPE,
        i_desc           IN VARCHAR2,
        i_id_institution IN dept.id_institution%TYPE,
        i_abbreviation   IN dept.abbreviation%TYPE,
        i_software       IN table_number,
        i_change         IN table_varchar,
        i_def_priority   IN dept.flg_priority%TYPE,
        i_collection_by  IN dept.flg_collection_by%TYPE,
        o_id_dept        OUT dept.id_dept%TYPE,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_res BOOLEAN;
    
    BEGIN
        l_res := set_dept_no_commit(i_lang           => i_lang,
                                    i_id_dept        => i_id_dept,
                                    i_dept_desc      => i_desc,
                                    i_id_institution => i_id_institution,
                                    i_abbreviation   => i_abbreviation,
                                    i_flg_available  => NULL,
                                    i_software       => i_software,
                                    i_change         => i_change,
                                    o_id_dept        => o_id_dept,
                                    o_error          => o_error);
        IF l_res
        THEN
            COMMIT;
        END IF;
    
        RETURN l_res;
    END set_dept;

    /** @headcom
    * Public Function. Get Department Information List
    * 
    * @param      I_LANG                     Language identification
    * @param      I_ID_INSTITUTION           Institution identification
    * @param      i_search                   Search
    * @param      o_dept_list                Cursor with department information
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/04/09
    */
    FUNCTION get_dept_list
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN dept.id_institution%TYPE,
        i_search         IN VARCHAR2,
        o_dept_list      OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET DEPT CURSOR';
        IF i_search IS NULL
        THEN
            OPEN o_dept_list FOR
                SELECT d.id_dept id,
                       pk_translation.get_translation(i_lang, d.code_dept) name,
                       d.abbreviation abrv,
                       pk_date_utils.date_hour_chr_extend_tsz(i_lang,
                                                              d.adw_last_update,
                                                              profissional(0, i_id_institution, 26)) upd_date,
                       d.flg_priority flg_priority,
                       pk_sysdomain.get_domain('ANALYSIS_REQ_DET.FLG_URGENCY', d.flg_priority, i_lang) desc_priority,
                       d.flg_collection_by collection_by,
                       pk_sysdomain.get_domain('ANALYSIS_INSTIT_SOFT.FLG_COLLECTION_AUTHOR',
                                               d.flg_collection_by,
                                               i_lang) desc_collection_by
                  FROM dept d
                 WHERE d.id_institution = i_id_institution
                   AND d.flg_available = g_flg_available
                 ORDER BY name;
        
        ELSE
            OPEN o_dept_list FOR
                SELECT d.id_dept id,
                       pk_translation.get_translation(i_lang, d.code_dept) name,
                       d.abbreviation abrv,
                       pk_date_utils.date_hour_chr_extend_tsz(i_lang,
                                                              d.adw_last_update,
                                                              profissional(0, i_id_institution, 26)) upd_date,
                       d.flg_priority flg_priority,
                       pk_sysdomain.get_domain('ANALYSIS_REQ_DET.FLG_URGENCY', d.flg_priority, i_lang) desc_priority,
                       d.flg_collection_by collection_by,
                       pk_sysdomain.get_domain('ANALYSIS_INSTIT_SOFT.FLG_COLLECTION_AUTHOR',
                                               d.flg_collection_by,
                                               i_lang) desc_collection_by
                  FROM dept d
                 WHERE d.id_institution = i_id_institution
                   AND d.flg_available = g_flg_available
                   AND translate(upper(pk_translation.get_translation(i_lang, d.code_dept)),
                                 'ÁÉÍÓÚÀÈÌÒÙÂÊÎÔÛÃÕÇÄËÏÖÜÑ',
                                 'AEIOUAEIOUAEIOUAOCAEIOUN') LIKE
                       '%' || translate(upper(i_search), 'ÁÉÍÓÚÀÈÌÒÙÂÊÎÔÛÃÕÇÄËÏÖÜÑ ', 'AEIOUAEIOUAEIOUAOCAEIOUN%') || '%'
                 ORDER BY name;
        
        END IF;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_dept_list);
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_DEPT_LIST');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_dept_list;

    /********************************************************************************************
    * Get Department Software
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_dept               Department ID
    * @param i_id_institution        Institution ID
    * @param o_software_desc         Associated softwares description 
    * @param o_software_list         Software list
    * @param o_error                 Error
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      JTS
    * @version                     0.1
    * @since                       2008/05/05
    ********************************************************************************************/
    FUNCTION get_dept_software
    (
        i_lang           IN language.id_language%TYPE,
        i_id_dept        IN dept.id_dept%TYPE,
        i_id_institution IN dept.id_institution%TYPE,
        o_software_desc  OUT VARCHAR2,
        o_software_list  OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        IF i_id_dept IS NOT NULL
        THEN
        
            SELECT pk_utils.query_to_string(('SELECT s.name FROM software_dept sd, software s
        WHERE sd.id_dept = ' || i_id_dept || '
        AND sd.id_software = s.id_software'),
                                            ', ')
              INTO o_software_desc
              FROM dual;
        
            g_error := 'GET SOFTWARE CURSOR';
            OPEN o_software_list FOR
                SELECT s.id_software id, s.name name, 'Y' flg_select
                  FROM software_dept sd, software s
                 WHERE sd.id_dept = i_id_dept
                   AND sd.id_software = s.id_software
                UNION
                SELECT s.id_software id, s.name name, 'N' flg_select
                  FROM software_institution si, software s
                 WHERE s.flg_mni = g_flg_avail
                   AND si.id_software = s.id_software
                   AND si.id_institution = i_id_institution
                   AND s.id_software != 26
                   AND s.id_software NOT IN (SELECT s2.id_software
                                               FROM software_dept sd2, software s2
                                              WHERE sd2.id_dept = i_id_dept
                                                AND sd2.id_software = s2.id_software)
                
                 ORDER BY name;
        ELSE
            g_error := 'GET SOFTWARE CURSOR';
            OPEN o_software_list FOR
                SELECT s.id_software id, s.name name, 'N' flg_select
                  FROM software_institution si, software s
                 WHERE s.flg_mni = g_flg_avail
                   AND si.id_software = s.id_software
                   AND si.id_institution = i_id_institution
                   AND s.id_software != 26
                 ORDER BY name;
        
            o_software_desc := NULL;
        
        END IF;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_software_list);
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_DEPT_SOFTWARE');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_dept_software;

    /** @headcom
    * Public Function. Get Institution Service Information
    *
    * @param      I_LANG                     Language identification
    * @param      I_ID_DEPARTMENT            Department identification
    * @param      O_DEPARTMENT               Cursor with Department information
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/03/21
    */
    FUNCTION get_department
    (
        i_lang          IN language.id_language%TYPE,
        i_id_department IN department.id_department%TYPE,
        o_department    OUT pk_types.cursor_type,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
        l_prof_ids  table_number := table_number();
        l_prof_desc table_varchar := table_varchar();
        l_ret       BOOLEAN;
    BEGIN
        g_error := 'GET DEPARTMENT CURSOR: i_id_department=' || i_id_department;
        pk_alertlog.log_debug(g_error);
        l_ret := get_serv_prof_responsible(i_lang, 0, i_id_department, 'C', l_prof_ids, l_prof_desc, o_error);
        OPEN o_department FOR
            SELECT d.id_department,
                   pk_translation.get_translation(i_lang, d.code_department) department_name,
                   d.abbreviation,
                   d.flg_type,
                   pk_sysdomain.get_domain('DEPARTMENT.FLG_TYPE', nvl(d.flg_type, NULL), i_lang) tipo,
                   d.flg_default,
                   pk_sysdomain.get_domain('YES_NO', d.flg_default, i_lang) defeito,
                   pk_date_utils.date_hour_chr_extend_tsz(i_lang,
                                                          d.adw_last_update,
                                                          profissional(0, d.id_institution, 26)) upd_date,
                   d.phone_number,
                   d.fax_number,
                   pk_utils.concat_table(l_prof_desc, ', ') resp_prof_desc,
                   l_prof_ids resp_prof_id
              FROM department d
             WHERE id_department = i_id_department;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_department);
            
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_DEPARTMENT');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_department;

    /********************************************************************************************
    * Returns the information for a given service
    *
    * @param      i_lang                     Language identification
    * @param      i_id_department            Department identification
    * @param      o_department               Cursor with Department information
    * @param      o_error                    Error
    *
    * @return                         true or false on success or error
    *
    * @author                          Orlando Antunes
    * @version                         2.6.0.3
    * @since                           2010/04/28
    **********************************************************************************************/
    FUNCTION get_department
    (
        i_lang          IN language.id_language%TYPE,
        i_prof          IN profissional,
        i_id_department IN department.id_department%TYPE,
        o_department    OUT pk_types.cursor_type,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
        l_prof_ids          table_number := table_number();
        l_prof_desc         table_varchar := table_varchar();
        l_prof_service_ids  table_number := table_number();
        l_prof_service_desc table_varchar := table_varchar();
        l_ret               BOOLEAN;
    BEGIN
    
        g_error := 'GET DEPARTMENT CURSOR: i_id_department=' || i_id_department;
        pk_alertlog.log_debug(g_error);
        l_ret := get_serv_prof_responsible(i_lang,
                                           i_prof.institution,
                                           i_id_department,
                                           'C',
                                           l_prof_ids,
                                           l_prof_desc,
                                           o_error);
    
        l_ret := get_serv_prof_responsible(i_lang,
                                           i_prof.institution,
                                           i_id_department,
                                           'S',
                                           l_prof_service_ids,
                                           l_prof_service_desc,
                                           o_error);
    
        OPEN o_department FOR
            SELECT d.id_department,
                   pk_translation.get_translation(i_lang, d.code_department) department_name,
                   d.abbreviation,
                   d.flg_type,
                   pk_sysdomain.get_domain('DEPARTMENT.FLG_TYPE', nvl(d.flg_type, NULL), i_lang) tipo,
                   d.flg_default,
                   pk_sysdomain.get_domain('YES_NO', d.flg_default, i_lang) defeito,
                   pk_date_utils.date_hour_chr_extend_tsz(i_lang,
                                                          d.adw_last_update,
                                                          profissional(0, d.id_institution, 26)) upd_date,
                   at.id_admission_type,
                   nvl(at.desc_admission_type, pk_translation.get_translation(i_lang, at.code_admission_type)) admission_type,
                   pk_date_utils.dt_chr_hour_tsz(i_lang, d.admission_time, i_prof) admission_time,
                   pk_date_utils.date_send_tsz(i_lang, d.admission_time, i_prof.institution, i_prof.software) dt_admission_time,
                   d.phone_number,
                   d.fax_number,
                   pk_utils.concat_table(l_prof_desc, ', ') resp_prof_desc,
                   l_prof_ids resp_prof_id,
                   pk_utils.concat_table(l_prof_service_desc, ', ') resp_prof_serv_desc,
                   l_prof_service_ids resp_prof_serv_id
              FROM department d
              LEFT JOIN admission_type at
                ON d.id_admission_type = at.id_admission_type
             WHERE id_department = i_id_department;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            RETURN pk_alert_exceptions.process_error(i_lang     => i_lang,
                                                     i_sqlcode  => SQLCODE,
                                                     i_sqlerrm  => SQLERRM,
                                                     i_message  => g_error,
                                                     i_owner    => 'ALERT',
                                                     i_package  => 'PK_BACKOFFICE',
                                                     i_function => 'GET_DEPARTMENT',
                                                     o_error    => o_error);
    END get_department;
    --

    /** @headcom
    * Public Function. Insert New Institution Service OR Update Institution Service Information
    *
    * @param      I_LANG                               Language identification
    * @param      I_ID_DEPARTMENT                      Service identification
    * @param      I_ID_INSTITUTION                     Institution identification
    * @param      I_DESC                               Service description
    * @param      I_ABBREVIATION                       Abreviation
    * @param      I_FLG_TYPE                           Type: C - Outpatient, U - Emergency department, I - Inpatient, S - Operating Room, 
                                                             A - Analysis lab., P - Clinical patalogy lab., T - Pathological anatomy lab, 
                                                             R - Radiology, F - Pharmacy. 
                                                             It may contain combinations (eg AP - Analyses of clinical pathology lab.)
    * @param      I_ID_DEPT                            Daepartment identification
    * @param      I_FLG_DEFAULT                        Default department: Y - Yes; N - No
    * @param      O_ID_DEPARTMENT                      Department identification
    * @param      O_ERROR                              Error
    *
    * @value       I_FLG_TYPE                          {*} 'C' Outpatient {*} 'U' Emergency department {*} 'I' Inpatient {*} 'S' Operating Room 
                                                       {*} 'A' Analysis lab. {*} 'P' Clinical patalogy lab. {*} 'T' Pathological anatomy lab 
                                                       {*} 'R' Radiology {*} 'F' Pharmacy. It may contain combinations (eg AP - Analyses of clinical pathology lab.)
    *
    * @value      I_FLG_DEFAULT                        {*} 'Y' Yes {*} 'N' No                                     
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/03/21
    */
    FUNCTION set_department
    (
        i_lang               IN language.id_language%TYPE,
        i_id_department      IN department.id_department%TYPE,
        i_id_institution     IN department.id_institution%TYPE,
        i_desc               IN VARCHAR2,
        i_abbreviation       IN department.abbreviation%TYPE,
        i_flg_type           IN department.flg_type%TYPE,
        i_id_dept            IN department.id_dept%TYPE,
        i_flg_default        IN department.flg_default%TYPE,
        i_def_priority       IN department.flg_priority%TYPE,
        i_collection_by      IN department.flg_collection_by%TYPE,
        i_floors_institution IN table_number,
        i_change             IN table_varchar,
        o_id_department      OUT department.id_department%TYPE,
        o_error              OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        IF NOT set_department(i_lang               => i_lang,
                              i_id_department      => i_id_department,
                              i_id_institution     => i_id_institution,
                              i_desc               => i_desc,
                              i_abbreviation       => i_abbreviation,
                              i_flg_type           => i_flg_type,
                              i_id_dept            => i_id_dept,
                              i_flg_default        => i_flg_default,
                              i_def_priority       => i_def_priority,
                              i_collection_by      => i_collection_by,
                              i_floors_institution => i_floors_institution,
                              i_change             => i_change,
                              i_id_admission_type  => NULL,
                              i_admission_time     => NULL,
                              o_id_department      => o_id_department,
                              o_error              => o_error)
        THEN
            RAISE g_exception;
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN g_exception THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_DEPARTMENT',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'SET_DEPARTMENT');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END set_department;

    /** @headcom
    * Public Function. Insert New Institution Service OR Update Institution Service Information
    *
    * @param      I_LANG                               Language identification
    * @param      I_ID_DEPARTMENT                      Service identification
    * @param      I_ID_INSTITUTION                     Institution identification
    * @param      I_DESC                               Service description
    * @param      I_ABBREVIATION                       Abreviation
    * @param      I_FLG_TYPE                           Type: C - Outpatient, U - Emergency department, I - Inpatient, S - Operating Room, 
                                                             A - Analysis lab., P - Clinical patalogy lab., T - Pathological anatomy lab, 
                                                             R - Radiology, F - Pharmacy. 
                                                             It may contain combinations (eg AP - Analyses of clinical pathology lab.)
    * @param      I_ID_DEPT                            Daepartment identification
    * @param      I_FLG_DEFAULT                        Default department: Y - Yes; N - No
    * @param      i_flg_available                      Department i_flg_available
    * @param      O_ID_DEPARTMENT                      Department identification
    * @param      o_id_floors_department               floors_department list
    * @param      O_ERROR                              Error
    *
    * @value       I_FLG_TYPE                          {*} 'C' Outpatient {*} 'U' Emergency department {*} 'I' Inpatient {*} 'S' Operating Room 
                                                       {*} 'A' Analysis lab. {*} 'P' Clinical patalogy lab. {*} 'T' Pathological anatomy lab 
                                                       {*} 'R' Radiology {*} 'F' Pharmacy. It may contain combinations (eg AP - Analyses of clinical pathology lab.)
    *
    * @value      I_FLG_DEFAULT                        {*} 'Y' Yes {*} 'N' No                                     
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/03/21
    */
    FUNCTION set_department_no_commit
    (
        i_lang                 IN language.id_language%TYPE,
        i_id_department        IN department.id_department%TYPE,
        i_id_institution       IN department.id_institution%TYPE,
        i_desc                 IN VARCHAR2,
        i_abbreviation         IN department.abbreviation%TYPE,
        i_flg_type             IN department.flg_type%TYPE,
        i_id_dept              IN department.id_dept%TYPE,
        i_flg_default          IN department.flg_default%TYPE,
        i_def_priority         IN department.flg_priority%TYPE,
        i_collection_by        IN department.flg_collection_by%TYPE,
        i_flg_available        IN department.flg_available%TYPE DEFAULT NULL,
        i_floors_institution   IN table_number,
        i_change               IN table_varchar,
        i_id_admission_type    IN admission_type.id_admission_type%TYPE,
        i_admission_time       IN VARCHAR2,
        o_id_department        OUT department.id_department%TYPE,
        o_id_floors_department OUT table_number,
        o_error                OUT t_error_out
    ) RETURN BOOLEAN IS
    
        g_error VARCHAR2(4000);
        my_exception EXCEPTION;
    
        l_rows_out      table_varchar := table_varchar();
        l_default_rank  NUMBER := 1;
        l_adm_time_in   TIMESTAMP(6) WITH LOCAL TIME ZONE;
        l_id_department department.id_department%TYPE := 0;
    
        --TRANSLATION
        l_id_lang  language.id_language%TYPE;
        l_code_trl translation.code_translation%TYPE := 'DEPARTMENT.CODE_DEPARTMENT.';
    
        l_id_floors_department floors_department.id_floors_department%TYPE;
    
        CURSOR c_language IS
            SELECT l.id_language
              FROM LANGUAGE l
             WHERE l.flg_available = pk_alert_constant.g_available;
    
        l_flg_available department.flg_available%TYPE := nvl(i_flg_available, pk_alert_constant.g_available);
    
    BEGIN
        IF i_id_institution IS NULL
        THEN
            g_error := 'Invalid Institution';
            RAISE my_exception;
        
        ELSIF i_desc IS NULL
        THEN
            g_error := 'Invalid Name';
            RAISE my_exception;
        END IF;
    
        g_sysdate     := SYSDATE;
        l_adm_time_in := pk_date_utils.get_string_tstz(i_lang,
                                                       profissional(0, i_id_institution, 26),
                                                       i_admission_time,
                                                       NULL);
    
        IF i_id_department IS NULL
        THEN
            l_id_department := ts_department.next_key();
        ELSE
            l_id_department := i_id_department;
        END IF;
        l_code_trl := concat(l_code_trl, l_id_department);
    
        g_error := 'INSERT INTO OR UPDATE DEPARTMENT';
        ts_department.upd(id_department_in      => l_id_department,
                          id_institution_in     => i_id_institution,
                          code_department_in    => l_code_trl,
                          rank_in               => l_default_rank,
                          abbreviation_in       => i_abbreviation,
                          abbreviation_nin      => NOT (i_abbreviation IS NULL),
                          flg_type_in           => i_flg_type,
                          flg_type_nin          => NOT (i_flg_type IS NULL),
                          id_dept_in            => i_id_dept,
                          id_dept_nin           => NOT (i_id_dept IS NULL),
                          flg_default_in        => i_flg_default,
                          flg_default_nin       => NOT (i_flg_default IS NULL),
                          flg_available_in      => l_flg_available,
                          id_admission_type_in  => i_id_admission_type,
                          id_admission_type_nin => NOT (i_id_admission_type IS NULL),
                          flg_priority_in       => i_def_priority,
                          flg_priority_nin      => NOT (i_def_priority IS NULL),
                          flg_collection_by_in  => i_collection_by,
                          flg_collection_by_nin => NOT (i_collection_by IS NULL),
                          admission_time_in     => l_adm_time_in,
                          admission_time_nin    => NOT (l_adm_time_in IS NULL),
                          handle_error_in       => TRUE,
                          rows_out              => l_rows_out);
        IF SQL%ROWCOUNT = 0
        THEN
            ts_department.ins(id_department_in     => l_id_department,
                              id_institution_in    => i_id_institution,
                              code_department_in   => l_code_trl,
                              rank_in              => l_default_rank,
                              abbreviation_in      => i_abbreviation,
                              flg_type_in          => i_flg_type,
                              id_dept_in           => i_id_dept,
                              flg_default_in       => i_flg_default,
                              flg_available_in     => l_flg_available,
                              id_admission_type_in => i_id_admission_type,
                              flg_priority_in      => i_def_priority,
                              flg_collection_by_in => i_collection_by,
                              admission_time_in    => l_adm_time_in,
                              handle_error_in      => TRUE,
                              rows_out             => l_rows_out);
        
            t_data_gov_mnt.process_insert(i_lang       => i_lang,
                                          i_prof       => profissional(0, i_id_institution, 0),
                                          i_table_name => 'DEPARTMENT',
                                          i_rowids     => l_rows_out,
                                          o_error      => o_error);
        ELSE
            t_data_gov_mnt.process_update(i_lang       => i_lang,
                                          i_prof       => profissional(0, i_id_institution, 0),
                                          i_table_name => 'DEPARTMENT',
                                          i_rowids     => l_rows_out,
                                          o_error      => o_error);
        END IF;
    
        SELECT d.id_department
          INTO o_id_department
          FROM department d
         WHERE ROWID IN (SELECT column_value
                           FROM TABLE(l_rows_out));
    
        IF o_id_department != l_id_department
        THEN
            l_code_trl := concat(l_code_trl, o_id_department);
        END IF;
    
        -- set department translation
        g_error := 'GET LANGUAGES';
        OPEN c_language;
        LOOP
            FETCH c_language
                INTO l_id_lang;
            EXIT WHEN c_language%NOTFOUND;
        
            g_error := 'INSERT_INTO_TRANSLATION SERVICE';
            pk_translation.insert_into_translation(l_id_lang, l_code_trl, i_desc);
        
            g_error := 'INSERT_INTO_LB_TRANSLATION SERVICE';
            pk_schedule_tools.generate_lb_translations(l_id_lang, table_varchar(l_code_trl));
        
        END LOOP;
    
        CLOSE c_language;
        -- remove to method (set_department_floors)
        IF NOT pk_backoffice.set_department_floors(i_lang                 => i_lang,
                                                   i_id_department        => l_id_department,
                                                   i_floors_institution   => i_floors_institution,
                                                   i_change               => i_change,
                                                   o_id_floors_department => o_id_floors_department,
                                                   o_error                => o_error)
        THEN
            g_error := 'NOT ABLE TO SET DEPARTMET FLOORS';
            RAISE my_exception;
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN my_exception THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_DEPARTMENT_NO_COMMIT',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'SET_DEPARTMENT_NO_COMMIT');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END set_department_no_commit;
    --

    /** @headcom
    * Public Function. Get Department Service List
    * 
    * @param      I_LANG                     Language identification
    * @param      I_ID_INSTITUTION           Institution identification
    * @param      O_DEPARTMENT_LIST          Cursor with services information
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/03/22
    */
    FUNCTION get_department_list
    (
        i_lang            IN language.id_language%TYPE,
        i_id_institution  IN institution.id_institution%TYPE,
        o_department_list OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET DEPARTMENT_LIST CURSOR';
        OPEN o_department_list FOR
            SELECT d.id_department id,
                   pk_translation.get_translation(i_lang, d.code_department) service,
                   d.id_dept,
                   pk_translation.get_translation(i_lang,
                                                  (SELECT code_dept
                                                     FROM dept
                                                    WHERE id_dept = d.id_dept)) departamento,
                   d.flg_default,
                   pk_sysdomain.get_domain('YES_NO', nvl(d.flg_default, 'N'), i_lang) defeito,
                   d.abbreviation,
                   d.flg_type,
                   pk_sysdomain.get_domain('DEPARTMENT.FLG_TYPE', nvl(d.flg_type, NULL), i_lang) tipo
              FROM department d
             WHERE d.id_institution = i_id_institution
               AND d.flg_available = 'Y'
             ORDER BY departamento;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_department_list);
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_DEPARTMENT_LIST');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_department_list;

    /** @headcom
    * Public Function. Get Department Service List 
    * 
    * @param      I_LANG                     Language identification
    * @param      I_ID_DEPT                  Department identification
    * @param      O_DEPARTMENT_LIST          Cursor with services information
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/03/22
    */
    FUNCTION get_dept_department_list
    (
        i_lang            IN language.id_language%TYPE,
        i_id_dept         IN dept.id_dept%TYPE,
        o_department_list OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET DEPARTMENT_LIST CURSOR';
        OPEN o_department_list FOR
            SELECT d.id_department id_service,
                   pk_translation.get_translation(i_lang, d.code_department) service,
                   d.id_dept,
                   pk_translation.get_translation(i_lang,
                                                  (SELECT code_dept
                                                     FROM dept
                                                    WHERE id_dept = d.id_dept)) departamento,
                   d.flg_default
              FROM department d
             WHERE id_dept = i_id_dept
               AND flg_available = 'Y'
             ORDER BY service;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_department_list);
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_DEPT_DEPARTMENT_LIST');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_dept_department_list;

    /** @headcom
    * Public Function. Get Department Service Type List
    * 
    * @param      I_LANG                     Language identification
    * @param      O_DEPARTMENT_TYPE          Cursor with services types information
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/04/20
    */
    FUNCTION get_department_type_list
    (
        i_lang            IN language.id_language%TYPE,
        o_department_type OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        g_error := 'GET DEPARTMENT TYPE CURSOR';
        OPEN o_department_type FOR
            SELECT val, desc_val
              FROM sys_domain
             WHERE code_domain = 'DEPARTMENT.FLG_TYPE'
               AND domain_owner = pk_sysdomain.k_default_schema
               AND flg_available = g_flg_available
               AND id_language = i_lang
             ORDER BY desc_val;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_department_type);
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_DEPARTMENT_TYPE_LIST');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_department_type_list;

    /** @headcom
    * Public Function. Update Institution Default Service Information
    *
    * @param      I_LANG                               Language information
    * @param      i_id_dept                            Department identification
    * @param      I_ID_DEPARTMENT _OLD                 Identification the service default to remove 
    * @param      I_ID_DEPARTMENT _NEW                 Identification the service that will be inserted as default 
    * @param      O_ERROR                              Error 
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/04/24
    */
    FUNCTION set_department_default
    (
        i_lang              IN language.id_language%TYPE,
        i_id_dept           IN department.id_dept%TYPE,
        i_id_department_old IN department.id_department%TYPE,
        i_id_department_new IN department.id_department%TYPE,
        o_error             OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        IF i_id_department_old IS NULL
        THEN
            g_error := 'UPDATE DEPARTMENT';
            UPDATE department
               SET flg_default = 'Y'
             WHERE id_department = i_id_department_new
               AND id_dept = i_id_dept;
        ELSIF i_id_department_new IS NULL
        THEN
            g_error := 'UPDATE DEPARTMENT';
            UPDATE department
               SET flg_default = 'N'
             WHERE id_department = i_id_department_old
               AND id_dept = i_id_dept;
        ELSE
            g_error := 'UPDATE DEPARTMENT';
            UPDATE department
               SET flg_default = 'Y'
             WHERE id_department = i_id_department_new
               AND id_dept = i_id_dept;
        
            g_error := 'UPDATE DEPARTMENT';
            UPDATE department
               SET flg_default = 'N'
             WHERE id_department = i_id_department_old
               AND id_dept = i_id_dept;
        
        END IF;
    
        COMMIT;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
            
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'SET_DEPARTMENT_DEFAULT');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END set_department_default;

    FUNCTION set_dep_clin_serv_new
    (
        i_lang                IN language.id_language%TYPE,
        i_prof                IN profissional,
        i_id_department_ins   IN table_number,
        i_id_clin_service_ins IN table_number,
        i_id_department_del   IN table_number,
        i_id_clin_service_del IN table_number,
        o_id_dep_clin_serv    OUT table_number,
        o_id_department       OUT table_number,
        o_id_clin_serv        OUT table_number,
        o_error               OUT t_error_out
    ) RETURN BOOLEAN IS
    
        CURSOR c_soft(c_id_department IN department.id_department%TYPE) IS
            SELECT sd.id_software
              FROM software_dept sd, department s
             WHERE s.id_department = c_id_department
               AND s.id_dept = sd.id_dept;
    
        e_child_remaining EXCEPTION;
        PRAGMA EXCEPTION_INIT(e_child_remaining, -2292);
    
        l_id_institution institution.id_institution%TYPE;
        l_not_delete     table_number;
        l_nd             NUMBER;
    
        l_param_def VARCHAR2(1);
    
        l_res   BOOLEAN;
        l_error VARCHAR2(4000);
    
        l_count_dcs      NUMBER;
        l_exists_new_dcs BOOLEAN := FALSE;
        /* RMGM: default execution new (job implementation) */
        -- jobs and job lists
        new_job         sys.job;
        new_job_list    sys.job_array := sys.job_array();
        l_job_name      VARCHAR2(200);
        l_job_name_list table_varchar := table_varchar();
    
        -- input vars
        l_id_market      market.id_market%TYPE;
        l_param_def_vers VARCHAR2(230);
        l_id_software    software.id_software%TYPE;
    
        -- auxiliar vars
        l_block      VARCHAR2(4000);
        l_jb_idx     NUMBER := 1;
        l_start_time TIMESTAMP(6) WITH LOCAL TIME ZONE;
    
        l_id_dep_clin_serv dep_clin_serv.id_dep_clin_serv%TYPE;
        r_cur              sch_event_dcs%ROWTYPE;
    BEGIN
    
        g_sysdate          := SYSDATE;
        o_id_dep_clin_serv := table_number();
        o_id_department    := table_number();
        o_id_clin_serv     := table_number();
        l_not_delete       := table_number();
        l_nd               := 1;
    
        FOR i IN 1 .. i_id_department_ins.count
        LOOP
            o_id_dep_clin_serv.extend;
            o_id_department.extend;
            o_id_clin_serv.extend;
        
            SELECT d.id_institution
              INTO l_id_institution
              FROM department d
             WHERE d.id_department = i_id_department_ins(i);
        
            o_id_department(i) := i_id_department_ins(i);
            o_id_clin_serv(i) := i_id_clin_service_ins(i);
        
            SELECT COUNT(dcs.id_dep_clin_serv)
              INTO l_count_dcs
              FROM dep_clin_serv dcs
             WHERE dcs.id_clinical_service = i_id_clin_service_ins(i)
               AND dcs.id_department = i_id_department_ins(i);
        
            IF l_count_dcs = 0
            THEN
            
                l_exists_new_dcs := TRUE;
            
                g_error := 'GET SEQ_DEP_CLIN_SERV.NEXTVAL';
                SELECT seq_dep_clin_serv.nextval
                  INTO o_id_dep_clin_serv(i)
                  FROM dual;
            
                g_error := 'INSERT INTO DEP_CLIN_SERV';
                INSERT INTO dep_clin_serv
                    (id_dep_clin_serv, id_clinical_service, id_department, rank, adw_last_update, flg_available)
                VALUES
                    (o_id_dep_clin_serv(i), i_id_clin_service_ins(i), i_id_department_ins(i), 1, g_sysdate, 'Y');
            
            ELSE
            
                --Search for active id_dep_clin_serv
                SELECT COUNT(dcs.id_dep_clin_serv)
                  INTO l_count_dcs
                  FROM dep_clin_serv dcs
                 WHERE dcs.id_clinical_service = i_id_clin_service_ins(i)
                   AND dcs.id_department = i_id_department_ins(i)
                   AND dcs.flg_available = pk_alert_constant.get_available;
            
                IF l_count_dcs = 0
                THEN
                
                    l_exists_new_dcs := TRUE;
                
                    --get last inactivated id_dep_clin_serv
                    SELECT id_dep_clin_serv
                      INTO o_id_dep_clin_serv(i)
                      FROM (SELECT dcs.id_dep_clin_serv
                              FROM dep_clin_serv dcs
                             WHERE dcs.id_clinical_service = i_id_clin_service_ins(i)
                               AND dcs.id_department = i_id_department_ins(i)
                               AND dcs.flg_available = pk_alert_constant.get_no
                             ORDER BY 1 DESC)
                     WHERE rownum = 1;
                
                    UPDATE dep_clin_serv dcs
                       SET flg_available = pk_alert_constant.get_available, adw_last_update = g_sysdate
                     WHERE dcs.id_dep_clin_serv = o_id_dep_clin_serv(i);
                
                    --------------------------------------------
                
                END IF;
            END IF;
        
            IF l_exists_new_dcs
            THEN
            
                OPEN c_soft(i_id_department_ins(i));
                LOOP
                    FETCH c_soft
                        INTO l_id_software;
                    EXIT WHEN c_soft%NOTFOUND;
                
                    l_param_def := pk_sysconfig.get_config('DEFAULT_PARAM',
                                                           profissional(i_prof.id, i_prof.institution, l_id_software));
                
                    l_param_def_vers := pk_sysconfig.get_config('DEFAULT_PARAM_VERS',
                                                                profissional(i_prof.id,
                                                                             i_prof.institution,
                                                                             l_id_software));
                
                    IF l_param_def = 'Y'
                    THEN
                    
                        SELECT nvl((SELECT i.id_market
                                     FROM institution i
                                    WHERE i.id_institution = i_prof.institution),
                                   0)
                          INTO l_id_market
                          FROM dual;
                    
                        IF l_id_market != 0
                        THEN
                        
                            l_start_time := SYSDATE + 1 / 2000;
                            l_job_name   := 'DEFAULT_PREF' || to_char(o_id_dep_clin_serv(i)) || l_id_software;
                        
                            l_block := 'begin pk_default_inst_preferences.set_default_param_freq(' || i_lang ||
                                       ',profissional(' || i_prof.id || ',' || i_prof.institution || ',' ||
                                       i_prof.software || '),' || l_id_market || ',''' || l_param_def_vers || ''',' ||
                                       l_id_software || ',' || i_id_clin_service_ins(i) || ',' || o_id_dep_clin_serv(i) ||
                                       ',''' || l_job_name || '''); end;';
                        
                            new_job := sys.job(job_name       => l_job_name,
                                               job_style      => 'REGULAR',
                                               program_action => l_block,
                                               action_type    => 'PLSQL_BLOCK',
                                               number_of_args => 0,
                                               start_date     => l_start_time,
                                               comments       => 'Default ' || to_char(o_id_dep_clin_serv(i)) ||
                                                                 ' execution',
                                               max_failures   => 2,
                                               auto_drop      => TRUE,
                                               enabled        => TRUE);
                        
                            l_job_name_list.extend;
                            l_job_name_list(l_jb_idx) := l_job_name;
                            new_job_list.extend;
                            new_job_list(l_jb_idx) := new_job;
                            l_jb_idx := l_jb_idx + 1;
                        END IF;
                    
                    END IF;
                
                END LOOP;
                CLOSE c_soft;
            
            END IF;
        
        END LOOP;
    
        FOR i IN 1 .. i_id_department_del.count
        LOOP
            l_not_delete.extend;
        
            BEGIN
                g_error := 'DELETE FROM DEP_CLIN_SERV';
                UPDATE dep_clin_serv dcs
                   SET dcs.flg_available = pk_alert_constant.get_no
                 WHERE dcs.id_clinical_service = i_id_clin_service_del(i)
                   AND dcs.id_department = i_id_department_del(i)
                   AND dcs.flg_available = pk_alert_constant.get_available
                RETURNING dcs.id_dep_clin_serv INTO l_id_dep_clin_serv;
            END;
        
            FOR r_cur IN (SELECT *
                            FROM sch_event_dcs a
                           WHERE a.id_dep_clin_serv = l_id_dep_clin_serv)
            
            LOOP
                UPDATE sch_event_dcs a
                   SET flg_available = pk_alert_constant.g_no
                 WHERE a.id_sch_event_dcs = r_cur.id_sch_event_dcs;
            
                pk_ia_event_backoffice.sch_event_dcs_delete(r_cur.id_sch_event_dcs,
                                                            r_cur.id_sch_event,
                                                            r_cur.id_dep_clin_serv);
            END LOOP;
        
        END LOOP;
        IF NOT del_prof_dcs_cfg(i_lang, i_prof, i_id_department_del, i_id_clin_service_del, o_error)
        THEN
            g_error := 'DELETE FROM PROF_DEP_CLIN_SERV';
            RAISE e_child_remaining;
        END IF;
    
        IF l_job_name_list.count > 0
        THEN
            dbms_scheduler.create_jobs(new_job_list, 'TRANSACTIONAL');
        END IF;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN e_child_remaining THEN
        
            l_error := pk_message.get_message(i_lang, 'ADMINISTRATOR_ROOM_M001');
            pk_alert_exceptions.process_error(i_lang,
                                              'ADM_ROOM_M001',
                                              l_error,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_DEP_CLIN_SERV_NEW',
                                              'U',
                                              o_error);
        
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'SET_DEP_CLIN_SERV_NEW');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END set_dep_clin_serv_new;

    /** @headcom
    * Public Function. Insert New Relation(Department/Clinical Service) OR Update Relation(Department/Clinical Service) Information
    *
    * @param      I_LANG                               Language identification
    * @param      I_ID_DEPARTMENT                      Services identification
    * @param      I_ID_CLIN_SERVICE                    Clinical service identification
    * @param      I_CHANGE                             Clinical service change: Y - Insert; N - Remove
    * @param      O_ID_DEP_CLIN_SERV                   Department/clinical service identification
    * @param      O_ERROR                              Error 
    *
    * @value      I_CHANGE                             {*} 'Y' Insert {*} 'N' Remove
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/03/21
    */

    FUNCTION set_dep_clin_serv
    (
        i_lang             IN language.id_language%TYPE,
        i_id_department    IN table_number,
        i_id_clin_service  IN table_number,
        i_change           IN table_varchar,
        o_id_dep_clin_serv OUT table_number,
        o_error            OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_insert         table_number;
        l_insert_s       table_number;
        l_delete         table_number;
        l_delete_s       table_number;
        l_not_delete     table_number;
        l_not_delete_s   table_number;
        l_i              NUMBER;
        l_d              NUMBER;
        l_nd             NUMBER;
        l_id_institution institution.id_institution%TYPE;
    
    BEGIN
        g_sysdate          := SYSDATE;
        o_id_dep_clin_serv := table_number();
        l_insert           := table_number();
        l_insert_s         := table_number();
        l_delete           := table_number();
        l_delete_s         := table_number();
        l_not_delete       := table_number();
        l_not_delete_s     := table_number();
        l_i                := 1;
        l_d                := 1;
        l_nd               := 1;
    
        FOR i IN 1 .. i_id_clin_service.count
        LOOP
            IF i_change(i) = 'Y'
            THEN
                l_insert.extend;
                l_insert_s.extend;
                l_insert(l_i) := i_id_clin_service(i);
                l_insert_s(l_i) := i_id_department(i);
                l_i := l_i + 1;
            ELSE
                l_delete.extend;
                l_delete_s.extend;
                l_delete(l_d) := i_id_clin_service(i);
                l_delete_s(l_d) := i_id_department(i);
                l_d := l_d + 1;
            END IF;
        END LOOP;
    
        FOR i IN 1 .. l_insert.count
        LOOP
            o_id_dep_clin_serv.extend;
        
            SELECT d.id_institution
              INTO l_id_institution
              FROM department d
             WHERE d.id_department = i_id_department(i);
        
            o_id_dep_clin_serv(i) := get_next_value('DEP_CLIN_SERV', l_id_institution);
        
            g_error := 'INSERT INTO DEP_CLIN_SERV';
            INSERT INTO dep_clin_serv
                (id_dep_clin_serv, id_clinical_service, id_department, rank, adw_last_update, flg_available)
            VALUES
                (o_id_dep_clin_serv(i), l_insert(i), l_insert_s(i), 1, g_sysdate, 'Y');
        
        END LOOP;
    
        FOR i IN 1 .. l_delete.count
        LOOP
            l_not_delete.extend;
            l_not_delete_s.extend;
        
            BEGIN
                g_error := 'DELETE FROM DEP_CLIN_SERV';
                DELETE FROM dep_clin_serv d
                 WHERE d.id_clinical_service = l_delete(i)
                   AND d.id_department = l_delete_s(i);
            EXCEPTION
                WHEN OTHERS THEN
                    l_not_delete(l_nd) := l_delete(i);
                    l_not_delete_s(l_nd) := l_delete_s(i);
            END;
        END LOOP;
    
        COMMIT;
    
        IF l_not_delete.count != 0
        THEN
            g_error := 'erro..';
            FOR i IN 1 .. l_not_delete.count
            LOOP
                g_error := g_error + l_not_delete(i) + ' <--> ' + l_not_delete_s(i);
            END LOOP;
            RETURN FALSE;
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'SET_DEP_CLIN_SERV');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END set_dep_clin_serv;

    /** @headcom
    * Public Function. Get Relation(Department/Clinical Service) Information
    * 
    * @param      I_LANG                     Language identification
    * @param      i_id_department            Department identification
    * @param      O_REL                      Cursor with Department / clinicals service relation
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/03/21
    */
    FUNCTION get_dep_clin_serv
    (
        i_lang          IN language.id_language%TYPE,
        i_id_department IN dep_clin_serv.id_department%TYPE,
        o_rel           OUT pk_types.cursor_type,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET DEP_CLIN_SERV CURSOR';
        OPEN o_rel FOR
            SELECT d.id_dep_clin_serv, d.id_clinical_service, d.id_department
              FROM dep_clin_serv d
             WHERE id_department = i_id_department
               AND flg_available = g_flg_available
             ORDER BY id_clinical_service;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_rel);
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_DEP_CLIN_SERV');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_dep_clin_serv;

    /** @headcom
    * Public Function. Get Clinical Services List
    * 
    * @param      I_LANG                     Language identification
    * @param      O_CLIN_SERV                Cursor with clinical services list
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/04/13
    */
    FUNCTION get_clin_serv_list
    (
        i_lang      IN language.id_language%TYPE,
        o_clin_serv OUT pk_types.cursor_type,
        o_error     OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET CLIN_SERV CURSOR';
        OPEN o_clin_serv FOR
            SELECT cs.id_clinical_service, pk_translation.get_translation(i_lang, cs.code_clinical_service) cs_name
              FROM clinical_service cs
             WHERE cs.flg_available = 'Y'
             ORDER BY cs_name;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_clin_serv);
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_CLIN_SERV_LIST');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_clin_serv_list;

    /** @headcom
    * Public Function. Insert New Relation Department/Clinical Service Room OR Update Relation Department/Clinical Service Room Information
    *
    * @param      I_LANG                               Language identification
    * @param      I_ID_ROOM                            Room identification
    * @param      I_ID_DEP_CLIN_SERV                   Department/clinical service identification 
    * @param      O_ID_ROOM_DEP_CLIN_SERV              Cursor with rooms of departments/clinical services information
    * @param      O_ERROR                              Error 
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/04/23
    */
    FUNCTION set_room_dcs_no_commit
    (
        i_lang               IN language.id_language%TYPE,
        i_id_room            IN room_dep_clin_serv.id_room%TYPE,
        i_dep_clin_serv      IN table_number,
        o_room_dep_clin_serv OUT table_number,
        o_error              OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_sysdate := SYSDATE;
    
        g_error := 'DELETE FROM ROOM_DEP_CLIN_SERV';
        DELETE FROM room_dep_clin_serv
         WHERE id_room = i_id_room;
        o_room_dep_clin_serv := table_number();
    
        FORALL i IN 1 .. i_dep_clin_serv.count
            INSERT INTO room_dep_clin_serv
                (id_room_dep_clin_serv, id_room, id_dep_clin_serv)
            VALUES
                (seq_room_dep_clin_serv.nextval, i_id_room, i_dep_clin_serv(i))
            RETURNING id_room_dep_clin_serv BULK COLLECT INTO o_room_dep_clin_serv;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              k_owner,
                                              k_package_name,
                                              'SET_ROOM_DCS_NO_COMMIT',
                                              o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_room_dcs_no_commit;

    /** @headcom
    * Public Function. Insert New Room OR Update Room Information
    *
    * @param      I_LANG                               Language identification
    * @param      I_ID_ROOM                            Room identification
    * @param      I_FLG_PROP                           Indicates if it is a room for professionals
    * @param      I_ID_DEPARTMENT                      Indicates in which service the room is located
    * @param      I_DESC                               Room description
    * @param      I_FLG_RECOVERY                       Indicates if it is a recover or operating room
    * @param      I_FLG_LAB                            Indicates if it is a laboratory room
    * @param      I_FLG_WAIT                           Indicates if it is a wait room
    * @param      I_FLG_WL                             Room for Waiting Line
    * @param      I_FLG_TRANSP                         Indicates if it is a destination for patient transport
    * @param      I_CODE_ABBREVIATION                  Room name abreviation
    * @param      O_ID_ROOM                            Room identification
    * @param      O_ERROR                              Error 
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/03/27
    */
    FUNCTION set_room
    (
        i_lang              IN language.id_language%TYPE,
        i_id_room           IN room.id_room%TYPE,
        i_flg_prof          IN room.flg_prof%TYPE,
        i_id_department     IN room.id_department%TYPE,
        i_desc              IN VARCHAR2,
        i_flg_recovery      IN room.flg_recovery%TYPE,
        i_flg_lab           IN room.flg_lab%TYPE,
        i_flg_wait          IN room.flg_wait%TYPE,
        i_flg_wl            IN room.flg_wl%TYPE,
        i_flg_transp        IN room.flg_transp%TYPE,
        i_code_abbreviation IN room.code_abbreviation%TYPE,
        o_id_room           OUT room.id_room%TYPE,
        o_error             OUT t_error_out
    ) RETURN BOOLEAN IS
        l_id_institution institution.id_institution%TYPE;
        l_code_trl       translation.code_translation%TYPE := 'ROOM.CODE_ROOM.';
        l_code_abrev_trl translation.code_translation%TYPE := 'ROOM.CODE_ABBREVIATION.';
        my_exception EXCEPTION;
    BEGIN
        g_sysdate := SYSDATE;
    
        IF i_flg_prof IS NULL
        THEN
            g_error := 'Room for professional?';
            RAISE my_exception;
        ELSIF i_id_department IS NULL
        THEN
            g_error := 'Invalid Service';
            RAISE my_exception;
        ELSIF i_desc IS NULL
        THEN
            g_error := 'Invalid ROOM Name';
            RAISE my_exception;
        ELSIF i_flg_recovery IS NULL
        THEN
            g_error := 'Recovery Room? Y/N';
            RAISE my_exception;
        ELSIF i_flg_lab IS NULL
        THEN
            g_error := 'Laboratory Room? Y/N';
            RAISE my_exception;
        ELSIF i_flg_transp IS NULL
        THEN
            g_error := 'Transport?';
            RAISE my_exception;
        ELSIF i_flg_wait IS NULL
        THEN
            g_error := 'Waiting Room? Y/N';
            RAISE my_exception;
        ELSIF i_flg_wl IS NULL
        THEN
            g_error := 'Waiting Line Room? Y/N';
            RAISE my_exception;
        ELSIF i_id_room IS NULL
        THEN
            SELECT d.id_institution
              INTO l_id_institution
              FROM department d
             WHERE d.id_department = i_id_department;
        
            o_id_room := get_next_value('ROOM', l_id_institution);
        
            g_error := 'INSERT INTO ROOM';
            INSERT INTO room
                (id_room,
                 code_room,
                 flg_prof,
                 id_department,
                 flg_recovery,
                 flg_lab,
                 rank,
                 adw_last_update,
                 flg_wait,
                 flg_wl,
                 flg_transp,
                 flg_available)
            VALUES
                (o_id_room,
                 l_code_trl || o_id_room,
                 i_flg_prof,
                 i_id_department,
                 i_flg_recovery,
                 i_flg_lab,
                 0,
                 g_sysdate,
                 i_flg_wait,
                 i_flg_wl,
                 
                 i_flg_transp,
                 g_flg_available);
        
            pk_translation.insert_into_translation(i_lang, l_code_trl || o_id_room || '', i_desc);
            pk_translation.insert_into_translation(i_lang, l_code_abrev_trl || o_id_room || '', i_code_abbreviation);
        
        ELSE
            g_error := 'UPDATE ROOM';
            UPDATE room
               SET flg_prof        = i_flg_prof,
                   id_department   = i_id_department,
                   flg_recovery    = i_flg_recovery,
                   flg_lab         = i_flg_lab,
                   rank            = 0,
                   adw_last_update = g_sysdate,
                   flg_wait        = i_flg_wait,
                   flg_wl          = i_flg_wl,
                   flg_transp      = i_flg_transp
             WHERE id_room = i_id_room;
        
            o_id_room := i_id_room;
        
            pk_translation.insert_into_translation(i_lang, l_code_trl || o_id_room || '', i_desc);
            pk_translation.insert_into_translation(i_lang, l_code_abrev_trl || o_id_room || '', i_code_abbreviation);
        
        END IF;
    
        COMMIT;
        RETURN TRUE;
    
    EXCEPTION
        WHEN my_exception THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_ROOM',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
        WHEN OTHERS THEN
        
            DECLARE
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'SET_ROOM');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END set_room;

    /** @headcom
    * Public Function. Get Room List
    * 
    * @param      I_LANG                     Language identification
    * @param      I_ID_DEPARTMENT            Service identification
    * @param      O_ROOM_LIST                Cursor with room information
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/03/27
    */
    FUNCTION get_room_list
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        o_room_list      OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET ROOM_LIST CURSOR';
        OPEN o_room_list FOR
            SELECT r.id_room id_room,
                   nvl(r.desc_room, pk_translation.get_translation(i_lang, r.code_room)) room_name,
                   r.id_department id_service,
                   pk_translation.get_translation(i_lang, serv.code_department) service_name,
                   d.id_dept id_dept,
                   pk_translation.get_translation(i_lang, d.code_dept) dept_name,
                   nvl(r.desc_room_abbreviation, pk_translation.get_translation(i_lang, r.code_abbreviation)) abbreviation,
                   r.flg_prof,
                   pk_sysdomain.get_domain('YES_NO', nvl(r.flg_prof, 'Y'), i_lang) prof,
                   r.flg_recovery,
                   pk_sysdomain.get_domain('YES_NO', nvl(r.flg_recovery, 'Y'), i_lang) recovery,
                   r.flg_lab,
                   pk_sysdomain.get_domain('YES_NO', nvl(r.flg_lab, 'Y'), i_lang) lab,
                   r.flg_wait,
                   pk_sysdomain.get_domain('YES_NO', nvl(r.flg_wait, 'Y'), i_lang) wait,
                   r.flg_wl,
                   pk_sysdomain.get_domain('YES_NO', nvl(r.flg_wl, 'Y'), i_lang) wl,
                   r.flg_transp,
                   pk_sysdomain.get_domain('YES_NO', nvl(r.flg_transp, 'Y'), i_lang) transp
              FROM room r, dept d, department serv
             WHERE serv.id_institution = i_id_institution
               AND r.id_department = serv.id_department
               AND serv.id_dept = d.id_dept
               AND d.id_institution = serv.id_institution
               AND r.flg_available = g_flg_available
             ORDER BY room_name;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            DECLARE
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
            
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_ROOM_LIST');
                pk_utils.undo_changes;
                pk_types.open_my_cursor(o_room_list);
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_room_list;

    /** @headcom
    * Public Function. Get Room DEP_CLIN_SERV List
    * 
    * @param      I_LANG                     Language identification
    * @param      I_ID_ROOM                  Room identification
    * @param      O_DEP_CLIN_SERV_LIST       Cursor with clinical service identification
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/07/29
    */
    FUNCTION get_room_dep_clin_serv
    (
        i_lang               IN language.id_language%TYPE,
        i_id_room            IN room_dep_clin_serv.id_room%TYPE,
        o_dep_clin_serv_list OUT pk_types.cursor_type,
        o_error              OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET DEP_CLIN_SERV_LIST CURSOR';
        OPEN o_dep_clin_serv_list FOR
            SELECT rdcs.id_dep_clin_serv, pk_translation.get_translation(i_lang, cs.code_clinical_service) esp
              FROM room_dep_clin_serv rdcs, clinical_service cs, dep_clin_serv dcs
             WHERE rdcs.id_room = i_id_room
               AND rdcs.id_dep_clin_serv = dcs.id_dep_clin_serv
               AND dcs.id_clinical_service = cs.id_clinical_service
             ORDER BY esp;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_dep_clin_serv_list);
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_ROOM_DEP_CLIN_SERV');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_room_dep_clin_serv;

    /** @headcom
    * Public Function. Get Institution List for a particular professional
    * 
    * @param      I_LANG                     Language identification
    * @param      i_prof                     Profissioanl (professional identification, institution identification, software identification)         
    * @param      i_id_professional          Professional identification
    * @param      O_INST                     Cursor with relation between profesisonal and institution 
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/03/28
    */
    FUNCTION get_prof_institution_list
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN profissional,
        i_id_professional IN prof_institution.id_professional%TYPE,
        o_inst            OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET CURSOR INST';
        -- 30/05/2011 RMGM: changed to ansi, [ALERT-151190] 
        -- added validation if professional still having active session in DB
        OPEN o_inst FOR
            SELECT pi.id_prof_institution,
                   pk_translation.get_translation(i_lang, i.code_institution) instituicao,
                   pk_translation.get_translation(i_lang, c.code_category) categoria,
                   pi.flg_state,
                   pk_sysdomain.get_domain('PROF_INSTITUTION.FLG_STATE', nvl(pi.flg_state, 'A'), i_lang) estado,
                   pk_sysdomain.get_img(i_lang, 'PROF_INSTITUTION.FLG_STATE', nvl(pi.flg_state, 'A')) icon,
                   pi.id_institution
              FROM prof_institution pi
             INNER JOIN institution i
                ON (i.id_institution = pi.id_institution AND i.flg_available = 'Y')
             INNER JOIN prof_cat pc
                ON (pc.id_professional = pi.id_professional AND pc.id_institution = pi.id_institution)
             INNER JOIN category c
                ON (c.id_category = pc.id_category AND c.flg_available = 'Y')
             WHERE pi.id_professional = i_id_professional
               AND pi.dt_end_tstz IS NULL
               AND pi.id_institution IN (SELECT id_institution
                                           FROM prof_institution
                                          WHERE id_professional = i_prof.id
                                            AND flg_state = g_active)
             ORDER BY instituicao;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_PROF_INSTITUTION_LIST');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_prof_institution_list;

    /** @headcom
    * Public Function. Get Categories List
    * 
    * @param      I_LANG                     Language identification 
    * @param      O_CAT                      Cursor with category information
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/03/28
    */
    FUNCTION get_prof_cat_list
    (
        i_lang  IN language.id_language%TYPE,
        o_cat   OUT pk_types.cursor_type,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET CURSOR CAT';
        OPEN o_cat FOR
            SELECT pk_translation.get_translation(i_lang, code_category) categoria
              FROM category
             WHERE flg_available = g_flg_avail
             ORDER BY categoria;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_PROF_CAT_LIST');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_prof_cat_list;

    /** @headcom
    * Public Function. Get professional personal info
    * 
    * @param      I_LANG                        Language identification
    * @param      I_PROF                        Object Profissional (professional identification, institution identification,software identification)
    * @param      I_ID_PROF                     Professioanl identification
    * @param      I_ID_INSTITUTION              Institution identification
    * @param      O_PROF_PERSONAL_DATA          Cursor with professioanl personal data
    * @param      O_ERROR                       Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/06/18
    */
    FUNCTION get_prof_personal_data
    (
        i_lang               IN language.id_language%TYPE,
        i_prof               IN profissional,
        i_id_prof            IN professional.id_professional%TYPE,
        i_id_institution     IN prof_institution.id_institution%TYPE,
        o_prof_personal_data OUT pk_types.cursor_type,
        o_error              OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET PERSONAL DATA';
        OPEN o_prof_personal_data FOR
            SELECT DISTINCT p.name,
                            p.nick_name,
                            p.initials,
                            pk_date_utils.dt_chr(i_lang, p.dt_birth, i_prof) date_birth,
                            pk_sysdomain.get_domain('PROFESSIONAL.GENDER', p.gender, i_lang) desc_gender,
                            pk_sysdomain.get_domain('PROFESSIONAL.MARITAL_STATUS', p.marital_status, i_lang) desc_marital_status,
                            p.gender,
                            p.marital_status
              FROM professional p
             WHERE p.id_professional = i_id_prof
               AND nvl(p.flg_prof_test, pk_alert_constant.get_no) = pk_alert_constant.get_no;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_prof_personal_data);
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_PROF_PERSONAL_DATA');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_prof_personal_data;

    /** @headcom
    * Public Function. Get professional adress info
    * 
    * @param      I_LANG                        Language department
    * @param      I_PROF                        Object Profissional (professional identification, institution identification,software identification)
    * @param      I_ID_PROF                     Professional identification
    * @param      I_ID_INSTITUTION              Institution identification
    * @param      O_PROF_ADRESS_DATA            Adress
    * @param      O_ERROR                       Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/06/18
    */
    FUNCTION get_prof_adress_data
    (
        i_lang             IN language.id_language%TYPE,
        i_prof             IN profissional,
        i_id_prof          IN professional.id_professional%TYPE,
        i_id_institution   IN prof_institution.id_institution%TYPE,
        o_prof_adress_data OUT pk_types.cursor_type,
        o_error            OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET ADRESS DATA';
        OPEN o_prof_adress_data FOR
            SELECT DISTINCT p.address,
                            p.city,
                            p.district,
                            p.zip_code,
                            pk_translation.get_translation(i_lang, c.code_country) countr,
                            p.id_country
              FROM professional p, country c
             WHERE p.id_professional = i_id_prof
               AND p.id_country = c.id_country(+)
               AND nvl(p.flg_prof_test, pk_alert_constant.get_no) = pk_alert_constant.get_no;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_prof_adress_data);
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_PROF_ADRESS_DATA');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_prof_adress_data;

    /** @headcom
    * Public Function. Getinfo
    * 
    * @param      I_LANG                        Language identification
    * @param      I_PROF                        Object Profissional (professional identification, institution identification,software identification)
    * @param      I_ID_PROF                     Professional identification
    * @param      I_ID_INSTITUTION              Institution identification
    * @param      O_PROF_PROFESSIONAL_DATA      Cursor withpersonal data
    * @param      O_ERROR                       Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/06/18
    */
    FUNCTION get_prof_professional_data
    (
        i_lang                   IN language.id_language%TYPE,
        i_prof                   IN profissional,
        i_id_prof                IN professional.id_professional%TYPE,
        i_id_institution         IN prof_institution.id_institution%TYPE,
        o_prof_professional_data OUT pk_types.cursor_type,
        o_error                  OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET PROFESSIONAL DATA';
        OPEN o_prof_professional_data FOR
            SELECT DISTINCT pk_translation.get_translation(i_lang, s.code_speciality) spec,
                            p.id_speciality,
                            pk_translation.get_translation(i_lang, ca.code_category) categoria,
                            pi.flg_state,
                            pk_sysdomain.get_domain('PROF_INSTITUTION.FLG_STATE', nvl(pi.flg_state, 'A'), i_lang) estado,
                            pi.num_mecan,
                            pc.id_category_sub,
                            pk_translation.get_translation(i_lang, cs.code_category_sub) desc_cat_sub,
                            pp.id_language,
                            l.desc_language
              FROM professional     p,
                   speciality       s,
                   category         ca,
                   prof_cat         pc,
                   prof_institution pi,
                   institution      i,
                   prof_preferences pp,
                   LANGUAGE         l,
                   category_sub     cs
             WHERE p.id_professional = i_id_prof
               AND p.id_speciality = s.id_speciality(+)
               AND nvl(p.flg_prof_test, pk_alert_constant.get_no) = pk_alert_constant.get_no
               AND pc.id_category = ca.id_category
               AND pi.id_professional = i_id_prof
               AND i.id_institution = pi.id_institution
               AND pc.id_professional = pi.id_professional
               AND pi.id_institution = i_id_institution
               AND pc.id_professional = i_id_prof
               AND pc.id_category = ca.id_category
               AND pp.id_professional = i_id_prof
               AND pp.id_institution LIKE nvl(to_char(i_id_institution), '%')
               AND pp.id_language = l.id_language
               AND pc.id_category_sub = cs.id_category_sub(+);
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_prof_professional_data);
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_PROF_PROFESSIONAL_DATA');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_prof_professional_data;

    /** @headcom
    * Public Function. Get professional contact info
    * 
    * @param      I_LANG                        Language identification
    * @param      I_PROF                        Object Profissional (professional identification, institution identification,software identification)
    * @param      I_ID_PROF                     Professional identification
    * @param      I_ID_INSTITUTION              Institution identification
    * @param      O_PROF_CONTACT_DATA           Professional contact data 
    * @param      O_ERROR                       Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/06/18
    */
    FUNCTION get_prof_contact_data
    (
        i_lang              IN language.id_language%TYPE,
        i_prof              IN profissional,
        i_id_prof           IN professional.id_professional%TYPE,
        i_id_institution    IN prof_institution.id_institution%TYPE,
        o_prof_contact_data OUT pk_types.cursor_type,
        o_error             OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET CONTACT DATA';
        OPEN o_prof_contact_data FOR
            SELECT DISTINCT p.num_contact
              FROM professional p
             WHERE p.id_professional = i_id_prof;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_prof_contact_data);
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_PROF_CONTACT_DATA');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_prof_contact_data;

    /** @headcom
    * Public Function. Get general institution data
    * 
    * @param      I_LANG                        Language identification
    * @param      I_PROF                        Object Profissional (professional identification, institution identification,software identification)
    * @param      I_ID_INSTITUTION              Institution identification
    * @param      O_INST_GENERAL_DATA           Institution general data
    * @param      O_ERROR                       Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/06/19
    */
    FUNCTION get_inst_general_data
    (
        i_lang              IN language.id_language%TYPE,
        i_prof              IN profissional,
        i_id_institution    IN institution.id_institution%TYPE,
        o_inst_general_data OUT pk_types.cursor_type,
        o_error             OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET GENERAL DATA';
        OPEN o_inst_general_data FOR
            SELECT pk_translation.get_translation(i_lang, i.code_institution) institution_name,
                   i.flg_type,
                   pk_sysdomain.get_domain('AB_INSTITUTION.FLG_TYPE', nvl(i.flg_type, NULL), i_lang) institution_type,
                   i.abbreviation,
                   i.id_parent,
                   pk_translation.get_translation(i_lang,
                                                  (SELECT code_institution
                                                     FROM institution
                                                    WHERE id_institution = i.id_parent)) institution_parent,
                   i.phone_number
              FROM institution i
             WHERE id_institution = i_id_institution;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_inst_general_data);
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_INST_GENERAL_DATA');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_inst_general_data;

    /** @headcom
    * Public Function. Get adress institution info
    * 
    * @param      I_LANG                        Language identification
    * @param      I_PROF                        Object Profissional (professional identification, institution identification,software identification)
    * @param      I_ID_INSTITUTION              Institution identification
    * @param      O_INST_ADRESS_DATA            Address 
    * @param      O_ERROR                       Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/06/19
    */
    FUNCTION get_inst_adress_data
    (
        i_lang             IN language.id_language%TYPE,
        i_prof             IN profissional,
        i_id_institution   IN institution.id_institution%TYPE,
        o_inst_adress_data OUT pk_types.cursor_type,
        o_error            OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        g_error := 'GET ADRESS DATA';
        OPEN o_inst_adress_data FOR
            SELECT i.address, i.location, i.district, i.zip_code
              FROM institution i
             WHERE id_institution = i_id_institution;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_inst_adress_data);
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_INST_ADRESS_DATA');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_inst_adress_data;

    FUNCTION get_inst_adress
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN profissional,
        i_id_institution IN institution.id_institution%TYPE,
        o_inst_address   OUT VARCHAR2,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        g_error := 'GET ADRESS DATA';
        SELECT i.address || g_field_separator || i.zip_code || g_field_separator || i.location || g_field_separator ||
               i.district
          INTO o_inst_address
          FROM institution i
         WHERE id_institution = i_id_institution;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_INST_ADRESS_DATA');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_inst_adress;

    /** @headcom
    * Public Function. Get administrator institution info
    * 
    * @param      I_LANG                        Language identification
    * @param      I_PROF                        Professional (Profissional identification, institution identification, software identification)
    * @param      I_ID_INSTITUTION              Institution identification
    * @param      O_INST_ADM_DATA               Institution administrator
    * @param      O_ERROR                       Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/06/19
    */
    FUNCTION get_inst_adm_data
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN profissional,
        i_id_institution IN institution.id_institution%TYPE,
        o_inst_adm_data  OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET ADMINISTRATOR DATA';
        OPEN o_inst_adm_data FOR
            SELECT p.name, p.nick_name, p.num_contact
              FROM institution i, prof_profile_template ppt, professional p
             WHERE i.id_institution = i_id_institution
               AND ppt.id_institution = i.id_institution
               AND ppt.id_profile_template = 690
               AND p.id_professional = ppt.id_professional;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_inst_adm_data);
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_INST_ADM_DATA');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_inst_adm_data;

    /** @headcom
    * Public Function. Get license institution info
    * 
    * @param      I_LANG                        Language identification
    * @param      I_PROF                        Professional (Profissional identification, institution identification, software identification)
    * @param      I_ID_INSTITUTION              Institution identification
    * @param      O_INST_LICENSE_DATA           Licences model
    * @param      O_ERROR                       Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/06/19
    */
    FUNCTION get_inst_license_data
    (
        i_lang              IN language.id_language%TYPE,
        i_prof              IN profissional,
        i_id_institution    IN institution.id_institution%TYPE,
        o_inst_license_data OUT pk_types.cursor_type,
        o_error             OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET LICENSE DATA';
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_inst_license_data);
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_INST_LICENSE_DATA');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
    END get_inst_license_data;

    /** @headcom
    * Public Function. Get Institution Information List
    *
    * @param      I_LANG                     Language identification
    * @param      I_FLG_TYPE                 Institution type
    * @param      I_ID_PROFESSIONAL          Professional identification 
    * @param      O_INST_LIST                Cursor with institution information
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/06/20
    */
    FUNCTION get_institution_list
    (
        i_lang            IN language.id_language%TYPE,
        i_flg_type        IN institution.flg_type%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        o_inst_list       OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        IF i_id_professional IS NULL
        THEN
            g_error := 'GET INSTITUTION CURSOR';
            OPEN o_inst_list FOR
                SELECT i.id_institution id,
                       pk_translation.get_translation(i_lang, i.code_institution) name,
                       pk_sysdomain.get_domain('AB_INSTITUTION.FLG_TYPE', nvl(i.flg_type, NULL), i_lang) TYPE,
                       i.flg_available,
                       pk_sysdomain.get_domain('AB_INSTITUTION.FLG_AVAILABLE', nvl(i.flg_available, 'Y'), i_lang) state,
                       pk_sysdomain.get_img(i_lang, 'AB_INSTITUTION.FLG_AVAILABLE', i.flg_available) image,
                       decode(i.id_parent,
                              NULL,
                              pk_sysdomain.get_domain('AB_INSTITUTION.GROUP', 'M', i_lang),
                              pk_sysdomain.get_domain('AB_INSTITUTION.GROUP', 'A', i_lang)) grupo,
                       decode(i.id_parent, NULL, 'M', 'A') flg_grupo,
                       i.id_parent
                  FROM institution i
                 WHERE ((i.flg_type = i_flg_type AND i_flg_type IS NOT NULL) OR i_flg_type IS NULL)
                 ORDER BY name;
        ELSE
            OPEN o_inst_list FOR
                SELECT i.id_institution id,
                       pk_translation.get_translation(i_lang, i.code_institution) name,
                       pk_sysdomain.get_domain('AB_INSTITUTION.FLG_TYPE', nvl(i.flg_type, NULL), i_lang) TYPE,
                       i.flg_available,
                       pk_sysdomain.get_domain('AB_INSTITUTION.FLG_AVAILABLE', nvl(i.flg_available, 'Y'), i_lang) state,
                       pk_sysdomain.get_img(i_lang, 'AB_INSTITUTION.FLG_AVAILABLE', i.flg_available) image,
                       decode(i.id_parent,
                              NULL,
                              pk_sysdomain.get_domain('AB_INSTITUTION.GROUP', 'M', i_lang),
                              pk_sysdomain.get_domain('AB_INSTITUTION.GROUP', 'A', i_lang)) grupo,
                       decode(i.id_parent, NULL, 'M', 'A') flg_grupo,
                       i.id_parent
                  FROM prof_profile_template ppt, institution i
                 WHERE ppt.id_professional = i_id_professional
                   AND ppt.id_profile_template = 30
                   AND (i.id_institution = ppt.id_institution OR i.id_parent = ppt.id_institution)
                 ORDER BY flg_grupo DESC;
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_inst_list);
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_INSTITUTION_LIST');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_institution_list;

    /** @headcom
    * Public Function. Get Currency List
    *
    * @param      I_LANG                     Language identification
    * @param      O_CURRENCY                 Cursor
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/07/16
    */
    FUNCTION get_currency_list
    (
        i_lang     IN language.id_language%TYPE,
        o_currency OUT pk_types.cursor_type,
        o_error    OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET CURRENCY CURSOR';
        OPEN o_currency FOR
            SELECT c.id_currency,
                   c.currency_desc currency,
                   pk_translation.get_translation(i_lang, c.code_currency) currency_desc
              FROM currency c;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_currency);
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_CURRENCY_LIST');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_currency_list;

    /** @headcom
    * Public Function. Get Languages List
    *
    * @param      I_LANG                     Language identification
    * @param      O_LANGUAGE                 Cursor with language identification
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     SS
    * @version    0.1
    * @since      2005/11/03
    */
    FUNCTION get_language_list
    (
        i_lang     IN language.id_language%TYPE,
        i_prof     IN profissional,
        o_language OUT pk_types.cursor_type,
        o_error    OUT t_error_out
    ) RETURN BOOLEAN IS
        l_value VARCHAR2(4000);
    BEGIN
    
        l_value := pk_sysconfig.get_config('LANGUAGE', i_prof);
    
        g_error := 'GET CURSOR';
        OPEN o_language FOR
            SELECT l.id_language,
                   pk_translation.get_translation(i_lang, l.code_language) desc_language,
                   decode(l_value, id_language, 'Y', 'N') flg_default
              FROM LANGUAGE l
             WHERE flg_available = g_flg_avail
             ORDER BY desc_language;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_LANGUAGE_LIST',
                                              o_error);
            pk_types.open_my_cursor(o_language);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
    END get_language_list;

    /** @headcom
    * Public Function. Get Institution Type List
    *
    * @param      I_LANG                     Language identification
    * @param      O_INST_LIST                Cursor with institution type information
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/04/17
    */
    FUNCTION get_institution_type_list
    (
        i_lang      IN language.id_language%TYPE,
        o_inst_type OUT pk_types.cursor_type,
        o_error     OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET INSTITUTION TYPE CURSOR';
        OPEN o_inst_type FOR
            SELECT val, desc_val
              FROM sys_domain
             WHERE code_domain = 'AB_INSTITUTION.FLG_TYPE'
               AND domain_owner = pk_sysdomain.k_default_schema
               AND flg_available = g_flg_available
               AND id_language = i_lang
             ORDER BY rank;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            RETURN FALSE;
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_inst_type);
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_INSTITUTION_TYPE_LIST');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_institution_type_list;

    /** @headcom
    * Public Function. Get Institution Type List
    *
    * @param      I_LANG                     Language identification
    * @param      O_GROUP_TYPE               Cursor with institution group information 
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/07/23
    */
    FUNCTION get_institution_group_list
    (
        i_lang       IN language.id_language%TYPE,
        o_group_type OUT pk_types.cursor_type,
        o_error      OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET INSTITUTION GROUP CURSOR';
        OPEN o_group_type FOR
            SELECT val, desc_val
              FROM sys_domain
             WHERE code_domain = 'AB_INSTITUTION.GROUP'
               AND domain_owner = pk_sysdomain.k_default_schema
               AND flg_available = g_flg_available
               AND id_language = i_lang
             ORDER BY rank;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_group_type);
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_INSTITUTION_GROUP_LIST');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_institution_group_list;

    /** @headcom
    * Public Function. Get Institution Type Licenses
    * Devolve as instituições, o tipo e o número de licenças em cada instituição
    *
    * @param      I_LANG                     Identificação do Idioma
    * @param      I_ID_PROFESSIONAL          Identificação do Profissional
    * @param      O_INST_LIST                Cursor com a informação das instituições
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenço - EL
    * @version    0.1
    * @since      2007/07/18
    */
    FUNCTION get_institution_type_licenses
    (
        i_lang            IN language.id_language%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        o_inst_list       OUT pk_types.cursor_type,
        o_error           OUT t_error_out
        
    ) RETURN BOOLEAN IS
        sql_stmt VARCHAR2(1000);
    BEGIN
        g_error  := 'GET INSTITUTION TYPE LICENSES CURSOR';
        sql_stmt := 'SELECT i.id_institution,
                   pk_translation.get_translation(:i_lang, i.code_institution) desc_institution,
                   pk_sysdomain.get_domain(''AB_INSTITUTION.FLG_TYPE'', nvl(i.flg_type, NULL), :i_lang) TYPE,
                   (SELECT COUNT(*)
                      FROM aol.license aol_l
                     WHERE aol_l.id_institution = i.id_institution
                       AND aol_l.flg_status IN (:g_flg_avail, ''W'', ''C'')
                       AND aol_l.id_profile_template_desc IS NOT NULL) counter
              FROM prof_profile_template ppt, institution i
             WHERE ppt.id_professional = :i_id_professional
               AND ppt.id_profile_template = 30
               AND (i.id_institution = ppt.id_institution OR i.id_parent = ppt.id_institution)
               AND i.flg_available = :g_flg_avail
             ORDER BY desc_institution';
        OPEN o_inst_list FOR sql_stmt
            USING i_lang, i_lang, g_flg_avail, i_id_professional, g_flg_avail;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_inst_list);
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_INSTITUTION_TYPE_LICENSES');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_institution_type_licenses;

    /** @headcom
    * Public Function. Get Professional Licenses
    * Devolve os profissionais e as respectivas licenças para uma determinada instituição.
    * O tipo representado pela flag poder?ser clínico, não clínico ou todos (null)
    * 
    * @param      I_LANG                     Identificação do Idioma
    * @param      i_prof                     
    * @param      I_ID_INSTITUTION           Identificação da Instituição
    * @param      I_FLG_TYPE                 Identificação do Tipo de Profissionais
    * @param      I_SEARCH                   palavra a pesquisar
    * @param      O_PROF_LIC_LIST            Cursor com a informação de profissionais e licenças
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenço - EL
    * @version    0.1
    * @since      2007/07/19
    */
    FUNCTION get_professional_licenses
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN profissional,
        i_id_institution IN institution.id_institution%TYPE,
        i_flg_type       IN category.flg_type%TYPE,
        i_search         IN VARCHAR2,
        o_prof_lic_list  OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
        sql_stmt VARCHAR2(10000);
    BEGIN
    
        g_error  := 'GET PROFESSIONAL LICENSES CURSOR';
        sql_stmt := 'SELECT NULL id_professional,
                   NULL photo,
                   NULL name,
                   l.id_license,
                   ptd.desc_profile_template profile,
                   pk_date_utils.date_chr_extend_tsz(' || i_lang ||
                    ', l.dt_expire_tstz, profissional( ' || i_prof.id || ', ' || i_prof.institution || ',
                    ' || i_prof.software ||
                    ')) dt_expire,
                   l.flg_status status,
                   pk_sysdomain.get_domain(''AOL.LICENSE.FLG_STATUS'', l.flg_status, ' || i_lang ||
                    ') estado,
                   pk_sysdomain.get_img(' || i_lang || ', ''AOL.LICENSE.FLG_STATUS'', l.flg_status) status_image,
                   ''Y'' flg_professional
              FROM license l, profile_template_desc ptd
             WHERE (l.id_institution = ' || i_id_institution || ' OR
                   l.id_institution = (SELECT i.id_parent
                                              FROM institution i
                                             WHERE i.id_institution = ' || i_id_institution || '))
               AND l.flg_status IN (''' || g_flg_available ||
                    ''', ''C'', ''W'')
               AND l.id_professional IS NULL ' || 'AND ptd.id_profile_template_desc = l.id_profile_template_desc
               AND (''' || i_flg_type || ''' IS NULL OR ' ||
                    'ptd.id_profile_template IN
                   (SELECT pt.id_profile_template
                       FROM profile_template pt
                      WHERE pt.flg_group =  ''' || i_flg_type || '''))
            UNION ' || 'SELECT p.id_professional,
                   pk_backoffice.get_prof_photo_url(' || i_lang ||
                    ', p.id_professional) photo,
                   p.name,
                   lic.id_license,
                   ptd.desc_profile_template profile,
                   pk_date_utils.date_chr_extend_tsz(' || i_lang ||
                    ', lic.dt_expire_tstz, profissional(' || i_prof.id || ', ' || i_prof.institution || ',
                    ' || i_prof.software ||
                    ')) dt_expire,
                   lic.flg_status status,
                   pk_sysdomain.get_domain(''AOL.LICENSE.FLG_STATUS'', lic.flg_status, ' || i_lang ||
                    ') estado,
                   pk_sysdomain.get_img(' || i_lang ||
                    ', ''AOL.LICENSE.FLG_STATUS'', lic.flg_status) status_image,
                   ''Y'' flg_professional
              FROM license lic, profile_template pt, profile_template_desc ptd, professional p
             WHERE lic.id_professional IS NOT NULL
               AND lic.id_professional = p.id_professional
               AND pk_prof_utils.is_internal_prof(i_lang, i_prof, p.id_professional, ' ||
                    i_id_institution || ')
               AND lic.id_institution = ' || i_id_institution || '
               AND lic.id_profile_template_desc = ptd.id_profile_template_desc
               AND ptd.id_profile_template = pt.id_profile_template
               AND pt.flg_group = ''' || i_flg_type || '''
               AND lic.flg_status IN (''' || g_flg_available ||
                    ''', ''C'', ''W'') 
               --
               AND translate(upper(p.name),
                                 ''ÁÉÍÓÚÀÈÌÒÙÂÊÎÔÛÃÕÇÄËÏÖÜÑ'',
                                 ''AEIOUAEIOUAEIOUAOCAEIOUN'') LIKE
                       ''%'' || translate(upper(''' || i_search || '''),
                                        ''ÁÉÍÓÚÀÈÌÒÙÂÊÎÔÛÃÕÇÄËÏÖÜÑ '',
                                        ''AEIOUAEIOUAEIOUAOCAEIOUN%'') || ''%''
               --
               ' || 'UNION
                               SELECT p.id_professional,
                                      pk_backoffice.get_prof_photo_url(' || i_lang ||
                    ', p.id_professional) photo,
                                      p.name,
                                      NULL id_license,
                                      ptd.desc_profile_template profile,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL,
                                      NULL flg_professional
                                 FROM prof_institution      pi,
                                      professional          p,
                                      profile_template      pt,
                                      prof_profile_template ppt,
                                      software              s,
                                      profile_template_desc ptd
                                WHERE pi.id_institution = ' || i_id_institution || '
                                  AND pi.flg_state = ''' || g_active || '''
                                  AND p.flg_state = ''' || g_active || '''
                                  AND nvl(p.flg_prof_test, pk_alert_constant.get_no) = pk_alert_constant.get_no
                                  AND p.id_professional = pi.id_professional
                                  AND p.id_professional NOT IN (SELECT lic.id_professional
                                                                  FROM license lic
                                                                 WHERE lic.id_institution = pi.id_institution
                                                                   AND lic.id_professional IS NOT NULL)
                                  AND ppt.id_profile_template = pt.id_profile_template
                                  AND ppt.id_professional = pi.id_professional
                                  AND ppt.id_institution = pi.id_institution
                                  AND pt.flg_group = ''' || i_flg_type || '''
                                  AND s.flg_viewer = ''N''
                                  AND pt.id_software = s.id_software
                                  AND pt.id_profile_template = ptd.id_profile_template 
                                  --
                                   AND translate(upper(p.name),
                                                     ''ÁÉÍÓÚÀÈÌÒÙÂÊÎÔÛÃÕÇÄËÏÖÜÑ'',
                                                     ''AEIOUAEIOUAEIOUAOCAEIOUN'') LIKE
                                           ''%'' || translate(upper(''' || i_search ||
                    '''),
                                                            ''ÁÉÍÓÚÀÈÌÒÙÂÊÎÔÛÃÕÇÄËÏÖÜÑ '',
                                                            ''AEIOUAEIOUAEIOUAOCAEIOUN%'') || ''%''
                                   --
               ' ||
                   
                    ' UNION
                             
                             SELECT NULL id_professional,
                                    NULL photo,
                                    NULL name,
                                    l.id_license,
                                    to_char(ppd.product_purchasable_desc) profile,
                                   pk_date_utils.date_chr_extend_tsz(' || i_lang ||
                    ', l.dt_expire_tstz, profissional(' || i_prof.id || ', ' || i_prof.institution || ',
                    ' || i_prof.software ||
                    ')) dt_expire,
                                   l.flg_status status,
                                   pk_sysdomain.get_domain(''AOL.LICENSE.FLG_STATUS'', l.flg_status, ' ||
                    i_lang || ') estado,
                                   pk_sysdomain.get_img(' || i_lang ||
                    ', ''AOL.LICENSE.FLG_STATUS'', l.flg_status) status_image,
                                   ''N'' flg_professional
                              FROM license l, product_purchasable_desc ppd, product_purchasable pp                              
                             WHERE (l.id_institution = ' || i_id_institution || ' OR
                                   l.id_institution = (SELECT i.id_parent
                                                              FROM institution i
                                                             WHERE i.id_institution = ' ||
                    i_id_institution || '))
                               AND pp.id_product_purchasable=ppd.id_product_purchasable
                               AND l.flg_status IN (''' || g_flg_available || ''', ''C'', ''W'') ' ||
                    'AND ppd.id_product_purchasable = l.id_product_purchasable
                               AND (''' || i_flg_type || ''' IS NULL OR ' || '''' || i_flg_type ||
                    ''' = ''' || g_flg_nonclinical || ''') AND pp.license_model = ''L'' ORDER BY id_professional DESC';
    
        pk_alertlog.log_debug(substr(sql_stmt, 0, 2000));
        pk_alertlog.log_debug(substr(sql_stmt, 2001, 2000));
        pk_alertlog.log_debug(substr(sql_stmt, 4001, 2000));
        pk_alertlog.log_debug(substr(sql_stmt, 6001, 2000));
        pk_alertlog.log_debug(substr(sql_stmt, 8001, 2000));
    
        OPEN o_prof_lic_list FOR sql_stmt;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_prof_lic_list);
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_PROFESSIONAL_LICENSES');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_professional_licenses;

    /** @headcom
    * Public Function. Get Profile Licenses
    * Devolve o número de licenças por perfil para uma determinada instituição.
    * 
    * @param      I_LANG                     Identificação do Idioma
    * @param      I_ID_INSTITUTION           Identificação da Instituição
    * @param      O_PROF_LIC_LIST            Cursor com a informação de profissionais e licenças
    * @param      o_total_lic
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenço - EL
    * @version    0.1
    * @since      2007/07/19
    */
    FUNCTION get_profile_licenses
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        o_prof_lic_list  OUT pk_types.cursor_type,
        o_total_lic      OUT NUMBER,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
        sql_stmt VARCHAR2(1000);
    BEGIN
        g_error  := 'GET PROFILE LICENSES CURSOR';
        sql_stmt := 'SELECT ptd.desc_profile_template profile,
                   COUNT(*) counter
              FROM license l, profile_template_desc ptd
             WHERE l.id_institution = :i_id_institution
               AND l.flg_status IN (:g_flg_available, :g_flg_waiting, :g_flg_cancel)
               AND l.id_profile_template_desc IS NOT NULL
               and ptd.id_profile_template_desc = l.id_profile_template_desc
             GROUP BY ptd.desc_profile_template
             ORDER BY profile';
        OPEN o_prof_lic_list FOR sql_stmt
            USING i_id_institution, g_flg_available, g_license_waiting, g_license_cancel;
    
        EXECUTE IMMEDIATE 'SELECT COUNT(*) counter
          FROM license l
         WHERE l.id_institution = :i_id_institution
           AND l.flg_status IN (:g_flg_available, :g_flg_waiting, :g_flg_cancel)
           AND l.id_profile_template_desc IS NOT NULL'
            INTO o_total_lic
            USING i_id_institution, g_flg_available, g_license_waiting, g_license_cancel;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_prof_lic_list);
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_PROFILE_LICENSES');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_profile_licenses;

    /** @headcom
    * Public Function. Get Institution Attributes
    * Retorna os detalhes de uma instituição.
    * 
    * @param      I_LANG                     Identificação do Idioma
    * @param      I_ID_INSTITUTION           Identificação da Instituição
    * @param      O_INST_ATTR                Cursor com a informação dos detalhes da instituição
    * @param      O_INST_AFFILIATIONS        Cursor com a informação das afiliações da instituição
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2009/03/05
    */
    FUNCTION get_institution_attributes
    (
        i_lang              IN language.id_language%TYPE,
        i_id_institution    IN institution.id_institution%TYPE,
        o_inst_attr         OUT pk_types.cursor_type,
        o_inst_affiliations OUT pk_types.cursor_type,
        o_error             OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        g_error := 'GET INSTITUTION ATTRIBUTES CURSOR';
        OPEN o_inst_attr FOR
            SELECT ia.id_inst_attributes,
                   (SELECT il.id_institution_language
                      FROM institution_language il
                     WHERE il.flg_available = g_flg_avail
                       AND il.id_institution = i.id_institution) id_lang,
                   pk_translation.get_translation(i_lang, i.code_institution) name,
                   i.id_parent,
                   ia.clues,
                   pk_sysdomain.get_domain('AB_INSTITUTION.GROUP', decode(i.id_parent, NULL, 'M', 'A'), i_lang) facility_group,
                   i.flg_type,
                   pk_sysdomain.get_domain('AB_INSTITUTION.FLG_TYPE', i.flg_type, i_lang) facility_type,
                   i.flg_available,
                   ia.social_security_number,
                   i.abbreviation,
                   (SELECT il.id_language
                      FROM institution_language il
                     WHERE il.flg_available = g_flg_avail
                       AND il.id_institution = i.id_institution) language_id,
                   get_institution_language(i_lang, i.id_institution) LANGUAGE,
                   ia.id_currency,
                   pk_translation.get_translation(i_lang,
                                                  (SELECT cu.code_currency
                                                     FROM currency cu
                                                    WHERE cu.id_currency = ia.id_currency)) currency_desc,
                   (SELECT cu.currency_desc
                      FROM currency cu
                     WHERE cu.id_currency = ia.id_currency) currency,
                   i.phone_number,
                   i.fax_number,
                   ia.email,
                   ia.health_license,
                   i.adress_type,
                   pk_sysdomain.get_domain('AB_INSTITUTION.ADRESS_TYPE', i.adress_type, i_lang) adress_type_desc,
                   i.address,
                   i.location,
                   i.district,
                   ia.flg_street_type,
                   pk_sysdomain.get_domain(i_code_dom => 'CONTACT_ADDRESS_MX.ROAD_TYPE',
                                           i_val      => ia.flg_street_type,
                                           i_lang     => i_lang) street_type,
                   ia.street_name,
                   ia.outdoor_number,
                   ia.indoor_number,
                   ia.id_settlement_type,
                   pk_adt.get_settlement_type_desc(i_lang               => i_lang,
                                                   i_prof               => NULL,
                                                   i_id_settlement_type => ia.id_settlement_type) settlement_type,
                   ia.id_settlement_name,
                   pk_adt.get_settlement_desc(i_lang               => i_lang,
                                              i_prof               => NULL,
                                              i_id_settlement      => ia.id_settlement_name,
                                              i_id_settlement_type => ia.id_settlement_type) settlement_name,
                   ia.id_entity,
                   (SELECT pk_translation.get_translation(i_lang      => i_lang,
                                                          i_code_mess => rb.code_rb_regional_classifier)
                      FROM rb_regional_classifier rb
                     WHERE rb.id_rb_regional_classifier = ia.id_entity) desc_entity,
                   ia.id_municip,
                   (SELECT pk_translation.get_translation(i_lang      => i_lang,
                                                          i_code_mess => rb.code_rb_regional_classifier)
                      FROM rb_regional_classifier rb
                     WHERE rb.id_rb_regional_classifier = ia.id_municip) desc_municip,
                   ia.id_localidad,
                   (SELECT pk_translation.get_translation(i_lang      => i_lang,
                                                          i_code_mess => rb.code_rb_regional_classifier)
                      FROM rb_regional_classifier rb
                     WHERE rb.id_rb_regional_classifier = ia.id_localidad) desc_localidad,
                   ia.id_postal_code,
                   (SELECT pk_translation.get_translation(i_lang      => i_lang,
                                                          i_code_mess => rb.code_rb_regional_classifier)
                      FROM rb_regional_classifier rb
                     WHERE rb.id_rb_regional_classifier = ia.id_postal_code) desc_postal_code,
                   
                   i.zip_code,
                   ia.id_country,
                   ia.jurisdiction AS id_jurisdiction,
                   (SELECT pk_translation.get_translation(i_lang      => i_lang,
                                                          i_code_mess => rb.code_rb_regional_classifier)
                      FROM rb_regional_classifier rb
                     WHERE rb.id_rb_regional_classifier = ia.jurisdiction) desc_jurisdiction,
                   pk_translation.get_translation(i_lang,
                                                  (SELECT c.code_country
                                                     FROM country c
                                                    WHERE c.flg_available = g_flg_avail
                                                      AND c.id_country = ia.id_country)) country,
                   ia.id_location_tax,
                   i.id_timezone_region,
                   decode(i.id_timezone_region,
                          NULL,
                          NULL,
                          (SELECT tzr.timezone_region
                             FROM timezone_region tzr
                            WHERE tzr.id_timezone_region = i.id_timezone_region)) desc_timezone_region,
                   nvl(i.id_market, 0) id_market,
                   pk_translation.get_translation(i_lang,
                                                  (SELECT m.code_market
                                                     FROM market m
                                                    WHERE m.id_market = nvl(i.id_market, 0))) market_desc,
                   i.contact_detail,
                   i.county,
                   i.address_other_name,
                   ia.website
              FROM institution i, inst_attributes ia
             WHERE i.id_institution = i_id_institution
               AND i.id_institution = ia.id_institution(+)
               AND ia.flg_available(+) = g_flg_avail;
    
        g_error := 'GET INSTITUTION AFFILIATIONS CURSOR';
        OPEN o_inst_affiliations FOR
            SELECT a.id_account,
                   pk_translation.get_translation(i_lang, a.code_account) account_name,
                   a.fill_type,
                   a.sys_domain_identifier,
                   (SELECT ia.value
                      FROM institution_accounts ia
                     WHERE ia.id_account = a.id_account
                       AND ia.id_institution = i_id_institution) VALUE,
                   decode(a.fill_type,
                          'M',
                          nvl((pk_sysdomain.get_domain(a.sys_domain_identifier,
                                                       (SELECT ia.value
                                                          FROM institution_accounts ia
                                                         WHERE ia.id_account = a.id_account
                                                           AND ia.id_institution = i_id_institution),
                                                       i_lang)),
                              NULL),
                          'MM',
                          nvl(get_domain_desc_str(a.sys_domain_identifier,
                                                  (SELECT ia.value
                                                     FROM institution_accounts ia
                                                    WHERE ia.id_account = a.id_account
                                                      AND ia.id_institution = i_id_institution),
                                                  i_lang),
                              NULL),
                          (SELECT ia.value
                             FROM institution_accounts ia
                            WHERE ia.id_account = a.id_account
                              AND ia.id_institution = i_id_institution)) value_desc,
                   ac.format_num,
                   ac.text_format_x,
                   ac.text_format_y,
                   ac.flg_editable
              FROM accounts a
             INNER JOIN accounts_country ac
                ON (ac.id_account = a.id_account)
             WHERE a.flg_available = 'Y'
               AND a.flg_type IN ('I', 'B')
               AND pk_translation.get_translation(i_lang, a.code_account) IS NOT NULL
               AND EXISTS (SELECT 0
                      FROM inst_attributes ia2
                     WHERE ia2.id_institution = i_id_institution
                       AND ia2.id_country = ac.id_country)
             ORDER BY ac.rank, pk_translation.get_translation(i_lang, a.code_account);
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_inst_attr);
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_INSTITUTION_ATTRIBUTES');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_institution_attributes;

    /** @headcom
    * Public Function. Insert New Institution OR Update Institution Information
    *
    * @param      I_LANG                               Language identification
    * @param      I_ID_INSTITUTION                     Institution identification
    * @param      i_id_inst_att                        Institution attributes
    * @param      i_id_inst_lang                       Institution language
    * @param      I_DESC                               Institution description
    * @param      i_id_parent                          Institution parent
    * @param      I_FLG_TYPE                           Institution type: H - Hospital, C - Primary Care, P - Private Practice
    * @param      i_tax                                Social security number
    * @param      I_ABBREVIATION                       Abreviation
    * @param      i_pref_lang                          Institution language
    * @param      i_currency                           Currency
    * @param      I_PHONE_NUMBER                       Phone number
    * @param      i_fax                                Fax
    * @param      i_email                              Email
    * @param      i_adress                             Adress
    * @param      I_LOCATION                           Location
    * @param      i_geo_state                          District
    * @param      i_zip_code                           Zip code           
    * @param      i_country                            Country
    * @param      i_location_tax                       Location tax                       
    * @param      i_lic_model                          Licence model
    * @param      i_pay_sched                          Payment schedule                          
    * @param      i_pay_opt                            Payment options            
    * @param      I_FLG_AVAILABLE                      Flag available
    * @param      i_id_tz_region                       id timezone region       
    * @param      i_commit_at_end                      Commit at end      
    * @param      O_ID_INSTITUTION                     Institution identification
    * @param      o_id_inst_attributes                 Institution attributes id
    * @param      o_id_inst_lang                       Institution Language identification
    * @param      O_ERROR                              Error 
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/07/20
    */
    FUNCTION set_institution_data
    (
        i_lang               IN language.id_language%TYPE,
        i_id_institution     IN institution.id_institution%TYPE,
        i_id_inst_att        IN inst_attributes.id_inst_attributes%TYPE,
        i_id_inst_lang       IN institution_language.id_institution_language%TYPE,
        i_desc               IN VARCHAR2,
        i_id_parent          IN institution.id_parent%TYPE,
        i_flg_type           IN institution.flg_type%TYPE,
        i_tax                IN inst_attributes.social_security_number%TYPE,
        i_abbreviation       IN institution.abbreviation%TYPE,
        i_pref_lang          IN institution_language.id_language%TYPE,
        i_currency           IN inst_attributes.id_currency%TYPE,
        i_phone_number       IN institution.phone_number%TYPE,
        i_fax                IN institution.fax_number%TYPE,
        i_email              IN inst_attributes.email%TYPE,
        i_adress             IN institution.address%TYPE,
        i_location           IN institution.location%TYPE,
        i_geo_state          IN institution.district%TYPE,
        i_zip_code           IN institution.zip_code%TYPE,
        i_country            IN inst_attributes.id_country%TYPE,
        i_location_tax       IN inst_attributes.id_location_tax%TYPE,
        i_lic_model          IN inst_attributes.license_model%TYPE,
        i_pay_sched          IN inst_attributes.payment_schedule%TYPE,
        i_pay_opt            IN inst_attributes.payment_options%TYPE,
        i_flg_available      IN institution.flg_available%TYPE,
        i_id_tz_region       IN institution.id_timezone_region%TYPE,
        i_id_market          IN market.id_market%TYPE,
        i_contact_det        IN ab_institution.contact_detail%TYPE,
        i_commit_at_end      IN BOOLEAN,
        i_clues              IN inst_attributes.clues%TYPE,
        i_health_license     IN inst_attributes.health_license%TYPE,
        i_flg_street_type    IN inst_attributes.flg_street_type%TYPE,
        i_street_name        IN inst_attributes.street_name%TYPE,
        i_outdoor_number     IN inst_attributes.outdoor_number%TYPE,
        i_indoor_number      IN inst_attributes.indoor_number%TYPE,
        i_id_settlement_type IN inst_attributes.id_settlement_type%TYPE,
        i_id_settlement_name IN inst_attributes.id_settlement_name%TYPE,
        i_id_entity          IN inst_attributes.id_entity%TYPE,
        i_id_municip         IN inst_attributes.id_municip%TYPE,
        i_id_localidad       IN inst_attributes.id_localidad%TYPE,
        i_id_postal_code     IN inst_attributes.id_postal_code%TYPE,
        i_jurisdiction       IN inst_attributes.jurisdiction%TYPE,
        i_website            IN inst_attributes.website%TYPE,
        o_id_institution     OUT institution.id_institution%TYPE,
        o_id_inst_attributes OUT inst_attributes.id_inst_attributes%TYPE,
        o_id_inst_lang       OUT institution_language.id_institution_language%TYPE,
        o_error              OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_id_inst_logo    institution_logo.id_institution_logo%TYPE;
        l_count_inst_lang NUMBER;
        my_exception EXCEPTION;
    
        --TRANSLATION
        l_id_lang  language.id_language%TYPE;
        l_code_trl translation.code_translation%TYPE := 'AB_INSTITUTION.CODE_INSTITUTION.';
    
        CURSOR c_language IS
            SELECT l.id_language
              FROM LANGUAGE l
             WHERE l.flg_available = g_flg_avail;
    
        l_professional   table_number := table_number();
        l_professional_c NUMBER := 0;
        idx              NUMBER := 1;
    
        l_old_inst_language institution_language.id_institution_language%TYPE;
    
        l_ine_location ab_institution.ine_location%TYPE;
    
    BEGIN
        g_sysdate := SYSDATE;
    
        IF i_desc IS NULL
        THEN
            g_error := 'Invalid Institution Name';
            RAISE my_exception;
        ELSIF i_flg_type IS NULL
        THEN
            g_error := 'Invalid Type of Insitution';
            RAISE my_exception;
        ELSIF i_flg_available IS NULL
        THEN
            g_error := 'Please Choose Available: Y/N';
            RAISE my_exception;
        ELSIF i_id_institution IS NULL
        THEN
            g_error := 'GET SEQ_INSTITUTION.NEXTVAL';
            SELECT seq_institution.nextval
              INTO o_id_institution
              FROM dual;
        
            g_error := 'INSERT INTO INSTITUTION';
            pk_api_ab_tables.upd_ins_into_ab_institution(i_id_ab_institution          => i_id_institution,
                                                         i_import_code                => NULL,
                                                         i_record_status              => 'A',
                                                         i_id_ab_market               => i_id_market,
                                                         i_code                       => NULL,
                                                         i_description                => i_desc,
                                                         i_alt_description            => NULL,
                                                         i_shortname                  => i_abbreviation,
                                                         i_vat_registration           => NULL,
                                                         i_timezone_region_code       => NULL,
                                                         i_rb_country_key             => i_country, --id_country
                                                         i_rb_regional_classifier_key => NULL,
                                                         i_id_ab_institution_parent   => i_id_parent,
                                                         i_flg_type                   => i_flg_type,
                                                         i_address1                   => i_adress,
                                                         i_address2                   => i_location,
                                                         i_address3                   => i_geo_state,
                                                         i_zip_code                   => i_zip_code,
                                                         i_zip_code_description       => NULL,
                                                         i_fax_number                 => i_fax,
                                                         i_phone_number               => i_phone_number,
                                                         i_email                      => i_email,
                                                         i_logo                       => NULL,
                                                         i_web_site                   => NULL,
                                                         i_geo_location_key           => NULL /*i_location*/,
                                                         i_flg_external               => NULL,
                                                         i_code_institution           => l_code_trl || i_id_institution,
                                                         i_flg_available              => i_flg_available,
                                                         i_rank                       => 1,
                                                         i_barcode                    => NULL,
                                                         i_ine_location               => 'N/A',
                                                         i_id_timezone_region         => i_id_tz_region,
                                                         i_ext_code                   => NULL,
                                                         i_dn_flg_status              => NULL,
                                                         i_adress_type                => NULL,
                                                         i_contact_det                => i_contact_det,
                                                         o_id_ab_institution          => o_id_institution);
        
            g_error := 'GET SEQ_INST_ATTRIBUTES.NEXTVAL';
            SELECT seq_inst_attributes.nextval
              INTO o_id_inst_attributes
              FROM dual;
        
            g_error := 'GET SEQ_INSTITUTION_LANGUAGE.NEXTVAL';
            SELECT seq_institution_language.nextval
              INTO o_id_inst_lang
              FROM dual;
        
            g_error := 'INSERT INTO INSTITUTION_LANGUAGE';
            INSERT INTO institution_language
                (id_institution_language, id_language, id_institution, flg_available, adw_last_update)
            VALUES
                (o_id_inst_lang, i_pref_lang, o_id_institution, g_flg_avail, SYSDATE);
        
            g_error := 'INSERT INTO INST_ATTRIBUTES';
            INSERT INTO inst_attributes
                (id_country,
                 id_institution,
                 id_inst_attributes,
                 social_security_number,
                 id_currency,
                 email,
                 license_model,
                 flg_available,
                 payment_schedule,
                 id_institution_language,
                 payment_options,
                 id_location_tax,
                 clues,
                 health_license,
                 jurisdiction,
                 flg_street_type,
                 street_name,
                 outdoor_number,
                 indoor_number,
                 id_settlement_type,
                 id_settlement_name,
                 id_entity,
                 id_municip,
                 id_localidad,
                 id_postal_code,
                 website)
            VALUES
                (i_country,
                 o_id_institution,
                 o_id_inst_attributes,
                 i_tax,
                 i_currency,
                 i_email,
                 i_lic_model,
                 g_flg_avail,
                 i_pay_sched,
                 o_id_inst_lang,
                 i_pay_opt,
                 i_location_tax,
                 i_clues,
                 i_health_license,
                 i_jurisdiction,
                 i_flg_street_type,
                 i_street_name,
                 i_outdoor_number,
                 i_indoor_number,
                 i_id_settlement_type,
                 i_id_settlement_name,
                 i_id_entity,
                 i_id_municip,
                 i_id_localidad,
                 i_id_postal_code,
                 i_website);
        
            g_error := 'GET LANGUAGES';
            OPEN c_language;
            LOOP
                FETCH c_language
                    INTO l_id_lang;
                EXIT WHEN c_language%NOTFOUND;
            
                g_error := 'INSERT_INTO_TRANSLATION INSTITUTION';
                pk_translation.insert_into_translation(l_id_lang, l_code_trl || o_id_institution, i_desc);
            
            END LOOP;
        
            CLOSE c_language;
        
        ELSE
            BEGIN
                SELECT nvl(i.ine_location, 'N/A')
                  INTO l_ine_location
                  FROM institution i
                 WHERE i.id_institution = i_id_institution;
            EXCEPTION
                WHEN no_data_found THEN
                    l_ine_location := 'N/A';
            END;
        
            g_error := 'UPDATE INSTITUTION';
            pk_api_ab_tables.upd_ins_into_ab_institution(i_id_ab_institution          => i_id_institution,
                                                         i_import_code                => NULL,
                                                         i_record_status              => 'A',
                                                         i_id_ab_market               => i_id_market,
                                                         i_code                       => NULL,
                                                         i_description                => NULL,
                                                         i_alt_description            => NULL,
                                                         i_shortname                  => i_abbreviation,
                                                         i_vat_registration           => NULL,
                                                         i_timezone_region_code       => NULL,
                                                         i_rb_country_key             => i_country, --id_country
                                                         i_rb_regional_classifier_key => NULL,
                                                         i_id_ab_institution_parent   => i_id_parent,
                                                         i_flg_type                   => i_flg_type,
                                                         i_address1                   => i_adress,
                                                         i_address2                   => i_location,
                                                         i_address3                   => i_geo_state,
                                                         i_zip_code                   => i_zip_code,
                                                         i_zip_code_description       => NULL,
                                                         i_fax_number                 => i_fax,
                                                         i_phone_number               => i_phone_number,
                                                         i_email                      => i_email,
                                                         i_logo                       => NULL,
                                                         i_web_site                   => NULL,
                                                         i_geo_location_key           => NULL,
                                                         i_flg_external               => NULL,
                                                         i_code_institution           => NULL,
                                                         i_flg_available              => i_flg_available,
                                                         i_rank                       => 1,
                                                         i_barcode                    => NULL,
                                                         i_ine_location               => l_ine_location,
                                                         i_id_timezone_region         => i_id_tz_region,
                                                         i_ext_code                   => NULL,
                                                         i_dn_flg_status              => NULL,
                                                         i_adress_type                => NULL,
                                                         i_contact_det                => NULL,
                                                         o_id_ab_institution          => o_id_institution);
        
            pk_api_ab_tables.upd_ab_institution(id_ab_institution_in => i_id_institution,
                                                shortname_in         => i_abbreviation,
                                                shortname_nin        => FALSE,
                                                description_in       => i_desc,
                                                description_nin      => FALSE,
                                                address1_in          => i_adress,
                                                address1_nin         => FALSE,
                                                address2_in          => i_location,
                                                address2_nin         => FALSE,
                                                address3_in          => i_geo_state,
                                                address3_nin         => FALSE,
                                                fax_number_in        => i_fax,
                                                fax_number_nin       => FALSE,
                                                zip_code_in          => i_zip_code,
                                                zip_code_nin         => FALSE,
                                                email_in             => i_email,
                                                email_nin            => FALSE,
                                                phone_number_in      => i_phone_number,
                                                phone_number_nin     => FALSE,
                                                contact_det_in       => i_contact_det,
                                                contact_det_nin      => FALSE);
        
            IF i_pay_opt IS NULL
            THEN
                IF i_id_inst_att IS NULL
                THEN
                    g_error := 'INSERT INST_ATTRIBUTES';
                    INSERT INTO inst_attributes
                        (id_country,
                         id_institution,
                         id_inst_attributes,
                         social_security_number,
                         id_currency,
                         email,
                         flg_available,
                         id_institution_language,
                         id_location_tax,
                         clues,
                         health_license,
                         jurisdiction,
                         flg_street_type,
                         street_name,
                         outdoor_number,
                         indoor_number,
                         id_settlement_type,
                         id_settlement_name,
                         id_entity,
                         id_municip,
                         id_localidad,
                         id_postal_code,
                         website)
                    VALUES
                        (i_country,
                         o_id_institution,
                         seq_inst_attributes.nextval,
                         i_tax,
                         i_currency,
                         i_email,
                         g_flg_avail,
                         i_id_inst_lang,
                         i_location_tax,
                         i_clues,
                         i_health_license,
                         i_jurisdiction,
                         i_flg_street_type,
                         i_street_name,
                         i_outdoor_number,
                         i_indoor_number,
                         i_id_settlement_type,
                         i_id_settlement_name,
                         i_id_entity,
                         i_id_municip,
                         i_id_localidad,
                         i_id_postal_code,
                         i_website);
                
                ELSE
                    g_error := 'UPDATE INST_ATTRIBUTES';
                    UPDATE inst_attributes
                       SET id_country              = i_country,
                           id_institution          = o_id_institution,
                           social_security_number  = i_tax,
                           id_currency             = i_currency,
                           email                   = i_email,
                           id_institution_language = i_id_inst_lang,
                           id_location_tax         = i_location_tax,
                           clues                   = i_clues,
                           health_license          = i_health_license,
                           jurisdiction            = i_jurisdiction,
                           flg_street_type         = i_flg_street_type,
                           street_name             = i_street_name,
                           outdoor_number          = i_outdoor_number,
                           indoor_number           = i_indoor_number,
                           id_settlement_type      = i_id_settlement_type,
                           id_settlement_name      = i_id_settlement_name,
                           id_entity               = i_id_entity,
                           id_municip              = i_id_municip,
                           id_localidad            = i_id_localidad,
                           id_postal_code          = i_id_postal_code,
                           website                 = i_website
                     WHERE id_inst_attributes = i_id_inst_att;
                END IF;
            ELSE
                IF i_id_inst_att IS NULL
                THEN
                    g_error := 'INSERT INST_ATTRIBUTES';
                    INSERT INTO inst_attributes
                        (id_country,
                         id_institution,
                         id_inst_attributes,
                         social_security_number,
                         id_currency,
                         email,
                         license_model,
                         payment_schedule,
                         payment_options,
                         flg_available,
                         id_institution_language,
                         id_location_tax,
                         clues,
                         health_license,
                         jurisdiction,
                         flg_street_type,
                         street_name,
                         outdoor_number,
                         indoor_number,
                         id_settlement_type,
                         id_settlement_name,
                         id_entity,
                         id_municip,
                         id_localidad,
                         id_postal_code,
                         website)
                    VALUES
                        (i_country,
                         o_id_institution,
                         seq_inst_attributes.nextval,
                         i_tax,
                         i_currency,
                         i_email,
                         i_lic_model,
                         i_pay_sched,
                         i_pay_opt,
                         g_flg_avail,
                         i_id_inst_lang,
                         i_location_tax,
                         i_clues,
                         i_health_license,
                         i_jurisdiction,
                         i_flg_street_type,
                         i_street_name,
                         i_outdoor_number,
                         i_indoor_number,
                         i_id_settlement_type,
                         i_id_settlement_name,
                         i_id_entity,
                         i_id_municip,
                         i_id_localidad,
                         i_id_postal_code,
                         i_website);
                ELSE
                    g_error := 'UPDATE INST_ATTRIBUTES';
                    UPDATE inst_attributes
                       SET id_country              = i_country,
                           id_institution          = o_id_institution,
                           social_security_number  = i_tax,
                           id_currency             = i_currency,
                           email                   = i_email,
                           license_model           = i_lic_model,
                           payment_schedule        = i_pay_sched,
                           id_institution_language = i_id_inst_lang,
                           payment_options         = i_pay_opt,
                           id_location_tax         = i_location_tax,
                           clues                   = i_clues,
                           health_license          = i_health_license,
                           jurisdiction            = i_jurisdiction,
                           flg_street_type         = i_flg_street_type,
                           street_name             = i_street_name,
                           outdoor_number          = i_outdoor_number,
                           indoor_number           = i_indoor_number,
                           id_settlement_type      = i_id_settlement_type,
                           id_settlement_name      = i_id_settlement_name,
                           id_entity               = i_id_entity,
                           id_municip              = i_id_municip,
                           id_localidad            = i_id_localidad,
                           id_postal_code          = i_id_postal_code,
                           website                 = i_website,
                           adw_last_update         = SYSDATE
                     WHERE id_inst_attributes = i_id_inst_att;
                
                END IF;
            END IF;
        
            g_error := 'SELECT COUNT(*) FROM INSTITUTION_LANGUAGE';
            SELECT COUNT(id_institution_language)
              INTO l_count_inst_lang
              FROM institution_language ia
             WHERE ia.id_institution = o_id_institution;
        
            IF l_count_inst_lang != 0
            THEN
            
                SELECT id_language
                  INTO l_old_inst_language
                  FROM institution_language ia
                 WHERE ia.id_institution = o_id_institution;
            
                g_error := 'UPDATE INSTITUTION_LANGUAGE';
                UPDATE institution_language
                   SET id_language = i_pref_lang, adw_last_update = SYSDATE
                 WHERE id_institution = o_id_institution;
            ELSE
                g_error := 'INSERT INTO INSTITUTION_LANGUAGE';
                INSERT INTO institution_language
                    (id_institution_language, id_language, id_institution, flg_available, adw_last_update)
                VALUES
                    (seq_institution_language.nextval, i_pref_lang, o_id_institution, g_flg_avail, SYSDATE);
            END IF;
        
            IF l_old_inst_language != i_pref_lang
            THEN
                -- Language update for the users referring to the current institution
                FOR users IN (SELECT su.id_ab_user_info
                                FROM prof_institution pi, ab_user_info su
                               WHERE id_institution = o_id_institution
                                 AND pi.id_professional = su.id_ab_user_info)
                LOOP
                    l_professional.extend;
                    -- Language update for the users referring to the current institution
                    g_error := 'UPDATE AB_USER_INFO';
                    pk_api_ab_tables.upd_ins_into_ab_user_info(i_id_ab_user_info    => users.id_ab_user_info,
                                                               i_login              => NULL,
                                                               i_password           => NULL,
                                                               i_import_code        => NULL,
                                                               i_record_status      => 'A',
                                                               i_institution_key    => o_id_institution,
                                                               i_flg_is_enable      => 'A',
                                                               i_first_name         => NULL,
                                                               i_last_name          => NULL,
                                                               i_full_name          => NULL,
                                                               i_external_system    => NULL,
                                                               i_external_system_id => NULL,
                                                               i_secret_quest       => NULL,
                                                               i_secret_answ        => NULL,
                                                               i_id_language        => i_pref_lang,
                                                               i_flg_temporary      => 'N',
                                                               i_date_creation_tstz => NULL,
                                                               o_id_ab_user_info    => l_professional_c);
                    l_professional(idx) := l_professional_c;
                    idx := idx + 1;
                END LOOP;
            
            END IF;
        
            g_error := 'GET LANGUAGES';
            OPEN c_language;
            LOOP
                FETCH c_language
                    INTO l_id_lang;
                EXIT WHEN c_language%NOTFOUND;
            
                g_error := 'INSERT_INTO_TRANSLATION INSTITUTION';
                pk_translation.insert_into_translation(l_id_lang, l_code_trl || o_id_institution, i_desc);
            
            END LOOP;
        
            CLOSE c_language;
        
        END IF;
        IF i_commit_at_end
        THEN
            COMMIT;
        END IF;
        RETURN TRUE;
    
    EXCEPTION
        WHEN my_exception THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_INSTITUTION_DATA',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
        WHEN OTHERS THEN
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'SET_INSTITUTION_DATA');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END set_institution_data;

    /** @headcom
    * Public Function. Get Institution Admninistrator
    * Retorna os detalhes do administrador de uma instituição.
    * 
    * @param      I_LANG                     Language identification
    * @param      I_ID_INSTITUTION           Institution identification
    * @param      i_prof                     Professional identification
    * @param      O_INST_ADMIN               Cursor with details about institution administrator
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Eduardo Lourenço - EL
    * @version    0.1
    * @since      2007/07/20
    */
    FUNCTION get_institution_administrator
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        i_prof           IN profissional,
        o_inst_admin     OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_profile_template NUMBER;
    
    BEGIN
    
        SELECT ppt.id_profile_template
          INTO l_profile_template
          FROM prof_profile_template ppt
         WHERE ppt.id_professional = i_prof.id
           AND ppt.id_software = i_prof.software
           AND ppt.id_institution = i_prof.institution;
    
        g_error := 'GET INSTITUTION ADMINISTRATOR CURSOR';
        OPEN o_inst_admin FOR
            SELECT p.id_professional id,
                   get_prof_title_desc(i_lang, p.title) desc_title,
                   p.title,
                   p.name,
                   p.first_name,
                   p.middle_name,
                   p.last_name,
                   p.nick_name,
                   (SELECT pc.id_category
                      FROM prof_cat pc
                     WHERE pc.id_institution = i.id_institution
                       AND pc.id_professional = p.id_professional) job_title,
                   pk_translation.get_translation(i_lang,
                                                  (SELECT c.code_category
                                                     FROM category c
                                                    WHERE c.flg_available = 'Y'
                                                      AND c.id_category =
                                                          (SELECT pc.id_category
                                                             FROM prof_cat pc
                                                            WHERE pc.id_institution = i.id_institution
                                                              AND pc.id_professional = p.id_professional))) desc_job_title,
                   pk_sysdomain.get_domain('PROFESSIONAL.GENDER', p.gender, i_lang) desc_gender,
                   p.gender,
                   pk_date_utils.dt_chr(i_lang, p.dt_birth, profissional(0, i_id_institution, 0)) string_birth,
                   get_date_to_be_sent(i_lang, p.dt_birth) dt_birth,
                   p.email,
                   p.work_phone num_contact,
                   p.cell_phone,
                   p.fax
              FROM institution i, prof_profile_template ppt, professional p
             WHERE i.id_institution = i_id_institution
               AND ppt.id_profile_template = l_profile_template
               AND ppt.id_institution = i.id_institution
               AND p.id_professional = ppt.id_professional
               AND pk_prof_utils.is_internal_prof(i_lang, NULL, p.id_professional, i_id_institution) =
                   pk_alert_constant.get_yes;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_inst_admin);
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_INSTITUTION_ADMINISTRATOR');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_institution_administrator;

    FUNCTION set_institution_administrator
    (
        i_lang          IN language.id_language%TYPE,
        i_software      IN software.id_software%TYPE,
        i_id_prof       IN professional.id_professional%TYPE,
        i_id_inst       IN institution.id_institution%TYPE,
        i_name          IN professional.name%TYPE,
        i_title         IN professional.title%TYPE,
        i_nick_name     IN professional.nick_name%TYPE,
        i_gender        IN professional.gender%TYPE,
        i_dt_birth      IN VARCHAR2,
        i_email         IN professional.email%TYPE,
        i_work_phone    IN professional.num_contact%TYPE,
        i_cell_phone    IN professional.cell_phone%TYPE,
        i_fax           IN professional.fax%TYPE,
        i_first_name    IN professional.first_name%TYPE,
        i_parent_name   IN professional.parent_name%TYPE,
        i_middle_name   IN professional.middle_name%TYPE,
        i_last_name     IN professional.last_name%TYPE,
        i_id_cat        IN category.id_category%TYPE,
        i_commit_at_end IN BOOLEAN,
        o_id_prof       OUT professional.id_professional%TYPE,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_title                    VARCHAR2(20);
        l_nick_name                VARCHAR2(200);
        l_short_name               VARCHAR2(200);
        l_id_prof_profile_template NUMBER(24);
        l_id_prof_cat              NUMBER(12);
        my_exception EXCEPTION;
        l_error            VARCHAR2(4000);
        l_prof_institution prof_institution.id_prof_institution%TYPE := 0;
    BEGIN
        g_sysdate := SYSDATE;
    
        IF i_nick_name IS NULL
        THEN
            l_error := pk_message.get_message(i_lang, 'PROFESSIONAL_M001');
            RAISE my_exception;
        ELSIF i_gender IS NULL
        THEN
            l_error := pk_message.get_message(i_lang, 'PROFESSIONAL_M002');
            RAISE my_exception;
        ELSIF i_id_prof IS NULL
        THEN
        
            g_error := 'INSERT INTO PROFESSIONAL';
            pk_api_ab_tables.upd_ins_into_ab_user_info(i_id_ab_user_info    => NULL,
                                                       i_login              => NULL,
                                                       i_password           => NULL,
                                                       i_import_code        => NULL,
                                                       i_record_status      => g_prof_flg_state_active,
                                                       i_institution_key    => i_id_inst,
                                                       i_flg_is_enable      => g_prof_flg_state_active,
                                                       i_first_name         => i_first_name,
                                                       i_last_name          => i_last_name,
                                                       i_full_name          => create_name_formated(i_lang,
                                                                                                    i_id_inst,
                                                                                                    i_first_name,
                                                                                                    i_parent_name,
                                                                                                    i_middle_name,
                                                                                                    i_last_name),
                                                       i_external_system    => NULL,
                                                       i_external_system_id => NULL,
                                                       i_secret_quest       => NULL,
                                                       i_secret_answ        => NULL,
                                                       i_id_language        => NULL,
                                                       i_flg_temporary      => 'N',
                                                       i_date_creation_tstz => NULL,
                                                       o_id_ab_user_info    => o_id_prof);
            INSERT INTO professional
                (id_professional,
                 name,
                 nick_name,
                 dt_birth,
                 work_phone,
                 gender,
                 title,
                 short_name,
                 cell_phone,
                 fax,
                 email,
                 first_name,
                 middle_name,
                 last_name,
                 flg_state)
            VALUES
                (o_id_prof,
                 create_name_formated(i_lang, i_id_inst, i_first_name, i_parent_name, i_middle_name, i_last_name),
                 i_nick_name,
                 get_date_received(i_lang, i_dt_birth),
                 i_work_phone,
                 i_gender,
                 i_title,
                 i_nick_name || ',' || get_prof_title_desc(i_lang, i_title),
                 i_cell_phone,
                 i_fax,
                 i_email,
                 i_first_name,
                 i_middle_name,
                 i_last_name,
                 g_prof_flg_state_active);
        
            ins_professional_hist(i_id_professional => o_id_prof, i_operation_type => g_prof_hist_oper_c);
            g_error := 'INSERT INTO PROF_INSTITUTION';
            pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                           i_id_professional     => o_id_prof,
                                                           i_id_institution      => i_id_inst,
                                                           i_flg_state           => 'I',
                                                           i_dt_begin_tstz       => current_timestamp,
                                                           o_id_prof_institution => l_prof_institution);
        
            g_error := 'GET SEQ_PROFE_CAT.NEXTVAL';
            SELECT seq_prof_cat.nextval
              INTO l_id_prof_cat
              FROM dual;
        
            g_error := 'INSERT INTO PROF_CAT';
            INSERT INTO prof_cat
                (id_prof_cat, id_professional, id_category, id_institution)
            VALUES
                (l_id_prof_cat, o_id_prof, i_id_cat, i_id_inst);
        
        ELSE
        
            g_error := 'UPDATE PROFESSIONAL';
            pk_api_ab_tables.upd_ins_into_ab_user_info(i_id_ab_user_info    => i_id_prof,
                                                       i_login              => NULL,
                                                       i_password           => NULL,
                                                       i_import_code        => NULL,
                                                       i_record_status      => g_prof_flg_state_active,
                                                       i_institution_key    => i_id_inst,
                                                       i_flg_is_enable      => g_prof_flg_state_active,
                                                       i_first_name         => i_first_name,
                                                       i_last_name          => i_last_name,
                                                       i_full_name          => create_name_formated(i_lang,
                                                                                                    i_id_inst,
                                                                                                    i_first_name,
                                                                                                    i_parent_name,
                                                                                                    i_middle_name,
                                                                                                    i_last_name),
                                                       i_external_system    => NULL,
                                                       i_external_system_id => NULL,
                                                       i_secret_quest       => NULL,
                                                       i_secret_answ        => NULL,
                                                       i_id_language        => NULL,
                                                       i_flg_temporary      => 'N',
                                                       i_date_creation_tstz => NULL,
                                                       o_id_ab_user_info    => o_id_prof);
            UPDATE professional
               SET name            = create_name_formated(i_lang,
                                                          i_id_inst,
                                                          i_first_name,
                                                          i_parent_name,
                                                          i_middle_name,
                                                          i_last_name),
                   gender          = i_gender,
                   dt_birth        = get_date_received(i_lang, i_dt_birth),
                   nick_name       = i_nick_name,
                   adw_last_update = g_sysdate,
                   title           = i_title,
                   short_name      = i_nick_name,
                   work_phone      = i_work_phone,
                   cell_phone      = i_cell_phone,
                   fax             = i_fax,
                   email           = i_email,
                   first_name      = i_first_name,
                   middle_name     = i_middle_name,
                   last_name       = i_last_name
             WHERE id_professional = o_id_prof;
            ins_professional_hist(i_id_professional => o_id_prof, i_operation_type => g_prof_hist_oper_u);
        
        END IF;
    
        IF i_commit_at_end
        THEN
            COMMIT;
        END IF;
        RETURN TRUE;
    
    EXCEPTION
        WHEN my_exception THEN
            pk_alert_exceptions.process_error(i_lang,
                                              'SET_INST_ADM',
                                              l_error,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_INSTITUTION_ADMINISTRATOR',
                                              'U',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        WHEN OTHERS THEN
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
            
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'SET_INSTITUTION_ADMINISTRATOR');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END set_institution_administrator;

    /** @headcom
    * Public Function. Get Institution Lincese
    * Retorna os detalhes de licenças de uma instituição.
    * 
    * @param      I_LANG                     Identificação do Idioma
    * @param      I_ID_INSTITUTION           Identificação da Instituição
    * @param      O_INST_LIC                 Cursor com os detalhes de licença da instituição
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenço - EL
    * @version    0.1
    * @since      2007/07/20
    */
    FUNCTION get_institution_license
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        o_inst_lic       OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
        l_prof   profissional;
        sql_stmt VARCHAR2(2000);
    BEGIN
        g_error  := 'SET PROF';
        l_prof   := profissional(0, i_id_institution, 26);
        g_error  := 'GET INSTITUTION LICENSE CURSOR';
        sql_stmt := 'SELECT pk_sysdomain.get_domain(''INST_ATTRIBUTES.LICENSE_MODEL'', ia.license_model, :i_lang) desc_license_model,
                   ia.license_model,
                   pk_sysdomain.get_domain(''INST_ATTRIBUTES.PAYMENT_SCHEDULE'', ia.payment_schedule, :i_lang) desc_payment_schedule,
                   ia.payment_schedule,
                   pk_sysdomain.get_domain(''INST_ATTRIBUTES.PAYMENT_OPTIONS'', ia.payment_options, :i_lang) desc_payment_options,
                   ia.payment_options,
                   pk_date_utils.date_chr_extend_tsz(:i_lang,
                                                   (SELECT MIN(p.dt_payment_tstz)
                                                      FROM aol.payment p, aol.license l
                                                     WHERE l.id_institution = :i_id_institution
                                                       AND l.id_license = p.id_license
                                                       AND p.trans_status = :g_trans_status_available),
                                                   :l_prof) date_first_payment
              FROM inst_attributes ia
             WHERE ia.id_institution = :i_id_institution';
        OPEN o_inst_lic FOR sql_stmt
            USING i_lang, i_lang, i_lang, i_lang, i_id_institution, g_trans_status_available, l_prof, i_id_institution;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_inst_lic);
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_INSTITUTION_LICENSE');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_institution_license;

    /** @headcom
    * Public Function. Get Licensing Model List
    *
    * @param      I_LANG                     Identificação do Idioma
    * @param      O_LIST                     Cursor com a Informação dos Modelos de Licenças
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenco - EL
    * @version    0.1
    * @since      2007/07/20
    */
    FUNCTION get_licensing_model_list
    (
        i_lang  IN language.id_language%TYPE,
        o_list  OUT pk_types.cursor_type,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET LICENSING MODEL LIST CURSOR';
        OPEN o_list FOR
        
            SELECT val, desc_val
              FROM sys_domain
             WHERE code_domain = 'INST_ATTRIBUTES.LICENSE_MODEL'
               AND domain_owner = pk_sysdomain.k_default_schema
               AND flg_available = g_flg_available
               AND id_language = i_lang
             ORDER BY rank;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_list);
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_LICENSING_MODEL_LIST');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_licensing_model_list;

    /** @headcom
    * Public Function. Get Payment Options List
    *
    * @param      I_LANG                     Language identification
    * @param      O_LIST                     Cursor with licences models information
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/07/24
    */
    FUNCTION get_payment_opt_list
    (
        i_lang  IN language.id_language%TYPE,
        o_list  OUT pk_types.cursor_type,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET LICENSING MODEL LIST CURSOR';
        OPEN o_list FOR
        
            SELECT val, desc_val
              FROM sys_domain
             WHERE code_domain = 'INST_ATTRIBUTES.PAYMENT_OPTIONS'
               AND domain_owner = pk_sysdomain.k_default_schema
               AND flg_available = g_flg_available
               AND id_language = i_lang
             ORDER BY rank;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_list);
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_PAYMENT_OPT_LIST');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_payment_opt_list;

    /** @headcom
    * Public Function. Get Payment Schedule List
    *
    * @param      I_LANG                     Identificação do Idioma
    * @param      O_LIST                     Cursor com a Informação de Escalonamento de Pagamentos
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenco - EL
    * @version    0.1
    * @since      2007/07/20
    */
    FUNCTION get_payment_schedule_list
    (
        i_lang  IN language.id_language%TYPE,
        o_list  OUT pk_types.cursor_type,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET PAYMENT SCHEDULE LIST CURSOR';
        OPEN o_list FOR
        
            SELECT val, desc_val
              FROM sys_domain
             WHERE code_domain = 'INST_ATTRIBUTES.PAYMENT_SCHEDULE'
               AND domain_owner = pk_sysdomain.k_default_schema
               AND flg_available = g_flg_available
               AND id_language = i_lang
             ORDER BY rank;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_list);
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'PAYMENT_SCHEDULE_LIST');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_payment_schedule_list;

    /** @headcom
    * Public Function. Get Institution Change Details
    *
    * @param      I_LANG                     Identificação do Idioma
    * @param      i_prof
    * @param      I_ID_INSTITUTION           Identificação da Instituição
    * @param      O_INST_GENERAL_ATTR_LIST   Cursor com os atributos gerais da instituição
    * @param      O_INST_ADMIN_ATTR_LIST     Cursor com os atributos do administrador da instituição
    * @param      O_INST_LICENSE_ATTR_LIST   Cursor com os atributos das licenças da instituição
    * @param      O_INST_TITLE_LIST          Cursor com os títulos a preencher
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenco - EL
    * @version    0.1
    * @since      2007/07/23
    */
    FUNCTION get_institution_change_details
    (
        i_lang                   IN language.id_language%TYPE,
        i_prof                   IN profissional,
        i_id_institution         IN institution.id_institution%TYPE,
        o_inst_general_attr_list OUT pk_types.cursor_type,
        o_inst_admin_attr_list   OUT pk_types.cursor_type,
        o_inst_license_attr_list OUT pk_types.cursor_type,
        o_inst_title_list        OUT pk_types.cursor_type,
        o_inst_affiliations      OUT pk_types.cursor_type,
        o_error                  OUT t_error_out
    ) RETURN BOOLEAN IS
        sql_stmt           VARCHAR2(2000);
        l_profile_template profile_template.id_profile_template%TYPE;
    BEGIN
    
        SELECT ppt.id_profile_template
          INTO l_profile_template
          FROM prof_profile_template ppt
         WHERE ppt.id_software = i_prof.software
           AND ppt.id_professional = i_prof.id
           AND ppt.id_institution = i_prof.institution;
    
        g_error := 'GET GENERAL ATTR CURSOR';
        OPEN o_inst_general_attr_list FOR
            SELECT decode(r,
                          1,
                          name,
                          2,
                          facility_group,
                          3,
                          facility_type,
                          4,
                          social_security_number,
                          5,
                          abbreviation,
                          6,
                          LANGUAGE,
                          7,
                          currency,
                          8,
                          phone_number,
                          9,
                          fax_number,
                          10,
                          email,
                          11,
                          address,
                          12,
                          location,
                          13,
                          district,
                          14,
                          zip_code,
                          15,
                          country) VALUE
              FROM (SELECT pk_translation.get_translation(i_lang, i.code_institution) name,
                           pk_sysdomain.get_domain('AB_INSTITUTION.GROUP', decode(i.id_parent, NULL, 'A', 'M'), i_lang) facility_group,
                           pk_sysdomain.get_domain('AB_INSTITUTION.FLG_TYPE', i.flg_type, i_lang) facility_type,
                           ia.social_security_number,
                           i.abbreviation,
                           get_institution_language(i_lang, i.id_institution) LANGUAGE,
                           pk_translation.get_translation(i_lang,
                                                          (SELECT cu.code_currency
                                                             FROM currency cu
                                                            WHERE cu.id_currency = ia.id_currency)) currency,
                           i.phone_number,
                           i.fax_number,
                           ia.email,
                           i.address,
                           i.location,
                           i.district,
                           i.zip_code,
                           pk_translation.get_translation(i_lang,
                                                          (SELECT c.code_country
                                                             FROM country c
                                                            WHERE c.flg_available = g_flg_avail
                                                              AND c.id_country = ia.id_country)) country
                      FROM institution i, inst_attributes ia
                     WHERE i.id_institution = i_id_institution
                       AND i.id_institution = ia.id_institution(+)),
                   (SELECT rownum r
                      FROM all_objects
                     WHERE rownum <= 15);
    
        g_error := 'GET INST ADMIN ATTR CURSOR';
        OPEN o_inst_admin_attr_list FOR
            SELECT decode(r,
                          1,
                          desc_title,
                          2,
                          first_name,
                          3,
                          middle_name,
                          4,
                          last_name,
                          5,
                          nick_name,
                          6,
                          desc_job_title,
                          7,
                          desc_gender,
                          8,
                          string_birth,
                          9,
                          email,
                          10,
                          work_phone,
                          11,
                          cell_phone,
                          12,
                          fax) VALUE
              FROM (SELECT get_prof_title_desc(i_lang, p.title) desc_title,
                           
                           p.first_name,
                           p.middle_name,
                           p.last_name,
                           p.nick_name,
                           pk_translation.get_translation(i_lang,
                                                          (SELECT c.code_category
                                                             FROM category c
                                                            WHERE c.flg_available = g_flg_avail
                                                              AND c.id_category =
                                                                  (SELECT pc.id_category
                                                                     FROM prof_cat pc
                                                                    WHERE pc.id_institution = i_id_institution
                                                                      AND pc.id_professional = p.id_professional))) desc_job_title,
                           pk_sysdomain.get_domain('PROFESSIONAL.GENDER', p.gender, i_lang) desc_gender,
                           pk_date_utils.date_chr_extend(i_lang, p.dt_birth, i_prof) string_birth,
                           
                           p.email,
                           p.work_phone,
                           p.cell_phone,
                           p.fax
                    
                      FROM professional p
                     WHERE p.id_professional IN (SELECT ppt.id_professional
                                                   FROM prof_profile_template ppt
                                                  WHERE ppt.id_profile_template = l_profile_template
                                                    AND ppt.id_institution = i_id_institution)
                       AND nvl(p.flg_prof_test, pk_alert_constant.get_no) = pk_alert_constant.get_no),
                   (SELECT rownum r
                      FROM all_objects
                     WHERE rownum <= 12);
    
        g_error  := 'GET INST LICENSE ATTR CURSOR';
        sql_stmt := 'SELECT decode(r,
                          1,
                          desc_license_model,
                          2,
                          desc_payment_schedule,
                          3,
                          desc_payment_options,
                          4,
                          date_first_payment) VALUE
              FROM (SELECT pk_sysdomain.get_domain(''INST_ATTRIBUTES.LICENSE_MODEL'', ia.license_model, :i_lang) desc_license_model,
                           pk_sysdomain.get_domain(''INST_ATTRIBUTES.PAYMENT_SCHEDULE'', ia.payment_schedule, :i_lang) desc_payment_schedule,
                           pk_sysdomain.get_domain(''INST_ATTRIBUTES.PAYMENT_OPTIONS'', ia.payment_options, :i_lang) desc_payment_options,
                           pk_date_utils.date_chr_extend(:i_lang,
                                                         (SELECT MIN(p.dt_payment)
                                                            FROM aol.payment p, aol.license l
                                                           WHERE l.id_institution = :i_id_institution
                                                             AND l.id_license = p.id_license
                                                             AND p.trans_status = :g_trans_status_available),
                                                         :i_prof) date_first_payment  
                      FROM inst_attributes ia
                     WHERE ia.id_institution = :i_id_institution),
                   (SELECT rownum r
                      FROM all_objects
                     WHERE rownum <= 4)';
        IF l_profile_template = 30
        THEN
            OPEN o_inst_license_attr_list FOR sql_stmt
                USING i_lang, i_lang, i_lang, i_lang, i_id_institution, g_trans_status_available, i_prof, i_id_institution;
        ELSE
            OPEN o_inst_license_attr_list FOR
                SELECT 1
                  FROM dual
                 WHERE 1 = 2;
        END IF;
    
        g_error := 'GET INST TITLES CURSOR';
        OPEN o_inst_title_list FOR
            SELECT decode(r,
                          1,
                          c1,
                          2,
                          c2,
                          3,
                          c3,
                          4,
                          c4,
                          5,
                          c5,
                          6,
                          c6,
                          7,
                          c7,
                          8,
                          c8,
                          9,
                          c9,
                          10,
                          c10,
                          11,
                          c11,
                          12,
                          c12,
                          13,
                          c13,
                          14,
                          c14,
                          15,
                          c15,
                          16,
                          c16,
                          17,
                          c17,
                          18,
                          c18,
                          19,
                          c19,
                          20,
                          c20,
                          21,
                          c21,
                          22,
                          c22,
                          23,
                          c23,
                          24,
                          c24,
                          25,
                          c25,
                          26,
                          c26,
                          27,
                          c27,
                          28,
                          c28,
                          29,
                          c29,
                          30,
                          c30,
                          31,
                          c31) title
              FROM (SELECT pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T012') c1,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T013') c2,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T004') c3,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T019') c4,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T052') c5,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T053') c6,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T054') c7,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T010') c8,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T055') c9,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T056') c10,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T025') c11,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T008') c12,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T057') c13,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T058') c14,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T059') c15,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T039') c16,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T040') c17,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T041') c18,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T042') c19,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T040') c20,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T042') c21,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T050') c22,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T082') c23,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T109') c24,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T110') c25,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T111') c26,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T112') c27,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T033') c28,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T034') c29,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T035') c30,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T036') c31
                      FROM dual),
                   (SELECT rownum r
                      FROM all_objects
                     WHERE rownum <= 31);
    
        g_error := 'GET INSTITUTION AFFILIATIONS CURSOR';
        OPEN o_inst_affiliations FOR
            SELECT a.id_account,
                   pk_translation.get_translation(i_lang, a.code_account) account_name,
                   a.fill_type,
                   a.sys_domain_identifier,
                   (SELECT ia.value
                      FROM institution_accounts ia
                     WHERE ia.id_account = a.id_account
                       AND ia.id_institution = i_id_institution) VALUE,
                   decode(a.fill_type,
                          'M',
                          nvl((pk_sysdomain.get_domain(a.sys_domain_identifier,
                                                       (SELECT ia.value
                                                          FROM institution_accounts ia
                                                         WHERE ia.id_account = a.id_account
                                                           AND ia.id_institution = i_id_institution),
                                                       i_lang)),
                              NULL),
                          (SELECT ia.value
                             FROM institution_accounts ia
                            WHERE ia.id_account = a.id_account
                              AND ia.id_institution = i_id_institution)) value_desc
              FROM accounts a, accounts_country ac
             WHERE a.flg_available = 'Y'
               AND a.flg_type IN ('I', 'B')
               AND pk_translation.get_translation(i_lang, a.code_account) IS NOT NULL
               AND a.id_account = ac.id_account
               AND ac.id_country = (SELECT ia2.id_country
                                      FROM inst_attributes ia2
                                     WHERE ia2.id_institution = i_id_institution);
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_inst_general_attr_list);
                pk_types.open_my_cursor(o_inst_admin_attr_list);
                pk_types.open_my_cursor(o_inst_license_attr_list);
                pk_types.open_my_cursor(o_inst_title_list);
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_INSTITUTION_CHANGE_DETAILS');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_institution_change_details;

    /** @headcom
    * Public Function. Get In Use and Not In Use Licenses
    *
    * @param      i_lang          Identificação do profissional
    * @param      i_id_prof          Identificação do profissional
    * @param      O_IN_USE                   Número de licenças em uso
    * @param      O_NOT_IN_USE               Número de licenças que não estão em uso
    * @param      O_CANCELLED                Número de licenças canceladas
    * @param      o_waiting
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenco - EL
    * @version    0.1
    * @since      2007/07/23
    */
    FUNCTION get_in_use_licenses
    (
        i_lang       IN language.id_language%TYPE,
        i_id_prof    IN professional.id_professional%TYPE,
        o_in_use     OUT NUMBER,
        o_not_in_use OUT NUMBER,
        o_cancelled  OUT NUMBER,
        o_waiting    OUT NUMBER,
        o_error      OUT t_error_out
    ) RETURN BOOLEAN IS
        sql_stmt VARCHAR2(1000);
    BEGIN
        g_error  := 'GET IN USE LICENSES - IN USE';
        sql_stmt := 'SELECT COUNT(*)
          FROM aol.license aol_l
         WHERE aol_l.flg_status = :g_flg_avail
           AND aol_l.id_profile_template_desc IS NOT NULL
           AND aol_l.id_institution IN (SELECT i.id_institution
                                          FROM institution i,
                                               (SELECT id_institution
                                                  FROM prof_profile_template ppt
                                                 WHERE ppt.id_professional = :i_id_prof
                                                   AND id_profile_template = 30) admin_inst
                                         WHERE i.id_institution = admin_inst.id_institution
                                            OR i.id_parent = admin_inst.id_institution
                                           AND i.flg_available = ''Y'')
           AND aol_l.id_professional IS NOT NULL';
        EXECUTE IMMEDIATE sql_stmt
            INTO o_in_use
            USING g_flg_avail, i_id_prof;
    
        g_error  := 'GET IN USE LICENSES - NOT IN USE';
        sql_stmt := 'SELECT COUNT(*)
          FROM aol.license aol_l
         WHERE aol_l.flg_status = :g_flg_avail
           AND aol_l.id_profile_template_desc IS NOT NULL
           AND aol_l.id_institution IN (SELECT i.id_institution
                                          FROM institution i,
                                               (SELECT id_institution
                                                  FROM prof_profile_template ppt
                                                 WHERE ppt.id_professional = :i_id_prof
                                                   AND id_profile_template = 30) admin_inst
                                         WHERE i.id_institution = admin_inst.id_institution
                                            OR i.id_parent = admin_inst.id_institution
                                           AND i.flg_available = ''Y'')
           AND aol_l.id_professional IS NULL';
        EXECUTE IMMEDIATE sql_stmt
            INTO o_not_in_use
            USING g_flg_avail, i_id_prof;
    
        g_error  := 'GET CANCELLED LICENSES - CANCELLED';
        sql_stmt := 'SELECT COUNT(*)
          FROM aol.license aol_l
         WHERE aol_l.flg_status = ''C''
           AND aol_l.id_profile_template_desc IS NOT NULL
           AND aol_l.id_institution IN (SELECT i.id_institution
                                          FROM institution i,
                                               (SELECT id_institution
                                                  FROM prof_profile_template ppt
                                                 WHERE ppt.id_professional = :i_id_prof
                                                   AND id_profile_template = 30) admin_inst
                                         WHERE i.id_institution = admin_inst.id_institution
                                            OR i.id_parent = admin_inst.id_institution
                                           AND i.flg_available = ''Y'')';
        EXECUTE IMMEDIATE sql_stmt
            INTO o_cancelled
            USING i_id_prof;
    
        g_error  := 'GET CANCELLED LICENSES - WAITING';
        sql_stmt := 'SELECT COUNT(*)
          FROM aol.license aol_l
         WHERE aol_l.flg_status = ''W''
           AND aol_l.id_profile_template_desc IS NOT NULL
           AND aol_l.id_institution IN (SELECT i.id_institution
                                          FROM institution i,
                                               (SELECT id_institution
                                                  FROM prof_profile_template ppt
                                                 WHERE ppt.id_professional = :i_id_prof
                                                   AND id_profile_template = 30) admin_inst
                                         WHERE i.id_institution = admin_inst.id_institution
                                            OR i.id_parent = admin_inst.id_institution
                                           AND i.flg_available = ''Y'')';
        EXECUTE IMMEDIATE sql_stmt
            INTO o_waiting
            USING i_id_prof;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_IN_USE_LICENSES');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_in_use_licenses;

    /********************************************************************************************
    * Get Professional attributes
    *
    * @param i_lang                Prefered language ID
    * @param i_prof                Professional type (ID, INST, SOFTWARE)
    * @param i_id_professional     Professional ID
    * @param i_id_institution      Institution ID
    * @param o_prof_attr           Cursor with profissional attributes
    * @param o_prof_affiliations   Cursor with profissional affiliations
    * @param o_error               Error
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      JTS
    * @version                     1.0
    * @since                       2009/09/22
    ********************************************************************************************/
    FUNCTION get_professional_attributes
    (
        i_lang              IN language.id_language%TYPE,
        i_prof              IN profissional,
        i_id_professional   IN professional.id_professional%TYPE,
        i_id_institution    IN institution.id_institution%TYPE,
        o_prof_attr         OUT pk_types.cursor_type,
        o_prof_affiliations OUT pk_types.cursor_type,
        o_error             OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_id_country     inst_attributes.id_country%TYPE;
        l_id_country_usa country.id_country%TYPE := 840;
    
        l_error_out t_error_out;
        l_exception EXCEPTION;
    
    BEGIN
    
        l_id_country := get_institution_country(i_lang, i_id_institution, l_error_out);
    
        IF l_id_country != l_id_country_usa
        THEN
            IF NOT get_prof_attributes(i_lang, i_prof, i_id_professional, i_id_institution, o_prof_attr, l_error_out)
            THEN
                RAISE l_exception;
            END IF;
        
        ELSE
        
            IF NOT
                get_prof_attributes_usa(i_lang, i_prof, i_id_professional, i_id_institution, o_prof_attr, l_error_out)
            THEN
                RAISE l_exception;
            END IF;
        
        END IF;
    
        IF NOT get_prof_accounts(i_lang, i_id_professional, i_id_institution, o_prof_affiliations, l_error_out)
        THEN
            RAISE l_exception;
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN l_exception THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error || ' / ' || l_error_out.err_desc,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROFESSIONAL_ATTRIBUTES',
                                              o_error);
            pk_utils.undo_changes;
            pk_types.open_my_cursor(o_prof_attr);
            pk_types.open_my_cursor(o_prof_affiliations);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROFESSIONAL_ATTRIBUTES',
                                              o_error);
            pk_utils.undo_changes;
            pk_types.open_my_cursor(o_prof_attr);
            pk_types.open_my_cursor(o_prof_affiliations);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
    END get_professional_attributes;

    /** @headcom
    * Public Function. Get Professional Change Details
    *
    * @param      I_LANG                     Identificação do Idioma
    * @param      i_prof
    * @param      I_ID_PROFESSIONAL          Identificação do Profissional
    * @param      o_prof_attr                Cursor com os detalhes do profissional
    * @param      o_title             Cursor com os detalhes do profissional
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenco - EL
    * @version    0.1
    * @since      2007/07/24
    */
    FUNCTION get_prof_change_details
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN profissional,
        i_id_professional IN institution.id_institution%TYPE,
        o_prof_attr       OUT pk_types.cursor_type,
        o_title           OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET PROFESSIONAL ATTRIBUTES CURSOR';
        OPEN o_prof_attr FOR
            SELECT DISTINCT p.name,
                            get_prof_title_desc(i_lang, p.title) title,
                            p.first_name,
                            p.middle_name,
                            p.last_name,
                            p.nick_name,
                            p.initials,
                            pk_date_utils.date_chr_extend(i_lang, p.dt_birth, i_prof) string_birth,
                            pk_sysdomain.get_domain('PROFESSIONAL.GENDER', p.gender, i_lang) desc_gender,
                            pk_sysdomain.get_domain('PROFESSIONAL.MARITAL_STATUS', p.marital_status, i_lang) desc_marital_status,
                            pk_translation.get_translation(i_lang, cat.code_category) cat,
                            pk_translation.get_translation(i_lang, s.code_speciality) spec,
                            p.num_order,
                            p.upin,
                            p.dea,
                            pk_translation.get_translation(i_lang,
                                                           (SELECT cs.code_category_sub
                                                              FROM category_sub cs
                                                             WHERE cs.id_category_sub = pcat.id_category_sub)) category_in_surgery,
                            pi.num_mecan,
                            get_prof_language(i_lang, p.id_professional, pi.id_institution) desc_lang,
                            p.flg_state,
                            p.address,
                            p.city,
                            p.district,
                            p.zip_code,
                            pk_translation.get_translation(i_lang, c.code_country) country,
                            p.work_phone,
                            p.num_contact home_phone,
                            p.cell_phone,
                            p.fax,
                            p.email
              FROM professional p, speciality s, category cat, prof_institution pi, country c, prof_cat pcat
             WHERE p.id_professional = i_id_professional
               AND nvl(p.flg_prof_test, pk_alert_constant.get_no) = pk_alert_constant.get_no
               AND p.id_professional = pcat.id_professional
               AND p.id_professional = pi.id_professional
               AND p.id_speciality = s.id_speciality
               AND p.id_country = c.id_country
               AND cat.id_category = pcat.id_category
               AND pi.id_institution = i_prof.institution
               AND s.flg_available = g_flg_avail
               AND cat.flg_available = g_flg_avail
               AND pi.flg_state = g_active
               AND c.flg_available = g_flg_avail;
    
        g_error := 'GET TITLE CURSOR';
        OPEN o_title FOR
            SELECT pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T068') name,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T038') title,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T073') first_name,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T074') middle_name,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T075') last_name,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T040') nick_name,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T039') initials,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T082') string_birth,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T050') desc_gender,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T012') desc_marital_status,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T042') cat,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T009') spec,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T003') num_order,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T113') upin,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T114') dea,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T035') category_in_surgery,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T055') num_mecan,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T115') desc_lang,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T056') flg_state,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T014') address,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T016') city,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T017') district,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T015') zip_code,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T116') country,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T117') work_phone,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T118') home_phone,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T111') cell_phone,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T112') fax,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T109') email
              FROM dual;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_prof_attr);
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_PROFESSIONAL_CHANGE_DETAILS');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_prof_change_details;

    /********************************************************************************************
    * Validates if num_order exist
    * Return true, if not exist. Returns false otherwise
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_institution        Institution ID
    * @param i_num_order             Order Number
    * @param o_flag_result           True if not exist, False if exist
    * @param o_error                 Error
    *
    * @return                      true or false on success or error
    *
    * @author                      Nuno Neves
    * @version                     2.5.1.3
    * @since                       2010/12/14
    ********************************************************************************************/
    FUNCTION exist_num_order
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        i_num_order      IN professional.num_order%TYPE,
        o_flag_result    OUT BOOLEAN,
        o_error          OUT t_error_out
    )
    
     RETURN BOOLEAN IS
    
        l_count_num_order INTEGER;
        l_id_market       institution.id_institution%TYPE;
    
    BEGIN
    
        -- get id market
        l_id_market := pk_utils.get_institution_market(i_lang, i_id_institution);
    
        SELECT COUNT(p.num_order)
          INTO l_count_num_order
          FROM professional p
         INNER JOIN prof_institution pi
            ON p.id_professional = pi.id_professional
         INNER JOIN institution i
            ON pi.id_institution = i.id_institution
           AND i.id_market = l_id_market
         WHERE p.num_order = i_num_order;
    
        --Validates if num_order exist
        IF l_count_num_order > 0
        THEN
            o_flag_result := TRUE;
        ELSE
            o_flag_result := FALSE;
        END IF;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'EXIST_NUM_ORDER',
                                              o_error);
        
            RETURN FALSE;
    END;

    FUNCTION get_prof_specialities
    (
        i_lang    IN language.id_language%TYPE,
        i_prof    IN profissional,
        i_prof_id IN NUMBER,
        o_list    OUT pk_types.cursor_type,
        o_error   OUT t_error_out
    ) RETURN BOOLEAN AS
    BEGIN
        OPEN o_list FOR
            SELECT ps.id_speciality,
                   ps.spec_ballot,
                   ps.id_institution_ext,
                   pk_translation.get_translation(i_lang, s.code_speciality) desc_speciality,
                   ie.institution_name,
                   ie.shortname
              FROM prof_specialities ps
             INNER JOIN speciality s
                ON ps.id_speciality = s.id_speciality
              LEFT JOIN institution_ext ie
                ON ps.id_institution_ext = ie.id_institution_ext
             WHERE ps.id_professional = i_prof_id
             ORDER BY rank;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_SPECIALITIES',
                                              o_error);
        
            RETURN FALSE;
        
    END get_prof_specialities;

    FUNCTION set_prof_specialities
    (
        i_lang                    IN language.id_language%TYPE,
        i_prof                    IN NUMBER,
        i_prof_spec_id            IN table_number,
        i_prof_spec_ballot        IN table_varchar,
        i_prof_spec_id_university IN table_number,
        o_spec_main               OUT NUMBER,
        o_error                   OUT t_error_out
    ) RETURN BOOLEAN AS
        l_seq_spec_id NUMBER;
        l_rows_out    table_varchar;
    BEGIN
    
        IF i_prof_spec_id IS NOT NULL
           AND i_prof_spec_id.count > 0
        THEN
            DELETE FROM prof_specialities a
             WHERE a.id_professional = i_prof;
        
            FOR i IN 1 .. i_prof_spec_id.count
            LOOP
                l_seq_spec_id := seq_prof_specialities.nextval;
                ts_prof_specialities.ins(id_prof_specialities_in => l_seq_spec_id,
                                         id_professional_in      => i_prof,
                                         id_speciality_in        => i_prof_spec_id(i),
                                         spec_ballot_in          => i_prof_spec_ballot(i),
                                         id_institution_ext_in   => i_prof_spec_id_university(i),
                                         speciality_main_in      => CASE
                                                                        WHEN i = 1 THEN
                                                                         'Y'
                                                                        ELSE
                                                                         'N'
                                                                    END,
                                         rank_in                 => i,
                                         rows_out                => l_rows_out);
            END LOOP;
        
            o_spec_main := i_prof_spec_id(1);
        END IF;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'EXIST_NUM_ORDER',
                                              o_error);
        
            RETURN FALSE;
        
    END set_prof_specialities;

    /** @headcom
    * Public Function. Set Professional
    * Insere profissional ou actualiza detalhes se j?existir
    *
    * @param      I_LANG                     Identificação do Idioma
    * @param      I_ID_PROF                  Identificação do Profissional
    * @param      --I_NAME                     Nome 
    * @param      I_TITLE                    Título
    * @param      I_FIRST_NAME               Primeiro nome
    * @param      I_MIDDLE_NAME              Nomes do meio
    * @param      I_LAST_NAME                Último nome
    * @param      I_NICK_NAME                Nome abreviado
    * @param      I_INITIALS                 Iniciais do nome
    * @param      I_DT_BIRTH                 Data de nascimento
    * @param      I_GENDER                   Sexo
    * @param      I_MARITAL_STATUS           Estado civil
    * @param      I_ID_CATEGORY              Identificador da categoria
    * @param      I_ID_SPECIALITY            Identificador da especialidade
    * @param      I_NUM_ORDER                Número da ordem
    * @param      I_UPIN                     UPIN
    * @param      I_DEA                      DEA
    * @param      I_ID_CAT_SURGERY           Identificador da categoria em cirurgia
    * @param      I_NUM_MECAN                Número mecanográfico
    * @param      I_ID_LANG                  Identificador da língua
    * @param      I_FLG_STATE                Estado
    * @param      I_ADDRESS                  Morada
    * @param      I_CITY                     Localidade
    * @param      I_DISTRICT                 Concelho
    * @param      I_ZIP_CODE                 Código postal
    * @param      I_ID_COUNTRY               Identificador do país
    * @param      I_WORK_PHONE               Telefone do trabalho
    * @param      I_NUM_CONTACT              Telefone de casa
    * @param      I_CELL_PHONE               Telemóvel
    * @param      I_FAX                      Fax
    * @param      I_EMAIL                    E-mail
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenco - EL
    * @version    0.1
    * @since      2007/07/24
    */
    FUNCTION set_professional
    (
        i_lang                    IN language.id_language%TYPE,
        i_id_institution          IN institution.id_institution%TYPE,
        i_id_prof                 IN professional.id_professional%TYPE,
        i_title                   IN professional.title%TYPE,
        i_first_name              IN professional.first_name%TYPE,
        i_middle_name             IN professional.middle_name%TYPE,
        i_last_name               IN professional.last_name%TYPE,
        i_nick_name               IN professional.nick_name%TYPE,
        i_initials                IN professional.initials%TYPE,
        i_dt_birth                IN VARCHAR2,
        i_gender                  IN professional.gender%TYPE,
        i_marital_status          IN professional.marital_status%TYPE,
        i_id_category             IN category.id_category%TYPE,
        i_id_speciality           IN professional.id_speciality%TYPE,
        i_id_scholarship          IN professional.id_scholarship%TYPE,
        i_num_order               IN professional.num_order%TYPE,
        i_upin                    IN professional.upin%TYPE,
        i_dea                     IN professional.dea%TYPE,
        i_id_cat_surgery          IN category.id_category%TYPE,
        i_num_mecan               IN prof_institution.num_mecan%TYPE,
        i_id_lang                 IN prof_preferences.id_language%TYPE,
        i_flg_state               IN prof_institution.flg_state%TYPE,
        i_address                 IN professional.address%TYPE,
        i_city                    IN professional.city%TYPE,
        i_district                IN professional.district%TYPE,
        i_zip_code                IN professional.zip_code%TYPE,
        i_id_country              IN professional.id_country%TYPE,
        i_work_phone              IN professional.work_phone%TYPE,
        i_num_contact             IN professional.num_contact%TYPE,
        i_cell_phone              IN professional.cell_phone%TYPE,
        i_fax                     IN professional.fax%TYPE,
        i_email                   IN professional.email%TYPE,
        i_commit_at_end           IN BOOLEAN,
        i_id_road                 IN professional.id_road%TYPE,
        i_entity                  IN professional.id_entity%TYPE,
        i_jurisdiction            IN professional.id_jurisdiction%TYPE,
        i_municip                 IN professional.id_municip%TYPE,
        i_localidad               IN professional.id_localidad%TYPE,
        i_id_postal_code_rb       IN professional.id_postal_code_rb%TYPE,
        i_parent_name             IN professional.parent_name%TYPE,
        i_first_name_sa           IN professional.first_name_sa%TYPE,
        i_parent_name_sa          IN professional.parent_name_sa%TYPE,
        i_middle_name_sa          IN professional.middle_name_sa%TYPE,
        i_last_name_sa            IN professional.last_name_sa%TYPE,
        i_agrupacion              IN professional.id_agrupacion%TYPE,
        i_adress_type             IN professional.adress_type%TYPE DEFAULT NULL,
        i_bleep_num               IN professional.bleep_number%TYPE DEFAULT NULL,
        i_suffix                  IN professional.suffix%TYPE DEFAULT NULL,
        i_county                  IN professional.county%TYPE DEFAULT NULL,
        i_other_adress            IN professional.address_other_name%TYPE DEFAULT NULL,
        i_contact_det             IN prof_institution.contact_detail%TYPE DEFAULT NULL,
        i_doc_ident_type          IN prof_doc.id_doc_type%TYPE,
        i_doc_ident_num           IN prof_doc.value%TYPE,
        i_doc_ident_val           IN VARCHAR2,
        i_tin                     IN professional.taxpayer_number%TYPE,
        i_clinical_name           IN professional.clinical_name%TYPE,
        i_prof_spec_id            IN table_number,
        i_prof_spec_ballot        IN table_varchar,
        i_prof_spec_id_university IN table_number,
        i_agrupacion_instit_id    IN professional.id_agrupacion_instit%TYPE,
        o_id_prof                 OUT professional.id_professional%TYPE,
        o_error                   OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_name                professional.name%TYPE;
        l_second_name         professional.middle_name%TYPE;
        l_last_name           professional.last_name%TYPE;
        l_id_prof_cat         prof_cat.id_prof_cat%TYPE;
        l_id_prof_institution prof_institution.id_prof_institution%TYPE;
        l_id_prof_preferences prof_preferences.id_prof_preferences%TYPE;
        l_flg_state           professional.flg_state%TYPE := g_active;
        l_flg_prof_state      professional.flg_state%TYPE := g_active;
        l_id_country          professional.id_country%TYPE;
        l_sof_null            NUMBER;
        l_pc_null             NUMBER;
    
        l_spec_main professional.id_speciality%TYPE;
    
        l_flg_state_out VARCHAR2(200);
        l_icon_out      VARCHAR2(200);
        l_res           BOOLEAN;
    
        l_flag_result BOOLEAN;
        l_num_order   professional.num_order%TYPE;
    
        l_state           prof_institution.flg_state%TYPE;
        l_dt_end_tstz     TIMESTAMP(6) WITH LOCAL TIME ZONE;
        l_num_mecano      prof_institution.num_mecan%TYPE;
        l_flg_schedulable prof_institution.flg_schedulable%TYPE;
    
        my_exception EXCEPTION;
        l_error VARCHAR(4000);
        -- 18/02/2011: RMGM         
        l_num_order_dup   VARCHAR2(200) := 'PROF_NUM_ORDER_DUPLICATE';
        l_num_order_valid sys_config.value%TYPE;
        -- core tables new params
        l_soft_inst_pk    ab_soft_inst_user_info.id_ab_software_institution%TYPE := NULL;
        l_role_sw_inst_pk ab_soft_inst_user_info.id_ab_software_inst_role%TYPE := NULL;
        l_role_id         ab_soft_inst_user_info.id_ab_role%TYPE := NULL;
        l_comp_id         VARCHAR2(200) := '';
        l_prof_pref_pk    prof_preferences.id_prof_preferences%TYPE := NULL;
        l_pi_id           prof_institution.id_prof_institution%TYPE;
    
        l_validation sys_config.value%TYPE;
    
        l_email VARCHAR2(400) := lower(i_email);
    
        l_count_active_inst NUMBER(12) := 0;
    
        l_rows_out table_varchar;
    
    BEGIN
    
        g_sysdate := SYSDATE;
    
        l_validation := pk_sysconfig.get_config(g_config_contact, profissional(i_id_prof, i_id_institution, 0));
    
        IF l_validation = 'Y'
        THEN
            IF NOT validate_email(profissional(i_id_prof, i_id_institution, 0), l_email)
            THEN
                l_error := pk_message.get_message(i_lang, 'PROFESSIONAL_M010');
                RAISE my_exception;
            END IF;
        
            IF NOT validate_phones(profissional(i_id_prof, i_id_institution, 0), i_work_phone, i_num_contact)
            THEN
                l_error := pk_message.get_message(i_lang, 'PROFESSIONAL_M011');
                RAISE my_exception;
            END IF;
        END IF;
    
        IF (i_first_name IS NULL AND i_middle_name IS NULL AND i_last_name IS NULL)
           OR i_nick_name IS NULL
        THEN
            l_error := pk_message.get_message(i_lang, 'PROFESSIONAL_M001');
            RAISE my_exception;
        ELSIF i_gender IS NULL
        THEN
            l_error := pk_message.get_message(i_lang, 'PROFESSIONAL_M002');
            RAISE my_exception;
        ELSIF i_id_lang IS NULL
        THEN
            l_error := pk_message.get_message(i_lang, 'PROFESSIONAL_M006');
            RAISE my_exception;
        ELSIF i_id_category IS NULL
        THEN
            l_error := pk_message.get_message(i_lang, 'PROFESSIONAL_M007');
            RAISE my_exception;
        ELSE
        
            IF i_id_country = -1
               OR i_id_country IS NULL
            THEN
                l_id_country := NULL;
            ELSE
                l_id_country := i_id_country;
            END IF;
        
            l_name := create_name_formated(i_lang,
                                           i_id_institution,
                                           i_first_name,
                                           i_parent_name,
                                           i_middle_name,
                                           i_last_name);
        
            l_flg_state := i_flg_state;
            --INSERT
            IF i_id_prof IS NULL
            THEN
            
                l_num_order_valid := pk_sysconfig.get_config(l_num_order_dup,
                                                             profissional(i_id_prof, i_id_institution, 0));
                IF l_num_order_valid = 'Y'
                THEN
                    --Validates if num_order exist
                    g_error := 'Validates if num_order exist';
                    IF NOT exist_num_order(i_lang, i_id_institution, i_num_order, l_flag_result, o_error)
                    THEN
                        RAISE my_exception;
                    END IF;
                
                    --if num_order exist
                    IF l_flag_result = TRUE
                    THEN
                        l_error := pk_message.get_message(i_lang, 'PROFESSIONAL_M009');
                        RAISE my_exception;
                    END IF;
                END IF;
            
                g_error := 'INSERT INTO PROFESSIONAL';
                pk_api_ab_tables.upd_ins_into_ab_user_info(i_id_ab_user_info    => NULL,
                                                           i_login              => NULL,
                                                           i_password           => NULL,
                                                           i_import_code        => NULL,
                                                           i_record_status      => g_prof_flg_state_active,
                                                           i_institution_key    => i_id_institution,
                                                           i_flg_is_enable      => l_flg_state,
                                                           i_first_name         => i_first_name,
                                                           i_last_name          => i_last_name,
                                                           i_full_name          => l_name,
                                                           i_external_system    => NULL,
                                                           i_external_system_id => NULL,
                                                           i_secret_quest       => NULL,
                                                           i_secret_answ        => NULL,
                                                           i_id_language        => i_id_lang,
                                                           i_flg_temporary      => 'N',
                                                           i_date_creation_tstz => NULL,
                                                           o_id_ab_user_info    => o_id_prof);
            
                ts_professional.ins(id_professional_in      => o_id_prof,
                                    name_in                 => l_name,
                                    nick_name_in            => i_nick_name || CASE
                                                                   WHEN i_title IS NULL THEN
                                                                    NULL
                                                                   ELSE
                                                                    ', ' || get_prof_title_desc(i_lang, i_title)
                                                               END,
                                    dt_birth_in             => get_date_received(i_lang, i_dt_birth),
                                    address_in              => i_address,
                                    district_in             => i_district,
                                    city_in                 => i_city,
                                    zip_code_in             => i_zip_code,
                                    num_contact_in          => i_num_contact,
                                    marital_status_in       => i_marital_status,
                                    gender_in               => i_gender,
                                    flg_state_in            => nvl(l_flg_state, g_active),
                                    num_order_in            => i_num_order,
                                    id_scholarship_in       => i_id_scholarship,
                                    id_speciality_in        => l_spec_main,
                                    id_country_in           => l_id_country,
                                    initials_in             => i_initials,
                                    title_in                => i_title,
                                    short_name_in           => i_nick_name,
                                    cell_phone_in           => i_cell_phone,
                                    fax_in                  => i_fax,
                                    email_in                => l_email,
                                    first_name_in           => i_first_name,
                                    middle_name_in          => i_middle_name,
                                    last_name_in            => i_last_name,
                                    work_phone_in           => i_work_phone,
                                    upin_in                 => i_upin,
                                    dea_in                  => i_dea,
                                    adress_type_in          => i_adress_type,
                                    bleep_number_in         => i_bleep_num,
                                    suffix_in               => i_suffix,
                                    county_in               => i_county,
                                    address_other_name_in   => i_other_adress,
                                    id_road_in              => i_id_road,
                                    id_entity_in            => i_entity,
                                    id_municip_in           => i_municip,
                                    id_localidad_in         => i_localidad,
                                    id_postal_code_rb_in    => i_id_postal_code_rb,
                                    id_jurisdiction_in      => i_jurisdiction,
                                    parent_name_in          => i_parent_name,
                                    first_name_sa_in        => i_first_name_sa,
                                    parent_name_sa_in       => i_parent_name_sa,
                                    middle_name_sa_in       => i_middle_name_sa,
                                    last_name_sa_in         => i_last_name_sa,
                                    id_agrupacion_in        => i_agrupacion,
                                    taxpayer_number_in      => i_tin,
                                    clinical_name_in        => i_clinical_name,
                                    id_agrupacion_instit_in => i_agrupacion_instit_id,
                                    rows_out                => l_rows_out);
            
                g_error := 'SET_PROF_SPECIALITIES';
                IF NOT set_prof_specialities(i_lang                    => i_lang,
                                             i_prof                    => o_id_prof,
                                             i_prof_spec_id            => i_prof_spec_id,
                                             i_prof_spec_ballot        => i_prof_spec_ballot,
                                             i_prof_spec_id_university => i_prof_spec_id_university,
                                             o_spec_main               => l_spec_main,
                                             o_error                   => o_error)
                THEN
                    RAISE my_exception;
                END IF;
            
                ts_professional.upd(id_professional_in => o_id_prof,
                                    id_speciality_in   => l_spec_main,
                                    id_speciality_nin  => FALSE,
                                    rows_out           => l_rows_out);
                IF i_doc_ident_num IS NOT NULL
                THEN
                    ins_prof_doc(i_lang            => i_lang,
                                 i_id_professional => o_id_prof,
                                 i_id_institution  => i_id_institution,
                                 i_doc_type        => i_doc_ident_type,
                                 i_doc_num         => i_doc_ident_num,
                                 i_doc_ident_val   => i_doc_ident_val);
                
                END IF;
            
                g_error := 'INSERT INTO PROFESSIONAL HISTORY';
                ins_professional_hist(i_id_professional => o_id_prof, i_operation_type => g_prof_hist_oper_c);
            
                g_error := 'INSERT INTO PROF_INSTITUTION';
                pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                               i_id_professional     => o_id_prof,
                                                               i_id_institution      => i_id_institution,
                                                               i_flg_state           => l_flg_state,
                                                               i_num_mecan           => i_num_mecan,
                                                               i_dt_begin_tstz       => g_sysdate_tstz,
                                                               i_flg_external        => 'N',
                                                               i_contact_det         => i_contact_det,
                                                               o_id_prof_institution => l_id_prof_institution);
            
                g_error := 'GET SEQ_PROF_CATEGORY.NEXTVAL';
                SELECT seq_prof_cat.nextval
                  INTO l_id_prof_cat
                  FROM dual;
            
                g_error := 'INSERT INTO PROF_CAT';
                INSERT INTO prof_cat
                    (id_prof_cat, id_professional, id_category, id_institution, id_category_sub)
                VALUES
                    (l_id_prof_cat, o_id_prof, i_id_category, i_id_institution, i_id_cat_surgery);
            
            ELSE
            
                --UPDATE
                SELECT p.num_order
                  INTO l_num_order
                  FROM professional p
                 WHERE p.id_professional = i_id_prof;
            
                --Check if the user is active i other institutions
                SELECT COUNT(1) COLLECT
                  INTO l_count_active_inst
                  FROM prof_institution pi
                 WHERE pi.id_professional = i_id_prof
                   AND pi.dt_end_tstz IS NULL
                   AND pi.flg_state = g_active
                   AND pi.id_institution <> i_id_institution;
            
                --If the user is still active for other institutions, he should not be inactivated in professional and ab_user_info
                IF l_count_active_inst > 0
                THEN
                    l_flg_prof_state := g_active;
                ELSE
                    l_flg_prof_state := l_flg_state;
                END IF;
            
                g_error := 'SET_PROF_SPECIALITIES';
                IF NOT set_prof_specialities(i_lang                    => i_lang,
                                             i_prof                    => i_id_prof,
                                             i_prof_spec_id            => i_prof_spec_id,
                                             i_prof_spec_ballot        => i_prof_spec_ballot,
                                             i_prof_spec_id_university => i_prof_spec_id_university,
                                             o_spec_main               => l_spec_main,
                                             o_error                   => o_error)
                THEN
                    RAISE my_exception;
                END IF;
                --validate that the order number entered is similar to existing (does not update the order number)
                IF i_num_order = l_num_order
                THEN
                    g_error := 'UPDATE PROFESSIONAL';
                    pk_api_ab_tables.upd_ins_into_ab_user_info(i_id_ab_user_info    => i_id_prof,
                                                               i_login              => NULL,
                                                               i_password           => NULL,
                                                               i_import_code        => NULL,
                                                               i_record_status      => g_prof_flg_state_active,
                                                               i_institution_key    => i_id_institution,
                                                               i_flg_is_enable      => l_flg_prof_state,
                                                               i_first_name         => i_first_name,
                                                               i_last_name          => i_last_name,
                                                               i_full_name          => l_name,
                                                               i_external_system    => NULL,
                                                               i_external_system_id => NULL,
                                                               i_secret_quest       => NULL,
                                                               i_secret_answ        => NULL,
                                                               i_id_language        => i_id_lang,
                                                               i_flg_temporary      => 'N',
                                                               i_date_creation_tstz => NULL,
                                                               o_id_ab_user_info    => o_id_prof);
                
                    ts_professional.upd(id_professional_in       => o_id_prof,
                                        name_in                  => l_name,
                                        name_nin                 => FALSE,
                                        nick_name_in             => i_nick_name || CASE
                                                                        WHEN i_title IS NULL THEN
                                                                         NULL
                                                                        ELSE
                                                                         ', ' || get_prof_title_desc(i_lang, i_title)
                                                                    END,
                                        nick_name_nin            => FALSE,
                                        dt_birth_in              => get_date_received(i_lang, i_dt_birth),
                                        dt_birth_nin             => FALSE,
                                        address_in               => i_address,
                                        address_nin              => FALSE,
                                        district_in              => i_district,
                                        district_nin             => FALSE,
                                        city_in                  => i_city,
                                        city_nin                 => FALSE,
                                        zip_code_in              => i_zip_code,
                                        zip_code_nin             => FALSE,
                                        num_contact_in           => i_num_contact,
                                        num_contact_nin          => FALSE,
                                        marital_status_in        => i_marital_status,
                                        marital_status_nin       => FALSE,
                                        gender_in                => i_gender,
                                        gender_nin               => FALSE,
                                        flg_state_in             => l_flg_prof_state,
                                        id_scholarship_in        => i_id_scholarship,
                                        id_scholarship_nin       => FALSE,
                                        id_speciality_in         => l_spec_main,
                                        id_speciality_nin        => FALSE,
                                        id_country_in            => l_id_country,
                                        id_country_nin           => FALSE,
                                        initials_in              => i_initials,
                                        initials_nin             => FALSE,
                                        title_in                 => i_title,
                                        title_nin                => FALSE,
                                        short_name_in            => i_nick_name,
                                        short_name_nin           => FALSE,
                                        cell_phone_in            => i_cell_phone,
                                        cell_phone_nin           => FALSE,
                                        fax_in                   => i_fax,
                                        fax_nin                  => FALSE,
                                        email_in                 => l_email,
                                        email_nin                => FALSE,
                                        first_name_in            => i_first_name,
                                        first_name_nin           => FALSE,
                                        middle_name_in           => i_middle_name,
                                        middle_name_nin          => FALSE,
                                        last_name_in             => i_last_name,
                                        last_name_nin            => FALSE,
                                        work_phone_in            => i_work_phone,
                                        work_phone_nin           => FALSE,
                                        upin_in                  => i_upin,
                                        upin_nin                 => FALSE,
                                        dea_in                   => i_dea,
                                        dea_nin                  => FALSE,
                                        adress_type_in           => i_adress_type,
                                        adress_type_nin          => FALSE,
                                        bleep_number_in          => i_bleep_num,
                                        bleep_number_nin         => FALSE,
                                        suffix_in                => i_suffix,
                                        suffix_nin               => FALSE,
                                        county_in                => i_county,
                                        county_nin               => FALSE,
                                        address_other_name_in    => i_other_adress,
                                        address_other_name_nin   => FALSE,
                                        id_road_in               => i_id_road,
                                        id_road_nin              => FALSE,
                                        id_entity_in             => i_entity,
                                        id_entity_nin            => FALSE,
                                        id_municip_in            => i_municip,
                                        id_municip_nin           => FALSE,
                                        id_localidad_in          => i_localidad,
                                        id_localidad_nin         => FALSE,
                                        id_postal_code_rb_in     => i_id_postal_code_rb,
                                        id_postal_code_rb_nin    => FALSE,
                                        id_jurisdiction_in       => i_jurisdiction,
                                        id_jurisdiction_nin      => FALSE,
                                        parent_name_in           => i_parent_name,
                                        parent_name_nin          => FALSE,
                                        first_name_sa_in         => i_first_name_sa,
                                        first_name_sa_nin        => FALSE,
                                        parent_name_sa_in        => i_parent_name_sa,
                                        parent_name_sa_nin       => FALSE,
                                        middle_name_sa_in        => i_middle_name_sa,
                                        middle_name_sa_nin       => FALSE,
                                        last_name_sa_in          => i_last_name_sa,
                                        last_name_sa_nin         => FALSE,
                                        id_agrupacion_in         => i_agrupacion,
                                        id_agrupacion_nin        => FALSE,
                                        taxpayer_number_in       => i_tin,
                                        taxpayer_number_nin      => TRUE,
                                        clinical_name_in         => i_clinical_name,
                                        clinical_name_nin        => TRUE,
                                        id_agrupacion_instit_in  => i_agrupacion_instit_id,
                                        id_agrupacion_instit_nin => FALSE,
                                        rows_out                 => l_rows_out);
                
                    --validate that the order number entered is similar to existing (update the order number)
                ELSE
                
                    l_num_order_valid := pk_sysconfig.get_config(l_num_order_dup,
                                                                 profissional(o_id_prof, i_id_institution, 0));
                    IF l_num_order_valid = 'Y'
                    THEN
                        --Validates if num_order exist
                        g_error := 'Validates if num_order exist';
                        IF NOT exist_num_order(i_lang, i_id_institution, i_num_order, l_flag_result, o_error)
                        THEN
                            RAISE my_exception;
                        END IF;
                    
                        --if num_order exist
                        IF l_flag_result = TRUE
                        THEN
                            l_error := pk_message.get_message(i_lang, 'PROFESSIONAL_M009');
                            RAISE my_exception;
                        END IF;
                    END IF;
                
                    g_error := 'UPDATE PROFESSIONAL';
                    pk_api_ab_tables.upd_ins_into_ab_user_info(i_id_ab_user_info    => i_id_prof,
                                                               i_login              => NULL,
                                                               i_password           => NULL,
                                                               i_import_code        => NULL,
                                                               i_record_status      => g_prof_flg_state_active,
                                                               i_institution_key    => i_id_institution,
                                                               i_flg_is_enable      => l_flg_prof_state,
                                                               i_first_name         => i_first_name,
                                                               i_last_name          => i_last_name,
                                                               i_full_name          => l_name,
                                                               i_external_system    => NULL,
                                                               i_external_system_id => NULL,
                                                               i_secret_quest       => NULL,
                                                               i_secret_answ        => NULL,
                                                               i_id_language        => i_id_lang,
                                                               i_flg_temporary      => 'Y',
                                                               i_date_creation_tstz => NULL,
                                                               o_id_ab_user_info    => o_id_prof);
                
                    ts_professional.upd(id_professional_in       => o_id_prof,
                                        name_in                  => l_name,
                                        name_nin                 => FALSE,
                                        nick_name_in             => i_nick_name || CASE
                                                                        WHEN i_title IS NULL THEN
                                                                         NULL
                                                                        ELSE
                                                                         ', ' || get_prof_title_desc(i_lang, i_title)
                                                                    END,
                                        nick_name_nin            => FALSE,
                                        dt_birth_in              => get_date_received(i_lang, i_dt_birth),
                                        dt_birth_nin             => FALSE,
                                        address_in               => i_address,
                                        address_nin              => FALSE,
                                        district_in              => i_district,
                                        district_nin             => FALSE,
                                        city_in                  => i_city,
                                        city_nin                 => FALSE,
                                        zip_code_in              => i_zip_code,
                                        zip_code_nin             => FALSE,
                                        num_contact_in           => i_num_contact,
                                        num_contact_nin          => FALSE,
                                        marital_status_in        => i_marital_status,
                                        marital_status_nin       => FALSE,
                                        gender_in                => i_gender,
                                        gender_nin               => FALSE,
                                        flg_state_in             => l_flg_prof_state,
                                        flg_state_nin            => FALSE,
                                        num_order_in             => i_num_order,
                                        num_order_nin            => FALSE,
                                        id_scholarship_in        => i_id_scholarship,
                                        id_scholarship_nin       => FALSE,
                                        id_speciality_in         => l_spec_main,
                                        id_speciality_nin        => FALSE,
                                        id_country_in            => l_id_country,
                                        id_country_nin           => FALSE,
                                        initials_in              => i_initials,
                                        initials_nin             => FALSE,
                                        title_in                 => i_title,
                                        title_nin                => FALSE,
                                        short_name_in            => i_nick_name,
                                        short_name_nin           => FALSE,
                                        cell_phone_in            => i_cell_phone,
                                        cell_phone_nin           => FALSE,
                                        fax_in                   => i_fax,
                                        fax_nin                  => FALSE,
                                        email_in                 => l_email,
                                        email_nin                => FALSE,
                                        first_name_in            => i_first_name,
                                        first_name_nin           => FALSE,
                                        middle_name_in           => i_middle_name,
                                        middle_name_nin          => FALSE,
                                        last_name_in             => i_last_name,
                                        last_name_nin            => FALSE,
                                        work_phone_in            => i_work_phone,
                                        work_phone_nin           => FALSE,
                                        upin_in                  => i_upin,
                                        upin_nin                 => FALSE,
                                        dea_in                   => i_dea,
                                        dea_nin                  => FALSE,
                                        adress_type_in           => i_adress_type,
                                        adress_type_nin          => FALSE,
                                        bleep_number_in          => i_bleep_num,
                                        bleep_number_nin         => FALSE,
                                        suffix_in                => i_suffix,
                                        suffix_nin               => FALSE,
                                        county_in                => i_county,
                                        county_nin               => FALSE,
                                        address_other_name_in    => i_other_adress,
                                        address_other_name_nin   => FALSE,
                                        id_road_in               => i_id_road,
                                        id_road_nin              => FALSE,
                                        id_entity_in             => i_entity,
                                        id_entity_nin            => FALSE,
                                        id_municip_in            => i_municip,
                                        id_municip_nin           => FALSE,
                                        id_localidad_in          => i_localidad,
                                        id_localidad_nin         => FALSE,
                                        id_postal_code_rb_in     => i_id_postal_code_rb,
                                        id_postal_code_rb_nin    => FALSE,
                                        id_jurisdiction_in       => i_jurisdiction,
                                        id_jurisdiction_nin      => FALSE,
                                        parent_name_in           => i_parent_name,
                                        parent_name_nin          => FALSE,
                                        first_name_sa_in         => i_first_name_sa,
                                        first_name_sa_nin        => FALSE,
                                        parent_name_sa_in        => i_parent_name_sa,
                                        parent_name_sa_nin       => FALSE,
                                        middle_name_sa_in        => i_middle_name_sa,
                                        middle_name_sa_nin       => FALSE,
                                        last_name_sa_in          => i_last_name_sa,
                                        last_name_sa_nin         => FALSE,
                                        id_agrupacion_in         => i_agrupacion,
                                        id_agrupacion_nin        => FALSE,
                                        taxpayer_number_in       => i_tin,
                                        taxpayer_number_nin      => TRUE,
                                        clinical_name_in         => i_clinical_name,
                                        clinical_name_nin        => TRUE,
                                        id_agrupacion_instit_in  => i_agrupacion_instit_id,
                                        id_agrupacion_instit_nin => FALSE,
                                        rows_out                 => l_rows_out);
                END IF;
            
                g_error := 'SET PROFESSIONAL HISTORY';
                ins_professional_hist(i_id_professional => o_id_prof, i_operation_type => g_prof_hist_oper_u);
            
                IF i_doc_ident_num IS NOT NULL
                THEN
                    upd_prof_doc(i_lang            => i_lang,
                                 i_id_professional => o_id_prof,
                                 i_id_institution  => i_id_institution,
                                 i_doc_type        => i_doc_ident_type,
                                 i_doc_num         => i_doc_ident_num,
                                 i_doc_ident_val   => i_doc_ident_val);
                END IF;
            
                g_error := 'GET PROF_INSTITUTION STATE';
                SELECT decode((SELECT COUNT(pi.flg_state)
                                FROM prof_institution pi
                               WHERE pi.id_institution = i_id_institution
                                 AND pi.id_professional = o_id_prof
                                 AND pi.dt_end_tstz IS NULL),
                              0,
                              (SELECT pi.flg_state
                                 FROM prof_institution pi
                                WHERE pi.id_professional = o_id_prof
                                  AND pi.id_institution = i_id_institution
                                  AND pi.dt_end_tstz = (SELECT MAX(pi2.dt_end_tstz)
                                                          FROM prof_institution pi2
                                                         WHERE pi2.id_institution = i_id_institution
                                                           AND pi2.id_professional = o_id_prof)),
                              (SELECT pi.flg_state
                                 FROM prof_institution pi
                                WHERE pi.id_institution = i_id_institution
                                  AND pi.id_professional = o_id_prof
                                  AND pi.dt_end_tstz IS NULL))
                  INTO l_state
                  FROM dual;
            
                IF l_state IS NULL
                   AND i_id_institution IS NOT NULL
                   AND o_id_prof IS NOT NULL
                THEN
                    pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                                   i_id_professional     => o_id_prof,
                                                                   i_id_institution      => i_id_institution,
                                                                   i_flg_state           => i_flg_state,
                                                                   i_num_mecan           => i_num_mecan,
                                                                   i_dt_begin_tstz       => g_sysdate_tstz,
                                                                   i_contact_det         => i_contact_det,
                                                                   o_id_prof_institution => l_id_prof_institution);
                
                    pk_api_ab_tables.upd_ins_into_ab_user_info(i_id_ab_user_info    => o_id_prof,
                                                               i_login              => NULL,
                                                               i_password           => NULL,
                                                               i_import_code        => NULL,
                                                               i_record_status      => g_prof_flg_state_active,
                                                               i_institution_key    => i_id_institution,
                                                               i_flg_is_enable      => l_flg_state,
                                                               i_first_name         => i_first_name,
                                                               i_last_name          => i_last_name,
                                                               i_full_name          => create_name_formated(i_lang,
                                                                                                            i_id_institution,
                                                                                                            i_first_name,
                                                                                                            i_parent_name,
                                                                                                            i_middle_name,
                                                                                                            i_last_name),
                                                               i_external_system    => NULL,
                                                               i_external_system_id => NULL,
                                                               i_secret_quest       => NULL,
                                                               i_secret_answ        => NULL,
                                                               i_id_language        => NULL,
                                                               i_flg_temporary      => 'N',
                                                               i_date_creation_tstz => NULL,
                                                               o_id_ab_user_info    => o_id_prof);
                
                ELSIF i_flg_state = 'A'
                      AND l_state != 'A'
                THEN
                
                    g_error := 'GET ALERT PROFESSIONAL FLG_SCHEDULABLE INFO FOR ID_PROFESSIONAL = ' || i_id_prof ||
                               'IN ID_INSTITUTION = ' || i_id_institution;
                    SELECT nvl(pi.flg_schedulable, 'N')
                      INTO l_flg_schedulable
                      FROM prof_institution pi
                     WHERE pi.id_professional = o_id_prof
                       AND pi.id_institution = i_id_institution
                       AND pi.dt_end_tstz IS NULL
                       AND pi.flg_state = l_state;
                
                    SELECT pi.id_prof_institution
                      INTO l_pi_id
                      FROM prof_institution pi
                     WHERE pi.id_professional = o_id_prof
                       AND pi.id_institution = i_id_institution
                       AND pi.flg_state = l_state
                       AND pi.dt_end_tstz IS NULL;
                
                    g_error := 'UPDATE PROF_INSTITUTION';
                    pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_pi_id,
                                                                   i_id_professional     => o_id_prof,
                                                                   i_id_institution      => i_id_institution,
                                                                   i_dt_end_tstz         => g_sysdate_tstz,
                                                                   i_contact_det         => i_contact_det,
                                                                   o_id_prof_institution => l_id_prof_institution);
                
                    g_error := 'INSERT INTO PROF_INSTITUTION';
                    pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                                   i_id_professional     => o_id_prof,
                                                                   i_id_institution      => i_id_institution,
                                                                   i_flg_state           => i_flg_state,
                                                                   i_num_mecan           => i_num_mecan,
                                                                   i_dt_begin_tstz       => g_sysdate_tstz,
                                                                   i_flg_schedulable     => l_flg_schedulable,
                                                                   i_contact_det         => i_contact_det,
                                                                   o_id_prof_institution => l_id_prof_institution);
                
                ELSIF i_flg_state = 'A'
                      AND l_state = 'A'
                THEN
                
                    g_error := 'GET PROF_INSTITUTION NUM_MECAN';
                    SELECT decode((SELECT pi.num_mecan
                                    FROM prof_institution pi
                                   WHERE pi.id_professional = o_id_prof
                                     AND pi.id_institution = i_id_institution
                                     AND pi.flg_state = i_flg_state
                                     AND pi.dt_end_tstz IS NULL),
                                  
                                  NULL,
                                  NULL,
                                  (SELECT pi.num_mecan
                                     FROM prof_institution pi
                                    WHERE pi.id_professional = o_id_prof
                                      AND pi.id_institution = i_id_institution
                                      AND pi.flg_state = i_flg_state
                                      AND pi.dt_end_tstz IS NULL))
                      INTO l_num_mecano
                      FROM dual;
                
                    IF l_num_mecano IS NULL
                    THEN
                    
                        g_error := 'GET ALERT PROFESSIONAL ID_PROF_INSTITUTION VALID FOR ID_PROFESSIONAL = ' ||
                                   i_id_prof || 'IN ID_INSTITUTION = ' || i_id_institution;
                        SELECT pi.id_prof_institution
                          INTO l_pi_id
                          FROM prof_institution pi
                         WHERE pi.id_professional = o_id_prof
                           AND pi.id_institution = i_id_institution
                           AND pi.flg_state = i_flg_state
                           AND pi.dt_end_tstz IS NULL;
                    
                        g_error := 'UPDATE PROF_INSTITUTION';
                        pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_pi_id,
                                                                       i_id_professional     => o_id_prof,
                                                                       i_id_institution      => i_id_institution,
                                                                       i_flg_state           => i_flg_state,
                                                                       i_num_mecan           => i_num_mecan,
                                                                       i_flg_schedulable     => l_flg_schedulable,
                                                                       i_contact_det         => i_contact_det,
                                                                       o_id_prof_institution => l_id_prof_institution);
                    
                    ELSIF l_num_mecano != i_num_mecan
                    THEN
                    
                        g_error := 'GET ALERT PROFESSIONAL FLG_SCHEDULABLE INFO FOR ID_PROFESSIONAL = ' || o_id_prof ||
                                   'IN ID_INSTITUTION = ' || i_id_institution;
                        SELECT nvl(pi.flg_schedulable, 'N')
                          INTO l_flg_schedulable
                          FROM prof_institution pi
                         WHERE pi.id_professional = o_id_prof
                           AND pi.id_institution = i_id_institution
                           AND pi.flg_state = i_flg_state
                           AND pi.dt_end_tstz IS NULL;
                    
                        g_error := 'UPDATE PROF_INSTITUTION';
                        SELECT pi.id_prof_institution
                          INTO l_pi_id
                          FROM prof_institution pi
                         WHERE pi.id_professional = o_id_prof
                           AND pi.id_institution = i_id_institution
                           AND pi.flg_state = i_flg_state
                           AND pi.dt_end_tstz IS NULL;
                    
                        g_error := 'UPDATE PROF_INSTITUTION';
                        pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_pi_id,
                                                                       i_id_professional     => o_id_prof,
                                                                       i_id_institution      => i_id_institution,
                                                                       i_flg_state           => i_flg_state,
                                                                       i_dt_end_tstz         => g_sysdate_tstz,
                                                                       i_contact_det         => i_contact_det,
                                                                       o_id_prof_institution => l_id_prof_institution);
                    
                        g_error := 'INSERT INTO PROF_INSTITUTION';
                        pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                                       i_id_professional     => o_id_prof,
                                                                       i_id_institution      => i_id_institution,
                                                                       i_flg_state           => i_flg_state,
                                                                       i_num_mecan           => i_num_mecan,
                                                                       i_dt_begin_tstz       => g_sysdate_tstz,
                                                                       i_flg_schedulable     => l_flg_schedulable,
                                                                       i_contact_det         => i_contact_det,
                                                                       o_id_prof_institution => l_id_prof_institution);
                    
                    ELSE
                        g_error := 'GET ALERT PROFESSIONAL ID_PROF_INSTITUTION VALID FOR ID_PROFESSIONAL = ' ||
                                   i_id_prof || 'IN ID_INSTITUTION = ' || i_id_institution;
                        SELECT pi.id_prof_institution
                          INTO l_id_prof_institution
                          FROM prof_institution pi
                         WHERE pi.id_professional = o_id_prof
                           AND pi.id_institution = i_id_institution
                           AND pi.flg_state = i_flg_state
                           AND pi.dt_end_tstz IS NULL;
                    END IF;
                
                ELSIF (i_flg_state = 'I' OR i_flg_state = 'S')
                THEN
                    IF l_state = 'A'
                    THEN
                    
                        g_error := 'GET ALERT PROFESSIONAL FLG_SCHEDULABLE INFO FOR ID_PROFESSIONAL = ' || i_id_prof ||
                                   'IN ID_INSTITUTION = ' || i_id_institution;
                        SELECT nvl(pi.flg_schedulable, 'N')
                          INTO l_flg_schedulable
                          FROM prof_institution pi
                         WHERE pi.id_professional = o_id_prof
                           AND pi.id_institution = i_id_institution
                           AND pi.flg_state = g_status_a
                           AND pi.dt_end_tstz IS NULL;
                    
                        SELECT pi.id_prof_institution
                          INTO l_pi_id
                          FROM prof_institution pi
                         WHERE pi.id_professional = o_id_prof
                           AND pi.id_institution = i_id_institution
                           AND pi.flg_state = g_status_a
                           AND pi.dt_end_tstz IS NULL;
                    
                        g_error := 'UPDATE PROF_INSTITUTION';
                        pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_pi_id,
                                                                       i_id_professional     => o_id_prof,
                                                                       i_id_institution      => i_id_institution,
                                                                       i_flg_state           => g_status_a,
                                                                       i_dt_end_tstz         => g_sysdate_tstz,
                                                                       i_contact_det         => i_contact_det,
                                                                       o_id_prof_institution => l_id_prof_institution);
                    
                        g_error := 'INSERT INTO PROF_INSTITUTION';
                        pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                                       i_id_professional     => o_id_prof,
                                                                       i_id_institution      => i_id_institution,
                                                                       i_flg_state           => i_flg_state,
                                                                       i_num_mecan           => i_num_mecan,
                                                                       i_dt_begin_tstz       => g_sysdate_tstz,
                                                                       i_flg_schedulable     => l_flg_schedulable,
                                                                       i_contact_det         => i_contact_det,
                                                                       o_id_prof_institution => l_id_prof_institution);
                    ELSE
                    
                        IF i_flg_state = l_state
                        THEN
                            SELECT decode((SELECT MAX(pi.dt_end_tstz)
                                            FROM prof_institution pi
                                           WHERE pi.id_professional = o_id_prof
                                             AND pi.id_institution = i_id_institution
                                             AND pi.flg_state = i_flg_state),
                                          NULL,
                                          NULL,
                                          (SELECT MAX(pi.dt_end_tstz)
                                             FROM prof_institution pi
                                            WHERE pi.id_professional = o_id_prof
                                              AND pi.id_institution = i_id_institution
                                              AND pi.flg_state = i_flg_state))
                              INTO l_dt_end_tstz
                              FROM dual;
                        
                            IF l_dt_end_tstz IS NULL
                            THEN
                            
                                g_error := 'GET PROF_INSTITUTION NUM_MECAN';
                                SELECT decode((SELECT pi.num_mecan
                                                FROM prof_institution pi
                                               WHERE pi.id_professional = o_id_prof
                                                 AND pi.id_institution = i_id_institution
                                                 AND pi.flg_state = i_flg_state
                                                 AND pi.dt_end_tstz IS NULL),
                                              
                                              NULL,
                                              NULL,
                                              (SELECT pi.num_mecan
                                                 FROM prof_institution pi
                                                WHERE pi.id_professional = o_id_prof
                                                  AND pi.id_institution = i_id_institution
                                                  AND pi.flg_state = i_flg_state
                                                  AND pi.dt_end_tstz IS NULL))
                                  INTO l_num_mecano
                                  FROM dual;
                            
                                IF l_num_mecano IS NULL
                                THEN
                                
                                    g_error := 'GET ALERT PROFESSIONAL ID_PROF_INSTITUTION VALID FOR ID_PROFESSIONAL = ' ||
                                               o_id_prof || 'IN ID_INSTITUTION = ' || i_id_institution;
                                    SELECT pi.id_prof_institution
                                      INTO l_pi_id
                                      FROM prof_institution pi
                                     WHERE pi.id_professional = o_id_prof
                                       AND pi.id_institution = i_id_institution
                                          --AND pi.flg_state = i_flg_state
                                       AND pi.dt_end_tstz IS NULL;
                                
                                    g_error := 'UPDATE PROF_INSTITUTION';
                                    pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_pi_id,
                                                                                   i_id_professional     => o_id_prof,
                                                                                   i_id_institution      => i_id_institution,
                                                                                   i_flg_state           => l_state,
                                                                                   i_num_mecan           => i_num_mecan,
                                                                                   i_contact_det         => i_contact_det,
                                                                                   o_id_prof_institution => l_id_prof_institution);
                                
                                ELSIF l_num_mecano != i_num_mecan
                                THEN
                                
                                    g_error := 'GET ALERT PROFESSIONAL FLG_SCHEDULABLE INFO FOR ID_PROFESSIONAL = ' ||
                                               o_id_prof || 'IN ID_INSTITUTION = ' || i_id_institution;
                                    SELECT nvl(pi.flg_schedulable, 'N')
                                      INTO l_flg_schedulable
                                      FROM prof_institution pi
                                     WHERE pi.id_professional = o_id_prof
                                       AND pi.id_institution = i_id_institution
                                       AND pi.flg_state = i_flg_state
                                       AND pi.dt_end_tstz IS NULL;
                                
                                    SELECT pi.id_prof_institution
                                      INTO l_pi_id
                                      FROM prof_institution pi
                                     WHERE pi.id_professional = o_id_prof
                                       AND pi.id_institution = i_id_institution
                                       AND pi.flg_state = i_flg_state
                                       AND pi.dt_end_tstz IS NULL;
                                
                                    g_error := 'UPDATE PROF_INSTITUTION';
                                    pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_pi_id,
                                                                                   i_id_professional     => o_id_prof,
                                                                                   i_id_institution      => i_id_institution,
                                                                                   i_flg_state           => i_flg_state,
                                                                                   i_dt_end_tstz         => g_sysdate_tstz,
                                                                                   i_contact_det         => i_contact_det,
                                                                                   o_id_prof_institution => l_id_prof_institution);
                                    g_error := 'INSERT INTO PROF_INSTITUTION';
                                    pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                                                   i_id_professional     => o_id_prof,
                                                                                   i_id_institution      => i_id_institution,
                                                                                   i_flg_state           => i_flg_state,
                                                                                   i_num_mecan           => i_num_mecan,
                                                                                   i_dt_begin_tstz       => g_sysdate_tstz,
                                                                                   i_flg_schedulable     => l_flg_schedulable,
                                                                                   i_contact_det         => i_contact_det,
                                                                                   o_id_prof_institution => l_id_prof_institution);
                                
                                ELSE
                                
                                    g_error := 'GET ALERT PROFESSIONAL ID_PROF_INSTITUTION VALID FOR ID_PROFESSIONAL = ' ||
                                               o_id_prof || 'IN ID_INSTITUTION = ' || i_id_institution;
                                    SELECT pi.id_prof_institution
                                      INTO l_id_prof_institution
                                      FROM prof_institution pi
                                     WHERE pi.id_professional = o_id_prof
                                       AND pi.id_institution = i_id_institution
                                       AND pi.flg_state = i_flg_state
                                       AND pi.dt_end_tstz IS NULL;
                                
                                END IF;
                            ELSE
                            
                                g_error := 'GET PROF_INSTITUTION NUM_MECAN';
                                SELECT decode((SELECT pi.num_mecan
                                                FROM prof_institution pi
                                               WHERE pi.id_professional = o_id_prof
                                                 AND pi.id_institution = i_id_institution
                                                 AND pi.flg_state = i_flg_state
                                                 AND pi.dt_end_tstz = l_dt_end_tstz),
                                              NULL,
                                              NULL,
                                              (SELECT pi.num_mecan
                                                 FROM prof_institution pi
                                                WHERE pi.id_professional = o_id_prof
                                                  AND pi.id_institution = i_id_institution
                                                  AND pi.flg_state = i_flg_state
                                                  AND pi.dt_end_tstz = l_dt_end_tstz))
                                  INTO l_num_mecano
                                  FROM dual;
                            
                                IF l_num_mecano IS NULL
                                THEN
                                
                                    g_error := 'GET ALERT PROFESSIONAL ID_PROF_INSTITUTION VALID FOR ID_PROFESSIONAL = ' ||
                                               o_id_prof || 'IN ID_INSTITUTION = ' || i_id_institution;
                                    SELECT pi.id_prof_institution
                                      INTO l_pi_id
                                      FROM prof_institution pi
                                     WHERE pi.id_professional = o_id_prof
                                       AND pi.id_institution = i_id_institution
                                       AND pi.flg_state = i_flg_state
                                       AND pi.dt_end_tstz IS NULL;
                                
                                    g_error := 'UPDATE PROF_INSTITUTION';
                                    pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_pi_id,
                                                                                   i_id_professional     => o_id_prof,
                                                                                   i_id_institution      => i_id_institution,
                                                                                   i_flg_state           => i_flg_state,
                                                                                   i_num_mecan           => i_num_mecan,
                                                                                   i_contact_det         => i_contact_det,
                                                                                   o_id_prof_institution => l_id_prof_institution);
                                
                                ELSIF l_num_mecano != i_num_mecan
                                THEN
                                
                                    g_error := 'GET ALERT PROFESSIONAL FLG_SCHEDULABLE INFO FOR ID_PROFESSIONAL = ' ||
                                               o_id_prof || 'IN ID_INSTITUTION = ' || i_id_institution;
                                    SELECT nvl(pi.flg_schedulable, 'N')
                                      INTO l_flg_schedulable
                                      FROM prof_institution pi
                                     WHERE pi.id_professional = o_id_prof
                                       AND pi.id_institution = i_id_institution
                                       AND pi.flg_state = i_flg_state
                                       AND pi.dt_end_tstz IS NULL;
                                
                                    SELECT pi.id_prof_institution
                                      INTO l_pi_id
                                      FROM prof_institution pi
                                     WHERE pi.id_professional = o_id_prof
                                       AND pi.id_institution = i_id_institution
                                       AND pi.flg_state = i_flg_state
                                       AND pi.dt_end_tstz IS NULL;
                                
                                    g_error := 'UPDATE PROF_INSTITUTION';
                                    pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_pi_id,
                                                                                   i_id_professional     => o_id_prof,
                                                                                   i_id_institution      => i_id_institution,
                                                                                   i_flg_state           => i_flg_state,
                                                                                   i_dt_end_tstz         => g_sysdate_tstz,
                                                                                   i_contact_det         => i_contact_det,
                                                                                   o_id_prof_institution => l_id_prof_institution);
                                
                                    g_error := 'INSERT INTO PROF_INSTITUTION';
                                    pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                                                   i_id_professional     => o_id_prof,
                                                                                   i_id_institution      => i_id_institution,
                                                                                   i_flg_state           => i_flg_state,
                                                                                   i_num_mecan           => i_num_mecan,
                                                                                   i_dt_begin_tstz       => g_sysdate_tstz,
                                                                                   i_flg_schedulable     => l_flg_schedulable,
                                                                                   i_contact_det         => i_contact_det,
                                                                                   o_id_prof_institution => l_id_prof_institution);
                                
                                ELSE
                                
                                    g_error := 'GET ALERT PROFESSIONAL ID_PROF_INSTITUTION VALID FOR ID_PROFESSIONAL = ' ||
                                               o_id_prof || 'IN ID_INSTITUTION = ' || i_id_institution;
                                    SELECT pi.id_prof_institution
                                      INTO l_id_prof_institution
                                      FROM prof_institution pi
                                     WHERE pi.id_professional = o_id_prof
                                       AND pi.id_institution = i_id_institution
                                       AND pi.flg_state = i_flg_state
                                       AND pi.dt_end_tstz IS NULL;
                                
                                END IF;
                            
                            END IF;
                        
                        ELSE
                        
                            g_error := 'GET ALERT PROFESSIONAL FLG_SCHEDULABLE INFO FOR ID_PROFESSIONAL = ' ||
                                       o_id_prof || 'IN ID_INSTITUTION = ' || i_id_institution;
                            SELECT nvl(pi.flg_schedulable, 'N')
                              INTO l_flg_schedulable
                              FROM prof_institution pi
                             WHERE pi.id_professional = o_id_prof
                               AND pi.id_institution = i_id_institution
                               AND pi.dt_end_tstz IS NULL
                               AND pi.flg_state = l_state;
                        
                            SELECT pi.id_prof_institution
                              INTO l_pi_id
                              FROM prof_institution pi
                             WHERE pi.id_professional = o_id_prof
                               AND pi.id_institution = i_id_institution
                               AND pi.flg_state = l_state
                               AND pi.dt_end_tstz IS NULL;
                        
                            g_error := 'UPDATE PROF_INSTITUTION';
                            pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_pi_id,
                                                                           i_id_professional     => o_id_prof,
                                                                           i_id_institution      => i_id_institution,
                                                                           i_flg_state           => i_flg_state,
                                                                           i_dt_end_tstz         => g_sysdate_tstz,
                                                                           i_contact_det         => i_contact_det,
                                                                           o_id_prof_institution => l_id_prof_institution);
                        
                            l_id_prof_institution := get_next_value('PROF_INSTITUTION', i_id_institution);
                        
                            g_error := 'INSERT INTO PROF_INSTITUTION';
                            pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                                           i_id_professional     => o_id_prof,
                                                                           i_id_institution      => i_id_institution,
                                                                           i_flg_state           => i_flg_state,
                                                                           i_num_mecan           => i_num_mecan,
                                                                           i_dt_begin_tstz       => g_sysdate_tstz,
                                                                           i_flg_schedulable     => l_flg_schedulable,
                                                                           i_contact_det         => i_contact_det,
                                                                           o_id_prof_institution => l_id_prof_institution);
                        
                        END IF;
                    
                    END IF;
                
                END IF;
                g_error := 'REMOVE PROFESSIONAL MEC NUMBER';
                IF i_num_mecan IS NULL
                THEN
                    pk_api_ab_tables.remove_prof_inst_num_mec(i_id_prof_inst => l_id_prof_institution);
                END IF;
            
                SELECT COUNT(pc.id_prof_cat)
                  INTO l_pc_null
                  FROM prof_cat pc
                 WHERE pc.id_professional = o_id_prof
                   AND pc.id_institution = i_id_institution;
            
                IF l_pc_null = 0
                THEN
                
                    g_error := 'INSERT INTO PROF_CAT';
                    INSERT INTO prof_cat
                        (id_prof_cat, id_professional, id_category, id_institution, id_category_sub)
                    VALUES
                        (seq_prof_cat.nextval, o_id_prof, i_id_category, i_id_institution, i_id_cat_surgery);
                ELSE
                    g_error := 'UPDATE PROF_CAT';
                    UPDATE prof_cat
                       SET id_category = i_id_category, id_category_sub = i_id_cat_surgery
                     WHERE id_professional = o_id_prof
                       AND id_institution = i_id_institution;
                END IF;
            END IF;
        
            g_error := 'UPDATE OR INSERT PROF_PREFERENCES';
            SELECT nvl((SELECT pp.id_prof_preferences
                         FROM prof_preferences pp
                        WHERE pp.id_professional = o_id_prof
                          AND pp.id_software = 0
                          AND pp.id_institution = i_id_institution),
                       NULL)
              INTO l_prof_pref_pk
              FROM dual;
        
            SELECT nvl((SELECT si.id_software_institution
                         FROM software_institution si
                        WHERE si.id_software = 0
                          AND si.id_institution = i_id_institution),
                       NULL)
              INTO l_soft_inst_pk
              FROM dual;
        
            g_error := 'GET DEFAULT COMPONENT ID';
            pk_api_ab_tables.get_component_from_si(profissional(o_id_prof, i_id_institution, 0), l_comp_id);
            pk_api_ab_tables.upd_ins_into_ab_sw_ins_usr_inf(i_prof                       => profissional(o_id_prof,
                                                                                                         i_id_institution,
                                                                                                         0),
                                                            i_id_ab_soft_inst_user_info  => l_prof_pref_pk,
                                                            i_import_code                => NULL,
                                                            i_record_status              => 'A',
                                                            i_id_ab_software_institution => l_soft_inst_pk,
                                                            i_id_ab_software_inst_role   => l_role_sw_inst_pk,
                                                            i_id_ab_institution          => i_id_institution,
                                                            i_id_ab_software             => 0,
                                                            i_id_ab_user_info            => o_id_prof,
                                                            i_id_ab_role                 => l_role_id,
                                                            i_id_ab_component            => to_number(l_comp_id),
                                                            i_id_ab_language             => i_id_lang,
                                                            i_flg_log                    => NULL,
                                                            i_id_department              => NULL,
                                                            i_dt_log_tstz                => NULL,
                                                            i_timeout                    => NULL,
                                                            i_first_screen               => NULL,
                                                            o_id_ab_soft_inst_user_info  => l_prof_pref_pk);
        
            pk_api_ab_tables.upd_ab_sw_ins_usr_inf_lang(i_id_ab_user_info => o_id_prof,
                                                        i_id_ab_inst      => i_id_institution,
                                                        i_id_ab_lang      => i_id_lang);
        
            g_error := 'UPDATE ALERT_INTER PROFESSIONAL INFO FOR ID_PROFESSIONAL = ' || o_id_prof ||
                       'IN ID_INSTITUTION = ' || i_id_institution;
            pk_ia_event_backoffice.prof_schedule_info_update(l_id_prof_institution, i_id_institution);
        END IF;
    
        IF i_commit_at_end
        THEN
            COMMIT;
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN my_exception THEN
            pk_alert_exceptions.process_error(i_lang,
                                              'SET_PROF',
                                              l_error,
                                              l_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_PROFESSIONAL',
                                              'U',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
            
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'SET_PROFESSIONAL');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END set_professional;

    /** @headcom
    * Public Function. User exists
    *
    * @param      I_LANG                     Identificação do Idioma
    * @param      I_DESC_USER                Nome do utilizador
    * @param      I_SECRET_ANSWER            Resposta secreta
    * @param      O_FLG_VALUE                Valor de retorno (Y/N)
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenco - EL
    * @version    0.1
    * @since      2007/07/26
    */
    FUNCTION user_exists
    (
        i_lang      IN language.id_language%TYPE,
        i_desc_user IN ab_user_info.login%TYPE,
        o_flg_value OUT VARCHAR2,
        o_error     OUT t_error_out
    ) RETURN BOOLEAN IS
        l_cursor  SYS_REFCURSOR;
        l_id_user ab_user_info.id_ab_user_info%TYPE;
    BEGIN
        g_error := 'GET ID_USER FROM AB_USER_INFO';
        OPEN l_cursor FOR
            SELECT id_ab_user_info
              FROM ab_user_info
             WHERE upper(login) = upper(i_desc_user);
        FETCH l_cursor
            INTO l_id_user;
        IF l_cursor%NOTFOUND
        THEN
            o_flg_value := 'F';
        ELSE
            o_flg_value := 'T';
            g_error     := pk_message.get_message(i_lang, 'USER_EXISTS_T001');
        END IF;
        CLOSE l_cursor;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'USER_EXISTS',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
    END user_exists;

    FUNCTION get_profile_tmpl_cost_list
    (
        i_user                   IN profissional,
        i_id_language            IN language.id_language%TYPE,
        i_id_software            IN profile_template.id_software%TYPE,
        o_profile_tmpl_cost_list OUT pk_types.cursor_type,
        o_error                  OUT t_error_out
    ) RETURN BOOLEAN IS
        l_sql VARCHAR2(32767);
    BEGIN
    
        l_sql := l_sql || 'SELECT * FROM (SELECT ptd.id_profile_template_desc id, pk_translation.get_translation(' ||
                 i_id_language || ', ptd.code_profile_template_desc) text, decode(ptc.cost, 0, ''' ||
                 g_profile_template_free_type || ''', NULL, ''' || g_profile_template_free_type || ''', ''' ||
                 g_profile_template_pay_type ||
                 ''') flg_type, ptc.flg_mandatory flg_mandatory, ptc.cost cost, pk_backoffice.set_currency_desc(ptc.cost, c.id_currency) cost_desc, ptc.cost_setupfee cost_setupfee, pk_backoffice.set_currency_desc(ptc.cost_setupfee, c.id_currency) cost_setupfee_desc, ptc.payment_schedule schedule, pk_sysdomain.get_domain(''INST_ATTRIBUTES.PAYMENT_SCHEDULE'', ptc.payment_schedule, ' ||
                 i_id_language || ') schedule_desc,  ptc.rank rank
              FROM profile_template pt, profile_template_desc ptd, aol.profile_template_cost ptc, currency c, institution i, institution i2, inst_attributes ia
             WHERE i2.id_institution = ' || i_user.institution ||
                 ' AND i.id_institution = nvl(i2.id_parent, i2.id_institution) AND i.id_institution = ia.id_institution AND ia.id_currency = c.id_currency AND ptd.id_software = ' ||
                 i_id_software || ' AND ptc.id_software = ' || i_id_software || '
               AND pt.id_profile_template = ptc.id_profile_template AND pt.id_profile_template = ptd.id_profile_template AND ptc.id_currency = c.id_currency
                AND nvl(ptc.id_country, 0) = decode(ia.id_country, ' || g_id_portugal ||
                 ', ia.id_country, 0)' || ' AND pt.flg_available = ''' || g_profile_template_available ||
                 ''' AND ptc.flg_available = ''' || g_profile_template_cost_avlbl || ''' ORDER BY rank)';
    
        g_error := 'OPEN CURSOR';
        pk_alertlog.log_debug(l_sql);
    
        IF l_sql IS NOT NULL
        THEN
            OPEN o_profile_tmpl_cost_list FOR l_sql;
        ELSE
            pk_types.open_my_cursor(o_profile_tmpl_cost_list);
        END IF;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_profile_tmpl_cost_list);
            pk_alert_exceptions.process_error(i_id_language,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROFILE_TMPL_COST_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END;

    /********************************************************************************************
    * GET ALL LICENSES 
    *
    * @param i_user                        profissional (id,institution, software)
    * @param i_id_language                 id_language 
    * @param o_all_license_list            List all licenses
    * @param o_error                       Error
    *
    *
    * @return                              true or false on success or error
    *
    * @author                              Sérgio Monteiro
    * @version                             1.0
    * @since                               2008/11/23
    ********************************************************************************************/

    FUNCTION get_all_license_list
    (
        i_user             IN profissional,
        i_id_language      IN language.id_language%TYPE,
        o_all_license_list OUT pk_types.cursor_type,
        o_error            OUT t_error_out
    ) RETURN BOOLEAN IS
        sql_stmt VARCHAR2(10000);
    BEGIN
    
        g_error  := 'OPEN CURSOR';
        sql_stmt := 'SELECT * FROM (SELECT DISTINCT *
              FROM (SELECT l.id_product_purchasable,
                           to_char(ppd.product_purchasable_desc) text,
                           (SELECT COUNT(*)
                              FROM license l2
                             WHERE l2.id_product_purchasable = l.id_product_purchasable
                               AND l2.id_institution = i.id_institution
                               AND i.id_institution =' || i_user.institution || '
                               AND l2.id_product_purchasable IS NOT NULL
                               AND l2.flg_status IN (''' || g_license_available || ''',''' ||
                    g_license_waiting || ''', ''' || g_license_cancel || ''')) all_num,
                           to_number(null) attributed_num
                      FROM license l, ' || 'institution           i,
                           institution           i2,
                           inst_attributes       ia,
                           product_purchasable_desc   ppd
                     WHERE i2.id_institution = ' || i_user.institution || '
                       AND i.id_institution = nvl(i2.id_parent, i2.id_institution)
                       AND i.id_institution = ia.id_institution
                       AND l.id_institution = i.id_institution
                       AND i.id_institution = ' || i_user.institution || '
                       AND l.id_product_purchasable = ppd.id_product_purchasable ' ||
                    'AND l.flg_status IN (''' || g_license_available || ''',''' || g_license_waiting || ''', ''' ||
                    g_license_cancel || ''')
                       AND l.id_product_purchasable IS NOT NULL)
                       ORDER BY text)';
    
        sql_stmt := sql_stmt || ' union all ';
    
        sql_stmt := sql_stmt || 'SELECT * FROM (SELECT DISTINCT *
              FROM (SELECT l.id_profile_template_desc,
                           ptd.desc_profile_template text,
                           (SELECT COUNT(*)
                              FROM license l2
                             WHERE l2.id_profile_template_desc = l.id_profile_template_desc
                               AND l2.id_institution = i.id_institution
                               AND i.id_institution = ' || i_user.institution || '
                               AND l2.id_profile_template_desc IS NOT NULL
                               AND l2.flg_status IN (''' || g_license_available || ''',''' ||
                    g_license_waiting || ''', ''' || g_license_cancel ||
                    ''')) all_num,
                           (SELECT COUNT(*)
                              FROM license l2
                             WHERE l2.id_profile_template_desc = l.id_profile_template_desc
                               AND l2.id_institution = i.id_institution
                               AND i.id_institution = ' || i_user.institution || '
                               AND l2.id_profile_template_desc IS NOT NULL
                               AND l2.id_professional IS NOT NULL
                               AND l2.flg_status IN (''' || g_license_available || ''',''' ||
                    g_license_waiting || ''', ''' || g_license_cancel || ''')) attributed_num
                      FROM license l, ' || 'institution           i,
                           institution           i2,
                           inst_attributes       ia,
                           profile_template_desc ptd
                     WHERE i2.id_institution = ' || i_user.institution || '
                       AND i.id_institution = nvl(i2.id_parent, i2.id_institution)
                       AND i.id_institution = ia.id_institution
                       AND l.id_institution = i.id_institution
                       AND i.id_institution = ' || i_user.institution || '
                       AND l.id_profile_template_desc = ptd.id_profile_template_desc ' ||
                    'AND l.flg_status IN (''' || g_license_available || ''',''' || g_license_waiting || ''', ''' ||
                    g_license_cancel || ''')
                       AND l.id_profile_template_desc IS NOT NULL)
                       ORDER BY text)';
    
        pk_alertlog.log_debug(substr(sql_stmt, 0, 2000));
        pk_alertlog.log_debug(substr(sql_stmt, 2001, 2000));
        pk_alertlog.log_debug(substr(sql_stmt, 4001, 2000));
        pk_alertlog.log_debug(substr(sql_stmt, 6001, 2000));
        OPEN o_all_license_list FOR sql_stmt;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_all_license_list);
            pk_alert_exceptions.process_error(i_id_language,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_ALL_LICENSE_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
    END;
    /********************************************************************************************
    * GET UNATTRIBUTED LICENSES 
    *
    * @param i_user                        profissional (id,institution, software)
    * @param i_id_language                 id_language 
    * @param o_unattribute_license_list    List of unattributed licenses
    * @param o_error                       Error
    *
    *
    * @return                              true or false on success or error
    *
    * @author                              Sérgio Monteiro
    * @version                             1.0
    * @since                               2008/11/23
    ********************************************************************************************/
    FUNCTION get_unattribute_license_list
    (
        i_user                     IN profissional,
        i_id_language              IN language.id_language%TYPE,
        o_unattribute_license_list OUT pk_types.cursor_type,
        o_error                    OUT t_error_out
    ) RETURN BOOLEAN IS
        sql_stmt VARCHAR2(2000);
    BEGIN
    
        g_error := 'OPEN CURSOR';
    
        OPEN o_unattribute_license_list FOR
            SELECT l.id_license, ptd.desc_profile_template text
              FROM license l, profile_template_desc ptd
             WHERE l.id_institution = i_user.institution
               AND l.id_profile_template_desc IS NOT NULL
               AND l.id_professional IS NULL
               AND l.flg_status IN (g_license_available, g_license_waiting, g_license_cancel)
               AND ptd.id_profile_template_desc = l.id_profile_template_desc
             ORDER BY id_license;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_unattribute_license_list);
            pk_alert_exceptions.process_error(i_id_language,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_UNATTRIBUTE_LICENSE_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
    END;

    FUNCTION set_main_facility
    (
        i_lang        IN language.id_language%TYPE,
        i_id_old_main IN institution.id_institution%TYPE,
        i_id_new_main IN institution.id_institution%TYPE,
        o_error       OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        NULL;
    END;

    FUNCTION get_assigned_specialities
    (
        i_lang            IN language.id_language%TYPE,
        i_id_institution  IN institution.id_institution%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        o_specialities    OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        OPEN o_specialities FOR
            SELECT s.id_dept departamento,
                   s.id_department servico,
                   dcs.id_dep_clin_serv especialidade,
                   pk_translation.get_translation(i_lang, 'DEPT.CODE_DEPT.' || s.id_dept) dep_msg,
                   pk_translation.get_translation(i_lang, s.code_department) serv_msg,
                   pk_translation.get_translation(i_lang, cs.code_clinical_service) spec_msg,
                   (pk_translation.get_translation(i_lang, 'DEPT.CODE_DEPT.' || s.id_dept) || ' - ' ||
                   pk_translation.get_translation(i_lang, s.code_department) || ' - ' ||
                   pk_translation.get_translation(i_lang, cs.code_clinical_service)) texto
              FROM prof_dep_clin_serv pdcs, dep_clin_serv dcs, clinical_service cs, department s
             WHERE pdcs.id_professional = i_id_professional
               AND pdcs.id_dep_clin_serv = dcs.id_dep_clin_serv
               AND dcs.flg_available = pk_alert_constant.g_yes
               AND cs.id_clinical_service = dcs.id_clinical_service
               AND s.id_department = dcs.id_department
               AND pdcs.id_institution = i_id_institution
               AND cs.flg_available = g_flg_available
               AND dcs.flg_available = g_flg_available
             ORDER BY departamento, servico, especialidade;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_specialities);
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_ASSIGNED_SPECILIATIES');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_assigned_specialities;

    FUNCTION get_inst_profiles
    (
        i_lang            IN language.id_language%TYPE,
        i_id_institution  IN institution.id_institution%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        o_inst_profile    OUT VARCHAR2,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_market       market.id_market%TYPE;
        l_inst_profile VARCHAR2(400);
        CURSOR c_profiles(c_market market.id_market%TYPE) IS
            SELECT DISTINCT (s.name || ' - ' ||
                            decode(ptm.id_market,
                                    0,
                                    pk_message.get_message(i_lang, pt.code_profile_template),
                                    pk_message.get_message(i_lang, pt.code_profile_template) || ' (' ||
                                    pk_translation.get_translation(i_lang, 'MARKET.CODE_MARKET.' || ptm.id_market) || ')')) profile
              FROM software_institution si
             INNER JOIN software s
                ON (s.id_software = si.id_software AND s.flg_viewer != 'Y')
             INNER JOIN prof_profile_template ppt
                ON (ppt.id_institution = si.id_institution AND ppt.id_software = s.id_software)
             INNER JOIN profile_template pt
                ON (pt.id_profile_template = ppt.id_profile_template AND pt.flg_available = g_flg_avail AND
                   pt.id_software = s.id_software)
             INNER JOIN profile_template_market ptm
                ON (ptm.id_profile_template = pt.id_profile_template)
             WHERE ppt.id_professional = i_id_professional
               AND si.id_institution = i_id_institution
               AND (ptm.id_market = c_market OR (ptm.id_market != c_market AND ptm.id_market = 0));
    
    BEGIN
        g_error := 'GET INSTITUTION MARKET';
        SELECT nvl((SELECT i.id_market
                     FROM institution i
                    WHERE i.id_institution = i_id_institution),
                   0)
          INTO l_market
          FROM dual;
    
        OPEN c_profiles(l_market);
        LOOP
            FETCH c_profiles
                INTO l_inst_profile;
            EXIT WHEN c_profiles%NOTFOUND;
            o_inst_profile := l_inst_profile || '; ' || o_inst_profile;
        END LOOP;
    
        CLOSE c_profiles;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_INST_PROFILES');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_inst_profiles;

    FUNCTION set_user_license
    (
        i_lang            IN language.id_language%TYPE,
        i_id_institution  IN institution.id_institution%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        i_id_license      IN NUMBER,
        i_commit_at_end   IN BOOLEAN,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_id_inst                  prof_institution.id_institution%TYPE;
        l_id_soft                  prof_soft_inst.id_software%TYPE;
        l_id_soft2                 prof_soft_inst.id_software%TYPE;
        l_id_cat                   prof_cat.id_category%TYPE;
        l_id_prof_templ            profile_template.id_profile_template%TYPE;
        l_id_prof_soft_inst        prof_soft_inst.id_prof_soft_inst%TYPE;
        l_id_self_cat              prof_cat.id_prof_cat%TYPE;
        l_id_prof_profile_template prof_profile_template.id_prof_profile_template%TYPE;
    
        c_inst  pk_types.cursor_type;
        c_soft  pk_types.cursor_type;
        c_templ pk_types.cursor_type;
    
        l_tab_inst         table_number := table_number();
        l_tab_soft         table_number := table_number();
        l_tab_templ        table_number := table_number();
        l_res              BOOLEAN;
        l_payment_schedule VARCHAR2(30);
    
        l_date      DATE;
        l_date_tstz TIMESTAMP WITH LOCAL TIME ZONE;
        l_months    NUMBER;
    
        CURSOR c_prof_inst IS
            SELECT pi.id_institution
              FROM prof_institution pi
             WHERE pi.id_professional = i_id_professional
               AND pi.id_institution = i_id_institution;
    
        CURSOR c_prof_soft_inst IS
            SELECT psi.id_prof_soft_inst
              FROM prof_soft_inst psi
             WHERE psi.id_software = (SELECT pt.id_software
                                        FROM profile_template pt
                                       WHERE pt.id_profile_template = l_id_prof_templ)
               AND psi.id_institution = i_id_institution
               AND psi.id_professional = i_id_professional;
    
        CURSOR c_id_category IS
            SELECT pc.id_category
              FROM prof_cat pc
             WHERE pc.id_professional = i_id_professional
               AND pc.id_institution = i_id_institution;
    
        CURSOR c_id_ppt IS
            SELECT ppt.id_prof_profile_template
              FROM prof_profile_template ppt
             WHERE ppt.id_profile_template = l_id_prof_templ
               AND ppt.id_professional = i_id_professional
               AND ppt.id_institution = i_id_institution;
    
        sql_stmt VARCHAR2(1000);
        l_error  VARCHAR2(1000);
        my_exception EXCEPTION;
        -- core tables new params
        l_soft_inst_pk     ab_soft_inst_user_info.id_ab_software_institution%TYPE := 0;
        l_role_sw_inst_pk  ab_soft_inst_user_info.id_ab_software_inst_role%TYPE := 0;
        l_role_id          ab_soft_inst_user_info.id_ab_role%TYPE := 0;
        l_comp_id          VARCHAR2(200) := '';
        l_prof_institution prof_institution.id_prof_institution%TYPE := 0;
        l_si_user_info     NUMBER := 0;
    
    BEGIN
        g_error     := 'SET DATE';
        l_date      := SYSDATE;
        l_date_tstz := current_timestamp;
    
        IF i_id_license IS NOT NULL
        THEN
            g_error  := 'SELECT pt.id_software INTO l_id_soft';
            sql_stmt := 'SELECT pt.id_software
              FROM profile_template pt
             WHERE pt.id_profile_template =
                   (SELECT ptd.id_profile_template
                      FROM aol.license l, profile_template_desc ptd
                     WHERE l.id_license = :i_id_license
                       AND ptd.id_profile_template_desc = l.id_profile_template_desc)';
            EXECUTE IMMEDIATE sql_stmt
                INTO l_id_soft
                USING i_id_license;
        
            g_error := 'SELECT id_profile_template INTO l_id_prof_templ';
        
            sql_stmt := 'SELECT ptd.id_profile_template
              FROM aol.license l, profile_template_desc ptd
             WHERE l.id_license = :i_id_license
               AND l.id_profile_template_desc = ptd.id_profile_template_desc';
            EXECUTE IMMEDIATE sql_stmt
                INTO l_id_prof_templ
                USING i_id_license;
        
            g_error := 'SELECT c.id_category INTO l_id_cat';
            SELECT c.id_category
              INTO l_id_cat
              FROM category c, profile_template pt
             WHERE c.id_category = pt.id_category
               AND pt.id_profile_template = l_id_prof_templ;
        END IF;
    
        g_error := 'OPEN c_prof_inst';
        OPEN c_prof_inst;
    
        FETCH c_prof_inst
            INTO l_id_inst;
        g_found := c_prof_inst%NOTFOUND;
    
        CLOSE c_prof_inst;
    
        IF l_id_inst IS NULL
        THEN
            g_error := 'INSERT INTO PROF_INSTITUTION';
            pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                           i_id_professional     => i_id_professional,
                                                           i_id_institution      => i_id_institution,
                                                           i_flg_state           => 'A',
                                                           o_id_prof_institution => l_prof_institution);
        END IF;
    
        IF i_id_license IS NOT NULL
        THEN
        
            g_error := 'open c_id_category';
            OPEN c_id_category;
            FETCH c_id_category
                INTO l_id_self_cat;
            g_found := c_id_category%FOUND;
            CLOSE c_id_category;
        
            IF l_id_self_cat IS NULL
            THEN
                g_error := 'INSERT INTO PROF_CAT';
                INSERT INTO prof_cat
                    (id_prof_cat, id_professional, id_category, id_institution)
                VALUES
                    (seq_prof_cat.nextval, i_id_professional, l_id_cat, i_id_institution);
            ELSIF l_id_self_cat != l_id_cat
            THEN
                l_error := pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_M010');
            
                g_error := 'DELETE FROM prof_institution';
                IF l_id_inst IS NULL
                THEN
                    pk_api_ab_tables.del_from_prof_institution('id_professional = ' || i_id_professional || '
                       AND id_institution = ' ||
                                                               i_id_institution);
                END IF;
            
                COMMIT;
                RAISE my_exception;
            
            END IF;
        
            g_error := 'open c_id_ppt';
            OPEN c_id_ppt;
            FETCH c_id_ppt
                INTO l_id_prof_profile_template;
            g_found := c_id_ppt%FOUND;
            CLOSE c_id_ppt;
        
            IF l_id_prof_profile_template IS NULL
            THEN
                g_error := 'INSERT INTO PROF_PROFILE_TEMPLATE';
                INSERT INTO prof_profile_template
                    (id_prof_profile_template, id_profile_template, id_professional, id_software, id_institution)
                VALUES
                    (get_next_value('PROF_PROFILE_TEMPLATE', i_id_institution),
                     l_id_prof_templ,
                     i_id_professional,
                     l_id_soft,
                     i_id_institution);
            END IF;
            g_error := 'open c_prof_soft_inst';
            OPEN c_prof_soft_inst;
            FETCH c_prof_soft_inst
                INTO l_id_soft2;
            g_found := c_prof_soft_inst%FOUND;
            CLOSE c_prof_soft_inst;
        
            IF l_id_soft2 IS NULL
            THEN
                g_error := 'INSERT INTO PROF_SOFT_INST';
                SELECT nvl((SELECT si.id_software_institution
                             FROM software_institution si
                            WHERE si.id_software = l_id_soft
                              AND si.id_institution = i_id_institution),
                           0)
                  INTO l_soft_inst_pk
                  FROM dual;
                g_error := 'GET DEFAULT COMPONENT ID';
                pk_api_ab_tables.get_component_from_si(profissional(0, i_id_institution, l_id_soft), l_comp_id);
                pk_api_ab_tables.upd_ins_into_ab_sw_ins_usr_inf(i_prof                       => profissional(i_id_professional,
                                                                                                             i_id_institution,
                                                                                                             l_id_soft),
                                                                i_id_ab_soft_inst_user_info  => NULL,
                                                                i_import_code                => NULL,
                                                                i_record_status              => 'A',
                                                                i_id_ab_software_institution => l_soft_inst_pk,
                                                                i_id_ab_software_inst_role   => l_role_sw_inst_pk,
                                                                i_id_ab_institution          => i_id_institution,
                                                                i_id_ab_software             => l_id_soft,
                                                                i_id_ab_user_info            => i_id_professional,
                                                                i_id_ab_role                 => l_role_id,
                                                                i_id_ab_component            => to_number(l_comp_id),
                                                                i_id_ab_language             => NULL,
                                                                i_flg_log                    => 'Y',
                                                                i_id_department              => NULL,
                                                                i_dt_log_tstz                => NULL,
                                                                i_timeout                    => NULL,
                                                                i_first_screen               => NULL,
                                                                o_id_ab_soft_inst_user_info  => l_si_user_info);
            END IF;
        
            l_tab_inst.extend;
            l_tab_soft.extend;
            l_tab_templ.extend;
        
            l_tab_inst(1) := i_id_institution;
            l_tab_soft(1) := l_id_soft;
            l_tab_templ(1) := l_id_prof_templ;
        
            l_res := set_template_list(i_lang,
                                       i_id_professional,
                                       l_tab_inst,
                                       l_tab_soft,
                                       NULL,
                                       l_tab_templ,
                                       FALSE,
                                       o_error);
        
            g_error := 'GET PAYMENT SCHEDULE';
            EXECUTE IMMEDIATE 'SELECT p.payment_schedule FROM aol.payment p WHERE p.id_license = :i_id_license AND p.flg_setupfee = ''N'''
                INTO l_payment_schedule
                USING i_id_license;
        
            g_error := 'SET MONTHS';
            IF l_payment_schedule = g_flg_montlhy_payment
            THEN
                l_months := g_montlhy_payment;
            ELSIF l_payment_schedule = g_flg_biannually_payment
            THEN
                l_months := g_biannually_payment;
            ELSIF l_payment_schedule = g_flg_annually_payment
            THEN
                l_months := g_annually_payment;
            END IF;
            g_error := ' UPDATE license ';
        
            EXECUTE IMMEDIATE 'UPDATE aol.license l
               SET id_professional  = :i_id_professional, id_institution = :i_id_institution,
                   l.dt_expire      = add_months(:l_date, :l_months),
                   l.dt_expire_tstz = pk_date_utils.add_to_ltstz(:l_date_tstz, :l_months, ''MONTH'')' ||
                              'WHERE id_license = :i_id_license'
                USING i_id_professional, i_id_institution, l_date, l_months, l_date_tstz, l_months, i_id_license;
        END IF;
    
        IF i_commit_at_end
        THEN
            COMMIT;
        END IF;
        RETURN TRUE;
    
    EXCEPTION
        WHEN my_exception THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              'SET_USER_LIC',
                                              l_error,
                                              l_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_USER_LICENSE',
                                              'U',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_USER_LICENSE',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END;

    FUNCTION get_all_payment
    (
        i_lang    IN language.id_language%TYPE,
        i_user    IN profissional,
        o_payment OUT pk_types.cursor_type,
        o_error   OUT t_error_out
    ) RETURN BOOLEAN IS
        sql_stmt VARCHAR2(10000);
    BEGIN
        g_error  := 'GET PAYMENT';
        sql_stmt := 'SELECT t.*, pk_backoffice.set_currency_desc(t.VALUE, c2.id_currency) value_desc
              FROM (SELECT p.cart_id trans_id,
                           SUM(p.value_tax) + SUM(p.VALUE) VALUE,
                           p.id_currency,
                           pk_date_utils.date_chr_extend_tsz(:i_lang,
                                                             decode(p.trans_status,
                                                                    :g_payment_future_yes,
                                                                    p.dt_payment_tstz,
                                                                    pk_date_utils.add_days_to_tstz(p.dt_generated_tstz,
                                                                                                   to_number(pk_sysconfig.get_config(''PAYMENT_DAYS_EXPIRE'',
                                                                                                                                     :i_user)) +
                                                                                                   to_number(pk_sysconfig.get_config(''LICENSE_DAYS_EXPIRE_AFTER'',
                                                                                                                                     :i_user)))),
                                                             :i_user) dt_payment,
                           :g_flg_icon_active flg_status,
                           pk_sysdomain.get_img(:i_lang, ''AOL.PAYMENT.TRANS_STATUS'', p.trans_status) flg_icon,
                           REPLACE(REPLACE(decode((SELECT COUNT(p2.id_license)
                                                    FROM aol.payment p2
                                                   WHERE p2.cart_id = p.cart_id
                                                     AND p2.flg_setupfee = :g_flg_not_setupfee),
                                                  1,
                                                  pk_message.get_message(:i_lang, ''BO_PAYMENT_DESCRIPTION_M002''),
                                                  pk_message.get_message(:i_lang, ''BO_PAYMENT_DESCRIPTION_M001'')),
                                           ''@1'',
                                           (SELECT COUNT(p2.id_license)
                                              FROM aol.payment p2
                                             WHERE p2.cart_id = p.cart_id
                                               AND p2.flg_setupfee = :g_flg_not_setupfee)),
                                   ''@2'',
                                   pk_sysdomain.get_domain(''INST_ATTRIBUTES.LICENSE_MODEL'', ia.license_model, :i_lang)) payment_desc, p.trans_status flg_payment
                      FROM aol.payment p, aol.license l, currency c, inst_attributes ia
                     WHERE p.id_license = l.id_license
                       AND p.trans_status IN (:g_trans_status_waiting, :g_trans_status_available)
                       AND p.id_currency = c.id_currency
                       AND l.id_institution = :i_user_institution
                       AND ia.id_institution = :i_user_institution
                     GROUP BY p.cart_id,
                              p.id_currency,
                              ia.license_model,
                              p.dt_payment_tstz,
                              p.dt_generated_tstz, p.trans_status
                     ORDER BY p.trans_status, p.dt_payment_tstz, p.dt_generated_tstz) t,
                   currency c2
             WHERE c2.id_currency = t.id_currency';
    
        pk_alertlog.log_debug(substr(sql_stmt, 0, 2000));
        pk_alertlog.log_debug(substr(sql_stmt, 2001, 2000));
        pk_alertlog.log_debug(substr(sql_stmt, 4001, 2000));
        OPEN o_payment FOR sql_stmt
            USING i_lang, g_payment_future_yes, i_user, i_user, i_user, g_flg_icon_active, i_lang, g_flg_not_setupfee, i_lang, i_lang, g_flg_not_setupfee, i_lang, g_trans_status_waiting, g_trans_status_available, i_user.institution, i_user.institution;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_payment);
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_ALL_PAYMENT');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END;

    FUNCTION get_payment_det
    (
        i_lang           IN language.id_language%TYPE,
        i_user           IN profissional,
        i_cart_id        IN VARCHAR2,
        o_payment_det    OUT pk_types.cursor_type,
        o_sub_total      OUT NUMBER,
        o_sub_total_desc OUT VARCHAR2,
        o_tax            OUT NUMBER,
        o_tax_desc       OUT VARCHAR2,
        o_total          OUT NUMBER,
        o_total_desc     OUT VARCHAR2,
        o_num            OUT NUMBER,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
        l_sql1 VARCHAR2(32767);
        l_sql2 VARCHAR2(32767);
    BEGIN
        g_error := 'GET PAYMENT DETAILS';
    
        l_sql1 := 'SELECT * from (SELECT aol.pk_aol_translation.get_translation(aol.t_user(' || i_user.id || ', ' ||
                  i_user.institution || ', ' || i_user.software || ', ' || i_lang ||
                  '), pp.code_product_purchasable) text,
                           ''N'' flg_type,
                           COUNT(pp.id_product_purchasable) qty,
                           nvl(p.value, 0) cost,
                           pk_backoffice.set_currency_desc(nvl(p.value, 0), ia.id_currency) cost_desc,
                           nvl(y.cost_setupfee, 0) cost_setupfee,
                           pk_backoffice.set_currency_desc(nvl(y.cost_setupfee, 0), ia.id_currency) cost_setupfee_desc,
                           (SUM(nvl(p.VALUE, 0)) + nvl(y.subtotal, 0)) subtotal_num,
                           pk_backoffice.set_currency_desc((SUM(nvl(p.VALUE, 0)) + nvl(y.subtotal, 0)), ia.id_currency) subtotal
                      FROM aol.license                 l,
                           aol.product_purchasable     pp,
                           inst_attributes       ia,
                           aol.payment                 p,
                           
                           (SELECT pp.id_product_purchasable,
                           ''N'' flg_type,
                           nvl(p.value, 0) cost_setupfee,
                           SUM(nvl(p.VALUE, 0)) subtotal
                      FROM aol.license                 l,
                           aol.product_purchasable     pp,
                           inst_attributes       ia,
                           aol.payment                 p
                     WHERE p.cart_id = ''' || i_cart_id || ''' AND l.id_product_purchasable IS NOT NULL
                       AND p.id_license = l.id_license
                       AND l.id_product_purchasable = pp.id_product_purchasable
                       AND ia.id_institution = l.id_institution
                       AND p.flg_setupfee = ''Y''
                     GROUP BY pp.id_product_purchasable,
                              p.VALUE,
                              pp.rank
                     ORDER BY pp.rank) y 
                     
                     WHERE p.cart_id = ''' || i_cart_id || ''' AND l.id_product_purchasable IS NOT NULL
                       AND p.id_license = l.id_license
                       AND l.id_product_purchasable = y.id_product_purchasable(+)
                       AND l.id_product_purchasable = pp.id_product_purchasable
                       AND ia.id_institution = l.id_institution
                       AND p.flg_setupfee = ''N''
                     GROUP BY pp.id_product_purchasable,
                              pp.code_product_purchasable,
                              p.VALUE,
                              pp.rank,
                              ia.id_currency,
                              y.subtotal,
                              y.cost_setupfee
                     ORDER BY pp.rank)';
    
        l_sql1 := l_sql1 || ' union all ';
    
        l_sql1 := l_sql1 || 'SELECT * FROM (SELECT pk_translation.get_translation(' || i_lang ||
                  ', ptd.code_profile_template_desc) text,
                           ''L'' flg_type,
                           COUNT(ptd.id_profile_template_desc) qty,
                           nvl(p.value, 0) cost,
                           pk_backoffice.set_currency_desc(nvl(p.value, 0), ia.id_currency) cost_desc,
                           nvl(y.cost_setupfee, 0),
                           pk_backoffice.set_currency_desc(nvl(y.cost_setupfee, 0) , ia.id_currency) cost_setupfee_desc,
                           (SUM(nvl(p.value, 0)) + nvl(y.subtotal, 0)) subtotal_num,
                           pk_backoffice.set_currency_desc((SUM(p.VALUE) + nvl(y.subtotal, 0)), ia.id_currency) subtotal
                      FROM aol.license                 l,
                           profile_template_desc ptd,
                           inst_attributes       ia,
                           aol.payment                 p,
                           
                           (SELECT ptd.id_profile_template_desc,
                           ''L'' flg_type,
                           nvl(p.value, 0) cost_setupfee,
                           SUM(nvl(p.value, 0)) subtotal
                      FROM aol.license                 l,
                           profile_template_desc ptd,
                           inst_attributes       ia,
                           aol.payment                 p
                     WHERE p.cart_id = ''' || i_cart_id || ''' AND l.id_profile_template_desc IS NOT NULL
                       AND p.id_license = l.id_license
                       AND l.id_profile_template_desc = ptd.id_profile_template_desc
                       AND ia.id_institution = l.id_institution
                       AND p.flg_setupfee = ''Y''
                     GROUP BY ptd.id_profile_template_desc,
                              p.VALUE,
                              ptd.rank
                     ORDER BY ptd.rank) y 
                     
                     WHERE p.cart_id = ''' || i_cart_id || ''' AND l.id_profile_template_desc IS NOT NULL
                       AND p.id_license = l.id_license
                       AND l.id_profile_template_desc = y.id_profile_template_desc(+)
                       AND l.id_profile_template_desc = ptd.id_profile_template_desc
                       AND ia.id_institution = l.id_institution
                       AND p.flg_setupfee = ''N''
                     GROUP BY ptd.id_profile_template_desc,
                              ptd.code_profile_template_desc,
                              p.VALUE,
                              ptd.rank,
                              ia.id_currency,
                              y.subtotal,
                              y.cost_setupfee
                     ORDER BY ptd.rank)';
    
        pk_alertlog.log_debug(substr(l_sql1, 0, 2000));
        pk_alertlog.log_debug(substr(l_sql1, 2001, 2000));
        pk_alertlog.log_debug(substr(l_sql1, 4001, 2000));
        pk_alertlog.log_debug(substr(l_sql1, 6001, 2000));
    
        OPEN o_payment_det FOR l_sql1;
    
        l_sql2 := 'select t.subtotal , pk_backoffice.set_currency_desc(t.subtotal, p2.id_currency), t.tax, pk_backoffice.set_currency_desc(t.tax, p2.id_currency), t.total, pk_backoffice.set_currency_desc(t.total, p2.id_currency), count(p2.id_payment) num from (select sum(p.value) subtotal, sum(p.value_tax) tax, sum(p.value + p.value_tax) total from aol.payment p where p.cart_id = ''' ||
                  i_cart_id || ''') t, aol.payment p2 where p2.cart_id = ''' || i_cart_id ||
                  ''' and p2.flg_setupfee = ''N'' group by p2.id_currency, t.subtotal, t.tax, t.total';
    
        pk_alertlog.log_debug(l_sql2);
        EXECUTE IMMEDIATE l_sql2
            INTO o_sub_total, o_sub_total_desc, o_tax, o_tax_desc, o_total, o_total_desc, o_num;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_payment_det);
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_PAYMENT_DET');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
    END;

    /**************************************************************************************************************************/

    /** @headcom
    * Public Function. Get Professional Photo URL
    *
    * @param      I_LANG                     Identificação do Idioma
    * @param      I_ID_PROFESSIONAL          Identificação do profissional
    *
    * @return     VARCHAR2
    * @author     Eduardo Lourenco - EL
    * @version    0.1
    * @since      2007/07/30
    */
    FUNCTION get_prof_photo_url
    (
        i_lang            IN language.id_language%TYPE,
        i_id_professional IN professional.id_professional%TYPE
    ) RETURN VARCHAR2 IS
    
        l_url   sys_config.value%TYPE;
        l_error t_error_out;
        my_exception EXCEPTION;
    BEGIN
        l_url := NULL;
        IF NOT pk_profphoto.get_prof_photo_url(i_lang,
                                               i_id_professional,
                                               profissional(i_id_professional, 0, 26),
                                               l_url,
                                               l_error)
        THEN
        
            RAISE my_exception;
        END IF;
        RETURN l_url;
    EXCEPTION
        WHEN my_exception THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_PHOTO_URL',
                                              l_error);
            pk_alert_exceptions.reset_error_state;
            RETURN NULL;
        
    END;

    /** @headcom
    * Public Function. Find Professionals
    *
    * @param      I_LANG                     Identificação do Idioma
    * @param      I_ID_INSTITUTION           Identificação da institituição
    * @param      I_NAME                     Nome
    * @param      I_DT_BIRTH                 Data de nascimento
    * @param      I_GENDER                   Sexo
    * @param      I_GENDER                   Sexo
    * @param      I_ID_SPECIALITY            Identificação da especialidade
    * @param      I_NUM_ORDER                Numero da ordem
    * @param      O_PROF_LIST                Lista de profissionais a retornar
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenco - EL
    * @version    0.1
    * @since      2007/07/30
    */
    FUNCTION find_professionals
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN profissional,
        i_id_institution IN institution.id_institution%TYPE,
        i_name           IN professional.name%TYPE,
        i_dt_birth       IN VARCHAR,
        i_gender         IN professional.gender%TYPE,
        i_id_speciality  IN professional.id_speciality%TYPE,
        i_num_order      IN professional.num_order%TYPE,
        i_id_license     IN NUMBER,
        o_prof_list      OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
        l_profile_template      profile_template.id_profile_template%TYPE;
        l_prof_profile_template profile_template.id_profile_template%TYPE;
        l_counter               NUMBER;
    BEGIN
    
        g_error := 'SELECT FROM PROF_PROFILE_TEMPLATE';
        SELECT ppt.id_profile_template
          INTO l_profile_template
          FROM prof_profile_template ppt
         WHERE ppt.id_software = i_prof.software
           AND ppt.id_professional = i_prof.id
           AND ppt.id_institution = i_prof.institution;
    
        IF l_profile_template = 30
        THEN
            g_error := 'FIND PROFESSIONALS';
            OPEN o_prof_list FOR 'SELECT DISTINCT p.id_professional,
                pk_backoffice.get_prof_photo_url(:i_lang, p.id_professional) photo_url,
                p.name,
                pk_sysdomain.get_domain(''PROFESSIONAL.GENDER'', p.gender, :i_lang) desc_gender,
                p.gender,
                pk_date_utils.date_chr_extend(:i_lang, p.dt_birth, :i_prof) string_birth,
                p.dt_birth,
                p.num_order,
                pk_translation.get_translation(:i_lang,
                                 (SELECT s.code_speciality
                                  FROM speciality s
                                 WHERE s.id_speciality = p.id_speciality
                                   AND s.flg_available = :g_flg_avail)) spec,
                p.id_speciality,
                fsu.login desc_user
          FROM professional p, prof_institution pi, ab_user_info fsu
         WHERE pi.id_professional = p.id_professional
           AND fsu.id_ab_user_info = p.id_professional
           AND nvl(p.flg_prof_test, pk_alert_constant.get_no) = pk_alert_constant.get_no
           AND (:i_name IS NULL 
           OR translate(upper(p.name),
                                 ''ÁÉÍÓÚÀÈÌÒÙÂÊÎÔÛÃÕÇÄËÏÖÜÑ'',
                                 ''AEIOUAEIOUAEIOUAOCAEIOUN'') LIKE
                       ''%'' || translate(upper(:i_name),
                                        ''ÁÉÍÓÚÀÈÌÒÙÂÊÎÔÛÃÕÇÄËÏÖÜÑ '',
                                        ''AEIOUAEIOUAEIOUAOCAEIOUN%'') || ''%'')
           AND (:i_dt_birth IS NULL OR trunc(p.dt_birth, ''D'') = trunc(pk_backoffice.get_date_received(:i_lang, :i_dt_birth), ''D''))
           AND (:i_gender IS NULL OR p.gender = :i_gender)
           AND (:i_id_speciality IS NULL OR p.id_speciality = :i_id_speciality)
           AND (:i_num_order IS NULL OR p.num_order = :i_num_order)
           AND ((:l_profile_template = 30 AND pi.id_institution = :i_id_institution AND
             (SELECT COUNT(*)
              FROM aol.license aol_l
               WHERE aol_l.id_institution = pi.id_institution
               AND aol_l.id_professional = p.id_professional
               AND aol_l.flg_status IN (:g_flg_avail, ''C'', ''W'')) = 0) OR
             (:l_profile_template = 30 AND pi.id_institution <> :i_id_institution) OR
             (:l_profile_template != 30 AND pi.id_institution <> :i_id_institution AND
             p.id_professional NOT IN (SELECT pi2.id_professional
                           FROM prof_institution pi2
                          WHERE pi2.id_institution = :i_id_institution
                            AND pi2.flg_state = :g_active)))
         ORDER BY name'
                USING i_lang, i_lang, i_lang, i_prof, i_lang, g_flg_avail, i_name, i_name, i_dt_birth, i_lang, i_dt_birth, i_gender, i_gender, i_id_speciality, i_id_speciality, i_num_order, i_num_order, l_profile_template, i_id_institution, g_flg_avail, l_profile_template, i_id_institution, l_profile_template, i_id_institution, i_id_institution, g_active;
        ELSE
            g_error := 'FIND PROFESSIONALS';
            OPEN o_prof_list FOR 'SELECT DISTINCT p.id_professional,
                pk_backoffice.get_prof_photo_url(:i_lang, p.id_professional) photo_url,
                p.name,
                pk_sysdomain.get_domain(''PROFESSIONAL.GENDER'', p.gender, :i_lang) desc_gender,
                p.gender,
                pk_date_utils.date_chr_extend(:i_lang, p.dt_birth, :i_prof) string_birth,
                p.dt_birth,
                p.num_order,
                pk_translation.get_translation(:i_lang,
                                 (SELECT s.code_speciality
                                  FROM speciality s
                                 WHERE s.id_speciality = p.id_speciality
                                   AND s.flg_available = :g_flg_avail)) spec,
                p.id_speciality,
                fsu.login desc_user
          FROM professional p, prof_institution pi, ab_user_info fsu
         WHERE pi.id_professional = p.id_professional
         AND nvl(p.flg_prof_test, :i_get_no) = :i_get_no
           AND fsu.id_ab_user_info = p.id_professional
           AND (:i_name IS NULL 
           OR translate(upper(p.name),
                                 ''ÁÉÍÓÚÀÈÌÒÙÂÊÎÔÛÃÕÇÄËÏÖÜÑ'',
                                 ''AEIOUAEIOUAEIOUAOCAEIOUN'') LIKE
                       ''%'' || translate(upper(:i_name),
                                        ''ÁÉÍÓÚÀÈÌÒÙÂÊÎÔÛÃÕÇÄËÏÖÜÑ '',
                                        ''AEIOUAEIOUAEIOUAOCAEIOUN%'') || ''%'')
           AND (:i_dt_birth IS NULL OR trunc(p.dt_birth, ''D'') = trunc(pk_backoffice.get_date_received(:i_lang, :i_dt_birth), ''D''))
           AND (:i_gender IS NULL OR p.gender = :i_gender)
           AND (:i_id_speciality IS NULL OR p.id_speciality = :i_id_speciality)
           AND (:i_num_order IS NULL OR p.num_order = :i_num_order)
           AND (' || ' pi.id_institution <> :i_id_institution AND
             p.id_professional NOT IN (SELECT pi2.id_professional
                           FROM prof_institution pi2
                          WHERE pi2.id_institution = :i_id_institution
                            AND pi2.flg_state = :g_active))
         ORDER BY name'
                USING i_lang, i_lang, i_lang, i_prof, i_lang, g_flg_avail, pk_alert_constant.get_no, pk_alert_constant.get_no, i_name, i_name, i_dt_birth, i_lang, i_dt_birth, i_gender, i_gender, i_id_speciality, i_id_speciality, i_num_order, i_num_order, i_id_institution, i_id_institution, g_active;
        
        END IF;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_prof_list);
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'FIND_PROFESSIONALS');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END;

    /**************************************************************************************************************************/
    FUNCTION set_profile_template_lcs
    (
        i_user                  IN profissional,
        i_language              IN language.id_language%TYPE,
        i_id_profile_templ_list IN table_number,
        i_profile_templ_num     IN table_number,
        i_payment_schedule_list IN table_varchar,
        i_flg_status            IN VARCHAR2,
        o_id_license            OUT table_number,
        o_error                 OUT t_error_out
    ) RETURN BOOLEAN IS
        l_id_license NUMBER(24);
        k            NUMBER;
        l_sql        VARCHAR2(30000);
    BEGIN
        g_error := 'SET LICENSES';
    
        l_sql := 'declare
        g_exception EXCEPTION;
        l_id_license table_number;
        l_error t_error_out;
        begin
        
        IF NOT aol.pk_aol_register.set_profile_template_lcs(aol.t_user( ' || i_user.id || ',
                                                                       ' || i_user.institution || ',
                                                                       ' || i_user.software || ',
                                                                       ' || i_language ||
                 '), table_number(' || pk_utils.concat_table(i_id_profile_templ_list, ',') || '), table_number(' ||
                 pk_utils.concat_table(i_profile_templ_num, ',') || '), ' || i_user.institution || ', table_varchar(' ||
                 table_varchar_string(i_payment_schedule_list, ',') || '), ''' || i_flg_status || ''' , :o_id_license,
                 :l_error)
        THEN
            RAISE g_exception;
        END IF;
        end;';
    
        pk_alertlog.log_debug(l_sql);
        EXECUTE IMMEDIATE l_sql
            USING OUT o_id_license, OUT o_error;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_language,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_PROFILE_TEMPLATE_LCS',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
    END;
    /**************************************************************************************************/

    /** @headcom
    * Public Function. Get License Details
    * Retorna os detalhes de licenças de uma instituição.
    * 
    * @param      I_LANG                     Identificação do Idioma
    * @param      I_ID_LICENSE               Identificação da Licença
    * @param      I_ID_PROFESSIONAL          Identificação do Profissional
    * @param      O_LIC                      Cursor com os detalhes de licença
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenço - EL
    * @version    0.1
    * @since      2007/07/30
    */
    FUNCTION get_license_details
    (
        i_lang            IN language.id_language%TYPE,
        i_id_license      IN NUMBER,
        i_id_professional IN professional.id_professional%TYPE,
        o_lic             OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        g_error := 'GET LICENSE DETAILS CURSOR';
        OPEN o_lic FOR
            SELECT l.id_license,
                   ptd.desc_profile_template template_desc,
                   p.id_professional,
                   get_prof_title_desc(i_lang, p.title) title,
                   p.first_name,
                   p.middle_name,
                   p.last_name,
                   p.nick_name,
                   l.id_profile_template_desc,
                   pk_sysdomain.get_domain('AOL.LICENSE.FLG_STATUS', l.flg_status, i_lang) flg_status_desc,
                   pk_sysdomain.get_img(i_lang, 'AOL.LICENSE.FLG_STATUS', l.flg_status) status_image,
                   l.flg_status,
                   pk_sysdomain.get_domain('INST_ATTRIBUTES.LICENSE_MODEL', ia.license_model, i_lang) desc_license_model,
                   pk_sysdomain.get_domain('INST_ATTRIBUTES.PAYMENT_SCHEDULE', l.payment_schedule, i_lang) desc_payment_schedule,
                   l.payment_schedule,
                   pk_sysdomain.get_domain('INST_ATTRIBUTES.PAYMENT_OPTIONS', ia.payment_options, i_lang) desc_payment_options,
                   ia.payment_options,
                   NULL date_first_payment,
                   l.notes_license
              FROM license l,
                   inst_attributes ia,
                   profile_template_desc ptd,
                   (SELECT p.id_professional, p.title, p.first_name, p.middle_name, p.last_name, p.nick_name
                      FROM professional p
                     WHERE p.id_professional = i_id_professional) p
             WHERE l.id_license = i_id_license
               AND ia.id_institution = l.id_institution
               AND l.id_professional = p.id_professional(+)
               AND ptd.id_profile_template_desc = l.id_profile_template_desc;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_lic);
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_PROF_TEMPLATE');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END;

    /*********************************************************************************************/

    FUNCTION cartid_generator
    (
        i_user     IN profissional,
        i_language IN language.id_language%TYPE,
        o_cartid   OUT VARCHAR2,
        o_error    OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        g_error := 'SET LICENSES';
        EXECUTE IMMEDIATE 'declare
        g_exception EXCEPTION;
        begin
        IF NOT
           aol.pk_aol_register.cartid_generator(aol.t_user(:i_user_id, :i_user_institution, :i_user_software, :i_language),
                                                 :o_cartid,
                                                 :o_error)
        THEN
            RAISE g_exception;
        END IF;
        end;'
            USING IN i_user.id, IN i_user.institution, IN i_user.software, IN i_language, OUT o_cartid, OUT o_error;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_language,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'CARTID_GENERATOR',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
    END;
    /*******************************************************************************************************/

    FUNCTION set_payment
    (
        i_user            IN profissional,
        i_language        IN language.id_language%TYPE,
        i_id_license_list IN table_number,
        i_cart_id         IN VARCHAR2,
        i_auth_mode       IN sys_config.value%TYPE,
        i_test_mode       IN sys_config.value%TYPE,
        i_trans_status    IN sys_config.value%TYPE,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
        l_id_currency inst_attributes.id_currency%TYPE;
    BEGIN
    
        g_error := 'GET INSTITUTION';
        SELECT ia.id_currency
          INTO l_id_currency
          FROM inst_attributes ia
         WHERE ia.id_institution = i_user.institution;
    
        g_error := 'SET PAYMENT';
        EXECUTE IMMEDIATE 'declare
        g_exception EXCEPTION;
        begin
        IF NOT aol.pk_aol_register.set_payment(aol.t_user(:i_user_id, :i_user_institution, :i_user_software, :i_language),
                                               :i_institution,
                                               :i_id_license_list,
                                               :l_id_currency,
                                               :i_cart_id,
                                               :i_auth_mode,
                                               :i_test_mode,
                                               :i_trans_status,
                                               :o_error)
        THEN
            RAISE g_exception;
        END IF;
        end;'
            USING IN i_user.id, IN i_user.institution, IN i_user.software, IN i_language, IN i_user.institution, IN i_id_license_list, IN l_id_currency, IN i_cart_id, IN i_auth_mode, IN i_test_mode, IN i_trans_status, OUT o_error;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_language,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_PAYMENT',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END;

    /** @headcom
    * Public Function. Set License Note
    * Insere ou actualiza nota numa determinada licença
    *
    * @param      I_LANG                     Identificação do Idioma
    * @param      I_ID_LICENSE               Identificação da Licença Profissional
    * @param      I_NOTE                     Nota a inserir
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenco - EL
    * @version    0.1
    * @since      2007/07/30
    */
    FUNCTION set_license_info
    (
        i_lang             IN language.id_language%TYPE,
        i_id_license       IN NUMBER,
        i_note             IN VARCHAR2,
        i_payment_schedule IN sys_domain.val%TYPE,
        o_error            OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'UPDATE AOL.LICENSE';
    
        EXECUTE IMMEDIATE 'UPDATE aol.license aol_l
           SET aol_l.notes_license = :i_note, aol_l.payment_schedule = :i_payment_schedule
         WHERE aol_l.id_license = :i_id_license'
            USING i_note, i_payment_schedule, i_id_license;
        COMMIT;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'SET_LICENSE_INFO');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END set_license_info;

    /** @headcom
    * Public Function. Get Assigned Profiles
    * Retorna os perfis associados a um profissional numa instituição
    * 
    * @param      I_LANG                     Identificação do Idioma
    * @param      I_ID_PROFESSIONAL          Identificação do Profissional
    * @param      I_ID_INSITUTION            Identificação da Instituição
    * @param      O_PROF_LIST                Cursor com os detalhes de licença
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenço - EL
    * @version    0.1
    * @since      2007/07/31
    */
    FUNCTION get_assigned_profiles
    (
        i_lang            IN language.id_language%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        i_id_institution  IN institution.id_institution%TYPE,
        o_prof_list       OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
        l_market market.id_market%TYPE;
    BEGIN
        g_error := 'GET INSTITUTION MARKET';
        SELECT nvl((SELECT i.id_market
                     FROM institution i
                    WHERE i.id_institution = i_id_institution),
                   0)
          INTO l_market
          FROM dual;
        g_error := 'GET ASSIGNED PROFILES CURSOR';
        OPEN o_prof_list FOR
            SELECT s.id_software,
                   ppt.id_profile_template,
                   s.name,
                   decode(ptm.id_market,
                          0,
                          pk_message.get_message(i_lang, pt.code_profile_template),
                          pk_message.get_message(i_lang,
                                                 (SELECT pt.code_profile_template
                                                    FROM profile_template pt
                                                   WHERE pt.id_profile_template = ppt.id_profile_template)) || ' (' ||
                          (pk_translation.get_translation(i_lang, 'MARKET.CODE_MARKET.' || ptm.id_market) || ')')) profile
              FROM software_institution si
             INNER JOIN software s
                ON (s.id_software = si.id_software)
             INNER JOIN prof_profile_template ppt
                ON (ppt.id_institution = si.id_institution AND ppt.id_software = s.id_software)
             INNER JOIN profile_template pt
                ON (pt.id_profile_template = ppt.id_profile_template AND pt.flg_available = g_flg_avail AND
                   pt.id_software = s.id_software)
             INNER JOIN profile_template_market ptm
                ON (ptm.id_profile_template = pt.id_profile_template)
             WHERE ppt.id_professional = i_id_professional
               AND si.id_institution = i_id_institution
               AND (ptm.id_market = l_market OR (ptm.id_market != l_market AND ptm.id_market = 0))
             ORDER BY s.name, profile;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            DECLARE
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_prof_list);
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_ASSIGNED_PROFILES');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END;

    /** @headcom
    * Public Function. Cancel License
    * Cancela a licença
    *
    * @param      I_LANG                     Identificação do Idioma
    * @param      I_ID_LICENSE               Identificação da Licença Profissional
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenco - EL
    * @version    0.1
    * @since      2007/07/31
    */
    FUNCTION cancel_license
    (
        i_lang       IN language.id_language%TYPE,
        i_id_license IN NUMBER,
        o_error      OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'UPDATE AOL.LICENSE';
    
        EXECUTE IMMEDIATE 'UPDATE aol.license aol_l
           SET aol_l.flg_status = ''C''
         WHERE aol_l.id_license = :i_id_license'
            USING i_id_license;
        COMMIT;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'CANCEL_LICENSE');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
    END cancel_license;

    /** @headcom
    * Public Function. Associate Specialties to a Professional
    * Cancela a licença
    *
    * @param      I_LANG                     Language identification
    * @param      I_ID_PROF                  Professional identification
    * @param      i_id_institution           Institution identification
    * @param      i_id_dep_clin_serv         Relation between departments and clinical services
    * @param      i_flg                      Flag
    * @param      O_ERROR                    Error
    *
    * @value      i_flg                      {*} 'Y' yes {*} 'N' No
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/07/31
    */
    FUNCTION set_prof_specialties_no_commit
    (
        i_lang             IN language.id_language%TYPE,
        i_id_prof          IN professional.id_professional%TYPE,
        i_id_institution   IN institution.id_institution%TYPE,
        i_id_dep_clin_serv IN table_number,
        i_flg              IN table_varchar,
        o_error            OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_bool      BOOLEAN;
        tbl_service table_number := table_number();
        l_dcs       NUMBER;
        l_service   NUMBER;
        l_rowids    table_varchar;
    
        -- *************************************************************************
        FUNCTION get_id_department
        (
            i_id_prof IN NUMBER,
            i_dcs     IN NUMBER
        ) RETURN NUMBER IS
            l_service         NUMBER;
            tbl_id_department table_number;
        BEGIN
        
            SELECT dcs.id_department
              BULK COLLECT
              INTO tbl_id_department
              FROM prof_dep_clin_serv pdcs
              JOIN dep_clin_serv dcs
                ON dcs.id_dep_clin_serv = pdcs.id_dep_clin_serv
             WHERE pdcs.id_professional = i_id_prof
               AND pdcs.id_dep_clin_serv = i_dcs --i_id_dep_clin_serv(i)
            ;
        
            IF tbl_id_department.count > 0
            THEN
                l_service := tbl_id_department(1);
            END IF;
        
            RETURN l_service;
        
        END get_id_department;
    
        -- ********************************************************
        PROCEDURE del_alloc_to_dcs
        (
            i_id_prof IN NUMBER,
            i_id_dcs  IN NUMBER
        ) IS
        BEGIN
        
            ts_prof_dep_clin_serv.del_pdcs_prf_dcs_i(id_professional_in => i_id_prof, id_dep_clin_serv_in => i_id_dcs);
        
        END del_alloc_to_dcs;
    
        -- ********************************************************
        PROCEDURE del_prof_func
        (
            i_id_prof IN NUMBER,
            i_id_dcs  IN NUMBER
        ) IS
        BEGIN
        
            IF i_id_dcs IS NOT NULL
            THEN
                DELETE FROM prof_func
                 WHERE id_professional = i_id_prof
                   AND id_dep_clin_serv = i_id_dcs;
            END IF;
        
        END del_prof_func;
    
        -- ********************************************************
        PROCEDURE store_service(i_department IN NUMBER) IS
        BEGIN
        
            tbl_service.extend();
            tbl_service(tbl_service.count) := i_department;
        
        END store_service;
    
        -- ********************************************************
        FUNCTION check_if_exist_in_pdcs
        (
            i_id_prof IN NUMBER,
            i_id_dcs  IN NUMBER
        ) RETURN BOOLEAN IS
            l_count NUMBER;
        BEGIN
        
            SELECT COUNT(*)
              INTO l_count
              FROM prof_dep_clin_serv pdcs
             WHERE pdcs.id_professional = i_id_prof
               AND pdcs.id_dep_clin_serv = i_id_dcs;
        
            RETURN(l_count > 0);
        
        END check_if_exist_in_pdcs;
    
        -- ********************************************************    
        FUNCTION get_prof_room
        (
            i_id_prof     IN NUMBER,
            i_tbl_service IN table_number
        ) RETURN table_number IS
            tbl_prof_room table_number;
        BEGIN
        
            SELECT pr.id_prof_room
              BULK COLLECT
              INTO tbl_prof_room
              FROM prof_room pr
              JOIN room r
                ON r.id_room = pr.id_room
              JOIN (SELECT /*+ OPT_ESTIMATE(TABLE xtbl ROWS=1) */
                     column_value id_department
                      FROM TABLE(i_tbl_service) xtbl) d
                ON d.id_department = r.id_department
             WHERE pr.id_professional = i_id_prof;
        
            RETURN tbl_prof_room;
        
        END get_prof_room;
    
        -- ********************************************************    
        PROCEDURE delete_prof_room
        (
            i_id_prof     IN NUMBER,
            i_tbl_service IN table_number
        ) IS
            tbl_prof_room table_number;
        BEGIN
        
            IF i_tbl_service.count > 0
            THEN
            
                tbl_prof_room := get_prof_room(i_id_prof => i_id_prof, i_tbl_service => i_tbl_service);
            
                FORALL i IN 1 .. tbl_prof_room.count
                    DELETE FROM prof_room pr
                     WHERE pr.id_prof_room = tbl_prof_room(i);
            END IF;
        
        END delete_prof_room;
    
    BEGIN
    
        -- Percorerr os elementos a N
        -- apagar o elemento da pdcs
        -- apagar da prof_func se id not null
        -- se nao houver regitos para o iprof,
        -- inserir
        -- Apagar da prof_room  se houve deparmtent selecionados para apagar
    
        -- Percorerr os elementos a Y
        --Se o registo nao existir na prof_dcs, inserir
    
        <<lup_thru_dcs>>
        FOR i IN 1 .. i_id_dep_clin_serv.count
        LOOP
        
            l_dcs := i_id_dep_clin_serv(i);
        
            IF i_flg(i) = 'N'
            THEN
            
                l_service := get_id_department(i_id_prof => i_id_prof, i_dcs => l_dcs);
                store_service(i_department => l_service);
            
                del_alloc_to_dcs(i_id_prof => i_id_prof, i_id_dcs => l_dcs);
            
                del_prof_func(i_id_prof => i_id_prof, i_id_dcs => l_dcs);
            ELSE
            
                l_bool := check_if_exist_in_pdcs(i_id_prof => i_id_prof, i_id_dcs => l_dcs);
            
                IF NOT l_bool
                THEN
                
                    ts_prof_dep_clin_serv.ins(id_prof_dep_clin_serv_in => ts_prof_dep_clin_serv.next_key(),
                                              id_professional_in       => i_id_prof,
                                              id_dep_clin_serv_in      => l_dcs,
                                              flg_status_in            => g_status_pdcs_s,
                                              flg_default_in           => 'N',
                                              id_institution_in        => i_id_institution,
                                              dt_creation_in           => current_timestamp,
                                              rows_out                 => l_rowids);
                
                END IF;
            
            END IF;
        
        END LOOP lup_thru_dcs;
    
        delete_prof_room(i_id_prof => i_id_prof, i_tbl_service => tbl_service);
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_PROF_SPECIALTIES_NO_COMMIT',
                                              o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
        
    END set_prof_specialties_no_commit;

    /** @headcom
    * Public Function. Remove Professional
    * Remove todas as ocorrências que digam respeito a um profissional
    *
    * @param      I_LANG                     Language identification
    * @param      I_ID_PROFESSIONAL          Professional identification
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Eduardo Lourenco - EL
    * @version    0.1
    * @since      2007/08/01
    */
    FUNCTION remove_professional
    (
        i_lang            IN language.id_language%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
    
        g_error := 'DELETE from aol.payment';
        EXECUTE IMMEDIATE 'DELETE FROM aol.payment
         WHERE id_license IN (SELECT id_license
                                FROM aol.license
                               WHERE id_professional = :i_id_professional)'
            USING i_id_professional;
    
        g_error := 'DELETE from aol.license';
        EXECUTE IMMEDIATE 'DELETE FROM aol.license
         WHERE id_professional = :i_id_professional'
            USING i_id_professional;
    
        g_error := 'delete from PROF_ROOM';
        DELETE FROM prof_room
         WHERE id_professional = i_id_professional;
    
        g_error := 'delete from PROF_FUNC';
        DELETE FROM prof_func
         WHERE id_professional = i_id_professional;
    
        g_error := 'delete from PROF_DEP_CLIN_SERV';
        DELETE FROM prof_dep_clin_serv
         WHERE id_professional = i_id_professional;
    
        g_error := 'delete from prof_profile_template ';
        DELETE FROM prof_profile_template
         WHERE id_professional = i_id_professional;
    
        g_error := 'DELETE from prof_preferences';
        DELETE FROM prof_preferences
         WHERE id_professional = i_id_professional;
    
        g_error := 'DELETE from prof_soft_inst';
        DELETE FROM prof_soft_inst
         WHERE id_professional = i_id_professional;
    
        g_error := 'delete from prof_cat';
        DELETE FROM prof_cat
         WHERE id_professional = i_id_professional;
    
        g_error := 'delete from prof_institution';
        DELETE FROM prof_institution
         WHERE id_professional = i_id_professional;
    
        g_error := 'delete from professional';
        DELETE FROM professional
         WHERE id_professional = i_id_professional;
        COMMIT;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'REMOVE_PROFESSIONAL');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END remove_professional;

    /** @headcom
    * Public Function. Remove Institution
    * Remove todas as ocorrências que digam respeito a uma instituição
    *
    * @param      I_LANG                     Identificação do Idioma
    * @param      I_ID_INSTITUTION           Identificação da Instituição
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenco - EL
    * @version    0.1
    * @since      2007/08/01
    */
    FUNCTION remove_institution
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
    
        g_error := 'DELETE from aol.payment';
    
        EXECUTE IMMEDIATE 'DELETE FROM aol.payment
         WHERE id_license IN (SELECT id_license
                                FROM aol.license
                               WHERE id_institution = :i_id_institution)'
            USING i_id_institution;
    
        g_error := 'DELETE from aol.license';
        EXECUTE IMMEDIATE 'DELETE FROM aol.license
         WHERE id_institution = :i_id_institution'
            USING i_id_institution;
    
        g_error := 'DELETE from dept';
        DELETE FROM dept
         WHERE id_institution = i_id_institution;
    
        g_error := 'DELETE from department';
        DELETE FROM department
         WHERE id_institution = i_id_institution;
    
        g_error := 'DELETE from prof_func';
        DELETE FROM prof_func
         WHERE id_institution = i_id_institution;
    
        g_error := 'DELETE from prof_profile_template';
        DELETE FROM prof_profile_template
         WHERE id_institution = i_id_institution;
    
        g_error := 'DELETE from prof_preferences';
        DELETE FROM prof_preferences
         WHERE id_institution = i_id_institution;
    
        g_error := 'DELETE from prof_soft_inst';
        DELETE FROM prof_soft_inst
         WHERE id_institution = i_id_institution;
    
        g_error := 'delete from prof_cat';
        DELETE FROM prof_cat
         WHERE id_institution = i_id_institution;
    
        g_error := 'delete from prof_institution';
        DELETE FROM prof_institution
         WHERE id_institution = i_id_institution;
    
        g_error := 'delete from inst_attributes';
        DELETE FROM inst_attributes
         WHERE id_institution = i_id_institution;
    
        g_error := 'delete from institution_language';
        DELETE FROM institution_language
         WHERE id_institution = i_id_institution;
    
        g_error := 'delete from institution';
        DELETE FROM institution
         WHERE id_institution = i_id_institution;
        COMMIT;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'REMOVE_INSTITUTION');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END remove_institution;

    /** @headcom
    * Public Function. Insert New P1 Specialities Destinations
    *                  OR P1 Specialities Destinations
    *
    * @param      I_LANG                               Language identification
    * @param      I_ID_INSTITUTION                     Institution identification
    * @param      I_SOFT                               Software identification
    * @param      O_ID_SOFT_INST                       Software institution identification
    * @param      O_ERROR                              Error 
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/08/02
    */
    FUNCTION set_software_institution
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN software_institution.id_institution%TYPE,
        i_soft           IN table_number,
        o_id_soft_inst   OUT table_number,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'DELETE FROM SOFTWARE_INSTITUTION';
        pk_api_ab_tables.del_from_ab_software_inst('id_ab_institution = ' || i_id_institution);
        o_id_soft_inst := table_number();
        FOR i IN 1 .. i_soft.count
        LOOP
            o_id_soft_inst.extend;
        
            o_id_soft_inst(i) := get_next_value('SOFTWARE_INSTITUTION', i_id_institution);
        
            g_error := 'INSERT INTO SOFTWARE_INSTITUTION';
            pk_api_ab_tables.upd_ins_into_ab_software_inst(i_id_ab_software_institution => NULL,
                                                           i_import_code                => NULL,
                                                           i_record_status              => 'A',
                                                           i_id_ab_institution          => i_id_institution,
                                                           i_id_ab_software             => i_soft(i),
                                                           o_id_ab_software_institution => o_id_soft_inst(i));
        
        END LOOP;
    
        RETURN TRUE;
        COMMIT;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'SET_SOFTWARE_INSTITUTION');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END set_software_institution;

    /** @headcom
    * Public Function. Get Institution and Profiles
    * Retorna a lista de instituições e perfis para um determinado profissional
    * 
    * @param      I_LANG                     Identificação do Idioma
    * @param      I_ID_INSTITUTION           Identificação da Instituição
    * @param      o_software                     Cursor com a lista de Perfis 
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenço - EL
    * @version    0.1
    * @since      2007/08/02
    *
    * UPDATED
    * coluna subtitle adicionada
    * @author     Telmo Castro
    * @version    2.4.3
    * @date       29-04-2008
    */
    FUNCTION get_institution_software
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        o_software       OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        OPEN o_software FOR
            SELECT s.id_software id,
                   s.name name,
                   pk_translation.get_translation(i_lang, s.code_software) subtitle,
                   REPLACE(pk_translation.get_translation(i_lang, s.code_software), '<br>', ' ') subtitle_no_br
              FROM software_institution si, software s
             WHERE s.flg_mni = g_flg_avail
               AND si.id_software = s.id_software
               AND si.id_institution = i_id_institution
               AND s.id_software != 26
             ORDER BY name;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_software);
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_INSTITUTION_SOFTWARE');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_institution_software;

    /** @headcom
    * Public Function. Set Service Defaults
    *
    * @param      I_LANG                               Identificação do Idioma
    * @param      I_ID_SERVICES                        Array dos serviços
    * @param      I_FLG_DEFAULTS                       Array de flags de serviços default
    * @param      O_ERROR                              Erro 
    *
    * @return     boolean
    * @author     Eduardo Lourenco
    * @version    0.1
    * @since      2007/08/03
    */
    FUNCTION set_service_default
    (
        i_lang        IN language.id_language%TYPE,
        i_id_services IN table_number,
        i_flg_default IN table_varchar,
        o_error       OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        FOR i IN 1 .. i_id_services.count
        LOOP
            g_error := 'UPDATE department';
            UPDATE department d
               SET flg_default = i_flg_default(i)
             WHERE d.id_department = i_id_services(i);
        
        END LOOP;
    
        COMMIT;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'SET_SERVICE_DEFAULT');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END set_service_default;

    /** @headcom
    * Public Function. Unsubscribe Institution License
    *
    * @param      I_LANG                               Identificação do Idioma
    * @param      i_id_inst                            Identificação da instituição
    * @param      O_ERROR                              Erro 
    *
    * @return     boolean
    * @author     Eduardo Lourenco
    * @version    0.1
    * @since      2007/08/03
    */
    FUNCTION unsubscribe_inst_license
    (
        i_lang    IN language.id_language%TYPE,
        i_id_inst IN institution.id_institution%TYPE,
        o_error   OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        g_error := 'UPDATE aol.license';
        EXECUTE IMMEDIATE 'UPDATE aol.license aol_l
           SET aol_l.flg_status = ''C''
         WHERE aol_l.id_institution = :i_id_inst'
            USING i_id_inst;
    
        g_error := 'UPDATE institution';
        EXECUTE IMMEDIATE 'UPDATE institution i
           SET i.flg_available = ''N''
         WHERE i.id_institution = :i_id_inst'
            USING i_id_inst;
    
        COMMIT;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'SET_SERVICE_DEFAULT');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END unsubscribe_inst_license;

    /** @headcom
    * Public Function. Get Institution and Profiles
    * Retorna a lista de instituições e perfis para um determinado profissional
    * 
    * @param      I_LANG                     Language identification
    * @param      i_prof                     Professional identification
    * @param      i_id_institution           Institution identification
    * @param      i_id_professional          Professional identification
    * @param      i_id_license               Licence identification               
    * @param      o_adm                      Cursor
    * @param      o_inst                     Cursor 
    * @param      o_prof                     Cursor
    * @param      o_lic                      Cursor
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/08/07
    */
    FUNCTION get_header
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN profissional,
        i_id_institution  IN institution.id_institution%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        i_id_license      IN NUMBER,
        o_adm             OUT pk_types.cursor_type,
        o_inst            OUT pk_types.cursor_type,
        o_prof            OUT pk_types.cursor_type,
        o_lic             OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
        l_spec             speciality.id_speciality%TYPE := NULL;
        l_profile_template profile_template.id_profile_template%TYPE;
    
    BEGIN
    
        SELECT ppt.id_profile_template
          INTO l_profile_template
          FROM prof_profile_template ppt
         WHERE ppt.id_software = i_prof.software
           AND ppt.id_professional = i_prof.id
           AND ppt.id_institution = i_prof.institution;
    
        IF i_id_professional IS NOT NULL
        THEN
            g_error := 'SELECT p.id_speciality INTO l_spec';
            SELECT p.id_speciality
              INTO l_spec
              FROM professional p
             WHERE p.id_professional = i_id_professional;
        END IF;
    
        g_error := 'OPEN O_ADMN';
        OPEN o_adm FOR
            SELECT p.id_professional, p.name, p.nick_name, get_prof_photo_url(i_lang, p.id_professional) photo
              FROM professional p
             WHERE p.id_professional = i_prof.id;
    
        IF i_id_institution IS NOT NULL
           AND i_id_professional IS NULL
        THEN
            g_error := 'OPEN O_INST';
            OPEN o_inst FOR
                SELECT DISTINCT (pk_translation.get_translation(i_lang, i.code_institution)) instit,
                                (pk_sysdomain.get_domain('AB_INSTITUTION.FLG_TYPE', i.flg_type, i_lang)) instit_type,
                                p.name,
                                pk_message.get_message(i_lang, pt.code_profile_template) profil,
                                
                                i.abbreviation
                  FROM professional          p,
                       prof_institution      pi,
                       institution           i,
                       prof_profile_template ppt,
                       profile_template      pt,
                       prof_photo            pp
                 WHERE p.id_professional = i_prof.id
                   AND pi.id_professional = p.id_professional
                   AND pi.id_institution = i_id_institution
                   AND pi.id_institution = i.id_institution
                   AND ppt.id_professional = p.id_professional
                   AND pt.id_profile_template = ppt.id_profile_template
                   AND pt.id_profile_template = l_profile_template;
        ELSE
            OPEN o_inst FOR
                SELECT 1
                  FROM dual
                 WHERE 1 = 2;
        END IF;
    
        IF i_id_professional IS NOT NULL
           AND i_id_institution IS NOT NULL
        THEN
            g_error := 'OPEN O_PROF';
            OPEN o_prof FOR
                SELECT DISTINCT get_prof_title_desc(i_lang, p.title) title,
                                p.name,
                                p.nick_name,
                                decode(l_spec,
                                       NULL,
                                       NULL,
                                       pk_translation.get_translation(i_lang,
                                                                      (SELECT spec.code_speciality
                                                                         FROM speciality spec
                                                                        WHERE spec.id_speciality = l_spec))) especialidade,
                                pk_translation.get_translation(i_lang, i.code_institution) insituicao,
                                pk_translation.get_translation(i_lang, c.code_category) categoria_profissional,
                                get_prof_photo_url(i_lang, p.id_professional) photo
                  FROM professional p, institution i, prof_institution pi, prof_cat pc, category c
                 WHERE p.id_professional = i_id_professional
                   AND pi.id_professional = p.id_professional
                   AND pi.id_institution = i_id_institution
                   AND i.id_institution = pi.id_institution
                   AND pc.id_professional = p.id_professional
                   AND c.id_category = pc.id_category
                   AND pc.id_institution = i.id_institution;
        
        ELSE
            OPEN o_prof FOR
                SELECT 1
                  FROM dual
                 WHERE 1 = 2;
        END IF;
    
        IF i_id_license IS NOT NULL
        THEN
            g_error := 'OPEN O_LIC';
            OPEN o_lic FOR 'SELECT pk_message.get_message(:i_lang, ''ADMINISTRATOR_IDENT_T069'') id_license,
                       pk_message.get_message(:i_lang, ''ADMINISTRATOR_IDENT_T076'') desc_license_model,
                       pk_message.get_message(:i_lang, ''ADMINISTRATOR_IDENT_T077'') desc_payment_schedule,
                       pk_message.get_message(:i_lang, ''ADMINISTRATOR_IDENT_T070'') next_payment_desc
                  FROM dual
                UNION ALL
                SELECT to_char(aol_l.id_license),
                       pk_sysdomain.get_domain(''INST_ATTRIBUTES.LICENSE_MODEL'', ia.license_model, :i_lang) desc_license_model,' ||
            
             'pk_sysdomain.get_domain(''INST_ATTRIBUTES.PAYMENT_SCHEDULE'', aol_l.payment_schedule, :i_lang) desc_payment_schedule,' || 'pk_date_utils.dt_chr(:i_lang, aol_l.dt_expire, :i_prof) next_payment_desc ' || 'FROM aol.license aol_l, inst_attributes ia
                 WHERE aol_l.id_license = :i_id_license
                   AND ia.id_institution = aol_l.id_institution'
                USING i_lang, i_lang, i_lang, i_lang, i_lang, i_lang, i_lang, i_prof, i_id_license;
        
        ELSE
            OPEN o_lic FOR
                SELECT 1
                  FROM dual
                 WHERE 1 = 2;
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_adm);
            pk_types.open_my_cursor(o_inst);
            pk_types.open_my_cursor(o_prof);
            pk_types.open_my_cursor(o_lic);
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_HEADER',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
    END get_header;

    /** @headcom
    * Public Function. 
    *
    * @param      I_LANG                     Language identification
    * @param      I_PROF                     System administrator
    * @param      I_ID_PROFESSIONAL          Professional identification 
    * @param      i_id_institution           Institution identification
    * @param      O_INST_PROFILE             Cursor with institution information
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/08/08
    */
    FUNCTION get_inst_prof
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN profissional,
        i_id_professional IN professional.id_professional%TYPE,
        i_id_institution  IN institution.id_institution%TYPE,
        o_inst_profile    OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_profile_template profile_template.id_profile_template%TYPE;
    
    BEGIN
    
        SELECT ppt.id_profile_template
          INTO l_profile_template
          FROM prof_profile_template ppt
         WHERE ppt.id_software = i_prof.software
           AND ppt.id_professional = i_prof.id
           AND ppt.id_institution = i_prof.institution;
    
        g_error := 'CURSOR O_INST_PROFILE';
        IF l_profile_template = 30
        THEN
        
            OPEN o_inst_profile FOR 'SELECT DISTINCT l.id_institution id, pk_translation.get_translation(:i_lang, i.code_institution) name
                  FROM aol.license l, institution i
                 WHERE l.id_professional = :i_id_professional
                   AND l.id_institution = i.id_institution
                   AND i.id_institution = :i_id_institution'
                USING i_lang, i_id_professional, i_id_institution;
        ELSE
            OPEN o_inst_profile FOR
                SELECT DISTINCT i.id_institution id, pk_translation.get_translation(i_lang, i.code_institution) name
                  FROM institution i, prof_institution pi
                 WHERE pi.id_professional = i_id_professional
                   AND pi.id_institution = i.id_institution
                   AND i.id_institution = i_id_institution;
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_inst_profile);
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_INST_PROF');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_inst_prof;

    /** @headcom
    * Public Function. 
    *
    * @param      I_LANG                     Language identification
    * @param      I_PROF                     System administrator
    * @param      I_ID_PROFESSIONAL          Professional identification 
    * @param      i_id_institution           Institution identification
    * @param      O_INST_PROFILE             Cursor with institution identification
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/08/08
    */
    FUNCTION get_inst_spec
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN profissional,
        i_id_professional IN professional.id_professional%TYPE,
        i_id_institution  IN institution.id_institution%TYPE,
        o_inst_spec       OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_profile_template profile_template.id_profile_template%TYPE;
        l_state            NUMBER;
    
    BEGIN
    
        SELECT ppt.id_profile_template
          INTO l_profile_template
          FROM prof_profile_template ppt
         WHERE ppt.id_software = i_prof.software
           AND ppt.id_professional = i_prof.id
           AND ppt.id_institution = i_prof.institution;
    
        g_error := 'GET PROF_INSTITUTION STATE';
        SELECT COUNT(pi.flg_state)
          INTO l_state
          FROM prof_institution pi
         WHERE pi.id_institution = i_id_institution
           AND pi.id_professional = i_id_professional;
    
        g_error := 'CURSOR O_INST_PROFILE';
        IF l_profile_template = 30
        THEN
        
            OPEN o_inst_spec FOR 'SELECT DISTINCT i.id_institution,
                                pk_translation.get_translation(:i_lang, i.code_institution) instituicao,
                                pk_translation.get_translation(:i_lang, ca.code_category) categoria,
                                pi.flg_state,
                                pk_sysdomain.get_domain(''PROF_INSTITUTION.FLG_STATE'', nvl(pi.flg_state, ''A''), :i_lang) estado,
                                pk_sysdomain.get_img(:i_lang, ''PROF_INSTITUTION.FLG_STATE'', nvl(pi.flg_state, ''A'')) icon,
                                (SELECT COUNT(*)
                                   FROM prof_dep_clin_serv pdcs
                                  WHERE pdcs.id_professional = :i_id_professional
                                    AND pdcs.id_institution = i.id_institution) count_spec
                  FROM aol.license l, professional p, category ca, prof_cat pc, institution i, prof_institution pi
                 WHERE p.id_professional = :i_id_professional
                   AND l.id_professional = p.id_professional
                   AND ca.id_category = pc.id_category
                   AND p.id_professional = pc.id_professional
                   AND nvl(p.flg_prof_test, pk_alert_constant.get_no) = pk_alert_constant.get_no
                   AND i.id_institution = l.id_institution
                   AND p.id_professional = pi.id_professional
                   AND pi.id_institution = i.id_institution
                   AND pc.id_institution = i.id_institution
                   AND i.id_institution = :i_id_institution'
                USING i_lang, i_lang, i_lang, i_lang, i_id_professional, i_id_professional, i_id_institution;
        ELSE
            IF l_state = 1
            THEN
                OPEN o_inst_spec FOR
                    SELECT DISTINCT i.id_institution,
                                    pk_translation.get_translation(i_lang, i.code_institution) instituicao,
                                    pk_translation.get_translation(i_lang, ca.code_category) categoria,
                                    pi.flg_state,
                                    pk_sysdomain.get_domain('PROF_INSTITUTION.FLG_STATE',
                                                            nvl(pi.flg_state, 'A'),
                                                            i_lang) estado,
                                    pk_sysdomain.get_img(i_lang, 'PROF_INSTITUTION.FLG_STATE', nvl(pi.flg_state, 'A')) icon,
                                    (SELECT COUNT(*)
                                       FROM prof_dep_clin_serv pdcs
                                      WHERE pdcs.id_professional = i_id_professional
                                        AND pdcs.id_institution = i.id_institution) count_spec
                      FROM professional p, category ca, prof_cat pc, institution i, prof_institution pi
                     WHERE p.id_professional = i_id_professional
                       AND ca.id_category = pc.id_category
                       AND pi.flg_state = pk_alert_constant.g_active
                       AND p.id_professional = pc.id_professional
                       AND nvl(p.flg_prof_test, pk_alert_constant.get_no) = pk_alert_constant.get_no
                       AND p.id_professional = pi.id_professional
                       AND pi.id_institution = i.id_institution
                       AND pc.id_institution = i.id_institution
                       AND i.id_institution = i_id_institution;
            ELSE
                OPEN o_inst_spec FOR
                    SELECT DISTINCT i.id_institution,
                                    pk_translation.get_translation(i_lang, i.code_institution) instituicao,
                                    pk_translation.get_translation(i_lang, ca.code_category) categoria,
                                    pi.flg_state,
                                    pk_sysdomain.get_domain('PROF_INSTITUTION.FLG_STATE',
                                                            nvl(pi.flg_state, 'A'),
                                                            i_lang) estado,
                                    pk_sysdomain.get_img(i_lang, 'PROF_INSTITUTION.FLG_STATE', nvl(pi.flg_state, 'A')) icon,
                                    (SELECT COUNT(*)
                                       FROM prof_dep_clin_serv pdcs
                                      WHERE pdcs.id_professional = i_id_professional
                                        AND pdcs.id_institution = i.id_institution) count_spec
                      FROM professional p, category ca, prof_cat pc, institution i, prof_institution pi
                     WHERE p.id_professional = i_id_professional
                       AND ca.id_category = pc.id_category
                       AND p.id_professional = pc.id_professional
                       AND nvl(p.flg_prof_test, pk_alert_constant.g_no) = pk_alert_constant.g_no
                       AND p.id_professional = pi.id_professional
                       AND pi.id_institution = i.id_institution
                       AND pc.id_institution = i.id_institution
                       AND pi.flg_state = pk_alert_constant.g_active
                       AND i.id_institution = i_id_institution
                       AND pi.flg_state = (SELECT pi3.flg_state
                                           
                                             FROM prof_institution pi3
                                            WHERE pi3.id_professional = i_id_professional
                                              AND pi3.flg_state = pk_alert_constant.g_active
                                              AND pi3.id_institution = i.id_institution
                                              AND pi3.dt_begin_tstz =
                                                  (SELECT MAX(pi2.dt_begin_tstz)
                                                     FROM prof_institution pi2
                                                    WHERE pi2.id_institution = i.id_institution
                                                      AND pi2.flg_state = pk_alert_constant.g_active
                                                      AND pi2.id_professional = i_id_professional));
            END IF;
        
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_inst_spec);
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_INST_SPEC');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_inst_spec;

    /*************************************************************************************************/

    FUNCTION get_currency_desc
    (
        i_user          IN profissional,
        i_language      IN language.id_language%TYPE,
        o_currency_desc OUT pk_types.cursor_type,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
    
        g_error := 'GET CURRENCY DESC';
        OPEN o_currency_desc FOR
            SELECT '(' || c.currency_desc || ')' currency_desc,
                   c.decimal_delimiter,
                   c.millenarian_delimiter,
                   c.unit_measure_flash
              FROM inst_attributes ia, currency c
             WHERE ia.id_institution = i_user.institution
               AND ia.id_currency = c.id_currency;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_currency_desc);
            pk_alert_exceptions.process_error(i_language,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_CURRENCY_DESC',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END;

    /** @headcom
    * Public Function. 
    *
    * @param      I_LANG                     Language identification
    * @param      I_ID_LICENSE               Licence identification
    * @param      O_LIC_CAT                  Cursor with licence category
    * @param      O_ERROR                    Error
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/08/09
    */
    FUNCTION get_license_cat
    (
        i_lang       IN language.id_language%TYPE,
        i_id_license IN NUMBER,
        o_lic_cat    OUT pk_types.cursor_type,
        o_error      OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        IF i_id_license IS NOT NULL
        THEN
            g_error := 'CURSOR O_LIC_CAT';
            OPEN o_lic_cat FOR 'SELECT c.id_category id_category, pk_translation.get_translation(:i_lang, c.code_category) cat,
            decode(c.flg_type, ''D'', ''Y'', ''N'') flg_clinical
                  FROM category c, profile_template pt, profile_template_desc ptd, aol.license l
                 WHERE l.id_license = :i_id_license
                   AND ptd.id_profile_template_desc = l.id_profile_template_desc
                   AND c.id_category = pt.id_category
                   AND ptd.id_profile_template = pt.id_profile_template'
                USING i_lang, i_id_license;
        ELSE
            g_error := 'CURSOR O_LIC_CAT';
            OPEN o_lic_cat FOR
                SELECT c.id_category id_category,
                       pk_translation.get_translation(i_lang, c.code_category) cat,
                       decode(c.flg_type, 'D', 'Y', 'N') flg_clinical
                  FROM category c, profile_template pt
                 WHERE pt.id_profile_template = 30
                   AND c.id_category = pt.id_category;
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                pk_types.open_my_cursor(o_lic_cat);
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_LICENSE_CAT');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_license_cat;

    /**********************************************************************************************/

    /** @headcom
    * Public Function. Unsubscribe Institution
    *
    * @param      I_LANG                               Identificação do Idioma
    * @param      I_ID_INSTITUTION                     Identificação da instituição
    * @param      O_ERROR                              Erro 
    *
    * @return     boolean
    * @author     Eduardo Lourenco
    * @version    0.1
    * @since      2007/08/27
    */
    FUNCTION unsubscribe_inst
    (
        i_lang    IN language.id_language%TYPE,
        i_id_inst IN institution.id_institution%TYPE,
        o_error   OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'UPDATE institution';
        UPDATE institution i
           SET i.flg_available = 'N'
         WHERE i.id_institution = i_id_inst;
    
        COMMIT;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'UNSUBSCRIBE_INST');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END unsubscribe_inst;

    /** @headcom
    * Public Function. Get Institution Type
    * Devolve as instituições e o respectivo tipo
    *
    * @param      I_LANG                     Identificação do Idioma
    * @param      I_ID_PROFESSIONAL          Identificação do Profissional
    * @param      O_INST_LIST                Cursor com a informação das instituições
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenço - EL
    * @version    0.1
    * @since      2007/08/27
    */
    FUNCTION get_institution_type
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN profissional,
        i_id_professional IN professional.id_professional%TYPE,
        o_inst_list       OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
        l_profile_template profile_template.id_profile_template%TYPE;
    BEGIN
    
        SELECT ppt.id_profile_template
          INTO l_profile_template
          FROM prof_profile_template ppt
         WHERE ppt.id_software = i_prof.software
           AND ppt.id_professional = i_prof.id
           AND ppt.id_institution = i_prof.institution;
    
        g_error := 'GET INSTITUTION TYPE CURSOR';
        OPEN o_inst_list FOR
            SELECT i.id_institution,
                   pk_translation.get_translation(i_lang, i.code_institution) desc_institution,
                   pk_sysdomain.get_domain('AB_INSTITUTION.FLG_TYPE', nvl(i.flg_type, NULL), i_lang) TYPE
              FROM prof_profile_template ppt, institution i
             WHERE ppt.id_professional = i_id_professional
               AND ppt.id_profile_template = l_profile_template
               AND i.id_institution = ppt.id_institution
               AND i.flg_available = g_flg_avail
             ORDER BY desc_institution;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_INSTITUTION_TYPE');
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_types.open_my_cursor(o_inst_list);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_institution_type;

    /** @headcom
    * Public Function. Get Professional NoLicenses
    * Devolve os profissionais para uma determinada instituição.
    * O tipo representado pela flag poder?ser clínico, não clínico ou todos (null)
    * 
    * @param      I_LANG                     Identificação do Idioma
    * @param      I_ID_INSTITUTION           Identificação da Instituição
    * @param      I_FLG_TYPE                 Identificação do Tipo de Profissionais
    * @param      I_SEARCH                   palavra a pesquisar
    * @param      O_PROF_LIST                Cursor com a informação de profissionais e licenças
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenço - EL
    * @version    0.1
    * @since      2007/08/27
    */
    FUNCTION get_professional_nolicense
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        i_flg_type       IN category.flg_type%TYPE,
        i_search         IN VARCHAR2,
        o_prof_list      OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_flg_group profile_template.flg_group%TYPE;
    
    BEGIN
    
        l_flg_group := CASE i_flg_type
                           WHEN 'Y' THEN
                            'P'
                           WHEN 'N' THEN
                            'C'
                           WHEN 'O' THEN
                            'N'
                           ELSE
                            NULL
                       END;
    
        g_error := 'GET PROFESSIONAL NOLICENSE CURSOR';
        OPEN o_prof_list FOR
            SELECT t.id_professional,
                   pk_backoffice.get_prof_photo_url(i_lang, t.id_professional) photo,
                   t.name,
                   decode(t.part,
                          1,
                          pk_utils.concat_table(CAST(MULTISET
                                                     (SELECT s2.name || ' - ' ||
                                                             pk_message.get_message(i_lang, pt2.code_profile_template) profile_desc
                                                        FROM profile_template pt2
                                                        JOIN prof_profile_template ppt2
                                                          ON pt2.id_profile_template = ppt2.id_profile_template
                                                        JOIN software s2
                                                          ON pt2.id_software = s2.id_software
                                                       WHERE ppt2.id_professional = t.id_professional
                                                         AND ppt2.id_institution = i_id_institution
                                                         AND pt2.flg_group = l_flg_group
                                                         AND pt2.flg_available = g_flg_avail
                                                         AND s2.flg_viewer = pk_alert_constant.get_no
                                                       ORDER BY profile_desc) AS table_varchar),
                                                ', '),
                          NULL -- não tenta encontrar os perfis para os profissionais da segunda parte do UNION ALL
                          ) profile, -- lista de perfis do profissional por software
                   (SELECT t1.flg_state
                      FROM (SELECT pi.flg_state,
                                   id_professional,
                                   row_number() over(PARTITION BY id_professional ORDER BY dt_end_tstz DESC NULLS FIRST) rn
                              FROM prof_institution pi
                             WHERE pi.id_institution = i_id_institution) t1
                     WHERE t.id_professional = t1.id_professional
                       AND t1.rn = 1) flg_state,
                   (SELECT pk_sysdomain.get_domain('PROF_INSTITUTION.FLG_STATE',
                                                   (SELECT t1.flg_state
                                                      FROM (SELECT pi.flg_state,
                                                                   id_professional,
                                                                   row_number() over(PARTITION BY id_professional ORDER BY dt_end_tstz DESC NULLS FIRST) rn
                                                              FROM prof_institution pi
                                                             WHERE pi.id_institution = i_id_institution) t1
                                                     WHERE t.id_professional = t1.id_professional
                                                       AND t1.rn = 1),
                                                   i_lang)
                      FROM dual) state_desc,
                   (SELECT pk_sysdomain.get_img(i_lang,
                                                'PROF_INSTITUTION.FLG_STATE',
                                                (SELECT t1.flg_state
                                                   FROM (SELECT pi.flg_state,
                                                                id_professional,
                                                                row_number() over(PARTITION BY id_professional ORDER BY dt_end_tstz DESC NULLS FIRST) rn
                                                           FROM prof_institution pi
                                                          WHERE pi.id_institution = i_id_institution) t1
                                                  WHERE t.id_professional = t1.id_professional
                                                    AND t1.rn = 1))
                      FROM dual) status_image,
                   pk_backoffice.get_user_status(i_lang, t.id_professional) user_status_msg,
                   t.id_category,
                   t.username
              FROM ( -- profissionais com um perfil associado na instituição e no estado P, C ou N
                    SELECT 1 part,
                            p.id_professional,
                            p.name,
                            pc.id_category,
                            (SELECT uinf.login
                               FROM ab_user_info uinf
                              WHERE uinf.id_ab_user_info = p.id_professional) username
                      FROM professional p
                      JOIN prof_cat pc
                        ON pc.id_professional = p.id_professional
                       AND pc.id_institution = i_id_institution
                     WHERE EXISTS (SELECT 0
                              FROM prof_profile_template ppt
                              JOIN prof_institution pi
                                ON pi.id_professional = ppt.id_professional
                               AND pi.id_institution = ppt.id_institution
                              JOIN profile_template pt
                                ON ppt.id_profile_template = pt.id_profile_template
                               AND pt.flg_group = l_flg_group
                             WHERE ppt.id_institution = i_id_institution
                               AND ppt.id_professional = p.id_professional)
                    UNION ALL
                    -- profissionais associados ?instituição mas sem perfil
                    SELECT 2 part,
                            p.id_professional,
                            p.name,
                            pc.id_category,
                            (SELECT uinf.login
                               FROM ab_user_info uinf
                              WHERE uinf.id_ab_user_info = p.id_professional) username
                      FROM professional p
                      JOIN prof_cat pc
                        ON pc.id_professional = p.id_professional
                       AND pc.id_institution = i_id_institution
                     WHERE NOT EXISTS (SELECT 0
                              FROM prof_profile_template ppt
                             WHERE ppt.id_institution = i_id_institution
                               AND ppt.id_professional = p.id_professional)
                       AND EXISTS (SELECT 0
                              FROM prof_institution pi
                             WHERE pi.id_professional = p.id_professional
                               AND pi.id_institution = pc.id_institution)) t
             WHERE (SELECT pk_prof_utils.is_internal_prof(i_lang,
                                                          profissional(0, 0, 0),
                                                          t.id_professional,
                                                          i_id_institution)
                      FROM dual) = pk_alert_constant.get_yes
             ORDER BY state_desc, name;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_PROFESSIONAL_NOLICENSE');
                pk_types.open_my_cursor(o_prof_list);
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_professional_nolicense;

    /** @headcom
    * Public Function. Cancel Inst Prof
    *
    * @param      I_LANG                     Identificação do Idioma
    * @param      I_ID_INST                  Identificação da Institutição
    * @param      I_ID_PROF                  Identificação do Profissional
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenco - EL
    * @version    0.1
    * @since      2007/08/27
    */
    FUNCTION cancel_inst_prof
    (
        i_lang    IN language.id_language%TYPE,
        i_id_inst IN institution.id_institution%TYPE,
        i_id_prof IN professional.id_professional%TYPE,
        o_error   OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'UPDATE AOL.LICENSE';
        EXECUTE IMMEDIATE 'UPDATE prof_institution pi
           SET pi.flg_state = ''I''
         WHERE pi.id_professional = :i_id_prof
           AND pi.id_institution = :i_id_inst'
            USING i_id_prof, i_id_inst;
        COMMIT;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'CANCEL_INST_PROF');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END cancel_inst_prof;

    /** @headcom
    * Public Function. Get Institution Information List
    *
    * @param      I_LANG                     Identificação do Idioma
    * @param      I_FLG_TYPE                 Tipode Instituição
    * @param      I_ID_PROFESSIONAL          Identificação do profissional 
    * @param      O_INST_LIST                Cursor com a Informação das Instituições
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenco
    * @version    0.1
    * @since      2007/08/27
    */
    FUNCTION get_institution_list_nolicense
    (
        i_lang      IN language.id_language%TYPE,
        i_prof      IN profissional,
        i_flg_type  IN institution.flg_type%TYPE,
        o_inst_list OUT pk_types.cursor_type,
        o_error     OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_profile_template profile_template.id_profile_template%TYPE;
    
    BEGIN
    
        g_error := 'SELECT PPT.ID_PROFILE_TEMPLATE FROM PROF_PROFILE_TEMPLATE PPT';
        SELECT ppt.id_profile_template
          INTO l_profile_template
          FROM prof_profile_template ppt
         WHERE ppt.id_software = i_prof.software
           AND ppt.id_professional = i_prof.id
           AND ppt.id_institution = i_prof.institution;
    
        g_error := 'GET INSTITUTION CURSOR';
        OPEN o_inst_list FOR
            SELECT DISTINCT i.id_institution id,
                            pk_translation.get_translation(i_lang, i.code_institution) name,
                            i.flg_type flg_type,
                            pk_sysdomain.get_domain('AB_INSTITUTION.FLG_TYPE', nvl(i.flg_type, NULL), i_lang) TYPE,
                            i.flg_available,
                            pk_sysdomain.get_domain('AB_INSTITUTION.FLG_AVAILABLE', nvl(i.flg_available, 'Y'), i_lang) state,
                            pk_sysdomain.get_img(i_lang, 'AB_INSTITUTION.FLG_AVAILABLE', i.flg_available) image,
                            decode(i.id_parent,
                                   NULL,
                                   pk_sysdomain.get_domain('AB_INSTITUTION.GROUP', 'M', i_lang),
                                   pk_sysdomain.get_domain('AB_INSTITUTION.GROUP', 'A', i_lang)) grupo,
                            decode(i.id_parent, NULL, 'M', 'A') flg_grupo,
                            i.id_parent
              FROM prof_profile_template ppt, institution i
             WHERE ppt.id_professional = i_prof.id
               AND ppt.id_profile_template = l_profile_template
               AND i.id_institution = ppt.id_institution
             ORDER BY flg_grupo DESC, TYPE DESC, name;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_INSTITUTION_LIST_NOLICENSE');
                pk_types.open_my_cursor(o_inst_list);
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_institution_list_nolicense;

    /** @headcom
    * Public Function. Get Institution Change Details NOLicense
    *
    * @param      I_LANG                     Identificação do Idioma
    * @param      I_ID_INSTITUTION           Identificação da Instituição
    * @param      O_INST_GENERAL_ATTR_LIST   Cursor com os atributos gerais da instituição
    * @param      O_INST_ADMIN_ATTR_LIST     Cursor com os atributos do administrador da instituição
    * @param      O_INST_TITLE_LIST          Cursor com os títulos a preencher
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenco - EL
    * @version    0.1
    * @since      2007/08/27
    */
    FUNCTION get_inst_change_details_nolic
    (
        i_lang                   IN language.id_language%TYPE,
        i_prof                   IN profissional,
        i_id_institution         IN institution.id_institution%TYPE,
        o_inst_general_attr_list OUT pk_types.cursor_type,
        o_inst_admin_attr_list   OUT pk_types.cursor_type,
        o_inst_title_list        OUT pk_types.cursor_type,
        o_error                  OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_profile_template profile_template.id_profile_template%TYPE;
    BEGIN
    
        SELECT ppt.id_profile_template
          INTO l_profile_template
          FROM prof_profile_template ppt
         WHERE ppt.id_software = i_prof.software
           AND ppt.id_professional = i_prof.id
           AND ppt.id_institution = i_prof.institution;
    
        g_error := 'GET LICENSING MODEL LIST CURSOR';
        OPEN o_inst_general_attr_list FOR
            SELECT decode(r,
                          1,
                          name,
                          2,
                          facility_group,
                          3,
                          facility_type,
                          4,
                          social_security_number,
                          5,
                          abbreviation,
                          6,
                          LANGUAGE,
                          7,
                          currency,
                          8,
                          phone_number,
                          9,
                          fax_number,
                          10,
                          email,
                          11,
                          address,
                          12,
                          location,
                          13,
                          district,
                          14,
                          zip_code,
                          15,
                          country) VALUE
              FROM (SELECT pk_translation.get_translation(i_lang, i.code_institution) name,
                           pk_sysdomain.get_domain('AB_INSTITUTION.GROUP', decode(i.id_parent, NULL, 'A', 'M'), i_lang) facility_group,
                           pk_sysdomain.get_domain('AB_INSTITUTION.FLG_TYPE', i.flg_type, i_lang) facility_type,
                           ia.social_security_number,
                           i.abbreviation,
                           get_institution_language(i_lang, i.id_institution) LANGUAGE,
                           pk_translation.get_translation(i_lang,
                                                          (SELECT cu.code_currency
                                                             FROM currency cu
                                                            WHERE cu.id_currency = ia.id_currency)) currency,
                           i.phone_number,
                           i.fax_number,
                           ia.email,
                           i.address,
                           i.location,
                           i.district,
                           i.zip_code,
                           pk_translation.get_translation(i_lang,
                                                          (SELECT c.code_country
                                                             FROM country c
                                                            WHERE c.flg_available = g_flg_avail
                                                              AND c.id_country = ia.id_country)) country
                      FROM institution i, inst_attributes ia
                     WHERE i.id_institution = i_id_institution
                       AND i.id_institution = ia.id_institution(+)),
                   (SELECT rownum r
                      FROM all_objects
                     WHERE rownum <= 15);
    
        OPEN o_inst_admin_attr_list FOR
            SELECT decode(r,
                          1,
                          desc_title,
                          2,
                          first_name,
                          3,
                          middle_name,
                          4,
                          last_name,
                          5,
                          nick_name,
                          6,
                          desc_job_title,
                          7,
                          desc_gender,
                          8,
                          string_birth,
                          9,
                          email,
                          10,
                          work_phone,
                          11,
                          cell_phone,
                          12,
                          fax) VALUE
              FROM (SELECT get_prof_title_desc(i_lang, p.title) desc_title,
                           p.first_name,
                           p.middle_name,
                           p.last_name,
                           p.nick_name,
                           pk_translation.get_translation(i_lang,
                                                          (SELECT c.code_category
                                                             FROM category c
                                                            WHERE c.flg_available = g_flg_avail
                                                              AND c.id_category =
                                                                  (SELECT pc.id_category
                                                                     FROM prof_cat pc
                                                                    WHERE pc.id_institution = i_id_institution
                                                                      AND pc.id_professional = p.id_professional))) desc_job_title,
                           pk_sysdomain.get_domain('PROFESSIONAL.GENDER', p.gender, i_lang) desc_gender,
                           pk_date_utils.date_chr_extend(i_lang, p.dt_birth, i_prof) string_birth,
                           p.email,
                           p.work_phone,
                           p.cell_phone,
                           p.fax
                      FROM professional p
                     WHERE p.id_professional = (SELECT ppt.id_professional
                                                  FROM prof_profile_template ppt
                                                 WHERE ppt.id_profile_template = l_profile_template
                                                   AND ppt.id_institution = i_id_institution)
                       AND nvl(p.flg_prof_test, pk_alert_constant.get_no) = pk_alert_constant.get_no),
                   (SELECT rownum r
                      FROM all_objects
                     WHERE rownum <= 12);
    
        OPEN o_inst_title_list FOR
            SELECT decode(r,
                          1,
                          c1,
                          2,
                          c2,
                          3,
                          c3,
                          4,
                          c4,
                          5,
                          c5,
                          6,
                          c6,
                          7,
                          c7,
                          8,
                          c8,
                          9,
                          c9,
                          10,
                          c10,
                          11,
                          c11,
                          12,
                          c12,
                          13,
                          c13,
                          14,
                          c14,
                          15,
                          c15,
                          16,
                          c16,
                          17,
                          c17,
                          18,
                          c18,
                          19,
                          c19,
                          20,
                          c20,
                          21,
                          c21,
                          22,
                          c22,
                          23,
                          c23,
                          24,
                          c24,
                          25,
                          c25,
                          26,
                          c26,
                          27,
                          c27) title
              FROM (SELECT pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T012') c1,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T013') c2,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T004') c3,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T019') c4,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T052') c5,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T053') c6,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T054') c7,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T010') c8,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T055') c9,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T056') c10,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T025') c11,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T008') c12,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T057') c13,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T058') c14,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T059') c15,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T039') c16,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T040') c17,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T041') c18,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T042') c19,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T040') c20,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T042') c21,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T050') c22,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T082') c23,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T109') c24,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T110') c25,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T111') c26,
                           pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T112') c27
                      FROM dual),
                   (SELECT rownum r
                      FROM all_objects
                     WHERE rownum <= 27);
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_INST_CHANGE_DETAILS_NOLIC');
            
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_types.open_my_cursor(o_inst_general_attr_list);
                pk_types.open_my_cursor(o_inst_admin_attr_list);
                pk_types.open_my_cursor(o_inst_title_list);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_inst_change_details_nolic;

    /** @headcom
    * Public Function. Get Header
    * 
    * @param      I_LANG                     Identificação do Idioma
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenco
    * @version    0.1
    * @since      2007/08/27
    */
    FUNCTION get_header_nolicense
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN profissional,
        i_id_institution  IN institution.id_institution%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        o_adm             OUT pk_types.cursor_type,
        o_inst            OUT pk_types.cursor_type,
        o_prof            OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_spec speciality.id_speciality%TYPE := NULL;
    
    BEGIN
    
        IF i_id_professional IS NOT NULL
        THEN
            g_error := 'SELECT p.id_speciality INTO l_spec';
            SELECT p.id_speciality
              INTO l_spec
              FROM professional p
             WHERE p.id_professional = i_id_professional;
        END IF;
    
        g_error := 'OPEN O_ADMN';
        OPEN o_adm FOR
            SELECT p.id_professional, p.name, p.nick_name
              FROM professional p
             WHERE p.id_professional = i_prof.id;
    
        IF i_id_institution IS NOT NULL
           AND i_id_professional IS NULL
        THEN
            g_error := 'OPEN O_INST';
            OPEN o_inst FOR
                SELECT DISTINCT (pk_translation.get_translation(i_lang, i.code_institution)) instit,
                                (pk_sysdomain.get_domain('AB_INSTITUTION.FLG_TYPE', i.flg_type, i_lang)) instit_type,
                                p.name,
                                pk_message.get_message(i_lang, pt.code_profile_template) profil,
                                i.abbreviation
                  FROM professional          p,
                       prof_institution      pi,
                       institution           i,
                       prof_profile_template ppt,
                       profile_template      pt,
                       prof_photo            pp
                 WHERE p.id_professional = i_prof.id
                   AND pi.id_professional = p.id_professional
                   AND pi.id_institution = i_id_institution
                   AND pi.id_institution = i.id_institution
                   AND ppt.id_professional = p.id_professional
                   AND pt.id_profile_template = ppt.id_profile_template
                   AND pt.id_profile_template = 30;
        ELSE
            OPEN o_inst FOR
                SELECT 1
                  FROM dual
                 WHERE 1 = 2;
        END IF;
    
        IF i_id_professional IS NOT NULL
           AND i_id_institution IS NOT NULL
        THEN
            g_error := 'OPEN O_PROF';
            OPEN o_prof FOR
                SELECT DISTINCT get_prof_title_desc(i_lang, p.title) title,
                                p.name,
                                p.nick_name,
                                decode(l_spec,
                                       NULL,
                                       NULL,
                                       pk_translation.get_translation(i_lang,
                                                                      (SELECT spec.code_speciality
                                                                         FROM speciality spec
                                                                        WHERE spec.id_speciality = l_spec))) especialidade,
                                pk_translation.get_translation(i_lang, i.code_institution) insituicao,
                                pk_translation.get_translation(i_lang, c.code_category) categoria_profissional
                  FROM professional p, institution i, prof_institution pi, prof_cat pc, category c
                 WHERE p.id_professional = i_id_professional
                   AND pi.id_professional = p.id_professional
                   AND pi.id_institution = i_id_institution
                   AND i.id_institution = pi.id_institution
                   AND pc.id_professional = p.id_professional
                   AND c.id_category = pc.id_category
                   AND pc.id_institution = i.id_institution;
        
        ELSE
            OPEN o_prof FOR
                SELECT 1
                  FROM dual
                 WHERE 1 = 2;
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'GET_HEADER_NOLICENCE');
            
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_types.open_my_cursor(o_adm);
                pk_types.open_my_cursor(o_inst);
                pk_types.open_my_cursor(o_prof);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_header_nolicense;

    /** @headcom
    * Public Function. Get PROF POSSIBLE LIST
    *
    * @param      I_LANG                     Identificação do Idioma
    * @param      O_LIST                     Cursor com a lista de tarefas possíveis no botão de adicionar no ecra de profissionais
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenco - EL
    * @version    0.1
    * @since      2007/08/29
    */
    FUNCTION get_prof_possible_list
    (
        i_lang  IN language.id_language%TYPE,
        o_list  OUT pk_types.cursor_type,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET LICENSING MODEL LIST CURSOR';
        OPEN o_list FOR
        
            SELECT val, desc_val
              FROM sys_domain
             WHERE code_domain = 'PROFESSIONAL_ADD_TASK'
               AND domain_owner = pk_sysdomain.k_default_schema
               AND flg_available = g_flg_available
               AND id_language = i_lang
             ORDER BY rank;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'GET_PROF_POSSIBLE_LIST');
                pk_types.open_my_cursor(o_list);
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END get_prof_possible_list;

    /** @headcom
    * Public Function. Insert New Institution OR Update Institution Information
    *
    * @param      I_LANG                               Language identification
    * @param      I_ID_INSTITUTION                     Institution identification
    * @param      i_id_inst_att                        Atributes institution
    * @param      i_id_inst_lang                       Language identification
    * @param      I_DESC                               Institution description
    * @param      i_id_parent                          Institution parent
    * @param      I_FLG_TYPE                           Institution type: H - Hospital, C - Primary care, P - Private Practice
    * @param      i_tax                                Social security number
    * @param      I_ABBREVIATION                       Abbreviation
    * @param      i_pref_lang                          Language
    * @param      I_PHONE_NUMBER                       Phone number
    * @param      i_fax                                Fax
    * @param      i_email                              Email
    * @param      i_adress                             Adress
    * @param      I_LOCATION                           Location
    * @param      i_geo_state                          District
    * @param      i_zip_code                           Zip code
    * @param      i_country                            Country
    * @param      I_FLG_AVAILABLE                      Flag available
    * @param      i_id_tz_region                       Timezone region identification
    * @param      o_id_institution                     Cursor
    * @param      o_id_inst_attributes                 Cursor
    * @param      o_id_inst_lang                       Cursor
    * @param      O_ERROR                              Error 
    *
    * @return     boolean
    * @author     Tércio Soares - JTS
    * @version    0.1
    * @since      2007/07/20
    */
    FUNCTION set_institution_data_nolicense
    (
        i_lang               IN language.id_language%TYPE,
        i_id_institution     IN institution.id_institution%TYPE,
        i_id_inst_att        IN inst_attributes.id_inst_attributes%TYPE,
        i_id_inst_lang       IN institution_language.id_institution_language%TYPE,
        i_desc               IN VARCHAR2,
        i_id_parent          IN institution.id_parent%TYPE,
        i_flg_type           IN institution.flg_type%TYPE,
        i_tax                IN inst_attributes.social_security_number%TYPE,
        i_abbreviation       IN institution.abbreviation%TYPE,
        i_pref_lang          IN institution_language.id_language%TYPE,
        i_currency           IN inst_attributes.id_currency%TYPE,
        i_phone_number       IN institution.phone_number%TYPE,
        i_fax                IN institution.fax_number%TYPE,
        i_email              IN inst_attributes.email%TYPE,
        i_adress             IN institution.address%TYPE,
        i_location           IN institution.location%TYPE,
        i_geo_state          IN institution.district%TYPE,
        i_zip_code           IN institution.zip_code%TYPE,
        i_country            IN inst_attributes.id_country%TYPE,
        i_flg_available      IN institution.flg_available%TYPE,
        i_id_tz_region       IN institution.id_timezone_region%TYPE,
        i_contact_det        IN ab_institution.contact_detail%TYPE,
        o_id_institution     OUT institution.id_institution%TYPE,
        o_id_inst_attributes OUT inst_attributes.id_inst_attributes%TYPE,
        o_id_inst_lang       OUT institution_language.id_institution_language%TYPE,
        o_error              OUT t_error_out
    ) RETURN BOOLEAN IS
        l_id_inst_logo    institution_logo.id_institution_logo%TYPE;
        l_count_inst_lang NUMBER;
        my_exception EXCEPTION;
        l_code_trl     translation.code_translation%TYPE := 'AB_INSTITUTION.CODE_INSTITUTION.';
        l_professional ab_user_info.id_ab_user_info%TYPE;
    
        CURSOR c_lang IS
            SELECT *
              FROM LANGUAGE;
    
    BEGIN
        g_sysdate := SYSDATE;
    
        IF i_desc IS NULL
        THEN
            g_error := 'Invalid Institution Name';
            RAISE my_exception;
        ELSIF i_flg_type IS NULL
        THEN
            g_error := 'Invalid Type of Insitution';
            RAISE my_exception;
        ELSIF i_flg_available IS NULL
        THEN
            g_error := 'Please Choose Available: Y/N';
            RAISE my_exception;
        ELSIF i_id_institution IS NULL
        THEN
        
            g_error := 'INSERT INTO INSTITUTION';
            pk_api_ab_tables.upd_ins_into_ab_institution(i_id_ab_institution          => i_id_institution,
                                                         i_import_code                => NULL,
                                                         i_record_status              => 'A',
                                                         i_id_ab_market               => NULL,
                                                         i_code                       => NULL,
                                                         i_description                => i_desc,
                                                         i_alt_description            => NULL,
                                                         i_shortname                  => i_abbreviation,
                                                         i_vat_registration           => NULL,
                                                         i_timezone_region_code       => NULL,
                                                         i_rb_country_key             => NULL, --id_country
                                                         i_rb_regional_classifier_key => NULL,
                                                         i_id_ab_institution_parent   => i_id_parent,
                                                         i_flg_type                   => i_flg_type,
                                                         i_address1                   => i_adress,
                                                         i_address2                   => i_geo_state,
                                                         i_address3                   => i_location,
                                                         i_zip_code                   => i_zip_code,
                                                         i_zip_code_description       => NULL,
                                                         i_fax_number                 => i_fax,
                                                         i_phone_number               => i_phone_number,
                                                         i_email                      => NULL,
                                                         i_logo                       => NULL,
                                                         i_web_site                   => NULL,
                                                         i_geo_location_key           => NULL /*l_district*/,
                                                         i_flg_external               => NULL,
                                                         i_code_institution           => l_code_trl || i_id_institution,
                                                         i_flg_available              => i_flg_available,
                                                         i_rank                       => 1,
                                                         i_barcode                    => NULL,
                                                         i_ine_location               => 'N/A',
                                                         i_id_timezone_region         => i_id_tz_region,
                                                         i_ext_code                   => NULL,
                                                         i_dn_flg_status              => NULL,
                                                         i_adress_type                => NULL,
                                                         i_contact_det                => i_contact_det,
                                                         o_id_ab_institution          => o_id_institution);
        
            g_error := 'GET SEQ_INST_ATTRIBUTES.NEXTVAL';
            SELECT seq_inst_attributes.nextval
              INTO o_id_inst_attributes
              FROM dual;
        
            g_error := 'GET SEQ_INSTITUTION_LANGUAGE.NEXTVAL';
            SELECT seq_institution_language.nextval
              INTO o_id_inst_lang
              FROM dual;
        
            g_error := 'INSERT INTO INSTITUTION_LANGUAGE';
            INSERT INTO institution_language
                (id_institution_language, id_language, id_institution, flg_available, adw_last_update)
            VALUES
                (o_id_inst_lang, i_pref_lang, o_id_institution, g_flg_avail, SYSDATE);
        
            g_error := 'INSERT INTO INST_ATTRIBUTES';
            INSERT INTO inst_attributes
                (id_country,
                 id_institution,
                 id_inst_attributes,
                 social_security_number,
                 id_currency,
                 email,
                 flg_available,
                 id_institution_language)
            VALUES
                (i_country,
                 o_id_institution,
                 o_id_inst_attributes,
                 i_tax,
                 i_currency,
                 i_email,
                 g_flg_avail,
                 o_id_inst_lang);
        
            -- Update all description of code_tranlsation ( name of institution )             
            FOR r_lang IN c_lang
            LOOP
                pk_translation.insert_into_translation(r_lang.id_language,
                                                       l_code_trl || o_id_institution || '',
                                                       i_desc);
            END LOOP;
        
        ELSE
            g_error := 'UPDATE INSTITUTION';
            pk_api_ab_tables.upd_ins_into_ab_institution(i_id_ab_institution          => i_id_institution,
                                                         i_import_code                => NULL,
                                                         i_id_ab_market               => NULL,
                                                         i_code                       => NULL,
                                                         i_description                => NULL,
                                                         i_alt_description            => NULL,
                                                         i_vat_registration           => NULL,
                                                         i_timezone_region_code       => NULL,
                                                         i_rb_country_key             => NULL, --id_country
                                                         i_rb_regional_classifier_key => NULL,
                                                         i_address1                   => NULL,
                                                         i_address2                   => NULL,
                                                         i_address3                   => NULL,
                                                         i_zip_code                   => NULL,
                                                         i_zip_code_description       => NULL,
                                                         i_fax_number                 => NULL,
                                                         i_phone_number               => NULL,
                                                         i_email                      => NULL,
                                                         i_logo                       => NULL,
                                                         i_web_site                   => NULL,
                                                         i_geo_location_key           => NULL,
                                                         i_flg_external               => NULL,
                                                         i_code_institution           => NULL,
                                                         i_flg_available              => NULL,
                                                         i_rank                       => NULL,
                                                         i_barcode                    => NULL,
                                                         i_ext_code                   => NULL,
                                                         i_dn_flg_status              => NULL,
                                                         i_adress_type                => NULL,
                                                         i_record_status              => 'A',
                                                         i_shortname                  => i_abbreviation,
                                                         i_id_ab_institution_parent   => i_id_parent,
                                                         i_flg_type                   => i_flg_type,
                                                         i_ine_location               => 'N/A',
                                                         i_id_timezone_region         => i_id_tz_region,
                                                         i_contact_det                => NULL,
                                                         o_id_ab_institution          => o_id_institution);
            pk_api_ab_tables.upd_ab_institution(id_ab_institution_in => i_id_institution,
                                                shortname_in         => i_abbreviation,
                                                shortname_nin        => FALSE,
                                                description_in       => i_desc,
                                                description_nin      => FALSE,
                                                address1_in          => i_adress,
                                                address1_nin         => FALSE,
                                                address2_in          => i_location,
                                                address2_nin         => FALSE,
                                                address3_in          => i_geo_state,
                                                address3_nin         => FALSE,
                                                fax_number_in        => i_fax,
                                                fax_number_nin       => FALSE,
                                                zip_code_in          => i_zip_code,
                                                zip_code_nin         => FALSE,
                                                phone_number_in      => i_phone_number,
                                                phone_number_nin     => FALSE,
                                                contact_det_in       => i_contact_det,
                                                contact_det_nin      => FALSE);
        
            g_error := 'UPDATE INST_ATTRIBUTES';
            UPDATE inst_attributes
               SET id_country              = i_country,
                   id_institution          = o_id_institution,
                   social_security_number  = i_tax,
                   email                   = i_email,
                   id_institution_language = i_id_inst_lang
             WHERE id_inst_attributes = i_id_inst_att;
        
            g_error := 'SELECT COUNT(ID_INSTITUTION_LANGUAGE)';
            SELECT COUNT(id_institution_language)
              INTO l_count_inst_lang
              FROM institution_language ia
             WHERE ia.id_institution = o_id_institution;
        
            IF l_count_inst_lang != 0
            THEN
                g_error := 'UPDATE INSTITUTION_LANGUAGE';
                UPDATE institution_language
                   SET id_language = i_pref_lang, adw_last_update = SYSDATE
                 WHERE id_institution = o_id_institution;
            ELSE
                g_error := 'INSERT INTO INSTITUTION_LANGUAGE';
                INSERT INTO institution_language
                    (id_institution_language, id_language, id_institution, flg_available, adw_last_update)
                VALUES
                    (seq_institution_language.nextval, i_pref_lang, o_id_institution, g_flg_avail, SYSDATE);
            END IF;
        
            -- RdSN 2007/08/08
            -- Language update for the users referring to the current institution
            FOR users IN (SELECT su.id_ab_user_info id
                            FROM prof_institution pi, ab_user_info su
                           WHERE id_institution = o_id_institution
                             AND pi.id_professional = su.id_ab_user_info)
            LOOP
                pk_api_ab_tables.upd_ins_into_ab_user_info(i_id_ab_user_info    => users.id,
                                                           i_login              => NULL,
                                                           i_password           => NULL,
                                                           i_import_code        => NULL,
                                                           i_record_status      => g_prof_flg_state_active,
                                                           i_institution_key    => i_id_institution,
                                                           i_flg_is_enable      => g_prof_flg_state_active,
                                                           i_first_name         => NULL,
                                                           i_last_name          => NULL,
                                                           i_full_name          => NULL,
                                                           i_external_system    => NULL,
                                                           i_external_system_id => NULL,
                                                           i_secret_quest       => NULL,
                                                           i_secret_answ        => NULL,
                                                           i_id_language        => i_pref_lang,
                                                           i_flg_temporary      => 'N',
                                                           i_date_creation_tstz => NULL,
                                                           o_id_ab_user_info    => l_professional);
            END LOOP;
        
            -- Update all description of code_tranlsation ( name of institution )             
            FOR r_lang IN c_lang
            LOOP
                pk_translation.insert_into_translation(r_lang.id_language,
                                                       l_code_trl || i_id_institution || '',
                                                       i_desc);
            END LOOP;
        
        END IF;
    
        COMMIT;
        RETURN TRUE;
    
    EXCEPTION
        WHEN my_exception THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_INSTITUTION_DATA',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'SET_INSTITUTION_DATA');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END set_institution_data_nolicense;

    /*****************************************************************************************************************************/

    FUNCTION set_currency_desc
    (
        i_value       IN NUMBER,
        i_id_currency IN currency.id_currency%TYPE
    ) RETURN VARCHAR2 IS
        l_currency_desc     VARCHAR2(60);
        l_decimal_delimiter currency.decimal_delimiter%TYPE;
    BEGIN
        g_error := 'SET CURRENCY_DESC';
        SELECT ltrim(to_char(i_value,
                             c.number_format,
                             'NLS_NUMERIC_CHARACTERS = ''' || c.decimal_delimiter || c.millenarian_delimiter ||
                             ''' NLS_CURRENCY = ''' || c.unit_measure || ''' '),
                     ' '),
               c.decimal_delimiter
          INTO l_currency_desc, l_decimal_delimiter
          FROM currency c
         WHERE c.id_currency = i_id_currency
           AND c.flg_available = g_currency_available;
    
        IF i_value = 0
        THEN
            l_currency_desc := REPLACE(l_currency_desc, l_decimal_delimiter, '0' || l_decimal_delimiter);
        END IF;
        RETURN l_currency_desc;
    EXCEPTION
        WHEN OTHERS THEN
            RETURN NULL;
    END;
    /*******************************************************************************************************/

    /** @headcom
    * Public Function. get_timezone_region_list
    *
    * @param      I_LANG                     Identificação do Idioma
    * @param      O_LIST                     Cursor com a lista de timezones possíveis
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenco - EL
    * @version    0.1
    * @since      2007/08/31
    */
    FUNCTION get_timezone_region_list
    (
        i_lang  IN language.id_language%TYPE,
        o_list  OUT pk_types.cursor_type,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET_TIMEZONE_REGION_LIST CURSOR';
        OPEN o_list FOR
            SELECT tzr.id_timezone_region, tzr.timezone_region
              FROM timezone_region tzr
             ORDER BY tzr.timezone_region;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_list);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_TIMEZONE_REGION_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_timezone_region_list;

    /** @headcom
    * Public Function. Get PROF POSSIBLE LIST
    *
    * @param      I_LANG                     Identificação do Idioma
    * @param      O_LIST                     Cursor com a lista de tarefas possíveis no botão de adicionar no ecra de instituições
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenco - EL
    * @version    0.1
    * @since      2007/08/31
    */
    FUNCTION get_inst_possible_list
    (
        i_lang  IN language.id_language%TYPE,
        o_list  OUT pk_types.cursor_type,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET INSTITUTION POSSIBLE LIST CURSOR';
        OPEN o_list FOR
        
            SELECT val, desc_val
              FROM sys_domain
             WHERE code_domain = 'INSTITUTION_ADD_TASK'
               AND domain_owner = pk_sysdomain.k_default_schema
               AND flg_available = g_flg_available
               AND id_language = i_lang
             ORDER BY rank;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_list);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_INST_POSSIBLE_LIST',
                                              o_error);
        
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_inst_possible_list;

    /*************************************************************************************************/

    FUNCTION get_tax
    (
        i_user     IN profissional,
        i_language IN language.id_language%TYPE,
        o_tax      OUT NUMBER,
        o_error    OUT t_error_out
    ) RETURN BOOLEAN IS
        l_id_location_tax inst_attributes.id_location_tax%TYPE;
        l_tax             NUMBER(6, 3);
    BEGIN
        l_tax   := NULL;
        g_error := 'INST INFO';
        SELECT ia.id_location_tax
          INTO l_id_location_tax
          FROM inst_attributes ia
         WHERE ia.id_institution = i_user.institution;
    
        g_error := 'SET TAX';
        SELECT t.tax
          INTO l_tax
          FROM (SELECT l.tax
                  FROM location_tax l
                 WHERE l.tax IS NOT NULL
                CONNECT BY PRIOR l.id_parent = l.id_location_tax
                 START WITH l.id_location_tax = l_id_location_tax
                 ORDER BY LEVEL) t
         WHERE rownum < 2;
    
        o_tax := l_tax;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_language,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_TAX',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END;

    /** @headcom
    * Public Function. Get PROF POSSIBLE LIST
    *
    * @param      I_LANG                     Identificação do Idioma
    * @param      O_LIST                     Cursor com a lista de tarefas possíveis no botão de adicionar no ecra de instituições
    * @param      O_ERROR                    Erro
    *
    * @return     boolean
    * @author     Eduardo Lourenco - EL
    * @version    0.1
    * @since      2007/08/31
    */
    FUNCTION get_inst_room_task_list
    (
        i_lang  IN language.id_language%TYPE,
        o_list  OUT pk_types.cursor_type,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET INSTITUTION ROOM TASK LIST CURSOR';
        OPEN o_list FOR
        
            SELECT val, desc_val
              FROM sys_domain
             WHERE code_domain = 'INSTITUTION_ROOM_ADD_TASKS'
               AND domain_owner = pk_sysdomain.k_default_schema
               AND flg_available = g_flg_available
               AND id_language = i_lang
             ORDER BY rank DESC;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_types.open_my_cursor(o_list);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_INST_ROOM_TASK_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
    END get_inst_room_task_list;

    FUNCTION get_date_received
    (
        i_lang     IN language.id_language%TYPE,
        i_str_date IN VARCHAR2
    ) RETURN DATE IS
        l_error t_error_out;
    BEGIN
        RETURN to_date(i_str_date, pk_date_utils.g_dateformat);
    EXCEPTION
        WHEN OTHERS THEN
            g_error := 'GET_DATE_RECEIVED';
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_DATE_RECEIVED',
                                              l_error);
            pk_alert_exceptions.reset_error_state;
        
            RETURN NULL;
    END;

    FUNCTION get_date_to_be_sent
    (
        i_lang IN language.id_language%TYPE,
        i_date IN DATE
    ) RETURN VARCHAR2 IS
        l_error t_error_out;
    BEGIN
    
        RETURN to_char(i_date, pk_date_utils.g_dateformat);
    EXCEPTION
        WHEN OTHERS THEN
            g_error := 'GET_DATE_RECEIVED';
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_DATE_TO_BE_SENT',
                                              l_error);
            pk_alert_exceptions.reset_error_state;
        
            RETURN NULL;
    END;

    FUNCTION get_room_list
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN profissional,
        i_id_institutiton IN institution.id_institution%TYPE,
        o_cur             OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET_ROOM_LIST';
        OPEN o_cur FOR
            SELECT r.id_room,
                   nvl(r.desc_room, pk_translation.get_translation(i_lang, r.code_room)) room_name,
                   pk_translation.get_translation(i_lang, d.code_department) service_name,
                   decode((SELECT COUNT(*)
                            FROM room_dep_clin_serv rdcs
                           WHERE rdcs.id_room = r.id_room
                             AND rdcs.id_dep_clin_serv IN
                                 (SELECT dcs.id_dep_clin_serv
                                    FROM dep_clin_serv dcs
                                   WHERE dcs.id_department = d.id_department
                                     AND dcs.flg_available = g_flg_avail)),
                          0,
                          'I',
                          'A') flg_select,
                   r.flg_available,
                   pk_sysdomain.get_domain('ROOM.FLG_AVAILABLE', r.flg_available, i_lang) desc_flg_available
              FROM room r, department d
             WHERE r.id_department = d.id_department
               AND d.id_institution = i_id_institutiton
             ORDER BY desc_flg_available, service_name, room_name;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_cur);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_ROOM_LIST',
                                              o_error);
        
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_room_list;

    FUNCTION get_service_spec_list
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN profissional,
        i_id_institutiton IN institution.id_institution%TYPE,
        i_id_room         IN room.id_room%TYPE,
        o_cur             OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET_SERVICE_SPEC_LIST';
        OPEN o_cur FOR
            SELECT dcs.id_dep_clin_serv id_srv_spec,
                   pk_translation.get_translation(i_lang,
                                                  (SELECT cs.code_clinical_service
                                                     FROM clinical_service cs
                                                    WHERE cs.id_clinical_service = dcs.id_clinical_service
                                                      AND cs.flg_available = g_flg_avail)) spec_name,
                   decode((SELECT COUNT(*)
                            FROM room_dep_clin_serv rdcs
                           WHERE rdcs.id_room = i_id_room
                             AND rdcs.id_dep_clin_serv = dcs.id_dep_clin_serv),
                          0,
                          'I',
                          'A') flg_select
              FROM dep_clin_serv dcs
             WHERE dcs.id_department = (SELECT r.id_department
                                          FROM room r
                                         WHERE r.id_room = i_id_room)
               AND dcs.flg_available = g_flg_avail;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_cur);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_SERVICE_SPEC_LIST',
                                              o_error);
        
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_service_spec_list;

    FUNCTION assign_room_service
    (
        i_lang        IN language.id_language%TYPE,
        i_prof        IN profissional,
        i_id_room     IN table_number,
        i_id_srv_spec IN table_number,
        i_flg_values  IN table_varchar,
        o_error       OUT t_error_out
    ) RETURN BOOLEAN IS
        l_id_room     room.id_room%TYPE;
        l_id_srv_spec dep_clin_serv.id_dep_clin_serv%TYPE;
        l_flg_value   VARCHAR2(1);
    
    BEGIN
        g_error := 'ASSIGN_ROOM_SERVICE';
        FOR i IN 1 .. i_id_room.count
        LOOP
            l_id_room     := i_id_room(i);
            l_id_srv_spec := i_id_srv_spec(i);
            l_flg_value   := i_flg_values(i);
        
            IF l_flg_value = 'Y'
            THEN
                INSERT INTO room_dep_clin_serv
                    (id_room_dep_clin_serv, id_room, id_dep_clin_serv)
                VALUES
                    (seq_room_dep_clin_serv.nextval, l_id_room, l_id_srv_spec);
            ELSIF l_flg_value = 'N'
            THEN
                DELETE FROM room_dep_clin_serv
                 WHERE id_room = l_id_room
                   AND id_dep_clin_serv = l_id_srv_spec;
            END IF;
        
        END LOOP;
        COMMIT;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
            
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang, SQLCODE, SQLERRM, g_error, 'ALERT', 'PK_BACKOFFICE', 'ASSIGN_ROOM_SERVICE');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END assign_room_service;

    FUNCTION get_room
    (
        i_lang    IN language.id_language%TYPE,
        i_prof    IN profissional,
        i_id_room IN room.id_room%TYPE,
        o_cur     OUT pk_types.cursor_type,
        o_error   OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET_ROOM';
        OPEN o_cur FOR
            SELECT r.id_room,
                   nvl(r.desc_room, pk_translation.get_translation(i_lang, r.code_room)) room_name,
                   r.id_department id_service,
                   pk_translation.get_translation(i_lang,
                                                  (SELECT d.code_department
                                                     FROM department d
                                                    WHERE d.id_department = r.id_department)) service_name,
                   concat(decode(r.flg_prof, g_flg_avail, 'P,', ''),
                          concat(decode(r.flg_recovery, g_flg_avail, 'R,', ''),
                                 concat(decode(r.flg_lab, g_flg_avail, 'L,', ''),
                                        concat(decode(r.flg_wait, g_flg_avail, 'W,', ''),
                                               concat(decode(r.flg_wl, g_flg_avail, 'C,', ''),
                                                      decode(r.flg_transp, g_flg_avail, 'T,', '')))))) id_room_type,
                   concat(decode(r.flg_prof,
                                 g_flg_avail,
                                 pk_sysdomain.get_domain('INSTITUTION_ROOM_TYPES', 'P', i_lang) || ',',
                                 ''),
                          concat(decode(r.flg_recovery,
                                        g_flg_avail,
                                        pk_sysdomain.get_domain('INSTITUTION_ROOM_TYPES', 'R', i_lang) || ',',
                                        ''),
                                 concat(decode(r.flg_lab,
                                               g_flg_avail,
                                               pk_sysdomain.get_domain('INSTITUTION_ROOM_TYPES', 'L', i_lang) || ',',
                                               ''),
                                        concat(decode(r.flg_wait,
                                                      g_flg_avail,
                                                      pk_sysdomain.get_domain('INSTITUTION_ROOM_TYPES', 'W', i_lang) || ',',
                                                      ''),
                                               concat(decode(r.flg_wl,
                                                             g_flg_avail,
                                                             pk_sysdomain.get_domain('INSTITUTION_ROOM_TYPES', 'C', i_lang) || ',',
                                                             ''),
                                                      decode(r.flg_transp,
                                                             g_flg_avail,
                                                             pk_sysdomain.get_domain('INSTITUTION_ROOM_TYPES', 'T', i_lang) || ',',
                                                             '')))))) room_type_name,
                   r.flg_available,
                   pk_sysdomain.get_domain('ROOM.FLG_AVAILABLE', r.flg_available, i_lang) desc_flg_available,
                   pk_date_utils.date_hour_chr_extend_tsz(i_lang, r.adw_last_update, i_prof) upd_date
              FROM room r
             WHERE r.id_room = i_id_room;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_cur);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_ROOM',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
    END get_room;

    FUNCTION get_inst_service_list
    (
        i_lang            IN language.id_language%TYPE,
        i_id_institutiton IN institution.id_institution%TYPE,
        o_cur             OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET_INST_SERVICE_LIST';
        OPEN o_cur FOR
            SELECT d.id_department id_service, pk_translation.get_translation(i_lang, d.code_department) service_name
              FROM department d
             WHERE d.id_institution = i_id_institutiton
               AND d.flg_available = pk_alert_constant.g_available
             ORDER BY service_name;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_cur);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_INST_SERVICE_LIST',
                                              o_error);
            RETURN FALSE;
        
    END get_inst_service_list;

    FUNCTION get_inst_room_type_list
    (
        i_lang  IN language.id_language%TYPE,
        o_cur   OUT pk_types.cursor_type,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        g_error := 'GET_INST_ROOM_TYPE_LIST';
        OPEN o_cur FOR
            SELECT val, desc_val
              FROM sys_domain
             WHERE code_domain = 'INSTITUTION_ROOM_TYPES'
               AND domain_owner = pk_sysdomain.k_default_schema
               AND flg_available = g_flg_available
               AND id_language = i_lang
             ORDER BY desc_val;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_types.open_my_cursor(o_cur);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_INST_ROOM_TYPE_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
    END get_inst_room_type_list;

    --******************************************
    -- Set_room changed from rui gomes to code by amanda
    --
    FUNCTION set_room
    (
        i_lang              IN language.id_language%TYPE,
        i_prof              IN profissional,
        i_id_room           IN room.id_room%TYPE,
        i_room_name         IN VARCHAR2,
        i_id_service        IN department.id_department%TYPE,
        i_flg_types         IN table_varchar,
        i_flg_available     IN room.flg_available%TYPE,
        i_floors_department IN floors_department.id_floors_department%TYPE,
        o_id_room           OUT room.id_room%TYPE,
        o_error             OUT t_error_out
    ) RETURN BOOLEAN IS
        l_ret BOOLEAN;
    BEGIN
    
        l_ret := set_room(i_lang              => i_lang -- IN language.id_language%TYPE,
                         ,
                          i_prof              => i_prof -- IN profissional,
                         ,
                          i_id_room           => i_id_room -- IN room.id_room%TYPE,
                         ,
                          i_room_name         => i_room_name -- IN VARCHAR2,
                         ,
                          i_abbreviation      => NULL -- IN VARCHAR2,
                         ,
                          i_category          => i_flg_types -- IN table_varchar,
                         ,
                          i_room_type         => NULL -- IN room_type.id_room_type%TYPE,
                         ,
                          i_room_service      => i_id_service -- IN room.id_department%TYPE,
                         ,
                          i_flg_selected_spec => NULL -- IN room.flg_selected_specialties%TYPE,
                         ,
                          i_floors_department => i_floors_department -- IN floors_department.id_floors_department%TYPE,
                         ,
                          i_state             => NULL -- IN room.flg_available%TYPE,
                         ,
                          i_capacity          => NULL -- IN room.capacity%TYPE,
                         ,
                          i_rank              => NULL -- IN room.rank%TYPE,
                         ,
                          o_id_room           => o_id_room -- OUT room.id_room%TYPE,
                         ,
                          o_error             => o_error -- OUT t_error_out
                          );
    
        IF l_ret
        THEN
            COMMIT;
        END IF;
    
        RETURN l_ret;
    
    END set_room;

    FUNCTION delete_room
    (
        i_lang    IN language.id_language%TYPE,
        i_prof    IN profissional,
        i_id_room IN room.id_room%TYPE,
        o_error   OUT t_error_out
    ) RETURN BOOLEAN IS
    
        e_room_child_remaining EXCEPTION;
        PRAGMA EXCEPTION_INIT(e_room_child_remaining, -2292);
        l_error VARCHAR2(4000);
    BEGIN
    
        g_error := 'DELETE_ROOM';
    
        DELETE FROM room
         WHERE id_room = i_id_room;
    
        COMMIT;
        RETURN TRUE;
    EXCEPTION
        WHEN e_room_child_remaining THEN
        
            l_error := pk_message.get_message(i_lang, 'COMMON_M001');
        
            pk_alert_exceptions.process_error(i_lang,
                                              'COMMON_M001',
                                              l_error,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'DELETE_ROOM',
                                              'U',
                                              o_error);
        
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'DELETE_ROOM',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END delete_room;

    FUNCTION set_inst_and_admin
    (
        i_lang               IN language.id_language%TYPE,
        i_id_institution     IN institution.id_institution%TYPE,
        i_clues              IN inst_attributes.clues%TYPE,
        i_id_inst_att        IN inst_attributes.id_inst_attributes%TYPE,
        i_id_inst_lang       IN institution_language.id_institution_language%TYPE,
        i_desc               IN VARCHAR2,
        i_id_parent          IN institution.id_parent%TYPE,
        i_flg_type           IN institution.flg_type%TYPE,
        i_tax                IN inst_attributes.social_security_number%TYPE,
        i_abbreviation       IN institution.abbreviation%TYPE,
        i_pref_lang          IN institution_language.id_language%TYPE,
        i_currency           IN inst_attributes.id_currency%TYPE,
        i_phone_number       IN institution.phone_number%TYPE,
        i_fax                IN institution.fax_number%TYPE,
        i_email              IN inst_attributes.email%TYPE,
        i_health_license     IN inst_attributes.health_license%TYPE,
        i_address            IN institution.address%TYPE,
        i_location           IN institution.location%TYPE,
        i_geo_state          IN institution.district%TYPE,
        i_flg_street_type    IN inst_attributes.flg_street_type%TYPE,
        i_street_name        IN inst_attributes.street_name%TYPE,
        i_outdoor_number     IN inst_attributes.outdoor_number%TYPE,
        i_indoor_number      IN inst_attributes.indoor_number%TYPE,
        i_id_settlement_type IN inst_attributes.id_settlement_type%TYPE,
        i_id_settlement_name IN inst_attributes.id_settlement_name%TYPE,
        i_id_entity          IN inst_attributes.id_entity%TYPE,
        i_id_municip         IN inst_attributes.id_municip%TYPE,
        i_id_localidad       IN inst_attributes.id_localidad%TYPE,
        i_id_postal_code     IN inst_attributes.id_postal_code%TYPE,
        i_zip_code           IN institution.zip_code%TYPE,
        i_country            IN inst_attributes.id_country%TYPE,
        i_jurisdiction       IN inst_attributes.jurisdiction%TYPE,
        i_location_tax       IN inst_attributes.id_location_tax%TYPE,
        i_lic_model          IN inst_attributes.license_model%TYPE,
        i_pay_sched          IN inst_attributes.payment_schedule%TYPE,
        i_pay_opt            IN inst_attributes.payment_options%TYPE,
        i_flg_available      IN institution.flg_available%TYPE,
        i_id_tz_region       IN institution.id_timezone_region%TYPE,
        i_id_market          IN market.id_market%TYPE,
        i_contact_det        IN ab_institution.contact_detail%TYPE,
        
        i_software    IN software.id_software%TYPE,
        i_id_prof     IN professional.id_professional%TYPE,
        i_id_inst     IN institution.id_institution%TYPE,
        i_name        IN professional.name%TYPE,
        i_title       IN professional.title%TYPE,
        i_nick_name   IN professional.nick_name%TYPE,
        i_gender      IN professional.gender%TYPE,
        i_dt_birth    IN VARCHAR2,
        i_prof_email  IN professional.email%TYPE,
        i_work_phone  IN professional.num_contact%TYPE,
        i_cell_phone  IN professional.cell_phone%TYPE,
        i_prof_fax    IN professional.fax%TYPE,
        i_first_name  IN professional.first_name%TYPE,
        i_parent_name IN professional.parent_name%TYPE,
        i_middle_name IN professional.middle_name%TYPE,
        i_last_name   IN professional.last_name%TYPE,
        i_id_cat      IN category.id_category%TYPE,
        
        o_id_institution     OUT institution.id_institution%TYPE,
        o_id_inst_attributes OUT inst_attributes.id_inst_attributes%TYPE,
        o_id_inst_lang       OUT institution_language.id_institution_language%TYPE,
        o_id_prof            OUT professional.id_professional%TYPE,
        o_error              OUT t_error_out
    ) RETURN BOOLEAN IS
        l_error_message t_error_out;
        my_exception EXCEPTION;
    BEGIN
        g_error := 'IF SET_INST_AND_ADMIN';
        IF set_institution_data(i_lang               => i_lang,
                                i_id_institution     => i_id_institution,
                                i_clues              => i_clues,
                                i_id_inst_att        => i_id_inst_att,
                                i_id_inst_lang       => i_id_inst_lang,
                                i_desc               => i_desc,
                                i_id_parent          => i_id_parent,
                                i_flg_type           => i_flg_type,
                                i_tax                => i_tax,
                                i_abbreviation       => i_abbreviation,
                                i_pref_lang          => i_pref_lang,
                                i_currency           => i_currency,
                                i_phone_number       => i_phone_number,
                                i_fax                => i_fax,
                                i_email              => i_email,
                                i_health_license     => i_health_license,
                                i_adress             => i_address,
                                i_location           => i_location,
                                i_geo_state          => i_geo_state,
                                i_flg_street_type    => i_flg_street_type,
                                i_street_name        => i_street_name,
                                i_outdoor_number     => i_outdoor_number,
                                i_indoor_number      => i_indoor_number,
                                i_id_settlement_type => i_id_settlement_type,
                                i_id_settlement_name => i_id_settlement_name,
                                i_id_entity          => i_id_entity,
                                i_id_municip         => i_id_municip,
                                i_id_localidad       => i_id_localidad,
                                i_id_postal_code     => i_id_postal_code,
                                i_zip_code           => i_zip_code,
                                i_country            => i_country,
                                i_jurisdiction       => i_jurisdiction,
                                i_location_tax       => i_location_tax,
                                i_lic_model          => i_lic_model,
                                i_pay_sched          => i_pay_sched,
                                i_pay_opt            => i_pay_opt,
                                i_flg_available      => i_flg_available,
                                i_id_tz_region       => i_id_tz_region,
                                i_id_market          => i_id_market,
                                i_contact_det        => i_contact_det,
                                i_commit_at_end      => FALSE,
                                i_website            => NULL,
                                o_id_institution     => o_id_institution,
                                o_id_inst_attributes => o_id_inst_attributes,
                                o_id_inst_lang       => o_id_inst_lang,
                                o_error              => o_error)
           AND set_institution_administrator(i_lang          => i_lang,
                                             i_software      => i_software,
                                             i_id_prof       => i_id_prof,
                                             i_id_inst       => nvl(o_id_institution, i_id_inst),
                                             i_name          => i_name,
                                             i_title         => i_title,
                                             i_nick_name     => i_nick_name,
                                             i_gender        => i_gender,
                                             i_dt_birth      => i_dt_birth,
                                             i_email         => i_prof_email,
                                             i_work_phone    => i_work_phone,
                                             i_cell_phone    => i_cell_phone,
                                             i_fax           => i_prof_fax,
                                             i_first_name    => i_first_name,
                                             i_parent_name   => i_parent_name,
                                             i_middle_name   => i_middle_name,
                                             i_last_name     => i_last_name,
                                             i_id_cat        => i_id_cat,
                                             i_commit_at_end => FALSE,
                                             o_id_prof       => o_id_prof,
                                             o_error         => o_error)
        THEN
            COMMIT;
            RETURN TRUE;
        ELSE
        
            RAISE my_exception;
        
        END IF;
    EXCEPTION
        WHEN my_exception THEN
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_INST_AND_ADMIN',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END set_inst_and_admin;

    FUNCTION set_prof_and_license
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        i_id_prof        IN professional.id_professional%TYPE,
        i_title          IN professional.title%TYPE,
        i_first_name     IN professional.first_name%TYPE,
        i_middle_name    IN professional.middle_name%TYPE,
        i_last_name      IN professional.last_name%TYPE,
        i_nick_name      IN professional.nick_name%TYPE,
        i_initials       IN professional.initials%TYPE,
        i_dt_birth       IN VARCHAR2,
        i_gender         IN professional.gender%TYPE,
        i_marital_status IN professional.marital_status%TYPE,
        i_id_category    IN category.id_category%TYPE,
        i_id_speciality  IN professional.id_speciality%TYPE,
        i_num_order      IN professional.num_order%TYPE,
        i_upin           IN professional.upin%TYPE,
        i_dea            IN professional.dea%TYPE,
        i_id_cat_surgery IN category.id_category%TYPE,
        i_num_mecan      IN prof_institution.num_mecan%TYPE,
        i_id_lang        IN prof_preferences.id_language%TYPE,
        i_flg_state      IN prof_institution.flg_state%TYPE,
        i_address        IN professional.address%TYPE,
        i_city           IN professional.city%TYPE,
        i_district       IN professional.district%TYPE,
        i_zip_code       IN professional.zip_code%TYPE,
        i_id_country     IN professional.id_country%TYPE,
        i_work_phone     IN professional.work_phone%TYPE,
        i_num_contact    IN professional.num_contact%TYPE,
        i_cell_phone     IN professional.cell_phone%TYPE,
        i_fax            IN professional.fax%TYPE,
        i_email          IN professional.email%TYPE,
        i_id_license     IN NUMBER,
        o_id_prof        OUT professional.id_professional%TYPE,
        o_error          OUT t_error_out
        
    ) RETURN BOOLEAN IS
        l_error_message t_error_out;
        my_exception EXCEPTION;
    BEGIN
        g_error := 'IF NOT SET_PROF_AND_LICENSE';
        IF NOT set_professional(i_lang                    => i_lang,
                                i_id_institution          => i_id_institution,
                                i_id_prof                 => i_id_prof,
                                i_title                   => i_title,
                                i_first_name              => i_first_name,
                                i_middle_name             => i_middle_name,
                                i_last_name               => i_last_name,
                                i_nick_name               => i_nick_name,
                                i_initials                => i_initials,
                                i_dt_birth                => i_dt_birth,
                                i_gender                  => i_gender,
                                i_marital_status          => i_marital_status,
                                i_id_category             => i_id_category,
                                i_id_speciality           => i_id_speciality,
                                i_id_scholarship          => NULL,
                                i_num_order               => i_num_order,
                                i_upin                    => i_upin,
                                i_dea                     => i_dea,
                                i_id_cat_surgery          => i_id_cat_surgery,
                                i_num_mecan               => i_num_mecan,
                                i_id_lang                 => i_id_lang,
                                i_flg_state               => i_flg_state,
                                i_address                 => i_address,
                                i_city                    => i_city,
                                i_district                => i_district,
                                i_zip_code                => i_zip_code,
                                i_id_country              => i_id_country,
                                i_work_phone              => i_work_phone,
                                i_num_contact             => i_num_contact,
                                i_cell_phone              => i_cell_phone,
                                i_fax                     => i_fax,
                                i_email                   => i_email,
                                i_commit_at_end           => FALSE,
                                i_id_road                 => NULL,
                                i_entity                  => NULL,
                                i_jurisdiction            => NULL,
                                i_municip                 => NULL,
                                i_localidad               => NULL,
                                i_id_postal_code_rb       => NULL,
                                i_parent_name             => NULL,
                                i_first_name_sa           => NULL,
                                i_parent_name_sa          => NULL,
                                i_middle_name_sa          => NULL,
                                i_last_name_sa            => NULL,
                                i_agrupacion              => NULL,
                                i_doc_ident_type          => NULL,
                                i_doc_ident_num           => NULL,
                                i_doc_ident_val           => NULL,
                                i_tin                     => NULL,
                                i_clinical_name           => NULL,
                                i_prof_spec_id            => NULL,
                                i_prof_spec_ballot        => NULL,
                                i_prof_spec_id_university => NULL,
                                i_agrupacion_instit_id    => NULL,
                                o_id_prof                 => o_id_prof,
                                o_error                   => o_error)
        THEN
            RAISE my_exception;
        ELSIF NOT set_user_license(i_lang            => i_lang,
                                   i_id_institution  => i_id_institution,
                                   i_id_professional => o_id_prof,
                                   i_id_license      => i_id_license,
                                   i_commit_at_end   => FALSE,
                                   o_error           => o_error)
        THEN
            RAISE my_exception;
        END IF;
    
        COMMIT;
        RETURN TRUE;
    
    EXCEPTION
        WHEN my_exception THEN
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_PROF_AND_LICENSE',
                                              o_error);
            pk_utils.undo_changes;
        
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END set_prof_and_license;

    FUNCTION set_tpl_list_and_prof_func_all
    (
        i_lang             IN language.id_language%TYPE,
        i_id_prof          IN professional.id_professional%TYPE,
        i_inst             IN table_number,
        i_soft             IN table_number,
        i_id_dep_clin_serv IN dep_clin_serv.id_dep_clin_serv%TYPE,
        i_templ            IN table_number,
        
        i_prof         IN profissional,
        i_func         IN table_number,
        i_change       IN table_varchar,
        o_id_prof_func OUT table_number,
        o_error        OUT t_error_out
        
    ) RETURN BOOLEAN IS
        l_error t_error_out;
        my_exception EXCEPTION;
    BEGIN
        g_error := 'SET_TPL_LIST_AND_PROF_FUNC_ALL';
        IF NOT set_template_list(i_lang             => i_lang,
                                 i_id_prof          => i_id_prof,
                                 i_inst             => i_inst,
                                 i_soft             => i_soft,
                                 i_id_dep_clin_serv => i_id_dep_clin_serv,
                                 i_templ            => i_templ,
                                 i_commit_at_end    => FALSE,
                                 o_error            => l_error)
        THEN
            RAISE my_exception;
        
        ELSIF NOT set_prof_func_all(i_lang            => i_lang,
                                    i_prof            => i_prof,
                                    i_id_professional => i_id_prof,
                                    i_institution     => i_inst,
                                    i_func            => i_func,
                                    i_change          => i_change,
                                    i_commit_at_end   => FALSE,
                                    o_id_prof_func    => o_id_prof_func,
                                    o_error           => l_error)
        THEN
        
            RAISE my_exception;
        END IF;
    
        COMMIT;
        RETURN TRUE;
    
    EXCEPTION
        WHEN my_exception THEN
            pk_utils.undo_changes;
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error || ' / ' || l_error.err_desc,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_TPL_LIST_AND_PROF_FUNC_ALL',
                                              o_error);
        
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_TPL_LIST_AND_PROF_FUNC_ALL',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
    END set_tpl_list_and_prof_func_all;

    FUNCTION get_summary_gen_inf
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN profissional,
        i_id_institution IN institution.id_institution%TYPE,
        o_cur_t1         OUT pk_types.cursor_type,
        o_cur_t2         OUT pk_types.cursor_type,
        o_cur_t3         OUT pk_types.cursor_type,
        o_cur_d1         OUT pk_types.cursor_type,
        o_cur_d2         OUT pk_types.cursor_type,
        o_cur_d3         OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
        l_profile_template profile_template.id_profile_template%TYPE;
        -- new fields for uSA market only
        l_market        market.id_market%TYPE;
        l_software_list table_number := table_number();
        l_cms_ehr_list  table_varchar := table_varchar();
    
        l_temp_msg_list table_varchar := table_varchar();
        l_ccn_id        VARCHAR2(200);
        l_ret           BOOLEAN;
        l_error         t_error_out;
        l_desc_gen      VARCHAR2(1000);
    
    BEGIN
        g_error := 'SELECT PPT.ID_PROFILE_TEMPLATE FROM PROF_PROFILE_TEMPLATE PPT';
        SELECT ppt.id_profile_template
          INTO l_profile_template
          FROM prof_profile_template ppt
         WHERE ppt.id_software = i_prof.software
           AND ppt.id_professional = i_prof.id
           AND ppt.id_institution = i_prof.institution;
    
        g_error  := 'GET INSTITUTION MARKET';
        l_market := pk_utils.get_institution_market(i_lang, i_id_institution);
        IF l_market = 2
        THEN
            g_error := 'GET INSTITUTION SOFTWARES';
            SELECT si.id_software
              BULK COLLECT
              INTO l_software_list
              FROM software_institution si
             WHERE si.id_institution = i_id_institution;
            g_error  := 'GET INSTITUTION CCN ID';
            l_ccn_id := get_inst_account_val(i_lang, i_id_institution, 87, l_error);
            g_error  := 'GET CMS EHR IDENTIFIERS';
            l_ret    := pk_backoffice_cda.get_cms_ehr_id(i_lang,
                                                         i_id_institution,
                                                         l_software_list,
                                                         l_cms_ehr_list,
                                                         l_error);
            g_error  := 'BUILD MESSAGE FOR CMS EHR IDENTIFIERS';
            SELECT s.name || ': ' || cms_ehr.column_value
              BULK COLLECT
              INTO l_temp_msg_list
              FROM (SELECT rownum idx, column_value
                      FROM TABLE(l_software_list)) sw,
                   (SELECT rownum idx, column_value
                      FROM TABLE(l_cms_ehr_list)) cms_ehr,
                   software s
             WHERE cms_ehr.idx = sw.idx
               AND s.id_software = sw.column_value;
        
            l_desc_gen := pk_utils.concat_table(l_temp_msg_list, '; ');
            g_error    := 'GET_TITTLES1';
            OPEN o_cur_t1 FOR
                SELECT pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T012') c1,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T013') c2,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T004') c3,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T019') c4,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T052') c5,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T053') c6,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T054') c7,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T010') c8,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T055') c9,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T056') c10,
                       'CCN_ID' c11,
                       'CMS_ID' c12,
                       pk_message.get_message(i_lang, 'COMMON_M041') c13
                  FROM dual;
        
            g_error := 'GET_TITTLES2';
            OPEN o_cur_t2 FOR
                SELECT pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T025') c11,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T008') c12,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T057') c13,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T058') c14,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T059') c15,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_T284') c14,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_T925') c15
                  FROM dual;
        
            g_error := 'GET_DATA1';
            OPEN o_cur_d1 FOR
            
                SELECT '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T012') || '</b>: ' ||
                       pk_translation.get_translation(i_lang, i.code_institution) name,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T013') || '</b>: ' ||
                       pk_sysdomain.get_domain('AB_INSTITUTION.GROUP', decode(i.id_parent, NULL, 'M', 'A'), i_lang) facility_group,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T004') || '</b>: ' ||
                       pk_sysdomain.get_domain('AB_INSTITUTION.FLG_TYPE', i.flg_type, i_lang) facility_type,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T019') || '</b>: ' ||
                       ia.social_security_number social_security_number,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T052') || '</b>: ' ||
                       i.abbreviation abbreviation,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T053') || '</b>: ' ||
                       pk_backoffice.get_institution_language(i_lang, i.id_institution) LANGUAGE,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T054') || '</b>: ' ||
                       pk_translation.get_translation(i_lang, c.code_currency) currency,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T010') || '</b>: ' ||
                       i.phone_number phone_number,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T055') || '</b>: ' ||
                       i.fax_number fax_number,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T056') || '</b>: ' ||
                       ia.email email,
                       '<b>' || 'CMS Certification Number (CCN)' || '</b>: ' || l_ccn_id ccn_id,
                       '<b>' || 'CMS EHR Certification Number' || '</b>: ' || l_desc_gen cms_id,
                       '<b>' || pk_message.get_message(i_lang, 'COMMON_M041') || '</b>: ' || i.contact_detail contact_detail
                  FROM institution i
                  LEFT JOIN inst_attributes ia
                    ON (i.id_institution = ia.id_institution AND ia.flg_available = g_flg_avail)
                  LEFT JOIN currency c
                    ON (c.id_currency = ia.id_currency AND c.flg_available = g_flg_avail)
                 WHERE i.id_institution = i_id_institution;
        
            g_error := 'GET_DATA2';
            OPEN o_cur_d2 FOR
                SELECT '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T025') || '</b>: ' ||
                       i.address address,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T008') || '</b>: ' ||
                       i.location location,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T057') || '</b>: ' ||
                       i.district district,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T058') || '</b>: ' ||
                       i.zip_code zip_code,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T059') || '</b>: ' ||
                       pk_translation.get_translation(i_lang, c.code_country) country,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_T284') || '</b>: ' || i.county county,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_T925') || '</b>: ' ||
                       i.address_other_name address_other_name
                  FROM institution i
                  LEFT JOIN inst_attributes ia
                    ON (i.id_institution = ia.id_institution AND ia.flg_available = g_flg_avail)
                  LEFT JOIN country c
                    ON (c.id_country = ia.id_country AND c.flg_available = g_flg_avail)
                 WHERE i.id_institution = i_id_institution;
        ELSIF l_market = 16
        THEN
        
            g_error := 'GET_TITTLES1';
            OPEN o_cur_t1 FOR
                SELECT pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T012') c1,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T089') c2,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T013') c3,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T004') c4,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T019') c5,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T052') c6,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T053') c7,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T054') c8,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T010') c9,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T055') c10,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T056') c11,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T090') c12,
                       pk_message.get_message(i_lang, 'COMMON_M041') c13
                  FROM dual;
            g_error := 'GET_TITTLES2';
            OPEN o_cur_t2 FOR
                SELECT pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T025') c11,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T008') c12,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T057') c13,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T092') c14,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T093') c15,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T094') c16,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T095') c17,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T096') c18,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T097') c19,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T058') c20,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T059') c21,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T091') c22
                  FROM dual;
        
            g_error := 'GET_DATA1';
            OPEN o_cur_d1 FOR
            
                SELECT '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T012') || '</b>: ' ||
                       pk_translation.get_translation(i_lang, i.code_institution) name,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T089') || '</b>: ' ||
                       ia.clues clues,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T013') || '</b>: ' ||
                       pk_sysdomain.get_domain('AB_INSTITUTION.GROUP', decode(i.id_parent, NULL, 'M', 'A'), i_lang) facility_group,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T004') || '</b>: ' ||
                       pk_sysdomain.get_domain('AB_INSTITUTION.FLG_TYPE', i.flg_type, i_lang) facility_type,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T019') || '</b>: ' ||
                       ia.social_security_number social_security_number,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T052') || '</b>: ' ||
                       i.abbreviation abbreviation,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T053') || '</b>: ' ||
                       pk_backoffice.get_institution_language(i_lang, i.id_institution) LANGUAGE,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T054') || '</b>: ' ||
                       pk_translation.get_translation(i_lang, c.code_currency) currency,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T010') || '</b>: ' ||
                       i.phone_number phone_number,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T055') || '</b>: ' ||
                       i.fax_number fax_number,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T056') || '</b>: ' ||
                       ia.email email,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T090') || '</b>: ' ||
                       ia.health_license health_license,
                       '<b>' || pk_message.get_message(i_lang, 'COMMON_M041') || '</b>: ' || i.contact_detail contact_detail
                  FROM institution i
                  LEFT JOIN inst_attributes ia
                    ON (i.id_institution = ia.id_institution AND ia.flg_available = g_flg_avail)
                  LEFT JOIN currency c
                    ON (c.id_currency = ia.id_currency AND c.flg_available = g_flg_avail)
                 WHERE i.id_institution = i_id_institution;
        
            g_error := 'GET_DATA2';
            OPEN o_cur_d2 FOR
                SELECT '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T025') || '</b>: ' ||
                       i.address address,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T008') || '</b>: ' ||
                       i.location location,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T057') || '</b>: ' ||
                       i.district district,
                       
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T092') || '</b>: ' ||
                       pk_sysdomain.get_domain(i_code_dom => 'CONTACT_ADDRESS_MX.ROAD_TYPE',
                                               i_val      => ia.flg_street_type,
                                               i_lang     => i_lang) street_type,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T093') || '</b>: ' ||
                       ia.street_name street_name,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T094') || '</b>: ' ||
                       ia.outdoor_number outdoor_number,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T095') || '</b>: ' ||
                       ia.indoor_number indoor_number,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T096') || '</b>: ' ||
                       pk_adt.get_settlement_type_desc(i_lang               => i_lang,
                                                       i_prof               => NULL,
                                                       i_id_settlement_type => ia.id_settlement_type) settlement_type,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T097') || '</b>: ' ||
                       pk_adt.get_settlement_desc(i_lang               => i_lang,
                                                  i_prof               => NULL,
                                                  i_id_settlement      => ia.id_settlement_name,
                                                  i_id_settlement_type => ia.id_settlement_type) settlement_name,
                       '<b>' || pk_message.get_message(i_lang, 'COMMON_M133') || '</b>: ' ||
                       (SELECT pk_translation.get_translation(i_lang      => i_lang,
                                                              i_code_mess => rb.code_rb_regional_classifier)
                          FROM rb_regional_classifier rb
                         WHERE rb.id_rb_regional_classifier = ia.id_entity) desc_entity,
                       '<b>' || pk_message.get_message(i_lang, 'REP_ID_PATIENT_MUNICIPALITY') || '</b>: ' ||
                       (SELECT pk_translation.get_translation(i_lang      => i_lang,
                                                              i_code_mess => rb.code_rb_regional_classifier)
                          FROM rb_regional_classifier rb
                         WHERE rb.id_rb_regional_classifier = ia.id_municip) desc_municip,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T008') || '</b>: ' ||
                       (SELECT pk_translation.get_translation(i_lang      => i_lang,
                                                              i_code_mess => rb.code_rb_regional_classifier)
                          FROM rb_regional_classifier rb
                         WHERE rb.id_rb_regional_classifier = ia.id_localidad) desc_localidad,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T028') || '</b>: ' ||
                       (SELECT pk_translation.get_translation(i_lang      => i_lang,
                                                              i_code_mess => rb.code_rb_regional_classifier)
                          FROM rb_regional_classifier rb
                         WHERE rb.id_rb_regional_classifier = ia.id_postal_code) desc_postal_code,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T058') || '</b>: ' ||
                       i.zip_code zip_code,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T059') || '</b>: ' ||
                       pk_translation.get_translation(i_lang, c.code_country) country,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T091') || '</b>: ' ||
                       (SELECT pk_translation.get_translation(i_lang      => i_lang,
                                                              i_code_mess => rb.code_rb_regional_classifier)
                          FROM rb_regional_classifier rb
                         WHERE rb.id_rb_regional_classifier = ia.jurisdiction) desc_jurisdiction
                  FROM institution i
                  LEFT JOIN inst_attributes ia
                    ON (i.id_institution = ia.id_institution AND ia.flg_available = g_flg_avail)
                  LEFT JOIN country c
                    ON (c.id_country = ia.id_country AND c.flg_available = g_flg_avail)
                 WHERE i.id_institution = i_id_institution;
        
        ELSE
            g_error := 'GET_TITTLES1';
            OPEN o_cur_t1 FOR
                SELECT pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T012') c1,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T013') c2,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T004') c3,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T019') c4,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T052') c5,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T053') c6,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T054') c7,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T010') c8,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T055') c9,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T056') c10,
                       pk_message.get_message(i_lang, 'COMMON_M041') c11
                  FROM dual;
            g_error := 'GET_TITTLES2';
            OPEN o_cur_t2 FOR
                SELECT pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T025') c11,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T008') c12,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T057') c13,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T058') c14,
                       pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T059') c15
                  FROM dual;
        
            g_error := 'GET_DATA1';
            OPEN o_cur_d1 FOR
            
                SELECT '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T012') || '</b>: ' ||
                       pk_translation.get_translation(i_lang, i.code_institution) name,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T013') || '</b>: ' ||
                       pk_sysdomain.get_domain('AB_INSTITUTION.GROUP', decode(i.id_parent, NULL, 'M', 'A'), i_lang) facility_group,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T004') || '</b>: ' ||
                       pk_sysdomain.get_domain('AB_INSTITUTION.FLG_TYPE', i.flg_type, i_lang) facility_type,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T019') || '</b>: ' ||
                       ia.social_security_number social_security_number,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T052') || '</b>: ' ||
                       i.abbreviation abbreviation,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T053') || '</b>: ' ||
                       pk_backoffice.get_institution_language(i_lang, i.id_institution) LANGUAGE,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T054') || '</b>: ' ||
                       pk_translation.get_translation(i_lang, c.code_currency) currency,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T010') || '</b>: ' ||
                       i.phone_number phone_number,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T055') || '</b>: ' ||
                       i.fax_number fax_number,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T056') || '</b>: ' ||
                       ia.email email,
                       '<b>' || pk_message.get_message(i_lang, 'COMMON_M041') || '</b>: ' || i.contact_detail contact_detail
                  FROM institution i
                  LEFT JOIN inst_attributes ia
                    ON (i.id_institution = ia.id_institution AND ia.flg_available = g_flg_avail)
                  LEFT JOIN currency c
                    ON (c.id_currency = ia.id_currency AND c.flg_available = g_flg_avail)
                 WHERE i.id_institution = i_id_institution;
        
            g_error := 'GET_DATA2';
            OPEN o_cur_d2 FOR
                SELECT '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T025') || '</b>: ' ||
                       i.address address,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T008') || '</b>: ' ||
                       i.location location,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T057') || '</b>: ' ||
                       i.district district,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T058') || '</b>: ' ||
                       i.zip_code zip_code,
                       '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T059') || '</b>: ' ||
                       pk_translation.get_translation(i_lang, c.code_country) country
                  FROM institution i
                  LEFT JOIN inst_attributes ia
                    ON (i.id_institution = ia.id_institution AND ia.flg_available = g_flg_avail)
                  LEFT JOIN country c
                    ON (c.id_country = ia.id_country AND c.flg_available = g_flg_avail)
                 WHERE i.id_institution = i_id_institution;
        END IF;
    
        g_error := 'GET_TITTLES3';
        OPEN o_cur_t3 FOR
            SELECT pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T039') title,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T040') FIRST,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T041') middle,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T042') LAST,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T040') show_name,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T042') desc_job_tittle,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T050') desc_gender,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T082') birth_date,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T109') email,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T110') phone,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T111') cellphone,
                   pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T112') fax
              FROM dual;
    
        g_error := 'GET_DATA3';
        OPEN o_cur_d3 FOR
            SELECT '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T039') || '</b>: ' ||
                   get_prof_title_desc(i_lang, p.title) desc_title,
                   '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T040') || '</b>: ' ||
                   p.first_name first_name,
                   '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T041') || '</b>: ' ||
                   p.middle_name middle_name,
                   '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T042') || '</b>: ' ||
                   p.last_name last_name,
                   '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T040') || '</b>: ' || p.nick_name nick_name,
                   '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T042') || '</b>: ' ||
                   pk_translation.get_translation(i_lang, c.code_category) desc_job_title,
                   '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T050') || '</b>: ' ||
                   pk_sysdomain.get_domain('PROFESSIONAL.GENDER', p.gender, i_lang) desc_gender,
                   '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T082') || '</b>: ' ||
                   pk_date_utils.date_chr_extend(i_lang, p.dt_birth, profissional(1000, 19, 26)) desc_dt_birth,
                   '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T109') || '</b>: ' || p.email email,
                   '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T110') || '</b>: ' || p.work_phone work_phone,
                   '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T111') || '</b>: ' || p.cell_phone cell_phone,
                   '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_IDENT_T112') || '</b>: ' || p.fax fax
              FROM institution i
             INNER JOIN prof_profile_template ppt
                ON (ppt.id_institution = i.id_institution)
             INNER JOIN professional p
                ON (p.id_professional = ppt.id_professional)
              JOIN prof_cat pc
                ON (pc.id_professional = p.id_professional AND pc.id_institution = i.id_institution)
              JOIN category c
                ON (c.id_category = pc.id_category AND c.flg_available = g_flg_avail)
             WHERE i.id_institution = i_id_institution
               AND ppt.id_profile_template = l_profile_template
               AND nvl(p.flg_prof_test, pk_alert_constant.get_no) = pk_alert_constant.get_no;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_types.open_my_cursor(o_cur_t1);
            pk_types.open_my_cursor(o_cur_t2);
            pk_types.open_my_cursor(o_cur_t3);
            pk_types.open_my_cursor(o_cur_d1);
            pk_types.open_my_cursor(o_cur_d2);
            pk_types.open_my_cursor(o_cur_d3);
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_SUMMARY_GEN_INF',
                                              o_error);
        
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_summary_gen_inf;

    FUNCTION get_summary_dept_srv
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN profissional,
        i_id_institution IN institution.id_institution%TYPE,
        o_cur            OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
        tn_id_dept table_number := table_number();
        tn_id_serv table_number := table_number();
    
        tv_desc_dept table_varchar := table_varchar();
        tv_desc_serv table_varchar := table_varchar();
        tv_desc_cs   table_clob := table_clob();
    
        t_str CLOB;
    BEGIN
        -- initialize clob
        t_str := '';
        -- colect department and service info
        SELECT d.id_dept id_department,
               pk_translation.get_translation(i_lang, d.code_dept) desc_department,
               s.id_department id_service,
               pk_translation.get_translation(i_lang, s.code_department) desc_service
          BULK COLLECT
          INTO tn_id_dept, tv_desc_dept, tn_id_serv, tv_desc_serv
          FROM dept d
         INNER JOIN department s
            ON (s.id_dept = d.id_dept AND s.id_institution = d.id_institution AND s.flg_available = g_flg_avail)
         WHERE d.flg_available = g_flg_avail
           AND d.id_institution = i_id_institution
         ORDER BY desc_department, desc_service;
        -- for each service colect list of clinical_services
        FOR i IN 1 .. tn_id_serv.count
        LOOP
            SELECT pk_utils.query_to_clob('SELECT pk_translation.get_translation(' || i_lang ||
                                          ', cs.code_clinical_service) tt
      FROM dep_clin_serv dcs
     INNER JOIN clinical_service cs
        ON (cs.id_clinical_service = dcs.id_clinical_service AND cs.flg_available = ''Y'')
     WHERE dcs.id_department = ' || tn_id_serv(i) || '
       AND dcs.flg_available = ''Y''
       AND pk_translation.get_translation(' || i_lang || ', cs.code_clinical_service) IS NOT NULL
       order by tt',
                                          ';')
              INTO t_str
              FROM dual;
        
            tv_desc_cs.extend;
            tv_desc_cs(i) := t_str;
        END LOOP;
        -- flash purge cursor
        g_error := 'GET_SUMMARY_DEPT_SRV';
        OPEN o_cur FOR
            SELECT dept.column_value id_department,
                   desc_dept.column_value desc_department,
                   serv.column_value id_service,
                   '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T080') || '</b>: ' ||
                   desc_serv.column_value desc_service,
                   NULL id_specialty,
                   '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T081') || '</b>: ' ||
                   desc_cs.column_value desc_specialty
              FROM (SELECT column_value, rownum AS id
                      FROM TABLE(tn_id_dept)) dept
             INNER JOIN (SELECT column_value, rownum AS id
                           FROM TABLE(tv_desc_dept)) desc_dept
                ON (desc_dept.id = dept.id)
             INNER JOIN (SELECT column_value, rownum AS id
                           FROM TABLE(tn_id_serv)) serv
                ON (serv.id = dept.id)
             INNER JOIN (SELECT column_value, rownum AS id
                           FROM TABLE(tv_desc_serv)) desc_serv
                ON (desc_serv.id = dept.id)
             INNER JOIN (SELECT column_value, rownum AS id
                           FROM TABLE(tv_desc_cs)) desc_cs
                ON (desc_cs.id = dept.id);
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_cur);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_SUMMARY_DEPT_SRV',
                                              o_error);
        
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
    END get_summary_dept_srv;

    /********************************************************************************************
    * Get set of rooms within institution dep_clin_Serv
    *
    * @param i_lang                  Prefered language ID
    * @param i_prof                  Professional info array
    * @param i_id_institution        Id institution 
    * @param o_error                 Error
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      RMGM
    * @version                     2.6
    * @since                       2011/05/17
    ********************************************************************************************/

    FUNCTION get_summary_rooms
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN profissional,
        i_id_institution IN institution.id_institution%TYPE,
        o_cur            OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
        -- vars to return
        t_str      CLOB;
        tn_id_room table_number := table_number();
        tn_id_dept table_number := table_number();
        tn_id_serv table_number := table_number();
    
        tv_desc_rdcs table_clob := table_clob();
    
        tv_desc_room table_varchar := table_varchar();
        tv_desc_dept table_varchar := table_varchar();
    BEGIN
        -- initialize clob
        t_str := '';
        -- colect room and department info
        SELECT r.id_room,
               pk_translation.get_translation(i_lang, r.code_room) desc_room,
               d.id_dept,
               (SELECT pk_translation.get_translation(i_lang, d.code_dept)
                  FROM dual) desc_dept,
               s.id_department
          BULK COLLECT
          INTO tn_id_room, tv_desc_room, tn_id_dept, tv_desc_dept, tn_id_serv
          FROM room r
         INNER JOIN department s
            ON (s.id_department = r.id_department AND s.flg_available = g_flg_avail)
         INNER JOIN dept d
            ON (d.id_dept = s.id_dept AND d.id_institution = s.id_institution AND d.flg_available = g_flg_avail)
         WHERE r.flg_available = g_flg_avail
           AND s.id_institution = i_id_institution
         ORDER BY desc_room, desc_dept;
        -- for each room colect list of dcs
        FOR i IN 1 .. tn_id_room.count
        LOOP
            SELECT pk_utils.query_to_clob('SELECT (SELECT pk_translation.get_translation(' || i_lang ||
                                          ', s.code_department) FROM dual) || ''-'' || (SELECT pk_translation.get_translation(' ||
                                          i_lang || ', cs.code_clinical_service) FROM dual) tt
          FROM room_dep_clin_serv rdcs
         INNER JOIN dep_clin_serv dcs
            ON (dcs.id_dep_clin_serv = rdcs.id_dep_clin_serv AND dcs.flg_available = ''Y'')
         INNER JOIN department s
            ON (s.id_department = dcs.id_department AND s.flg_available = ''Y'')
         INNER JOIN clinical_service cs
            ON (cs.id_clinical_service = dcs.id_clinical_service AND cs.flg_available = ''Y'')
         WHERE rdcs.id_room =' || tn_id_room(i) || '
           AND s.id_department = ' || tn_id_serv(i) || ' order by tt',
                                          ';')
              INTO t_str
              FROM dual;
        
            tv_desc_rdcs.extend;
            tv_desc_rdcs(i) := t_str;
        END LOOP;
    
        -- flash cursor
        g_error := 'GET_SUMMARY_ROOMS';
        OPEN o_cur FOR
            SELECT /*+ use_nl(room room_id dept dept_id dcs)*/
             room_id.column_value id_room,
             room.column_value desc_room,
             dept_id.column_value id_department,
             '<b>' || (SELECT pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T082')
                         FROM dual) || '</b>: ' || dept.column_value desc_department,
             NULL AS id_srv_spec,
             '<b>' || (SELECT pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T080')
                         FROM dual) || '/' || (SELECT pk_message.get_message(i_lang, 'ADMINISTRATOR_INSTITUTIONS_T081')
                                                 FROM dual) || '</b>: ' || dcs.column_value desc_srv_spec
              FROM (SELECT /*+ opt_estimate(table t1 rows=1) */
                     column_value, rownum AS id
                      FROM TABLE(tv_desc_room) t1) room
             INNER JOIN (SELECT /*+ opt_estimate(table t2 rows=1) */
                          column_value, rownum AS id
                           FROM TABLE(tn_id_room) t2) room_id
                ON (room_id.id = room.id)
             INNER JOIN (SELECT /*+ opt_estimate(table t3 rows=1) */
                          column_value, rownum AS id
                           FROM TABLE(tv_desc_dept) t3) dept
                ON (dept.id = room.id)
             INNER JOIN (SELECT /*+ opt_estimate(table t4 rows=1) */
                          column_value, rownum AS id
                           FROM TABLE(tn_id_dept) t4) dept_id
                ON (dept_id.id = room.id)
              LEFT JOIN (SELECT /*+ opt_estimate(table t5 rows=1) */
                          column_value, rownum AS id
                           FROM TABLE(tv_desc_rdcs) t5) dcs
                ON (dcs.id = room.id);
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_types.open_my_cursor(o_cur);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_SUMMARY_ROOMS',
                                              o_error);
        
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_summary_rooms;

    FUNCTION get_next_value
    (
        i_table_name     IN VARCHAR2,
        i_id_institution IN institution.id_institution%TYPE
    ) RETURN NUMBER IS
        l_value NUMBER;
    
    BEGIN
    
        CASE i_table_name
            WHEN 'PROF_PROFILE_TEMPLATE' THEN
                l_value := seq_prof_profile_template.nextval;
            WHEN 'DEPT' THEN
                l_value := seq_dept.nextval;
            WHEN 'DEP_CLIN_SERV' THEN
                l_value := seq_dep_clin_serv.nextval;
            WHEN 'PROF_INSTITUTION' THEN
                l_value := seq_prof_institution.nextval;
            WHEN 'SOFTWARE_INSTITUTION' THEN
                l_value := seq_software_institution.nextval;
            WHEN 'ROOM' THEN
                l_value := seq_room.nextval;
            WHEN 'SOFTWARE_DEPT' THEN
                l_value := seq_software_dept.nextval;
            WHEN 'FLOORS' THEN
                l_value := seq_floors.nextval;
            WHEN 'FLOORS_INSTITUTION' THEN
                l_value := seq_floors_institution.nextval;
            WHEN 'BUILDING' THEN
                l_value := seq_building.nextval;
            ELSE
                NULL;
        END CASE;
    
        RETURN l_value;
    END;

    /*************************************************************************************************************************/

    FUNCTION table_varchar_string
    (
        i_tab       IN table_varchar,
        i_delim     IN VARCHAR2 DEFAULT '|',
        i_start_off IN NUMBER DEFAULT 1,
        i_length    IN NUMBER DEFAULT -1
    ) RETURN VARCHAR2 IS
        /**
        * Aggregate function for group by clauses, and others.
        * Concatenates all varchar2 in the passed table
        *
        * @param i_tab a object of type 'table or varchar'
        * @param i_delim delimiter between elements in the table
        * @return the text
        */
        l_string VARCHAR2(32767) := NULL;
        l_length NUMBER;
    BEGIN
        IF i_length < 0
        THEN
            l_length := i_tab.count;
        ELSE
            l_length := i_length;
        END IF;
        FOR l_idx IN 1 .. i_tab.count
        LOOP
            IF l_idx BETWEEN i_start_off AND (i_start_off + l_length)
            THEN
                IF l_string IS NULL
                THEN
                    l_string := '''' || i_tab(l_idx) || '''';
                ELSE
                    l_string := l_string || i_delim || '''' || i_tab(l_idx) || '''';
                END IF;
            END IF;
        END LOOP;
        RETURN l_string;
    END;

    FUNCTION get_prof_profile_template
    (
        i_lang                IN language.id_language%TYPE,
        i_prof                IN profissional,
        o_id_profile_template OUT prof_profile_template.id_profile_template%TYPE,
        o_error               OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        SELECT ppt.id_profile_template
          INTO o_id_profile_template
          FROM prof_profile_template ppt
         INNER JOIN profile_template pt
            ON (pt.id_profile_template = ppt.id_profile_template)
         INNER JOIN software s
            ON (s.id_software = pt.id_software)
         WHERE ppt.id_professional = i_prof.id
           AND ppt.id_institution = i_prof.institution
           AND ppt.id_software = i_prof.software
           AND s.flg_viewer = 'N';
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_PROFILE_TEMPLATE',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_prof_profile_template;

    /**********************************************************************************************
    * Facility number of licenses
    *
    * @param i_prof              Object (professional ID, institution ID, software ID)
    * @param i_lang              Prefered language ID
    * @param o_license_num       Number of licenses
    * @param o_error             Error
    *
    * @return                    true or false on success or error
    *
    * @author                    JVB
    * @version                   1.0
    * @since                     2007/11/21
    **********************************************************************************************/
    FUNCTION get_license_num
    (
        i_prof        IN profissional,
        i_lang        IN language.id_language%TYPE,
        o_license_num OUT NUMBER,
        o_error       OUT t_error_out
    ) RETURN BOOLEAN IS
        l_sql VARCHAR2(32767);
    BEGIN
        g_error := 'Count licenses';
        l_sql   := 'SELECT COUNT(l.id_license)
          FROM aol.license l
         WHERE l.id_institution = ' || i_prof.institution || ' AND l.id_profile_template_desc IS NOT NULL
           AND l.flg_status IN (''' || g_license_waiting || ''', ''' || g_license_available || ''')';
    
        pk_alertlog.log_debug(l_sql);
        EXECUTE IMMEDIATE l_sql
            INTO o_license_num;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_LICENSE_NUM',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END;

    /**********************************************************************************************
    * Facility number of licenses
    *
    * @param i_prof              Object (professional ID, institution ID, software ID)
    * @param i_lang              Prefered language ID
    * @param o_license_num       Number of licenses
    * @param o_error             Error
    *
    * @return                    true or false on success or error
    *
    * @author                    JVB
    * @version                   1.0
    * @since                     2007/11/21
    **********************************************************************************************/
    FUNCTION get_license_num
    (
        i_prof IN profissional,
        i_lang IN language.id_language%TYPE
    ) RETURN NUMBER IS
        l_num   NUMBER(12);
        l_sql   VARCHAR2(32767);
        l_error t_error_out;
    BEGIN
        g_error := 'Count licenses';
        l_sql   := 'SELECT COUNT(l.id_license)
          FROM aol.license l
         WHERE l.id_institution = ' || i_prof.institution || ' AND l.id_profile_template_desc IS NOT NULL
           AND l.flg_status IN (''' || g_license_waiting || ''', ''' || g_license_available || ''')';
    
        pk_alertlog.log_debug(l_sql);
        EXECUTE IMMEDIATE l_sql
            INTO l_num;
        RETURN l_num;
    EXCEPTION
        WHEN OTHERS THEN
        
            g_error := 'GET_LICENCE_NUM';
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_LICENCE_NUM',
                                              l_error);
            pk_alert_exceptions.reset_error_state;
            RETURN NULL;
        
    END;

    /**********************************************************************************************
    * Value to pay for licenses
    *
    * @param i_prof              Object (professional ID, institution ID, software ID)
    * @param i_lang              Prefered language ID
    * @param i_id_software       Software ID
    * @param i_id_product_list   Products ID
    * @param i_product_num       Number of products
    * @param i_product_type      Product type
    * @param i_payment_schedule  Payment schedule
    * @param o_license_cost_list Product list
    * @param o_sub_total         Sub total
    * @param o_sub_total_desc    Sub total description
    * @param o_tax               Tax
    * @param o_tax_desc          Tax description
    * @param o_total             Total
    * @param o_total_desc        Total description
    * @param o_setupfee          Setupfee
    * @param o_setupfee_desc     Setupfee description
    * @param o_error             Error
    *
    * @return                    true or false on success or error
    *
    * @author                    JVB
    * @version                   1.0
    * @since                     2007/12/04
    **********************************************************************************************/
    FUNCTION get_product_cost_list
    (
        i_prof              IN profissional,
        i_lang              IN language.id_language%TYPE,
        i_id_software       IN profile_template.id_software%TYPE,
        i_id_product_list   IN table_number,
        i_product_num       IN table_number,
        i_product_type      IN table_varchar,
        i_payment_schedule  IN table_varchar,
        o_license_cost_list OUT pk_types.cursor_type,
        o_sub_total         OUT NUMBER,
        o_sub_total_desc    OUT VARCHAR2,
        o_tax               OUT NUMBER,
        o_tax_desc          OUT VARCHAR2,
        o_total             OUT NUMBER,
        o_total_desc        OUT VARCHAR2,
        o_setupfee          OUT NUMBER,
        o_setupfee_desc     OUT VARCHAR2,
        o_qty               OUT NUMBER,
        o_error             OUT t_error_out
    ) RETURN BOOLEAN IS
        l_sql1            VARCHAR2(32767);
        l_sql2            VARCHAR2(32767);
        l_sql3            VARCHAR2(32767);
        l_cursor_total    pk_types.cursor_type;
        l_tax             NUMBER(10, 6);
        l_tax_desc        VARCHAR2(11);
        l_id_country      country.id_country%TYPE;
        l_id_location_tax location_tax.id_location_tax%TYPE;
        l_id_currency     currency.id_currency%TYPE;
    
        l_formationfee        NUMBER(24, 4);
        l_formationfee_desc   VARCHAR2(30);
        l_lic_num_old         NUMBER(10);
        l_prd_num_old         NUMBER(10);
        l_lic_num             NUMBER(10);
        l_prd_num             NUMBER(10);
        l_id_profile_template profile_template.id_profile_template%TYPE;
        l_error               t_error_out;
        my_exception EXCEPTION;
    
    BEGIN
    
        -- set country and location tax
        g_error := 'SET COUNTRY AND LOCATION TAX';
        SELECT ia.id_country, ia.id_location_tax, ia.id_currency
          INTO l_id_country, l_id_location_tax, l_id_currency
          FROM inst_attributes ia
         WHERE ia.id_institution = i_prof.institution;
    
        FOR i IN 1 .. i_product_type.count
        LOOP
            IF l_sql1 IS NOT NULL
               AND i_product_num(i) <> 0
            THEN
                l_sql1 := l_sql1 || ' union all ';
            END IF;
        
            IF i_product_type(i) = g_product_purch_type
               AND i_product_num(i) <> 0
            THEN
            
                -- set license number old
                g_error := 'SET LIC NUM OLD';
                IF NOT get_inst_pro_num(i_prof, i_lang, i_id_product_list(i), l_prd_num_old, l_error)
                THEN
                
                    RAISE my_exception;
                
                END IF;
            
                g_error   := 'GET FORMATION FEE';
                l_sql3    := 'SELECT t.cost_formationfee
                  FROM (SELECT nvl(ppc.cost_formationfee, 0) cost_formationfee
                          FROM aol.product_purchasable pp, aol.product_purchasable_cost ppc
                         WHERE pp.id_product_purchasable = ' || i_id_product_list(i) ||
                             ' AND pp.id_product_purchasable = ppc.id_product_purchasable
                           AND ppc.id_currency = ' || l_id_currency ||
                             ' AND nvl(ppc.payment_schedule, 1) = nvl(''' || i_payment_schedule(i) ||
                             ''', 1)
                           AND ppc.id_country = ' || l_id_country ||
                             ' AND nvl(ppc.license_num, ' || i_product_num(i) || ') = ' || i_product_num(i) || ') t
                 WHERE rownum < 2';
                l_prd_num := l_prd_num_old + i_product_num(i);
            
                EXECUTE IMMEDIATE l_sql3
                    INTO l_formationfee;
            
                -- convert formation fee
                l_formationfee_desc := REPLACE(l_formationfee, ',', '.');
            
                g_error := 'SQL PRODUCT';
                l_sql1  := l_sql1 ||
                           'SELECT * FROM (SELECT pp.id_product_purchasable id, ppc.id_product_purchasable_cost id_cost,  aol.pk_aol_translation.get_translation(aol.t_user(' ||
                           i_prof.id || ',' || i_prof.institution || ', ' || i_prof.software || ', ' || i_lang ||
                           '), pp.code_product_purchasable) text, ''' || g_product_purch_type ||
                           ''' flg_type, nvl(ppc.cost, 0) cost, pk_backoffice.set_currency_desc(nvl(ppc.cost, 0), c.id_currency) cost_desc, (nvl(ppc.cost_setupfee, 0) + ' ||
                           l_formationfee_desc ||
                           ') cost_setupfee , pk_backoffice.set_currency_desc((nvl(ppc.cost_setupfee, 0) + ' ||
                           l_formationfee_desc || '), c.id_currency) cost_setupfee_desc, ' || i_product_num(i) ||
                           ' qty, (nvl(ppc.cost, 0) + nvl(ppc.cost_setupfee, 0) + ' || l_formationfee_desc || ') * ' ||
                           i_product_num(i) ||
                           ' subtotal_num, pk_backoffice.set_currency_desc((nvl(ppc.cost, 0) + nvl(ppc.cost_setupfee, 0) + ' ||
                           l_formationfee_desc || ') * ' || i_product_num(i) ||
                           ', c.id_currency) subtotal, pp.rank rank
          FROM aol.product_purchasable pp, aol.product_purchasable_cost ppc, currency c
         WHERE pp.id_product_purchasable = ' || i_id_product_list(i) || '
           AND pp.id_product_purchasable = ppc.id_product_purchasable
           AND c.id_currency = ' || l_id_currency || ' AND ppc.id_currency = c.id_currency
           AND pp.id_software IN (' || i_id_software || ', 0)
           AND ppc.id_country = ' || l_id_country || '
           AND pp.id_institution = ' || g_alert_institution || ' AND nvl(ppc.license_num, ' ||
                           l_prd_num || ') = ' || l_prd_num || ' AND pp.flg_available = ''' ||
                           g_product_purchasable_avlbl || ''' AND ppc.flg_available = ''' || g_product_purch_cost_avlbl ||
                           ''' AND nvl(ppc.payment_schedule, 1) = nvl(''' || i_payment_schedule(i) ||
                           ''', 1) ORDER BY rank)  WHERE rownum < 2';
            
                g_error := 'SQL LICENSE';
            
            ELSIF i_product_type(i) = g_profile_template_pay_type
                  AND i_product_num(i) <> 0
            THEN
                -- set profile_template
                SELECT ptd.id_profile_template
                  INTO l_id_profile_template
                  FROM profile_template_desc ptd
                 WHERE ptd.id_profile_template_desc = i_id_product_list(i);
                -- set license number old
            
                g_error := 'SET LIC NUM OLD';
                IF NOT get_inst_lic_num(i_prof, i_lang, l_id_profile_template, l_lic_num_old, l_error)
                THEN
                
                    RAISE my_exception;
                END IF;
            
                g_error := ' get profile template cost formation fee ';
                l_sql3  := 'SELECT t.cost_formationfee
                  FROM (SELECT nvl(ptc.cost_formationfee, 0) cost_formationfee
                          FROM profile_template      pt,
                               profile_template_desc ptd,
                               aol.profile_template_cost       ptc
                         WHERE ptd.id_profile_template_desc = ' || i_id_product_list(i) ||
                           ' AND pt.id_profile_template = ptd.id_profile_template
                           AND ptc.id_profile_template = pt.id_profile_template
                           AND ptc.id_software = ptd.id_software
                           AND ptc.id_currency = ' || l_id_currency ||
                           ' AND nvl(ptc.payment_schedule, 1) = nvl(''' || i_payment_schedule(i) ||
                           ''', 1)
                           AND nvl(ptc.license_num, ' || i_product_num(i) || ') = ' ||
                           i_product_num(i) || ') t
                 WHERE rownum < 2';
            
                l_lic_num := l_lic_num_old + i_product_num(i);
            
                EXECUTE IMMEDIATE l_sql3
                    INTO l_formationfee;
            
                -- convert formation fee
                l_formationfee_desc := REPLACE(l_formationfee, ',', '.');
            
                g_error := 'SQL LICENSE PROFILE TEMPLATE';
                l_sql1  := l_sql1 ||
                           'SELECT * FROM (SELECT ptd.id_profile_template_desc id, ptc.id_profile_template_cost id_cost, pk_translation.get_translation(' ||
                           i_lang || ', ptd.code_profile_template_desc) text, ''' || g_profile_template_type ||
                           ''' flg_type, nvl(ptc.cost, 0) cost, pk_backoffice.set_currency_desc(nvl(ptc.cost, 0), c.id_currency) cost_desc, (nvl(ptc.cost_setupfee, 0) + nvl(ptc.cost_formationfee, 0)) cost_setupfee , pk_backoffice.set_currency_desc((nvl(ptc.cost_setupfee, 0) + nvl(ptc.cost_formationfee, 0)), c.id_currency) cost_setupfee_desc, ' ||
                           i_product_num(i) ||
                           ' qty, (nvl(ptc.cost, 0) + nvl(ptc.cost_setupfee, 0) + nvl(ptc.cost_formationfee, 0)) * ' ||
                           i_product_num(i) ||
                           ' subtotal_num, pk_backoffice.set_currency_desc((nvl(ptc.cost, 0) + nvl(ptc.cost_setupfee, 0) + nvl(ptc.cost_formationfee, 0)) * ' ||
                           i_product_num(i) || ', c.id_currency) subtotal, ptd.rank rank
              FROM profile_template pt, aol.profile_template_cost ptc, currency c, profile_template_desc ptd
             WHERE ptd.id_profile_template_desc = ' || i_id_product_list(i) ||
                           ' AND ptd.id_profile_template = pt.id_profile_template AND ptd.id_profile_template = ptc.id_profile_template AND ptd.id_software = ' ||
                           i_id_software || ' AND ptc.id_software = ' || i_id_software || ' AND c.id_currency = ' ||
                           l_id_currency || ' AND ptc.id_currency = c.id_currency AND ptd.id_country = ' ||
                           l_id_country || ' AND nvl(ptc.license_num, ' || l_lic_num || ') = ' || l_lic_num ||
                           ' AND pt.flg_available = ''' || g_profile_template_available ||
                           ''' AND ptc.flg_available = ''' || g_profile_template_cost_avlbl ||
                           ''' AND ptd.flg_available = ''' || g_profile_template_desc_avlbl ||
                           ''' AND nvl(ptc.payment_schedule, 1) = nvl(''' || i_payment_schedule(i) ||
                           ''', 1) ORDER BY license_num) WHERE rownum < 2 ';
            END IF;
        END LOOP;
    
        pk_alertlog.log_debug(substr(l_sql1, 0, 2000));
        pk_alertlog.log_debug(substr(l_sql1, 2001, 2000));
        pk_alertlog.log_debug(substr(l_sql1, 4001, 2000));
        pk_alertlog.log_debug(substr(l_sql1, 6001, 2000));
        pk_alertlog.log_debug(substr(l_sql1, 8001, 2000));
    
        -- SET TAX
        g_error := 'SET TAX';
        IF NOT get_tax(i_prof, i_lang, l_tax, l_error)
        THEN
            RAISE my_exception;
        END IF;
    
        l_tax_desc := REPLACE(l_tax, ',', '.');
    
        g_error := 'OPEN CURSOR';
        IF l_sql1 IS NOT NULL
        THEN
            l_sql2 := 'SELECT total + setupfee sub_total, pk_backoffice.set_currency_desc(total + setupfee, c.id_currency) sub_total_desc, (' ||
                      l_tax_desc || ' * (total + setupfee)) tax, pk_backoffice.set_currency_desc((' || l_tax_desc ||
                      ' * (total + setupfee)), c.id_currency) tax_desc, (' || l_tax_desc ||
                      ' * (total + setupfee) + total + setupfee) total, pk_backoffice.set_currency_desc((' ||
                      l_tax_desc ||
                      ' * (total + setupfee) + total + setupfee), c.id_currency) total_desc, setupfee,pk_backoffice.set_currency_desc(setupfee, c.id_currency) setupfee_desc, qty FROM (SELECT sum(cost * qty) total, sum(cost_setupfee * qty) setupfee, sum(qty) qty  FROM (' ||
                      l_sql1 || ')), currency c WHERE c.id_currency =' || l_id_currency;
        
            OPEN o_license_cost_list FOR l_sql1;
        ELSE
            pk_types.open_my_cursor(o_license_cost_list);
        END IF;
    
        g_error := 'GET TOTAL';
        IF l_sql2 IS NOT NULL
        THEN
            pk_alertlog.log_debug(substr(l_sql2, 0, 2000));
            pk_alertlog.log_debug(substr(l_sql2, 2001, 2000));
            pk_alertlog.log_debug(substr(l_sql2, 4001, 2000));
            pk_alertlog.log_debug(substr(l_sql2, 6001, 2000));
            pk_alertlog.log_debug(substr(l_sql2, 8001, 2000));
            OPEN l_cursor_total FOR l_sql2;
            FETCH l_cursor_total
                INTO o_sub_total,
                     o_sub_total_desc,
                     o_tax,
                     o_tax_desc,
                     o_total,
                     o_total_desc,
                     o_setupfee,
                     o_setupfee_desc,
                     o_qty;
            CLOSE l_cursor_total;
        END IF;
    
        RETURN TRUE;
    EXCEPTION
        WHEN my_exception THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error || ' / ' || l_error.err_desc,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PRODUCT_COST_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_license_cost_list);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PRODUCT_COST_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END;

    /**********************************************************************************************
    * Value to pay for licenses
    *
    * @param i_prof              Object (professional ID, institution ID, software ID)
    * @param i_lang              Preferred language ID
    * @param i_id_software       Software ID
    * @param o_product_list      Product list
    * @param o_error             Error
    *
    * @return                    true or false on success or error
    *
    * @author                    JVB
    * @version                   1.0
    * @since                     2007/12/04
    **********************************************************************************************/
    FUNCTION get_product_list
    (
        i_prof         IN profissional,
        i_lang         IN language.id_language%TYPE,
        i_id_software  IN profile_template.id_software%TYPE,
        o_product_list OUT pk_types.cursor_type,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
        l_sql VARCHAR2(32767);
    
        l_id_country  country.id_country%TYPE;
        l_id_currency currency.id_currency%TYPE;
    BEGIN
        -- set country and location tax
        g_error := 'SET COUNTRY AND LOCATION TAX';
        SELECT ia.id_country, ia.id_currency
          INTO l_id_country, l_id_currency
          FROM inst_attributes ia
         WHERE ia.id_institution = i_prof.institution;
    
        l_sql := 'SELECT * FROM (SELECT pp.id_product_purchasable id, aol.pk_aol_translation.get_translation(aol.t_user(' ||
                 i_prof.id || ',' || i_prof.institution || ', ' || i_prof.software || ', ' || i_lang ||
                 '), pp.code_product_purchasable) text, ''' || g_product_purch_type || ''' flg_type, '''' flg_mandatory, decode(ppc.payment_schedule, null, ''N'', ''Y'') flg_schedule, pp.rank rank, to_char(null) flg_free
          FROM aol.product_purchasable pp, aol.product_purchasable_cost ppc, currency c
         WHERE pp.id_product_purchasable = ppc.id_product_purchasable
           AND c.id_currency = ' || l_id_currency || ' AND ppc.id_currency = c.id_currency
           AND pp.id_software IN (' || i_id_software || ', 0) AND ppc.id_country = ' || l_id_country || '
           AND pp.id_institution = ' || g_alert_institution || ' AND pp.flg_available = ''' ||
                 g_product_purchasable_avlbl || ''' AND ppc.flg_available = ''' || g_product_purch_cost_avlbl ||
                 ''' GROUP BY pp.id_product_purchasable, pp.code_product_purchasable, decode(ppc.payment_schedule, null, ''N'', ''Y''), pp.rank ORDER BY text, rank)';
    
        l_sql := l_sql || ' union all ';
        l_sql := l_sql || 'SELECT * FROM (SELECT ptd.id_profile_template_desc id, pk_translation.get_translation(' ||
                 i_lang || ', ptd.code_profile_template_desc) text, ''' || g_profile_template_pay_type ||
                 ''' flg_type, ptc.flg_mandatory flg_mandatory, decode(ptc.payment_schedule, null, ''N'', ''Y'') flg_schedule, ptd.rank rank, ptd.flg_free
              FROM profile_template pt, aol.profile_template_cost ptc, currency c, profile_template_desc ptd
             WHERE pt.id_profile_template(+) = ptd.id_profile_template AND pt.id_profile_template = ptc.id_profile_template(+) AND ptc.id_software(+) = ' ||
                 i_id_software || ' AND ptd.id_software = ' || i_id_software || ' AND c.id_currency(+) = ' ||
                 l_id_currency || ' AND ptc.id_currency = c.id_currency(+) AND ptd.id_country = ' || l_id_country ||
                 ' AND pt.flg_available(+) = ''' || g_profile_template_available || ''' AND ptc.flg_available(+) = ''' ||
                 g_profile_template_cost_avlbl || ''' AND ptd.flg_available = ''' || g_profile_template_desc_avlbl ||
                 ''' Group BY ptd.id_profile_template_desc, ptd.id_profile_template, ptd.code_profile_template_desc, ptd.flg_type, ptc.flg_mandatory, ptd.rank, ptd.flg_free, decode(ptc.payment_schedule, null, ''N'', ''Y'') ORDER BY flg_type desc, text, rank)';
    
        g_error := 'OPEN CURSOR';
        pk_alertlog.log_debug(substr(l_sql, 0, 2000));
        pk_alertlog.log_debug(substr(l_sql, 2001, 2000));
        pk_alertlog.log_debug(substr(l_sql, 4001, 2000));
    
        IF l_sql IS NOT NULL
        THEN
            OPEN o_product_list FOR l_sql;
        ELSE
            pk_types.open_my_cursor(o_product_list);
        END IF;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_product_list);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PRODUCT_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END;

    /********************************************************************************************
    * Number of profile licenses 
    *
    * @param i_prof                   Object (professional ID, institution ID, software ID)
    * @param i_lang                   Preferred language ID
    * @param i_id_profile_template    Profile ID
    * @param o_license_num            Number of profiles
    * @param o_error                  Error
    *
    * @return                         true or false on success or error
    *
    * @author                         JVB
    * @version                        1.0
    * @since                          2007/11/29
    ********************************************************************************************/
    FUNCTION get_inst_lic_num
    (
        i_prof                IN profissional,
        i_lang                IN language.id_language%TYPE,
        i_id_profile_template IN profile_template.id_profile_template%TYPE,
        o_license_num         OUT NUMBER,
        o_error               OUT t_error_out
    ) RETURN BOOLEAN IS
        l_sql VARCHAR2(32767);
    BEGIN
        g_error := 'COUNT LICENSES';
        l_sql   := 'SELECT COUNT(l.id_license)
          FROM aol.license l, profile_template_desc ptc
         WHERE l.id_institution = ' || i_prof.institution ||
                   ' AND l.id_profile_template_desc = ptc.id_profile_template_desc
           AND ptc.id_profile_template = ' || i_id_profile_template || ' AND l.flg_status IN (''' ||
                   g_license_available || ''', ''' || g_license_waiting || ''')';
    
        EXECUTE IMMEDIATE l_sql
            INTO o_license_num;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_INST_LIC_NUM',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END;

    /********************************************************************************************
    * Number of profile licenses at the facility
    *
    * @param i_prof                   Object (professional ID, institution ID, software ID)
    * @param i_lang                   Preferred language ID
    * @param i_id_institution         Institution ID
    * @param i_id_product_purchasable Product ID
    * @param o_product_num            Number of products
    * @param o_error                  Error
    *
    * @return                         true or false on success or error
    *
    * @author                         JVB
    * @version                        1.0
    * @since                          2007/12/03
    ********************************************************************************************/
    FUNCTION get_inst_pro_num
    (
        i_prof                   IN profissional,
        i_lang                   IN language.id_language%TYPE,
        i_id_product_purchasable IN NUMBER,
        o_product_num            OUT NUMBER,
        o_error                  OUT t_error_out
    ) RETURN BOOLEAN IS
        l_sql VARCHAR2(32767);
    BEGIN
        g_error := 'COUNT LICENSES';
        l_sql   := 'SELECT COUNT(l.id_license)
          FROM aol.license l, aol.product_purchasable pp
         WHERE l.id_institution = ' || i_prof.institution || ' AND pp.id_product_purchasable = ' ||
                   i_id_product_purchasable || ' AND l.id_product_purchasable = pp.id_product_purchasable
           AND l.flg_status IN (''' || g_license_available || ''', ''' || g_license_waiting || ''')';
    
        EXECUTE IMMEDIATE l_sql
            INTO o_product_num;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_INST_PRO_NUM',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END;

    /********************************************************************************************
    * Create/update licenses
    *
    * @param i_prof                   Profissional ID
    * @param i_lang                   Preferred language ID
    * @param i_id_product_purch_list  Product list
    * @param i_product_purch_num      Number of linceses
    * @param i_id_institution         Institution ID
    * @param o_id_license             Licenses
    * @param o_error                  Error
    *
    * @return                         true or false on success or error
    *
    * @author                         JVB
    * @version                        1.0
    * @since                          2007/12/04
    ********************************************************************************************/
    FUNCTION set_product_purch_lcs
    (
        i_prof                  IN profissional,
        i_lang                  IN language.id_language%TYPE,
        i_id_product_purch_list IN table_number,
        i_product_purch_num     IN table_number,
        i_payment_schedule_list IN table_varchar,
        o_id_license            OUT table_number,
        o_error                 OUT t_error_out
    ) RETURN BOOLEAN IS
        l_sql VARCHAR2(32767);
    BEGIN
        g_error := 'SET LICENSES';
        l_sql   := 'declare
        g_exception EXCEPTION;
        l_id_license table_number;
        l_error t_error_out;
        begin
        
        IF NOT aol.pk_aol_register.set_product_purch_lcs(aol.t_user( ' || i_prof.id || ',
                                                                       ' || i_prof.institution || ',
                                                                       ' || i_prof.software || ',
                                                                       ' || i_lang ||
                   '), table_number(' || pk_utils.concat_table(i_id_product_purch_list, ',') || '), table_number(' ||
                   pk_utils.concat_table(i_product_purch_num, ',') || '), ' || i_prof.institution || ', table_varchar(' ||
                   table_varchar_string(i_payment_schedule_list, ',') || '), :o_id_license,
                 :l_error)
        THEN
            RAISE g_exception;
        END IF;
        end;';
    
        pk_alertlog.log_debug(l_sql);
        EXECUTE IMMEDIATE l_sql
            USING OUT o_id_license, OUT o_error;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_PRODUCT_PURCH_LCS',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
        
            RETURN FALSE;
    END;

    /********************************************************************************************
    * Suggest username
    *
    * @param i_lang          Preferred language ID
    * @param i_first_name    First name
    * @param i_middle_name   Middle name
    * @param i_last_name     Last name
    * @param o_user_desc     Username
    * @param o_error         Error
    *
    * @return                true or false on success or error
    *
    * @author                JVB
    * @version               1.0
    * @since                 2007/12/17
    ********************************************************************************************/
    FUNCTION suggest_user
    (
        i_lang        IN language.id_language%TYPE,
        i_first_name  IN professional.first_name%TYPE,
        i_middle_name IN professional.middle_name%TYPE,
        i_last_name   IN professional.last_name%TYPE,
        o_user_desc   OUT ab_user_info.login%TYPE,
        o_error       OUT t_error_out
    ) RETURN BOOLEAN IS
        CURSOR c_user IS
            SELECT *
              FROM sys_domain d
             WHERE d.code_domain = 'SUGGEST_USER'
               AND domain_owner = pk_sysdomain.k_default_schema
             ORDER BY d.rank;
        r_user      c_user%ROWTYPE;
        l_user_desc ab_user_info.login%TYPE;
        l_flg_value VARCHAR2(1);
    
        l_first_name  professional.first_name%TYPE;
        l_middle_name professional.first_name%TYPE;
        l_last_name   professional.first_name%TYPE;
        l_error       t_error_out;
    BEGIN
        g_error := 'SUGGEST USER';
        -- set l_flg_value 'T' 
        l_flg_value := 'T';
    
        -- set l_names
        l_first_name  := REPLACE(i_first_name, ' ', '');
        l_middle_name := REPLACE(i_middle_name, ' ', '');
        l_last_name   := REPLACE(i_last_name, ' ', '');
    
        -- open cursor - exit when l_flg_value = 'F'
        OPEN c_user;
        LOOP
            FETCH c_user
                INTO r_user;
            EXIT WHEN l_flg_value = 'F';
        
            l_user_desc := REPLACE(REPLACE(REPLACE(r_user.desc_val, '@@1', l_first_name), '@@2', l_middle_name),
                                   '@@3',
                                   l_last_name);
        
            -- user exists validation
            IF NOT user_exists(i_lang, l_user_desc, l_flg_value, l_error)
            THEN
                RAISE g_exception;
            END IF;
        
            -- set o_user_desc if user doesn't exist
            IF l_flg_value = 'F'
            THEN
                o_user_desc := l_user_desc;
            END IF;
        
        END LOOP;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SUGGEST_USER',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END;

    /********************************************************************************************
    * Get alerts for a specific profile
    *
    * @param i_lang                  Preferred language ID
    * @param i_id_institution        Institution ID
    * @param i_id_software           Software ID    
    * @param i_id_profile_template   Profile ID
    * @param i_id_professional       Professional ID
    * @param o_list                  Alerts
    * @param o_error                 Error
    *
    * @return                        true or false on success or error
    * 
    *
    * @author                        JS
    * @version                       0.1
    * @since                         2008/03/11
    ********************************************************************************************/
    FUNCTION get_profile_sys_alert
    (
        i_lang                IN language.id_language%TYPE,
        i_id_institution      IN institution.id_institution%TYPE,
        i_id_software         IN software.id_software%TYPE,
        i_id_profile_template IN profile_template.id_profile_template%TYPE,
        i_id_professional     IN professional.id_professional%TYPE,
        o_list                OUT pk_types.cursor_type,
        o_error               OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
    
        g_error := 'GET CURSOR';
        OPEN o_list FOR
            SELECT DISTINCT sa.id_sys_alert,
                            pk_translation.get_translation(i_lang, sa.code_alert) sys_alert,
                            'A' flg_select
              FROM sys_alert_config sac, sys_alert sa, sys_alert_prof saprof
             WHERE sac.id_software IN (i_id_software, 0)
               AND sac.id_institution IN (i_id_institution, 0)
               AND sac.id_profile_template IN (i_id_profile_template, 0)
               AND sac.id_sys_alert = sa.id_sys_alert
               AND saprof.id_sys_alert = sa.id_sys_alert
               AND saprof.id_professional = i_id_professional
               AND saprof.id_software = i_id_software
               AND saprof.id_institution = i_id_institution
               AND saprof.id_profile_template = i_id_profile_template
            UNION
            SELECT DISTINCT sa.id_sys_alert,
                            pk_translation.get_translation(i_lang, sa.code_alert) sys_alert,
                            'I' flg_select
              FROM sys_alert_config sac, sys_alert sa
             WHERE sac.id_software IN (i_id_software, 0)
               AND sac.id_institution IN (i_id_institution, 0)
               AND sac.id_profile_template IN (i_id_profile_template, 0)
               AND sac.id_sys_alert = sa.id_sys_alert
               AND sac.id_sys_alert NOT IN
                   (SELECT sa.id_sys_alert
                      FROM sys_alert_config sac, sys_alert sa, sys_alert_prof saprof
                     WHERE sac.id_software IN (i_id_software, 0)
                       AND sac.id_institution IN (i_id_institution, 0)
                       AND sac.id_profile_template IN (i_id_profile_template, 0)
                       AND sac.id_sys_alert = sa.id_sys_alert
                       AND saprof.id_sys_alert = sa.id_sys_alert
                       AND saprof.id_professional = i_id_professional
                       AND saprof.id_software = i_id_software
                       AND saprof.id_institution = i_id_institution
                       AND saprof.id_profile_template = i_id_profile_template)
             ORDER BY sys_alert;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_list);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROFILE_SYS_ALERT',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_profile_sys_alert;

    /********************************************************************************************
    * Get professional assigned profiles at the facility
    *
    * @param i_lang             Preferred language ID
    * @param i_id_institution   Institution ID
    * @param i_id_software      Software ID
    * @param o_templ            Profiles
    * @param o_error            Error
    *
    * @return                   true or false on success or error
    * 
    *
    * @author                   JTS
    * @version                  0.1
    * @since                    2007/12/27
    ********************************************************************************************/
    FUNCTION get_profile_template_list
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN prof_profile_template.id_institution%TYPE,
        i_id_software    IN prof_profile_template.id_software%TYPE,
        o_templ          OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_profiles NUMBER(12) := 0;
        l_market   institution.id_market%TYPE;
    
    BEGIN
    
        SELECT COUNT(pti.id_profile_template)
          INTO l_profiles
          FROM profile_template_inst pti
         WHERE pti.id_institution = i_id_institution;
    
        SELECT nvl((SELECT i.id_market
                     FROM institution i
                    WHERE i.id_institution = i_id_institution),
                   0)
          INTO l_market
          FROM dual;
    
        IF l_profiles = 0
        THEN
            g_error := 'GET O_TEMPL';
            OPEN o_templ FOR
                SELECT DISTINCT pt.id_profile_template,
                                decode(ptm.id_market,
                                       0,
                                       pk_message.get_message(i_lang, pt.code_profile_template),
                                       pk_message.get_message(i_lang, pt.code_profile_template) || ' (' ||
                                       pk_utils.query_to_string('SELECT pk_translation.get_translation(' || i_lang ||
                                                                ', m.code_market) 
                               FROM market m WHERE m.id_market =' ||
                                                                ptm.id_market || '',
                                                                ',') || ')') intern_name_templ
                  FROM profile_template pt, profile_template_inst pti, profile_template_market ptm
                 WHERE pt.id_software = i_id_software
                   AND pt.flg_available = g_flg_available
                   AND pti.id_institution = 0
                   AND pti.id_profile_template = pt.id_profile_template
                   AND ptm.id_profile_template = pti.id_profile_template
                   AND ptm.id_market IN (0, l_market)
                 ORDER BY intern_name_templ;
        
        ELSE
            g_error := 'GET O_TEMPL';
            OPEN o_templ FOR
                SELECT DISTINCT pt.id_profile_template,
                                decode(ptm.id_market,
                                       0,
                                       pk_message.get_message(i_lang, pt.code_profile_template),
                                       pk_message.get_message(i_lang, pt.code_profile_template) || ' (' ||
                                       pk_utils.query_to_string('SELECT pk_translation.get_translation(' || i_lang ||
                                                                ', m.code_market) 
                               FROM market m WHERE m.id_market =' ||
                                                                ptm.id_market || '',
                                                                ',') || ')') intern_name_templ
                  FROM profile_template pt, profile_template_inst pti, profile_template_market ptm
                 WHERE pt.id_software = i_id_software
                   AND pt.flg_available = g_flg_available
                   AND pti.id_institution = i_id_institution
                   AND pti.id_profile_template = pt.id_profile_template
                   AND ptm.id_profile_template = pti.id_profile_template
                   AND ptm.id_market IN (0, l_market)
                 ORDER BY intern_name_templ;
        
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_templ);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROFILE_TEMPLATE_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_profile_template_list;

    /********************************************************************************************
    * Get list of professionals for a given institution, software and profile
    *
    * @param i_lang             Preferred language ID
    * @param i_id_institution   Institution ID
    * @param i_id_software      Software ID
    * @param i_id_prof_template profile ID
    * @param o_profs            output list
    * @param o_error            Error
    *
    * @return                   true or false on success or error
    * 
    * @author                   Telmo Castro
    * @version                  2.4.3
    * @since                    29-04-2008
    *
    * UPDATED
    * added total line to output cursor.
    * @author                   Telmo Castro
    * @version                  2.4.3
    * @date                     07-05-2008
    ********************************************************************************************/
    FUNCTION get_profile_profs
    (
        i_lang             IN language.id_language%TYPE,
        i_id_institution   IN prof_profile_template.id_institution%TYPE,
        i_id_software      IN prof_profile_template.id_software%TYPE,
        i_id_prof_template IN prof_profile_template.id_profile_template%TYPE,
        i_dummy            IN NUMBER,
        o_profs            OUT pk_types.cursor_type,
        o_error            OUT t_error_out
    ) RETURN BOOLEAN IS
        l_message      sys_message.desc_message%TYPE;
        l_ptname       pk_translation.t_desc_translation;
        l_linecount    NUMBER;
        l_replacements table_varchar;
        l_tokens       table_varchar;
        l_no_translation EXCEPTION;
        l_dummy NUMBER := i_dummy;
        l_error t_error_out;
        my_exception EXCEPTION;
    
        l_inactive_profs table_number := table_number();
    
    BEGIN
        -- get sys_message
        g_error   := 'get sys_message ' || g_todosprofs;
        l_message := pk_message.get_message(i_lang, g_todosprofs);
    
        g_error := 'GET INACTIVE PROFESSIONALS IN THE INSTITUTION (ID: ' || i_id_institution;
        pk_alertlog.log_debug('PK_BACKOFFICE.GET_PROFILE_PROFS ' || g_error);
        SELECT DISTINCT pi.id_professional
          BULK COLLECT
          INTO l_inactive_profs
          FROM prof_institution pi
         WHERE pi.id_institution = i_id_institution
           AND pi.dt_end_tstz IS NULL
           AND pi.flg_state != 'A'
         ORDER BY pi.id_professional;
    
        IF l_message IS NULL
        THEN
            pk_alertlog.log_warn(g_missing_translation || ' ' || g_todosprofs || ' : lang=' || i_lang, 'PK_BACKOFFICE');
            l_message := ' ';
        ELSE
            -- get line count to insert into message in the first row
            SELECT COUNT(1)
              INTO l_linecount
              FROM prof_profile_template ppt
             INNER JOIN professional p
                ON ppt.id_professional = p.id_professional
             WHERE id_profile_template = i_id_prof_template
               AND id_software = i_id_software
               AND id_institution = i_id_institution
               AND nvl(p.flg_prof_test, pk_alert_constant.get_no) = pk_alert_constant.get_no
               AND p.id_professional NOT IN
                   (SELECT column_value
                      FROM TABLE(CAST(l_inactive_profs AS table_number)));
        
            -- get profile template label
            g_error := 'get profile name';
            BEGIN
                SELECT pk_message.get_message(i_lang, code_profile_template)
                  INTO l_ptname
                  FROM profile_template pt
                 WHERE pt.id_profile_template = i_id_prof_template;
            EXCEPTION
                WHEN no_data_found THEN
                    RAISE l_no_translation;
            END;
        
            -- finalize message that goes like this: all types of scheduling (x)
            -- this message is inserted in the 1st position of the output
            g_error        := 'replace tokens';
            l_replacements := table_varchar(l_ptname, l_linecount);
            l_tokens       := table_varchar('@1', '@2');
            IF NOT pk_schedule.replace_tokens(i_lang         => i_lang,
                                              i_string       => l_message,
                                              i_tokens       => l_tokens,
                                              i_replacements => l_replacements,
                                              o_string       => l_message,
                                              o_error        => l_error)
            THEN
                RAISE my_exception;
            END IF;
        
        END IF;
    
        -- open cursor
        g_error := 'OPEN o_profs';
        OPEN o_profs FOR
            SELECT g_all id_professional,
                   l_message name,
                   NULL nick_name,
                   NULL title,
                   NULL gender,
                   1 order_field,
                   'I' flag_checked
              FROM dual
            UNION
            SELECT p.id_professional, p.name, p.nick_name, p.title, p.gender, 2, 'I' flag_checked
              FROM prof_profile_template ppt
             INNER JOIN professional p
                ON ppt.id_professional = p.id_professional
             WHERE id_profile_template = i_id_prof_template
               AND id_software = i_id_software
               AND id_institution = i_id_institution
               AND nvl(p.flg_prof_test, pk_alert_constant.get_no) = pk_alert_constant.get_no
               AND p.id_professional NOT IN
                   (SELECT column_value
                      FROM TABLE(CAST(l_inactive_profs AS table_number)))
             ORDER BY order_field, name;
        RETURN TRUE;
    
    EXCEPTION
        WHEN l_no_translation THEN
        
            pk_types.open_my_cursor(o_profs);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROFILE_PROFS',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
        WHEN my_exception THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error || ' / ' || l_error.err_desc,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROFILE_PROFS',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_profs);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROFILE_PROFS',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_profile_profs;

    /********************************************************************************************
    * Insert/delete professional alerts
    *
    * @param i_lang                 Preferred language ID
    * @param i_id_professional      Professional ID
    * @param i_id_institution       Institution ID
    * @param i_software             Softwares
    * @param i_profile              Profiles
    * @param i_id_sys_alert         Alerts
    * @param i_id_sys_alert_change  Change in alert
    * @param o_id_sys_alert_prof    Alerts ID's
    * @param o_error                Error
    *
    * @return                   true or false on success or error
    * 
    *
    * @author                   JTS
    * @version                  0.1
    * @since                    2007/12/27
    ********************************************************************************************/
    FUNCTION set_prof_sys_alert
    (
        i_lang                IN language.id_language%TYPE,
        i_id_professional     IN sys_alert_prof.id_professional%TYPE,
        i_id_institution      IN sys_alert_prof.id_institution%TYPE,
        i_software            IN table_number,
        i_profile             IN table_number,
        i_id_sys_alert        IN table_number,
        i_id_sys_alert_change IN table_varchar,
        o_id_sys_alert_prof   OUT table_number,
        o_error               OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_ind       NUMBER := 1;
        l_valid_sap sys_alert_prof.id_sys_alert_prof%TYPE;
        -- 30/05/2011 RMGM [ALERT-181892]
    BEGIN
    
        o_id_sys_alert_prof := table_number();
    
        FOR i IN 1 .. i_software.count
        LOOP
        
            IF i_id_sys_alert_change(i) = 'Y'
            THEN
            
                -- professional alert already configured in software/institution?
                SELECT nvl((SELECT sap.id_sys_alert_prof
                             FROM sys_alert_prof sap
                            WHERE sap.id_sys_alert = i_id_sys_alert(i)
                              AND sap.id_institution = i_id_institution
                              AND sap.id_professional = i_id_professional
                              AND sap.id_software = i_software(i)),
                           0)
                  INTO l_valid_sap
                  FROM dual;
            
                o_id_sys_alert_prof.extend;
            
                IF l_valid_sap = 0
                THEN
                    -- if not then insert
                    g_error := 'GET SEQ_SYS_ALERT_PROF.NEXTVAL';
                    SELECT seq_sys_alert_prof.nextval
                      INTO o_id_sys_alert_prof(l_ind)
                      FROM dual;
                
                    g_error := 'INSERT INTO SYS_ALERT_PROF';
                    INSERT INTO sys_alert_prof
                        (id_sys_alert_prof,
                         id_sys_alert,
                         id_institution,
                         id_professional,
                         id_profile_template,
                         id_software)
                    VALUES
                        (o_id_sys_alert_prof(l_ind),
                         i_id_sys_alert(i),
                         i_id_institution,
                         i_id_professional,
                         i_profile(i),
                         i_software(i));
                
                ELSE
                    -- else update existing alert configuration to proper profile
                    o_id_sys_alert_prof(l_ind) := l_valid_sap;
                    UPDATE sys_alert_prof sap
                       SET sap.id_profile_template = i_profile(i)
                     WHERE sap.id_sys_alert_prof = l_valid_sap;
                END IF;
                l_ind := l_ind + 1;
            ELSE
                g_error := 'DELETE FROM SYS_ALERT_PROF';
                DELETE FROM sys_alert_prof sap
                 WHERE sap.id_institution = i_id_institution
                   AND sap.id_professional = i_id_professional
                   AND sap.id_profile_template = i_profile(i)
                   AND sap.id_sys_alert = i_id_sys_alert(i);
            END IF;
        
        END LOOP;
    
        COMMIT;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_PROF_SYS_ALERT',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END set_prof_sys_alert;

    /********************************************************************************************
    * Get Professional alerts
    *
    * @param i_lang             Preferred language ID
    * @param i_id_institution   Institution ID
    * @param i_id_professional  Professional ID
    * @param o_list             Alerts
    * @param o_error            Error
    *
    * @return                   true or false on success or error
    * 
    *
    * @author                   JTS
    * @version                  0.1
    * @since                    2007/12/27
    ********************************************************************************************/
    FUNCTION get_prof_sys_alert
    (
        i_lang            IN language.id_language%TYPE,
        i_id_institution  IN sys_alert_config.id_institution%TYPE,
        i_id_professional IN sys_alert_prof.id_professional%TYPE,
        o_list            OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
    
        g_error := 'GET CURSOR';
        OPEN o_list FOR
            SELECT sap.id_sys_alert_prof,
                   sap.id_sys_alert,
                   pk_translation.get_translation(i_lang, sa.code_alert) sys_alert,
                   s.id_software,
                   s.name software_name,
                   pt.id_profile_template,
                   pk_message.get_message(i_lang, pt.code_profile_template) profile_name,
                   'A' flg_select
              FROM sys_alert_prof sap, sys_alert sa, software s, profile_template pt
             WHERE sap.id_institution = i_id_institution
               AND sap.id_professional = i_id_professional
               AND sap.id_sys_alert = sa.id_sys_alert
               AND sap.id_software = s.id_software
               AND sap.id_profile_template = pt.id_profile_template
             ORDER BY sys_alert;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_list);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_SYS_ALERT',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_prof_sys_alert;

    /********************************************************************************************
    * Get professional assigned softwares at the facility
    *
    * @param i_lang             Preferred language ID
    * @param i_id_professional  Professional ID
    * @param i_id_institution   Institution ID
    * @param o_prof_list        Softwares
    * @param o_error            Error
    *
    * @return                   true or false on success or error
    * 
    *
    * @author                   JTS
    * @version                  0.1
    * @since                    2007/12/27
    ********************************************************************************************/
    FUNCTION get_assigned_profiles_alerts
    (
        i_lang            IN language.id_language%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        i_id_institution  IN institution.id_institution%TYPE,
        o_prof_list       OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
    
        g_error := 'GET ASSIGNED PROFILES CURSOR';
        OPEN o_prof_list FOR
            SELECT DISTINCT s.id_software, s.name, 'A' flg_select
              FROM software_institution  si,
                   software              s,
                   prof_profile_template ppt,
                   profile_template      pt,
                   sys_alert_prof        sap,
                   sys_alert             sa
             WHERE si.id_institution = i_id_institution
               AND si.id_software = s.id_software
               AND pt.id_software = si.id_software
               AND ppt.id_professional = i_id_professional
               AND ppt.id_institution = si.id_institution
               AND pt.flg_available = g_flg_avail
               AND ppt.id_profile_template = pt.id_profile_template
               AND sap.id_software = si.id_software
               AND sap.id_institution = si.id_institution
               AND sap.id_professional = ppt.id_professional
               AND sap.id_sys_alert = sa.id_sys_alert
            UNION
            SELECT DISTINCT s.id_software, s.name, 'I' flg_select
              FROM software_institution si, software s, prof_profile_template ppt, profile_template pt
             WHERE si.id_institution = i_id_institution
               AND si.id_software = s.id_software
               AND pt.id_software = si.id_software
               AND ppt.id_professional = i_id_professional
               AND ppt.id_institution = si.id_institution
               AND pt.flg_available = g_flg_avail
               AND ppt.id_profile_template = pt.id_profile_template
               AND si.id_software NOT IN (SELECT DISTINCT s.id_software
                                            FROM software_institution  si,
                                                 software              s,
                                                 prof_profile_template ppt,
                                                 profile_template      pt,
                                                 sys_alert_prof        sap,
                                                 sys_alert             sa
                                           WHERE si.id_institution = i_id_institution
                                             AND si.id_software = s.id_software
                                             AND pt.id_software = si.id_software
                                             AND ppt.id_professional = i_id_professional
                                             AND ppt.id_institution = si.id_institution
                                             AND pt.flg_available = g_flg_avail
                                             AND ppt.id_profile_template = pt.id_profile_template
                                             AND sap.id_software = si.id_software
                                             AND sap.id_institution = si.id_institution
                                             AND sap.id_professional = ppt.id_professional
                                             AND sap.id_sys_alert = sa.id_sys_alert)
             ORDER BY name;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_prof_list);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_ASSIGNED_PROFILES_ALERTS',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_assigned_profiles_alerts;

    /********************************************************************************************
    * Get Profiles
    *
    * @param i_lang             Preferred language ID
    * @param i_id_institution   Institution ID
    * @param i_id_software      Software ID
    * @param i_id_professional  Professional ID
    * @param o_templ            Profiles
    * @param o_error            Error
    *
    * @return                   true or false on success or error
    * 
    *
    * @author                   JS
    * @version                  0.1
    * @since                    2008/03/11
    ********************************************************************************************/
    FUNCTION get_prof_profile_alerts
    (
        i_lang            IN language.id_language%TYPE,
        i_id_institution  IN prof_profile_template.id_institution%TYPE,
        i_id_software     IN prof_profile_template.id_software%TYPE,
        i_id_professional IN prof_profile_template.id_professional%TYPE,
        o_templ           OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        g_error := 'GET O_TEMPL';
        OPEN o_templ FOR
            SELECT DISTINCT pt.id_profile_template,
                            pk_message.get_message(i_lang, pt.code_profile_template) profile_name,
                            'A' flg_select
              FROM prof_profile_template ppt, profile_template pt, sys_alert_prof sa, sys_alert_config sac
             WHERE ppt.id_institution = i_id_institution
               AND ppt.id_software = i_id_software
               AND ppt.id_professional = i_id_professional
               AND ppt.id_profile_template = pt.id_profile_template
               AND pt.id_software = ppt.id_software
               AND sac.id_software IN (i_id_software, 0)
               AND sac.id_institution IN (i_id_institution, 0)
               AND sac.id_profile_template IN (ppt.id_profile_template, 0)
               AND sac.id_sys_alert = sa.id_sys_alert
               AND sa.id_professional = ppt.id_professional
               AND sa.id_software = ppt.id_software
               AND sa.id_institution = ppt.id_institution
            UNION
            SELECT DISTINCT pt.id_profile_template,
                            pk_message.get_message(i_lang, pt.code_profile_template) profile_name,
                            'I' flg_select
              FROM prof_profile_template ppt, profile_template pt
             WHERE ppt.id_institution = i_id_institution
               AND ppt.id_software = i_id_software
               AND ppt.id_professional = i_id_professional
               AND ppt.id_profile_template = pt.id_profile_template
               AND pt.id_software = ppt.id_software
               AND ppt.id_profile_template NOT IN
                   (SELECT pt.id_profile_template
                    
                      FROM prof_profile_template ppt, profile_template pt, sys_alert_prof sa2, sys_alert_config sac2
                     WHERE ppt.id_institution = i_id_institution
                       AND ppt.id_software = i_id_software
                       AND ppt.id_professional = i_id_professional
                       AND ppt.id_profile_template = pt.id_profile_template
                       AND pt.id_software = ppt.id_software
                       AND sac2.id_software IN (i_id_software, 0)
                       AND sac2.id_institution IN (i_id_institution, 0)
                       AND sac2.id_profile_template IN (ppt.id_profile_template, 0)
                       AND sac2.id_sys_alert = sa2.id_sys_alert
                       AND sa2.id_professional = ppt.id_professional
                       AND sa2.id_software = ppt.id_software
                       AND sa2.id_institution = ppt.id_institution)
             ORDER BY profile_name;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_templ);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_PROFILE_ALERTS',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_prof_profile_alerts;

    /********************************************************************************************
    * Get Departments and Services tasks
    *
    * @param i_lang         Preferred language ID
    * @param o_list         Tasks
    * @param o_error        Error
    *
    * @return               true or false on success or error
    * 
    *
    * @author               EL
    * @version              0.1
    * @since                2008/01/16
    ********************************************************************************************/
    FUNCTION get_dept_serv_task_list
    (
        i_lang  IN language.id_language%TYPE,
        o_list  OUT pk_types.cursor_type,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET DEPT SERV TASK LIST CURSOR';
        OPEN o_list FOR
        
            SELECT val, desc_val
              FROM sys_domain
             WHERE code_domain = 'DEPT_SERV_ADD_TASK'
               AND domain_owner = pk_sysdomain.k_default_schema
               AND flg_available = g_flg_available
               AND id_language = i_lang
             ORDER BY rank;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_list);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_DEPT_SERV_TASK_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_dept_serv_task_list;

    /********************************************************************************************
    * Get Room State List
    *
    * @param i_lang          Preferred language ID
    * @param o_room_state    State list
    * @param o_error         Error
    *
    * @return                true or false on success or error
    * 
    *
    * @author                JTS
    * @version               0.1
    * @since                 2008/01/16
    ********************************************************************************************/
    FUNCTION get_room_state_list
    (
        i_lang       IN language.id_language%TYPE,
        o_room_state OUT pk_types.cursor_type,
        o_error      OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET SAMPLE_RECIPIENT STATE CURSOR';
        OPEN o_room_state FOR
            SELECT val, desc_val, img_name icon
              FROM sys_domain
             WHERE code_domain = 'ROOM.FLG_AVAILABLE'
               AND domain_owner = pk_sysdomain.k_default_schema
               AND flg_available = g_flg_available
               AND id_language = i_lang
             ORDER BY rank;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_room_state);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_ROOM_STATE_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_room_state_list;

    /********************************************************************************************
    * Get Department Service List 
    *
    * @param i_lang             Preferred language ID
    * @param i_id_dept          Department ID
    * @param o_department_list  Services
    * @param o_error            Error
    *
    * @return                   true or false on success or error
    * 
    *
    * @author                   JTS
    * @version                  0.1
    * @since                    2008/02/07
    ********************************************************************************************/
    FUNCTION get_service_list
    (
        i_lang            IN language.id_language%TYPE,
        i_id_dept         IN dept.id_dept%TYPE,
        o_department_list OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET DEPARTMENT_LIST CURSOR';
        OPEN o_department_list FOR
            SELECT d.id_department id_service,
                   pk_translation.get_translation(i_lang, d.code_department) service_name,
                   d.id_dept,
                   pk_translation.get_translation(i_lang,
                                                  (SELECT code_dept
                                                     FROM dept
                                                    WHERE id_dept = d.id_dept)) dept_name,
                   'A' flg_select,
                   d.flg_priority flg_priority,
                   pk_sysdomain.get_domain('ANALYSIS_REQ_DET.FLG_URGENCY', d.flg_priority, i_lang) desc_priority,
                   d.flg_collection_by collection_by,
                   pk_sysdomain.get_domain('ANALYSIS_INSTIT_SOFT.FLG_COLLECTION_AUTHOR', d.flg_collection_by, i_lang) desc_collection_by
              FROM department d
             WHERE id_dept = i_id_dept
               AND flg_available = g_flg_available
               AND d.id_department IN (SELECT DISTINCT dcs.id_department
                                         FROM dep_clin_serv dcs
                                        WHERE dcs.id_department = d.id_department)
            UNION
            SELECT d.id_department id_service,
                   pk_translation.get_translation(i_lang, d.code_department) service_name,
                   d.id_dept,
                   pk_translation.get_translation(i_lang,
                                                  (SELECT code_dept
                                                     FROM dept
                                                    WHERE id_dept = d.id_dept)) dept_name,
                   'I' flg_select,
                   d.flg_priority flg_priority,
                   pk_sysdomain.get_domain('ANALYSIS_REQ_DET.FLG_URGENCY', d.flg_priority, i_lang) desc_priority,
                   d.flg_collection_by collection_by,
                   pk_sysdomain.get_domain('ANALYSIS_INSTIT_SOFT.FLG_COLLECTION_AUTHOR', d.flg_collection_by, i_lang) desc_collection_by
              FROM department d
             WHERE id_dept = i_id_dept
               AND flg_available = g_flg_available
               AND d.id_department NOT IN (SELECT DISTINCT dcs.id_department
                                             FROM dep_clin_serv dcs
                                            WHERE dcs.id_department = d.id_department)
             ORDER BY flg_select, service_name;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_types.open_my_cursor(o_department_list);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_SERVICE_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_service_list;

    /********************************************************************************************
    * Get Relation(Service/Clinical Service) Information
    *
    * @param i_lang          Preferred language ID
    * @param i_id_dept       Department ID
    * @param i_id_department Service ID
    * @param o_dcs           Clinical services
    * @param o_error         Error
    *
    * @return                true or false on success or error
    * 
    *
    * @author                JTS
    * @version               0.1
    * @since                 2008/02/07
    ********************************************************************************************/
    FUNCTION get_dep_clin_serv_list
    (
        i_lang          IN language.id_language%TYPE,
        i_id_dept       IN dept.id_dept%TYPE,
        i_id_department IN dep_clin_serv.id_department%TYPE,
        o_dcs           OUT pk_types.cursor_type,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET DEP_CLIN_SERV CURSOR';
        OPEN o_dcs FOR
            SELECT dcs.id_dep_clin_serv,
                   cs.id_clinical_service,
                   pk_translation.get_translation(i_lang, cs.code_clinical_service) clinical_service,
                   'A' flg_select,
                   pk_sysdomain.get_domain('BACKOFFICE_ACTIVE', 'A', i_lang) desc_status
              FROM dep_clin_serv dcs, clinical_service cs
             WHERE dcs.id_clinical_service = cs.id_clinical_service
               AND cs.flg_available = g_flg_available
               AND dcs.flg_available = g_flg_available
               AND dcs.id_department = i_id_department
               AND dcs.id_department IN (SELECT DISTINCT s.id_department
                                           FROM department s
                                          WHERE dcs.id_department = s.id_department
                                            AND s.id_dept = i_id_dept)
               AND pk_translation.get_translation(i_lang, cs.code_clinical_service) IS NOT NULL
            UNION
            SELECT NULL id_dep_clin_serv,
                   cs.id_clinical_service,
                   pk_translation.get_translation(i_lang, cs.code_clinical_service) clinical_service,
                   'I' flg_select,
                   pk_sysdomain.get_domain('BACKOFFICE_ACTIVE', 'I', i_lang) desc_status
              FROM clinical_service cs, dep_clin_serv dcs
             WHERE dcs.id_clinical_service = cs.id_clinical_service
               AND cs.flg_available = g_flg_available
               AND dcs.flg_available = g_flg_available
               AND dcs.id_clinical_service NOT IN
                   (SELECT dcs2.id_clinical_service
                      FROM dep_clin_serv dcs2, clinical_service cs2
                     WHERE dcs2.id_clinical_service = cs2.id_clinical_service
                       AND cs2.flg_available = g_flg_available
                       AND dcs2.flg_available = g_flg_available
                       AND dcs2.id_department = i_id_department
                       AND dcs2.id_department IN (SELECT DISTINCT s2.id_department
                                                    FROM department s2
                                                   WHERE dcs2.id_department = s2.id_department
                                                     AND s2.id_dept = i_id_dept))
               AND pk_translation.get_translation(i_lang, cs.code_clinical_service) IS NOT NULL
            --
            UNION
            SELECT NULL id_dep_clin_serv,
                   cs.id_clinical_service,
                   pk_translation.get_translation(i_lang, cs.code_clinical_service) clinical_service,
                   'I' flg_select,
                   pk_sysdomain.get_domain('BACKOFFICE_ACTIVE', 'I', i_lang) desc_status
              FROM clinical_service cs
             WHERE cs.id_clinical_service NOT IN
                   (SELECT dcs2.id_clinical_service
                      FROM dep_clin_serv dcs2, clinical_service cs2
                     WHERE dcs2.id_clinical_service = cs2.id_clinical_service
                       AND cs2.flg_available = g_flg_available
                       AND dcs2.flg_available = g_flg_available
                       AND dcs2.id_department = i_id_department
                       AND dcs2.id_department IN (SELECT DISTINCT s2.id_department
                                                    FROM department s2
                                                   WHERE dcs2.id_department = s2.id_department
                                                     AND s2.id_dept = i_id_dept))
               AND cs.flg_available = g_flg_available
               AND pk_translation.get_translation(i_lang, cs.code_clinical_service) IS NOT NULL
            --
             ORDER BY flg_select, clinical_service;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_dcs);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_DEP_CLIN_SERV_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_dep_clin_serv_list;

    /********************************************************************************************
    * Set professional accounts information
    *
    * @param i_lang                  Preferred language ID
    * @param i_id_professional       Professional ID
    * @param i_accounts              Account ID's Array
    * @param i_accounts_values       Account Values Array
    * @param o_error                 Error
    *
    * @return                        true or false on success or error
    * 
    *
    * @author                        JTS
    * @version                       0.1
    * @since                         2008/05/26
    ********************************************************************************************/
    FUNCTION set_prof_accounts
    (
        i_lang            IN language.id_language%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        i_accounts        IN table_number,
        i_accounts_values IN table_varchar,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_PROF_ACCOUNTS',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END set_prof_accounts;

    /********************************************************************************************
    * Get professional accounts information
    *
    * @param i_lang                  Preferred language ID
    * @param i_id_professional       Professional ID
    * @param i_id_institution        Institution
    * @param o_prof_accounts         Professional affiliations
    * @param o_error                 Error
    *
    * @return                        true or false on success or error
    * 
    *
    * @author                        JTS
    * @version                       0.1
    * @since                         2009/09/22
    ********************************************************************************************/
    FUNCTION get_prof_accounts
    (
        i_lang            IN language.id_language%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        i_id_institution  IN institution.id_institution%TYPE,
        o_prof_accounts   OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_error_out t_error_out;
        l_exception EXCEPTION;
    
        l_id_category prof_cat.id_category%TYPE;
    
    BEGIN
    
        g_error := 'GET PROFESSIONAL CATEGORY: ID_PROFESSIONAL = ' || i_id_professional;
        pk_alertlog.log_debug('PK_BACKOFFICE.GET_PROF_ACCOUNTS: ' || g_error);
        SELECT nvl((SELECT pcat.id_category
                     FROM prof_cat pcat
                    WHERE pcat.id_professional = i_id_professional
                      AND pcat.id_institution = i_id_institution),
                   0)
          INTO l_id_category
          FROM dual;
    
        IF l_id_category != 0
        THEN
        
            IF NOT get_prof_cat_affiliations(i_lang,
                                             i_id_professional,
                                             l_id_category,
                                             i_id_institution,
                                             o_prof_accounts,
                                             l_error_out)
            THEN
                RAISE l_exception;
            END IF;
        
        ELSE
        
            pk_types.open_my_cursor(o_prof_accounts);
        
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN l_exception THEN
            pk_types.open_my_cursor(o_prof_accounts);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error || ' / ' || l_error_out.err_desc,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_ACCOUNTS',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
        WHEN OTHERS THEN
            pk_types.open_my_cursor(o_prof_accounts);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_ACCOUNTS',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_prof_accounts;

    /********************************************************************************************
    * Departmwent Room list
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_institution        Institution ID
    * @param i_id_department         Service ID
    * @param o_room_list             Room List
    * @param o_error                 Error
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      JTS
    * @version                     0.1
    * @since                       2008/05/28
    ********************************************************************************************/
    FUNCTION get_room_list
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        i_id_department  IN department.id_department%TYPE,
        o_room_list      OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET ROOM_LIST CURSOR';
        OPEN o_room_list FOR
            SELECT 0 id_room, pk_message.get_message(i_lang, 'ADMINISTRATOR_T076') room_name
              FROM dual
            UNION
            SELECT r.id_room id_room, nvl(r.desc_room, pk_translation.get_translation(i_lang, r.code_room)) room_name
              FROM room r, department s
             WHERE r.id_department = s.id_department
               AND s.id_institution = i_id_institution
               AND s.id_department = i_id_department
             ORDER BY room_name;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_types.open_my_cursor(o_room_list);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_ROOM_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_room_list;

    /********************************************************************************************
    * USF list
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_institution        Institution ID
    * @param o_list                  USF List
    * @param o_error                 Error
    *
    *
    * @return                        true or false on success or error
    *
    * @author                        JTS
    * @version                       0.1
    * @since                         2008/05/30
    ********************************************************************************************/
    FUNCTION get_usf_list
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        o_list           OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET ROOM_LIST CURSOR';
        OPEN o_list FOR
            SELECT i.id_institution id_usf, pk_translation.get_translation(i_lang, i.code_institution) usf_name
              FROM institution i
             WHERE i.id_institution = i_id_institution
               AND i.flg_available = g_flg_available
             ORDER BY usf_name;
        NULL;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_types.open_my_cursor(o_list);
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_USF_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_usf_list;

    /********************************************************************************************
    * USF Teams list
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_usf                USF ID
    * @param i_id_professional       Professional ID
    * @param o_list                  USF List
    * @param o_error                 Error
    *
    *
    * @return                        true or false on success or error
    *
    * @author                        JTS
    * @version                       0.1
    * @since                         2008/05/30
    ********************************************************************************************/
    FUNCTION get_usf_team_list
    (
        i_lang   IN language.id_language%TYPE,
        i_id_usf IN institution.id_institution%TYPE,
        
        i_id_professional IN prof_team_det.id_professional%TYPE,
        o_list            OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_cat category.id_category%TYPE;
    
    BEGIN
    
        SELECT nvl((SELECT DISTINCT pc.id_category
                     FROM prof_team pt, prof_team_category ptc, prof_cat pc
                    WHERE pt.id_institution = i_id_usf
                      AND pt.id_prof_team = ptc.id_prof_team
                      AND ptc.id_category = pc.id_category
                      AND pc.id_professional = i_id_professional),
                   0)
          INTO l_cat
          FROM dual;
    
        g_error := 'GET ROOM_LIST CURSOR';
        OPEN o_list FOR
            SELECT pt.id_prof_team,
                   pt.prof_team_name,
                   nvl((SELECT ptd.flg_status
                         FROM prof_team_det ptd
                        WHERE ptd.id_prof_team = pt.id_prof_team
                          AND ptd.id_professional = i_id_professional),
                       'I') flg_select
              FROM prof_team pt
             WHERE pt.id_institution = i_id_usf
               AND pt.flg_available = g_flg_available
               AND pt.flg_status = 'A'
               AND l_cat IN (SELECT DISTINCT ptc.id_category
                               FROM prof_team_category ptc
                              WHERE ptc.id_prof_team = pt.id_prof_team);
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_list);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_USF_TEAM_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_usf_team_list;

    /********************************************************************************************
    * USF Team detail
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_usf                USF ID
    * @param i_id_prof_team          USF team ID
    * @param i_id_professional       Professional ID
    * @param o_usf_team_cat_list     USF Categoey List
    * @param o_usf_team_prof_list    USF Team members
    * @param o_error                 Error
    *
    *
    * @return                        true or false on success or error
    *
    * @author                        JTS
    * @version                       0.1
    * @since                         2008/05/30
    ********************************************************************************************/
    FUNCTION get_usf_team_detail
    (
        i_lang               IN language.id_language%TYPE,
        i_id_usf             IN institution.id_institution%TYPE,
        i_id_prof_team       IN prof_team_det.id_prof_team%TYPE,
        i_id_professional    IN professional.id_professional%TYPE,
        o_usf_team_cat_list  OUT pk_types.cursor_type,
        o_usf_team_prof_list OUT pk_types.cursor_type,
        o_error              OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET USF_TEAM_CAT_LIST CURSOR';
        OPEN o_usf_team_cat_list FOR
            SELECT DISTINCT c.id_category, pk_translation.get_translation(i_lang, c.code_category) category_desc
              FROM prof_team pt, prof_team_category ptc, category c
             WHERE pt.id_institution = i_id_usf
               AND pt.id_prof_team = i_id_prof_team
               AND pt.id_prof_team = ptc.id_prof_team
               AND ptc.id_category = c.id_category;
    
        IF i_id_professional IS NULL
        THEN
            g_error := 'GET USF_TEAM_PROF_LIST CURSOR';
            OPEN o_usf_team_prof_list FOR
                SELECT DISTINCT p.id_professional, p.name, pc.id_category
                  FROM prof_team pt, prof_team_det ptd, prof_cat pc, professional p
                 WHERE pt.id_institution = i_id_usf
                   AND pt.id_prof_team = i_id_prof_team
                   AND pt.id_prof_team = ptd.id_prof_team
                   AND ptd.id_professional = p.id_professional
                   AND p.id_professional = pc.id_professional
                   AND nvl(p.flg_prof_test, pk_alert_constant.get_no) = pk_alert_constant.get_no;
        
        ELSE
            g_error := 'GET USF_TEAM_PROF_LIST CURSOR';
            OPEN o_usf_team_prof_list FOR
                SELECT DISTINCT p.id_professional, p.name, pc.id_category
                  FROM prof_team pt, prof_team_det ptd, prof_cat pc, professional p
                 WHERE pt.id_institution = i_id_usf
                   AND pt.id_prof_team = i_id_prof_team
                   AND pt.id_prof_team = ptd.id_prof_team
                   AND ptd.id_professional = p.id_professional
                   AND p.id_professional = pc.id_professional
                   AND nvl(p.flg_prof_test, pk_alert_constant.get_no) = pk_alert_constant.get_no
                UNION
                SELECT DISTINCT p.id_professional, p.name, pc.id_category
                  FROM professional p, prof_cat pc
                 WHERE p.id_professional = i_id_professional
                   AND nvl(p.flg_prof_test, pk_alert_constant.get_no) = pk_alert_constant.get_no
                   AND pc.id_professional = p.id_professional
                   AND pc.id_category IN (SELECT DISTINCT c2.id_category
                                            FROM prof_team pt2, prof_team_category ptc2, category c2
                                           WHERE pt2.id_institution = i_id_usf
                                             AND pt2.id_prof_team = i_id_prof_team
                                             AND pt2.id_prof_team = ptc2.id_prof_team
                                             AND ptc2.id_category = c2.id_category);
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_usf_team_cat_list);
            pk_types.open_my_cursor(o_usf_team_prof_list);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_USF_TEAM_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_usf_team_detail;

    /********************************************************************************************
    * Set professional teams information
    *
    * @param i_lang                  Preferred language ID
    * @param i_id_professional       Professional ID
    * @param i_prof_teams            Team ID's Array
    * @param i_select                Selected Value Array
    * @param o_error                 Error
    *
    * @return                        true or false on success or error
    * 
    *
    * @author                        JTS
    * @version                       0.1
    * @since                         2008/05/30
    ********************************************************************************************/
    FUNCTION set_prof_usf_teams
    (
        i_lang            IN language.id_language%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        i_prof_teams      IN table_number,
        i_select          IN table_varchar,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_id_prof_team_det prof_team_det.id_prof_team_det%TYPE;
    
    BEGIN
    
        g_error := 'INSERT INTO PROF_ACCOUNTS';
        FOR i IN 1 .. i_prof_teams.count
        LOOP
            IF i_select(i) = 'Y'
            THEN
                g_error := 'GET SEQ_PROF_TEAM_DET.NEXTVAL';
                SELECT seq_prof_team_det.nextval
                  INTO l_id_prof_team_det
                  FROM dual;
            
                g_error := 'INSERT INTO PROF_TEAM_DET';
                INSERT INTO prof_team_det
                    (id_prof_team_det,
                     id_prof_team,
                     id_professional,
                     flg_available,
                     --adw_last_update,
                     flg_status)
                VALUES
                    (l_id_prof_team_det,
                     i_prof_teams(i),
                     i_id_professional,
                     'Y',
                     --SYSDATE,
                     'A');
            ELSE
                g_error := 'DELETE FROM PROF_TEAM_DET';
                DELETE FROM prof_team_det ptd
                 WHERE ptd.id_prof_team = i_prof_teams(i)
                   AND ptd.id_professional = i_id_professional;
            END IF;
        
        END LOOP;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_PROF_USF_TEAMS',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END set_prof_usf_teams;

    /********************************************************************************************
    * Institution Team list
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_institution        Institution ID
    * @param o_list                  USF List
    * @param o_error                 Error
    *
    *
    * @return                        true or false on success or error
    *
    * @author                        JTS
    * @version                       0.1
    * @since                         2008/05/31
    ********************************************************************************************/
    FUNCTION get_inst_team_list
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        o_list           OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET ROOM_LIST CURSOR';
        OPEN o_list FOR
            SELECT i.id_institution id_usf,
                   pk_translation.get_translation(i_lang, i.code_institution) usf_name,
                   pt.id_prof_team,
                   pt.prof_team_name,
                   (SELECT COUNT(ptd.id_professional)
                      FROM prof_team_det ptd
                     WHERE ptd.id_prof_team = pt.id_prof_team) elem_num,
                   pt.flg_status
              FROM institution i, prof_team pt
             WHERE i.id_institution = i_id_institution
               AND pt.id_institution = i.id_institution
               AND pt.flg_type = 'C'
               AND pt.id_prof_team NOT IN (SELECT pt2.id_prof_team_old
                                             FROM prof_team pt2
                                            WHERE pt2.id_prof_team_old IS NOT NULL)
             ORDER BY usf_name, prof_team_name;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_list);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_INST_TEAM_LIST',
                                              o_error);
        
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_inst_team_list;

    /********************************************************************************************
    * USF Team Detail
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_prof_team          Team ID
    * @param o_team                  Team information
    * @param o_team_cat              Team categories list
    * @param o_team_prof             Team professionals list
    * @param o_team_spec             Team specialties list
    * @param o_error                 Error
    *
    *
    * @return                        true or false on success or error
    *
    * @author                        JTS
    * @version                       0.1
    * @since                         2008/06/01
    ********************************************************************************************/
    FUNCTION get_usf_team
    (
        i_lang         IN language.id_language%TYPE,
        i_id_prof_team IN prof_team.id_prof_team%TYPE,
        o_team         OUT pk_types.cursor_type,
        o_team_cat     OUT pk_types.cursor_type,
        o_team_prof    OUT pk_types.cursor_type,
        o_team_spec    OUT pk_types.cursor_type,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_institution institution.id_institution%TYPE;
    
    BEGIN
    
        SELECT pt.id_institution
          INTO l_institution
          FROM prof_team pt
         WHERE pt.id_prof_team = i_id_prof_team;
    
        g_error := 'GET TEAM LIST CURSOR';
        OPEN o_team FOR
            SELECT i.id_institution id_usf,
                   pk_translation.get_translation(i_lang, i.code_institution) usf_name,
                   pt.id_prof_team,
                   pt.prof_team_name team_name,
                   pk_utils.query_to_string('SELECT 
                   pk_translation.get_translation(' || i_lang ||
                                            ', c2.code_category) category_desc
        FROM prof_team_category ptc2, category c2
        where ptc2.id_prof_team = ' || pt.id_prof_team || '
        AND ptc2.id_category = c2.id_category
                   ',
                                            ',') categories,
                   pk_utils.query_to_string('
                    SELECT pk_translation.get_translation(' || i_lang ||
                                            ', cs2.code_clinical_service)
                    FROM prof_team_clin_serv ptcs2, clinical_service cs2
                    WHERE ptcs2.id_prof_team = ' || pt.id_prof_team || '
                    AND ptcs2.id_clinical_service = cs2.id_clinical_service
                    AND cs2.flg_available = ''Y''',
                                            ', ') specialties,
                   pk_utils.query_to_string('
                   SELECT p3.name || '', '' || pk_translation.get_translation(' ||
                                            i_lang || '
                   , c3.code_category)
              FROM prof_team pt3, prof_team_det ptd3, professional p3, prof_cat pc3, category c3
             WHERE pt3.id_prof_team = ' || pt.id_prof_team || '
             AND ptd3.id_prof_team = pt3.id_prof_team
               AND pt3.id_institution = ' || l_institution || '
               AND ptd3.id_professional = p3.id_professional
               AND p3.id_professional = pc3.id_professional
               AND nvl(p3.flg_prof_test, pk_alert_constant.get_no) = pk_alert_constant.get_no
               AND pc3.id_category = c3.id_category
               AND pc3.id_institution = pt3.id_institution',
                                            ';') professionals
              FROM institution i, prof_team pt
             WHERE pt.id_prof_team = i_id_prof_team
               AND pt.id_institution = i.id_institution;
    
        g_error := 'GET TEAM CATEGORY LIST CURSOR';
        OPEN o_team_cat FOR
            SELECT c.id_category, pk_translation.get_translation(i_lang, c.code_category) category_desc
              FROM prof_team_category ptc, category c
             WHERE ptc.id_prof_team = i_id_prof_team
               AND ptc.id_category = c.id_category;
    
        g_error := 'GET TEAM PROFESSIONALS LIST CURSOR';
        OPEN o_team_prof FOR
            SELECT p.id_professional,
                   p.name,
                   c.id_category,
                   pk_translation.get_translation(i_lang, c.code_category) category_desc,
                   pk_utils.query_to_string('
                   select ptcs.id_clinical_service
                   from prof_team_clin_serv ptcs,
                   clinical_service    cs,
                   prof_dep_clin_serv pdcs,
                   dep_clin_serv dcs,
                   prof_team_det ptd2
                   where ptcs.id_prof_team = ' || i_id_prof_team || '
               AND ptcs.id_clinical_service = cs.id_clinical_service
               AND cs.flg_available = ''Y''
               AND ptcs.id_prof_team = ptd2.id_prof_team
               AND ptd2.id_professional = ' || p.id_professional || '
               AND pdcs.id_professional = ptd2.id_professional
               AND pdcs.id_dep_clin_serv = dcs.id_dep_clin_serv
               AND dcs.id_clinical_service = cs.id_clinical_service
               ',
                                            ',') id_clinical_service
              FROM prof_team pt, prof_team_det ptd, professional p, prof_cat pc, category c
             WHERE pt.id_prof_team = i_id_prof_team
               AND ptd.id_prof_team = pt.id_prof_team
               AND pt.id_institution = l_institution
               AND ptd.id_professional = p.id_professional
               AND p.id_professional = pc.id_professional
               AND nvl(p.flg_prof_test, pk_alert_constant.get_no) = pk_alert_constant.get_no
               AND pc.id_category = c.id_category
               AND pc.id_institution = pt.id_institution;
    
        g_error := 'GET TEAM SPECIALTIES LIST CURSOR';
        OPEN o_team_spec FOR
            SELECT cs.id_clinical_service,
                   pk_translation.get_translation(i_lang, cs.code_clinical_service) clinical_service_name
              FROM prof_team_clin_serv ptcs, clinical_service cs
             WHERE ptcs.id_prof_team = i_id_prof_team
               AND ptcs.id_clinical_service = cs.id_clinical_service
               AND cs.flg_available = 'Y';
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_team);
            pk_types.open_my_cursor(o_team_cat);
            pk_types.open_my_cursor(o_team_prof);
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_USF_TEAM',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_usf_team;

    /********************************************************************************************
    * USF Professionals list
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_institution        Institution ID
    * @param i_id_prof_team          Team ID
    * @param i_categories            Array of Categories ID's
    * @param i_spec                  Array of specialties ID's
    * @param i_search                Professional search
    * @param o_prof                  Professionals list
    * @param o_error                 Error
    *
    *
    * @return                        true or false on success or error
    *
    * @author                        JTS
    * @version                       0.1
    * @since                         2008/06/01
    ********************************************************************************************/
    FUNCTION get_usf_prof_list
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        i_id_prof_team   IN prof_team.id_prof_team%TYPE,
        i_categories     IN table_number,
        i_spec           IN table_number,
        i_search         IN VARCHAR2,
        o_prof           OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        IF i_id_prof_team IS NULL
        THEN
            g_error := 'GET TEAM LIST CURSOR';
            OPEN o_prof FOR
                SELECT DISTINCT p.id_professional,
                                get_prof_photo_url(i_lang, p.id_professional) photo,
                                p.name,
                                c.id_category,
                                pk_translation.get_translation(i_lang, c.code_category) category_desc,
                                'N' flg_select,
                                pk_utils.query_to_string('
                                                    select distinct dcs.id_clinical_service
                                                    from prof_dep_clin_serv pdcs2, dep_clin_serv dcs
                                                    where pdcs2.id_professional = ' ||
                                                         p.id_professional || '
                                                    and pdcs2.id_dep_clin_serv = dcs.id_dep_clin_serv
                                                    and pdcs2.id_institution = ' ||
                                                         pi.id_institution || '
                                                    ',
                                                         ',') id_clinical_service
                  FROM professional p, prof_institution pi, prof_cat pc, category c, prof_dep_clin_serv pdcs
                 WHERE pi.id_institution = i_id_institution
                   AND p.id_professional = pi.id_professional
                   AND pk_prof_utils.is_internal_prof(i_lang,
                                                      profissional(0, 0, 0),
                                                      p.id_professional,
                                                      i_id_institution) = pk_alert_constant.get_yes
                   AND pi.flg_state = 'A'
                   AND pc.id_professional = p.id_professional
                   AND pc.id_institution = i_id_institution
                   AND c.id_category = pc.id_category
                   AND c.id_category IN (SELECT column_value
                                           FROM TABLE(CAST(i_categories AS table_number)))
                   AND pdcs.id_professional = p.id_professional
                   AND pdcs.id_institution = pi.id_institution
                   AND pdcs.id_dep_clin_serv IN
                       (SELECT DISTINCT dcs.id_dep_clin_serv
                          FROM dep_clin_serv dcs, department s, clinical_service cs
                         WHERE dcs.id_department = s.id_department
                           AND s.id_institution = pdcs.id_institution
                           AND s.flg_type = 'C'
                           AND dcs.id_clinical_service = cs.id_clinical_service
                           AND cs.flg_available = 'Y'
                           AND cs.id_clinical_service IN
                               (SELECT column_value
                                  FROM TABLE(CAST(i_spec AS table_number))));
        ELSE
        
            g_error := 'GET TEAM LIST CURSOR';
            OPEN o_prof FOR
                SELECT DISTINCT p.id_professional,
                                get_prof_photo_url(i_lang, p.id_professional) photo,
                                p.name,
                                c.id_category,
                                pk_translation.get_translation(i_lang, c.code_category) category_desc,
                                'Y' flg_select,
                                pk_utils.query_to_string('
                                                    select distinct dcs.id_clinical_service
                                                    from prof_dep_clin_serv pdcs2, dep_clin_serv dcs
                                                    where pdcs2.id_professional = ' ||
                                                         p.id_professional || '
                                                    and pdcs2.id_dep_clin_serv = dcs.id_dep_clin_serv
                                                    and pdcs2.id_institution = ' ||
                                                         pc.id_institution || '
                                                    ',
                                                         ',') id_clinical_service
                  FROM prof_team          pt,
                       prof_team_det      ptd,
                       professional       p,
                       prof_cat           pc,
                       category           c,
                       prof_dep_clin_serv pdcs
                 WHERE pt.id_prof_team = i_id_prof_team
                   AND ptd.id_prof_team = pt.id_prof_team
                   AND ptd.id_professional = p.id_professional
                   AND pc.id_professional = p.id_professional
                   AND pk_prof_utils.is_internal_prof(i_lang,
                                                      profissional(0, 0, 0),
                                                      p.id_professional,
                                                      i_id_institution) = pk_alert_constant.get_yes
                   AND pc.id_institution = i_id_institution
                   AND c.id_category = pc.id_category
                   AND c.id_category IN (SELECT column_value
                                           FROM TABLE(CAST(i_categories AS table_number)))
                   AND pdcs.id_professional = p.id_professional
                   AND pdcs.id_institution = i_id_institution
                   AND pdcs.id_dep_clin_serv IN
                       (SELECT DISTINCT dcs.id_dep_clin_serv
                          FROM dep_clin_serv dcs, department s, clinical_service cs
                         WHERE dcs.id_department = s.id_department
                           AND s.id_institution = pdcs.id_institution
                           AND s.flg_type = 'C'
                           AND dcs.id_clinical_service = cs.id_clinical_service
                           AND cs.flg_available = 'Y'
                           AND cs.id_clinical_service IN
                               (SELECT column_value
                                  FROM TABLE(CAST(i_spec AS table_number))))
                UNION
                SELECT DISTINCT p.id_professional,
                                get_prof_photo_url(i_lang, p.id_professional) photo,
                                p.name,
                                c.id_category,
                                pk_translation.get_translation(i_lang, c.code_category) category_desc,
                                'N' flg_select,
                                pk_utils.query_to_string('
                                                    select distinct dcs.id_clinical_service
                                                    from prof_dep_clin_serv pdcs2, dep_clin_serv dcs
                                                    where pdcs2.id_professional = ' ||
                                                         p.id_professional || '
                                                    and pdcs2.id_dep_clin_serv = dcs.id_dep_clin_serv
                                                    and pdcs2.id_institution = ' ||
                                                         pi.id_institution || '
                                                    ',
                                                         ',') id_clinical_service
                  FROM professional p, prof_institution pi, prof_cat pc, category c, prof_dep_clin_serv pdcs
                 WHERE pi.id_institution = i_id_institution
                   AND p.id_professional = pi.id_professional
                   AND pk_prof_utils.is_internal_prof(i_lang,
                                                      profissional(0, 0, 0),
                                                      p.id_professional,
                                                      i_id_institution) = pk_alert_constant.get_yes
                   AND pi.flg_state = 'A'
                   AND pi.id_professional NOT IN
                       (SELECT p2.id_professional
                          FROM prof_team pt2, prof_team_det ptd2, professional p2, prof_cat pc2, category c2
                         WHERE pt2.id_prof_team = i_id_prof_team
                           AND ptd2.id_prof_team = pt2.id_prof_team
                           AND ptd2.id_professional = p2.id_professional
                           AND pc2.id_professional = p2.id_professional
                           AND nvl(p2.flg_prof_test, pk_alert_constant.g_no) = pk_alert_constant.g_no
                           AND pc2.id_institution = i_id_institution
                           AND c2.id_category = pc2.id_category
                           AND c2.id_category IN (SELECT column_value
                                                    FROM TABLE(CAST(i_categories AS table_number))))
                   AND pc.id_professional = p.id_professional
                   AND pc.id_institution = i_id_institution
                   AND c.id_category = pc.id_category
                   AND c.id_category IN (SELECT column_value
                                           FROM TABLE(CAST(i_categories AS table_number)))
                   AND pdcs.id_professional = p.id_professional
                   AND pdcs.id_institution = pi.id_institution
                   AND pdcs.id_dep_clin_serv IN
                       (SELECT DISTINCT dcs.id_dep_clin_serv
                          FROM dep_clin_serv dcs, department s, clinical_service cs
                         WHERE dcs.id_department = s.id_department
                           AND s.id_institution = pdcs.id_institution
                           AND s.flg_type = 'C'
                           AND dcs.id_clinical_service = cs.id_clinical_service
                           AND cs.flg_available = 'Y'
                           AND cs.id_clinical_service IN
                               (SELECT column_value
                                  FROM TABLE(CAST(i_spec AS table_number))));
        
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_types.open_my_cursor(o_prof);
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_USF_PROF_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_usf_prof_list;

    /********************************************************************************************
    * Create/Edit Team
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_prof_team          Team ID
    * @param i_id_usf                USF ID
    * @param i_prof_team_name        Prof team name
    * @param i_categories            Array with team categories
    * @param i_categries_select      Array with team categories selection
    * @param i_prof                  Array with professional ID's
    * @param i_prof_select           Array with professional selection
    * @param i_spec                  Array with specialties ID's
    * @param i_spec_select           Array with specialties selection
    * @param o_id_prof_team          Prof Team ID
    * @param o_error                 Error
    *
    *
    * @return                        true or false on success or error
    *
    * @author                        JTS
    * @version                       0.1
    * @since                         2008/06/01
    ********************************************************************************************/
    FUNCTION set_usf_team
    (
        i_lang             IN language.id_language%TYPE,
        i_id_prof_team     IN prof_team.id_prof_team%TYPE,
        i_id_usf           IN institution.id_institution%TYPE,
        i_prof_team_name   IN prof_team.prof_team_name%TYPE,
        i_categories       IN table_number,
        i_categries_select IN table_varchar,
        i_prof             IN table_number,
        i_prof_select      IN table_varchar,
        i_spec             IN table_number,
        i_spec_select      IN table_varchar,
        o_id_prof_team     OUT prof_team.id_prof_team%TYPE,
        o_error            OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_institution   institution.id_institution%TYPE;
        l_prof_team_det prof_team_det.id_prof_team_det%TYPE;
        l_res           BOOLEAN;
        l_prof          table_number;
        l_prof_select   table_varchar;
        l_cat           table_number;
        l_cat_select    table_varchar;
        l_spec          table_number;
        l_spec_select   table_varchar;
    
        CURSOR c_prof(c_id_prof_team IN prof_team_det.id_prof_team%TYPE) IS(
            SELECT ptd.id_professional id_prof, g_status_a status
              FROM prof_team_det ptd
             WHERE ptd.id_prof_team = c_id_prof_team
            UNION
            SELECT column_value id_prof, g_status_a status
              FROM TABLE(CAST(i_prof AS table_number)) prof
             WHERE prof.column_value IN (SELECT prof2.column_value
                                           FROM (SELECT column_value, rownum rn
                                                   FROM TABLE(CAST(i_prof_select AS table_varchar))) prof_select,
                                                (SELECT column_value, rownum rn
                                                   FROM TABLE(CAST(i_prof AS table_number))) prof2
                                          WHERE prof_select.rn = prof2.rn
                                            AND prof_select.column_value = g_status_a))
            MINUS
            SELECT column_value id_prof, g_status_a status
              FROM TABLE(CAST(i_prof AS table_number)) prof
             WHERE prof.column_value IN (SELECT prof2.column_value
                                           FROM (SELECT column_value, rownum rn
                                                   FROM TABLE(CAST(i_prof_select AS table_varchar))) prof_select,
                                                (SELECT column_value, rownum rn
                                                   FROM TABLE(CAST(i_prof AS table_number))) prof2
                                          WHERE prof_select.rn = prof2.rn
                                            AND prof_select.column_value = g_status_i);
    
        CURSOR c_cat(c_id_prof_team IN prof_team_category.id_prof_team%TYPE) IS(
            SELECT ptc.id_category id_cat, g_status_a status
              FROM prof_team_category ptc
             WHERE ptc.id_prof_team = c_id_prof_team
            UNION
            SELECT column_value id_cat, g_status_a status
              FROM TABLE(CAST(i_categories AS table_number)) cat
             WHERE cat.column_value IN (SELECT cat2.column_value
                                          FROM (SELECT column_value, rownum rn
                                                  FROM TABLE(CAST(i_categries_select AS table_varchar))) cat_select,
                                               (SELECT column_value, rownum rn
                                                  FROM TABLE(CAST(i_categories AS table_number))) cat2
                                         WHERE cat_select.rn = cat2.rn
                                           AND cat_select.column_value = g_status_a))
            MINUS
            SELECT column_value, g_status_a status
              FROM TABLE(CAST(i_categories AS table_number)) cat
             WHERE cat.column_value IN (SELECT cat2.column_value
                                          FROM (SELECT column_value, rownum rn
                                                  FROM TABLE(CAST(i_categries_select AS table_varchar))) cat_select,
                                               (SELECT column_value, rownum rn
                                                  FROM TABLE(CAST(i_categories AS table_number))) cat2
                                         WHERE cat_select.rn = cat2.rn
                                           AND cat_select.column_value = g_status_i);
    
        CURSOR c_spec(c_id_prof_team IN prof_team_clin_serv.id_prof_team%TYPE) IS(
            SELECT ptcs.id_clinical_service id_clin_serv, g_status_a status
              FROM prof_team_clin_serv ptcs
             WHERE ptcs.id_prof_team = c_id_prof_team
            UNION
            SELECT column_value id_clin_serv, g_status_a status
              FROM TABLE(CAST(i_spec AS table_number)) spec
             WHERE spec.column_value IN (SELECT spec2.column_value
                                           FROM (SELECT column_value, rownum rn
                                                   FROM TABLE(CAST(i_spec_select AS table_varchar))) spec_select,
                                                (SELECT column_value, rownum rn
                                                   FROM TABLE(CAST(i_spec AS table_number))) spec2
                                          WHERE spec_select.rn = spec2.rn
                                            AND spec_select.column_value = g_status_a))
            MINUS
            SELECT column_value id_clin_serv, g_status_a status
              FROM TABLE(CAST(i_spec AS table_number)) spec
             WHERE spec.column_value IN (SELECT spec2.column_value
                                           FROM (SELECT column_value, rownum rn
                                                   FROM TABLE(CAST(i_spec_select AS table_varchar))) spec_select,
                                                (SELECT column_value, rownum rn
                                                   FROM TABLE(CAST(i_spec AS table_number))) spec2
                                          WHERE spec_select.rn = spec2.rn
                                            AND spec_select.column_value = g_status_i);
    BEGIN
    
        IF i_id_prof_team IS NULL
        THEN
            g_error := 'GET SEQ_PROF_TEAM.NEXTVAL';
            SELECT seq_prof_team.nextval
              INTO o_id_prof_team
              FROM dual;
        
            g_error := 'INSERT INTO PROF_TEAM';
            INSERT INTO prof_team
                (id_prof_team, prof_team_name, flg_available, flg_status, id_institution, flg_type, dt_begin_tstz)
            VALUES
                (o_id_prof_team, i_prof_team_name, 'Y', 'A', i_id_usf, 'C', g_sysdate_tstz);
        
            FOR i IN 1 .. i_categories.count
            LOOP
                g_error := 'INSERT INTO PROF_TEAM_CATEGORY';
                INSERT INTO prof_team_category
                    (id_prof_team, id_category)
                VALUES
                    (o_id_prof_team, i_categories(i));
            END LOOP;
        
            FOR j IN 1 .. i_prof.count
            LOOP
                g_error := 'GET SEQ_PROF_TEAM_DET.NEXTVAL';
                SELECT seq_prof_team_det.nextval
                  INTO l_prof_team_det
                  FROM dual;
            
                g_error := 'INSERT INTO PROF_TEAM_DET';
                INSERT INTO prof_team_det
                    (id_prof_team_det, id_prof_team, id_professional, flg_available, flg_status)
                VALUES
                    (l_prof_team_det, o_id_prof_team, i_prof(j), 'Y', 'A');
            END LOOP;
        
            FOR k IN 1 .. i_spec.count
            LOOP
                g_error := 'INSERT INTO PROF_TEAM_CLIN_SERV';
                INSERT INTO prof_team_clin_serv
                    (id_prof_team, id_clinical_service)
                VALUES
                    (o_id_prof_team, i_spec(k));
            END LOOP;
        
        ELSE
        
            g_error := 'UPDATE PROF_TEAM';
            UPDATE prof_team pt
               SET pt.flg_available = 'N', pt.flg_status = 'I', pt.dt_end_tstz = g_sysdate_tstz
             WHERE pt.id_prof_team = i_id_prof_team;
        
            FOR i IN 1 .. i_prof.count
            LOOP
                IF i_prof_select(i) = 'I'
                THEN
                    g_error := 'UPDATE PROF_TEAM_DET';
                    UPDATE prof_team_det ptd
                       SET ptd.flg_status = 'I', ptd.dt_end = g_sysdate_tstz
                     WHERE ptd.id_prof_team = i_id_prof_team
                       AND ptd.id_professional = i_prof(i);
                END IF;
            
            END LOOP;
        
            g_error := 'UPDATE PROF_TEAM_DET';
            UPDATE prof_team_det ptd
               SET ptd.flg_status = 'I', ptd.dt_end = g_sysdate_tstz
             WHERE ptd.id_prof_team = i_id_prof_team;
        
            g_error := 'OPEN CURSOR C_PROF';
            OPEN c_prof(i_id_prof_team);
            FETCH c_prof BULK COLLECT
                INTO l_prof, l_prof_select;
            CLOSE c_prof;
        
            g_error := 'OPEN CURSOR C_CAT';
            OPEN c_cat(i_id_prof_team);
            FETCH c_cat BULK COLLECT
                INTO l_cat, l_cat_select;
            CLOSE c_cat;
        
            g_error := 'OPEN CURSOR C_SPEC';
            OPEN c_spec(i_id_prof_team);
            FETCH c_spec BULK COLLECT
                INTO l_spec, l_spec_select;
            CLOSE c_spec;
        
            l_res := set_usf_team(i_lang,
                                  NULL,
                                  i_id_usf,
                                  i_prof_team_name,
                                  l_cat,
                                  l_cat_select,
                                  l_prof,
                                  l_prof_select,
                                  l_spec,
                                  l_spec_select,
                                  o_id_prof_team,
                                  o_error);
        
            g_error := 'UPDATE PROF_TEAM';
            UPDATE prof_team pt
               SET pt.id_prof_team_old = i_id_prof_team
             WHERE pt.id_prof_team = o_id_prof_team;
        
        END IF;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_USF_TEAM',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END set_usf_team;

    /********************************************************************************************
    * Get Professional USF
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_professional       Professional ID
    * @param o_usf                   USF Information
    * @param o_error                 Error
    *
    *
    * @return                        true or false on success or error
    *
    * @author                        JTS
    * @version                       0.1
    * @since                         2008/06/01
    ********************************************************************************************/
    FUNCTION get_professional_usf
    (
        i_lang            IN language.id_language%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        o_usf             OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'SELECT USF';
        OPEN o_usf FOR
            SELECT i.id_institution id_usf, pk_translation.get_translation(i_lang, i.code_institution) usf_name
              FROM prof_institution pi, institution i
             WHERE pi.id_professional = i_id_professional
               AND pi.id_institution = i.id_institution
               AND i.flg_type = 'U';
        NULL;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROFESSIONAL_USF',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_professional_usf;

    /********************************************************************************************
    * Set USF Teams state
    *
    * @param i_lang                  Prefered language ID
    * @param i_prof_team             Array of Team ID's
    * @param i_flg_state             Array of Teams sate
    * @param o_error
    *
    * @return                      true or false on success or error
    *
    * @author                      JTS
    * @version                     0.1
    * @since                       2008/06/02
    ********************************************************************************************/
    FUNCTION set_usf_team_state
    (
        i_lang      IN language.id_language%TYPE,
        i_prof_team IN table_number,
        i_flg_state IN table_varchar,
        o_error     OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        FOR i IN 1 .. i_prof_team.count
        LOOP
            g_error := 'UPDATE PROF_TEAM';
            UPDATE prof_team pt
               SET pt.flg_status = i_flg_state(i)
             WHERE pt.id_prof_team = i_prof_team(i);
        END LOOP;
    
        COMMIT;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_USF_TEAM_STATE',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END set_usf_team_state;

    /********************************************************************************************
    * Consult Clincal Services
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_institution        Institution ID
    * @param i_id_prof_team          Team ID
    * @param o_clin_serv             Consult Clinical Services
    * @param o_error                 Error
    *
    *
    * @return                        true or false on success or error
    *
    * @author                        JTS
    * @version                       0.1
    * @since                         2008/06/04
    ********************************************************************************************/
    FUNCTION get_team_clin_serv_list
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        i_id_prof_team   IN prof_team.id_prof_team%TYPE,
        o_clin_serv      OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        IF i_id_prof_team IS NULL
        THEN
            g_error := 'GET CLIN_SERV CURSOR';
            OPEN o_clin_serv FOR
                SELECT DISTINCT cs.id_clinical_service id_clin_serv,
                                pk_translation.get_translation(i_lang, cs.code_clinical_service) clin_serv_name,
                                g_status_i flg_select
                  FROM dep_clin_serv dcs, department s, clinical_service cs
                 WHERE dcs.id_department = s.id_department
                   AND s.id_institution = i_id_institution
                   AND s.flg_type = 'C'
                   AND dcs.id_clinical_service = cs.id_clinical_service
                   AND cs.flg_available = 'Y'
                 ORDER BY clin_serv_name;
        ELSE
            g_error := 'GET CLIN_SERV CURSOR';
            OPEN o_clin_serv FOR
                SELECT DISTINCT cs.id_clinical_service id_clin_serv,
                                pk_translation.get_translation(i_lang, cs.code_clinical_service) clin_serv_name,
                                g_status_a flg_select
                  FROM prof_team_clin_serv ptcs, clinical_service cs
                 WHERE ptcs.id_prof_team = i_id_prof_team
                   AND ptcs.id_clinical_service = cs.id_clinical_service
                   AND cs.flg_available = 'Y'
                UNION
                SELECT DISTINCT cs.id_clinical_service id_clin_serv,
                                pk_translation.get_translation(i_lang, cs.code_clinical_service) clin_serv_name,
                                g_status_i flg_select
                  FROM dep_clin_serv dcs, department s, clinical_service cs
                 WHERE dcs.id_department = s.id_department
                   AND s.id_institution = i_id_institution
                   AND s.flg_type = 'C'
                   AND dcs.id_clinical_service = cs.id_clinical_service
                   AND cs.flg_available = 'Y'
                   AND cs.id_clinical_service NOT IN (SELECT DISTINCT cs2.id_clinical_service
                                                        FROM prof_team_clin_serv ptcs, clinical_service cs2
                                                       WHERE ptcs.id_prof_team = i_id_prof_team
                                                         AND ptcs.id_clinical_service = cs2.id_clinical_service
                                                         AND cs2.flg_available = 'Y')
                 ORDER BY clin_serv_name;
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_clin_serv);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_TEAM_CLIN_SERV_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_team_clin_serv_list;

    /********************************************************************************************
    * Professional USF list
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_institution        Institution ID
    * @param i_id_professional       Professional ID
    * @param o_list                  USF List
    * @param o_error                 Error
    *
    *
    * @return                        true or false on success or error
    *
    * @author                        JTS
    * @version                       0.1
    * @since                         2008/06/04
    ********************************************************************************************/
    FUNCTION get_prof_usf_list
    (
        i_lang            IN language.id_language%TYPE,
        i_id_institution  IN institution.id_institution%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        o_list            OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET ROOM_LIST CURSOR';
        OPEN o_list FOR
            SELECT i.id_institution id_usf,
                   pk_translation.get_translation(i_lang, i.code_institution) usf_name,
                   'A' flg_select
              FROM institution i, prof_team pt, prof_team_det ptd
             WHERE ptd.id_professional = i_id_professional
               AND pt.id_prof_team = ptd.id_prof_team
               AND pt.id_institution = i_id_institution
               AND pt.id_institution = i.id_institution
               AND i.flg_available = g_flg_available
            UNION
            SELECT i2.id_institution id_usf,
                   pk_translation.get_translation(i_lang, i2.code_institution) usf_name,
                   'I' flg_select
              FROM institution i2
             WHERE i2.id_institution = i_id_institution
               AND i2.flg_available = g_flg_available
               AND i2.id_institution NOT IN (SELECT i.id_institution
                                               FROM institution i, prof_team pt, prof_team_det ptd
                                              WHERE ptd.id_professional = i_id_professional
                                                AND pt.id_prof_team = ptd.id_prof_team
                                                AND pt.id_institution = i_id_institution
                                                AND pt.id_institution = i.id_institution
                                                AND i.flg_available = g_flg_available)
             ORDER BY usf_name;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_list);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_USF_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_prof_usf_list;

    /********************************************************************************************
    * USF Team Detail
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_prof_team          Team ID
    * @param o_team                  Team information
    * @param o_error                 Error
    *
    *
    * @return                        true or false on success or error
    *
    * @author                        JTS
    * @version                       0.1
    * @since                         2008/06/19
    ********************************************************************************************/
    FUNCTION get_usf_team_hist
    (
        i_lang         IN language.id_language%TYPE,
        i_id_prof_team IN prof_team.id_prof_team%TYPE,
        o_team         OUT pk_types.cursor_type,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        g_error := 'GET TEAM LIST CURSOR';
        OPEN o_team FOR
            SELECT pk_translation.get_translation(i_lang, i.code_institution) usf_name,
                   pt.prof_team_name team_name,
                   pk_utils.query_to_string('
                    SELECT pk_translation.get_translation(' || i_lang ||
                                            ', cs2.code_clinical_service)
                    FROM prof_team_clin_serv ptcs2, clinical_service cs2
                    WHERE ptcs2.id_prof_team = ' || pt.id_prof_team || '
                    AND ptcs2.id_clinical_service = cs2.id_clinical_service
                    AND cs2.flg_available = ''Y''',
                                            ', ') specialties,
                   pk_utils.query_to_string('
                   SELECT p3.name || '', '' || pk_translation.get_translation(' ||
                                            i_lang || '
                   , c3.code_category)
              FROM prof_team pt3, prof_team_det ptd3, professional p3, prof_cat pc3, category c3
             WHERE pt3.id_prof_team = ' || pt.id_prof_team || '
             AND ptd3.id_prof_team = pt3.id_prof_team
               AND pt3.id_institution = ' || pt.id_institution || '
               AND ptd3.id_professional = p3.id_professional
               AND p3.id_professional = pc3.id_professional
               AND nvl(p3.flg_prof_test, pk_alert_constant.get_no) = pk_alert_constant.get_no
               AND pc3.id_category = c3.id_category
               AND pc3.id_institution = pt3.id_institution',
                                            ';') professionals,
                   pt.flg_status,
                   pk_sysdomain.get_domain('ACTIVE_INACTIVE', pt.flg_status, i_lang) status_desc,
                   (SELECT COUNT(ptd.id_professional)
                      FROM prof_team_det ptd
                     WHERE ptd.id_prof_team = pt.id_prof_team) elem_num,
                   pk_date_utils.date_hour_chr_extend(i_lang, pt.dt_begin_tstz, profissional(0, i.id_institution, 26)) upd_date
              FROM institution i, prof_team pt
             WHERE pt.id_institution = i.id_institution
             START WITH pt.id_prof_team = i_id_prof_team
            CONNECT BY id_prof_team = PRIOR id_prof_team_old
             ORDER BY pt.dt_begin_tstz DESC;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_team);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_USF_TEAM_HIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_usf_team_hist;

    /*
    * Utility function to tokenize string
    *
    *
    * @param           pline            string to tokenize
    * @param           pdelimiter       token delimiter
    * @return          associtative array containing tokens
    *
    * @author    Joao Sa
    * @version   2.6.3
    * @since     2014/02/07
    */
    FUNCTION get_string_token_list
    (
        pline      IN VARCHAR2,
        pdelimiter IN VARCHAR2
    ) RETURN t_tab_string_token IS
        sline     VARCHAR2(2000);
        npos      INTEGER;
        nposold   INTEGER;
        nindex    INTEGER;
        nlength   INTEGER;
        ncnt      INTEGER;
        stoken    VARCHAR2(200);
        ttokentab t_tab_string_token;
    BEGIN
    
        -- Remove extra spaces
        sline := regexp_replace(pline, '[[:space:]]+', ' ');
    
        IF (substr(sline, length(sline), 1) <> '|')
        THEN
            sline := sline || '|';
        END IF;
    
        npos    := 0;
        stoken  := '';
        nlength := length(sline);
        ncnt    := 0;
    
        FOR nindex IN 1 .. nlength
        LOOP
            IF ((substr(sline, nindex, 1) = pdelimiter) OR (nindex = nlength))
            THEN
                nposold := npos;
                npos    := nindex;
                ncnt    := ncnt + 1;
                stoken  := substr(sline, nposold + 1, npos - nposold - 1);
            
                ttokentab(ncnt) := stoken;
            END IF;
        
        END LOOP;
    
        RETURN ttokentab;
    END get_string_token_list;

    /*
    * Function to create a professional and user account.
    * Performs three steps:
    * 1. Create user account (as temporary)
    * 2. Create professional
    * 3. Link professional to user name
    *
    * @param           i_lang            language associated to the professional executing the request
    * @param           i_login           username
    * @param           i_pass            password
    * @param           i_name            professional's name 
    * @param           i_nick_name       professional's nick name
    * @param           i_gender          professional's gender 
    * @param           i_secret_answ     security answer
    * @param           i_secret_quest    security question
    * @param           i_commit_at_end   commit, do not commit
    * @param           o_id_professional id of 
    * @param           o_error           error 
    * @return  returns true or false on success or error
    *
    * @author    Joao Sa
    * @version   2.6.3
    * @since     2014/02/07
    */
    FUNCTION set_temporary_user
    (
        i_lang            IN language.id_language%TYPE,
        i_login           IN ab_user_info.login%TYPE,
        i_pass            IN VARCHAR2,
        i_name            IN professional.name%TYPE,
        i_nick_name       IN professional.nick_name%TYPE,
        i_gender          IN professional.gender%TYPE,
        i_secret_answ     IN VARCHAR2,
        i_secret_quest    IN NUMBER,
        i_commit_at_end   IN BOOLEAN,
        o_id_professional OUT professional.id_professional%TYPE,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_login ab_user_info.login%TYPE := NULL;
        l_ret   BOOLEAN;
    
        l_name_token t_tab_string_token;
    
        l_first_name  professional.first_name%TYPE;
        l_last_name   professional.last_name%TYPE;
        l_middle_name professional.middle_name%TYPE;
        l_error       t_error_out;
    BEGIN
    
        g_error := 'REMOVE SPACES IN BEGIN/END OF USERNAME';
        l_login := TRIM(i_login);
    
        g_error := 'Error creating user credentials';
        IF NOT alert_core_func.pk_idp_user_cfg.set_user_credentials(i_compl_name   => i_name,
                                                                    i_email        => NULL,
                                                                    i_def_lang     => i_lang,
                                                                    i_first_name   => NULL,
                                                                    i_middle_name  => NULL,
                                                                    i_username     => i_login,
                                                                    i_password     => i_pass,
                                                                    i_sec_question => i_secret_quest,
                                                                    i_sec_answer   => i_secret_answ,
                                                                    o_error        => l_error)
        
        THEN
            RAISE g_exception;
        END IF;
    
        -- Get first, last and middle names
        g_error      := 'Error tokenizing name';
        l_name_token := get_string_token_list(TRIM(i_name), ' ');
    
        FOR indx IN l_name_token.first .. l_name_token.last
        LOOP
        
            IF (indx = l_name_token.first)
            THEN
                l_first_name := l_name_token(indx);
            ELSIF (indx = l_name_token.last)
            THEN
                l_last_name := l_name_token(indx);
            ELSE
                l_middle_name := l_middle_name || ' ' || l_name_token(indx);
            END IF;
        END LOOP;
        l_name_token.delete;
    
        g_error := 'Error updating ab_user_info';
        pk_api_ab_tables.upd_ins_into_ab_user_info(i_id_ab_user_info    => NULL,
                                                   i_login              => NULL,
                                                   i_password           => NULL,
                                                   i_import_code        => NULL,
                                                   i_record_status      => 'I',
                                                   i_institution_key    => 0,
                                                   i_flg_is_enable      => 'I',
                                                   i_first_name         => l_first_name,
                                                   i_last_name          => l_last_name,
                                                   i_full_name          => i_name,
                                                   i_external_system    => NULL,
                                                   i_external_system_id => NULL,
                                                   i_secret_quest       => NULL,
                                                   i_secret_answ        => NULL,
                                                   i_id_language        => i_lang,
                                                   i_flg_temporary      => 'Y',
                                                   i_date_creation_tstz => current_timestamp,
                                                   o_id_ab_user_info    => o_id_professional);
    
        g_error := 'Error inserting into professional';
        INSERT INTO professional
            (id_professional, name, nick_name, gender, flg_state, first_name, middle_name, last_name)
        VALUES
            (o_id_professional, i_name, i_nick_name, i_gender, 'I', l_first_name, l_middle_name, l_last_name);
    
        g_error := 'INSERT INTO PROFESSIONAL HISTORY';
        ins_professional_hist(i_id_professional => o_id_professional, i_operation_type => g_prof_hist_oper_c);
    
        g_error := 'Error updating username';
        IF NOT pk_backoffice_sp.set_username(i_lang            => i_lang,
                                             i_user_name       => i_login,
                                             i_id_professional => o_id_professional,
                                             o_error           => l_error)
        THEN
            RAISE g_exception;
        END IF;
    
        IF i_commit_at_end = TRUE
        THEN
            COMMIT;
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN g_exception THEN
            pk_alert_exceptions.process_error(i_lang,
                                              l_error.ora_sqlcode,
                                              l_error.ora_sqlerrm,
                                              g_error,
                                              g_package_owner,
                                              g_package_name,
                                              'SET_TEMPORARY_USER',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              g_package_owner,
                                              g_package_name,
                                              'SET_TEMPORARY_USER',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END set_temporary_user;

    /********************************************************************************************
    * Get user status - Blocked if there is an alert "UNBLOCK_USER" for the professional
    *
    * @param i_lang                  Prefered language ID
    * @param i_user                  User ID
    *
    *
    * @return                        true or false on success or error
    *
    * @author                        Susana Silva
    * @version                       2.4.4
    * @since                         2008/12/03
      ********************************************************************************************/
    FUNCTION get_user_status
    (
        i_lang IN language.id_language%TYPE,
        i_user IN professional.id_professional%TYPE
    ) RETURN VARCHAR2 IS
    
        l_flg_status ab_user_info.flg_is_enable% TYPE;
        l_message    VARCHAR2(200);
        l_time       VARCHAR2(200);
        l_error      t_error_out;
    BEGIN
    
        g_error := 'Get Alerts';
        BEGIN
            SELECT DISTINCT decode(instr(pk_date_utils.get_elapsed_sysdate_tsz(i_lang, v.dt_record), ':'),
                                   0,
                                   pk_date_utils.get_elapsed_sysdate_tsz(i_lang, v.dt_record),
                                   pk_date_utils.get_elapsed_sysdate_tsz(i_lang, v.dt_record) || ' ' ||
                                   pk_message.get_message(i_lang, 'ALERT_LIST_T003'))
            
              INTO l_time
              FROM sys_alert_event v
             WHERE v.id_record = i_user
               AND v.id_sys_alert = pk_alerts.g_alert_user_blocked
               AND v.id_institution = 0
               AND rownum = 1;
            l_message := '(' || pk_message.get_message(i_lang, profissional(i_user, 0, 0), 'ADMINISTRATOR_T173') ||
                         pk_message.get_message(i_lang, profissional(i_user, 0, 0), 'ADMINISTRATOR_T206') || l_time || ')';
        EXCEPTION
            WHEN no_data_found THEN
                l_message := NULL;
        END;
    
        RETURN l_message;
    
    EXCEPTION
        WHEN OTHERS THEN
            g_error := 'GET_USER_STATUS';
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_USER_STATUS',
                                              l_error);
            pk_alert_exceptions.reset_error_state;
            RETURN NULL;
        
    END get_user_status;

    /********************************************************************************************
     * GET PROFESSIONAL AGE
    *
    * @param i_lang                  Prefered language ID
    * @param i_dt_birth              Birthday date
    *
    *
    * @return                        true or false on success or error
    *
    * @author                        Susana Silva
    * @version                       2.4.4
    * @since                         2008/12/03
      ********************************************************************************************/

    FUNCTION get_professional_age
    (
        i_lang     IN language.id_language%TYPE,
        i_dt_birth IN professional.dt_birth%TYPE
    ) RETURN NUMBER IS
    
        l_age    NUMBER;
        l_months NUMBER;
        l_days   NUMBER;
        l_error  t_error_out;
    BEGIN
    
        IF i_dt_birth IS NULL
        THEN
            l_age := NULL;
        ELSE
            l_months := months_between(SYSDATE, i_dt_birth);
            l_days   := (SYSDATE - i_dt_birth);
        
            IF l_months < 1
            THEN
                l_age := trunc(l_days);
            ELSE
                l_age := trunc(l_months / 12);
            END IF;
        END IF;
    
        RETURN l_age;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            g_error := 'GET_PROFESSIONAL_AGE';
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROFESSIONAL_AGE',
                                              l_error);
            pk_alert_exceptions.reset_error_state;
            RETURN NULL;
        
    END get_professional_age;

    /********************************************************************************************
    * SET LICENSES
    *
    * @param i_lang                     Prefered language ID
    * @param i_id_institution           id institution
    * @param i_id_product_purchasable   id for the product purchasable (billing or adw)
    * @param i_id_professional          Professional id
    * @param i_dt_expire                expire date   
    * @param i_flg_status               license status
    * @param i_payment_schedule         payment schedule A- anual B-biannual
    * @param i_notes_license            notes for the  licenses
    * @param i_dt_purchase              dt of purchase
    * @param i_id_profile_template_desc id_profile template desc    
    * @param i_dt_expire_tstz           date of expire_tstz    
    * @param i_dt_purchase_tstz         date of purchase_tstz    
    * @param o_error                    Error
    *
    *
    * @return                        true or false on success or error
    *
    * @author                        Sérgio Monteiro
    * @version                       0.1
    * @since                         2008/11/15
    ********************************************************************************************/

    FUNCTION set_licenses
    (
        i_lang                     IN language.id_language%TYPE,
        i_id_institution           IN license.id_institution%TYPE,
        i_id_product_purchasable   IN license.id_product_purchasable%TYPE,
        i_id_professional          IN license.id_professional%TYPE,
        i_dt_expire                IN license.dt_expire%TYPE,
        i_flg_status               IN license.flg_status%TYPE,
        i_payment_schedule         IN license.payment_schedule%TYPE,
        i_notes_license            IN license.notes_license%TYPE,
        i_dt_purchase              IN license.dt_purchase%TYPE,
        i_id_profile_template_desc IN license.id_profile_template_desc%TYPE,
        i_dt_expire_tstz           IN license.dt_expire_tstz%TYPE,
        i_dt_purchase_tstz         IN license.dt_purchase_tstz%TYPE,
        o_error                    OUT t_error_out
    ) RETURN BOOLEAN IS
        l_id_license NUMBER;
    
    BEGIN
        SELECT seq_license.nextval
          INTO l_id_license
          FROM dual;
    
        INSERT INTO license
            (id_license,
             id_institution,
             id_product_purchasable,
             id_professional,
             dt_expire,
             flg_status,
             payment_schedule,
             notes_license,
             dt_purchase,
             id_profile_template_desc,
             dt_expire_tstz,
             dt_purchase_tstz,
             adw_last_update)
        
        VALUES
            (l_id_license,
             i_id_institution,
             i_id_product_purchasable,
             i_id_professional,
             i_dt_expire,
             i_flg_status,
             i_payment_schedule,
             i_notes_license,
             i_dt_purchase,
             i_id_profile_template_desc,
             i_dt_expire_tstz,
             i_dt_purchase_tstz,
             SYSDATE);
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_LICENSES',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END;

    /********************************************************************************************
    * Create institution via ALERT?ONLINE
    *
    * @param i_lang                  Prefered language ID
    * @param i_flg_type_inst         Flag type for institution - H - Hospital, C - Primary Care, P - Private Practice
    * @param i_id_country            Institution ID country
    * @param i_inst_name             Institution name
    * @param i_inst_address          Institution address
    * @param i_inst_zipcode          Institution zipcode
    * @param i_inst_phone            Institution phone
    * @param i_inst_fax              Institution fax
    * @param i_inst_email            Institution email
    * @param i_inst_currency         Institution prefered currency
    * @param i_inst_timezone         Institution timezendo ID    
    * @param i_inst_acronym          Institution acronym
    * @param i_market                Market id
    * @param o_id_institution        institution ID created
    * @param o_error                 error    
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      Sérgio Monteiro
    * @version                     0.1
    * @since                       2008/12/03
    ********************************************************************************************/

    FUNCTION set_institution_data_online
    (
        i_lang           IN language.id_language%TYPE,
        i_flg_type_inst  IN institution.flg_type%TYPE,
        i_id_country     IN inst_attributes.id_country%TYPE,
        i_inst_name      IN pk_translation.t_desc_translation,
        i_inst_address   IN institution.address%TYPE,
        i_inst_zipcode   IN institution.zip_code%TYPE,
        i_inst_phone     IN institution.phone_number%TYPE,
        i_inst_fax       IN institution.fax_number%TYPE,
        i_inst_email     IN inst_attributes.email%TYPE,
        i_inst_currency  IN inst_attributes.id_currency%TYPE,
        i_inst_timezone  IN institution.id_timezone_region%TYPE,
        i_inst_acronym   IN institution.abbreviation%TYPE,
        i_market         IN market.id_market%TYPE,
        o_id_institution OUT institution.id_institution%TYPE,
        o_error          OUT t_error_out
        
    ) RETURN BOOLEAN IS
    
        l_id_institution     NUMBER;
        l_id_inst_attributes NUMBER;
        l_id_inst_lang       NUMBER;
        l_version            VARCHAR(50) := pk_sysconfig.get_config('DEFAULT_PARAM_VERS', profissional(0, 0, 0));
        l_code_trl           translation.code_translation%TYPE := 'AB_INSTITUTION.CODE_INSTITUTION.';
        l_error              t_error_out;
        my_exception EXCEPTION;
    BEGIN
    
        IF NOT set_institution_data(i_lang               => i_lang,
                                    i_id_institution     => NULL,
                                    i_clues              => NULL,
                                    i_id_inst_att        => NULL,
                                    i_id_inst_lang       => i_lang,
                                    i_desc               => i_inst_name,
                                    i_id_parent          => NULL,
                                    i_flg_type           => i_flg_type_inst,
                                    i_tax                => NULL,
                                    i_abbreviation       => i_inst_acronym,
                                    i_pref_lang          => i_lang,
                                    i_currency           => i_inst_currency,
                                    i_phone_number       => i_inst_phone,
                                    i_fax                => i_inst_fax,
                                    i_email              => i_inst_email,
                                    i_health_license     => NULL,
                                    i_adress             => i_inst_address,
                                    i_location           => NULL,
                                    i_geo_state          => NULL,
                                    i_flg_street_type    => NULL,
                                    i_street_name        => NULL,
                                    i_outdoor_number     => NULL,
                                    i_indoor_number      => NULL,
                                    i_id_settlement_type => NULL,
                                    i_id_settlement_name => NULL,
                                    i_id_entity          => NULL,
                                    i_id_municip         => NULL,
                                    i_id_localidad       => NULL,
                                    i_id_postal_code     => NULL,
                                    i_zip_code           => i_inst_zipcode,
                                    i_country            => i_id_country,
                                    i_jurisdiction       => NULL,
                                    i_location_tax       => NULL,
                                    i_lic_model          => NULL,
                                    i_pay_sched          => NULL,
                                    i_pay_opt            => NULL,
                                    i_flg_available      => 'Y',
                                    i_id_tz_region       => i_inst_timezone,
                                    i_id_market          => 0,
                                    i_contact_det        => NULL,
                                    i_commit_at_end      => FALSE,
                                    i_website            => NULL,
                                    o_id_institution     => l_id_institution,
                                    o_id_inst_attributes => l_id_inst_attributes,
                                    o_id_inst_lang       => l_id_inst_lang,
                                    o_error              => l_error)
        THEN
            RAISE my_exception;
        
        END IF;
        o_id_institution := l_id_institution;
    
        pk_translation.insert_into_translation(i_lang       => i_lang,
                                               i_code_trans => l_code_trl || l_id_institution,
                                               i_desc_trans => i_inst_name);
    
        RETURN TRUE;
    EXCEPTION
        WHEN my_exception THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              l_error.err_desc,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_INSTITUTION_DATA_ONLINE',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_INSTITUTION_DATA_ONLINE',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END;

    /********************************************************************************************
    * Get a list off the markets for a specific country
    *
    * @param i_lang                Prefered language ID
    * @param i_id_country          Institution country ID
    * @param o_market              Market List cursor
    * @param o_error               Error
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      Tércio Soares
    * @version                     0.1
    * @since                       2008/12/09
    ********************************************************************************************/
    FUNCTION get_market_list
    (
        i_lang       IN language.id_language%TYPE,
        i_id_country IN country.id_country%TYPE,
        o_market     OUT pk_types.cursor_type,
        o_error      OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        g_error := 'GET MARKET CURSOR';
        OPEN o_market FOR
            SELECT m.id_market, pk_translation.get_translation(i_lang, m.code_market) market_desc, 'N' flg_default
              FROM market m
             WHERE m.id_market = 0
            UNION
            SELECT m.id_market,
                   pk_translation.get_translation(i_lang, m.code_market) market_desc,
                   cm.flg_active flg_default
              FROM country_market cm, market m
             WHERE cm.id_country = i_id_country
               AND cm.id_market = m.id_market;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_market);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_MARKET_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_market_list;

    /********************************************************************************************
    * GET USER FUNTIONALITY 
    *
    * @param i_id_category              Prefered language ID
    * @param i_id_software              Prefered language ID
    * @param i_id_institution           Prefered language ID
    * @param i_id_user                  Prefered language ID
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      Susana Silva
    * @version                     0.1
    * @since                       2008/12/06
    ********************************************************************************************/

    FUNCTION get_user_funtionality
    (
        i_id_category    IN category.id_category%TYPE,
        i_id_software    IN software.id_software%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        i_id_user        IN ab_user_info.id_ab_user_info%TYPE
    ) RETURN VARCHAR IS
    
        l_flg_type   profile_template.flg_group%TYPE;
        l_o_flg_type VARCHAR2(1);
        l_flg_cat    category.flg_type%TYPE;
        l_error      t_error_out;
    BEGIN
    
        g_error := 'PROF_PROFILE_TEMPLATE';
    
        BEGIN
            SELECT pt.flg_group
              INTO l_flg_type
              FROM prof_profile_template ppt, profile_template pt, software s
             WHERE ppt.id_profile_template = pt.id_profile_template
               AND ppt.id_professional = i_id_user
               AND ppt.id_software = i_id_software
               AND ppt.id_institution = i_id_institution
               AND s.id_software = pt.id_software
               AND s.flg_viewer = 'N'
               AND rownum = 1;
        
        EXCEPTION
            WHEN no_data_found THEN
            
                BEGIN
                    g_error := 'PROF_CAT';
                    SELECT c.flg_type
                      INTO l_flg_cat
                      FROM category c
                     WHERE c.id_category = i_id_category;
                EXCEPTION
                    WHEN no_data_found THEN
                        l_flg_cat := 'O';
                END;
            
                IF l_flg_cat IS NOT NULL
                THEN
                    CASE l_flg_cat
                        WHEN 'D' THEN
                            l_o_flg_type := 'P';
                        WHEN 'I' THEN
                            l_o_flg_type := 'P';
                        WHEN 'N' THEN
                            l_o_flg_type := 'C';
                        WHEN 'P' THEN
                            l_o_flg_type := 'C';
                        WHEN 'T' THEN
                            l_o_flg_type := 'C';
                        WHEN 'F' THEN
                            l_o_flg_type := 'C';
                        WHEN 'M' THEN
                            l_o_flg_type := 'C';
                        WHEN 'U' THEN
                            l_o_flg_type := 'C';
                        WHEN 'A' THEN
                            l_o_flg_type := 'N';
                        WHEN 'O' THEN
                            l_o_flg_type := 'N';
                        WHEN 'C' THEN
                            l_o_flg_type := 'N';
                        WHEN 'V' THEN
                            l_o_flg_type := 'N';
                        WHEN 'S' THEN
                            l_o_flg_type := 'N';
                        WHEN 'x' THEN
                            l_o_flg_type := 'N';
                        ELSE
                            l_o_flg_type := 'N';
                        
                    END CASE;
                END IF;
            
                RETURN l_o_flg_type;
        END;
    
        IF l_flg_type IS NOT NULL
        THEN
            l_o_flg_type := l_flg_type;
        END IF;
    
        RETURN l_o_flg_type;
    
    EXCEPTION
        WHEN no_data_found THEN
            RETURN 'N';
        
        WHEN OTHERS THEN
        
            RETURN 'N';
        
    END get_user_funtionality;

    /********************************************************************************************
    * Get the software available for the institution, including the "All" softwares clause
    *
    * @param i_lang                            Prefered language ID
    * @param i_id_institution                  Institution ID    
    * @param o_software                        Software ID
    * @param o_error                           Error
    *
    *
    * @return                                  true or false on success or error
    *
    * @author                                  Sérgio Cunha
    * @version                                 0.1
    * @since                                   2009/01/27
    ********************************************************************************************/
    FUNCTION get_institution_software_all
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        o_software       OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        OPEN o_software FOR
            SELECT s.id_software id, s.name name
              FROM software_institution si, software s
             WHERE s.flg_mni = pk_alert_constant.g_yes
               AND si.id_software = s.id_software
               AND si.id_institution = i_id_institution
               AND s.id_software != 26
            UNION
            SELECT 0 id, '<b>' || pk_message.get_message(i_lang, 'ADMINISTRATOR_T228') || '</b>'
              FROM dual
             ORDER BY id;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_software);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_INSTITUTION_SOFTWARE_ALL',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_institution_software_all;

    /********************************************************************************************
    * Get State List
    *
    * @param i_lang                Prefered language ID
    * @param i_code_domain         Code to obtain Options
    * @param o_list                List od states
    * @param o_error               Error
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      SC
    * @version                     0.1
    * @since                       17/02/2009
    ********************************************************************************************/
    FUNCTION get_state_list
    (
        i_lang        IN language.id_language%TYPE,
        i_code_domain sys_domain.code_domain%TYPE,
        o_list        OUT pk_types.cursor_type,
        o_error       OUT t_error_out
    ) RETURN BOOLEAN IS
        l_exception EXCEPTION;
    BEGIN
        IF i_code_domain = 'PROFESSIONAL.TITLE'
        THEN
            g_error := 'GET LIST CURSOR';
            IF NOT pk_backoffice_api_ui.get_prof_title_list(i_lang, profissional(0, 0, 0), o_list, o_error)
            THEN
                RAISE l_exception;
            END IF;
        
        ELSE
        
            g_error := 'GET LIST CURSOR';
            OPEN o_list FOR
                SELECT val, desc_val, img_name icon
                  FROM sys_domain
                 WHERE code_domain = i_code_domain
                   AND domain_owner = pk_sysdomain.k_default_schema
                   AND flg_available = pk_alert_constant.g_yes
                   AND id_language = i_lang
                 ORDER BY rank, desc_val;
        END IF;
        RETURN TRUE;
    EXCEPTION
        WHEN l_exception THEN
            pk_types.open_my_cursor(o_list);
            pk_alert_exceptions.process_error(i_lang,
                                              o_error.ora_sqlcode,
                                              o_error.ora_sqlerrm,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_STATE_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_list);
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_STATE_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_state_list;

    /********************************************************************************************
    * Get Appointment Department List 
    *
    * @param i_lang             Preferred language ID
    * @param i_id_institution   Institution ID
    * @param o_dept_list        Departments cursor
    * @param o_error            Error
    *
    * @return                   true or false on success or error
    * 
    *
    * @author                   JTS
    * @version                  0.1
    * @since                    2009/03/04
    ********************************************************************************************/
    FUNCTION get_appointment_dept_list
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN dept.id_institution%TYPE,
        o_dept_list      OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET DEPT CURSOR';
        OPEN o_dept_list FOR
            SELECT d.id_dept id_dept, pk_translation.get_translation(i_lang, d.code_dept) dept_name
              FROM dept d
             WHERE d.id_institution = i_id_institution
               AND d.flg_available = g_flg_available
               AND d.id_dept IN (SELECT s.id_dept
                                   FROM department s
                                  WHERE s.flg_type = 'C'
                                    AND s.id_institution = i_id_institution)
             ORDER BY dept_name;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_dept_list);
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_APPOINTMENT_DEPT_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_appointment_dept_list;

    /********************************************************************************************
    * Get Appointment Service List 
    *
    * @param i_lang             Preferred language ID
    * @param i_id_dept          Department ID
    * @param o_service_list     Services cursor
    * @param o_error            Error
    *
    * @return                   true or false on success or error
    * 
    *
    * @author                   JTS
    * @version                  0.1
    * @since                    2009/03/04
    ********************************************************************************************/
    FUNCTION get_appointment_service_list
    (
        i_lang         IN language.id_language%TYPE,
        i_id_dept      IN dept.id_dept%TYPE,
        o_service_list OUT pk_types.cursor_type,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET DEPARTMENT_LIST CURSOR';
        OPEN o_service_list FOR
            SELECT s.id_department id_service, pk_translation.get_translation(i_lang, s.code_department) service_name
              FROM department s
             WHERE s.id_dept = i_id_dept
               AND s.flg_available = g_flg_available
               AND s.flg_type = 'C';
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_service_list);
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_APPOINTMENT_SERVICE_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_appointment_service_list;

    /********************************************************************************************
    * Get Relation(Service/Clinical Service) Previous nurse contact information
    *
    * @param i_lang          Preferred language ID
    * @param i_id_dept       Department ID
    * @param i_id_department Service ID
    * @param o_dcs           Clinical services
    * @param o_error         Error
    *
    * @return                true or false on success or error
    * 
    *
    * @author                JTS
    * @version               0.1
    * @since                 2009/03/04
    ********************************************************************************************/
    FUNCTION get_dcs_nurse_pre_list
    (
        i_lang          IN language.id_language%TYPE,
        i_id_dept       IN dept.id_dept%TYPE,
        i_id_department IN dep_clin_serv.id_department%TYPE,
        o_dcs           OUT pk_types.cursor_type,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET DEP_CLIN_SERV CURSOR';
        OPEN o_dcs FOR
            SELECT DISTINCT dcs.id_dep_clin_serv,
                            cs.id_clinical_service,
                            pk_translation.get_translation(i_lang, cs.code_clinical_service) clinical_service,
                            decode(dcs.flg_nurse_pre,
                                   pk_alert_constant.g_yes,
                                   pk_alert_constant.g_active,
                                   pk_alert_constant.g_inactive) flg_select
              FROM dep_clin_serv dcs, clinical_service cs
             WHERE dcs.id_clinical_service = cs.id_clinical_service
               AND dcs.flg_available = g_flg_available
               AND dcs.id_department = i_id_department
               AND dcs.id_department IN (SELECT DISTINCT s.id_department
                                           FROM department s
                                          WHERE dcs.id_department = s.id_department
                                            AND s.id_dept = i_id_dept)
               AND pk_translation.get_translation(i_lang, cs.code_clinical_service) IS NOT NULL
             ORDER BY flg_select, clinical_service;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_dcs);
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_DCS_NURSE_PRE_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_dcs_nurse_pre_list;

    /********************************************************************************************
    * Update Relation(Service/Clinical Service) Previous nurse contact information
    *
    * @param i_lang             Preferred language ID
    * @param i_dcs              Relation(Service/Clinical Service) ID's
    * @param i_nurse_pre        Previous nurse contact indication
    * @param o_dcs              Relation(Service/Clinical Service) ID's
    * @param o_error            Error
    *
    * @return                   true or false on success or error
    * 
    *
    * @author                   JTS
    * @version                  0.1
    * @since                    2009/03/04
    ********************************************************************************************/
    FUNCTION set_dcs_nurse_pre
    (
        i_lang      IN language.id_language%TYPE,
        i_dcs       IN table_number,
        i_nurse_pre IN table_varchar,
        o_dcs       OUT table_number,
        o_error     OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_ind NUMBER := 1;
    
    BEGIN
    
        o_dcs := table_number();
    
        FOR i IN 1 .. i_dcs.count
        LOOP
        
            o_dcs.extend;
        
            g_error := 'UPDATE DEP_CLIN_SERV';
            UPDATE dep_clin_serv dcs
               SET dcs.flg_nurse_pre = i_nurse_pre(i)
             WHERE dcs.id_dep_clin_serv = i_dcs(i);
        
            o_dcs(l_ind) := i_dcs(i);
            l_ind := l_ind + 1;
        
        END LOOP;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_DCS_NURSE_PRE',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END set_dcs_nurse_pre;

    /********************************************************************************************
    * Set institution affiliations values
    *
    * @param i_lang             Preferred language ID
    * @param i_id_institution   Institution ID
    * @param i_accounts         Affiliations ID's
    * @param i_values           Affiliations Values
    * @param o_error            Error
    *
    * @return                   true or false on success or error
    * 
    *
    * @author                   JTS
    * @version                  0.1
    * @since                    2009/03/05
    ********************************************************************************************/
    FUNCTION set_inst_affiliations
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        i_accounts       IN table_number,
        i_values         IN table_varchar,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_rowids table_varchar;
    
    BEGIN
    
        FOR i IN 1 .. i_accounts.count
        LOOP
        
            IF i_values(i) IS NULL
            THEN
                g_error := 'delete account inst';
                ts_institution_accounts.del(i_id_institution, i_accounts(i));
            ELSE
                g_error := 'Update/ Insert account inst';
                ts_institution_accounts.upd_ins(id_institution_in => i_id_institution,
                                                id_account_in     => i_accounts(i),
                                                value_in          => i_values(i),
                                                rows_out          => l_rowids);
            END IF;
        END LOOP;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_INST_AFFILIATIONS',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END set_inst_affiliations;

    /********************************************************************************************
    * Set Professional affiliations values
    *
    * @param i_lang             Preferred language ID
    * @param i_id_professional  Professional ID
    * @param i_institution      Institution ID's
    * @param i_accounts         Affiliations ID's
    * @param i_values           Affiliations Values
    * @param o_error            Error
    *
    * @return                   true or false on success or error
    * 
    *
    * @author                   JTS
    * @version                  0.1
    * @since                    2009/03/05
    ********************************************************************************************/
    FUNCTION set_prof_affiliations
    (
        i_lang            IN language.id_language%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        i_institution     IN table_number,
        i_accounts        IN table_number,
        i_values          IN table_varchar,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_rowids      table_varchar;
        l_account_pis accounts.id_account%TYPE := 81;
        l_exception EXCEPTION;
    BEGIN
    
        FOR i IN 1 .. i_accounts.count
        LOOP
        
            IF i_values(i) IS NULL
            THEN
                g_error := 'delete account inst';
                ts_prof_accounts.del(i_id_professional, i_accounts(i), i_institution(i));
            ELSE
                IF i_accounts(i) = l_account_pis
                THEN
                    g_error := 'PIS ' || i_values(i) || 'J?EM USO';
                    IF NOT check_prof_acount_value(i_values(i), i_accounts(i), i_institution(i), i_id_professional)
                    THEN
                        RAISE l_exception;
                    END IF;
                END IF;
                ts_prof_accounts.upd_ins(id_professional_in => i_id_professional,
                                         id_account_in      => i_accounts(i),
                                         id_institution_in  => i_institution(i),
                                         value_in           => i_values(i),
                                         rows_out           => l_rowids);
            END IF;
        
        END LOOP;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN l_exception THEN
            pk_alert_exceptions.process_error(i_lang,
                                              'CHECK PROF DATA',
                                              g_error,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_PROF_AFFILIATIONS',
                                              'U',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        WHEN OTHERS THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_PROF_AFFILIATIONS',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END set_prof_affiliations;

    /********************************************************************************************
    * Get Institutions Country affiliations
    *
    * @param i_lang                Preferred language ID
    * @param i_id_institution      Institution ID
    * @param i_id_country          Country ID
    * @param o_inst_affiliations   Affiliations cursor
    * @param o_error               Error
    *
    * @return                      true or false on success or error
    * 
    *
    * @author                      JTS
    * @version                     0.1
    * @since                       2009/03/05
    ********************************************************************************************/
    FUNCTION get_inst_ctry_affiliations
    (
        i_lang              IN language.id_language%TYPE,
        i_id_institution    IN institution.id_institution%TYPE,
        i_id_country        IN country.id_country%TYPE,
        o_inst_affiliations OUT pk_types.cursor_type,
        o_error             OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        g_error := 'GET INSTITUTION COUNTRY AFFILIATIONS CURSOR';
        OPEN o_inst_affiliations FOR
            SELECT a.id_account,
                   pk_translation.get_translation(i_lang, a.code_account) account_name,
                   a.fill_type,
                   a.sys_domain_identifier,
                   (SELECT ia.value
                      FROM institution_accounts ia
                     WHERE ia.id_account = a.id_account
                       AND ia.id_institution = i_id_institution) VALUE,
                   decode(a.fill_type,
                          'M',
                          nvl((pk_sysdomain.get_domain(a.sys_domain_identifier,
                                                       (SELECT ia.value
                                                          FROM institution_accounts ia
                                                         WHERE ia.id_account = a.id_account
                                                           AND ia.id_institution = i_id_institution),
                                                       i_lang)),
                              NULL),
                          'MM',
                          nvl(get_domain_desc_str(a.sys_domain_identifier,
                                                  (SELECT ia.value
                                                     FROM institution_accounts ia
                                                    WHERE ia.id_account = a.id_account
                                                      AND ia.id_institution = i_id_institution),
                                                  i_lang),
                              NULL),
                          (SELECT ia.value
                             FROM institution_accounts ia
                            WHERE ia.id_account = a.id_account
                              AND ia.id_institution = i_id_institution)) value_desc,
                   ac.format_num,
                   ac.text_format_x,
                   ac.text_format_y,
                   ac.flg_editable
              FROM accounts a
             INNER JOIN accounts_country ac
                ON (ac.id_account = a.id_account)
             WHERE a.flg_available = 'Y'
               AND a.flg_type IN ('I', 'B')
               AND pk_translation.get_translation(i_lang, a.code_account) IS NOT NULL
               AND ac.id_country = i_id_country
             ORDER BY ac.rank, pk_translation.get_translation(i_lang, a.code_account);
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_types.open_my_cursor(o_inst_affiliations);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_INST_CTRY_AFFILIATIONS',
                                              o_error);
        
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_inst_ctry_affiliations;

    /********************************************************************************************
    * Get Professional Category affiliations
    *
    * @param i_lang                Preferred language ID
    * @param i_id_professional     Professional ID
    * @param i_id_category         Category ID
    * @param i_id_institution      Institution ID
    * @param o_prof_affiliations   Affiliations cursor
    * @param o_error               Error
    *
    * @return                      true or false on success or error
    * 
    *
    * @author                      JTS
    * @version                     0.1
    * @since                       2009/03/05
    ********************************************************************************************/
    FUNCTION get_prof_cat_affiliations
    (
        i_lang              IN language.id_language%TYPE,
        i_id_professional   IN professional.id_professional%TYPE,
        i_id_category       IN category.id_category%TYPE,
        i_id_institution    IN institution.id_institution%TYPE,
        o_prof_affiliations OUT pk_types.cursor_type,
        o_error             OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
    
        g_error := 'GET PROFESSIONAL AFFILIATIONS: ID_PROFESSIONAL = ' || i_id_professional;
        pk_alertlog.log_debug('PK_BACKOFFICE.GET_PROF_CAT_AFFILIATIONS: ' || g_error);
        OPEN o_prof_affiliations FOR
            SELECT a.id_account,
                   pk_translation.get_translation(i_lang, a.code_account) account_name,
                   a.fill_type,
                   a.sys_domain_identifier,
                   decode(acat.flg_institution,
                          'Y',
                          (SELECT pa.value
                             FROM prof_accounts pa
                            WHERE pa.id_account = a.id_account
                              AND pa.id_professional = i_id_professional
                              AND pa.id_institution = i_id_institution),
                          (SELECT pa.value
                             FROM prof_accounts pa
                            WHERE pa.id_account = a.id_account
                              AND pa.id_professional = i_id_professional
                              AND pa.id_institution = 0)) VALUE,
                   decode(a.fill_type,
                          'M',
                          nvl((pk_sysdomain.get_domain(a.sys_domain_identifier,
                                                       (decode(acat.flg_institution,
                                                               'Y',
                                                               (SELECT pa.value
                                                                  FROM prof_accounts pa
                                                                 WHERE pa.id_account = a.id_account
                                                                   AND pa.id_professional = i_id_professional
                                                                   AND pa.id_institution = i_id_institution),
                                                               (SELECT pa.value
                                                                  FROM prof_accounts pa
                                                                 WHERE pa.id_account = a.id_account
                                                                   AND pa.id_professional = i_id_professional
                                                                   AND pa.id_institution = 0))),
                                                       i_lang)),
                              NULL),
                          'MM',
                          nvl(get_domain_desc_str(a.sys_domain_identifier,
                                                  (decode(acat.flg_institution,
                                                          'Y',
                                                          (SELECT pa.value
                                                             FROM prof_accounts pa
                                                            WHERE pa.id_account = a.id_account
                                                              AND pa.id_professional = i_id_professional
                                                              AND pa.id_institution = i_id_institution),
                                                          (SELECT pa.value
                                                             FROM prof_accounts pa
                                                            WHERE pa.id_account = a.id_account
                                                              AND pa.id_professional = i_id_professional
                                                              AND pa.id_institution = 0))),
                                                  i_lang),
                              NULL),
                          (decode(acat.flg_institution,
                                  'Y',
                                  (SELECT pa.value
                                     FROM prof_accounts pa
                                    WHERE pa.id_account = a.id_account
                                      AND pa.id_professional = i_id_professional
                                      AND pa.id_institution = i_id_institution),
                                  (SELECT pa.value
                                     FROM prof_accounts pa
                                    WHERE pa.id_account = a.id_account
                                      AND pa.id_professional = i_id_professional
                                      AND pa.id_institution = 0)))) value_desc,
                   decode(acat.flg_institution, 'N', 0, i_id_institution) id_institution,
                   ac.format_num,
                   ac.text_format_x,
                   ac.text_format_y,
                   ac.flg_editable
              FROM accounts a
             INNER JOIN accounts_category acat
                ON (acat.id_account = a.id_account AND acat.id_category = i_id_category)
             INNER JOIN accounts_country ac
                ON (ac.id_account = a.id_account)
             INNER JOIN inst_attributes ia
                ON (ia.id_country = ac.id_country AND ia.id_institution = i_id_institution)
             WHERE a.flg_available = 'Y'
               AND pk_translation.get_translation(i_lang, a.code_account) IS NOT NULL
               AND a.flg_type IN ('P', 'B')
             ORDER BY ac.rank, pk_translation.get_translation(i_lang, a.code_account);
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_types.open_my_cursor(o_prof_affiliations);
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_CAT_AFFILIATIONS',
                                              o_error);
        
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_prof_cat_affiliations;

    /********************************************************************************************
    * Gets the market associated with a given instituition
    *
    * @param i_lang              Language
    * @param i_id_institution    Professional array
    *
    * @param o_id_market         Market id 
    * @param o_error             Error information
    
    * @return                    Return BOOLEAN 
    *
    * @author                    Sérgio Cunha
    * @version                   2.5
    * @since                     25/05/2009
    ********************************************************************************************/
    FUNCTION get_institution_market
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        o_market         OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_id_country country.id_country%TYPE;
        l_error_out  t_error_out;
    
    BEGIN
    
        l_id_country := get_institution_country(i_lang, i_id_institution, l_error_out);
    
        g_error := 'SELECT MARKET';
        OPEN o_market FOR
            SELECT i.id_market, m.desc_market, l_id_country id_country
              FROM institution i
              JOIN market m
                ON i.id_market = m.id_market
             WHERE i.id_institution = i_id_institution;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_types.open_my_cursor(o_market);
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_INSTITUTION_MARKET',
                                              o_error);
        
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_institution_market;

    /********************************************************************************************
    * Get the color associated to a given dep_clin_serv
    *
    * @param i_lang              Language
    * @param i_prof              Professional array
    * @param i_id_institution    Institution ID
    * @param i_dcs               Dep_clin_serv ID
    * @param o_color             Color 
    * @param o_error             Error information
    
    * @return                    Return BOOLEAN 
    *
    * @author                    Sérgio Cunha
    * @version                   2.5.0.4
    * @since                     05/06/2009
    ********************************************************************************************/
    FUNCTION get_dcs_color
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN profissional,
        i_id_institution IN institution.id_institution%TYPE,
        i_dcs            IN dep_clin_serv.id_dep_clin_serv%TYPE,
        o_color          OUT sch_color.color_hex%TYPE,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        BEGIN
            g_error := 'GET DCS COLOR';
            SELECT sc.color_hex color_hex
              INTO o_color
              FROM sch_color sc
             WHERE sc.id_dep_clin_serv = i_dcs
               AND sc.id_institution = i_id_institution
               AND sc.flg_type = pk_alert_constant.g_flg_status_d;
        EXCEPTION
            WHEN no_data_found THEN
                o_color := NULL;
        END;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_DCS_COLOR',
                                              o_error);
        
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_dcs_color;

    /********************************************************************************************
    * Get the info associated to a given dep_clin_serv
    *
    * @param i_lang              Language
    * @param i_prof              Professional array
    * @param i_id_institution    Institution ID
    * @param i_dcs               Dep_clin_serv ID
    * @param o_dcs_info          Dep_clin_serv info
    * @param o_dcs_pre_exams     Dep_clin_serv pre exams
    * @param o_error             Error information
    
    * @return                    Return BOOLEAN 
    *
    * @author                    Sérgio Cunha
    * @version                   2.5.0.4
    * @since                     05/06/2009
    ********************************************************************************************/
    FUNCTION get_dcs_info
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN profissional,
        i_id_institution IN institution.id_institution%TYPE,
        i_dcs            IN dep_clin_serv.id_dep_clin_serv%TYPE,
        o_dcs_info       OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_flg_edit   VARCHAR2(1);
        l_dcs_color  sch_color.color_hex%TYPE;
        l_desc_color sys_domain.desc_val%TYPE;
        my_exception EXCEPTION;
    
        l_id_country    country.id_country%TYPE;
        l_id_country_nl country.id_country%TYPE := 528;
        l_error_out     t_error_out;
    
    BEGIN
    
        l_id_country := get_institution_country(i_lang, i_id_institution, l_error_out);
    
        SELECT decode(s.flg_type, 'C', pk_alert_constant.g_yes, pk_alert_constant.g_no)
          INTO l_flg_edit
          FROM department s
         WHERE s.id_department = (SELECT dcs.id_department
                                    FROM dep_clin_serv dcs
                                   WHERE dcs.id_dep_clin_serv = i_dcs);
    
        IF NOT get_dcs_color(i_lang, i_prof, i_id_institution, i_dcs, l_dcs_color, o_error)
        THEN
            RAISE my_exception;
        END IF;
    
        IF l_dcs_color IS NULL
        THEN
            SELECT pk_message.get_message(i_lang, 'ADMINISTRATOR_T414') desc_color
              INTO l_desc_color
              FROM dual;
        
        ELSE
            SELECT pk_sysdomain.get_domain('BACKOFFICE_COLORS', l_dcs_color, i_lang) desc_color
              INTO l_desc_color
              FROM dual;
        
        END IF;
    
        IF l_id_country != l_id_country_nl
        THEN
        
            OPEN o_dcs_info FOR
                SELECT l_dcs_color color,
                       l_desc_color desc_color,
                       dcs.id_dep_clin_serv id_dcs,
                       dcs.flg_nurse_pre,
                       pk_sysdomain.get_domain('DEP_CLIN_SERV.FLG_NURSE_PRE', dcs.flg_nurse_pre, i_lang) desc_flg_nurse_pre,
                       l_flg_edit flg_edit
                  FROM dep_clin_serv dcs
                 WHERE dcs.id_dep_clin_serv = i_dcs;
        
        ELSE
        
            OPEN o_dcs_info FOR
                SELECT l_dcs_color color,
                       l_desc_color desc_color,
                       dcs.id_dep_clin_serv id_dcs,
                       dcs.flg_nurse_pre,
                       pk_sysdomain.get_domain('DEP_CLIN_SERV.FLG_NURSE_PRE', dcs.flg_nurse_pre, i_lang) desc_flg_nurse_pre,
                       l_flg_edit flg_edit,
                       dcs.flg_coding,
                       pk_sysdomain.get_domain('DEP_CLIN_SERV.FLG_CODING', dcs.flg_coding, i_lang) desc_flg_coding
                  FROM dep_clin_serv dcs
                 WHERE dcs.id_dep_clin_serv = i_dcs;
        
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN my_exception THEN
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
        WHEN OTHERS THEN
            pk_types.open_my_cursor(o_dcs_info);
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_DCS_INFO',
                                              o_error);
        
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_dcs_info;

    /********************************************************************************************
    * Set the edited info to a given dep_clin_serv
    *
    * @param i_lang              Language
    * @param i_prof              Professional array
    * @param i_id_institution    Institution ID
    * @param i_dcs               Dep_clin_serv ID
    * @param i_color             Color (Hex)
    * @param i_desc_code         Dep_clin_serv description
    * @param i_flg_nurse_pre     Dep_clin_serv info
    * @param i_flg_coding        Dep_clin_serv coding info
    * @param o_error             Error information
    
    * @return                    Return BOOLEAN 
    *
    * @author                    Sérgio Cunha
    * @version                   2.5.0.4
    * @since                     05/06/2009
    ********************************************************************************************/
    FUNCTION set_dcs_info
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN profissional,
        i_id_institution IN institution.id_institution%TYPE,
        i_dcs            IN dep_clin_serv.id_dep_clin_serv%TYPE,
        i_color          IN sch_color.color_hex%TYPE,
        i_flg_nurse_pre  IN dep_clin_serv.flg_nurse_pre%TYPE,
        i_flg_coding     IN dep_clin_serv.flg_coding%TYPE,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_id_sch_color sch_color.id_sch_color%TYPE;
    
    BEGIN
    
        IF i_flg_coding IS NULL
        THEN
        
            g_error := 'UPDATE DCS INFO';
            UPDATE dep_clin_serv dcs
               SET dcs.flg_nurse_pre = i_flg_nurse_pre
             WHERE dcs.id_dep_clin_serv = i_dcs;
        
        ELSE
        
            g_error := 'UPDATE DCS INFO';
            UPDATE dep_clin_serv dcs
               SET dcs.flg_nurse_pre = i_flg_nurse_pre, dcs.flg_coding = i_flg_coding
             WHERE dcs.id_dep_clin_serv = i_dcs;
        
        END IF;
    
        BEGIN
            g_error := 'GET SCH_COLOR ID';
            SELECT sc.id_sch_color
              INTO l_id_sch_color
              FROM sch_color sc
             WHERE sc.id_dep_clin_serv = i_dcs
               AND sc.flg_type = pk_alert_constant.g_flg_status_d;
        EXCEPTION
            WHEN no_data_found THEN
                l_id_sch_color := NULL;
        END;
    
        IF l_id_sch_color IS NULL
        THEN
            IF i_color IS NOT NULL
            THEN
                g_error := 'INSERT SCH_COLOR';
                INSERT INTO sch_color
                    (id_sch_color, id_institution, color_name, color_hex, flg_type, id_dep_clin_serv)
                VALUES
                    (seq_sch_color.nextval, i_id_institution, NULL, i_color, pk_alert_constant.g_flg_status_d, i_dcs);
            END IF;
        ELSE
            IF i_color IS NOT NULL
            THEN
                g_error := 'UPDATE SCH_COLOR';
                UPDATE sch_color sc
                   SET sc.color_hex = i_color
                 WHERE sc.id_sch_color = l_id_sch_color;
            ELSE
                g_error := 'DELETE SCH_COLOR';
                DELETE sch_color sc
                 WHERE sc.id_sch_color = l_id_sch_color;
            END IF;
        END IF;
    
        COMMIT;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_DCS_INFO',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END set_dcs_info;

    /********************************************************************************************
    * Get State List
    *
    * @param i_lang                Prefered language ID
    * @param i_code_domain         Code to obtain Options
    * @param i_code_message        Code message to be at 1st position of list
    * @param o_list                List od states
    * @param o_error               Error
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      SC
    * @version                     0.1
    * @since                       17/02/2009
    ********************************************************************************************/
    FUNCTION get_message_state_list
    (
        i_lang         IN language.id_language%TYPE,
        i_code_domain  sys_domain.code_domain%TYPE,
        i_code_message sys_message.code_message%TYPE,
        i_val          sys_message.flg_type%TYPE,
        o_list         OUT pk_types.cursor_type,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
        g_error := 'GET LIST CURSOR';
        OPEN o_list FOR
            SELECT i_val val, pk_message.get_message(i_lang, i_code_message) desc_val, NULL icon, -100 rank
              FROM dual
            UNION ALL
            SELECT val, desc_val, img_name icon, rank
              FROM sys_domain
             WHERE code_domain = i_code_domain
               AND domain_owner = pk_sysdomain.k_default_schema
               AND flg_available = pk_alert_constant.g_yes
               AND id_language = i_lang
             ORDER BY rank;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
        
            pk_types.open_my_cursor(o_list);
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_MESSAGE_STATE_LIST',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_message_state_list;

    /********************************************************************************************
    * Get Room Slot
    *
    * @param i_lang                Prefered language ID
    * @param i_prof                Professional identification
    * @param i_dep_clin_serv       Service/Speciality identification
    * @param o_room                Room Output
    * @param o_error               Error
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      Susana Silva
    * @version                     2.5.0.4
    * @since                       21/07/2009
    ********************************************************************************************/

    FUNCTION get_room_slot
    (
        i_lang          IN language.id_language%TYPE,
        i_prof          IN profissional,
        i_dep_clin_serv IN dep_clin_serv.id_dep_clin_serv%TYPE,
        o_room          OUT pk_types.cursor_type,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
    
        g_error := 'I_LANG/I_PROF/I_DEP_CLIN_SERV';
        pk_alertlog.log_debug('PK_BACKOFFICE.GET_ROOM_SLOT ' || g_error);
    
        IF i_lang IS NOT NULL
           AND i_prof IS NOT NULL
           AND i_dep_clin_serv IS NOT NULL
        THEN
        
            g_error := 'I_LANG/I_PROF/I_DEP_CLIN_SERV NOT NULL';
            pk_alertlog.log_debug('PK_BACKOFFICE.GET_ROOM_SLOT  ' || g_error);
        
            g_error := 'O_ROOM';
            pk_alertlog.log_debug('PK_BACKOFFICE.GET_ROOM_SLOT  ' || g_error);
        
            OPEN o_room FOR
            
                SELECT nvl(r.desc_room, pk_translation.get_translation(i_lang, r.code_room)) room_name, r.id_room
                  FROM room_dep_clin_serv rdcs, room r
                 WHERE r.id_room = rdcs.id_room
                   AND rdcs.id_dep_clin_serv = i_dep_clin_serv
                   AND r.flg_available = pk_alert_constant.g_yes
                 ORDER BY 1;
        
            RETURN TRUE;
        ELSE
            g_error := 'I_LANG/I_PROF/I_DEP_CLIN_SERV NULL';
            pk_alertlog.log_debug('PK_BACKOFFICE.GET_ROOM_SLOT  ' || g_error);
        
            RAISE my_exception;
        END IF;
    
    EXCEPTION
        WHEN my_exception THEN
            pk_alert_exceptions.process_error(i_lang     => i_lang,
                                              i_sqlcode  => SQLCODE,
                                              i_sqlerrm  => SQLERRM,
                                              i_message  => g_error,
                                              i_owner    => 'ALERT',
                                              i_package  => 'PK_BACKOFFICE',
                                              i_function => 'GET_ROOM_SLOT',
                                              o_error    => o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang     => i_lang,
                                              i_sqlcode  => SQLCODE,
                                              i_sqlerrm  => SQLERRM,
                                              i_message  => g_error,
                                              i_owner    => 'ALERT',
                                              i_package  => 'PK_BACKOFFICE',
                                              i_function => 'GET_ROOM_SLOT',
                                              o_error    => o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
    END get_room_slot;

    /********************************************************************************************
    * Get Professional attributes from USA
    *
    * @param i_lang                Prefered language ID
    * @param i_prof                Professional type (ID, INST, SOFTWARE)
    * @param i_id_professional     Professional ID
    * @param i_id_institution      Institution ID
    * @param o_prof_attr           Cursor with profissional attributes
    * @param o_error               Error
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      JTS
    * @version                     0.1
    * @since                       2009/09/22
    ********************************************************************************************/
    FUNCTION get_prof_attributes_usa
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN profissional,
        i_id_professional IN professional.id_professional%TYPE,
        i_id_institution  IN institution.id_institution%TYPE,
        o_prof_attr       OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        g_error := 'GET PROFESSIONAL ATTRIBUTES CURSOR';
        OPEN o_prof_attr FOR
            SELECT DISTINCT p.id_professional,
                            p.name,
                            p.title,
                            get_prof_title_desc(i_lang, p.title) desc_title,
                            p.first_name,
                            p.middle_name,
                            p.last_name,
                            p.short_name nick_name,
                            p.initials,
                            get_date_to_be_sent(i_lang, p.dt_birth) date_birth,
                            pk_date_utils.dt_chr(i_lang, p.dt_birth, profissional(0, i_id_institution, 0)) string_birth,
                            pk_sysdomain.get_domain('PROFESSIONAL.GENDER', p.gender, i_lang) desc_gender,
                            p.gender,
                            pk_sysdomain.get_domain('PROFESSIONAL.MARITAL_STATUS', p.marital_status, i_lang) desc_marital_status,
                            p.marital_status,
                            pk_translation.get_translation(i_lang,
                                                           (SELECT cat.code_category
                                                              FROM category cat, prof_cat pcat
                                                             WHERE pcat.id_professional = i_id_professional
                                                               AND pcat.id_institution = i_id_institution
                                                               AND pcat.id_category = cat.id_category
                                                               AND cat.flg_available = g_flg_avail)) cat,
                            (SELECT pcat.id_category
                               FROM prof_cat pcat
                              WHERE pcat.id_professional = i_id_professional
                                AND pcat.id_institution = i_id_institution) id_category,
                            decode((SELECT cat.flg_type
                                     FROM category cat, prof_cat pcat
                                    WHERE pcat.id_professional = i_id_professional
                                      AND pcat.id_institution = i_id_institution
                                      AND pcat.id_category = cat.id_category
                                      AND cat.flg_available = g_flg_avail),
                                   'D',
                                   'Y',
                                   'N') flg_clinical,
                            pk_translation.get_translation(i_lang,
                                                           (SELECT s.code_speciality
                                                              FROM speciality s
                                                             WHERE s.id_speciality = p.id_speciality
                                                               AND s.flg_available = g_flg_avail)) spec,
                            p.id_speciality,
                            p.num_order,
                            p.upin,
                            p.dea,
                            (SELECT pcat.id_category_sub
                               FROM prof_cat pcat
                              WHERE pcat.id_professional = i_id_professional
                                AND pcat.id_institution = i_id_institution) id_category_in_surgery,
                            pk_translation.get_translation(i_lang,
                                                           (SELECT cs.code_category_sub
                                                              FROM category_sub cs, prof_cat pcat
                                                             WHERE cs.id_category_sub = pcat.id_category_sub
                                                               AND pcat.id_professional = i_id_professional
                                                               AND pcat.id_institution = i_id_institution
                                                               AND cs.flg_available = g_flg_avail)) category_in_surgery,
                            
                            decode((SELECT DISTINCT (pi.num_mecan)
                                     FROM prof_institution pi
                                    WHERE pi.id_professional = p.id_professional
                                      AND pi.id_institution = i_id_institution
                                      AND pi.dt_end_tstz IS NULL),
                                   NULL,
                                   ((SELECT DISTINCT (pi.num_mecan)
                                       FROM prof_institution pi
                                      WHERE pi.id_professional = p.id_professional
                                        AND pi.id_institution = i_id_institution
                                        AND pi.dt_end_tstz =
                                            (SELECT MAX(pi2.dt_end_tstz)
                                               FROM prof_institution pi2
                                              WHERE pi2.id_professional = pi.id_professional
                                                AND pi2.id_institution = pi.id_institution))),
                                   (SELECT DISTINCT (pi.num_mecan)
                                      FROM prof_institution pi
                                     WHERE pi.id_professional = p.id_professional
                                       AND pi.id_institution = i_id_institution
                                       AND pi.dt_end_tstz IS NULL)) num_mecan,
                            get_prof_language(i_lang, p.id_professional, i_id_institution) desc_lang,
                            (SELECT id_language
                               FROM prof_preferences pp
                              WHERE pp.id_professional = p.id_professional
                                AND pp.id_institution = i_id_institution
                                AND pp.id_software = 0) id_lang,
                            decode((SELECT DISTINCT (pi.flg_state)
                                     FROM prof_institution pi
                                    WHERE pi.id_professional = p.id_professional
                                      AND pi.id_institution = i_id_institution
                                      AND pi.dt_end_tstz IS NULL),
                                   NULL,
                                   ((SELECT DISTINCT (pi.flg_state)
                                       FROM prof_institution pi
                                      WHERE pi.id_professional = p.id_professional
                                        AND pi.id_institution = i_id_institution
                                        AND pi.dt_end_tstz =
                                            (SELECT MAX(pi2.dt_end_tstz)
                                               FROM prof_institution pi2
                                              WHERE pi2.id_professional = pi.id_professional
                                                AND pi2.id_institution = pi.id_institution))),
                                   (SELECT DISTINCT (pi.flg_state)
                                      FROM prof_institution pi
                                     WHERE pi.id_professional = p.id_professional
                                       AND pi.id_institution = i_id_institution
                                       AND pi.dt_end_tstz IS NULL)) flg_state,
                            pk_sysdomain.get_domain('PROF_INSTITUTION.FLG_STATE',
                                                    decode((SELECT DISTINCT (pi.flg_state)
                                                             FROM prof_institution pi
                                                            WHERE pi.id_professional = p.id_professional
                                                              AND pi.id_institution = i_id_institution
                                                              AND pi.dt_end_tstz IS NULL),
                                                           NULL,
                                                           ((SELECT DISTINCT (pi.flg_state)
                                                               FROM prof_institution pi
                                                              WHERE pi.id_professional = p.id_professional
                                                                AND pi.id_institution = i_id_institution
                                                                AND pi.dt_end_tstz =
                                                                    (SELECT MAX(pi2.dt_end_tstz)
                                                                       FROM prof_institution pi2
                                                                      WHERE pi2.id_professional = pi.id_professional
                                                                        AND pi2.id_institution = pi.id_institution))),
                                                           (SELECT DISTINCT (pi.flg_state)
                                                              FROM prof_institution pi
                                                             WHERE pi.id_professional = p.id_professional
                                                               AND pi.id_institution = i_id_institution
                                                               AND pi.dt_end_tstz IS NULL)),
                                                    i_lang) desc_state,
                            p.adress_type,
                            pk_sysdomain.get_domain('PROFESSIONAL.ADRESS_TYPE', p.adress_type, i_lang) adress_type_desc,
                            p.address,
                            p.city,
                            p.district,
                            p.zip_code,
                            pk_translation.get_translation(i_lang,
                                                           (SELECT c.code_country
                                                              FROM country c
                                                             WHERE c.id_country = p.id_country)) country,
                            p.id_country,
                            p.work_phone,
                            p.num_contact,
                            p.cell_phone,
                            p.fax,
                            p.email,
                            pk_date_utils.date_hour_chr_extend_tsz(i_lang, p.update_time, i_prof) desc_adw_last_update,
                            p.code_scoolarship,
                            pk_translation.get_translation(i_lang,
                                                           'SCHOLARSHIP.CODE_SCHOLARSHIP.' || p.code_scoolarship) schoolarship_desc,
                            p.bleep_number,
                            decode((SELECT DISTINCT (pi.contact_detail)
                                     FROM prof_institution pi
                                    WHERE pi.id_professional = p.id_professional
                                      AND pi.id_institution = i_id_institution
                                      AND pi.dt_end_tstz IS NULL),
                                   NULL,
                                   ((SELECT DISTINCT (pi.contact_detail)
                                       FROM prof_institution pi
                                      WHERE pi.id_professional = p.id_professional
                                        AND pi.id_institution = i_id_institution
                                        AND pi.dt_end_tstz =
                                            (SELECT MAX(pi2.dt_end_tstz)
                                               FROM prof_institution pi2
                                              WHERE pi2.id_professional = pi.id_professional
                                                AND pi2.id_institution = pi.id_institution))),
                                   (SELECT DISTINCT (pi.contact_detail)
                                      FROM prof_institution pi
                                     WHERE pi.id_professional = p.id_professional
                                       AND pi.id_institution = i_id_institution
                                       AND pi.dt_end_tstz IS NULL)) contact_detail,
                            p.suffix,
                            p.county,
                            p.address_other_name
              FROM professional p
             WHERE p.id_professional = i_id_professional;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_ATTRIBUTES_USA',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
    END get_prof_attributes_usa;

    /********************************************************************************************
    * Get Professional attributes
    *
    * @param i_lang                Prefered language ID
    * @param i_prof                Professional type (ID, INST, SOFTWARE)
    * @param i_id_professional     Professional ID
    * @param i_id_institution      Institution ID
    * @param o_prof_attr           Cursor with profissional attributes
    * @param o_error               Error
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      JTS
    * @version                     0.1
    * @since                       2009/09/22
    ********************************************************************************************/
    FUNCTION get_prof_attributes
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN profissional,
        i_id_professional IN professional.id_professional%TYPE,
        i_id_institution  IN institution.id_institution%TYPE,
        o_prof_attr       OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        g_error := 'GET PROFESSIONAL ATTRIBUTES CURSOR';
        OPEN o_prof_attr FOR
            SELECT DISTINCT p.id_professional,
                            p.name,
                            p.title,
                            get_prof_title_desc(i_lang, p.title) desc_title,
                            p.first_name,
                            p.parent_name,
                            p.middle_name,
                            p.last_name,
                            p.first_name_sa,
                            p.parent_name_sa,
                            p.middle_name_sa,
                            p.last_name_sa,
                            p.short_name nick_name,
                            p.initials,
                            get_date_to_be_sent(i_lang, p.dt_birth) date_birth,
                            pk_date_utils.dt_chr(i_lang, p.dt_birth, profissional(0, i_id_institution, 0)) string_birth,
                            pk_sysdomain.get_domain('PROFESSIONAL.GENDER', p.gender, i_lang) desc_gender,
                            p.gender,
                            pk_sysdomain.get_domain('PROFESSIONAL.MARITAL_STATUS', p.marital_status, i_lang) desc_marital_status,
                            p.marital_status,
                            pk_translation.get_translation(i_lang,
                                                           (SELECT cat.code_category
                                                              FROM category cat, prof_cat pcat
                                                             WHERE pcat.id_professional = i_id_professional
                                                               AND pcat.id_institution = i_id_institution
                                                               AND pcat.id_category = cat.id_category
                                                               AND cat.flg_available = g_flg_avail)) cat,
                            (SELECT pcat.id_category
                               FROM prof_cat pcat
                              WHERE pcat.id_professional = i_id_professional
                                AND pcat.id_institution = i_id_institution) id_category,
                            decode((SELECT cat.flg_type
                                     FROM category cat, prof_cat pcat
                                    WHERE pcat.id_professional = i_id_professional
                                      AND pcat.id_institution = i_id_institution
                                      AND pcat.id_category = cat.id_category
                                      AND cat.flg_available = g_flg_avail),
                                   'D',
                                   'Y',
                                   'N') flg_clinical,
                            pk_translation.get_translation(i_lang,
                                                           (SELECT s.code_speciality
                                                              FROM speciality s
                                                             WHERE s.id_speciality = p.id_speciality
                                                               AND s.flg_available = g_flg_avail)) spec,
                            p.id_speciality,
                            p.id_scholarship,
                            pk_translation.get_translation(i_lang,
                                                           (SELECT s.code_scholarship
                                                              FROM scholarship s
                                                             WHERE s.id_scholarship = p.id_scholarship)) desc_scholarship,
                            p.id_agrupacion,
                            pk_translation.get_translation(i_lang      => i_lang,
                                                           i_code_mess => (SELECT sg.code_scholarship_group
                                                                             FROM alert_adtcod_cfg.scholarship_group sg
                                                                            WHERE sg.id_scholarship_group =
                                                                                  p.id_agrupacion)) desc_agrupacion,
                            p.num_order,
                            (SELECT pcat.id_category_sub
                               FROM prof_cat pcat
                              WHERE pcat.id_professional = i_id_professional
                                AND pcat.id_institution = i_id_institution) id_category_in_surgery,
                            pk_translation.get_translation(i_lang,
                                                           (SELECT cs.code_category_sub
                                                              FROM category_sub cs, prof_cat pcat
                                                             WHERE cs.id_category_sub = pcat.id_category_sub
                                                               AND pcat.id_professional = i_id_professional
                                                               AND pcat.id_institution = i_id_institution
                                                               AND cs.flg_available = g_flg_avail)) category_in_surgery,
                            
                            decode((SELECT DISTINCT (pi.num_mecan)
                                     FROM prof_institution pi
                                    WHERE pi.id_professional = p.id_professional
                                      AND pi.flg_state = pk_alert_constant.g_active
                                      AND pi.id_institution = i_id_institution
                                      AND pi.dt_end_tstz IS NULL),
                                   NULL,
                                   ((SELECT DISTINCT (pi.num_mecan)
                                       FROM prof_institution pi
                                      WHERE pi.id_professional = p.id_professional
                                        AND pi.flg_state = pk_alert_constant.g_active
                                        AND pi.id_institution = i_id_institution
                                        AND pi.dt_end_tstz =
                                            (SELECT MAX(pi2.dt_end_tstz)
                                               FROM prof_institution pi2
                                              WHERE pi2.id_professional = pi.id_professional
                                                AND pi2.flg_state = pk_alert_constant.g_active
                                                AND pi2.id_institution = pi.id_institution))),
                                   (SELECT DISTINCT (pi.num_mecan)
                                      FROM prof_institution pi
                                     WHERE pi.id_professional = p.id_professional
                                       AND pi.flg_state = pk_alert_constant.g_active
                                       AND pi.id_institution = i_id_institution
                                       AND pi.dt_end_tstz IS NULL)) num_mecan,
                            (SELECT pk_translation.get_translation(i_lang, 'LANGUAGE.CODE_LANGUAGE.' || id_language)
                               FROM prof_preferences pp
                              WHERE pp.id_professional = p.id_professional
                                AND pp.id_institution = i_id_institution
                                AND pp.id_software = 0) desc_lang,
                            (SELECT id_language
                               FROM prof_preferences pp
                              WHERE pp.id_professional = p.id_professional
                                AND pp.id_institution = i_id_institution
                                AND pp.id_software = 0) id_lang,
                            nvl((SELECT pi.flg_state
                                  FROM prof_institution pi
                                 WHERE pi.id_professional = p.id_professional
                                   AND pi.id_institution = i_id_institution
                                   AND pi.dt_end_tstz IS NULL),
                                p.flg_state) flg_state,
                            pk_sysdomain.get_domain('PROF_INSTITUTION.FLG_STATE',
                                                    nvl((SELECT pi.flg_state
                                                          FROM prof_institution pi
                                                         WHERE pi.id_professional = p.id_professional
                                                           AND pi.id_institution = i_id_institution
                                                           AND pi.dt_end_tstz IS NULL),
                                                        p.flg_state),
                                                    i_lang) desc_state,
                            NULL AS adress_type,
                            NULL adress_type_desc,
                            p.address,
                            p.city,
                            p.district,
                            p.zip_code,
                            pk_translation.get_translation(i_lang,
                                                           (SELECT c.code_country
                                                              FROM country c
                                                             WHERE c.id_country = p.id_country)) country,
                            p.id_country,
                            p.work_phone,
                            p.num_contact,
                            p.cell_phone,
                            p.fax,
                            p.email,
                            pk_date_utils.date_hour_chr_extend_tsz(i_lang, p.update_time, i_prof) desc_adw_last_update,
                            p.bleep_number,
                            decode((SELECT DISTINCT (pi.contact_detail)
                                     FROM prof_institution pi
                                    WHERE pi.id_professional = p.id_professional
                                      AND pi.flg_state = pk_alert_constant.g_active
                                      AND pi.id_institution = i_id_institution
                                      AND pi.dt_end_tstz IS NULL),
                                   NULL,
                                   ((SELECT DISTINCT (pi.contact_detail)
                                       FROM prof_institution pi
                                      WHERE pi.id_professional = p.id_professional
                                        AND pi.flg_state = pk_alert_constant.g_active
                                        AND pi.id_institution = i_id_institution
                                        AND pi.dt_end_tstz =
                                            (SELECT MAX(pi2.dt_end_tstz)
                                               FROM prof_institution pi2
                                              WHERE pi2.id_professional = pi.id_professional
                                                AND pi2.flg_state = pk_alert_constant.g_active
                                                AND pi2.id_institution = pi.id_institution))),
                                   (SELECT DISTINCT (pi.contact_detail)
                                      FROM prof_institution pi
                                     WHERE pi.id_professional = p.id_professional
                                       AND pi.flg_state = pk_alert_constant.g_active
                                       AND pi.id_institution = i_id_institution
                                       AND pi.dt_end_tstz IS NULL)) contact_detail,
                            p.id_road id_road,
                            (SELECT sm.desc_settlement
                               FROM alert_adtcod_cfg.settlement_mx sm
                              WHERE sm.id_settlement = p.id_road) desc_road,
                            p.id_entity id_entity,
                            pk_translation.get_translation(i_lang      => i_lang,
                                                           i_code_mess => rbrc.code_rb_regional_classifier) desc_entity,
                            p.id_jurisdiction,
                            pk_translation.get_translation(i_lang      => i_lang,
                                                           i_code_mess => rbrcj.code_rb_regional_classifier) desc_jurisdiction,
                            p.id_municip id_municip,
                            pk_translation.get_translation(i_lang      => i_lang,
                                                           i_code_mess => rbrcp.code_rb_regional_classifier) desc_municip,
                            p.id_localidad id_localid,
                            pk_translation.get_translation(i_lang      => i_lang,
                                                           i_code_mess => rbrca.code_rb_regional_classifier) desc_localid,
                            pd.id_doc_type,
                            decode(dt.id_doc_type, NULL, NULL, pk_translation.get_translation(i_lang, dt.code_doc_type)) desc_doc_type,
                            pd.value value_doc_type,
                            pk_date_utils.get_timestamp_str(i_lang, i_prof, pd.dt_expire_tstz, NULL) dt_expire_doc_str,
                            p.taxpayer_number,
                            p.clinical_name,
                            p.id_agrupacion_instit,
                            (SELECT institution_name
                               FROM institution_ext
                              WHERE id_institution = p.id_agrupacion_instit) agrupacion_instit_name
              FROM professional p
              LEFT JOIN prof_doc pd
                ON pd.id_professional = p.id_professional
               AND pd.id_institution = i_id_institution
              LEFT JOIN doc_type dt
                ON dt.id_doc_type = pd.id_doc_type
              LEFT JOIN rb_regional_classifier rbrc
                ON p.id_entity = rbrc.id_rb_regional_classifier
              LEFT JOIN rb_regional_classifier rbrcj
                ON p.id_jurisdiction = rbrcj.id_rb_regional_classifier
              LEFT JOIN rb_regional_classifier rbrcp
                ON p.id_municip = rbrcp.id_rb_regional_classifier
              LEFT JOIN rb_regional_classifier rbrca
                ON p.id_localidad = rbrca.id_rb_regional_classifier
             WHERE p.id_professional = i_id_professional;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_ATTRIBUTES',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
    END get_prof_attributes;

    /********************************************************************************************
      * Get Professional attributes (CDA)
      *
      * @param i_lang                Prefered language ID
      * @param i_prof                Professional type (ID, INST, SOFTWARE)
      * @param i_id_professional     Professional ID
      * @param i_id_institution      Institution ID
      * @param o_prof_attr           Cursor with profissional attributes
      * @param o_error               Error
      *
      *
      * @return                      true or false on success or error
      *
      * @author                      Andr?Silva
    * @version             2.7.0.0
      * @since                       2016/12/21
      ********************************************************************************************/
    FUNCTION get_prof_attributes_cda
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN profissional,
        i_id_professional IN professional.id_professional%TYPE,
        i_id_institution  IN institution.id_institution%TYPE,
        o_prof_attr       OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        g_error := 'GET PROFESSIONAL ATTRIBUTES CURSOR';
        OPEN o_prof_attr FOR
            SELECT DISTINCT p.id_professional,
                            p.first_name,
                            p.last_name,
                            p.city,
                            p.district,
                            p.zip_code,
                            (SELECT c.code_country
                               FROM country c
                              WHERE c.id_country = p.id_country) country,
                            pk_translation.get_translation(i_lang      => i_lang,
                                                           i_code_mess => rbrca.code_rb_regional_classifier) desc_entity,
                            pk_translation.get_translation(i_lang      => i_lang,
                                                           i_code_mess => rbrcp.code_rb_regional_classifier) desc_municip,
                            pk_translation.get_translation(i_lang      => i_lang,
                                                           i_code_mess => rbrc.code_rb_regional_classifier) desc_localid
              FROM professional p
              LEFT JOIN rb_regional_classifier rbrca
                ON p.id_entity = rbrca.id_rb_regional_classifier
              LEFT JOIN rb_regional_classifier rbrcp
                ON p.id_municip = rbrcp.id_rb_regional_classifier
              LEFT JOIN rb_regional_classifier rbrc
                ON p.id_localidad = rbrc.id_rb_regional_classifier
             WHERE p.id_professional = i_id_professional;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_ATTRIBUTES_CDA',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
    END get_prof_attributes_cda;

    /********************************************************************************************
    * Get Institution Country ID
    *
    * @param i_lang                Prefered language ID
    * @param i_id_institution      Institution ID
    * @param O_error               Error
    *
    *
    * @return                      Country ID
    *
    * @author                      JTS
    * @version                     0.1
    * @since                       2009/09/22
    ********************************************************************************************/
    FUNCTION get_institution_country
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        o_error          OUT t_error_out
    ) RETURN inst_attributes.id_country%TYPE IS
    
        l_id_country inst_attributes.id_country%TYPE := 0;
    
    BEGIN
    
        SELECT nvl((SELECT ia.id_country
                     FROM inst_attributes ia
                    WHERE ia.id_institution = i_id_institution
                      AND ia.flg_available = pk_alert_constant.g_available),
                   0)
          INTO l_id_country
          FROM dual;
    
        RETURN l_id_country;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_INSTITUTION_COUNTRY',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN l_id_country;
        
    END get_institution_country;

    /********************************************************************************************
    * Find a professional based on accounts values
    *
    * @param i_lang                  Prefered language ID
    * @param i_accounts              Accounts ID's
    * @param i_accounts_val          Accounts values
    * @param o_professional          Professional ID
    * @param o_error                 error    
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      Tércio Soares
    * @version                     0.1
    * @since                       2009/12/12
    ********************************************************************************************/

    FUNCTION get_id_professional
    (
        i_lang         IN language.id_language%TYPE,
        i_accounts     IN table_number,
        i_accounts_val IN table_varchar,
        o_professional OUT professional.id_professional%TYPE,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_id_profissional NUMBER;
    
    BEGIN
    
        o_professional := NULL;
    
        FOR i IN 1 .. i_accounts.count
        LOOP
        
            g_error := 'SELECT PROFESSIONAL BY ACCOUNT VALUE: ' || to_char(i_accounts(i)) || i_accounts_val(i);
            pk_alertlog.log_debug('PK_BACKOFFICE.GET_ID_PROFESSIONAL: ' || g_error);
            SELECT nvl((SELECT pa.id_professional
                         FROM prof_accounts pa
                        WHERE pa.id_account = i_accounts(i)
                          AND pa.value = i_accounts_val(i)
                          AND pa.id_institution = 0
                          AND rownum = 1),
                       NULL)
              INTO l_id_profissional
              FROM dual;
        
            IF o_professional IS NOT NULL
               AND l_id_profissional IS NOT NULL
            THEN
            
                IF o_professional != l_id_profissional
                THEN
                    o_professional := NULL;
                    EXIT;
                END IF;
            
            ELSIF o_professional IS NULL
                  AND l_id_profissional IS NOT NULL
            THEN
            
                o_professional := l_id_profissional;
            
            END IF;
        
        END LOOP;
    
        RETURN TRUE;
    
    EXCEPTION
    
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_ID_PROFISSIONAL',
                                              o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
        
    END get_id_professional;

    /********************************************************************************************
    * Find an institution based on accounts values
    *
    * @param i_lang                  Prefered language ID
    * @param i_accounts              Accounts ID's
    * @param i_accounts_val          Accounts values
    * @param o_institution           Institution ID
    * @param o_error                 error    
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      Tércio Soares
    * @version                     0.1
    * @since                       2009/12/12
    ********************************************************************************************/

    FUNCTION get_id_institution
    (
        i_lang         IN language.id_language%TYPE,
        i_accounts     IN table_number,
        i_accounts_val IN table_varchar,
        o_institution  OUT professional.id_professional%TYPE,
        o_error        OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_id_institution NUMBER;
    
    BEGIN
    
        o_institution := NULL;
    
        FOR i IN 1 .. i_accounts.count
        LOOP
        
            g_error := 'SELECT INSTITUTION BY ACCOUNT VALUE: ' || to_char(i_accounts(i)) || i_accounts_val(i);
            pk_alertlog.log_debug('PK_BACKOFFICE.GET_ID_INSTITUTION: ' || g_error);
            SELECT nvl((SELECT ia.id_institution
                         FROM institution_accounts ia
                        WHERE ia.id_account = i_accounts(i)
                          AND ia.value = i_accounts_val(i)
                          AND rownum = 1),
                       NULL)
              INTO l_id_institution
              FROM dual;
        
            IF o_institution IS NOT NULL
               AND l_id_institution IS NOT NULL
            THEN
            
                IF o_institution != l_id_institution
                THEN
                    o_institution := NULL;
                    EXIT;
                END IF;
            
            ELSIF o_institution IS NULL
                  AND l_id_institution IS NOT NULL
            THEN
            
                o_institution := l_id_institution;
            
            END IF;
        
        END LOOP;
    
        RETURN TRUE;
    
    EXCEPTION
    
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_ID_INSTITUTION',
                                              o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
        
    END get_id_institution;

    /********************************************************************************************
    * Update/insert information for an external user
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_prof               Professional ID
    * @param i_title                 Professional Title
    * @param i_first_name            Professional first name
    * @param i_middle_name           Professional middle name
    * @param i_last_name             Professional last name
    * @param i_nickname              Professional Nickname
    * @param i_initials              Professional initials
    * @param i_dt_birth              Professional Date of Birth
    * @param i_gender                Professioanl gender
    * @param i_marital_status        Professional marital status
    * @param i_id_speciality         Professional specialty
    * @param i_num_order             Professional license number
    * @param i_address               Professional adress
    * @param i_city                  Professional city
    * @param i_district              Professional district
    * @param i_zip_code              Professional zip code
    * @param i_id_country            Professional cpuntry
    * @param i_phone                 Professional phone
    * @param i_mobile_phone          Professional mobile phone
    * @param i_fax                   Professional fax
    * @param i_email                 Professional email
    * @param o_professional          Professional ID
    * @param o_error                 error    
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      Tércio Soares
    * @version                     0.1
    * @since                       2009/12/14
    ********************************************************************************************/
    FUNCTION set_ext_professional
    (
        i_lang           IN language.id_language%TYPE,
        i_id_prof        IN professional.id_professional%TYPE,
        i_title          IN professional.title%TYPE,
        i_first_name     IN professional.first_name%TYPE,
        i_parent_name    IN professional.parent_name%TYPE,
        i_middle_name    IN professional.middle_name%TYPE,
        i_last_name      IN professional.last_name%TYPE,
        i_nickname       IN professional.nick_name%TYPE,
        i_initials       IN professional.initials%TYPE,
        i_dt_birth       IN professional.dt_birth%TYPE,
        i_gender         IN professional.gender%TYPE,
        i_marital_status IN professional.marital_status%TYPE,
        i_id_speciality  IN professional.id_speciality%TYPE,
        i_num_order      IN professional.num_order%TYPE,
        i_address        IN professional.address%TYPE,
        i_city           IN professional.city%TYPE,
        i_district       IN professional.district%TYPE,
        i_zip_code       IN professional.zip_code%TYPE,
        i_id_country     IN professional.id_country%TYPE,
        i_phone          IN professional.work_phone%TYPE,
        i_num_contact    IN professional.num_contact%TYPE,
        i_mobile_phone   IN professional.cell_phone%TYPE,
        i_fax            IN professional.fax%TYPE,
        i_email          IN professional.email%TYPE,
        i_id_institution IN prof_institution.id_institution%TYPE,
        i_commit_at_end  IN BOOLEAN,
        o_professional   OUT professional.id_professional%TYPE,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_name        professional.name%TYPE;
        l_second_name professional.middle_name%TYPE;
        l_last_name   professional.last_name%TYPE;
        l_id_country  professional.id_country%TYPE;
    
        my_exception EXCEPTION;
        l_error VARCHAR(4000);
    
        l_flg_state prof_institution.flg_state%TYPE;
        l_oerror    t_error_out;
    
        -- 2011/04/20 RMGM: added dn_flg_status validation
        l_mkt_prof         institution.id_market%TYPE;
        l_dn_status        institution.dn_flg_status%TYPE;
        l_prof_institution prof_institution.id_prof_institution%TYPE := 0;
    
    BEGIN
        g_sysdate := SYSDATE;
    
        SELECT nvl(i.id_market, 0)
          INTO l_mkt_prof
          FROM institution i
         WHERE i.id_institution = i_id_institution;
    
        IF l_mkt_prof = 5
        THEN
            l_dn_status := 'I';
        ELSE
            l_dn_status := 'V';
        END IF;
    
        IF (i_first_name IS NULL AND i_middle_name IS NULL AND i_last_name IS NULL)
           OR i_nickname IS NULL
        THEN
            l_error := pk_message.get_message(i_lang, 'PROFESSIONAL_M001');
            RAISE my_exception;
        ELSIF i_gender IS NULL
        THEN
            l_error := pk_message.get_message(i_lang, 'PROFESSIONAL_M002');
            RAISE my_exception;
        ELSE
            IF i_id_country = -1
               OR i_id_country IS NULL
            THEN
                l_id_country := NULL;
            ELSE
                l_id_country := i_id_country;
            END IF;
        
            l_name := create_name_formated(i_lang,
                                           i_id_institution,
                                           i_first_name,
                                           i_parent_name,
                                           i_middle_name,
                                           i_last_name);
        
            IF i_id_prof IS NULL
            THEN
            
                g_error := 'INSERT INTO PROFESSIONAL';
                pk_api_ab_tables.upd_ins_into_ab_user_info(i_id_ab_user_info    => NULL,
                                                           i_login              => NULL,
                                                           i_password           => NULL,
                                                           i_import_code        => NULL,
                                                           i_record_status      => g_prof_flg_state_active,
                                                           i_institution_key    => i_id_institution,
                                                           i_flg_is_enable      => g_prof_flg_state_active,
                                                           i_first_name         => i_first_name,
                                                           i_last_name          => i_last_name,
                                                           i_full_name          => create_name_formated(i_lang,
                                                                                                        i_id_institution,
                                                                                                        i_first_name,
                                                                                                        i_parent_name,
                                                                                                        i_middle_name,
                                                                                                        i_last_name),
                                                           i_external_system    => NULL,
                                                           i_external_system_id => NULL,
                                                           i_secret_quest       => NULL,
                                                           i_secret_answ        => NULL,
                                                           i_id_language        => NULL,
                                                           i_flg_temporary      => 'N',
                                                           i_date_creation_tstz => NULL,
                                                           o_id_ab_user_info    => o_professional);
                INSERT INTO professional
                    (id_professional,
                     name,
                     nick_name,
                     dt_birth,
                     address,
                     district,
                     city,
                     zip_code,
                     num_contact,
                     marital_status,
                     gender,
                     flg_state,
                     num_order,
                     id_speciality,
                     id_country,
                     initials,
                     title,
                     short_name,
                     work_phone,
                     cell_phone,
                     fax,
                     email,
                     first_name,
                     middle_name,
                     last_name)
                VALUES
                    (o_professional,
                     l_name,
                     i_nickname || decode(i_title, NULL, NULL, ', ' || get_prof_title_desc(i_lang, i_title)),
                     i_dt_birth,
                     i_address,
                     i_district,
                     i_city,
                     i_zip_code,
                     i_num_contact,
                     i_marital_status,
                     i_gender,
                     g_active,
                     i_num_order,
                     i_id_speciality,
                     l_id_country,
                     i_initials,
                     i_title,
                     i_nickname,
                     i_phone,
                     i_mobile_phone,
                     i_fax,
                     i_email,
                     i_first_name,
                     i_middle_name,
                     i_last_name);
                ins_professional_hist(i_id_professional => o_professional, i_operation_type => g_prof_hist_oper_c);
                g_error := 'INSERT INTO PROF_INSTITUTION';
                pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                               i_id_professional     => o_professional,
                                                               i_id_institution      => i_id_institution,
                                                               i_flg_state           => pk_alert_constant.g_active,
                                                               i_dt_begin_tstz       => g_sysdate_tstz,
                                                               i_flg_external        => pk_alert_constant.g_yes,
                                                               i_dn_flg_status       => l_dn_status,
                                                               o_id_prof_institution => l_prof_institution);
            
            ELSE
            
                g_error := 'UPDATE PROFESSIONAL';
                pk_api_ab_tables.upd_ins_into_ab_user_info(i_id_ab_user_info    => i_id_prof,
                                                           i_login              => NULL,
                                                           i_password           => NULL,
                                                           i_import_code        => NULL,
                                                           i_record_status      => g_prof_flg_state_active,
                                                           i_institution_key    => i_id_institution,
                                                           i_flg_is_enable      => g_prof_flg_state_active,
                                                           i_first_name         => i_first_name,
                                                           i_last_name          => i_last_name,
                                                           i_full_name          => create_name_formated(i_lang,
                                                                                                        i_id_institution,
                                                                                                        i_first_name,
                                                                                                        i_parent_name,
                                                                                                        i_middle_name,
                                                                                                        i_last_name),
                                                           i_external_system    => NULL,
                                                           i_external_system_id => NULL,
                                                           i_secret_quest       => NULL,
                                                           i_secret_answ        => NULL,
                                                           i_id_language        => NULL,
                                                           i_flg_temporary      => 'N',
                                                           i_date_creation_tstz => NULL,
                                                           o_id_ab_user_info    => o_professional);
                UPDATE professional
                   SET name           = l_name,
                       nick_name      = i_nickname ||
                                        decode(i_title, NULL, NULL, ', ' || get_prof_title_desc(i_lang, i_title)),
                       dt_birth       = i_dt_birth,
                       address        = i_address,
                       district       = i_district,
                       city           = i_city,
                       zip_code       = i_zip_code,
                       num_contact    = i_num_contact,
                       marital_status = i_marital_status,
                       gender         = i_gender,
                       num_order      = i_num_order,
                       id_speciality  = i_id_speciality,
                       id_country     = l_id_country,
                       initials       = i_initials,
                       title          = i_title,
                       short_name     = i_nickname,
                       work_phone     = i_phone,
                       cell_phone     = i_mobile_phone,
                       fax            = i_fax,
                       email          = i_email,
                       first_name     = i_first_name,
                       middle_name    = i_middle_name,
                       last_name      = i_last_name
                 WHERE id_professional = o_professional;
                ins_professional_hist(i_id_professional => o_professional, i_operation_type => g_prof_hist_oper_u);
            END IF;
        END IF;
    
        IF i_commit_at_end
        THEN
            COMMIT;
        END IF;
        RETURN TRUE;
    
    EXCEPTION
        WHEN my_exception THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              l_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_EXT_PROFESSIONAL',
                                              'U',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_EXT_PROFESSIONAL',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
    END set_ext_professional;

    /********************************************************************************************
    * Create/Update external institution
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_institution        Institution ID
    * @param i_id_inst_att           Institution Attibutes ID
    * @param i_desc                  Institution name
    * @param i_id_parent             Parent Institution ID
    * @param i_flg_type              Flag type for institution - H - Hospital, C - Primary Care, P - Private Practice
    * @param i_abbreviation          Institution abbreviation
    * @param i_phone_number          Institution phone
    * @param i_fax                   Institution fax
    * @param i_email                 Institution email
    * @param i_ext_code              Institution Code
    * @param i_adress                Institution address
    * @param i_location              Institution location
    * @param i_district              Institution district
    * @param i_zip_code              Institution zip code
    * @param i_country               Institution Country ID
    * @param i_flg_available         Available - Y - Yes, N - No 
    * @param i_id_tz_region          Institution timezone ID    
    * @param i_id_market             Institution Market id
    * @param i_commit_at_end         Commit changes in this function - Y - Yes, N - No 
    * @param o_id_institution        institution ID
    * @param o_error                 error    
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      Tércio Soares
    * @version                     0.1
    * @since                       2009/12/14
    ********************************************************************************************/
    FUNCTION set_ext_institution
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        i_id_inst_att    IN inst_attributes.id_inst_attributes%TYPE,
        i_desc           IN VARCHAR2,
        i_id_parent      IN institution.id_parent%TYPE,
        i_flg_type       IN institution.flg_type%TYPE,
        i_abbreviation   IN institution.abbreviation%TYPE,
        i_phone_number   IN institution.phone_number%TYPE,
        i_fax            IN institution.fax_number%TYPE,
        i_email          IN inst_attributes.email%TYPE,
        i_ext_code       IN institution.ext_code%TYPE,
        i_adress         IN institution.address%TYPE,
        i_location       IN institution.location%TYPE,
        i_district       IN institution.district%TYPE,
        i_zip_code       IN institution.zip_code%TYPE,
        i_country        IN inst_attributes.id_country%TYPE,
        i_flg_available  IN institution.flg_available%TYPE,
        i_id_tz_region   IN institution.id_timezone_region%TYPE,
        i_id_market      IN market.id_market%TYPE,
        i_commit_at_end  IN BOOLEAN,
        o_id_institution OUT institution.id_institution%TYPE,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
        my_exception EXCEPTION;
    
        --TRANSLATION
        l_id_lang  language.id_language%TYPE;
        l_code_trl translation.code_translation%TYPE := 'AB_INSTITUTION.CODE_INSTITUTION.';
    
        l_id_inst_attributes inst_attributes.id_inst_attributes%TYPE;
    
        -- 2011/04/20 RMGM: added dn_flg_status validation
        l_dn_status institution.dn_flg_status%TYPE;
    
        CURSOR c_language IS
            SELECT l.id_language
              FROM LANGUAGE l
             WHERE l.flg_available = pk_alert_constant.g_available;
    
    BEGIN
        g_sysdate := SYSDATE;
        IF i_id_market = 5
        THEN
            l_dn_status := 'I';
        ELSE
            l_dn_status := 'V';
        END IF;
    
        IF i_desc IS NULL
        THEN
            g_error := 'Invalid Institution Name';
            RAISE my_exception;
        ELSIF i_flg_type IS NULL
        THEN
            g_error := 'Invalid Type of Insitution';
            RAISE my_exception;
        ELSIF i_flg_available IS NULL
        THEN
            g_error := 'Please Choose Available: Y/N';
            RAISE my_exception;
        ELSIF i_id_institution IS NULL
        THEN
        
            g_error := 'INSERT INTO INSTITUTION';
            pk_api_ab_tables.upd_ins_into_ab_institution(i_id_ab_institution          => i_id_institution,
                                                         i_import_code                => NULL,
                                                         i_record_status              => 'A',
                                                         i_id_ab_market               => i_id_market,
                                                         i_code                       => NULL,
                                                         i_description                => i_desc,
                                                         i_alt_description            => NULL,
                                                         i_shortname                  => i_abbreviation,
                                                         i_vat_registration           => NULL,
                                                         i_timezone_region_code       => NULL,
                                                         i_rb_country_key             => i_country, --id_country
                                                         i_rb_regional_classifier_key => NULL,
                                                         i_id_ab_institution_parent   => i_id_parent,
                                                         i_flg_type                   => i_flg_type,
                                                         i_address1                   => i_adress,
                                                         i_address2                   => i_location,
                                                         i_address3                   => i_district,
                                                         i_zip_code                   => i_zip_code,
                                                         i_zip_code_description       => NULL,
                                                         i_fax_number                 => i_fax,
                                                         i_phone_number               => i_phone_number,
                                                         i_email                      => i_email,
                                                         i_logo                       => NULL,
                                                         i_web_site                   => NULL,
                                                         i_geo_location_key           => NULL,
                                                         i_flg_external               => pk_alert_constant.g_yes,
                                                         i_code_institution           => NULL,
                                                         i_flg_available              => i_flg_available,
                                                         i_rank                       => 1,
                                                         i_barcode                    => NULL,
                                                         i_ine_location               => 'N/A',
                                                         i_id_timezone_region         => i_id_tz_region,
                                                         i_ext_code                   => i_ext_code,
                                                         i_dn_flg_status              => l_dn_status,
                                                         i_adress_type                => NULL,
                                                         i_contact_det                => NULL,
                                                         o_id_ab_institution          => o_id_institution);
        
            g_error := 'GET SEQ_INST_ATTRIBUTES.NEXTVAL';
            SELECT seq_inst_attributes.nextval
              INTO l_id_inst_attributes
              FROM dual;
        
            g_error := 'INSERT INTO INST_ATTRIBUTES';
            INSERT INTO inst_attributes
                (id_country, id_institution, id_inst_attributes, email, flg_available)
            VALUES
                (i_country, o_id_institution, l_id_inst_attributes, i_email, i_flg_available);
        
            g_error := 'GET LANGUAGES';
            OPEN c_language;
            LOOP
                FETCH c_language
                    INTO l_id_lang;
                EXIT WHEN c_language%NOTFOUND;
            
                g_error := 'INSERT_INTO_TRANSLATION INSTITUTION';
                pk_translation.insert_into_translation(l_id_lang, l_code_trl || o_id_institution, i_desc);
            
            END LOOP;
        
            CLOSE c_language;
        
        ELSE
            g_error := 'UPDATE INSTITUTION';
            pk_api_ab_tables.upd_ins_into_ab_institution(i_id_ab_institution          => i_id_institution,
                                                         i_import_code                => NULL,
                                                         i_record_status              => 'A',
                                                         i_id_ab_market               => i_id_market,
                                                         i_code                       => NULL,
                                                         i_description                => NULL,
                                                         i_alt_description            => NULL,
                                                         i_shortname                  => i_abbreviation,
                                                         i_vat_registration           => NULL,
                                                         i_timezone_region_code       => NULL,
                                                         i_rb_country_key             => i_country, --id_country
                                                         i_rb_regional_classifier_key => NULL,
                                                         i_id_ab_institution_parent   => i_id_parent,
                                                         i_flg_type                   => i_flg_type,
                                                         i_address1                   => i_adress,
                                                         i_address2                   => i_location,
                                                         i_address3                   => i_district,
                                                         i_zip_code                   => i_zip_code,
                                                         i_zip_code_description       => NULL,
                                                         i_fax_number                 => i_fax,
                                                         i_phone_number               => i_phone_number,
                                                         i_email                      => i_email,
                                                         i_logo                       => NULL,
                                                         i_web_site                   => NULL,
                                                         i_geo_location_key           => NULL,
                                                         i_flg_external               => pk_alert_constant.g_yes,
                                                         i_code_institution           => NULL,
                                                         i_flg_available              => i_flg_available,
                                                         i_rank                       => NULL,
                                                         i_barcode                    => NULL,
                                                         i_ine_location               => 'N/A',
                                                         i_id_timezone_region         => i_id_tz_region,
                                                         i_ext_code                   => i_ext_code,
                                                         i_dn_flg_status              => l_dn_status,
                                                         i_adress_type                => NULL,
                                                         i_contact_det                => NULL,
                                                         o_id_ab_institution          => o_id_institution);
            pk_api_ab_tables.upd_ab_institution(id_ab_institution_in => i_id_institution,
                                                shortname_in         => i_abbreviation,
                                                shortname_nin        => FALSE,
                                                description_in       => i_desc,
                                                description_nin      => FALSE,
                                                address1_in          => i_adress,
                                                address1_nin         => FALSE,
                                                address2_in          => i_location,
                                                address2_nin         => FALSE,
                                                fax_number_in        => i_fax,
                                                fax_number_nin       => FALSE,
                                                zip_code_in          => i_zip_code,
                                                zip_code_nin         => FALSE,
                                                email_in             => i_email,
                                                email_nin            => FALSE,
                                                phone_number_in      => i_phone_number,
                                                phone_number_nin     => FALSE,
                                                ext_code_in          => i_ext_code,
                                                ext_code_nin         => FALSE);
        
            SELECT nvl((SELECT ia.id_inst_attributes
                         FROM inst_attributes ia
                        WHERE ia.id_institution = o_id_institution),
                       0)
              INTO l_id_inst_attributes
              FROM dual;
            IF i_id_inst_att IS NULL
               AND l_id_inst_attributes IS NULL
            THEN
                g_error := 'INSERT INST_ATTRIBUTES';
                INSERT INTO inst_attributes
                    (id_country, id_institution, id_inst_attributes, email, flg_available)
                VALUES
                    (i_country, o_id_institution, seq_inst_attributes.nextval, i_email, i_flg_available);
            
            ELSE
                g_error := 'UPDATE INST_ATTRIBUTES';
                UPDATE inst_attributes
                   SET id_country     = i_country,
                       id_institution = o_id_institution,
                       email          = i_email,
                       flg_available  = i_flg_available
                 WHERE id_inst_attributes = nvl(i_id_inst_att, l_id_inst_attributes);
            END IF;
        
            g_error := 'GET LANGUAGES';
            OPEN c_language;
            LOOP
                FETCH c_language
                    INTO l_id_lang;
                EXIT WHEN c_language%NOTFOUND;
            
                g_error := 'INSERT_INTO_TRANSLATION INSTITUTION';
                pk_translation.insert_into_translation(l_id_lang, l_code_trl || o_id_institution, i_desc);
            
            END LOOP;
        
            CLOSE c_language;
        
        END IF;
        IF i_commit_at_end
        THEN
            COMMIT;
        END IF;
        RETURN TRUE;
    
    EXCEPTION
        WHEN my_exception THEN
        
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_EXT_INSTITUTION',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_EXT_INSTITUTION',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
        
    END set_ext_institution;

    /********************************************************************************************
    * Set Institution Professional state
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_professional       Professional ID
    * @param i_id_institution        Institution ID
    * @param i_flg_state             Professional state
    * @param i_num_mecan             Mecan. Number
    * @param o_flg_state             Professional state
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      JTS
    * @version                     0.1
    * @since                       2009/12/14
    ********************************************************************************************/
    FUNCTION set_prof_institution
    (
        i_lang            IN language.id_language%TYPE,
        i_id_professional IN prof_institution.id_professional%TYPE,
        i_id_institution  IN prof_institution.id_institution%TYPE,
        i_flg_state       IN prof_institution.flg_state%TYPE,
        i_num_mecan       IN prof_institution.num_mecan%TYPE,
        o_flg_state       OUT prof_institution.flg_state%TYPE,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
        CURSOR c_inst IS
            SELECT p_inst.id_prof_institution
              FROM (SELECT x.*
                      FROM prof_institution x
                     WHERE x.id_institution = i_id_institution
                       AND x.id_professional = i_id_professional
                     ORDER BY x.dt_end_tstz DESC) p_inst
             WHERE rownum = 1;
        l_inst                prof_institution.id_prof_institution%TYPE := NULL;
        l_id_prof_institution NUMBER;
    
    BEGIN
    
        OPEN c_inst;
        FETCH c_inst
            INTO l_inst;
        g_found := c_inst%NOTFOUND;
        CLOSE c_inst;
        g_error := 'INSERT INTO PROF_INSTITUTION';
        pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_inst,
                                                       i_id_professional     => i_id_professional,
                                                       i_id_institution      => i_id_institution,
                                                       i_flg_state           => i_flg_state,
                                                       i_num_mecan           => i_num_mecan,
                                                       i_dt_begin_tstz       => g_sysdate_tstz,
                                                       i_flg_external        => 'N',
                                                       o_id_prof_institution => l_id_prof_institution);
        o_flg_state := i_flg_state;
        g_error     := 'REMOVE PROFESSIONAL MEC NUMBER';
        IF i_num_mecan IS NULL
        THEN
            pk_api_ab_tables.remove_prof_inst_num_mec(i_id_prof_inst => l_id_prof_institution);
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_PROF_INSTITUTION',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
        
    END set_prof_institution;

    /********************************************************************************************
    * Set Institution Professional Category
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_prof               Professional ID
    * @param i_id_institution        Institution ID
    * @param i_id_category           Professional Category
    * @param i_id_cat_surgery        Professional Category In Surgery
    * @param i_commit_at_end         Commit changes in this function - Y - Yes, N - No 
    * @param o_id_prof               Professional state
    * @param o_error                 Error
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      JTS
    * @version                     0.1
    * @since                       2009/12/14
    ********************************************************************************************/
    FUNCTION set_prof_cat
    (
        i_lang           IN language.id_language%TYPE,
        i_id_prof        IN professional.id_professional%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        i_id_category    IN category.id_category%TYPE,
        i_id_cat_surgery IN category.id_category%TYPE,
        i_commit_at_end  IN BOOLEAN,
        o_id_prof        OUT professional.id_professional%TYPE,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_id_prof_cat prof_cat.id_prof_cat%TYPE;
        l_prof_cat    NUMBER;
    
        my_exception EXCEPTION;
        l_error VARCHAR(4000);
    
    BEGIN
    
        IF i_id_category IS NULL
        THEN
            l_error := pk_message.get_message(i_lang, 'PROFESSIONAL_M007');
            RAISE my_exception;
        ELSE
        
            SELECT COUNT(pc.id_prof_cat)
              INTO l_prof_cat
              FROM prof_cat pc
             WHERE pc.id_professional = i_id_prof
               AND pc.id_institution = i_id_institution;
        
            IF l_prof_cat = 0
            THEN
            
                g_error := 'GET SEQ_PROF_CATEGORY.NEXTVAL';
            
                SELECT seq_prof_cat.nextval
                  INTO l_id_prof_cat
                  FROM dual;
            
                g_error := 'INSERT INTO PROF_CAT';
                INSERT INTO prof_cat
                    (id_prof_cat, id_professional, id_category, id_institution, id_category_sub)
                VALUES
                    (l_id_prof_cat, i_id_prof, i_id_category, i_id_institution, i_id_cat_surgery);
            
            ELSE
            
                g_error := 'UPDATE PROF_CAT';
                UPDATE prof_cat
                   SET id_category = i_id_category, id_category_sub = i_id_cat_surgery
                 WHERE id_professional = i_id_prof
                   AND id_institution = i_id_institution;
            END IF;
        
            o_id_prof := i_id_prof;
        
        END IF;
    
        IF i_commit_at_end
        THEN
            COMMIT;
        END IF;
        RETURN TRUE;
    
    EXCEPTION
        WHEN my_exception THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              l_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_PROF_CAT',
                                              'U',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_PROF_CAT',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
        
    END set_prof_cat;

    /********************************************************************************************
    * Find an institution based on accounts values
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_professional       Professional ID
    * @param o_username              Username
    * @param o_error                 error    
    *
    *
    * @return                      Professional Username
    *
    * @author                      Tércio Soares
    * @version                     0.1
    * @since                       2010/01/06
    ********************************************************************************************/
    FUNCTION get_prof_username
    (
        i_lang            IN language.id_language%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        o_username        OUT ab_user_info.login%TYPE,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        g_error := 'SELECT USERNAME BY PROFESSIONAL ID: ' || to_char(i_id_professional);
        pk_alertlog.log_debug('PK_BACKOFFICE.GET_PROF_USERNAME: ' || g_error);
        SELECT nvl((SELECT fsu.login
                     FROM professional p, ab_user_info fsu
                    WHERE p.id_professional = i_id_professional
                      AND p.id_professional = fsu.id_ab_user_info(+)),
                   NULL)
          INTO o_username
          FROM dual;
    
        RETURN TRUE;
    
    EXCEPTION
    
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_USER_NAME',
                                              o_error);
            RETURN FALSE;
        
    END get_prof_username;

    /********************************************************************************************
    * Get Department Floors
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_department         Service ID
    * @param i_id_institution        Institution ID
    * @param o_floors_desc           Associated floors description 
    * @param o_floors_list           Floors list
    * @param o_error                 Error
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      JTS
    * @version                     0.1
    * @since                       2010/03/01
    ********************************************************************************************/
    FUNCTION get_floors_department
    (
        i_lang           IN language.id_language%TYPE,
        i_id_department  IN department.id_department%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        o_floors_desc    OUT VARCHAR2,
        o_floors_list    OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        IF i_id_department IS NOT NULL
        THEN
        
            IF length(pk_utils.query_to_string(('SELECT pk_translation.get_translation(' || i_lang ||
                                               ', f.code_floors) || ''('' ||
                       pk_translation.get_translation(' || i_lang ||
                                               ', b.code_building) || '')
                                                ''
                  FROM floors_institution fi
                 INNER JOIN floors f
                    ON (f.id_floors = fi.id_floors)
                 INNER JOIN floors_department fd
                    ON (fd.id_floors_institution = fi.id_floors_institution)
                 INNER JOIN building b
                    ON (b.id_building = fi.id_building)
                 WHERE fi.id_institution = ' || i_id_institution || '
                   AND fi.flg_available = ''' || g_flg_available || '''
                   AND fd.id_department = ' || i_id_department || '
                   AND f.flg_available = ''' || g_flg_available || '''
                   AND fd.flg_available = ''' || g_flg_available || '''
                   AND b.flg_available = ''' || g_flg_available || ''''),
                                               ', ')) > 1000
            THEN
                SELECT substr(pk_utils.query_to_string(('
                        SELECT pk_translation.get_translation(' ||
                                                       i_lang ||
                                                       ', f.code_floors) || ''('' ||
                       pk_translation.get_translation(' ||
                                                       i_lang || ', b.code_building) || '')
                                                        ''
                  FROM floors_institution fi
                 INNER JOIN floors f
                    ON (f.id_floors = fi.id_floors)
                 INNER JOIN floors_department fd
                    ON (fd.id_floors_institution = fi.id_floors_institution)
                 INNER JOIN building b
                    ON (b.id_building = fi.id_building)
                 WHERE fi.id_institution = ' || i_id_institution || '
                   AND fi.flg_available = ''' || g_flg_available || '''
                   AND fd.id_department = ' || i_id_department || '
                   AND f.flg_available = ''' || g_flg_available || '''
                   AND fd.flg_available = ''' || g_flg_available || '''
                   AND b.flg_available = ''' || g_flg_available || ''''),
                                                       ', '),
                              1,
                              1000) || '...'
                  INTO o_floors_desc
                  FROM dual;
            
            ELSE
                SELECT pk_utils.query_to_string(('SELECT pk_translation.get_translation(' || i_lang ||
                                                ', f.code_floors) || ''('' ||
                       pk_translation.get_translation(' || i_lang ||
                                                ', b.code_building) || '')''
                  FROM floors_institution fi
                 INNER JOIN floors f
                    ON (f.id_floors = fi.id_floors)
                 INNER JOIN floors_department fd
                    ON (fd.id_floors_institution = fi.id_floors_institution)
                 INNER JOIN building b
                    ON (b.id_building = fi.id_building)
                 WHERE fi.id_institution = ' || i_id_institution || '
                   AND fi.flg_available = ''' || g_flg_available || '''
                   AND fd.id_department = ' || i_id_department || '
                   AND f.flg_available = ''' || g_flg_available || '''
                   AND fd.flg_available = ''' || g_flg_available || '''
                   AND b.flg_available = ''' || g_flg_available || ''''),
                                                ', ')
                  INTO o_floors_desc
                  FROM dual;
            
            END IF;
        
            g_error := 'GET FLOORS CURSOR';
            OPEN o_floors_list FOR
            
                SELECT fi.id_floors_institution id,
                       pk_translation.get_translation(i_lang, f.code_floors) || ' (' ||
                       pk_translation.get_translation(i_lang, b.code_building) || ')' name,
                       'Y' flg_select
                  FROM floors_institution fi
                 INNER JOIN floors f
                    ON (f.id_floors = fi.id_floors)
                 INNER JOIN floors_department fd
                    ON (fd.id_floors_institution = fi.id_floors_institution)
                 INNER JOIN building b
                    ON (b.id_building = fi.id_building)
                 WHERE fi.id_institution = i_id_institution
                   AND fi.flg_available = g_flg_available
                   AND fd.id_department = i_id_department
                   AND f.flg_available = g_flg_available
                   AND fd.flg_available = g_flg_available
                   AND b.flg_available = g_flg_available
                UNION
                SELECT fi.id_floors_institution id,
                       pk_translation.get_translation(i_lang, f.code_floors) || ' (' ||
                       pk_translation.get_translation(i_lang, b.code_building) || ')' name,
                       'N' flg_select
                  FROM floors_institution fi
                 INNER JOIN floors f
                    ON (f.id_floors = fi.id_floors)
                 INNER JOIN building b
                    ON (b.id_building = fi.id_building)
                 WHERE fi.id_institution = i_id_institution
                   AND fi.flg_available = g_flg_available
                   AND f.flg_available = g_flg_available
                   AND b.flg_available = g_flg_available
                   AND NOT EXISTS (SELECT 0
                          FROM floors_institution fi2
                         INNER JOIN floors f2
                            ON (f2.id_floors = fi2.id_floors)
                         INNER JOIN floors_department fd2
                            ON (fd2.id_floors_institution = fi2.id_floors_institution)
                         INNER JOIN building b2
                            ON (b2.id_building = fi2.id_building)
                         WHERE fi2.id_institution = i_id_institution
                           AND fi2.flg_available = g_flg_available
                           AND fd2.id_department = i_id_department
                           AND f2.flg_available = g_flg_available
                           AND fd2.flg_available = g_flg_available
                           AND b2.flg_available = g_flg_available
                           AND f2.id_floors = f.id_floors)
                 ORDER BY name;
        
        ELSE
            g_error := 'GET FLOORS CURSOR';
            OPEN o_floors_list FOR
                SELECT fi.id_floors_institution id,
                       pk_translation.get_translation(i_lang, f.code_floors) || ' (' ||
                       pk_translation.get_translation(i_lang, b.code_building) || ')' name,
                       'N' flg_select
                  FROM floors_institution fi
                 INNER JOIN floors f
                    ON (f.id_floors = fi.id_floors)
                 INNER JOIN building b
                    ON (b.id_building = fi.id_building)
                 WHERE fi.id_institution = i_id_institution
                   AND fi.flg_available = g_flg_available
                   AND f.flg_available = g_flg_available
                   AND b.flg_available = g_flg_available
                 ORDER BY name;
        
            o_floors_desc := NULL;
        
        END IF;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_FLOORS_DEPARTMENT',
                                              o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
        
    END get_floors_department;

    /********************************************************************************************
    * Get Room Floors List
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_department         Service ID
    * @param i_id_institution        Institution ID
    * @param i_id_room               Room ID
    * @param o_floors_desc           Associated floor description 
    * @param o_floors_list           Floors list
    * @param o_error                 Error
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      JTS
    * @version                     0.1
    * @since                       2010/03/01
    ********************************************************************************************/
    FUNCTION get_room_floors_list
    (
        i_lang           IN language.id_language%TYPE,
        i_id_department  IN department.id_department%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        i_id_room        IN room.id_room%TYPE,
        o_floors_desc    OUT VARCHAR2,
        o_floors_list    OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_id_floor             floors.id_floors%TYPE;
        l_id_floors_department floors_department.id_floors_department%TYPE;
    
    BEGIN
    
        IF i_id_department IS NOT NULL
        THEN
        
            SELECT nvl((SELECT f.id_floors
                         FROM room r, floors_department fd, floors_institution fi, floors f
                        WHERE r.id_room = i_id_room
                          AND r.id_floors_department = fd.id_floors_department
                          AND fd.id_floors_institution = fi.id_floors_institution
                          AND fi.id_floors = f.id_floors
                          AND f.flg_available = g_flg_available
                          AND fi.flg_available = g_flg_available
                          AND fd.flg_available = g_flg_available
                          AND r.flg_available = g_flg_available),
                       0),
                   nvl((SELECT fd.id_floors_department
                         FROM room r, floors_department fd, floors_institution fi, floors f
                        WHERE r.id_room = i_id_room
                          AND r.id_floors_department = fd.id_floors_department
                          AND fd.id_floors_institution = fi.id_floors_institution
                          AND fi.id_floors = f.id_floors
                          AND f.flg_available = g_flg_available
                          AND fi.flg_available = g_flg_available
                          AND fd.flg_available = g_flg_available
                          AND r.flg_available = g_flg_available),
                       0)
              INTO l_id_floor, l_id_floors_department
              FROM dual;
        
            IF l_id_floor = 0
            THEN
                o_floors_desc := NULL;
            
                g_error := 'GET FLOORS CURSOR';
                OPEN o_floors_list FOR
                    SELECT fd.id_floors_department id,
                           pk_translation.get_translation(i_lang, f.code_floors) name,
                           'N' flg_select
                      FROM floors_department fd, floors_institution fi, floors f
                     WHERE fi.id_institution = i_id_institution
                       AND fd.id_floors_institution = fi.id_floors_institution
                       AND fd.id_department = i_id_department
                       AND fi.id_floors = f.id_floors
                       AND f.flg_available = g_flg_available
                       AND fi.flg_available = g_flg_available
                       AND fd.flg_available = g_flg_available
                     ORDER BY name;
            
            ELSE
            
                SELECT pk_translation.get_translation(i_lang, f.code_floors)
                  INTO o_floors_desc
                  FROM floors f
                 WHERE f.id_floors = l_id_floor;
            
                g_error := 'GET FLOORS CURSOR';
                OPEN o_floors_list FOR
                    SELECT l_id_floors_department id, o_floors_desc name, 'Y' flg_select
                      FROM dual
                    UNION
                    SELECT fd.id_floors_department id,
                           pk_translation.get_translation(i_lang, f.code_floors) name,
                           'N' flg_select
                      FROM floors_department fd, floors_institution fi, floors f
                     WHERE fi.id_institution = i_id_institution
                       AND fd.id_floors_institution = fi.id_floors_institution
                       AND fd.id_department = i_id_department
                       AND fi.id_floors = f.id_floors
                       AND f.flg_available = g_flg_available
                       AND fi.flg_available = g_flg_available
                       AND fd.flg_available = g_flg_available
                       AND f.id_floors != l_id_floor
                     ORDER BY name;
            
            END IF;
        
        ELSE
            g_error := 'GET FLOORS CURSOR';
            OPEN o_floors_list FOR
                SELECT fd.id_floors_department id,
                       pk_translation.get_translation(i_lang, f.code_floors) name,
                       'N' flg_select
                  FROM floors_department fd, floors_institution fi, floors f
                 WHERE fi.id_institution = i_id_institution
                   AND fd.id_floors_institution = fi.id_floors_institution
                   AND fd.id_department = i_id_department
                   AND fi.id_floors = f.id_floors
                   AND f.flg_available = g_flg_available
                   AND fi.flg_available = g_flg_available
                   AND fd.flg_available = g_flg_available
                 ORDER BY name;
        
            o_floors_desc := NULL;
        
        END IF;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_ROOM_FLOORS_LIST',
                                              o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
        
    END get_room_floors_list;

    /********************************************************************************************
    * Set Institution Professional Preferences
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_professional       Professional ID
    * @param i_id_institution        Institution ID
    * @param i_id_language           Language ID
    * @param i_commit_at_end         Commit changes in this function - Y - Yes, N - No 
    * @param o_id_professional       Professional ID
    * @param o_error                 Error
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      JTS
    * @version                     2.6.0.3.4
    * @since                       2010/10/15
    ********************************************************************************************/
    FUNCTION set_prof_preferences
    (
        i_lang            IN language.id_language%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        i_id_institution  IN institution.id_institution%TYPE,
        i_id_language     IN prof_preferences.id_language%TYPE,
        i_commit_at_end   IN BOOLEAN,
        o_id_professional OUT professional.id_professional%TYPE,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_func_name CONSTANT VARCHAR2(100) := 'SET_PROF_PREFERENCES';
    
        l_sof_null        NUMBER;
        l_soft_inst_pk    ab_soft_inst_user_info.id_ab_software_institution%TYPE := NULL;
        l_role_sw_inst_pk ab_soft_inst_user_info.id_ab_software_inst_role%TYPE := NULL;
        l_role_id         ab_soft_inst_user_info.id_ab_role%TYPE := NULL;
        l_comp_id         VARCHAR2(200) := '';
        l_si_user_info    NUMBER := 0;
    
    BEGIN
    
        g_error := 'CHECK PROFESSIONAL PREFERENCES IN THE INSTITUTION (ID: ' || i_id_institution ||
                   ' ) PROFESSIONAL (ID: ' || i_id_professional || ' )';
        pk_alertlog.log_debug('PK_BACKOFFICE.SET_PROF_PREFERENCES ' || g_error);
        SELECT COUNT(pp.id_prof_preferences)
          INTO l_sof_null
          FROM prof_preferences pp
         WHERE pp.id_professional = i_id_professional
           AND pp.id_institution = i_id_institution
           AND pp.id_software = 0;
    
        IF l_sof_null = 0
        THEN
            SELECT nvl((SELECT si.id_software_institution
                         FROM software_institution si
                        WHERE si.id_software = 0
                          AND si.id_institution = i_id_institution),
                       0)
              INTO l_soft_inst_pk
              FROM dual;
            g_error := 'GET DEFAULT COMPONENT ID';
            pk_api_ab_tables.get_component_from_si(profissional(0, i_id_institution, 0), l_comp_id);
            pk_api_ab_tables.upd_ins_into_ab_sw_ins_usr_inf(i_prof                       => profissional(i_id_professional,
                                                                                                         i_id_institution,
                                                                                                         0),
                                                            i_id_ab_soft_inst_user_info  => NULL,
                                                            i_import_code                => NULL,
                                                            i_record_status              => g_prof_flg_state_active,
                                                            i_id_ab_software_institution => l_soft_inst_pk,
                                                            i_id_ab_software_inst_role   => l_role_sw_inst_pk,
                                                            i_id_ab_institution          => i_id_institution,
                                                            i_id_ab_software             => 0,
                                                            i_id_ab_user_info            => i_id_professional,
                                                            i_id_ab_role                 => l_role_id,
                                                            i_id_ab_component            => to_number(l_comp_id),
                                                            i_id_ab_language             => i_id_language,
                                                            i_flg_log                    => NULL,
                                                            i_id_department              => NULL,
                                                            i_dt_log_tstz                => NULL,
                                                            i_timeout                    => NULL,
                                                            i_first_screen               => NULL,
                                                            o_id_ab_soft_inst_user_info  => l_si_user_info);
            pk_api_ab_tables.upd_ins_into_ab_user_info(i_id_ab_user_info    => i_id_professional,
                                                       i_login              => NULL,
                                                       i_password           => NULL,
                                                       i_import_code        => NULL,
                                                       i_record_status      => g_prof_flg_state_active,
                                                       i_institution_key    => i_id_institution,
                                                       i_flg_is_enable      => g_prof_flg_state_active,
                                                       i_first_name         => NULL,
                                                       i_last_name          => NULL,
                                                       i_full_name          => NULL,
                                                       i_external_system    => NULL,
                                                       i_external_system_id => NULL,
                                                       i_secret_quest       => NULL,
                                                       i_secret_answ        => NULL,
                                                       i_id_language        => i_id_language,
                                                       i_flg_temporary      => 'N',
                                                       i_date_creation_tstz => NULL,
                                                       o_id_ab_user_info    => o_id_professional);
        
        ELSE
            FOR pref IN (SELECT pp.id_prof_preferences, pp.id_software
                           FROM prof_preferences pp
                          WHERE pp.id_professional = i_id_professional
                            AND pp.id_institution = i_id_institution)
            LOOP
                SELECT nvl((SELECT si.id_software_institution
                             FROM software_institution si
                            WHERE si.id_software = pref.id_software
                              AND si.id_institution = i_id_institution),
                           0)
                  INTO l_soft_inst_pk
                  FROM dual;
            
                g_error := 'GET DEFAULT COMPONENT ID';
                pk_api_ab_tables.get_component_from_si(profissional(0, i_id_institution, pref.id_software), l_comp_id);
                pk_api_ab_tables.upd_ins_into_ab_sw_ins_usr_inf(i_prof                       => profissional(i_id_professional,
                                                                                                             i_id_institution,
                                                                                                             pref.id_software),
                                                                i_id_ab_soft_inst_user_info  => pref.id_prof_preferences,
                                                                i_import_code                => NULL,
                                                                i_record_status              => 'A',
                                                                i_id_ab_software_institution => l_soft_inst_pk,
                                                                i_id_ab_software_inst_role   => l_role_sw_inst_pk,
                                                                i_id_ab_institution          => i_id_institution,
                                                                i_id_ab_software             => pref.id_software,
                                                                i_id_ab_user_info            => i_id_professional,
                                                                i_id_ab_role                 => l_role_id,
                                                                i_id_ab_component            => to_number(l_comp_id),
                                                                i_id_ab_language             => i_id_language,
                                                                i_flg_log                    => NULL,
                                                                i_id_department              => NULL,
                                                                i_dt_log_tstz                => NULL,
                                                                i_timeout                    => NULL,
                                                                i_first_screen               => NULL,
                                                                o_id_ab_soft_inst_user_info  => l_si_user_info);
            END LOOP;
            pk_api_ab_tables.upd_ins_into_ab_user_info(i_id_ab_user_info    => i_id_professional,
                                                       i_login              => NULL,
                                                       i_password           => NULL,
                                                       i_import_code        => NULL,
                                                       i_record_status      => g_prof_flg_state_active,
                                                       i_institution_key    => i_id_institution,
                                                       i_flg_is_enable      => g_prof_flg_state_active,
                                                       i_first_name         => NULL,
                                                       i_last_name          => NULL,
                                                       i_full_name          => NULL,
                                                       i_external_system    => NULL,
                                                       i_external_system_id => NULL,
                                                       i_secret_quest       => NULL,
                                                       i_secret_answ        => NULL,
                                                       i_id_language        => i_id_language,
                                                       i_flg_temporary      => 'N',
                                                       i_date_creation_tstz => NULL,
                                                       o_id_ab_user_info    => o_id_professional);
        
        END IF;
    
        IF i_commit_at_end
        THEN
            COMMIT;
        END IF;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              g_package_owner,
                                              g_package_name,
                                              l_func_name,
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
        
    END set_prof_preferences;

    /********************************************************************************************
    * Set Professional institution relations (internal or external)
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_professional       Professional ID
    * @param i_institutions          Institution ID's
    * @param i_flg_state             Professional status in institutions
    * @param i_num_mecan             Mecan. Number's
    * @param i_dt_begin_tstz         Begin dates
    * @param i_dt_end_tstz           End dates
    * @param i_flg_external          External relation? Y - External, N- internal
    * @param i_commit_at_end         Commit changes in this function - Y - Yes, N - No
    * @param o_prof_institutions     Professional/institution relation id's
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      JTS
    * @version                     2.6.0.3.4
    * @since                       2010/11/22
    ********************************************************************************************/
    FUNCTION set_prof_institutions
    (
        i_lang              IN language.id_language%TYPE,
        i_id_professional   IN prof_institution.id_professional%TYPE,
        i_institutions      IN table_number,
        i_flg_state         IN table_varchar,
        i_num_mecan         IN table_varchar,
        i_dt_begin_tstz     IN table_timestamp,
        i_dt_end_tstz       IN table_timestamp,
        i_flg_external      IN prof_institution.flg_external%TYPE,
        i_commit_at_end     IN BOOLEAN,
        o_prof_institutions OUT table_number,
        o_error             OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_func_name CONSTANT VARCHAR2(100) := 'SET_PROF_INSTITUTIONS';
    
        l_prof_institution prof_institution.id_prof_institution%TYPE;
        l_flg_state        VARCHAR2(1 CHAR);
        l_icon             VARCHAR2(200 CHAR);
        l_index            NUMBER := 1;
        l_exception EXCEPTION;
        l_error_out t_error_out;
    
    BEGIN
    
        IF i_flg_external = pk_alert_constant.get_yes
        THEN
        
            FOR i IN 1 .. i_institutions.count
            LOOP
                g_error := 'COUNT NUMBER OF ASSOCIATIONS BETWEEN EXTERNAL PROFESIONAL AND INSTITUTION: id_professional = ' ||
                           i_id_professional || ', ID_INSTITUTION = ' || i_institutions(i);
                pk_alertlog.log_debug('PK_API_BACKOFFICE.INTF_SET_PROF_INSTITUTIONS: ' || g_error);
                SELECT nvl((SELECT pi.id_prof_institution
                             FROM prof_institution pi
                            WHERE pi.id_professional = i_id_professional
                              AND pi.id_institution = i_institutions(i)
                              AND pi.flg_external = i_flg_external),
                           0)
                  INTO l_prof_institution
                  FROM dual;
            
                IF l_prof_institution = 0
                THEN
                
                    g_error := 'ASSOCIATE AN EXTERNAL PROFESIONAL TO INSTITUTIONS: id_professional = ' ||
                               i_id_professional;
                    pk_alertlog.log_debug('PK_API_BACKOFFICE.INTF_SET_PROF_INSTITUTIONS: ' || g_error);
                    IF NOT pk_backoffice.set_prof_institution(i_lang             => i_lang,
                                                              i_id_professional  => i_id_professional,
                                                              i_id_institution   => i_institutions(i),
                                                              i_flg_state        => i_flg_state(i),
                                                              i_num_mecan        => i_num_mecan(i),
                                                              i_dt_begin_tstz    => i_dt_begin_tstz(i),
                                                              i_dt_end_tstz      => i_dt_end_tstz(i),
                                                              i_flg_external     => i_flg_external,
                                                              o_prof_institution => l_prof_institution,
                                                              o_error            => l_error_out)
                    THEN
                        RAISE l_exception;
                    
                    END IF;
                
                END IF;
            
                g_error := 'ASSOCIATION ID BETWEEN EXTERNAL PROFESIONAL AND INSTITUTION';
                pk_alertlog.log_debug('PK_API_BACKOFFICE.INTF_SET_PROF_INSTITUTION: ' || g_error);
                o_prof_institutions.extend;
                o_prof_institutions(l_index) := l_prof_institution;
                l_index := l_index + 1;
            
            END LOOP;
        ELSE
        
            FOR i IN 1 .. i_institutions.count
            LOOP
            
                g_error := 'COUNT NUMBER OF ASSOCIATIONS BETWEEN PROFESIONAL AND INSTITUTION: id_professional = ' ||
                           i_id_professional || ', ID_INSTITUTION = ' || i_institutions(i);
                pk_alertlog.log_debug('PK_API_BACKOFFICE.INTF_SET_PROF_INSTITUTIONS: ' || g_error);
                SELECT COUNT(pi.id_prof_institution)
                  INTO l_prof_institution
                  FROM prof_institution pi
                 WHERE pi.id_professional = i_id_professional
                   AND pi.id_institution = i_institutions(i)
                   AND pi.flg_external = i_flg_external;
            
                IF l_prof_institution = 0
                THEN
                
                    g_error := 'ASSOCIATE A PROFESIONAL TO INSTITUTION : id_professional = ' || i_id_professional;
                    pk_alertlog.log_debug('PK_API_BACKOFFICE.INTF_SET_PROF_INSTITUTION: ' || g_error);
                    IF NOT pk_backoffice.set_prof_institution(i_lang             => i_lang,
                                                              i_id_professional  => i_id_professional,
                                                              i_id_institution   => i_institutions(i),
                                                              i_flg_state        => i_flg_state(i),
                                                              i_num_mecan        => i_num_mecan(i),
                                                              i_dt_begin_tstz    => i_dt_begin_tstz(i),
                                                              i_dt_end_tstz      => i_dt_end_tstz(i),
                                                              i_flg_external     => i_flg_external,
                                                              o_prof_institution => l_prof_institution,
                                                              o_error            => l_error_out)
                    THEN
                        RAISE l_exception;
                    
                    END IF;
                
                ELSE
                
                    g_error := 'UPDATE PROFESIONAL INFORTMATION IN INSTITUTION : id_professional = ' ||
                               i_id_professional;
                    pk_alertlog.log_debug('PK_API_BACKOFFICE.INTF_SET_PROF_INSTITUTION: ' || g_error);
                    IF NOT pk_backoffice.set_prof_institution_state(i_lang            => i_lang,
                                                                    i_id_professional => i_id_professional,
                                                                    i_id_institution  => i_institutions(i),
                                                                    i_flg_state       => i_flg_state(i),
                                                                    i_num_mecan       => i_num_mecan(i),
                                                                    o_flg_state       => l_flg_state,
                                                                    o_icon            => l_icon,
                                                                    o_error           => l_error_out)
                    THEN
                        RAISE l_exception;
                    ELSE
                    
                        g_error := 'GET RELATION ID BETWEEN PROFESIONAL AND INSTITUTION : id_professional = ' ||
                                   i_id_professional;
                        pk_alertlog.log_debug('PK_API_BACKOFFICE.INTF_SET_PROF_INSTITUTION: ' || g_error);
                        SELECT pi.id_prof_institution
                          INTO l_prof_institution
                          FROM prof_institution pi
                         WHERE pi.id_professional = i_id_professional
                           AND pi.id_institution = i_institutions(i)
                           AND pi.flg_state = l_flg_state
                           AND pi.flg_external = i_flg_external
                           AND pi.dt_end_tstz IS NULL;
                    
                        IF i_dt_begin_tstz(i) IS NOT NULL
                        THEN
                        
                            g_error := 'UPDATE BEGIN DATE IN THE ASSOCIATION BETWEEN PROFESIONAL AND INSTITUTION : id_professional = ' ||
                                       i_id_professional;
                            pk_alertlog.log_debug('PK_API_BACKOFFICE.INTF_SET_PROF_INSTITUTION: ' || g_error);
                            pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_prof_institution,
                                                                           i_id_professional     => i_id_professional,
                                                                           i_id_institution      => i_institutions(i),
                                                                           i_flg_state           => i_flg_state(i),
                                                                           i_num_mecan           => i_num_mecan(i),
                                                                           i_dt_begin_tstz       => i_dt_begin_tstz(i),
                                                                           o_id_prof_institution => l_prof_institution);
                            g_error := 'REMOVE PROFESSIONAL MEC NUMBER';
                            IF i_num_mecan(i) IS NULL
                            THEN
                                pk_api_ab_tables.remove_prof_inst_num_mec(i_id_prof_inst => l_prof_institution);
                            END IF;
                        END IF;
                    
                    END IF;
                END IF;
            
                g_error := 'ASSOCIATION ID BETWEEN PROFESIONAL AND INSTITUTION';
                pk_alertlog.log_debug('PK_API_BACKOFFICE.INTF_SET_PROF_INSTITUTION: ' || g_error);
                o_prof_institutions.extend;
                o_prof_institutions(l_index) := l_prof_institution;
                l_index := l_index + 1;
            END LOOP;
        
        END IF;
    
        IF i_commit_at_end
        THEN
            COMMIT;
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN l_exception THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error || ' / ' || l_error_out.err_desc,
                                              g_package_owner,
                                              g_package_name,
                                              l_func_name,
                                              o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
        
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              g_package_owner,
                                              g_package_name,
                                              l_func_name,
                                              o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
        
    END set_prof_institutions;

    /********************************************************************************************
    * Set Institution Professional state
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_professional       Professional ID
    * @param i_id_institution        Institution ID
    * @param i_flg_state             Professional state
    * @param i_num_mecan             Mecan. Number
    * @param i_dt_begin_tstz         Begin date
    * @param i_dt_end_tstz           End date
    * @param i_flg_external          External professional? Y - Yes, N - No
    * @param o_prof_institution      Professional/institution relation ID
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      JTS
    * @version                     2.6.0.3.4
    * @since                       2010/11/22
    ********************************************************************************************/
    FUNCTION set_prof_institution
    (
        i_lang             IN language.id_language%TYPE,
        i_id_professional  IN prof_institution.id_professional%TYPE,
        i_id_institution   IN prof_institution.id_institution%TYPE,
        i_flg_state        IN prof_institution.flg_state%TYPE,
        i_num_mecan        IN prof_institution.num_mecan%TYPE,
        i_dt_begin_tstz    IN prof_institution.dt_begin_tstz%TYPE,
        i_dt_end_tstz      IN prof_institution.dt_end_tstz%TYPE,
        i_flg_external     IN prof_institution.flg_external%TYPE,
        o_prof_institution OUT prof_institution.id_prof_institution%TYPE,
        o_error            OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_func_name CONSTANT VARCHAR2(100) := 'SET_PROF_INSTITUTION';
        CURSOR c_inst IS
            SELECT p_inst.id_prof_institution
              FROM (SELECT x.*
                      FROM prof_institution x
                     WHERE x.id_institution = i_id_institution
                       AND x.id_professional = i_id_professional
                     ORDER BY x.dt_end_tstz DESC) p_inst
             WHERE rownum = 1;
        l_inst                prof_institution.id_prof_institution%TYPE := NULL;
        l_id_prof_institution prof_institution.id_prof_institution%TYPE;
        l_prof_schedulable    NUMBER := 0;
        l_flg_schedulable     prof_institution.flg_schedulable%TYPE := pk_alert_constant.get_no;
    
    BEGIN
    
        IF i_flg_external = pk_alert_constant.get_no
        THEN
        
            SELECT COUNT(pt.id_profile_template)
              INTO l_prof_schedulable
              FROM profile_template pt, software s
             WHERE pt.id_profile_template IN (SELECT ppt.id_profile_template
                                                FROM prof_profile_template ppt
                                               WHERE ppt.id_professional = i_id_professional
                                                 AND ppt.id_institution = i_id_institution)
               AND pt.flg_available = g_flg_available
               AND pt.id_software = s.id_software
               AND s.flg_viewer = pk_alert_constant.get_no
               AND pt.flg_schedulable = pk_alert_constant.get_yes;
        
            IF l_prof_schedulable > 0
            THEN
            
                l_flg_schedulable := pk_alert_constant.get_yes;
            END IF;
        
        END IF;
    
        OPEN c_inst;
        FETCH c_inst
            INTO l_inst;
        g_found := c_inst%NOTFOUND;
        CLOSE c_inst;
        g_error := 'ASSOCIATE AN EXTERNAL PROFESIONAL TO INSTITUTIONS: id_professional = ' || i_id_professional ||
                   ', ID_INSTITUTION = ' || i_id_institution;
        pk_alertlog.log_debug('PK_API_BACKOFFICE.SET_PROF_INSTITUTION: ' || g_error);
        -- INSTITUTION    
        pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_inst,
                                                       i_id_professional     => i_id_professional,
                                                       i_id_institution      => i_id_institution,
                                                       i_flg_state           => i_flg_state,
                                                       i_num_mecan           => i_num_mecan,
                                                       i_dt_begin_tstz       => i_dt_begin_tstz,
                                                       i_dt_end_tstz         => i_dt_end_tstz,
                                                       i_flg_external        => i_flg_external,
                                                       i_flg_schedulable     => l_flg_schedulable,
                                                       o_id_prof_institution => o_prof_institution);
    
        g_error := 'REMOVE PROFESSIONAL MEC NUMBER';
        IF i_num_mecan IS NULL
        THEN
            pk_api_ab_tables.remove_prof_inst_num_mec(i_id_prof_inst => o_prof_institution);
        END IF;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              g_package_owner,
                                              g_package_name,
                                              l_func_name,
                                              o_error);
            pk_alert_exceptions.reset_error_state;
        
    END set_prof_institution;

    /************************************************************************************************************ 
    * Returns the description for a sys_domain
    *
    * @param      i_id_institution                  Institution ID
    *
    * @return     Language Full Description
    * @author     Mauro Sousa
    * @version    0.1
    * @since      2011/02/08
    ***********************************************************************************************************/
    FUNCTION get_institution_language
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE
    ) RETURN VARCHAR2 IS
        l_languages table_varchar;
    
    BEGIN
    
        SELECT pk_translation.get_translation(i_lang, l.code_language) desc_language
          BULK COLLECT
          INTO l_languages
          FROM LANGUAGE l
          JOIN institution_language il
            ON il.id_language = l.id_language
           AND il.flg_available = g_flg_available
           AND il.id_institution = i_id_institution;
    
        --If records are returned then
        IF l_languages.count > 0
        THEN
            RETURN l_languages(1);
        ELSE
            RETURN NULL;
        END IF;
    
    EXCEPTION
        WHEN OTHERS THEN
            RETURN NULL;
    END get_institution_language;
    /************************************************************************************************************ 
    * Returns the description for a sys_domain
    *
    * @param      i_id_professional            Professional ID
    * @param      i_id_institution             Institution ID
    *
    * @return     Language Full Description
    * @author     Mauro Sousa
    * @version    0.1
    * @since      2011/02/09
    ***********************************************************************************************************/
    FUNCTION get_prof_language
    (
        i_lang            IN language.id_language%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        i_id_institution  IN institution.id_institution%TYPE
    ) RETURN VARCHAR2 IS
        l_languages table_varchar;
    
    BEGIN
    
        SELECT pk_translation.get_translation(i_lang, t.code_language) desc_language
          BULK COLLECT
          INTO l_languages
          FROM LANGUAGE t
         WHERE t.id_language = (SELECT id_language
                                  FROM prof_preferences pp
                                 WHERE pp.id_professional = i_id_professional
                                   AND pp.id_institution = i_id_institution
                                   AND pp.id_software = 0);
    
        --If records are returned then
        IF l_languages.count > 0
        THEN
            RETURN l_languages(1);
        ELSE
            RETURN NULL;
        END IF;
    
    EXCEPTION
        WHEN OTHERS THEN
            RETURN NULL;
    END get_prof_language;

    /********************************************************************************************
    * Updates series status according to current year 
    *
    * @param i_lang                  Prefered language ID
    * @param i_prof                  Professional ID
    *
    *
    * @author                        Álvaro Vasconcelos   
    * @version                       2.5.1.5
    * @since                         2011/04/07
    ********************************************************************************************/
    PROCEDURE update_series_status
    (
        i_lang IN language.id_language%TYPE,
        i_prof IN profissional
    ) IS
    BEGIN
    
        UPDATE series s
           SET s.flg_status = decode(s.starting_number,
                                     pk_pregnancy_api.get_pregnancy_next_code(i_lang,
                                                                              i_prof,
                                                                              (SELECT gs.code_state
                                                                                 FROM geo_state gs
                                                                                WHERE gs.id_geo_state = s.id_geo_state),
                                                                              substr(s.series_year, 3, 4),
                                                                              s.starting_number,
                                                                              s.ending_number),
                                     g_series_can,
                                     g_series_desc)
         WHERE s.flg_status = g_series_active
           AND s.id_institution = i_prof.institution
           AND to_number(s.series_year) -
               to_number(to_char(pk_date_utils.get_timestamp_insttimezone(i_lang, s.id_institution, current_timestamp),
                                 'YYYY')) < 0;
    
        UPDATE series s
           SET s.flg_status = g_series_active
         WHERE s.id_institution = i_prof.institution
           AND s.id_series =
               (SELECT MIN(s1.id_series)
                  FROM series s1
                 WHERE s1.flg_status = g_series_pending
                   AND s1.id_institution = i_prof.institution
                   AND s1.series_year =
                       to_char(pk_date_utils.get_timestamp_insttimezone(i_lang, s1.id_institution, current_timestamp),
                               'YYYY'))
           AND NOT EXISTS
         (SELECT 1
                  FROM series s2
                 WHERE s2.flg_status IN (g_series_active, g_series_suspended)
                   AND s2.id_institution = i_prof.institution
                   AND s2.series_year =
                       to_char(pk_date_utils.get_timestamp_insttimezone(i_lang, s2.id_institution, current_timestamp),
                               'YYYY')
                   AND s2.starting_number < s.starting_number);
    
        COMMIT;
    EXCEPTION
        WHEN OTHERS THEN
            ROLLBACK;
            RAISE;
    END;

    /********************************************************************************************
    * Get sis pre natal series
    *
    * @param i_lang                  Prefered language ID
    * @param i_prof                  Professional ID
    * @param o_list                  Series List
    * @param o_msg                   Message of % available 
    * @param o_error                 error
    *
    * @return                        true or false on success or error
    *
    * @author                        Álvaro Vasconcelos   
    * @version                       2.5.1.5
    * @since                         2011/04/07
    ********************************************************************************************/
    FUNCTION get_pre_natal_series_list
    (
        i_lang  IN language.id_language%TYPE,
        i_prof  IN profissional,
        o_list  OUT pk_types.cursor_type,
        o_msg   OUT sys_message.desc_message%TYPE,
        o_mask  OUT sys_config.value%TYPE,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
    
        g_error := 'SELECT MASK CONFIG';
        SELECT pk_sysconfig.get_config(g_series_mask, i_prof)
          INTO o_mask
          FROM dual;
    
        g_error := 'OPEN o_list';
        OPEN o_list FOR
            SELECT s.id_series id_serie,
                   pk_message.get_message(i_lang, g_series_from_msg) || ' ' ||
                   pk_pregnancy_api.get_desc_pregnancy_code(i_lang,
                                                            i_prof,
                                                            gs.code_state,
                                                            substr(s.series_year, 3, 4),
                                                            s.starting_number) || ' ' ||
                   pk_message.get_message(i_lang, g_series_to_msg) || ' ' ||
                   pk_pregnancy_api.get_desc_pregnancy_code(i_lang,
                                                            i_prof,
                                                            gs.code_state,
                                                            substr(s.series_year, 3, 4),
                                                            s.ending_number) numbers_interval,
                   decode(s.starting_number,
                          pk_pregnancy_api.get_pregnancy_next_code(i_lang,
                                                                   i_prof,
                                                                   gs.code_state,
                                                                   substr(s.series_year, 3, 4),
                                                                   s.starting_number,
                                                                   s.ending_number),
                          '---',
                          pk_message.get_message(i_lang, g_series_from_msg) || ' ' ||
                          pk_pregnancy_api.get_desc_pregnancy_code(i_lang,
                                                                   i_prof,
                                                                   gs.code_state,
                                                                   substr(s.series_year, 3, 4),
                                                                   s.starting_number) || ' ' ||
                          pk_message.get_message(i_lang, g_series_to_msg) || ' ' ||
                          pk_pregnancy_api.get_desc_pregnancy_code(i_lang,
                                                                   i_prof,
                                                                   gs.code_state,
                                                                   substr(s.series_year, 3, 4),
                                                                   (pk_pregnancy_api.get_pregnancy_next_code(i_lang,
                                                                                                             i_prof,
                                                                                                             gs.code_state,
                                                                                                             substr(s.series_year,
                                                                                                                    3,
                                                                                                                    4),
                                                                                                             s.starting_number,
                                                                                                             s.ending_number)))) attributted_numbers,
                   (s.ending_number - pk_pregnancy_api.get_pregnancy_next_code(i_lang,
                                                                               i_prof,
                                                                               gs.code_state,
                                                                               substr(s.series_year, 3, 4),
                                                                               s.starting_number,
                                                                               s.ending_number)) available_numbers,
                   s.flg_status,
                   pk_sysdomain.get_domain(g_series_domain, s.flg_status, i_lang) desc_status,
                   s.starting_number,
                   s.current_number,
                   s.ending_number,
                   s.series_year,
                   gs.code_state
              FROM series s
              JOIN geo_state gs
                ON gs.id_geo_state = s.id_geo_state
             WHERE s.id_institution = i_prof.institution
             ORDER BY s.id_series;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_pre_natal_series_list;

    /********************************************************************************************
    * Get sis pre natal active serie
    *
    * @param i_lang                  Prefered language ID
    * @param i_prof                  Professional ID
    * @param o_error                 error
    *
    * @return                        true or false on success or error
    *
    * @author                        Álvaro Vasconcelos   
    * @version                       2.5.1.5
    * @since                         2011/04/07
    ********************************************************************************************/
    FUNCTION get_pre_natal_serie
    (
        i_lang  IN language.id_language%TYPE,
        i_prof  IN profissional,
        o_error OUT t_error_out
    ) RETURN t_rec_serie IS
        l_rec_serie t_rec_serie;
    BEGIN
    
        update_series_status(i_lang, i_prof);
    
        SELECT s.id_series,
               s.starting_number,
               pk_pregnancy_api.get_pregnancy_next_code(i_lang,
                                                        i_prof,
                                                        gs.code_state,
                                                        s.series_year,
                                                        s.starting_number,
                                                        s.ending_number) current_number,
               s.ending_number,
               substr(s.series_year, 3, 4) series_year,
               pk_sysconfig.get_config(g_series_mask, i_prof),
               gs.code_state
          INTO l_rec_serie.id_series,
               l_rec_serie.starting_number,
               l_rec_serie.current_number,
               l_rec_serie.ending_number,
               l_rec_serie.series_year,
               l_rec_serie.mask,
               l_rec_serie.code_state
          FROM series s
          JOIN geo_state gs
            ON gs.id_geo_state = s.id_geo_state
         WHERE s.id_institution = i_prof.institution
           AND s.flg_status = g_series_active;
    
        RETURN l_rec_serie;
    EXCEPTION
        WHEN no_data_found THEN
            RETURN NULL;
        WHEN OTHERS THEN
            RAISE;
    END get_pre_natal_serie;
    /********************************************************************************************
    * Get sis pre natal active serie
    *
    * @param i_lang                  Prefered language ID
    * @param i_prof                  Professional ID
    * @param o_list                  Series List
    * @param o_msg                   Message of % available 
    * @param o_error                 error
    *
    * @return                        true or false on success or error
    *
    * @author                        Álvaro Vasconcelos   
    * @version                       2.5.1.5
    * @since                         2011/04/07
    ********************************************************************************************/
    FUNCTION get_pre_natal_serie
    (
        i_lang  IN language.id_language%TYPE,
        i_prof  IN profissional,
        o_list  OUT pk_types.cursor_type,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
    
        update_series_status(i_lang, i_prof);
    
        OPEN o_list FOR
            SELECT s.id_series id_serie,
                   s.starting_number,
                   pk_pregnancy_api.get_pregnancy_next_code(i_lang,
                                                            i_prof,
                                                            gs.code_state,
                                                            substr(s.series_year, 3, 4),
                                                            s.starting_number,
                                                            s.ending_number) current_number,
                   s.ending_number,
                   substr(s.series_year, 3, 4) series_year,
                   pk_sysconfig.get_config(g_series_mask, i_prof) mask,
                   gs.code_state id_state_code
              FROM series s
              JOIN geo_state gs
                ON gs.id_geo_state = s.id_geo_state
             WHERE s.id_institution = i_prof.institution
               AND s.flg_status = g_series_active;
    
        RETURN TRUE;
    EXCEPTION
        WHEN no_data_found THEN
            RETURN NULL;
        WHEN OTHERS THEN
            RAISE;
    END get_pre_natal_serie;

    /********************************************************************************************
    * Checks if a number is contained inside one of the institution series
    *
    * @param i_lang                  Prefered language ID
    * @param i_prof                  Professional ID
    * @param i_current_number        Series number that will be assessed
    * @param i_code_state            State code
    * @param i_geo_state             State ID
    *
    * @return                        this sisprenatal code is contained in the serie? (Y)es or (N)o
    *
    * @author                        Jos?Silva
    * @version                       2.5.1.9
    * @since                         2011/11/17
    ********************************************************************************************/
    FUNCTION check_inst_serie_number
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN profissional,
        i_current_number IN series.current_number%TYPE,
        i_code_state     IN geo_state.code_state%TYPE,
        i_geo_state      IN geo_state.id_geo_state%TYPE,
        i_code_year      IN series.series_year%TYPE
    ) RETURN VARCHAR2 IS
    
        l_count NUMBER;
    
    BEGIN
    
        SELECT COUNT(*)
          INTO l_count
          FROM series s
          JOIN geo_state gs
            ON gs.id_geo_state = s.id_geo_state
         WHERE s.id_institution = i_prof.institution
           AND s.flg_status <> g_series_can
           AND gs.code_state = nvl(i_code_state, gs.code_state)
           AND gs.id_geo_state = nvl(i_geo_state, gs.id_geo_state)
           AND s.series_year = i_code_year
           AND i_current_number BETWEEN s.starting_number AND s.ending_number;
    
        IF l_count > 0
        THEN
            RETURN pk_alert_constant.g_yes;
        ELSE
            RETURN pk_alert_constant.g_no;
        END IF;
    
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END check_inst_serie_number;

    /********************************************************************************************
    * Get sis pre natal active serie current number
    *
    * @param i_lang                  Prefered language ID
    * @param i_prof                  Professional ID
    * @param o_error                 error
    *
    * @return                        true or false on success or error
    *
    * @author                        Álvaro Vasconcelos   
    * @version                       2.5.1.5
    * @since                         2011/04/07
    ********************************************************************************************/
    FUNCTION get_serie_current_number
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN profissional,
        i_code_state      IN geo_state.code_state%TYPE,
        i_year            IN series.series_year%TYPE,
        i_starting_number IN series.starting_number%TYPE,
        i_ending_number   IN series.ending_number%TYPE
    ) RETURN series.current_number%TYPE IS
        l_current_number series.current_number%TYPE;
    BEGIN
    
        SELECT current_number
          INTO l_current_number
          FROM series s
         WHERE s.id_institution = i_prof.institution
           AND s.starting_number = i_starting_number
           AND s.ending_number = i_ending_number
           AND substr(s.series_year, 3, 4) = i_year
           AND s.id_geo_state = (SELECT id_geo_state
                                   FROM geo_state
                                  WHERE code_state = i_code_state);
    
        RETURN l_current_number;
    
    EXCEPTION
        WHEN no_data_found THEN
            RETURN NULL;
        WHEN OTHERS THEN
            RAISE;
    END get_serie_current_number;

    /********************************************************************************************
    * Set sis pre natal active serie current number
    *
    * @param i_lang                  Prefered language ID
    * @param i_prof                  Professional ID
    * @param i_code_state            Country state code
    * @param i_year                  Series year
    * @param i_current_number        Series current number
    * @param o_error                 error
    *
    * @return                        true or false on success or error
    *
    * @author                        Álvaro Vasconcelos   
    * @version                       2.5.1.5
    * @since                         2011/04/07
    ********************************************************************************************/
    FUNCTION set_serie_current_number
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN profissional,
        i_code_state     IN geo_state.code_state%TYPE,
        i_year           IN series.series_year%TYPE,
        i_current_number IN series.current_number%TYPE,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
        l_id_series     series.id_series%TYPE;
        l_ending_number series.ending_number%TYPE;
        l_perc          sys_config.value%TYPE := pk_sysconfig.get_config(g_series_avai_perc, i_prof);
    BEGIN
    
        g_error := 'UPDATE SERIES CURRENT NUMBER';
        UPDATE series s
           SET s.current_number = i_current_number
         WHERE s.id_institution = i_prof.institution
           AND i_current_number BETWEEN s.starting_number AND s.ending_number
           AND substr(s.series_year, 3, 4) = i_year
           AND s.id_geo_state = (SELECT id_geo_state
                                   FROM geo_state
                                  WHERE code_state = i_code_state)
           AND s.flg_status = g_series_active
        RETURNING s.id_series, s.ending_number INTO l_id_series, l_ending_number;
    
        g_error := 'VERIFIES PERCENTAGE AVAILABLE';
        IF (100 - ((i_current_number / l_ending_number) * 100)) <= to_number(l_perc)
        THEN
            g_error := 'INSERT_SYS_ALERT_EVENT';
            IF NOT pk_alerts.insert_sys_alert_event(i_lang,
                                                    i_prof,
                                                    106,
                                                    -1,
                                                    1,
                                                    current_timestamp,
                                                    i_prof.id,
                                                    NULL,
                                                    NULL,
                                                    NULL,
                                                    NULL,
                                                    NULL,
                                                    NULL,
                                                    o_error)
            THEN
                RETURN FALSE;
            END IF;
        END IF;
    
        g_error := 'VALIDATE SERIES AVAILABLE NUMBERS';
        IF i_current_number = l_ending_number
        THEN
            UPDATE series s
               SET s.flg_status = g_series_concluded
             WHERE s.id_institution = i_prof.institution
               AND s.id_series = l_id_series;
        END IF;
    
        UPDATE series s
           SET s.flg_status = g_series_active
         WHERE s.id_institution = i_prof.institution
           AND s.id_series =
               (SELECT MIN(s1.id_series)
                  FROM series s1
                 WHERE s1.flg_status = g_series_pending
                   AND s1.id_institution = i_prof.institution
                   AND s1.series_year =
                       to_char(pk_date_utils.get_timestamp_insttimezone(i_lang, s1.id_institution, current_timestamp),
                               'YYYY'))
           AND NOT EXISTS
         (SELECT 1
                  FROM series s2
                 WHERE s2.flg_status IN (g_series_active, g_series_suspended)
                   AND s2.id_institution = i_prof.institution
                   AND s2.series_year =
                       to_char(pk_date_utils.get_timestamp_insttimezone(i_lang, s2.id_institution, current_timestamp),
                               'YYYY')
                   AND s2.starting_number < s.starting_number);
    
        COMMIT;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            ROLLBACK;
            RAISE;
    END set_serie_current_number;

    /********************************************************************************************
    * Get states of a country
    *
    * @param i_lang                  Prefered language ID
    * @param i_prof                  Professional ID
    * @param o_error                 error
    *
    * @return                        true or false on success or error
    *
    * @author                        Álvaro Vasconcelos   
    * @version                       2.5.1.5
    * @since                         2011/04/07
    ********************************************************************************************/
    FUNCTION get_state_list
    (
        i_lang  IN language.id_language%TYPE,
        i_prof  IN profissional,
        o_list  OUT pk_types.cursor_type,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        g_error := 'OPEN CURSOR';
        OPEN o_list FOR
            SELECT gs.id_geo_state,
                   gs.code_state code_state,
                   pk_translation.get_translation(i_lang, gs.code_geo_state) desc_state
              FROM geo_state gs
             WHERE gs.id_country = (SELECT ia.id_country
                                      FROM inst_attributes ia
                                     WHERE ia.id_institution = i_prof.institution);
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_state_list;

    /********************************************************************************************
    * Creates/Edit a new series
    *
    * @param i_lang                  Prefered language ID
    * @param i_prof                  Professional ID
    * @param i_id_series             Series ID
    * @param i_code_state            Official code state
    * @param i_year                  Series Year
    * @param i_starting_number       Series starting number
    * @param i_ending_number         Series ending number
    * @param i_flg_status            Series status
    * @param o_error                 error
    *
    * @return                        true or false on success or error
    *
    * @author                        Álvaro Vasconcelos   
    * @version                       2.5.1.5
    * @since                         2011/04/07
    ********************************************************************************************/
    FUNCTION set_pre_natal_serie
    (
        i_lang            IN language.id_language%TYPE,
        i_prof            IN profissional,
        i_id_series       IN series.id_series%TYPE,
        i_id_geo_state    IN geo_state.id_geo_state%TYPE,
        i_year            IN series.series_year%TYPE,
        i_starting_number IN series.starting_number%TYPE,
        i_current_number  IN series.current_number%TYPE,
        i_ending_number   IN series.ending_number%TYPE,
        o_msg             OUT sys_message.desc_message%TYPE,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
        l_perc               sys_config.value%TYPE := pk_sysconfig.get_config(g_series_avai_perc, i_prof);
        l_overlapping_series series.id_series%TYPE;
    
        l_overlapping_array        table_number := table_number();
        l_overlap_validation_start NUMBER(24) := 0;
        l_overlap_validation_end   NUMBER(24) := 0;
        l_index                    NUMBER := 1;
    
        CURSOR c_all_series IS
            SELECT s.id_series
              FROM series s
             WHERE s.id_institution = i_prof.institution
               AND s.series_year = i_year
               AND s.flg_status != g_series_can
               AND s.id_series != i_id_series;
    BEGIN
    
        g_error := 'VERIFY OVERLAPPING SERIES';
        FOR serie IN c_all_series
        LOOP
            /* starting number validation */
            SELECT nvl(COUNT(*), 0)
              INTO l_overlap_validation_start
              FROM series s
             WHERE s.id_institution = i_prof.institution
               AND ((i_starting_number BETWEEN s.starting_number AND
                   decode(s.flg_status, g_series_desc, s.current_number, s.ending_number)) OR
                   (s.starting_number BETWEEN i_starting_number AND i_ending_number))
               AND s.id_series = serie.id_series;
        
            /* ending number validation */
            SELECT nvl(COUNT(*), 0)
              INTO l_overlap_validation_end
              FROM series s
             WHERE s.id_institution = i_prof.institution
               AND ((i_ending_number BETWEEN s.starting_number AND
                   decode(s.flg_status, g_series_desc, s.current_number, s.ending_number)) OR
                   (decode(s.flg_status, g_series_desc, s.current_number, s.ending_number) BETWEEN i_starting_number AND
                   i_ending_number))
               AND s.id_series = serie.id_series;
        
            IF l_overlap_validation_start > 0
               OR l_overlap_validation_end > 0
            THEN
                l_overlapping_array.extend;
                l_overlapping_array(l_index) := serie.id_series;
                l_index := l_index + 1;
            END IF;
        
        END LOOP;
    
        IF i_current_number >= i_starting_number
           AND i_current_number <= i_ending_number
           AND l_overlapping_array.count = 0
        THEN
            g_error := 'MERGE INTO SERIES';
            MERGE INTO series s
            USING (SELECT i_id_series id_series, i_prof.institution id_institution
                     FROM dual) t
            ON (s.id_series = t.id_series AND s.id_institution = t.id_institution)
            WHEN MATCHED THEN
                UPDATE
                   SET s.id_geo_state    = i_id_geo_state,
                       s.series_year     = i_year,
                       s.starting_number = i_starting_number,
                       s.current_number  = i_current_number,
                       s.ending_number   = i_ending_number
            WHEN NOT MATCHED THEN
                INSERT
                    (s.id_series,
                     s.id_institution,
                     s.id_geo_state,
                     s.starting_number,
                     s.current_number,
                     s.ending_number,
                     s.series_year,
                     s.flg_status)
                VALUES
                    (i_id_series,
                     i_prof.institution,
                     i_id_geo_state,
                     i_starting_number,
                     i_current_number,
                     i_ending_number,
                     i_year,
                     (SELECT nvl((SELECT decode(s1.flg_status,
                                               g_series_active,
                                               g_series_pending,
                                               g_series_suspended,
                                               g_series_pending,
                                               g_series_active)
                                   FROM series s1
                                  WHERE s1.id_institution = i_prof.institution
                                    AND s1.flg_status IN (g_series_active, g_series_suspended)
                                    AND s1.series_year = i_year
                                    AND rownum = 1),
                                 decode(i_year, to_char(current_timestamp, 'YYYY'), g_series_active, g_series_pending))
                        FROM dual));
        
            g_error := 'VERIFIES PERCENTAGE AVAILABLE';
            IF (100 - ((i_current_number / i_ending_number) * 100)) <= to_number(l_perc)
            THEN
                g_error := 'INSERT_SYS_ALERT_EVENT';
                IF NOT pk_alerts.insert_sys_alert_event(i_lang,
                                                        i_prof,
                                                        106,
                                                        -1,
                                                        1,
                                                        current_timestamp,
                                                        i_prof.id,
                                                        NULL,
                                                        NULL,
                                                        NULL,
                                                        NULL,
                                                        NULL,
                                                        NULL,
                                                        o_error)
                THEN
                    RETURN FALSE;
                END IF;
            END IF;
        ELSE
            o_msg := pk_message.get_message(i_lang, 'SIS_PRE_NATAL_M003');
            RETURN TRUE;
        END IF;
    
        COMMIT;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            ROLLBACK;
            RAISE;
    END set_pre_natal_serie;

    /********************************************************************************************
    * Sets pre natal series status
    *
    * @param i_lang                  Prefered language ID
    * @param i_prof                  Professional ID
    * @param i_id_series             Series ID
    * @param i_flg_status            Series status
    * @param o_error                 error
    *
    * @return                        true or false on success or error
    *
    * @author                        Álvaro Vasconcelos   
    * @version                       2.5.1.5
    * @since                         2011/04/07
    ********************************************************************************************/
    FUNCTION set_pre_natal_serie_status
    (
        i_lang       IN language.id_language%TYPE,
        i_prof       IN profissional,
        i_id_series  IN series.id_series%TYPE,
        i_flg_status IN series.flg_status%TYPE,
        o_error      OUT t_error_out
    ) RETURN BOOLEAN IS
        l_status      series.flg_status%TYPE := i_flg_status;
        l_from_status series.flg_status%TYPE;
        l_exception EXCEPTION;
    BEGIN
    
        SELECT s.flg_status
          INTO l_from_status
          FROM series s
         WHERE s.id_series = i_id_series
           AND s.id_institution = i_prof.institution;
    
        IF l_status = g_series_can_desc
        THEN
            g_error := 'VERIFY EDITION';
            SELECT decode(s.starting_number,
                          pk_pregnancy_api.get_pregnancy_next_code(i_lang,
                                                                   i_prof,
                                                                   gs.code_state,
                                                                   substr(s.series_year, 3, 4),
                                                                   s.starting_number,
                                                                   s.ending_number),
                          g_series_can,
                          g_series_desc)
              INTO l_status
              FROM series s
              JOIN geo_state gs
                ON gs.id_geo_state = s.id_geo_state
             WHERE s.id_institution = i_prof.institution
               AND s.id_series = i_id_series;
        
        ELSIF l_status = g_series_active
        THEN
            g_error := 'VERIFY PROGRESSABILITY';
            SELECT decode(s.series_year,
                          to_char(current_timestamp, 'YYYY'),
                          decode((SELECT 1
                                   FROM series s2
                                  WHERE s2.flg_status IN (g_series_active, g_series_suspended)
                                    AND s2.id_institution = i_prof.institution
                                    AND s2.starting_number < s.starting_number
                                    AND rownum = 1),
                                 1,
                                 g_series_pending,
                                 g_series_active),
                          g_series_pending)
              INTO l_status
              FROM series s
             WHERE s.id_institution = i_prof.institution
               AND s.id_series = i_id_series;
        END IF;
    
        g_error := 'UPDATING SERIES FLG_STATUS';
        UPDATE series s
           SET s.flg_status = l_status
         WHERE s.id_institution = i_prof.institution
           AND s.id_series = i_id_series;
    
        g_error := 'INSERT SYS_ALERT';
        IF l_from_status = g_series_active
        THEN
            IF NOT pk_alerts.insert_sys_alert_event(i_lang,
                                                    i_prof,
                                                    107,
                                                    -1,
                                                    i_prof.id,
                                                    current_timestamp,
                                                    i_prof.id,
                                                    NULL,
                                                    NULL,
                                                    NULL,
                                                    NULL,
                                                    NULL,
                                                    NULL,
                                                    o_error)
            THEN
                RAISE l_exception;
            END IF;
        END IF;
    
        COMMIT;
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            ROLLBACK;
            RAISE;
    END set_pre_natal_serie_status;

    /********************************************************************************************
    * Get next series
    *
    * @param i_lang                  Prefered language ID
    * @param i_prof                  Professional ID
    * @param o_next_id_series        Series next ID
    * @param o_current_year          Current year
    * @param o_msg_atributed         Message attributed numbers (N/A)
    * @param o_msg_available         Message available numbers (N/A)
    * @param o_flg_status            Series flag status
    * @param o_desc_status           Series desc status
    * @param o_error                 error
    *
    * @return                        true or false on success or error
    *
    * @author                        Álvaro Vasconcelos   
    * @version                       2.5.1.5
    * @since                         2011/04/07
    ********************************************************************************************/
    FUNCTION get_next_pre_natal_serie
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN profissional,
        o_next_id_series OUT series.id_series%TYPE,
        o_current_year   OUT series.series_year%TYPE,
        o_msg_atributed  OUT sys_message.desc_message%TYPE,
        o_msg_available  OUT sys_message.desc_message%TYPE,
        o_code_state     OUT geo_state.code_state%TYPE,
        o_desc_state     OUT pk_translation.t_desc_translation,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
        l_n_a_msg       sys_message.desc_message%TYPE := pk_message.get_message(i_lang, g_series_na_msg);
        l_max_id_series series.id_series%TYPE;
    BEGIN
        g_error := 'GET NEXT SERIES DETAILS';
        SELECT MAX(s.id_series),
               nvl(MAX(s.id_series) + 1, 1),
               pk_date_utils.date_year_tsz(i_lang, current_timestamp, i_prof.institution, i_prof.software),
               l_n_a_msg,
               l_n_a_msg
          INTO l_max_id_series, o_next_id_series, o_current_year, o_msg_atributed, o_msg_available
          FROM series s
         WHERE s.id_institution = i_prof.institution;
    
        g_error := 'GET STATE DETAILS';
        BEGIN
            SELECT gs.code_state, pk_translation.get_translation(i_lang, gs.code_geo_state)
              INTO o_code_state, o_desc_state
              FROM series s
              JOIN geo_state gs
                ON gs.id_geo_state = s.id_geo_state
             WHERE s.id_institution = i_prof.institution
               AND s.id_series = l_max_id_series;
        EXCEPTION
            WHEN no_data_found THEN
                o_code_state := NULL;
                o_desc_state := NULL;
        END;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_next_pre_natal_serie;

    /********************************************************************************************
    * Get pre natal series available status
    *
    * @param i_lang                  Prefered language ID
    * @param i_prof                  Professional ID
    * @param o_list                  List of status
    * @param o_error                 error
    *
    * @return                        true or false on success or error
    *
    * @author                        Álvaro Vasconcelos   
    * @version                       2.5.1.5
    * @since                         2011/04/07
    ********************************************************************************************/
    FUNCTION get_series_available_status
    (
        i_lang       IN language.id_language%TYPE,
        i_prof       IN profissional,
        i_id_series  IN series.id_series%TYPE,
        i_subject    IN action.subject%TYPE,
        i_from_state IN action.from_state%TYPE,
        o_list       OUT pk_types.cursor_type,
        o_error      OUT t_error_out
    ) RETURN BOOLEAN IS
        l_canc_disc           sys_domain.desc_val%TYPE := pk_sysdomain.get_domain(g_series_domain, g_series_can, i_lang) ||
                                                          ' / ' || pk_sysdomain.get_domain(g_series_domain,
                                                                                           g_series_desc,
                                                                                           i_lang);
        l_actions             t_coll_action;
        l_action_states       table_varchar := table_varchar();
        l_canc_disc_available BOOLEAN;
        l_unused_serie        VARCHAR2(1 CHAR);
        l_prog_serie          VARCHAR2(1 CHAR);
    BEGIN
        g_error   := 'GET_ACTIONS';
        l_actions := pk_action.tf_get_actions(i_lang       => i_lang,
                                              i_prof       => i_prof,
                                              i_subject    => i_subject,
                                              i_from_state => i_from_state);
    
        FOR i IN l_actions.first .. l_actions.last
        LOOP
            IF l_actions(i).to_state = g_series_can_desc
            THEN
                l_canc_disc_available := TRUE;
            ELSE
                IF l_actions(i).flg_active = g_series_active
                THEN
                    l_action_states.extend;
                    l_action_states(l_action_states.last) := l_actions(i).to_state;
                END IF;
            END IF;
        END LOOP;
    
        IF l_canc_disc_available
        THEN
            l_action_states.extend;
            l_action_states(l_action_states.last) := g_series_can;
            l_action_states.extend;
            l_action_states(l_action_states.last) := g_series_desc;
        END IF;
    
        g_error := 'VERIFY EDITION AND PROGRESSABILITY';
        SELECT decode(s.starting_number,
                      pk_pregnancy_api.get_pregnancy_next_code(i_lang,
                                                               i_prof,
                                                               gs.code_state,
                                                               substr(s.series_year, 3, 4),
                                                               s.starting_number,
                                                               s.ending_number),
                      g_series_active,
                      g_series_inactive),
               decode(s.series_year,
                      to_char(current_timestamp, 'YYYY'),
                      decode((SELECT 1
                               FROM series s2
                              WHERE s2.flg_status IN (g_series_active, g_series_suspended)
                                AND s2.id_institution = i_prof.institution
                                AND s2.starting_number < s.starting_number
                                AND rownum = 1),
                             1,
                             g_series_inactive,
                             g_series_active),
                      g_series_inactive)
          INTO l_unused_serie, l_prog_serie
          FROM series s
          JOIN geo_state gs
            ON gs.id_geo_state = s.id_geo_state
         WHERE s.id_institution = i_prof.institution
           AND s.id_series = i_id_series;
    
        g_error := 'OPEN o_list';
        OPEN o_list FOR
        
            SELECT sd.desc_val,
                   sd.val flg_status,
                   sd.img_name,
                   sd.rank,
                   decode(b.to_state,
                          NULL,
                          decode(sd.val,
                                 i_from_state,
                                 g_series_no,
                                 g_series_pending,
                                 decode(l_prog_serie, g_series_inactive, g_series_available, g_series_no),
                                 g_series_no),
                          decode(sd.val,
                                 g_series_can,
                                 decode(l_unused_serie, g_series_active, g_series_available, g_series_no),
                                 g_series_desc,
                                 decode(l_unused_serie, g_series_active, g_series_no, g_series_available),
                                 g_series_active,
                                 decode(l_prog_serie, g_series_active, g_series_available, g_series_no),
                                 g_series_available)) flg_action
              FROM sys_domain sd
              LEFT JOIN (SELECT column_value to_state
                           FROM TABLE(l_action_states)) b
                ON sd.val = b.to_state
             WHERE sd.code_domain = g_series_domain
               AND sd.domain_owner = pk_sysdomain.k_default_schema
               AND sd.id_language = i_lang
               AND sd.flg_available = g_series_available;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_series_available_status;

    /********************************************************************************************
    * Get pre natal series available actions
    *
    * @param i_lang                  Prefered language ID
    * @param i_prof                  Professional ID
    * @param o_list                  List of actions
    * @param o_error                 error
    *
    * @return                        true or false on success or error
    *
    * @author                        Álvaro Vasconcelos   
    * @version                       2.5.1.5
    * @since                         2011/04/07
    ********************************************************************************************/
    FUNCTION get_series_actions
    (
        i_lang       IN language.id_language%TYPE,
        i_prof       IN profissional,
        i_id_series  IN series.id_series%TYPE,
        i_subject    IN action.subject%TYPE,
        i_from_state IN action.from_state%TYPE,
        o_actions    OUT pk_types.cursor_type,
        o_error      OUT t_error_out
    ) RETURN BOOLEAN IS
        l_actions         t_coll_action;
        l_edit_rec        t_rec_action;
        l_unused_serie    VARCHAR2(1 CHAR);
        l_edit_message    sys_message.desc_message%TYPE;
        l_id_serie_active series.id_series%TYPE;
    BEGIN
    
        g_error   := 'GET_ACTIONS';
        l_actions := pk_action.tf_get_actions(i_lang       => i_lang,
                                              i_prof       => i_prof,
                                              i_subject    => i_subject,
                                              i_from_state => i_from_state);
    
        g_error := 'VERIFY EDITION';
        SELECT decode(s.starting_number,
                      pk_pregnancy_api.get_pregnancy_next_code(i_lang,
                                                               i_prof,
                                                               gs.code_state,
                                                               substr(s.series_year, 3, 4),
                                                               s.starting_number,
                                                               s.ending_number),
                      decode(s.flg_status,
                             g_series_can,
                             g_series_inactive,
                             g_series_desc,
                             g_series_inactive,
                             g_series_active),
                      g_series_inactive),
               pk_message.get_message(i_lang, g_series_edit_msg)
          INTO l_unused_serie, l_edit_message
          FROM series s
          JOIN geo_state gs
            ON gs.id_geo_state = s.id_geo_state
         WHERE s.id_institution = i_prof.institution
           AND s.id_series = i_id_series;
    
        g_error := 'VERIFY EXISTENT "IN PROGRESS" SERIES';
        BEGIN
            SELECT s.id_series
              INTO l_id_serie_active
              FROM series s
             WHERE s.id_institution = i_prof.institution
               AND s.flg_status = g_series_active;
        EXCEPTION
            WHEN no_data_found THEN
                l_id_serie_active := NULL;
        END;
    
        g_error    := 'ADDING EDITION ACTION';
        l_edit_rec := t_rec_action(-1,
                                   NULL,
                                   1,
                                   i_from_state,
                                   g_series_edit,
                                   l_edit_message,
                                   NULL,
                                   g_series_no,
                                   i_subject,
                                   l_unused_serie);
    
        g_error := 'OPEN CURSOR';
        OPEN o_actions FOR
            SELECT *
              FROM TABLE(t_coll_action(l_edit_rec) MULTISET UNION l_actions);
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE;
    END get_series_actions;

    /********************************************************************************************
    * This procedure performs cpoe specific tasks (to be called by an oracle job)
    *
    * @return                        true or false on success or error
    *
    * @author                        Álvaro Vasconcelos   
    * @version                       2.5.1.5
    * @since                         2011/04/07
    ********************************************************************************************/
    PROCEDURE series_job_validator IS
        l_lang language.id_language%TYPE := to_number(pk_sysconfig.get_config(pk_alert_constant.g_sys_config_def_language,
                                                                              pk_alert_constant.g_inst_all,
                                                                              pk_alert_constant.g_soft_all));
    
        l_error t_error_out;
    
        CURSOR c_admins IS
            SELECT p.id_professional, i.id_institution, ppt.id_software
              FROM institution i
              JOIN prof_institution pi
                ON pi.id_institution = i.id_institution
              JOIN professional p
                ON p.id_professional = pi.id_professional
              JOIN prof_profile_template ppt
                ON ppt.id_professional = p.id_professional
               AND ppt.id_institution = i.id_institution
             WHERE ppt.id_profile_template IN (SELECT pt.id_profile_template
                                                 FROM profile_template pt
                                                 JOIN profile_template_category ptc
                                                   ON ptc.id_profile_template = pt.id_profile_template
                                                WHERE ptc.id_category = 20)
               AND ppt.id_software = 26
               AND i.id_market = 3;
    
        l_exception EXCEPTION;
        l_id_serie series.id_series%TYPE;
    BEGIN
        g_error := 'series job begin';
        UPDATE series s
           SET s.flg_status = decode(s.starting_number,
                                     pk_pregnancy_api.get_pregnancy_next_code(l_lang,
                                                                              profissional(0,
                                                                                           s.id_institution,
                                                                                           pk_alert_constant.g_soft_all),
                                                                              (SELECT gs.code_state
                                                                                 FROM geo_state gs
                                                                                WHERE gs.id_geo_state = s.id_geo_state),
                                                                              substr(s.series_year, 3, 4),
                                                                              s.starting_number,
                                                                              s.ending_number),
                                     g_series_can,
                                     g_series_desc)
         WHERE s.flg_status = g_series_active
           AND to_number(s.series_year) -
               to_number(to_char(pk_date_utils.get_timestamp_insttimezone(l_lang, s.id_institution, current_timestamp),
                                 'YYYY')) < 0;
    
        g_error := 'create alert';
        FOR prof IN c_admins
        LOOP
            g_error := 'validating series alert for: ' || prof.id_professional;
            UPDATE series s
               SET s.flg_status = g_series_active
             WHERE s.id_institution = prof.id_institution
               AND s.id_series =
                   (SELECT MIN(s1.id_series)
                      FROM series s1
                     WHERE s1.flg_status = g_series_pending
                       AND s1.id_institution = prof.id_institution
                       AND s1.series_year =
                           to_char(pk_date_utils.get_timestamp_insttimezone(l_lang, s1.id_institution, current_timestamp),
                                   'YYYY'))
               AND NOT EXISTS
             (SELECT 1
                      FROM series s2
                     WHERE s2.flg_status IN (g_series_active, g_series_suspended)
                       AND s2.id_institution = prof.id_institution
                       AND s2.series_year =
                           to_char(pk_date_utils.get_timestamp_insttimezone(l_lang, s2.id_institution, current_timestamp),
                                   'YYYY')
                       AND s2.starting_number < s.starting_number);
        
            BEGIN
                SELECT s.id_series
                  INTO l_id_serie
                  FROM series s
                 WHERE s.id_institution = prof.id_institution
                   AND s.flg_status = g_series_active;
            EXCEPTION
                WHEN no_data_found THEN
                    l_id_serie := NULL;
            END;
        
            IF l_id_serie IS NULL
            THEN
                IF NOT pk_alerts.insert_sys_alert_event(l_lang,
                                                        profissional(prof.id_professional,
                                                                     prof.id_institution,
                                                                     prof.id_software),
                                                        107,
                                                        -1,
                                                        prof.id_professional,
                                                        current_timestamp,
                                                        prof.id_professional,
                                                        NULL,
                                                        NULL,
                                                        NULL,
                                                        NULL,
                                                        NULL,
                                                        NULL,
                                                        l_error)
                THEN
                    RAISE l_exception;
                END IF;
            END IF;
        END LOOP;
    
        COMMIT;
    EXCEPTION
        WHEN OTHERS THEN
            ROLLBACK;
            pk_alert_exceptions.process_error(l_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SERIES_JOB_VALIDATOR',
                                              l_error);
        
    END series_job_validator;

    /********************************************************************************************
    * Get geo_state table id
    *
    * @param i_lang                  Prefered language ID
    * @param i_prof                  Professional ID
    * @param i_code_state            List of actions
    *
    * @return                        id_geo_state
    *
    * @author                        Álvaro Vasconcelos   
    * @version                       2.5.1.5
    * @since                         2011/04/07
    ********************************************************************************************/
    FUNCTION get_geo_state_id
    (
        i_lang       IN language.id_language%TYPE,
        i_prof       IN profissional,
        i_code_state IN geo_state.code_state%TYPE
    ) RETURN geo_state.id_geo_state%TYPE IS
        l_id_geo_state geo_state.id_geo_state%TYPE;
    BEGIN
        SELECT id_geo_state
          INTO l_id_geo_state
          FROM geo_state
         WHERE geo_state.code_state = i_code_state;
    
        RETURN l_id_geo_state;
    EXCEPTION
        WHEN no_data_found THEN
            RETURN NULL;
        WHEN OTHERS THEN
            RAISE;
    END get_geo_state_id;

    /********************************************************************************************
    * Get code_state from geo_state table
    *
    * @param i_lang                  Prefered language ID
    * @param i_prof                  Professional ID
    * @param i_id_geo_state          Geo state ID 
    *
    * @return                        code_state
    *
    * @author                        Álvaro Vasconcelos   
    * @version                       2.5.1.5
    * @since                         2011/04/29
    ********************************************************************************************/
    FUNCTION get_code_state
    (
        i_lang         IN language.id_language%TYPE,
        i_prof         IN profissional,
        i_id_geo_state IN geo_state.code_state%TYPE
    ) RETURN geo_state.code_state%TYPE IS
        l_code_state geo_state.code_state%TYPE;
    BEGIN
        SELECT code_state
          INTO l_code_state
          FROM geo_state
         WHERE geo_state.id_geo_state = i_id_geo_state;
    
        RETURN l_code_state;
    EXCEPTION
        WHEN no_data_found THEN
            RETURN NULL;
        WHEN OTHERS THEN
            RAISE;
    END get_code_state;
    /********************************************************************************************
    * Set Institution Professional state
    *
    * @param i_lang                  Prefered language ID
    * @param i_id_professional       Professional ID
    * @param i_id_institution        Institution ID
    * @param i_flg_state             Professional state
    * @param i_num_mecan             Mecan. Number
    * @param o_flg_state             Professional state
    * @param o_icon                  Professional state icon
    *
    *
    * @return                      true or false on success or error
    *
    * @author                      JTS
    * @version                     0.1
    * @since                       2008/06/02
    ********************************************************************************************/
    FUNCTION set_intf_prof_inst_state
    (
        i_lang            IN language.id_language%TYPE,
        i_id_professional IN prof_institution.id_professional%TYPE,
        i_id_institution  IN prof_institution.id_institution%TYPE,
        i_flg_state       IN prof_institution.flg_state%TYPE,
        i_num_mecan       IN prof_institution.num_mecan%TYPE,
        o_flg_state       OUT prof_institution.flg_state%TYPE,
        o_icon            OUT VARCHAR2,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_state               prof_institution.flg_state%TYPE;
        l_id_prof_institution prof_institution.id_prof_institution%TYPE;
        l_num_mecano          prof_institution.num_mecan%TYPE;
        l_dt_end_tstz         TIMESTAMP(6) WITH LOCAL TIME ZONE;
    
    BEGIN
    
        g_error := 'GET PROF_INSTITUTION STATE';
        SELECT decode((SELECT COUNT(pi.flg_state)
                        FROM prof_institution pi
                       WHERE pi.id_institution = i_id_institution
                         AND pi.id_professional = i_id_professional
                         AND pi.dt_end_tstz IS NULL),
                      0,
                      (SELECT pi.flg_state
                         FROM prof_institution pi
                        WHERE pi.id_professional = i_id_professional
                          AND pi.id_institution = i_id_institution
                          AND pi.dt_end_tstz = (SELECT MAX(pi2.dt_end_tstz)
                                                  FROM prof_institution pi2
                                                 WHERE pi2.id_institution = i_id_institution
                                                   AND pi2.id_professional = i_id_professional)),
                      (SELECT pi.flg_state
                         FROM prof_institution pi
                        WHERE pi.id_institution = i_id_institution
                          AND pi.id_professional = i_id_professional
                          AND pi.dt_end_tstz IS NULL))
          INTO l_state
          FROM dual;
    
        IF i_flg_state = 'A'
           AND l_state != 'A'
        THEN
            g_error := 'GET PROF_INSTITUTION PK';
            BEGIN
                SELECT pi.id_prof_institution
                  INTO l_id_prof_institution
                  FROM prof_institution pi
                 WHERE pi.id_professional = i_id_professional
                   AND pi.id_institution = i_id_institution
                   AND pi.flg_state = l_state
                   AND pi.dt_end_tstz IS NULL;
            EXCEPTION
                WHEN no_data_found THEN
                    l_id_prof_institution := NULL;
            END;
            g_error := 'UPDATE PROF_INSTITUTION';
            --
            pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_id_prof_institution,
                                                           i_id_professional     => i_id_professional,
                                                           i_id_institution      => i_id_institution,
                                                           i_flg_state           => l_state,
                                                           i_dt_end_tstz         => g_sysdate_tstz,
                                                           o_id_prof_institution => l_id_prof_institution);
        
            g_error := 'INSERT INTO PROF_INSTITUTION';
            pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                           i_id_professional     => i_id_professional,
                                                           i_id_institution      => i_id_institution,
                                                           i_flg_state           => i_flg_state,
                                                           i_num_mecan           => i_num_mecan,
                                                           i_dt_begin_tstz       => g_sysdate_tstz,
                                                           o_id_prof_institution => l_id_prof_institution);
        
        ELSIF i_flg_state = 'A'
              AND l_state = 'A'
        THEN
            g_error := 'GET PROF_INSTITUTION PK';
            BEGIN
                SELECT pi.id_prof_institution
                  INTO l_id_prof_institution
                  FROM prof_institution pi
                 WHERE pi.id_professional = i_id_professional
                   AND pi.id_institution = i_id_institution
                   AND pi.flg_state = i_flg_state
                   AND pi.dt_end_tstz IS NULL;
            EXCEPTION
                WHEN no_data_found THEN
                    l_id_prof_institution := NULL;
            END;
            g_error := 'GET PROF_INSTITUTION NUM_MECAN';
            SELECT decode((SELECT pi.num_mecan
                          
                            FROM prof_institution pi
                           WHERE pi.id_professional = i_id_professional
                             AND pi.id_institution = i_id_institution
                             AND pi.flg_state = i_flg_state
                             AND pi.dt_end_tstz IS NULL),
                          
                          NULL,
                          NULL,
                          (SELECT pi.num_mecan
                           
                             FROM prof_institution pi
                            WHERE pi.id_professional = i_id_professional
                              AND pi.id_institution = i_id_institution
                              AND pi.flg_state = i_flg_state
                              AND pi.dt_end_tstz IS NULL))
              INTO l_num_mecano
              FROM dual;
        
            IF l_num_mecano IS NULL
            THEN
                g_error := 'UPDATE PROF_INSTITUTION';
                pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_id_prof_institution,
                                                               i_id_professional     => i_id_professional,
                                                               i_id_institution      => i_id_institution,
                                                               i_flg_state           => i_flg_state,
                                                               i_dt_end_tstz         => g_sysdate_tstz,
                                                               o_id_prof_institution => l_id_prof_institution);
            
            ELSIF l_num_mecano != i_num_mecan
            THEN
                g_error := 'UPDATE PROF_INSTITUTION';
                pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                               i_id_professional     => i_id_professional,
                                                               i_id_institution      => i_id_institution,
                                                               i_flg_state           => i_flg_state,
                                                               i_num_mecan           => i_num_mecan,
                                                               i_dt_begin_tstz       => g_sysdate_tstz,
                                                               o_id_prof_institution => l_id_prof_institution);
            
                g_error := 'INSERT INTO PROF_INSTITUTION';
                pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                               i_id_professional     => i_id_professional,
                                                               i_id_institution      => i_id_institution,
                                                               i_flg_state           => i_flg_state,
                                                               i_num_mecan           => i_num_mecan,
                                                               i_dt_begin_tstz       => g_sysdate_tstz,
                                                               o_id_prof_institution => l_id_prof_institution);
            
            END IF;
        
        ELSIF (i_flg_state = 'I' OR i_flg_state = 'S')
        THEN
            IF l_state = 'A'
            THEN
                g_error := 'GET PROF_INSTITUTION PK';
                BEGIN
                    SELECT pi.id_prof_institution
                      INTO l_id_prof_institution
                      FROM prof_institution pi
                     WHERE pi.id_professional = i_id_professional
                       AND pi.id_institution = i_id_institution
                       AND pi.flg_state = g_status_a
                       AND pi.dt_end_tstz IS NULL;
                EXCEPTION
                    WHEN no_data_found THEN
                        l_id_prof_institution := NULL;
                END;
                g_error := 'UPDATE PROF_INSTITUTION';
                pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_id_prof_institution,
                                                               i_id_professional     => i_id_professional,
                                                               i_id_institution      => i_id_institution,
                                                               i_flg_state           => g_status_a,
                                                               i_dt_end_tstz         => g_sysdate_tstz,
                                                               o_id_prof_institution => l_id_prof_institution);
            
                g_error := 'INSERT INTO PROF_INSTITUTION';
                pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                               i_id_professional     => i_id_professional,
                                                               i_id_institution      => i_id_institution,
                                                               i_flg_state           => i_flg_state,
                                                               i_num_mecan           => i_num_mecan,
                                                               i_dt_begin_tstz       => g_sysdate_tstz,
                                                               o_id_prof_institution => l_id_prof_institution);
            
            ELSE
            
                IF i_flg_state = l_state
                THEN
                    g_error := 'GET PROF_INSTITUTION PK';
                    BEGIN
                        SELECT pi.id_prof_institution
                          INTO l_id_prof_institution
                          FROM prof_institution pi
                         WHERE pi.id_professional = i_id_professional
                           AND pi.id_institution = i_id_institution
                           AND pi.flg_state = i_flg_state
                           AND pi.dt_end_tstz IS NULL;
                    EXCEPTION
                        WHEN no_data_found THEN
                            l_id_prof_institution := NULL;
                    END;
                    SELECT decode((SELECT MAX(pi.dt_end_tstz)
                                    FROM prof_institution pi
                                   WHERE pi.id_professional = i_id_professional
                                     AND pi.id_institution = i_id_institution
                                     AND pi.flg_state = i_flg_state),
                                  NULL,
                                  NULL,
                                  (SELECT MAX(pi.dt_end_tstz)
                                     FROM prof_institution pi
                                    WHERE pi.id_professional = i_id_professional
                                      AND pi.id_institution = i_id_institution
                                      AND pi.flg_state = i_flg_state))
                      INTO l_dt_end_tstz
                      FROM dual;
                
                    IF l_dt_end_tstz IS NULL
                    THEN
                    
                        g_error := 'GET PROF_INSTITUTION NUM_MECAN';
                        SELECT decode((SELECT pi.num_mecan
                                      
                                        FROM prof_institution pi
                                       WHERE pi.id_professional = i_id_professional
                                         AND pi.id_institution = i_id_institution
                                         AND pi.flg_state = i_flg_state
                                         AND pi.dt_end_tstz IS NULL),
                                      
                                      NULL,
                                      NULL,
                                      (SELECT pi.num_mecan
                                       
                                         FROM prof_institution pi
                                        WHERE pi.id_professional = i_id_professional
                                          AND pi.id_institution = i_id_institution
                                          AND pi.flg_state = i_flg_state
                                          AND pi.dt_end_tstz IS NULL))
                          INTO l_num_mecano
                          FROM dual;
                    
                        IF l_num_mecano != i_num_mecan
                        THEN
                            g_error := 'UPDATE PROF_INSTITUTION';
                            pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_id_prof_institution,
                                                                           i_id_professional     => i_id_professional,
                                                                           i_id_institution      => i_id_institution,
                                                                           i_flg_state           => i_flg_state,
                                                                           i_dt_end_tstz         => g_sysdate_tstz,
                                                                           o_id_prof_institution => l_id_prof_institution);
                        
                            g_error := 'INSERT INTO PROF_INSTITUTION';
                            pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                                           i_id_professional     => i_id_professional,
                                                                           i_id_institution      => i_id_institution,
                                                                           i_flg_state           => i_flg_state,
                                                                           i_num_mecan           => i_num_mecan,
                                                                           i_dt_begin_tstz       => g_sysdate_tstz,
                                                                           o_id_prof_institution => l_id_prof_institution);
                        
                        END IF;
                    ELSE
                    
                        g_error := 'GET PROF_INSTITUTION NUM_MECAN';
                        SELECT decode((SELECT pi.num_mecan
                                      
                                        FROM prof_institution pi
                                       WHERE pi.id_professional = i_id_professional
                                         AND pi.id_institution = i_id_institution
                                         AND pi.flg_state = i_flg_state
                                         AND pi.dt_end_tstz = l_dt_end_tstz),
                                      
                                      NULL,
                                      NULL,
                                      (SELECT pi.num_mecan
                                       
                                         FROM prof_institution pi
                                        WHERE pi.id_professional = i_id_professional
                                          AND pi.id_institution = i_id_institution
                                          AND pi.flg_state = i_flg_state
                                          AND pi.dt_end_tstz = l_dt_end_tstz))
                          INTO l_num_mecano
                          FROM dual;
                    
                        IF l_num_mecano != i_num_mecan
                        THEN
                            g_error := 'UPDATE PROF_INSTITUTION';
                            pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_id_prof_institution,
                                                                           i_id_professional     => i_id_professional,
                                                                           i_id_institution      => i_id_institution,
                                                                           i_flg_state           => i_flg_state,
                                                                           i_dt_end_tstz         => g_sysdate_tstz,
                                                                           o_id_prof_institution => l_id_prof_institution);
                        
                            g_error := 'INSERT INTO PROF_INSTITUTION';
                            pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                                           i_id_professional     => i_id_professional,
                                                                           i_id_institution      => i_id_institution,
                                                                           i_flg_state           => i_flg_state,
                                                                           i_num_mecan           => i_num_mecan,
                                                                           i_dt_begin_tstz       => g_sysdate_tstz,
                                                                           o_id_prof_institution => l_id_prof_institution);
                        
                        END IF;
                    
                    END IF;
                
                ELSE
                    g_error := 'GET PROF_INSTITUTION PK';
                    BEGIN
                        SELECT pi.id_prof_institution
                          INTO l_id_prof_institution
                          FROM prof_institution pi
                         WHERE pi.id_professional = i_id_professional
                           AND pi.id_institution = i_id_institution
                           AND pi.flg_state = l_state
                           AND pi.dt_end_tstz IS NULL;
                    EXCEPTION
                        WHEN no_data_found THEN
                            l_id_prof_institution := NULL;
                    END;
                    g_error := 'UPDATE PROF_INSTITUTION';
                    pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => l_id_prof_institution,
                                                                   i_id_professional     => i_id_professional,
                                                                   i_id_institution      => i_id_institution,
                                                                   i_flg_state           => l_state,
                                                                   i_dt_end_tstz         => g_sysdate_tstz,
                                                                   o_id_prof_institution => l_id_prof_institution);
                
                    g_error := 'INSERT INTO PROF_INSTITUTION';
                    pk_api_ab_tables.upd_ins_into_prof_institution(i_id_prof_institution => NULL,
                                                                   i_id_professional     => i_id_professional,
                                                                   i_id_institution      => i_id_institution,
                                                                   i_flg_state           => i_flg_state,
                                                                   i_num_mecan           => i_num_mecan,
                                                                   i_dt_begin_tstz       => g_sysdate_tstz,
                                                                   o_id_prof_institution => l_id_prof_institution);
                
                END IF;
            
            END IF;
        
        END IF;
        g_error := 'REMOVE PROFESSIONAL MEC NUMBER';
        IF i_num_mecan IS NULL
        THEN
            pk_api_ab_tables.remove_prof_inst_num_mec(i_id_prof_inst => l_id_prof_institution);
        END IF;
    
        o_flg_state := i_flg_state;
        o_icon      := pk_sysdomain.get_img(i_lang, 'PROF_INSTITUTION.FLG_STATE', o_flg_state);
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
        
            DECLARE
                l_error_in t_error_in := t_error_in();
                l_ret      BOOLEAN;
            BEGIN
                l_error_in.set_all(i_lang,
                                   SQLCODE,
                                   SQLERRM,
                                   g_error,
                                   'ALERT',
                                   'PK_BACKOFFICE',
                                   'SET_INTF_PROF_INST_STATE');
                pk_utils.undo_changes;
                l_ret := pk_alert_exceptions.process_error(l_error_in, o_error);
                pk_alert_exceptions.reset_error_state;
                RETURN FALSE;
            END;
        
    END set_intf_prof_inst_state;
    /************************************************************************************************************ 
    * Returns the professional name formated
    *
    * @param      i_id_prof            Profissional type
    *
    * @return     Professional Name Formated
    * @author     RMGM
    * @version    2.6.0.5
    * @since      2012/01/11
    ***********************************************************************************************************/
    FUNCTION get_prof_name_formated
    (
        i_prof           IN table_number,
        i_id_institution IN institution.id_institution%TYPE
    ) RETURN table_varchar IS
    
        l_config     sys_config.id_sys_config%TYPE := 'PROF_NAME_PATTERN';
        l_mkt_config sys_config.value%TYPE;
    
        t_name  table_varchar;
        o_error t_error_out;
    BEGIN
        --g_func_name  := upper('get_prof_name_formated');
        g_error      := 'GET SYSTEM CONFIGURATION' || l_config;
        l_mkt_config := pk_sysconfig.get_config(l_config, profissional(0, i_id_institution, 0));
    
        g_error := 'GET FORMATED NAME';
        SELECT REPLACE(TRIM(regexp_replace(TRIM(regexp_replace(TRIM(regexp_replace(v_prof.prof_name,
                                                                                   '(.*) (.*) (.*) (.*)',
                                                                                   TRIM(l_mkt_config))),
                                                               '(\A,)|(,\Z)')),
                                           '(, ,)',
                                           ',')),
                       '|',
                       ' ') formated_name
          BULK COLLECT
          INTO t_name
          FROM (SELECT REPLACE(TRIM(p.first_name), ' ', '|') || ' ' || REPLACE(TRIM(p.parent_name), ' ', '|') || ' ' ||
                       REPLACE(TRIM(p.middle_name), ' ', '|') || ' ' || REPLACE(TRIM(p.last_name), ' ', '|') prof_name
                  FROM professional p
                 WHERE p.id_professional IN (SELECT column_value
                                               FROM TABLE(CAST(i_prof AS table_number)))
                   AND p.first_name IS NOT NULL
                 ORDER BY p.id_professional DESC) v_prof;
    
        RETURN t_name;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(1,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'get_prof_name_formated',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN NULL;
    END get_prof_name_formated;
    /************************************************************************************************************ 
    * Returns True or False
    *
    * @param       i_lang                     Log Language
    * @param      i_id_professional     Professional id (if null update all in the institution)
    * @param      i_id_institution      Institution Id (mandatory)
    * @param      o_profs               output cursor with professional ids
    * @param      o_error               error
    *
    * @return     Boolean 1-true; 2-false;
    * @author     RMGM
    * @version    2.6.0.5
    * @since      2012/01/11
    ***********************************************************************************************************/
    FUNCTION set_prof_name_formated
    (
        i_lang            IN language.id_language%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        i_id_institution  IN institution.id_institution%TYPE,
        o_profs           OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
        l_name_format professional.name%TYPE;
    
        l_profs_array      table_number := table_number();
        l_profs_name_array table_varchar := table_varchar();
        l_index            NUMBER := 1;
    
        CURSOR c_prof_inst IS
            SELECT p.id_professional
              FROM professional p
             INNER JOIN prof_institution pi
                ON (pi.id_professional = p.id_professional AND pi.flg_state = 'A' AND pi.dt_end_tstz IS NULL)
             WHERE pi.id_institution = i_id_institution
               AND p.first_name IS NOT NULL
             ORDER BY p.id_professional DESC;
    BEGIN
        --g_func_name  := upper('set_prof_name_formated');
        IF (i_id_professional IS NOT NULL OR i_id_professional != 0)
        THEN
            l_profs_array.extend;
            l_profs_array(l_index) := i_id_professional;
        
            l_profs_name_array := get_prof_name_formated(l_profs_array, i_id_institution);
        
            g_error := 'UPDATE PROFESSIONAL' || i_id_professional;
            FORALL i IN 1 .. l_profs_array.count
                UPDATE professional p
                   SET p.name = nvl(l_profs_name_array(i), p.name)
                 WHERE p.id_professional = l_profs_array(i)
                   AND p.first_name IS NOT NULL
                   AND EXISTS (SELECT 0
                          FROM prof_institution pi
                         WHERE pi.id_professional = p.id_professional
                           AND pi.id_institution = i_id_institution
                           AND pi.flg_state = 'A'
                           AND pi.dt_end_tstz IS NULL
                           AND rownum = 1);
        
        ELSE
            g_error := 'GET PROFESSIONAL LIST';
            OPEN c_prof_inst;
            FETCH c_prof_inst BULK COLLECT
                INTO l_profs_array;
        
            l_profs_name_array := get_prof_name_formated(l_profs_array, i_id_institution);
            g_error            := 'UPDATE ALL INSTITUTION PROFESSIONALS';
            FORALL j IN 1 .. l_profs_array.count
                UPDATE professional p
                   SET p.name = nvl(l_profs_name_array(j), p.name)
                 WHERE p.id_professional = l_profs_array(j);
            g_error := 'CLOSE CURSOR';
            CLOSE c_prof_inst;
        END IF;
        g_error := 'OUTPUT CURSOR';
        OPEN o_profs FOR
            SELECT column_value
              FROM TABLE(CAST(l_profs_array AS table_number));
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'set_prof_name_formated',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END set_prof_name_formated;
    /************************************************************************************************************ 
    * Returns Formated complete name according to configured pattern in institution
    *
    * @param       i_lang                     Log Language
    * @param      i_id_institution      Institution Id (mandatory)
    * @param      i_first_name           first name
    * @param      i_midle_name           first name
    * @param      i_last_name           last name
    * @param      o_error               error
    *
    * @return     Formated complete name
    * @author     RMGM
    * @version    2.6.0.5
    * @since      2012/01/11
    ***********************************************************************************************************/
    FUNCTION create_name_formated
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        i_first_name     IN professional.first_name%TYPE,
        i_parent_name    IN professional.parent_name%TYPE,
        i_midle_name     IN professional.middle_name%TYPE,
        i_last_name      IN professional.last_name%TYPE
    ) RETURN VARCHAR2 IS
        k_config       CONSTANT VARCHAR2(0050 CHAR) := 'PROF_NAME_PATTERN';
        k_filling_mask CONSTANT VARCHAR2(0010 CHAR) := '*****';
        k_sp           CONSTANT VARCHAR2(0010 CHAR) := chr(32);
    
        l_name       professional.name%TYPE;
        format_name  professional.name%TYPE;
        l_mkt_config sys_config.value%TYPE;
    
        -- exception and error proccess
        l_exception EXCEPTION;
        o_error t_error_out;
    
        l_first_name  professional.first_name%TYPE;
        l_parent_name professional.parent_name%TYPE;
        l_midle_name  professional.middle_name%TYPE;
        l_last_name   professional.last_name%TYPE;
    
    BEGIN
    
        IF (i_first_name IS NOT NULL AND i_id_institution IS NOT NULL)
        THEN
        
            l_first_name  := nvl(REPLACE(i_first_name, k_sp, k_filling_mask), k_filling_mask);
            l_parent_name := nvl(REPLACE(i_parent_name, k_sp, k_filling_mask), k_filling_mask);
            l_midle_name  := nvl(REPLACE(i_midle_name, k_sp, k_filling_mask), k_filling_mask);
            l_last_name   := nvl(REPLACE(i_last_name, k_sp, k_filling_mask), k_filling_mask);
        
            l_mkt_config := pk_sysconfig.get_config(k_config, profissional(0, i_id_institution, 0));
        
            l_name      := regexp_replace(TRIM(REPLACE(TRIM(l_first_name), k_sp, '|') || k_sp ||
                                               REPLACE(TRIM(nvl(l_parent_name, k_sp)), k_sp, '|') || k_sp ||
                                               REPLACE(TRIM(nvl(l_midle_name, k_sp)), k_sp, '|') || k_sp ||
                                               REPLACE(TRIM(l_last_name), k_sp, '|')),
                                          k_sp || k_sp,
                                          k_sp);
            format_name := REPLACE(TRIM(regexp_replace(TRIM(regexp_replace(TRIM(regexp_replace(l_name,
                                                                                               '(.*) (.*) (.*) (.*)',
                                                                                               TRIM(l_mkt_config))),
                                                                           '(\A,)|(,\Z)')),
                                                       '(, ,)',
                                                       ',')),
                                   '|',
                                   k_sp);
        
            format_name := regexp_replace(regexp_replace(format_name, '\*{1,}', k_sp), '\s{1,}', k_sp);
        ELSE
            g_error := 'Please Fill First Name (Mandatory) and the Institution to execute the pattern format';
            RAISE l_exception;
        END IF;
    
        RETURN format_name;
    
    EXCEPTION
        WHEN l_exception THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'create_name_formated',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN NULL;
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'create_name_formated',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN NULL;
    END create_name_formated;
    /********************************************************************************************
    * Get Professional CAB CONV (FR Market)
    *
    * @param i_lang                Preferred language ID
    * @param i_prof                Professional Data Type
    *
    * @return                      String with Identifier
    * 
    *
    * @author                      RMGM
    * @version                     0.1
    * @since                       2012/09/18
    ********************************************************************************************/
    FUNCTION get_cab_conv_id
    (
        i_lang IN language.id_language%TYPE,
        i_prof IN profissional
    ) RETURN VARCHAR2 IS
        l_id_category prof_cat.id_category%TYPE;
    
        l_cab_id  prof_accounts.id_account%TYPE := 69;
        l_conv_id prof_accounts.id_account%TYPE := 74;
        l_zsid_id prof_accounts.id_account%TYPE := 75;
        l_zik_id  prof_accounts.id_account%TYPE := 76;
        l_spec_id prof_accounts.id_account%TYPE := 77;
    
        l_cab_val  prof_accounts.value%TYPE;
        l_conv_val prof_accounts.value%TYPE;
        l_zsid_val prof_accounts.value%TYPE;
        l_zik_val  prof_accounts.value%TYPE;
        l_spec_val prof_accounts.value%TYPE;
    
        l_val_exception EXCEPTION;
        l_error_out t_error_out;
    
        l_cab_conv_id prof_accounts.value%TYPE;
    BEGIN
        g_error := 'GET PROFESSIONAL CATEGORY: ID_PROFESSIONAL = ' || i_prof.id;
        SELECT nvl((SELECT pcat.id_category
                     FROM prof_cat pcat
                    WHERE pcat.id_professional = i_prof.id
                      AND pcat.id_institution = i_prof.institution),
                   0)
          INTO l_id_category
          FROM dual;
        IF l_id_category != 0
        THEN
            g_error := 'GET PROFESSIONAL CAB: ID_PROFESSIONAL = ' || i_prof.id;
            SELECT nvl((SELECT pa.value
                         FROM prof_accounts pa
                        WHERE pa.id_professional = i_prof.id
                          AND pa.id_account = l_cab_id),
                       -100)
              INTO l_cab_val
              FROM dual;
            IF (l_cab_val = -100 OR length(l_conv_val) > 2)
            THEN
                RAISE l_val_exception;
            END IF;
            g_error := 'GET PROFESSIONAL CONV: ID_PROFESSIONAL = ' || i_prof.id;
            SELECT nvl((SELECT pa.value
                         FROM prof_accounts pa
                        WHERE pa.id_professional = i_prof.id
                          AND pa.id_account = l_conv_id),
                       -100)
              INTO l_conv_val
              FROM dual;
            IF (l_conv_val = -100 OR length(l_conv_val) > 2)
            THEN
                RAISE l_val_exception;
            END IF;
            g_error := 'GET PROFESSIONAL ZSID: ID_PROFESSIONAL = ' || i_prof.id;
            SELECT nvl((SELECT pa.value
                         FROM prof_accounts pa
                        WHERE pa.id_professional = i_prof.id
                          AND pa.id_account = l_zsid_id),
                       -100)
              INTO l_zsid_val
              FROM dual;
            IF (l_zsid_val = -100 OR length(l_zsid_val) > 2)
            THEN
                RAISE l_val_exception;
            END IF;
            g_error := 'GET PROFESSIONAL ZIK: ID_PROFESSIONAL = ' || i_prof.id;
            SELECT nvl((SELECT pa.value
                         FROM prof_accounts pa
                        WHERE pa.id_professional = i_prof.id
                          AND pa.id_account = l_zik_id),
                       -100)
              INTO l_zik_val
              FROM dual;
            IF (l_zik_val = -100 OR length(l_zik_val) > 2)
            THEN
                RAISE l_val_exception;
            END IF;
            g_error := 'GET PROFESSIONAL SPEC: ID_PROFESSIONAL = ' || i_prof.id;
            SELECT nvl((SELECT pa.value
                         FROM prof_accounts pa
                        WHERE pa.id_professional = i_prof.id
                          AND pa.id_account = l_spec_id),
                       -100)
              INTO l_spec_val
              FROM dual;
            IF (l_spec_val = -100 OR length(l_spec_val) > 2)
            THEN
                RAISE l_val_exception;
            END IF;
        END IF;
        l_cab_conv_id := l_cab_val || l_conv_val || l_zsid_val || l_zik_val || l_spec_val;
        RETURN l_cab_conv_id;
    EXCEPTION
        WHEN l_val_exception THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_API_BACKOFFICE',
                                              'GET_CAB_CONV_ID',
                                              l_error_out);
        
            pk_alert_exceptions.reset_error_state;
            RETURN NULL;
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_API_BACKOFFICE',
                                              'GET_CAB_CONV_ID',
                                              l_error_out);
        
            pk_alert_exceptions.reset_error_state;
            RETURN NULL;
    END get_cab_conv_id;
    -- Get Domains desc from a string
    FUNCTION get_domain_desc_str
    (
        i_code_domain IN sys_domain.code_domain%TYPE,
        i_value       IN prof_accounts.value%TYPE,
        i_lang        IN language.id_language%TYPE
    ) RETURN VARCHAR2 IS
        l_val_tbl  table_varchar := table_varchar();
        l_desc_tbl table_varchar := table_varchar();
        l_out_srt  VARCHAR2(1000) := '';
    BEGIN
        -- convert  strings into a table of values
        SELECT pk_utils.str_split_c(i_value, '|')
          INTO l_val_tbl
          FROM dual;
    
        SELECT pk_sysdomain.get_domain(i_code_domain, val_id.column_value, i_lang)
          BULK COLLECT
          INTO l_desc_tbl
          FROM TABLE(CAST(l_val_tbl AS table_varchar)) val_id;
    
        l_out_srt := pk_utils.concat_table(l_desc_tbl, ', ');
    
        RETURN l_out_srt;
    END get_domain_desc_str;
    /************************************************************************************************************ 
    * Returns True or False
    *
    * @param       i_lang                     Log Language
    * @param      i_id_department             Service ID
    * @param      i_floors_institution        Floors Institution to relate to service array
    * @param      i_change                    Array indexed to floors_institution showing if we remove or add association
    * @param      o_error                     error
    *
    * @return     Boolean 1-true; 0-false;
    * @author     RMGM
    * @version    2.6.3
    * @since      2013/02/26
    ***********************************************************************************************************/

    FUNCTION set_department_floors
    (
        i_lang                 IN language.id_language%TYPE,
        i_id_department        IN department.id_department%TYPE,
        i_floors_institution   IN table_number,
        i_change               IN table_varchar,
        o_id_floors_department OUT table_number,
        o_error                OUT t_error_out
    ) RETURN BOOLEAN IS
        l_id_floors_department floors_department.id_floors_department%TYPE;
        tbl_floors             table_number := table_number();
    BEGIN
    
        FOR i IN 1 .. i_floors_institution.count
        LOOP
            IF i_change(i) = 'Y'
            THEN
                g_error                := 'GET NEXT ID';
                l_id_floors_department := seq_floors_department.nextval;
            
                g_error := 'INSERT INTO FLOORS_DEPARTMENT';
                INSERT INTO floors_department
                    (id_floors_department, id_department, flg_available, id_floors_institution)
                VALUES
                    (l_id_floors_department, i_id_department, pk_alert_constant.g_available, i_floors_institution(i));
            ELSE
                g_error := 'DELETE FROM FLOORS_DEP_POSITION';
                DELETE FROM floors_dep_position fdp
                 WHERE fdp.id_floors_department IN
                       (SELECT fd.id_floors_department
                          FROM floors_department fd
                         WHERE fd.id_department = i_id_department
                           AND fd.id_floors_institution = i_floors_institution(i));
            
                g_error := 'UPDATE ROOM FLOOR';
                UPDATE room r
                   SET r.id_floors_department = NULL
                 WHERE r.id_floors_department IN
                       (SELECT fd.id_floors_department
                          FROM floors_department fd
                         WHERE fd.id_department = i_id_department
                           AND fd.id_floors_institution = i_floors_institution(i));
            
                g_error := 'DELETE FROM ROOM_DEP_POSITION';
                DELETE FROM room_dep_position rdp
                 WHERE rdp.id_room IN
                       (SELECT r.id_room
                          FROM room r
                         WHERE r.id_floors_department IN
                               (SELECT fd.id_floors_department
                                  FROM floors_department fd
                                 WHERE fd.id_department = i_id_department
                                   AND fd.id_floors_institution = i_floors_institution(i)));
            
                g_error := 'DELETE FROM FLOORS_DEPARTMENT';
                DELETE FROM floors_department fd
                 WHERE fd.id_department = i_id_department
                   AND fd.id_floors_institution = i_floors_institution(i)
                RETURNING id_floors_department INTO l_id_floors_department;
            END IF;
        
            tbl_floors.extend();
            tbl_floors(tbl_floors.count) := l_id_floors_department;
        
        END LOOP;
    
        o_id_floors_department := tbl_floors;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_DEPARTMENT_FLOORS',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END set_department_floors;

    FUNCTION set_department_floors
    (
        i_lang               IN language.id_language%TYPE,
        i_id_department      IN department.id_department%TYPE,
        i_floors_institution IN table_number,
        i_change             IN table_varchar,
        o_error              OUT t_error_out
    ) RETURN BOOLEAN IS
        l_id_floors_department table_number := table_number();
    BEGIN
    
        RETURN set_department_floors(i_lang                 => i_lang,
                                     i_id_department        => i_id_department,
                                     i_floors_institution   => i_floors_institution,
                                     i_change               => i_change,
                                     o_id_floors_department => l_id_floors_department,
                                     o_error                => o_error);
    
    END set_department_floors;
    /*********************************************************************************************
    * Get decoded description for professional title
    *
    * @param i_lang                     Aplication language ID
    * @param i_title                    Professional Title recorded value   
    *
    * @return                           Decoded description
    *
    * @author                           RMGM
    * @version                          2.5.2.7
    * @since                            2013/01/18
    ********************************************************************************************/
    FUNCTION get_prof_title_desc
    (
        i_lang  IN language.id_language%TYPE,
        i_title IN professional.title%TYPE
    ) RETURN VARCHAR2 IS
        l_code_title sys_domain.code_domain%TYPE := 'PROFESSIONAL.TITLE';
        l_o_title    professional.title%TYPE;
    BEGIN
        SELECT nvl(pk_sysdomain.get_domain(l_code_title, i_title, i_lang), i_title)
          INTO l_o_title
          FROM dual;
        RETURN l_o_title;
    END get_prof_title_desc;

    /********************************************************************************************
    * Set Professional BR Fields (SBIS)
    *
    * @param i_lang             Preferred language ID
    * @param i_id_professional  Professional ID
    * @param i_institution      Institution ID's
    * @param i_accounts         Affiliations ID's
    * @param i_values           Affiliations Values
    * @param o_error            Error
    *
    * @return                   true or false on success or error
    *
    *
    * @author                   RMGM
    * @version                  0.1
    * @since                    2013/11/12
    ********************************************************************************************/
    FUNCTION set_professional_br
    (
        i_lang               IN language.id_language%TYPE,
        i_id_prof            IN professional.id_professional%TYPE,
        i_id_cpf             IN professional.id_cpf%TYPE,
        i_id_cns             IN professional.id_cns%TYPE,
        i_mother_name        IN professional.mother_name%TYPE,
        i_father_name        IN professional.father_name%TYPE,
        i_id_gstate_birth    IN professional.id_geo_state_birth%TYPE,
        i_id_city_birth      IN professional.id_district_birth%TYPE,
        i_code_race          IN professional.code_race%TYPE,
        i_code_school        IN professional.code_scoolarship%TYPE,
        i_flg_in_school      IN professional.flg_in_school%TYPE,
        i_code_logr          IN professional.code_logr_type%TYPE,
        i_door_num           IN professional.door_number%TYPE,
        i_address_ext        IN professional.address_extension%TYPE,
        i_id_gstate_adress   IN professional.id_geo_state_adress%TYPE,
        i_id_city_adress     IN professional.id_district_adress%TYPE,
        i_adress_area        IN professional.adress_area%TYPE,
        i_code_banq          IN professional.code_banq%TYPE,
        i_desc_agency        IN professional.desc_banq_ag%TYPE,
        i_banq_account       IN professional.id_banq_account%TYPE,
        i_code_certif        IN professional.code_certificate%TYPE,
        i_balcon_certif      IN professional.desc_balcony%TYPE,
        i_book_certif        IN professional.desc_book%TYPE,
        i_page_certif        IN professional.desc_page%TYPE,
        i_term_certif        IN professional.desc_term%TYPE,
        i_date_certif        IN VARCHAR2,
        i_id_document        IN professional.id_document%TYPE,
        i_balcon_doc         IN professional.code_emitant_cert%TYPE,
        i_id_gstate_doc      IN professional.id_geo_state_doc%TYPE,
        i_date_doc           IN VARCHAR2,
        i_code_crm           IN professional.code_emitant_crm%TYPE,
        i_id_gstate_crm      IN professional.id_geo_state_crm%TYPE,
        i_code_family_status IN professional.code_family_status%TYPE,
        i_code_doc_type      IN professional.code_doc_type%TYPE,
        i_prof_ocp           IN professional.id_prof_formation%TYPE,
        i_other_doc_desc     IN professional.other_doc_desc%TYPE,
        i_healht_plan        IN professional.id_health_plan%TYPE,
        o_error              OUT t_error_out
    ) RETURN BOOLEAN IS
        l_exception EXCEPTION;
        -- ALERT-308439
        l_hist_op  professional_hist.id_operation%TYPE := 0;
        l_rows_upd table_varchar := table_varchar();
    BEGIN
        g_error := 'UPDATE PROFESSIONAL BR FIELDS ' || i_id_prof;
        UPDATE professional p_br
           SET p_br.id_cpf              = i_id_cpf,
               p_br.id_cns              = i_id_cns,
               p_br.mother_name         = i_mother_name,
               p_br.father_name         = i_father_name,
               p_br.id_geo_state_birth  = i_id_gstate_birth,
               p_br.id_district_birth   = i_id_city_birth,
               p_br.code_race           = i_code_race,
               p_br.code_scoolarship    = i_code_school,
               p_br.flg_in_school       = i_flg_in_school,
               p_br.code_logr_type      = i_code_logr,
               p_br.door_number         = i_door_num,
               p_br.address_extension   = i_address_ext,
               p_br.id_geo_state_adress = i_id_gstate_adress,
               p_br.id_district_adress  = i_id_city_adress,
               p_br.adress_area         = i_adress_area,
               p_br.code_banq           = i_code_banq,
               p_br.desc_banq_ag        = i_desc_agency,
               p_br.id_banq_account     = i_banq_account,
               p_br.code_certificate    = i_code_certif,
               p_br.desc_balcony        = i_balcon_certif,
               p_br.desc_book           = i_book_certif,
               p_br.desc_page           = i_page_certif,
               p_br.desc_term           = i_term_certif,
               p_br.dt_emission_cert    = get_date_received(i_lang, i_date_certif),
               p_br.id_document         = i_id_document,
               p_br.code_emitant_cert   = i_balcon_doc,
               p_br.id_geo_state_doc    = i_id_gstate_doc,
               p_br.dt_emission_id      = get_date_received(i_lang, i_date_doc),
               p_br.code_emitant_crm    = i_code_crm,
               p_br.id_geo_state_crm    = i_id_gstate_crm,
               p_br.code_family_status  = i_code_family_status,
               p_br.code_doc_type       = i_code_doc_type,
               p_br.id_prof_formation   = i_prof_ocp,
               p_br.other_doc_desc      = i_other_doc_desc,
               p_br.id_health_plan      = i_healht_plan
         WHERE p_br.id_professional = i_id_prof;
    
        l_hist_op := get_prof_hist_pk(i_id_prof);
        IF l_hist_op > 0
        THEN
            ts_professional_hist.upd(id_operation_in         => l_hist_op,
                                     id_cpf_in               => i_id_cpf,
                                     id_cns_in               => i_id_cns,
                                     id_cns_nin              => FALSE,
                                     mother_name_in          => i_mother_name,
                                     mother_name_nin         => FALSE,
                                     father_name_in          => i_father_name,
                                     father_name_nin         => FALSE,
                                     id_geo_state_birth_in   => i_id_gstate_birth,
                                     id_geo_state_birth_nin  => FALSE,
                                     id_district_birth_in    => i_id_city_birth,
                                     id_district_birth_nin   => FALSE,
                                     code_race_in            => i_code_race,
                                     code_race_nin           => FALSE,
                                     code_scoolarship_in     => i_code_school,
                                     code_scoolarship_nin    => FALSE,
                                     flg_in_school_in        => i_flg_in_school,
                                     flg_in_school_nin       => FALSE,
                                     code_logr_type_in       => i_code_logr,
                                     code_logr_type_nin      => FALSE,
                                     door_number_in          => i_door_num,
                                     door_number_nin         => FALSE,
                                     address_extension_in    => i_address_ext,
                                     address_extension_nin   => FALSE,
                                     id_geo_state_adress_in  => i_id_gstate_adress,
                                     id_geo_state_adress_nin => FALSE,
                                     id_district_adress_in   => i_id_city_adress,
                                     id_district_adress_nin  => FALSE,
                                     adress_area_in          => i_adress_area,
                                     adress_area_nin         => FALSE,
                                     code_banq_in            => i_code_banq,
                                     code_banq_nin           => FALSE,
                                     desc_banq_ag_in         => i_desc_agency,
                                     desc_banq_ag_nin        => FALSE,
                                     id_banq_account_in      => i_banq_account,
                                     id_banq_account_nin     => FALSE,
                                     code_certificate_in     => i_code_certif,
                                     code_certificate_nin    => FALSE,
                                     desc_balcony_in         => i_balcon_certif,
                                     desc_balcony_nin        => FALSE,
                                     desc_book_in            => i_book_certif,
                                     desc_book_nin           => FALSE,
                                     desc_page_in            => i_page_certif,
                                     desc_page_nin           => FALSE,
                                     desc_term_in            => i_term_certif,
                                     dt_emission_cert_in     => get_date_received(i_lang, i_date_certif),
                                     dt_emission_cert_nin    => FALSE,
                                     id_document_in          => i_id_document,
                                     id_document_nin         => FALSE,
                                     code_emitant_cert_in    => i_balcon_doc,
                                     code_emitant_cert_nin   => FALSE,
                                     id_geo_state_doc_in     => i_id_gstate_doc,
                                     id_geo_state_doc_nin    => FALSE,
                                     dt_emission_id_in       => get_date_received(i_lang, i_date_doc),
                                     dt_emission_id_nin      => FALSE,
                                     code_emitant_crm_in     => i_code_crm,
                                     code_emitant_crm_nin    => FALSE,
                                     id_geo_state_crm_in     => i_id_gstate_crm,
                                     id_geo_state_crm_nin    => FALSE,
                                     code_family_status_in   => i_code_family_status,
                                     code_family_status_nin  => FALSE,
                                     code_doc_type_in        => i_code_doc_type,
                                     code_doc_type_nin       => FALSE,
                                     id_prof_formation_in    => i_prof_ocp,
                                     id_prof_formation_nin   => FALSE,
                                     other_doc_desc_in       => i_other_doc_desc,
                                     other_doc_desc_nin      => FALSE,
                                     id_health_plan_in       => i_healht_plan,
                                     id_health_plan_nin      => FALSE,
                                     rows_out                => l_rows_upd);
        END IF;
        IF SQL%ROWCOUNT = 0
        THEN
            g_error := 'INSERT PROFESSIONAL RECORD FIRST FOR ' || i_id_prof;
            RAISE l_exception;
        END IF;
        RETURN TRUE;
    EXCEPTION
        WHEN l_exception THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_PROFESSIONAL_BR',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_PROFESSIONAL_BR',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END set_professional_br;
    /********************************************************************************************
    * Get Professional BR Fields (SBIS)
    *
    * @param i_lang             Preferred language ID
    * @param i_id_professional  Professional ID
    * @param i_institution      Institution ID's
    * @param i_accounts         Affiliations ID's
    * @param i_values           Affiliations Values
    * @param o_error            Error
    *
    * @return                   true or false on success or error
    *
    *
    * @author                   RMGM
    * @version                  0.1
    * @since                    2013/11/12
    ********************************************************************************************/
    FUNCTION get_professional_br
    (
        i_lang            IN language.id_language%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        i_id_institution  IN institution.id_institution%TYPE,
        o_prof_br         OUT pk_types.cursor_type,
        o_prof_inst_br    OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
        l_code_race   sys_domain.code_domain%TYPE := 'PATIENT.FLG_RACE';
        l_code_school sys_domain.code_domain%TYPE := 'PROFESSIONAL.SCOLARSHIP';
        l_code_yesno  sys_domain.code_domain%TYPE := 'YES_NO';
        l_code_logr   sys_domain.code_domain%TYPE := 'PROFESSIONAL.STREET_TYPE';
        l_code_banq   sys_domain.code_domain%TYPE := 'PROFESSIONAL.BANK_CODE';
    
        l_code_entity    sys_domain.code_domain%TYPE := 'PROFESSIONAL.EMITING_ENTITY';
        l_code_certif    sys_domain.code_domain%TYPE := 'PROFESSIONAL.CERTIFICATE_TYPE';
        l_code_famstatus sys_domain.code_domain%TYPE := 'PROFESSIONAL.FAMILY_STATUS';
        l_code_doc_type  sys_domain.code_domain%TYPE := 'PROFESSIONAL.DOC_TYPE';
        --
        l_code_bond        sys_domain.code_domain%TYPE := 'PROFESSIONAL.BOND';
        l_code_bondtype    sys_domain.code_domain%TYPE := 'PROFESSIONAL.BOND_TYPE';
        l_code_bondsubtype sys_domain.code_domain%TYPE := 'PROFESSIONAL.BOND_SUBTYPE';
        l_id_market        market.id_market%TYPE := 0;
    BEGIN
        g_error     := 'GET MARKET FOR INSTITUTION ' || i_id_institution;
        l_id_market := pk_utils.get_institution_market(i_lang, i_id_institution);
        IF l_id_market = 3
        THEN
            g_error := 'GET PROFESSIONAL (BR) DATA ' || i_id_professional;
            OPEN o_prof_br FOR
                SELECT p_br.id_professional,
                       p_br.id_cpf,
                       p_br.id_cns,
                       p_br.mother_name,
                       p_br.father_name,
                       p_br.id_geo_state_birth,
                       (SELECT pk_translation.get_translation(i_lang, rc.code_rb_regional_classifier)
                          FROM rb_regional_classifier rc
                         WHERE rc.id_rb_regional_classifier = p_br.id_geo_state_birth) geo_state_birth_desc,
                       (SELECT rc.reg_classifier_abbreviation
                          FROM rb_regional_classifier rc
                         WHERE rc.id_rb_regional_classifier = p_br.id_geo_state_birth) geo_state_birth_code,
                       p_br.id_district_birth,
                       (SELECT pk_translation.get_translation(i_lang, rc.code_rb_regional_classifier)
                          FROM rb_regional_classifier rc
                         WHERE rc.id_rb_regional_classifier = p_br.id_district_birth) district_birth_desc,
                       (SELECT rc.reg_classifier_code
                          FROM rb_regional_classifier rc
                         WHERE rc.id_rb_regional_classifier = p_br.id_district_birth) district_birth_code,
                       p_br.code_race,
                       (pk_sysdomain.get_domain(l_code_race, p_br.code_race, i_lang)) race_desc,
                       p_br.code_scoolarship,
                       (pk_sysdomain.get_domain(l_code_school, p_br.code_scoolarship, i_lang)) schoolarship_desc,
                       p_br.flg_in_school,
                       (pk_sysdomain.get_domain(l_code_yesno, p_br.flg_in_school, i_lang)) flg_in_school_desc,
                       p_br.code_logr_type,
                       (pk_sysdomain.get_domain(l_code_logr, p_br.code_logr_type, i_lang)) logr_type_desc,
                       p_br.door_number,
                       p_br.address_extension,
                       p_br.id_geo_state_adress,
                       (SELECT pk_translation.get_translation(i_lang, rc.code_rb_regional_classifier)
                          FROM rb_regional_classifier rc
                         WHERE rc.id_rb_regional_classifier = p_br.id_geo_state_adress) geo_state_adress_desc,
                       (SELECT rc.reg_classifier_abbreviation
                          FROM rb_regional_classifier rc
                         WHERE rc.id_rb_regional_classifier = p_br.id_geo_state_adress) geo_state_adress_code,
                       p_br.id_district_adress,
                       (SELECT pk_translation.get_translation(i_lang, rc.code_rb_regional_classifier)
                          FROM rb_regional_classifier rc
                         WHERE rc.id_rb_regional_classifier = p_br.id_district_adress) district_adress_desc,
                       (SELECT rc.reg_classifier_code
                          FROM rb_regional_classifier rc
                         WHERE rc.id_rb_regional_classifier = p_br.id_district_adress) district_adress_code,
                       p_br.adress_area,
                       p_br.code_banq,
                       (pk_sysdomain.get_domain(l_code_banq, p_br.code_banq, i_lang)) banq_desc,
                       p_br.desc_banq_ag,
                       p_br.id_banq_account,
                       p_br.code_certificate,
                       (pk_sysdomain.get_domain(l_code_certif, p_br.code_certificate, i_lang)) certificate_desc,
                       p_br.desc_balcony,
                       p_br.desc_book,
                       p_br.desc_page,
                       p_br.desc_term,
                       get_date_to_be_sent(i_lang, p_br.dt_emission_cert) dt_emission_cert,
                       pk_date_utils.dt_chr(i_lang, p_br.dt_emission_cert, profissional(0, i_id_institution, 0)) string_dt_certif,
                       p_br.id_document,
                       p_br.code_emitant_cert,
                       (pk_sysdomain.get_domain(l_code_entity, p_br.code_emitant_cert, i_lang)) emitant_desc,
                       p_br.id_geo_state_doc,
                       (SELECT pk_translation.get_translation(i_lang, rc.code_rb_regional_classifier)
                          FROM rb_regional_classifier rc
                         WHERE rc.id_rb_regional_classifier = p_br.id_geo_state_doc) geo_state_doc_desc,
                       (SELECT rc.reg_classifier_abbreviation
                          FROM rb_regional_classifier rc
                         WHERE rc.id_rb_regional_classifier = p_br.id_geo_state_doc) geo_state_doc_code,
                       get_date_to_be_sent(i_lang, p_br.dt_emission_id) dt_emission_id,
                       pk_date_utils.dt_chr(i_lang, p_br.dt_emission_id, profissional(0, i_id_institution, 0)) string_dt_id,
                       p_br.code_emitant_crm,
                       (pk_sysdomain.get_domain(l_code_entity, p_br.code_emitant_crm, i_lang)) crm_desc,
                       p_br.id_geo_state_crm,
                       (SELECT pk_translation.get_translation(i_lang, rc.code_rb_regional_classifier)
                          FROM rb_regional_classifier rc
                         WHERE rc.id_rb_regional_classifier = p_br.id_geo_state_crm) geo_state_crm_desc,
                       (SELECT rc.reg_classifier_abbreviation
                          FROM rb_regional_classifier rc
                         WHERE rc.id_rb_regional_classifier = p_br.id_geo_state_crm) geo_state_crm_code,
                       p_br.code_family_status,
                       (pk_sysdomain.get_domain(l_code_famstatus, p_br.code_family_status, i_lang)) family_status_desc,
                       p_br.code_doc_type,
                       (pk_sysdomain.get_domain(l_code_doc_type, p_br.code_doc_type, i_lang)) doc_type_desc,
                       p_br.id_prof_formation,
                       (SELECT pk_translation.get_translation(i_lang, o.code_occupation)
                          FROM occupation o
                         WHERE o.id_occupation = p_br.id_prof_formation) prof_formation_desc,
                       p_br.other_doc_desc,
                       p_br.id_health_plan health_plan_id,
                       (SELECT pk_translation.get_translation(i_lang, hp.code_health_plan)
                          FROM health_plan hp
                         WHERE hp.id_health_plan = p_br.id_health_plan) health_plan_desc,
                       (SELECT hp.id_health_plan_entity
                          FROM health_plan hp
                         WHERE hp.id_health_plan = p_br.id_health_plan) health_plan_entity_id
                  FROM professional p_br
                 WHERE p_br.id_professional = i_id_professional;
        
            g_error := 'GET PROFESSIONAL ' || i_id_professional || ' INSTITUTION ' || i_id_institution || ' DATA ';
            OPEN o_prof_inst_br FOR
                SELECT pi.id_professional_bond,
                       get_bond_subt_id(i_lang, pi.id_professional_bond) bond_subtype_id,
                       get_bond_subt_desc(i_lang, pi.id_professional_bond) bond_subtype_desc,
                       get_bond_type_id(i_lang, pi.id_professional_bond) bond_type_id,
                       get_bond_type_desc(i_lang, pi.id_professional_bond) bond_type_desc,
                       get_bond_id(i_lang, pi.id_professional_bond) bond_id,
                       get_bond_desc(i_lang, pi.id_professional_bond) bond_desc,
                       pi.work_schedule_amb,
                       pi.work_schedule_inp,
                       pi.work_schedule_other,
                       pi.flg_sus_app,
                       (pk_sysdomain.get_domain(l_code_yesno, pi.flg_sus_app, i_lang)) sus_app_desc
                  FROM prof_institution pi
                 WHERE pi.id_professional = i_id_professional
                   AND pi.id_institution = i_id_institution
                   AND pi.flg_state = 'A'
                   AND pi.dt_end_tstz IS NULL;
        ELSE
            RETURN TRUE;
        END IF;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              g_package_owner,
                                              g_package_name,
                                              'GET_PROFESSIONAL_BR',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_professional_br;
    /********************************************************************************************
    * Get Professional BR Fields (SBIS)
    *
    * @param i_lang             Preferred language ID
    * @param i_id_professional  Professional ID
    * @param i_institution      Institution ID's
    * @param i_accounts         Affiliations ID's
    * @param i_values           Affiliations Values
    * @param o_error            Error
    *
    * @return                   true or false on success or error
    *
    *
    * @author                   RMGM
    * @version                  0.1
    * @since                    2013/11/12
    ********************************************************************************************/
    FUNCTION check_prof_br_uk_data
    (
        i_lang            IN language.id_language%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        i_id_cpf          IN professional.id_cpf%TYPE,
        i_id_ident        IN professional.id_document%TYPE,
        i_emitant_id      IN professional.code_emitant_cert%TYPE,
        i_id_gstate_doc   IN professional.id_geo_state_doc%TYPE,
        i_code_crm        IN professional.code_emitant_crm%TYPE,
        i_id_gstate_crm   IN professional.id_geo_state_crm%TYPE,
        i_num_order       IN professional.num_order%TYPE,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
        l_valid_crm NUMBER := 0;
        l_valid_cpf NUMBER := 0;
        l_valid_rg  NUMBER := 0;
        l_existing_data EXCEPTION;
        l_code_entity sys_domain.code_domain%TYPE := 'PROFESSIONAL.EMITING_ENTITY';
    BEGIN
        g_error := 'CRM ' || i_num_order || ':' || pk_sysdomain.get_domain(l_code_entity, i_code_crm, i_lang) || '-' ||
                   pk_translation.get_translation(i_lang,
                                                  'RB_REGIONAL_CLASSIFIER.CODE_RB_REGIONAL_CLASSIFIER.' ||
                                                  i_id_gstate_crm) || ' EM USO';
        SELECT COUNT(*)
          INTO l_valid_crm
          FROM professional p_br
         WHERE p_br.num_order = i_num_order
           AND p_br.id_geo_state_crm = i_id_gstate_crm
           AND p_br.code_emitant_crm = i_code_crm
           AND p_br.id_professional != i_id_professional;
        IF l_valid_crm > 0
        THEN
            RAISE l_existing_data;
        END IF;
        g_error := 'CPF ' || i_id_cpf || ' EM USO';
        SELECT COUNT(*)
          INTO l_valid_cpf
          FROM professional p_br
         WHERE p_br.id_cpf = i_id_cpf
           AND p_br.id_professional != i_id_professional;
        IF l_valid_cpf > 0
        THEN
            RAISE l_existing_data;
        END IF;
        g_error := 'RG ' || i_id_ident || ' EM USO';
        SELECT COUNT(*)
          INTO l_valid_rg
          FROM professional p_br
         WHERE p_br.id_document = i_id_ident
           AND p_br.code_emitant_cert = i_emitant_id
           AND p_br.id_geo_state_doc = i_id_gstate_doc
           AND p_br.id_professional != i_id_professional;
        IF l_valid_rg > 0
        THEN
            RAISE l_existing_data;
        END IF;
        RETURN TRUE;
    EXCEPTION
        WHEN l_existing_data THEN
            pk_alert_exceptions.process_error(i_lang,
                                              'CHECK PROF DATA',
                                              g_error,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'check_prof_br_uk_data',
                                              'U',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END check_prof_br_uk_data;
    /********************************************************************************************
    * Get Professional Bond domain BR Fields (SBIS)
    *
    * @param i_lang             Preferred language ID
    * @param i_prof             Professional array ID
    * @param i_level            Bond level (1 bond, 2 type, 3 subtype)
    * @param i_bond_id          Parent id, null when level = 1
    * @param o_res_list         cursor with ordered results
    * @param o_error            Error
    *
    * @return                   true or false on success or error
    *    
    * @author                   RMGM
    * @version                  0.1
    * @since                    2013/11/14
    ********************************************************************************************/
    FUNCTION get_bond_values
    (
        i_lang     IN language.id_language%TYPE,
        i_prof     IN profissional,
        i_level    IN NUMBER DEFAULT 1,
        i_bond_id  IN NUMBER DEFAULT NULL,
        o_res_list OUT pk_types.cursor_type,
        o_error    OUT t_error_out
    ) RETURN BOOLEAN IS
    
    BEGIN
    
        g_error := 'GET BOND LIST OF VALUES BY PARENT ' || i_bond_id || ' CHILD LEVEL ' || i_level;
        OPEN o_res_list FOR
            SELECT bond_type.id_bond,
                   pk_translation.get_translation(i_lang, bond_type.code_bond) desc_bond,
                   bond_type.ext_code
              FROM (SELECT LEVEL lvl, x.id_bond, x.ext_code, x.code_bond, x.id_bond_parent
                      FROM professional_bond x
                     WHERE x.flg_available = 'Y'
                     START WITH x.id_bond_parent IS NULL
                    CONNECT BY PRIOR x.id_bond = x.id_bond_parent) bond_type
             WHERE bond_type.lvl = nvl(i_level, 1)
               AND (id_bond_parent = i_bond_id OR (i_bond_id IS NULL AND id_bond_parent IS NULL));
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              g_package_owner,
                                              g_package_name,
                                              'get_bond_values',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_bond_values;
    -- desc_bond_subtype
    FUNCTION get_bond_subt_desc
    (
        i_lang       IN language.id_language%TYPE,
        i_id_bond_st IN professional_bond.id_bond%TYPE
    ) RETURN translation.desc_lang_1%TYPE IS
        l_desc_trl translation.desc_lang_1%TYPE := NULL;
        l_level    NUMBER := 0;
    BEGIN
        l_level := get_bond_levels(i_id_bond_st);
        IF l_level > 2
        THEN
            g_error := 'GET BOND SUBTYPE DESCRIPTION ' || i_id_bond_st;
            SELECT pk_translation.get_translation(i_lang, bond_type.code_bond)
              INTO l_desc_trl
              FROM (SELECT LEVEL lvl, pb.id_bond, pb.ext_code, pb.code_bond, pb.id_bond_parent
                      FROM professional_bond pb
                     WHERE pb.flg_available = 'Y'
                     START WITH pb.id_bond = i_id_bond_st
                    CONNECT BY PRIOR pb.id_bond_parent = pb.id_bond) bond_type
             WHERE bond_type.lvl = l_level - 2;
        ELSE
            RETURN NULL;
        END IF;
        RETURN l_desc_trl;
    EXCEPTION
        WHEN OTHERS THEN
            RETURN NULL;
    END get_bond_subt_desc;
    FUNCTION get_bond_subt_id
    (
        i_lang       IN language.id_language%TYPE,
        i_id_bond_st IN professional_bond.id_bond%TYPE
    ) RETURN professional_bond.id_bond%TYPE IS
        l_bond_id professional_bond.id_bond%TYPE := 0;
        l_level   NUMBER := 0;
    BEGIN
        l_level := get_bond_levels(i_id_bond_st);
        IF l_level > 2
        THEN
            g_error := 'GET BOND SUBTYPE DESCRIPTION ' || i_id_bond_st;
            SELECT bond_type.id_bond
              INTO l_bond_id
              FROM (SELECT LEVEL lvl, pb.id_bond, pb.ext_code, pb.code_bond, pb.id_bond_parent
                      FROM professional_bond pb
                     WHERE pb.flg_available = 'Y'
                     START WITH pb.id_bond = i_id_bond_st
                    CONNECT BY PRIOR pb.id_bond_parent = pb.id_bond) bond_type
             WHERE bond_type.lvl = l_level - 2;
        ELSE
            RETURN NULL;
        END IF;
        RETURN l_bond_id;
    EXCEPTION
        WHEN OTHERS THEN
            RETURN NULL;
    END get_bond_subt_id;
    -- desc_bond_type
    FUNCTION get_bond_type_desc
    (
        i_lang       IN language.id_language%TYPE,
        i_id_bond_st IN professional_bond.id_bond%TYPE
    ) RETURN translation.desc_lang_1%TYPE IS
        l_desc_trl translation.desc_lang_1%TYPE := NULL;
        l_level    NUMBER := 0;
    BEGIN
        l_level := get_bond_levels(i_id_bond_st);
        IF l_level > 1
        THEN
            g_error := 'GET BOND TYPE DESCRIPTION ' || i_id_bond_st;
            SELECT pk_translation.get_translation(i_lang, bond_type.code_bond)
              INTO l_desc_trl
              FROM (SELECT LEVEL lvl, pb.id_bond, pb.ext_code, pb.code_bond, pb.id_bond_parent
                      FROM professional_bond pb
                     WHERE pb.flg_available = 'Y'
                     START WITH pb.id_bond = i_id_bond_st
                    CONNECT BY PRIOR pb.id_bond_parent = pb.id_bond) bond_type
             WHERE bond_type.lvl = l_level - 1;
        ELSE
            RETURN NULL;
        END IF;
        RETURN l_desc_trl;
    EXCEPTION
        WHEN OTHERS THEN
            RETURN NULL;
    END get_bond_type_desc;
    FUNCTION get_bond_type_id
    (
        i_lang       IN language.id_language%TYPE,
        i_id_bond_st IN professional_bond.id_bond%TYPE
    ) RETURN professional_bond.id_bond%TYPE IS
        l_bond_id professional_bond.id_bond%TYPE := 0;
        l_level   NUMBER := 0;
    BEGIN
        l_level := get_bond_levels(i_id_bond_st);
        IF l_level > 1
        THEN
            g_error := 'GET BOND TYPE DESCRIPTION ' || i_id_bond_st;
            SELECT bond_type.id_bond
              INTO l_bond_id
              FROM (SELECT LEVEL lvl, pb.id_bond, pb.ext_code, pb.code_bond, pb.id_bond_parent
                      FROM professional_bond pb
                     WHERE pb.flg_available = 'Y'
                     START WITH pb.id_bond = i_id_bond_st
                    CONNECT BY PRIOR pb.id_bond_parent = pb.id_bond) bond_type
             WHERE bond_type.lvl = l_level - 1;
        ELSE
            RETURN NULL;
        END IF;
        RETURN l_bond_id;
    EXCEPTION
        WHEN OTHERS THEN
            RETURN NULL;
    END get_bond_type_id;
    -- desc_bond
    FUNCTION get_bond_desc
    (
        i_lang       IN language.id_language%TYPE,
        i_id_bond_st IN professional_bond.id_bond%TYPE
    ) RETURN translation.desc_lang_1%TYPE IS
        l_desc_trl translation.desc_lang_1%TYPE := NULL;
        l_level    NUMBER := 0;
    BEGIN
        l_level := get_bond_levels(i_id_bond_st);
        g_error := 'GET BOND DESCRIPTION ' || i_id_bond_st;
        SELECT pk_translation.get_translation(i_lang, bond_type.code_bond)
          INTO l_desc_trl
          FROM (SELECT LEVEL lvl, pb.id_bond, pb.ext_code, pb.code_bond, pb.id_bond_parent
                  FROM professional_bond pb
                 WHERE pb.flg_available = 'Y'
                 START WITH pb.id_bond = i_id_bond_st
                CONNECT BY PRIOR pb.id_bond_parent = pb.id_bond) bond_type
         WHERE bond_type.lvl = l_level;
        RETURN l_desc_trl;
    EXCEPTION
        WHEN OTHERS THEN
            RETURN NULL;
    END get_bond_desc;
    FUNCTION get_bond_id
    (
        i_lang       IN language.id_language%TYPE,
        i_id_bond_st IN professional_bond.id_bond%TYPE
    ) RETURN professional_bond.id_bond%TYPE IS
        l_bond_id professional_bond.id_bond%TYPE := 0;
        l_level   NUMBER := 0;
    BEGIN
        l_level := get_bond_levels(i_id_bond_st);
        g_error := 'GET BOND DESCRIPTION ' || i_id_bond_st;
        SELECT bond_type.id_bond
          INTO l_bond_id
          FROM (SELECT LEVEL lvl, pb.id_bond, pb.ext_code, pb.code_bond, pb.id_bond_parent
                  FROM professional_bond pb
                 WHERE pb.flg_available = 'Y'
                 START WITH pb.id_bond = i_id_bond_st
                CONNECT BY PRIOR pb.id_bond_parent = pb.id_bond) bond_type
         WHERE bond_type.lvl = l_level;
        RETURN l_bond_id;
    EXCEPTION
        WHEN OTHERS THEN
            RETURN NULL;
    END get_bond_id;
    --decode levels of stored value
    FUNCTION get_bond_levels(i_last IN professional_bond.id_bond%TYPE) RETURN NUMBER IS
        l_level NUMBER := 0;
    BEGIN
        SELECT nvl(MAX(LEVEL), 0)
          INTO l_level
          FROM professional_bond pb
         WHERE pb.flg_available = 'Y'
         START WITH pb.id_bond = i_last
        CONNECT BY PRIOR pb.id_bond_parent = pb.id_bond;
        RETURN l_level;
    END get_bond_levels;

    FUNCTION check_prof_acount_value
    (
        i_value           IN prof_accounts.value%TYPE,
        i_account         IN prof_accounts.id_account%TYPE,
        i_institution     IN prof_accounts.id_institution%TYPE,
        i_id_professional IN prof_accounts.id_professional%TYPE
    ) RETURN BOOLEAN IS
        l_control_var NUMBER;
    BEGIN
        g_error := 'VALOR ' || i_value || ' NO CAMPO ' ||
                   pk_translation.get_translation(11, 'ACCOUNT.CODE_ACCOUNT.' || i_account);
        SELECT COUNT(1)
          INTO l_control_var
          FROM prof_accounts pa
         WHERE TRIM(upper(pa.value)) = TRIM(upper(i_value))
           AND pa.id_account = i_account
           AND pa.id_professional != i_id_professional
           AND pa.id_institution IN (i_institution, 0);
    
        IF l_control_var = 0
        THEN
            RETURN TRUE;
        ELSE
            RETURN FALSE;
        END IF;
    END check_prof_acount_value;
    /********************************************************************************************
    * Get Professional CBO ID
    *
    * @param i_lang                  Prefered language ID
    * @param i_prof                  Professional Type Identifier
    * @param o_error                 error
    *
    * @return                        CBO code
    *
    * @author                        Rui Gomes
    * @version                       2.5.2.7
    * @since                         2013/01/28
    ********************************************************************************************/
    FUNCTION get_prof_cbo_id
    (
        i_lang  IN language.id_language%TYPE,
        i_prof  IN profissional,
        o_error OUT t_error_out
    ) RETURN VARCHAR2 IS
        l_cbo_code    VARCHAR2(100);
        l_account_ocp accounts.id_account%TYPE := 56;
    
        l_iaccount_res NUMBER;
        l_exception EXCEPTION;
    BEGIN
        g_error := 'GET PROFESSIONAL CBO CODE FOR REPORTS AND MCDT REFERRAL';
    
        SELECT nvl(COUNT(*), 0)
          INTO l_iaccount_res
          FROM prof_accounts pa
         INNER JOIN accounts a
            ON (a.id_account = pa.id_account AND a.flg_available = pk_alert_constant.g_available)
         WHERE pa.id_account = l_account_ocp
           AND pa.id_professional = i_prof.id
           AND pa.id_institution = i_prof.institution;
    
        IF l_iaccount_res > 0
        THEN
        
            SELECT pa.value
              INTO l_cbo_code
              FROM prof_accounts pa
             INNER JOIN accounts a
                ON (a.id_account = pa.id_account AND a.flg_available = pk_alert_constant.g_available)
             WHERE pa.id_account = l_account_ocp
               AND pa.id_professional = i_prof.id
               AND pa.id_institution = i_prof.institution;
        ELSE
            g_error := 'NO CBO DEFINED FOR PROFESSIONAL: ' || i_prof.id;
            RAISE l_exception;
        END IF;
    
        RETURN l_cbo_code;
    EXCEPTION
        WHEN l_exception THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_CBO_ID',
                                              o_error);
            RETURN NULL;
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_CBO_ID',
                                              o_error);
            RETURN NULL;
    END get_prof_cbo_id;
    /********************************************************************************************
    * Get list of responsible professionals in a service context
    *
    * @param i_lang                   Preferred language ID for this professional    
    * @param i_institution            Institution ID
    * @param i_id_professional        Professional ID
    * @param o_prof_id_list           List of professionals ids
    * @param o_prof_desc_list         list of professional names indexed to ids
    * @param o_error                  Error Message ID
    *
    * @return                         true or false
    *
    * @author                         RMGM
    * @version                        2.6.3
    * @since                          2014/02/10
    **********************************************************************************************/
    FUNCTION get_serv_prof_responsible
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        i_id_department  IN department.id_department%TYPE,
        i_flg_type       IN department_resp_prof.flg_type%TYPE,
        o_prof_id_list   OUT table_number,
        o_prof_desc_list OUT table_varchar,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        g_error := 'GET LIST OF RESPONSIBLE PROFESSIONALS IN DEPARTMENT ' || i_id_department;
        SELECT drp.id_professional,
               pk_prof_utils.get_name_signature(i_lang, profissional(0, i_id_institution, 0), drp.id_professional) prof_names
          BULK COLLECT
          INTO o_prof_id_list, o_prof_desc_list
          FROM department_resp_prof drp
         WHERE drp.id_department = i_id_department
           AND drp.flg_type IN ('B', i_flg_type)
           AND EXISTS (SELECT 1
                  FROM prof_institution pi
                 WHERE pi.id_professional = drp.id_professional
                   AND pi.id_institution = i_id_institution
                   AND pi.dt_end_tstz IS NULL
                   AND pi.flg_state = pk_alert_constant.g_active);
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            o_prof_id_list   := table_number();
            o_prof_desc_list := table_varchar();
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE_API_UI',
                                              'GET_SERV_PROF_RESPONSIBLE',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_serv_prof_responsible;
    /********************************************************************************************
    * Set list of responsible professionals in a service context
    *
    * @param i_lang                   Preferred language ID for this professional    
    * @param i_id_department          Service ID
    * @param i_id_professional        Professional ID
    * @param i_prof_id_list           List of professionals ids
    * @param o_error                  Error Message ID
    *
    * @return                         true or false
    *
    * @author                         RMGM
    * @version                        2.6.3
    * @since                          2014/02/10
    **********************************************************************************************/
    FUNCTION set_serv_prof_resp
    (
        i_lang          IN language.id_language%TYPE,
        i_id_department IN department.id_department%TYPE,
        i_prof_id_list  IN table_number,
        i_prof_service  IN table_number,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
        l_exists_prof NUMBER;
    BEGIN
        FOR i IN 1 .. i_prof_id_list.count
        LOOP
            SELECT COUNT(*)
              INTO l_exists_prof
              FROM department_resp_prof
             WHERE id_department = i_id_department
               AND id_professional = i_prof_id_list(i);
        
            IF l_exists_prof = 0
            THEN
                INSERT INTO department_resp_prof
                    (id_department_resp_prof, id_department, id_professional, flg_type)
                VALUES
                    (seq_department_resp_prof.nextval, i_id_department, i_prof_id_list(i), 'C');
            ELSE
                UPDATE department_resp_prof
                   SET flg_type = 'B'
                 WHERE id_department = i_id_department
                   AND id_professional = i_prof_id_list(i);
            END IF;
        END LOOP;
    
        FOR i IN 1 .. i_prof_service.count
        LOOP
            SELECT COUNT(*)
              INTO l_exists_prof
              FROM department_resp_prof
             WHERE id_department = i_id_department
               AND id_professional = i_prof_service(i);
        
            IF l_exists_prof = 0
            THEN
                INSERT INTO department_resp_prof
                    (id_department_resp_prof, id_department, id_professional, flg_type)
                VALUES
                    (seq_department_resp_prof.nextval, i_id_department, i_prof_service(i), 'S');
            ELSE
                UPDATE department_resp_prof
                   SET flg_type = 'B'
                 WHERE id_department = i_id_department
                   AND id_professional = i_prof_service(i);
            END IF;
        END LOOP;
    
        COMMIT;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE_API_UI',
                                              'GET_SERV_PROF_RESPONSIBLE',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            ROLLBACK;
            RETURN FALSE;
    END set_serv_prof_resp;
    /********************************************************************************************
    * Check if a professional is already responsible for a service
    *
    * @param i_lang                   Preferred language ID for this professional
    * @param i_id_department          Service ID
    * @param i_prof_id                Professional id
    *
    * @return                         true or false
    *
    * @author                         RMGM
    * @version                        2.6.3
    * @since                          2014/02/10
    **********************************************************************************************/
    FUNCTION check_serv_prof_resp
    (
        i_lang          IN language.id_language%TYPE,
        i_id_department IN department.id_department%TYPE,
        i_prof_id       IN professional.id_professional%TYPE
    ) RETURN BOOLEAN IS
        l_validation NUMBER := 0;
    BEGIN
        SELECT COUNT(1)
          INTO l_validation
          FROM department_resp_prof drp
         WHERE drp.id_department = i_id_department
           AND drp.id_professional = i_prof_id;
    
        IF l_validation > 0
        THEN
            RETURN FALSE;
        ELSE
            RETURN TRUE;
        END IF;
    END check_serv_prof_resp;
    /********************************************************************************************
    * Check if a professional is already responsible for a service and return identifier char
    *
    * @param i_lang                   Preferred language ID for this professional
    * @param i_id_department          Service ID
    * @param i_prof_id                Professional id
    *
    * @return                         true or false
    *
    * @author                         RMGM
    * @version                        2.6.3
    * @since                          2014/02/10
    **********************************************************************************************/
    FUNCTION check_serv_prof_resp_chr
    (
        i_lang          IN language.id_language%TYPE,
        i_id_department IN department.id_department%TYPE,
        i_prof_id       IN professional.id_professional%TYPE
    ) RETURN VARCHAR IS
    BEGIN
        IF check_serv_prof_resp(i_lang, i_id_department, i_prof_id)
        THEN
            RETURN 'A';
        ELSE
            RETURN 'D';
        END IF;
    END check_serv_prof_resp_chr;
    /********************************************************************************************
    * Set list of responsible professionals in a service context
    *
    * @param i_lang                   Preferred language ID for this professional    
    * @param i_id_department          Service ID
    * @param i_prof_id                Professional id
    * @param o_error                  Error Message ID
    *
    * @return                         true or false
    *
    * @author                         RMGM
    * @version                        2.6.3
    * @since                          2014/02/10
    **********************************************************************************************/
    FUNCTION set_serv_prof_resp
    (
        i_lang          IN language.id_language%TYPE,
        i_id_department IN department.id_department%TYPE,
        i_prof_id       IN professional.id_professional%TYPE,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        IF check_serv_prof_resp(i_lang, i_id_department, i_prof_id)
        THEN
            g_error := 'SET PROFESSIONAL ' || i_prof_id || ' ALREADY RESPONSIBLE IN DEPARTMENT ' || i_id_department;
            INSERT INTO department_resp_prof
                (id_department_resp_prof, id_department, id_professional)
            VALUES
                (seq_department_resp_prof.nextval, i_id_department, i_prof_id);
        END IF;
        COMMIT;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE_API_UI',
                                              'GET_SERV_PROF_RESPONSIBLE',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            ROLLBACK;
            RETURN FALSE;
    END set_serv_prof_resp;
    /********************************************************************************************
    * Delete responsible professional in a service context
    *
    * @param i_lang                   Preferred language ID for this professional    
    * @param i_id_department          Service ID
    * @param i_prof_id                Professional id
    * @param o_error                  Error Message ID
    *
    * @return                         true or false
    *
    * @author                         RMGM
    * @version                        2.6.3
    * @since                          2014/02/10
    **********************************************************************************************/
    FUNCTION delete_serv_prof_resp
    (
        i_lang          IN language.id_language%TYPE,
        i_id_department IN department.id_department%TYPE,
        i_prof_id       IN professional.id_professional%TYPE,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        INSERT INTO department_resp_prof_hist
            (id_department_resp_prof, id_department, id_professional, flg_operation)
        VALUES
            (seq_department_resp_prof_hist.nextval, i_id_department, i_prof_id, 'D');
    
        DELETE FROM department_resp_prof drp
         WHERE drp.id_department = i_id_department
           AND drp.id_professional = i_prof_id;
        COMMIT;
        RETURN TRUE;
    END delete_serv_prof_resp;
    /********************************************************************************************
    * Delete a list of responsible professionals in a service context
    *
    * @param i_lang                   Preferred language ID for this professional    
    * @param i_id_department          Service ID
    * @param i_prof_id                Professional id list
    * @param o_error                  Error Message ID
    *
    * @return                         true or false
    *
    * @author                         RMGM
    * @version                        2.6.3
    * @since                          2014/02/10
    **********************************************************************************************/
    FUNCTION delete_serv_prof_resp
    (
        i_lang          IN language.id_language%TYPE,
        i_id_department IN department.id_department%TYPE,
        i_prof_id       IN table_number,
        i_prof_service  IN table_number,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
        l_current_flg_type department_resp_prof.flg_type%TYPE;
    BEGIN
    
        FORALL i IN 1 .. i_prof_id.count
            INSERT INTO department_resp_prof_hist
                (id_department_resp_prof, id_department, id_professional, flg_operation, flg_type)
            VALUES
                (seq_department_resp_prof_hist.nextval, i_id_department, i_prof_id(i), 'D', 'C');
    
        FORALL i IN 1 .. i_prof_service.count
            INSERT INTO department_resp_prof_hist
                (id_department_resp_prof, id_department, id_professional, flg_operation, flg_type)
            VALUES
                (seq_department_resp_prof_hist.nextval, i_id_department, i_prof_service(i), 'D', 'S');
    
        FOR i IN 1 .. i_prof_id.count
        LOOP
            SELECT drp.flg_type
              INTO l_current_flg_type
              FROM department_resp_prof drp
             WHERE drp.id_department = i_id_department
               AND drp.id_professional = i_prof_id(i);
        
            IF l_current_flg_type = 'B'
            THEN
                UPDATE department_resp_prof drp
                   SET flg_type = 'S'
                 WHERE drp.id_department = i_id_department
                   AND drp.id_professional = i_prof_id(i);
            ELSE
                DELETE FROM department_resp_prof drp
                 WHERE drp.id_department = i_id_department
                   AND drp.id_professional = i_prof_id(i);
            END IF;
        END LOOP;
    
        FOR i IN 1 .. i_prof_service.count
        LOOP
            SELECT drp.flg_type
              INTO l_current_flg_type
              FROM department_resp_prof drp
             WHERE drp.id_department = i_id_department
               AND drp.id_professional = i_prof_service(i);
        
            IF l_current_flg_type = 'B'
            THEN
                UPDATE department_resp_prof drp
                   SET flg_type = 'C'
                 WHERE drp.id_department = i_id_department
                   AND drp.id_professional = i_prof_service(i);
            ELSE
                DELETE FROM department_resp_prof drp
                 WHERE drp.id_department = i_id_department
                   AND drp.id_professional = i_prof_service(i);
            END IF;
        END LOOP;
    
        COMMIT;
        RETURN TRUE;
    END delete_serv_prof_resp;
    /********************************************************************************************
    * Get a list of professional physicians in a service context to turn as responsible
    *
    * @param i_lang                   Preferred language ID for this professional    
    * @param i_id_department          Service ID
    * @param i_prof_id                Professional id list
    * @param o_error                  Error Message ID
    *
    * @return                         true or false
    *
    * @author                         RMGM
    * @version                        2.6.3
    * @since                          2014/02/11
    **********************************************************************************************/
    FUNCTION get_serv_physician_list
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        i_id_department  IN department.id_department%TYPE,
        o_prof_list      OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
        l_prof_physician category.id_category%TYPE := 1;
    BEGIN
        OPEN o_prof_list FOR
            SELECT p.id_professional,
                   pk_prof_utils.get_name_signature(i_lang, profissional(0, i_id_institution, 0), p.id_professional) prof_name
              FROM professional p
             INNER JOIN prof_cat pc
                ON (pc.id_professional = p.id_professional)
             WHERE EXISTS (SELECT 0
                      FROM prof_institution pi
                     WHERE pi.id_professional = p.id_professional
                       AND pi.id_institution = i_id_institution
                       AND pi.flg_state = 'A'
                       AND pi.dt_end_tstz IS NULL)
               AND pc.id_institution = i_id_institution
               AND pc.id_category = l_prof_physician
             ORDER BY prof_name;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'get_serv_physician_list',
                                              o_error);
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END get_serv_physician_list;
    /********************************************************************************************
    * Get list of professional physicians in a service context to turn as responsible
    *
    * @param i_lang                   Preferred language ID for this professional    
    * @param i_id_department          Service ID
    * @param i_prof_id                Professional id list
    * @param o_error                  Error Message ID
    *
    * @return                         true or false
    *
    * @author                         RMGM
    * @version                        2.6.3
    * @since                          2014/02/11
    **********************************************************************************************/
    FUNCTION get_service_responsible_map
    (
        i_lang            IN language.id_language%TYPE,
        i_id_dept         IN dept.id_dept%TYPE,
        i_id_professional IN department.id_department%TYPE,
        o_result_list     OUT pk_types.cursor_type,
        o_error           OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        OPEN o_result_list FOR
            SELECT d.id_department,
                   pk_backoffice.check_serv_prof_resp_chr(i_lang, d.id_department, i_id_professional) flg_prof_resp
              FROM department d
             WHERE d.flg_available = 'Y'
               AND d.id_dept = i_id_dept;
        RETURN TRUE;
    END get_service_responsible_map;
    /********************************************************************************************
    * Get Professional account values
    *
    * @param i_lang             Preferred language ID
    * @param i_prof_id          Professional ID
    * @param i_institution      Institution ID
    * @param i_accounts         Affiliations ID
    * @param o_error            Error
    *
    * @return                   true or false on success or error
    *
    *
    * @author                   RMGM
    * @version                  0.1
    * @since                    2012/02/17
    ********************************************************************************************/
    FUNCTION get_prof_account_val
    (
        i_lang        IN language.id_language%TYPE,
        i_prof_id     IN professional.id_professional%TYPE,
        i_institution IN institution.id_institution%TYPE,
        i_account     IN accounts.id_account%TYPE,
        o_error       OUT t_error_out
    ) RETURN VARCHAR2 IS
        l_country country.id_country%TYPE;
        l_exception EXCEPTION;
    
        o_value VARCHAR2(1000 CHAR);
    BEGIN
        -- get institution country
        BEGIN
            SELECT nvl(ia2.id_country, 0)
              INTO l_country
              FROM inst_attributes ia2
             WHERE ia2.id_institution = i_institution
               AND ia2.flg_available = pk_alert_constant.get_available;
        
            IF l_country = 0
            THEN
                g_error := 'INSTITUTION COUNTRY NOT CONFIGURED';
                RAISE l_exception;
            END IF;
        EXCEPTION
            WHEN no_data_found THEN
                g_error := 'INSTITUTION COUNTRY NOT CONFIGURED';
                RAISE l_exception;
        END;
        -- get account value
        BEGIN
            SELECT decode(a.fill_type,
                          'M',
                          nvl((pk_sysdomain.get_domain(a.sys_domain_identifier,
                                                       (SELECT pa.value
                                                          FROM prof_accounts pa
                                                         WHERE pa.id_account = a.id_account
                                                           AND pa.id_professional = i_prof_id
                                                           AND pa.id_institution = decode(ac.flg_institution,
                                                                                          g_flg_available,
                                                                                          i_institution,
                                                                                          0)),
                                                       i_lang)),
                              NULL),
                          (SELECT pa.value
                             FROM prof_accounts pa
                            WHERE pa.id_account = a.id_account
                              AND pa.id_professional = i_prof_id
                              AND pa.id_institution = decode(ac.flg_institution, g_flg_available, i_institution, 0))) value_desc
              INTO o_value
              FROM accounts a
             INNER JOIN accounts_category ac
                ON (ac.id_account = a.id_account AND
                   ac.id_category = pk_prof_utils.get_id_category(i_lang, profissional(i_prof_id, i_institution, 0)))
             WHERE a.flg_available = g_flg_available
               AND a.flg_type IN (g_account_type_p, g_account_type_b)
               AND a.id_account = i_account
               AND pk_translation.get_translation(i_lang, a.code_account) IS NOT NULL
               AND EXISTS (SELECT 0
                      FROM accounts_country acx
                     WHERE acx.id_account = a.id_account
                       AND acx.id_country = l_country
                       AND rownum = 1);
        EXCEPTION
            WHEN no_data_found THEN
                g_error := 'NO VALUE FOUND FOR PROF ' || i_prof_id;
                RAISE l_exception;
        END;
        RETURN o_value;
    EXCEPTION
        WHEN l_exception THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_API_BACKOFFICE',
                                              'GET_PROF_ACCOUNT_VAL',
                                              o_error);
            RETURN NULL;
        
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_API_BACKOFFICE',
                                              'GET_PROF_ACCOUNT_VAL',
                                              o_error);
            RETURN NULL;
    END get_prof_account_val;
    /********************************************************************************************
    * Get Institution accounts values
    *
    * @param i_lang             Preferred language ID
    * @param i_institution      Institution ID's
    * @param i_accounts         Affiliations ID's
    * @param o_error            Error
    *
    * @return                   true or false on success or error
    *
    *
    * @author                   RMGM
    * @version                  0.1
    * @since                    2012/02/17
    ********************************************************************************************/
    FUNCTION get_inst_account_val
    (
        i_lang        IN language.id_language%TYPE,
        i_institution IN institution.id_institution%TYPE,
        i_account     IN accounts.id_account%TYPE,
        o_error       OUT t_error_out
    ) RETURN VARCHAR2 IS
        l_country country.id_country%TYPE;
        l_exception EXCEPTION;
    
        o_value VARCHAR2(1000 CHAR);
    BEGIN
        -- get institution country
        BEGIN
            SELECT nvl(ia2.id_country, 0)
              INTO l_country
              FROM inst_attributes ia2
             WHERE ia2.id_institution = i_institution
               AND ia2.flg_available = pk_alert_constant.get_available;
        
            IF l_country = 0
            THEN
                g_error := 'INSTITUTION COUNTRY NOT CONFIGURED';
                RAISE l_exception;
            END IF;
        EXCEPTION
            WHEN no_data_found THEN
                g_error := 'INSTITUTION COUNTRY NOT CONFIGURED';
                RAISE l_exception;
        END;
        -- get account value
        BEGIN
            SELECT decode(a.fill_type,
                          'M',
                          nvl((pk_sysdomain.get_domain(a.sys_domain_identifier,
                                                       (SELECT ia.value
                                                          FROM institution_accounts ia
                                                         WHERE ia.id_account = a.id_account
                                                           AND ia.id_institution = i_institution),
                                                       i_lang)),
                              NULL),
                          (SELECT ia.value
                             FROM institution_accounts ia
                            WHERE ia.id_account = a.id_account
                              AND ia.id_institution = i_institution)) value_desc
              INTO o_value
              FROM accounts a
             INNER JOIN accounts_country ac
                ON (ac.id_account = a.id_account)
             WHERE a.flg_available = pk_alert_constant.get_available
               AND a.flg_type IN (g_account_type_i, g_account_type_b)
               AND pk_translation.get_translation(i_lang, a.code_account) IS NOT NULL
               AND ac.id_country = l_country
               AND a.id_account = i_account;
        EXCEPTION
            WHEN no_data_found THEN
                g_error := 'NO VALUE FOUND FOR INSTITUTION ' || i_institution;
                RETURN NULL;
        END;
        RETURN o_value;
    EXCEPTION
        WHEN l_exception THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_API_BACKOFFICE',
                                              'GET_INST_ACCOUNT_VAL',
                                              o_error);
            RETURN NULL;
        
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_API_BACKOFFICE',
                                              'GET_INST_ACCOUNT_VAL',
                                              o_error);
            RETURN NULL;
    END get_inst_account_val;
    /*
    Method that returns scholarship list of values by market and language translation
    */
    FUNCTION get_scholarship_mkt
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        o_schol_res      OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
        l_inst_mkt market.id_market%TYPE;
    BEGIN
        g_error    := 'GET MARKET FOR INSTITUTION ' || i_id_institution;
        l_inst_mkt := pk_utils.get_institution_market(i_lang, i_id_institution);
        g_error    := 'GET CONTENT IN MARKET ' || l_inst_mkt || ' FOR INSTITUTION ' || i_id_institution;
        OPEN o_schol_res FOR
            SELECT s.id_scholarship val, pk_translation.get_translation(i_lang, s.code_scholarship) desc_val, NULL icon
              FROM scholarship s
              LEFT JOIN scholarship_cat_spec b
                ON s.id_scholarship = b.id_scholarship
             WHERE b.id_scholarship_cat_spec IS NULL
               AND s.flg_available = g_flg_available
               AND EXISTS (SELECT /*+opt_estimate sm(rows=10)*/
                     0
                      FROM alert_adtcod_cfg.scholarship_market sm
                     WHERE sm.id_scholarship = s.id_scholarship
                       AND sm.id_market = l_inst_mkt)
               AND pk_translation.get_translation(i_lang, s.code_scholarship) IS NOT NULL
            
             ORDER BY desc_val;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_SCHOLARSHIP_MKT',
                                              o_error);
            pk_types.open_my_cursor(o_schol_res);
            RETURN FALSE;
    END get_scholarship_mkt;

    FUNCTION get_scholarship_group
    (
        i_lang                 IN language.id_language%TYPE,
        i_id_institution       IN institution.id_institution%TYPE,
        i_id_scholarship_group IN professional.id_agrupacion%TYPE,
        o_list                 OUT pk_types.cursor_type,
        o_error                OUT t_error_out
    ) RETURN BOOLEAN IS
        l_inst_mkt market.id_market%TYPE;
        l_t_config alert_core_tech.t_config;
    
    BEGIN
        g_error    := 'GET MARKET FOR INSTITUTION ' || i_id_institution;
        l_inst_mkt := pk_utils.get_institution_market(i_lang, i_id_institution);
    
        g_error    := 'GET PROF_SCHOLARSHIP CONFIG';
        l_t_config := pk_core_config.get_config(i_area             => 'PROF_SCHOLARSHIP',
                                                i_prof             => NULL,
                                                i_market           => l_inst_mkt,
                                                i_category         => NULL,
                                                i_profile_template => NULL,
                                                i_prof_dcs         => NULL,
                                                i_episode_dcs      => NULL);
        IF l_t_config.id_config IS NULL
        THEN
            pk_types.open_my_cursor(o_list);
            RETURN TRUE;
        END IF;
    
        OPEN o_list FOR
            SELECT s.id_scholarship val, pk_translation.get_translation(i_lang, s.code_scholarship) desc_val, NULL icon
              FROM scholarship s
             INNER JOIN alert_adtcod_cfg.scholarship_group_rel b
                ON s.id_scholarship = b.id_scholarship
             INNER JOIN (SELECT *
                           FROM TABLE(pk_core_config.get_values_by_mkt_inst_sw(i_lang => NULL,
                                                                               i_prof => NULL,
                                                                               i_area => 'PROF_SCHOLARSHIP'))) cfgt
                ON cfgt.id_record = b.id_scholarship_group_rel
             WHERE s.flg_available = g_flg_available
               AND b.id_scholarship_group = i_id_scholarship_group
               AND pk_translation.get_translation(i_lang, s.code_scholarship) IS NOT NULL
             ORDER BY desc_val;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_SCHOLARSHIP_MKT_CAT_SPEC',
                                              o_error);
            pk_types.open_my_cursor(o_list);
            RETURN FALSE;
    END get_scholarship_group;
    /*******************************************************
    * Method to create professional specializations/ affiliations string
    *
    * i_lang                        language identifier
    * i_id_professional             professional list
    * i_id_institution              institution identifier
    *
    * return varchar
    *
    ******************************************************/
    FUNCTION get_prof_resp_af_data
    (
        i_lang            IN language.id_language%TYPE,
        i_id_professional IN table_number,
        i_id_institution  IN institution.id_institution%TYPE
    ) RETURN VARCHAR2 IS
        l_account_id  prof_accounts.id_account%TYPE := 88;
        l_account_val prof_accounts.value%TYPE := NULL;
    
        l_valid      NUMBER := 0;
        l_error      t_error_out;
        l_temp_var   VARCHAR2(1000 CHAR);
        l_temp_check VARCHAR2(1000 CHAR);
    
        l_table_val   table_varchar := table_varchar();
        l_idx         NUMBER := 1;
        l_checkpoint  NUMBER := 0;
        l_checkpoint1 NUMBER := 0;
    BEGIN
    
        FOR i IN 1 .. i_id_professional.count
        LOOP
            g_error       := '1. GET current professional ' || i_id_professional(i) || ' acount value ';
            l_account_val := pk_backoffice.get_prof_account_val(i_lang,
                                                                i_id_professional(i),
                                                                i_id_institution,
                                                                l_account_id,
                                                                l_error);
        
            -- exact match
            IF pk_utils.search_table_varchar(l_table_val, l_account_val) = -1
            THEN
                l_checkpoint := 0;
            ELSE
                l_checkpoint := 1;
            END IF;
            g_error    := '   1.2 Manage current string ';
            l_temp_var := regexp_replace(REPLACE(translate(upper(l_account_val),
                                                           'ÁÉÍÓÚÀÈÌÒÙÂÊÎÔÛÃÕÇÄËÏÖÜÑ ',
                                                           'AEIOUAEIOUAEIOUAOCAEIOUN'),
                                                 chr(39),
                                                 ''),
                                         '[[:space:]]*',
                                         '');
        
            FOR j IN 1 .. l_table_val.count
            LOOP
                g_error      := '   1.3 Manage stored string ';
                l_temp_check := regexp_replace(REPLACE(translate(upper(l_table_val(j)),
                                                                 'ÁÉÍÓÚÀÈÌÒÙÂÊÎÔÛÃÕÇÄËÏÖÜÑ ',
                                                                 'AEIOUAEIOUAEIOUAOCAEIOUN'),
                                                       chr(39),
                                                       ''),
                                               '[[:space:]]*',
                                               '');
                -- translated match
                g_error := '2. Check if ' || l_temp_var || ' is in ' || l_temp_check || ' ';
                SELECT instr(l_temp_check, l_temp_var)
                  INTO l_checkpoint1
                  FROM dual;
            
                g_error := '2. Check if ' || l_temp_check || ' is in ' || l_temp_var || ' ';
                SELECT instr(l_temp_var, l_temp_check)
                  INTO l_valid
                  FROM dual;
            
                IF l_checkpoint1 = 0
                THEN
                    l_checkpoint := 0;
                ELSE
                    l_checkpoint := 1;
                END IF;
                IF l_valid > 0
                THEN
                    l_table_val(j) := NULL;
                    l_checkpoint := 0;
                END IF;
            END LOOP;
        
            IF l_checkpoint < 1
            THEN
                l_table_val.extend;
                l_table_val(l_idx) := l_account_val;
                l_idx := l_idx + 1;
            
            END IF;
        
            l_account_val := NULL;
        END LOOP;
    
        RETURN pk_utils.concat_table(l_table_val, chr(10));
    END get_prof_resp_af_data;
    /********************************************************************************************
    * Returns the Professional facility IDentifier (Mecanografic number)
    *
    * @param      i_lang                     Language identification
    * @param      i_prof                     Professional identification Array
    * @param      o_mec_num                  Identifier output
    * @param      o_error                    Error
    *
    * @return                         true or false on success or error
    *
    * @author                          Rui Gomes
    * @version                         2.6.4.1
    * @since                           2014/07/08
    **********************************************************************************************/
    FUNCTION get_prof_inst_mec_num
    (
        i_lang       IN language.id_language%TYPE,
        i_prof       IN profissional,
        i_flg_active IN VARCHAR2 DEFAULT NULL,
        o_mec_num    OUT prof_institution.num_mecan%TYPE,
        o_error      OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        BEGIN
            g_error := 'GET MEC NUMBER TO PROF ' || i_prof.id || ' IN INSTITUTION ' || i_prof.institution;
            SELECT pi.num_mecan
              INTO o_mec_num
              FROM prof_institution pi
             WHERE pi.id_professional = i_prof.id
               AND pi.id_institution = i_prof.institution
               AND ((i_flg_active IS NULL) OR (pi.flg_state = i_flg_active))
               AND pi.dt_end_tstz IS NULL;
        EXCEPTION
            WHEN no_data_found THEN
                o_mec_num := NULL;
        END;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_INST_MEC_NUM',
                                              o_error);
            o_mec_num := NULL;
            RETURN FALSE;
    END get_prof_inst_mec_num;
    /********************************************************************************************
    * Get Institution National identifier
    *
    * @param i_lang             Preferred language ID
    * @param i_prof             Professional Array
    * @param i_id_prefix        National Id context
    *
    * @return                   Value
    *
    * @author                   RMGM
    * @version                  2.6.4.2
    * @since                    2014/09/23
    ********************************************************************************************/
    FUNCTION get_inst_finess
    (
        i_lang IN language.id_language%TYPE,
        i_prof IN profissional
    ) RETURN VARCHAR IS
        l_error t_error_out;
    BEGIN
    
        RETURN get_inst_account_val(i_lang, i_prof.institution, g_account_inst_finess, l_error);
    
    EXCEPTION
        WHEN OTHERS THEN
            RETURN NULL;
    END get_inst_finess;
    /********************************************************************************************
    * Get Institution National identifier
    *
    * @param i_lang             Preferred language ID
    * @param i_prof             Professional Array
    * @param i_id_prefix        National Id context
    *
    * @return                   Value
    *
    * @author                   RMGM
    * @version                  2.6.4.2
    * @since                    2014/09/23
    ********************************************************************************************/
    FUNCTION get_inst_natid
    (
        i_lang IN language.id_language%TYPE,
        i_prof IN profissional
    ) RETURN table_varchar IS
        l_ret_tbl table_varchar := table_varchar();
        l_error   t_error_out;
    BEGIN
        l_ret_tbl.extend;
        l_ret_tbl(1) := 0 ||
                        pk_backoffice.get_inst_account_val(i_lang, i_prof.institution, g_account_prof_adeli, l_error);
        l_ret_tbl.extend;
        l_ret_tbl(2) := 1 ||
                        pk_backoffice.get_inst_account_val(i_lang, i_prof.institution, g_account_inst_finess, l_error);
        l_ret_tbl.extend;
        l_ret_tbl(3) := 2 ||
                        pk_backoffice.get_inst_account_val(i_lang, i_prof.institution, g_account_inst_siren, l_error);
        l_ret_tbl.extend;
        l_ret_tbl(4) := 3 ||
                        pk_backoffice.get_inst_account_val(i_lang, i_prof.institution, g_account_inst_siret, l_error);
        l_ret_tbl.extend;
        l_ret_tbl(5) := 4 ||
                        pk_backoffice.get_inst_account_val(i_lang, i_prof.institution, g_account_inst_rpps, l_error);
    
        RETURN l_ret_tbl;
    EXCEPTION
        WHEN OTHERS THEN
            RETURN l_ret_tbl;
    END get_inst_natid;
    /********************************************************************************************
    * Get Professional National identifier
    *
    * @param i_lang             Preferred language ID
    * @param i_prof             Professional Array
    * @param i_id_prefix        National Id context
    *
    * @return                   Value
    *
    * @author                   RMGM
    * @version                  2.6.4.2
    * @since                    2014/09/23
    ********************************************************************************************/

    FUNCTION get_prof_natid
    (
        i_lang IN language.id_language%TYPE,
        i_prof IN profissional
    ) RETURN table_varchar IS
        l_ret_tbl  table_varchar := table_varchar();
        l_error    t_error_out;
        v_res_prof VARCHAR2(200) := NULL;
    
        -- ********************************
        l_inst_account_val  VARCHAR2(4000);
        l_prof_inst_mec_num VARCHAR2(4000);
        l_action            VARCHAR2(0050 CHAR);
        l_account           NUMBER(24);
        l_num               NUMBER(24);
        k_mode_prof_account CONSTANT VARCHAR2(0050 CHAR) := 'MODE_PROF_ACCOUNT';
        k_mode_inst_account CONSTANT VARCHAR2(0050 CHAR) := 'MODE_INST_ACCOUNT';
        k_mode_num_order    CONSTANT VARCHAR2(0050 CHAR) := 'MODE_NUM_ORDER';
        -- ********************************
    BEGIN
    
        <<lup_thru_account_types>>
        FOR i IN 1 .. 9
        LOOP
        
            l_ret_tbl.extend;
        
            CASE i
                WHEN 1 THEN
                    l_action  := k_mode_prof_account;
                    l_num     := (i - 1);
                    l_account := g_account_prof_adeli;
                
                WHEN 2 THEN
                    l_action  := k_mode_inst_account;
                    l_num     := (i - 1);
                    l_account := g_account_prof_adeli;
                
                WHEN 3 THEN
                    l_action  := k_mode_prof_account;
                    l_num     := (i - 1);
                    l_account := g_account_prof_drass;
                WHEN 4 THEN
                    l_action  := k_mode_inst_account;
                    l_num     := (i - 1);
                    l_account := g_account_inst_finess;
                WHEN 5 THEN
                    l_action  := k_mode_inst_account;
                    l_num     := (i - 1);
                    l_account := g_account_inst_siren;
                WHEN 6 THEN
                    l_action  := k_mode_inst_account;
                    l_num     := (i - 1);
                    l_account := g_account_inst_siret;
                WHEN 7 THEN
                    l_action  := k_mode_inst_account;
                    l_num     := (i - 1);
                    l_account := g_account_inst_rpps;
                WHEN 8 THEN
                    l_action := k_mode_num_order;
                    l_num    := i;
                WHEN 9 THEN
                    l_action  := k_mode_prof_account;
                    l_num     := i;
                    l_account := g_account_prof_stud;
                
            END CASE;
        
            CASE l_action
                WHEN k_mode_prof_account THEN
                    l_ret_tbl(i) := l_num || pk_backoffice.get_prof_account_val(i_lang,
                                                                                i_prof.id,
                                                                                i_prof.institution,
                                                                                l_account,
                                                                                l_error);
                
                WHEN k_mode_inst_account THEN
                    l_inst_account_val  := pk_backoffice.get_inst_account_val(i_lang,
                                                                              i_prof.institution,
                                                                              l_account,
                                                                              l_error);
                    l_prof_inst_mec_num := pk_prof_utils.get_prof_inst_mec_num(i_lang => i_lang, i_prof => i_prof);
                
                    l_ret_tbl(i) := l_num || l_inst_account_val || '/' || l_prof_inst_mec_num;
                
                WHEN k_mode_num_order THEN
                
                    IF pk_prof_utils.get_num_order(i_lang, i_prof, i_prof.id, v_res_prof, l_error)
                    THEN
                        l_ret_tbl(i) := l_num || v_res_prof;
                    END IF;
                
            END CASE;
        
        END LOOP lup_thru_account_types;
    
        RETURN l_ret_tbl;
    
    EXCEPTION
        WHEN OTHERS THEN
            RETURN l_ret_tbl;
    END get_prof_natid;

    /********************************************************************************************
    * Get VHIF data
    *
    * @param i_lang             Preferred language ID
    * @param i_prof             Professional Array
    * @param i_inst_nat_prefix  National institution Id context
    * @param i_prof_nat_prefix  National Professional Id context
    * @o_prof_name              professional name
    * @o_prof_spec              professional Speciality
    * @o_prof_role              professional Role
    * @o_prof_idnat             professional National identifier
    * @o_inst_type              Institution Type
    * @o_inst_serial            Institution Serial
    * @o_inst_idnat             Institution National identifier
    * @o_prod_vers              alert version
    * @o_sw_name                software Name,
    * @o_sw_cert_id             Software certification identifier
    *
    * @return                   True or False
    *
    * @author                   RMGM
    * @version                  2.6.4.2
    * @since                    2014/09/23
    ********************************************************************************************/
    FUNCTION get_prof_vhif_data
    (
        i_lang        IN language.id_language%TYPE,
        i_prof        IN profissional,
        o_prof_name   OUT professional.name%TYPE,
        o_prof_spec   OUT speciality.id_content%TYPE,
        o_prof_role   OUT category.id_content%TYPE,
        o_prof_idnat  OUT table_varchar,
        o_inst_type   OUT institution.flg_type%TYPE,
        o_inst_serial OUT institution.id_institution%TYPE,
        o_inst_idnat  OUT table_varchar,
        o_prod_vers   OUT alert_version.version%TYPE,
        o_sw_name     OUT software.intern_name%TYPE,
        o_sw_cert_id  OUT sys_config.value%TYPE,
        o_error       OUT t_error_out
    ) RETURN BOOLEAN IS
        l_msg VARCHAR2(200) := 'ALERT';
    BEGIN
        -- professional data
        g_error := 'professional data';
        BEGIN
            SELECT p.name,
                   (SELECT s.id_content
                      FROM speciality s
                     WHERE s.id_speciality = p.id_speciality) "id_speciality",
                   (SELECT c.id_content
                      FROM category c
                     WHERE c.id_category = pc.id_category) "RoleId"
            
              INTO o_prof_name, o_prof_spec, o_prof_role
              FROM professional p
             INNER JOIN prof_cat pc
                ON (pc.id_professional = p.id_professional)
             WHERE pc.id_institution = i_prof.institution
               AND p.id_professional = i_prof.id;
        EXCEPTION
            WHEN no_data_found THEN
                o_prof_name := NULL;
                o_prof_spec := NULL;
                o_prof_role := NULL;
        END;
        g_error      := 'professional national ids';
        o_prof_idnat := pk_backoffice.get_prof_natid(i_lang, i_prof);
        -- institution data    
        g_error      := 'institution national ids';
        o_inst_idnat := pk_backoffice.get_inst_natid(i_lang, i_prof);
    
        g_error := 'institution data';
        BEGIN
            SELECT i.flg_type,
                   
                   i.id_institution "Serial Num"
              INTO o_inst_type, o_inst_serial
              FROM institution i
             WHERE i.id_institution = i_prof.institution;
        EXCEPTION
            WHEN no_data_found THEN
                o_inst_type   := NULL;
                o_inst_idnat  := NULL;
                o_inst_serial := NULL;
        END;
        -- alert version
        g_error := 'alert version data';
    
        o_prod_vers := pk_sysconfig.get_config(i_code_cf   => 'CERTIFICATION_VERSION',
                                               i_prof_inst => i_prof.institution,
                                               i_prof_soft => i_prof.software);
    
        -- sw data
        g_error := 'software data';
    
        o_sw_name    := l_msg;
        o_sw_cert_id := pk_sysconfig.get_config(i_code_cf   => 'CMS_EHR_CN',
                                                i_prof_inst => i_prof.institution,
                                                i_prof_soft => 0);
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_VHIF_DATA',
                                              o_error);
            RETURN FALSE;
    END get_prof_vhif_data;
    /********************************************************************************************
    * Get Operation identifier in professional History
    *
    * @param i_id_professional  Professional identifier
    *
    * @return                   Operation Identifier
    *
    * @author                   RMGM
    * @version                  2.6.4
    * @since                    2015/03/03
    ********************************************************************************************/
    FUNCTION get_prof_hist_pk(i_id_professional IN professional.id_professional%TYPE) RETURN NUMBER IS
        l_ret_n NUMBER(24) := 0;
    BEGIN
        SELECT ord_tbl.id_operation
          INTO l_ret_n
          FROM (SELECT ph.id_operation
                  FROM professional_hist ph
                 WHERE ph.id_professional = i_id_professional
                 ORDER BY ph.dt_operation DESC, ph.id_operation DESC) ord_tbl
         WHERE rownum = 1;
    
        RETURN l_ret_n;
    EXCEPTION
        WHEN OTHERS THEN
            RETURN 0;
    END get_prof_hist_pk;
    /********************************************************************************************
    * Insert New Professional information in History table
    *
    * @param i_id_professional  Professional identifier
    * @param i_operation_type   type of operation being made (C - create; U - update; R - removal)
    *
    * @author                   RMGM
    * @version                  2.6.4
    * @since                    2015/03/03
    ********************************************************************************************/
    PROCEDURE ins_professional_hist
    (
        i_id_professional IN professional.id_professional%TYPE,
        i_operation_type  IN professional_hist.operation_type%TYPE
    ) IS
        tbl_prof_id table_number := table_number();
        l_res_tbl   table_varchar := table_varchar();
    BEGIN
        tbl_prof_id.extend;
        tbl_prof_id(1) := i_id_professional;
    
        ins_professional_hist(i_tbl_professional => tbl_prof_id, i_operation_type => i_operation_type);
    
    END ins_professional_hist;

    PROCEDURE ins_prof_doc
    (
        i_lang            IN language.id_language%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        i_id_institution  IN prof_doc.id_institution%TYPE,
        i_doc_type        IN prof_doc.id_doc_type%TYPE,
        i_doc_num         IN prof_doc.value%TYPE,
        i_doc_ident_val   IN VARCHAR2
    ) IS
        l_doc_ident_val prof_doc.dt_expire_tstz%TYPE;
        l_rows_out      table_varchar;
    BEGIN
    
        IF i_doc_ident_val IS NOT NULL
        THEN
            l_doc_ident_val := pk_date_utils.get_string_tstz(i_lang,
                                                             profissional(i_id_professional, i_id_institution, NULL),
                                                             i_doc_ident_val,
                                                             NULL);
        END IF;
    
        ts_prof_doc.ins(id_prof_doc_in     => ts_prof_doc.next_key(),
                        id_doc_type_in     => i_doc_type,
                        id_professional_in => i_id_professional,
                        value_in           => i_doc_num,
                        id_institution_in  => i_id_institution,
                        dt_expire_tstz_in  => l_doc_ident_val,
                        rows_out           => l_rows_out);
    END ins_prof_doc;

    PROCEDURE upd_prof_doc
    (
        i_lang            IN language.id_language%TYPE,
        i_id_professional IN professional.id_professional%TYPE,
        i_id_institution  IN prof_doc.id_institution%TYPE,
        i_doc_type        IN prof_doc.id_doc_type%TYPE,
        i_doc_num         IN prof_doc.value%TYPE,
        i_doc_ident_val   IN VARCHAR2
    ) IS
    
        l_doc_ident_val prof_doc.dt_expire_tstz%TYPE;
        l_rows_out      table_varchar;
    BEGIN
    
        ts_prof_doc.del_by(where_clause_in => 'id_professional = ' || i_id_professional || ' and id_institution = ' ||
                                              i_id_institution,
                           rows_out        => l_rows_out);
    
        IF i_doc_ident_val IS NOT NULL
        THEN
            l_doc_ident_val := pk_date_utils.get_string_tstz(i_lang,
                                                             profissional(i_id_professional, i_id_institution, NULL),
                                                             i_doc_ident_val,
                                                             NULL);
        END IF;
    
        ts_prof_doc.ins(id_prof_doc_in     => ts_prof_doc.next_key(),
                        id_doc_type_in     => i_doc_type,
                        id_professional_in => i_id_professional,
                        value_in           => i_doc_num,
                        id_institution_in  => i_id_institution,
                        dt_expire_tstz_in  => l_doc_ident_val,
                        rows_out           => l_rows_out);
    END upd_prof_doc;

    FUNCTION get_prof_doc_list
    (
        i_lang  IN language.id_language%TYPE,
        i_prof  IN profissional,
        o_list  OUT pk_types.cursor_type,
        o_error OUT t_error_out
    ) RETURN BOOLEAN AS
    BEGIN
    
        OPEN o_list FOR
            SELECT DISTINCT a.id_doc_type, pk_translation.get_translation(i_lang, b.code_doc_type) desc_doc_type
              FROM doc_types_config a
             INNER JOIN doc_type b
                ON a.id_doc_type = b.id_doc_type
             WHERE a.id_software = i_prof.software
               AND a.id_institution IN (0, i_prof.institution)
               AND b.flg_available = pk_alert_constant.g_yes;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            RETURN FALSE;
    END get_prof_doc_list;

    /********************************************************************************************
    * Insert New Professional information in History table
    *
    * @param i_id_professional  List of Professional identifiers
    * @param i_operation_type   type of operation being made (C - create; U - update; R - removal)
    *
    * @author                   RMGM
    * @version                  2.6.4
    * @since                    2015/03/03
    ********************************************************************************************/
    PROCEDURE ins_professional_hist
    (
        i_tbl_professional IN table_number,
        i_operation_type   IN professional_hist.operation_type%TYPE
    ) IS
        tbl_prof_hist ts_professional_hist.professional_hist_tc;
        l_res_tbl     table_varchar := table_varchar();
        l_str1        VARCHAR2(50 CHAR);
    BEGIN
        l_str1 := substr(nvl(pk_utils.str_token(pk_utils.get_client_id, 1, ';'), USER), 1, 24);
        SELECT ts_professional_hist.next_key() id_operation,
               i_operation_type operation_type,
               current_timestamp dt_operation,
               l_str1 operation_user,
               id_professional,
               name,
               nick_name,
               dt_birth,
               address,
               district,
               city,
               zip_code,
               num_contact,
               marital_status,
               gender,
               flg_state,
               num_order,
               id_scholarship,
               id_speciality,
               id_country,
               barcode,
               initials,
               title,
               short_name,
               dt_birth_tstz,
               cell_phone,
               fax,
               email,
               first_name,
               middle_name,
               last_name,
               work_phone,
               upin,
               dea,
               flg_migration,
               flg_prof_test,
               adress_type,
               id_cpf,
               id_cns,
               mother_name,
               father_name,
               id_geo_state_birth,
               id_district_birth,
               code_race,
               code_scoolarship,
               flg_in_school,
               code_logr_type,
               door_number,
               address_extension,
               id_geo_state_adress,
               id_district_adress,
               adress_area,
               code_banq,
               desc_banq_ag,
               id_banq_account,
               code_doc_type,
               code_certificate,
               desc_balcony,
               desc_book,
               desc_page,
               desc_term,
               dt_emission_cert,
               id_document,
               code_emitant_cert,
               id_geo_state_doc,
               dt_emission_id,
               code_emitant_crm,
               id_geo_state_crm,
               code_family_status,
               id_prof_formation,
               other_doc_desc,
               id_health_plan,
               bleep_number,
               suffix,
               county,
               address_other_name,
               create_user,
               create_time,
               create_institution,
               update_user,
               update_time,
               update_institution,
               taxpayer_number,
               clinical_name,
               id_agrupacion_instit
          BULK COLLECT
          INTO tbl_prof_hist
          FROM professional p
         WHERE p.id_professional IN (SELECT /*+ opt_estimate prof(rows = 100)*/
                                      column_value
                                       FROM TABLE(i_tbl_professional) prof);
    
        ts_professional_hist.ins(rows_in => tbl_prof_hist, rows_out => l_res_tbl);
    
    END ins_professional_hist;
    /********************************************************************************************
    * Check if bleep number is valid according to institution configuration
    *
    * @param i_lang             Application language
    * @param i_prof          Professional identifier
    *
    * @return                   True or False
    *
    * @author                   RMGM
    * @version                  2.6.4
    * @since                    2015/03/04
    ********************************************************************************************/
    FUNCTION is_bleep_valid
    (
        i_lang IN language.id_language%TYPE,
        i_prof IN profissional
    ) RETURN BOOLEAN IS
        l_config_val NUMBER;
        l_date_diff  NUMBER;
    BEGIN
        g_error      := 'Get configuration value ' || i_prof.id;
        l_config_val := to_number(pk_sysconfig.get_config(i_code_cf   => g_config_bleep_timeout,
                                                          i_prof_inst => i_prof.institution,
                                                          i_prof_soft => i_prof.software));
    
        g_error := 'Get last change date for professional ' || i_prof.id;
        SELECT trunc(pk_date_utils.get_timestamp_diff(i_timestamp_1 => SYSDATE, i_timestamp_2 => p.adw_last_update))
          INTO l_date_diff
          FROM professional p
         WHERE p.id_professional = i_prof.id;
        IF l_date_diff < to_number(l_config_val)
        THEN
            RETURN TRUE;
        ELSE
            RETURN FALSE;
        END IF;
    
    END is_bleep_valid;
    /********************************************************************************************
    * Get prof_institution PK id
    *
    * @param i_lang            Application Language
    * @param i_id_prof         Professional identifier
    * @param i_id_institution  Institution identifier
    * @param i_flg_sate        State of the professional in institution
    *            
    * @Return                  prof_institution PK
    *
    * @author                   RMGM
    * @version                  2.6.4
    * @since                    2015/03/05
    ********************************************************************************************/
    FUNCTION get_prof_institution_pk
    (
        i_lang           IN language.id_language%TYPE,
        i_id_prof        IN professional.id_professional%TYPE,
        i_id_institution IN prof_institution.id_institution%TYPE,
        i_flg_sate       IN prof_institution.flg_state%TYPE DEFAULT 'A'
    ) RETURN prof_institution.id_prof_institution%TYPE IS
        l_pi_pk prof_institution.id_prof_institution%TYPE := 0;
    BEGIN
        g_error := 'Get prof_institutin ID for professional ' || i_id_prof || ' in institution ' || i_id_institution;
        SELECT pi.id_prof_institution
          INTO l_pi_pk
          FROM prof_institution pi
         WHERE pi.id_professional = i_id_prof
           AND pi.id_institution = i_id_institution
           AND pi.flg_state = i_flg_sate
           AND pi.dt_end_tstz IS NULL;
    
        RETURN l_pi_pk;
    EXCEPTION
        WHEN OTHERS THEN
            RETURN NULL;
    END get_prof_institution_pk;
    /********************************************************************************************
    * Set contact fields for professional in institution
    *
    * @param i_lang            Application Language
    * @param i_id_prof         Professional identifier
    * @param i_id_institution  Institution identifier
    * @param i_work_phone      Work phone Number value
    * @param i_home_phone      Home phone Number value
    * @param i_cell_phone      Celular phone Number value
    * @param i_fax             Fax Number value
    * @param i_email           Email adress value
    * @param i_bleep           Bleep number value
    * @param i_contact_det     other contact details info
    * @param o_error           Error object    
    *            
    * @Return                  True or False
    *
    * @author                   RMGM
    * @version                  2.6.4
    * @since                    2015/03/05
    ********************************************************************************************/
    FUNCTION set_prof_contacts
    (
        i_lang           IN language.id_language%TYPE,
        i_id_prof        IN professional.id_professional%TYPE,
        i_id_institution IN prof_institution.id_institution%TYPE,
        i_work_phone     IN professional.work_phone%TYPE,
        i_home_phone     IN professional.num_contact%TYPE,
        i_cell_phone     IN professional.cell_phone%TYPE,
        i_fax            IN professional.fax%TYPE,
        i_email          IN professional.email%TYPE,
        i_bleep          IN professional.bleep_number%TYPE,
        i_contact_det    IN prof_institution.contact_detail%TYPE,
        i_commit_trs     IN BOOLEAN DEFAULT TRUE,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
        l_pi_pk prof_institution.id_prof_institution%TYPE := 0;
    BEGIN
    
        g_error := 'Set contact information for professional ' || i_id_prof;
        UPDATE professional p
           SET p.work_phone   = i_work_phone,
               p.num_contact  = i_home_phone,
               p.cell_phone   = i_cell_phone,
               p.fax          = i_fax,
               p.email        = i_email,
               p.bleep_number = i_bleep
         WHERE p.id_professional = i_id_prof;
    
        g_error := 'Clear Contact details field if null for prof_inst ' || i_id_prof;
        IF i_contact_det IS NULL
        THEN
            l_pi_pk := pk_backoffice.get_prof_institution_pk(i_lang           => i_lang,
                                                             i_id_prof        => i_id_prof,
                                                             i_id_institution => i_id_institution);
            pk_api_ab_tables.del_prof_inst_cont_det(i_id_prof_inst => l_pi_pk);
        END IF;
        g_error := 'SET PROFESSIONAL HISTORY';
        pk_backoffice.ins_professional_hist(i_id_professional => i_id_prof,
                                            i_operation_type  => pk_backoffice.g_prof_hist_oper_u);
        IF i_commit_trs
        THEN
            COMMIT;
        END IF;
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_PROF_CONTACTS',
                                              o_error);
            IF i_commit_trs
            THEN
                ROLLBACK;
            END IF;
            RETURN FALSE;
    END set_prof_contacts;
    /********************************************************************************************
    * Get contact fields for professional in institution
    *
    * @param i_lang            Application Language
    * @param i_id_prof         Professional identifier
    * @param i_id_institution  Institution identifier
    * @param i_req_date        Date to get data from (null or default gets last data inputed)
    * @param o_work_phone      Work phone Number value
    * @param o_home_phone      Home phone Number value
    * @param o_cell_phone      Celular phone Number value
    * @param o_fax             Fax Number value
    * @param o_email           Email adress value
    * @param o_bleep           Bleep number value
    * @param o_contact_det     other contact details info
    * @param o_error           Error object    
    *            
    * @Return                  True or False
    *
    * @author                   RMGM
    * @version                  2.6.4
    * @since                    2015/03/05
    ********************************************************************************************/
    FUNCTION get_prof_contacts
    (
        i_lang           IN language.id_language%TYPE,
        i_id_prof        IN professional.id_professional%TYPE,
        i_id_institution IN prof_institution.id_institution%TYPE,
        i_req_date       IN professional_hist.dt_operation%TYPE DEFAULT NULL,
        o_work_phone     OUT professional.work_phone%TYPE,
        o_home_phone     OUT professional.num_contact%TYPE,
        o_cell_phone     OUT professional.cell_phone%TYPE,
        o_fax            OUT professional.fax%TYPE,
        o_email          OUT professional.email%TYPE,
        o_bleep          OUT professional.bleep_number%TYPE,
        o_contact_det    OUT prof_institution.contact_detail%TYPE,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
        l_pi_pk prof_institution.id_prof_institution%TYPE := 0;
    BEGIN
        IF i_req_date IS NULL
        THEN
            g_error := 'Get contact information for professional ' || i_id_prof;
            SELECT p.work_phone, p.num_contact, p.cell_phone, p.fax, p.email, p.bleep_number
              INTO o_work_phone, o_home_phone, o_cell_phone, o_fax, o_email, o_bleep
              FROM professional p
             WHERE p.id_professional = i_id_prof;
        ELSE
            g_error := 'Get contact information from history for professional ' || i_id_prof;
            SELECT work_phone, num_contact, cell_phone, fax, email, bleep_number
              INTO o_work_phone, o_home_phone, o_cell_phone, o_fax, o_email, o_bleep
              FROM (SELECT nvl(ph.work_phone, p.work_phone) work_phone,
                           nvl(ph.num_contact, p.num_contact) num_contact,
                           nvl(ph.cell_phone, p.cell_phone) cell_phone,
                           nvl(ph.fax, p.fax) fax,
                           nvl(ph.email, p.email) email,
                           nvl(ph.bleep_number, p.bleep_number) bleep_number,
                           row_number() over(PARTITION BY p.id_professional ORDER BY ph.dt_operation DESC NULLS FIRST) rn
                      FROM professional p
                      LEFT JOIN professional_hist ph
                        ON p.id_professional = ph.id_professional
                     WHERE p.id_professional = i_id_prof
                       AND nvl(ph.dt_operation, i_req_date) <= i_req_date) t
             WHERE rn = 1;
        END IF;
        l_pi_pk := pk_backoffice.get_prof_institution_pk(i_lang           => i_lang,
                                                         i_id_prof        => i_id_prof,
                                                         i_id_institution => i_id_institution);
    
        g_error := 'Get contact additional information for professional ' || i_id_prof;
        SELECT pi.contact_detail
          INTO o_contact_det
          FROM prof_institution pi
         WHERE pi.id_prof_institution = l_pi_pk;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_CONTACTS',
                                              o_error);
            o_work_phone  := NULL;
            o_home_phone  := NULL;
            o_cell_phone  := NULL;
            o_fax         := NULL;
            o_email       := NULL;
            o_bleep       := NULL;
            o_contact_det := NULL;
            RETURN FALSE;
    END get_prof_contacts;

    /********************************************************************************************
    * Get work phone contact for professional
    *
    * @param i_lang            Application Language
    * @param i_prof            Professional identifier
    * @param i_req_date        Date to get data from (null or default gets last data inputed)
    *            
    * @Return                   professional.work_phone
    *
    * @author                   Joana Madureira Barroso
    * @version                  2.6.5
    * @since                    2015/04/10
    ********************************************************************************************/
    FUNCTION get_prof_work_phone_contact
    (
        i_lang     IN language.id_language%TYPE,
        i_prof     IN profissional,
        i_req_date IN professional_hist.dt_operation%TYPE DEFAULT NULL
    ) RETURN professional.work_phone%TYPE IS
    
        l_work_phone professional.work_phone%TYPE;
        l_error      t_error_out;
    BEGIN
        g_error := 'Get contact information for professional ' || i_prof.id;
        IF i_req_date IS NULL
        THEN
            g_error := 'Get contact information for professional ' || i_prof.id;
            SELECT p.work_phone
              INTO l_work_phone
              FROM professional p
             WHERE p.id_professional = i_prof.id;
        ELSE
            SELECT work_phone
              INTO l_work_phone
              FROM (SELECT nvl(ph.work_phone, p.work_phone) work_phone,
                           row_number() over(PARTITION BY p.id_professional ORDER BY ph.dt_operation DESC NULLS FIRST) rn
                      FROM professional p
                      LEFT JOIN professional_hist ph
                        ON p.id_professional = ph.id_professional
                     WHERE p.id_professional = i_prof.id
                       AND ph.dt_operation <= i_req_date) t
             WHERE rn = 1;
        END IF;
    
        RETURN l_work_phone;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_WORK_PHONE_CONTACT',
                                              l_error);
        
            RETURN NULL;
        
    END get_prof_work_phone_contact;

    /********************************************************************************************
    * Get home  phone contact for professional
    *
    * @param i_lang            Application Language
    * @param i_prof            Professional identifier
    * @param i_req_date        Date to get data from (null or default gets last data inputed)
    *            
    * @Return                   professional.num_contact
    *
    * @author                   Joana Madureira Barroso
    * @version                  2.6.5
    * @since                    2015/04/10
    ********************************************************************************************/

    FUNCTION get_prof_home_phone_contact
    (
        i_lang     IN language.id_language%TYPE,
        i_prof     IN profissional,
        i_req_date IN professional_hist.dt_operation%TYPE DEFAULT NULL
    ) RETURN professional.num_contact%TYPE IS
    
        l_home_phone professional.num_contact%TYPE;
        l_error      t_error_out;
    BEGIN
        g_error := 'Get contact information for professional ' || i_prof.id;
        IF i_req_date IS NULL
        THEN
            g_error := 'Get contact information for professional ' || i_prof.id;
            SELECT p.num_contact
              INTO l_home_phone
              FROM professional p
             WHERE p.id_professional = i_prof.id;
        ELSE
            SELECT num_contact
              INTO l_home_phone
              FROM (SELECT nvl(ph.num_contact, p.num_contact) num_contact,
                           row_number() over(PARTITION BY p.id_professional ORDER BY ph.dt_operation DESC NULLS FIRST) rn
                      FROM professional p
                      LEFT JOIN professional_hist ph
                        ON p.id_professional = ph.id_professional
                     WHERE p.id_professional = i_prof.id
                       AND ph.dt_operation <= i_req_date) t
             WHERE rn = 1;
        END IF;
    
        RETURN l_home_phone;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_HOME_PHONE_CONTACT',
                                              l_error);
        
            RETURN NULL;
        
    END get_prof_home_phone_contact;

    /********************************************************************************************
    * Get bleep number contact for professional
    *
    * @param i_lang            Application Language
    * @param i_prof            Professional identifier
    * @param i_req_date        Date to get data from (null or default gets last data inputed)
    *            
    * @Return                   professional.num_contact
    *
    * @author                   Joana Madureira Barroso
    * @version                  2.6.5
    * @since                    2015/04/10
    ********************************************************************************************/

    FUNCTION get_prof_bleep_number_contact
    (
        i_lang     IN language.id_language%TYPE,
        i_prof     IN profissional,
        i_req_date IN professional_hist.dt_operation%TYPE DEFAULT NULL
    ) RETURN professional.bleep_number%TYPE IS
    
        l_bleep_number professional.bleep_number%TYPE;
        l_error        t_error_out;
    BEGIN
        g_error := 'Get contact information for professional ' || i_prof.id;
        IF i_req_date IS NULL
        THEN
            g_error := 'Get contact information for professional ' || i_prof.id;
            SELECT p.bleep_number
              INTO l_bleep_number
              FROM professional p
             WHERE p.id_professional = i_prof.id;
        ELSE
            SELECT bleep_number
              INTO l_bleep_number
              FROM (SELECT nvl(ph.bleep_number, p.bleep_number) bleep_number,
                           row_number() over(PARTITION BY p.id_professional ORDER BY ph.dt_operation DESC NULLS FIRST) rn
                      FROM professional p
                      LEFT JOIN professional_hist ph
                        ON p.id_professional = ph.id_professional
                     WHERE p.id_professional = i_prof.id
                       AND ph.dt_operation <= i_req_date) t
             WHERE rn = 1;
        END IF;
    
        RETURN l_bleep_number;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_BLEEP_NUMBER_CONTACT',
                                              l_error);
        
            RETURN NULL;
    END get_prof_bleep_number_contact;

    /********************************************************************************************
    * Get cell number contact for professional
    *
    * @param i_lang            Application Language
    * @param i_prof            Professional identifier
    * @param i_req_date        Date to get data from (null or default gets last data inputed)
    *            
    * @Return                   professional.num_contact
    *
    * @author                   Joana Madureira Barroso
    * @version                  2.6.5
    * @since                    2015/04/10
    ********************************************************************************************/

    FUNCTION get_prof_cell_number_contact
    (
        i_lang     IN language.id_language%TYPE,
        i_prof     IN profissional,
        i_req_date IN professional_hist.dt_operation%TYPE DEFAULT NULL
    ) RETURN professional.cell_phone%TYPE IS
    
        l_cell_number professional.cell_phone%TYPE;
        l_error       t_error_out;
    BEGIN
        g_error := 'Get contact information for professional ' || i_prof.id;
        IF i_req_date IS NULL
        THEN
            g_error := 'Get contact information for professional ' || i_prof.id;
            SELECT p.cell_phone
              INTO l_cell_number
              FROM professional p
             WHERE p.id_professional = i_prof.id;
        ELSE
            SELECT cell_phone
              INTO l_cell_number
              FROM (SELECT nvl(ph.cell_phone, p.cell_phone) cell_phone,
                           row_number() over(PARTITION BY p.id_professional ORDER BY ph.dt_operation DESC NULLS FIRST) rn
                      FROM professional p
                      LEFT JOIN professional_hist ph
                        ON p.id_professional = ph.id_professional
                     WHERE p.id_professional = i_prof.id
                       AND ph.dt_operation <= i_req_date) t
             WHERE rn = 1;
        END IF;
    
        RETURN l_cell_number;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_CELL_NUMBER_CONTACT',
                                              l_error);
        
            RETURN NULL;
    END get_prof_cell_number_contact;

    /********************************************************************************************
    * Get all professionals (except responsible) allocated for a department
    *
    * @param i_lang            Prefered language ID
    * @param i_prof            Professional Array Identifier
    * @param i_id_department   Department identifier
    *
    * @param o_prof_id_list    List of professionals ids
    * @param o_prof_desc_list  list of professional names indexed to ids
    * @param o_error           Error object
    *
    * @author                  GS
    * @version                 2.6.5
    * @since                   2015/05/12
    ********************************************************************************************/
    FUNCTION get_serv_prof_not_responsible
    (
        i_lang           IN language.id_language%TYPE,
        i_id_institution IN institution.id_institution%TYPE,
        i_id_department  IN department.id_department%TYPE,
        o_prof_id_list   OUT table_number,
        o_prof_desc_list OUT table_varchar,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        g_error := 'GET LIST OF RESPONSIBLE PROFESSIONALS IN DEPARTMENT ' || i_id_department;
        SELECT drp.id_professional,
               pk_prof_utils.get_name_signature(i_lang    => i_lang,
                                                i_prof    => profissional(0, i_id_institution, 0),
                                                i_prof_id => drp.id_professional) prof_name
          BULK COLLECT
          INTO o_prof_id_list, o_prof_desc_list
          FROM department_resp_prof drp
         WHERE id_department = i_id_department
           AND flg_type IN ('B', 'S')
         ORDER BY pk_prof_utils.get_name(i_lang => i_lang, i_prof_id => drp.id_professional);
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            o_prof_id_list   := table_number();
            o_prof_desc_list := table_varchar();
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_SERV_PROF_NOT_RESPONSIBLE',
                                              o_error);
            RETURN FALSE;
    END get_serv_prof_not_responsible;

    /* Function that return the flg_type department
    ** @param i_lang        the id language
    * @param i_prof         professional, software and institution ids
    * @param i_id_department department id
    **/
    FUNCTION get_department_type
    (
        i_lang          IN NUMBER,
        i_prof          IN profissional,
        i_id_department IN department.id_department%TYPE
    ) RETURN VARCHAR2 IS
        l_flg_type VARCHAR2(6char);
    BEGIN
        SELECT dep.flg_type
          INTO l_flg_type
          FROM department dep
         WHERE dep.id_department = i_id_department;
    
        RETURN l_flg_type;
    
    EXCEPTION
        WHEN no_data_found THEN
            RETURN NULL;
        
    END get_department_type;

    FUNCTION get_inst_field
    (
        i_lang           IN NUMBER,
        i_prof           IN profissional,
        i_id_institution IN NUMBER,
        i_field          IN VARCHAR2
    ) RETURN VARCHAR2 IS
    
        k_clues           CONSTANT VARCHAR2(0100 CHAR) := 'CLUES';
        k_inst_name       CONSTANT VARCHAR2(0100 CHAR) := 'INST_NAME';
        k_street_type     CONSTANT VARCHAR2(0100 CHAR) := 'STREET_TYPE';
        k_street          CONSTANT VARCHAR2(0100 CHAR) := 'STREET';
        k_outside_number  CONSTANT VARCHAR2(0100 CHAR) := 'OUTSIDE_NUMBER';
        k_inside_number   CONSTANT VARCHAR2(0100 CHAR) := 'INSIDE_NUMBER';
        k_settlement_type CONSTANT VARCHAR2(0100 CHAR) := 'SETTLEMENT_TYPE';
        k_settlement      CONSTANT VARCHAR2(0100 CHAR) := 'SETTLEMENT';
        k_code_settlement CONSTANT VARCHAR2(0100 CHAR) := 'CODE_SETTLEMENT';
        k_code_entity     CONSTANT VARCHAR2(0100 CHAR) := 'CODE_ENTITY';
        k_code_municip    CONSTANT VARCHAR2(0100 CHAR) := 'CODE_MUNICIP';
        k_code_location   CONSTANT VARCHAR2(0100 CHAR) := 'CODE_LOCATION';
        k_postal_code     CONSTANT VARCHAR2(0100 CHAR) := 'POSTAL_CODE';
        k_phone_number    CONSTANT VARCHAR2(0100 CHAR) := 'PHONE_NUMBER';
        k_id_country      CONSTANT VARCHAR2(0100 CHAR) := 'ID_COUNTRY';
    
        l_clues           VARCHAR2(4000 CHAR);
        l_inst_name       VARCHAR2(4000 CHAR);
        l_street_type     VARCHAR2(2 CHAR);
        l_street          VARCHAR2(4000 CHAR);
        l_outside_number  VARCHAR2(4000 CHAR);
        l_inside_number   VARCHAR2(4000 CHAR);
        l_settlement_type NUMBER(24);
        l_settlement      VARCHAR2(4000 CHAR);
        l_settlement_code VARCHAR2(2 CHAR);
        l_code_entity     VARCHAR2(4000 CHAR);
        l_code_municip    VARCHAR2(4000 CHAR);
        l_code_location   VARCHAR2(4000 CHAR);
        l_postal_code     VARCHAR2(4000 CHAR);
        l_phone_number    VARCHAR2(4000 CHAR);
        l_id_country      NUMBER(24);
    
        l_return VARCHAR2(4000 CHAR);
    BEGIN
    
        SELECT ia.clues,
               pk_translation.get_translation(i_lang, i.code_institution) inst_name,
               ia.flg_street_type street_type,
               ia.street_name street,
               ia.outdoor_number outdoor_number,
               ia.indoor_number indoor_number,
               ia.id_settlement_type settlement_type,
               pk_adt.get_settlement_desc(i_lang               => i_lang,
                                          i_prof               => i_prof,
                                          i_id_settlement      => ia.id_settlement_name,
                                          i_id_settlement_type => ia.id_settlement_type) settlement,
               pk_adt.get_rb_reg_classifier_code(i_rb_reg_class => ia.id_entity, i_rank => 5) code_entity,
               pk_adt.get_rb_reg_classifier_code(i_rb_reg_class => ia.id_municip, i_rank => 10) code_municip,
               pk_adt.get_rb_reg_classifier_code(i_rb_reg_class => ia.id_localidad, i_rank => 15) code_location,
               i.zip_code postal_code,
               i.phone_number,
               pk_adt.get_settlement_code(i_lang               => i_lang,
                                          i_prof               => i_prof,
                                          i_id_settlement_type => ia.id_settlement_type) settlement_code,
               ia.id_country
          INTO l_clues,
               l_inst_name,
               l_street_type,
               l_street,
               l_outside_number,
               l_inside_number,
               l_settlement_type,
               l_settlement,
               l_code_entity,
               l_code_municip,
               l_code_location,
               l_postal_code,
               l_phone_number,
               l_settlement_code,
               l_id_country
          FROM institution i
          LEFT JOIN inst_attributes ia
            ON (i.id_institution = ia.id_institution AND ia.flg_available = g_flg_avail)
         WHERE i.id_institution = i_id_institution;
    
        CASE i_field
            WHEN k_clues THEN
                l_return := l_clues;
            WHEN k_inst_name THEN
                l_return := l_inst_name;
            WHEN k_street_type THEN
                l_return := l_street_type;
            WHEN k_street THEN
                l_return := l_street;
            WHEN k_outside_number THEN
                l_return := l_outside_number;
            WHEN k_inside_number THEN
                l_return := l_inside_number;
            WHEN k_settlement_type THEN
                l_return := to_char(l_settlement_type);
            WHEN k_settlement THEN
                l_return := l_settlement;
            WHEN k_code_settlement THEN
                l_return := l_settlement_code;
            WHEN k_code_entity THEN
                l_return := l_code_entity;
            WHEN k_code_municip THEN
                l_return := l_code_municip;
            WHEN k_code_location THEN
                l_return := l_code_location;
            WHEN k_postal_code THEN
                l_return := l_postal_code;
            WHEN k_phone_number THEN
                l_return := l_phone_number;
            WHEN k_id_country THEN
                l_return := l_id_country;
            ELSE
                l_return := NULL;
        END CASE;
    
        RETURN l_return;
    
    EXCEPTION
        WHEN OTHERS THEN
            RETURN NULL;
    END get_inst_field;

    FUNCTION get_professional_br_report
    (
        i_lang    IN language.id_language%TYPE,
        i_prof    IN profissional,
        i_id_prof IN professional.id_professional%TYPE,
        o_prof    OUT pk_types.cursor_type,
        o_error   OUT t_error_out
    ) RETURN BOOLEAN IS
    
        l_code_entity sys_domain.code_domain%TYPE := 'PROFESSIONAL.EMITING_ENTITY';
    
        l_exception EXCEPTION;
    BEGIN
        OPEN o_prof FOR
            SELECT p.num_order num_crm, (pk_sysdomain.get_domain(l_code_entity, p.code_emitant_crm, i_lang)) desc_crm
              FROM professional p
             WHERE p.id_professional = i_id_prof;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROFESSIONAL_BR_REPORT',
                                              o_error);
            pk_types.open_my_cursor(o_prof);
            RETURN FALSE;
        
    END get_professional_br_report;

    /********************************************************************************************
    * Validate email structure
    *
    * @param i_prof            Professional
    * @param i_email           Email adress value
    *            
    * @Return                  True or False
    *
    * @author                   Andr?Silva
    * @version                  2.7.1
    * @since                    2017/10/13
    ********************************************************************************************/

    FUNCTION validate_email
    (
        i_prof  IN profissional,
        i_email IN professional.email%TYPE
    ) RETURN BOOLEAN IS
    
        l_email_regexp sys_config.value%TYPE;
    
    BEGIN
    
        l_email_regexp := pk_sysconfig.get_config(g_config_email_regexp, i_prof);
    
        IF NOT regexp_like(i_email, l_email_regexp)
        THEN
            RETURN FALSE;
        END IF;
    
        RETURN TRUE;
    END validate_email;

    /********************************************************************************************
    * Validate phone number structure
    *
    * @param i_prof            Professional 
    * @param i_work_phone      Work phone Number value
    * @param i_home_phone      Home phone Number value
    *            
    * @Return                  True or False
    *
    * @author                   Andr?Silva
    * @version                  2.7.1
    * @since                    2017/10/13
    ********************************************************************************************/
    FUNCTION validate_phones
    (
        i_prof       IN profissional,
        i_work_phone IN professional.work_phone%TYPE,
        i_home_phone IN professional.num_contact%TYPE
    ) RETURN BOOLEAN IS
    
        l_phone_length sys_config.value%TYPE;
    
    BEGIN
    
        l_phone_length := pk_sysconfig.get_config(g_config_phone_length, i_prof);
    
        IF (substr(i_work_phone, 1, 1) != '+' OR length(i_work_phone) != l_phone_length)
        THEN
            RETURN FALSE;
        END IF;
    
        IF (substr(i_home_phone, 1, 1) != '+' OR length(i_home_phone) != l_phone_length)
        THEN
            RETURN FALSE;
        END IF;
    
        RETURN TRUE;
    END validate_phones;

    FUNCTION get_name_translation
    (
        i_lang       IN language.id_language%TYPE,
        i_prof       IN profissional,
        i_name       IN name_translation.ocidental_name%TYPE,
        i_type       IN NUMBER,
        o_name_trans OUT name_translation.ocidental_name%TYPE,
        o_error      OUT t_error_out
    ) RETURN BOOLEAN IS
        l_names_array table_varchar;
    BEGIN
    
        IF i_type = 0
        THEN
            BEGIN
                SELECT nt.arabic_name
                  BULK COLLECT
                  INTO l_names_array
                  FROM name_translation nt
                 WHERE upper(nt.ocidental_name) = upper(i_name);
            EXCEPTION
                WHEN no_data_found THEN
                    l_names_array := NULL;
            END;
        ELSE
            BEGIN
                SELECT nt.ocidental_name
                  BULK COLLECT
                  INTO l_names_array
                  FROM name_translation nt
                 WHERE nt.arabic_name = i_name;
            EXCEPTION
                WHEN no_data_found THEN
                    l_names_array := NULL;
            END;
        END IF;
    
        IF l_names_array.count > 0
        THEN
            o_name_trans := l_names_array(1);
        END IF;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE_API_UI',
                                              'GET_NAME_TRANSLATION',
                                              o_error);
            RETURN FALSE;
    END get_name_translation;

    FUNCTION get_agrupacion
    (
        i_lang           IN language.id_language%TYPE,
        i_prof           IN profissional,
        i_id_institution IN institution.id_institution%TYPE,
        o_list           OUT pk_types.cursor_type,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
    
        OPEN o_list FOR
            SELECT a.id_scholarship_group,
                   pk_translation.get_translation(i_lang => i_lang, i_code_mess => a.code_scholarship_group) desc_scholarship_group
              FROM alert_adtcod_cfg.scholarship_group a;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_AGRUPACION',
                                              o_error);
            RETURN FALSE;
    END get_agrupacion;

    /**
    * Public Function. Get all dep_clin_serv id to a Professional
    *
    * @param i_id_prof                  Professional identification
    * @param i_id_institution           Institution identification
    *
    * @return                           table_number of id_dep_clin_serv
    *
    * @raises                           PL/SQL generic error "OTHERS"
    *
    * @author                           Amanda Lee
    * @version                          2.7.3.5
    * @since                            2018/06/05
    */
    FUNCTION get_prof_dcs
    (
        i_id_prof        IN professional.id_professional%TYPE,
        i_id_institution IN institution.id_institution%TYPE
    ) RETURN table_number IS
        l_dep_clin_serv_list table_number := table_number();
    BEGIN
        SELECT pdcs.id_dep_clin_serv
          BULK COLLECT
          INTO l_dep_clin_serv_list
          FROM prof_dep_clin_serv pdcs
         WHERE pdcs.id_professional = i_id_prof
           AND pdcs.id_institution = i_id_institution;
    
        RETURN l_dep_clin_serv_list;
    END get_prof_dcs;

    /**
    * Public Function. Get all dep_clin_serv id to a Professional
    *
    * @param i_lang                     Language identification
    * @param i_id_prof                  Professional identification
    * @param i_id_institution           Institution identification
    * @param o_id_dep_clin_serv         dep_clin_serv id list
    * @param o_error                    Error
    *
    * @return                           True or False
    *
    * @raises                           PL/SQL generic error "OTHERS"
    *
    * @author                           Amanda Lee
    * @version                          2.7.3.5
    * @since                            2018/06/05
    */
    FUNCTION get_prof_dcs
    (
        i_lang             IN language.id_language%TYPE,
        i_id_prof          IN professional.id_professional%TYPE,
        i_id_institution   IN institution.id_institution%TYPE,
        o_id_dep_clin_serv OUT table_number,
        o_error            OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        o_id_dep_clin_serv := get_prof_dcs(i_id_prof => i_id_prof, i_id_institution => i_id_institution);
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_DCS',
                                              o_error);
            RETURN FALSE;
    END get_prof_dcs;

    /** @headcom
    * Public Function. Associate Specialties to a Professional
    * Cancela a licenè·
    *
    * @param      i_lang                     Language identification
    * @param      i_id_prof                  Professional identification
    * @param      i_id_institution           Institution identification
    * @param      i_id_dep_clin_serv         Relation between departments and clinical services
    * @param      i_flg                      Flag
    * @param      o_error                    Error
    *
    * @return     boolean
    * @author     Tå»¨cio Soares - JTS
    * @version    0.1
    * @since      2007/07/31
    */
    FUNCTION set_prof_specialties
    (
        i_lang             IN language.id_language%TYPE,
        i_id_prof          IN professional.id_professional%TYPE,
        i_id_institution   IN institution.id_institution%TYPE,
        i_id_dep_clin_serv IN table_number,
        i_flg              IN table_varchar,
        o_error            OUT t_error_out
    ) RETURN BOOLEAN IS
        l_bool BOOLEAN;
    BEGIN
        l_bool := set_prof_specialties_no_commit(i_lang             => i_lang,
                                                 i_id_prof          => i_id_prof,
                                                 i_id_institution   => i_id_institution,
                                                 i_id_dep_clin_serv => i_id_dep_clin_serv,
                                                 i_flg              => i_flg,
                                                 o_error            => o_error);
        IF l_bool
        THEN
            COMMIT;
        END IF;
        RETURN l_bool;
    END set_prof_specialties;

    /**
    * Public Function. Insert New Institution Service OR Update Institution Service Information
    *
    * @param i_lang                     Language identification
    * @param i_id_department            Service identification
    * @param i_id_institution           Institution identification
    * @param i_desc                     Service description
    * @param i_abbreviation             Abreviation
    * @param i_flg_type                 Flg type
    * @param i_id_dept                  Daepartment identification
    * @param i_flg_default              Default department: Y - Yes; N - No
    * @param i_def_priority             (U)rgent/CITO; (N)on Urgent (Deprecated)
    * @param i_collection_by            (L)aboratory or (D)epartment (Deprecated)
    * @param i_floors_institution       Floor institution identifier
    * @param i_change                   Change floor_department
    * @param i_id_admission_type        Type of admission
    * @param i_admission_time           Time of admission
    * @param o_id_department            Department identification
    * @param o_error                    Error
    *
    * @value i_flg_type                 {*} 'C' Outpatient {*} 'U' Emergency department {*} 'I' Inpatient {*} 'S' Operating Room 
    *                                   {*} 'A' Analysis lab. {*} 'P' Clinical patalogy lab. {*} 'T' Pathological anatomy lab 
    *                                   {*} 'R' Radiology {*} 'F' Pharmacy. It may contain combinations (eg AP - Analyses of clinical pathology lab.)
    * @value i_flg_default              {*} 'Y' Yes {*} 'N' No                                     
    * @value i_def_priority             {*} 'U' Urgent/CITO {*} 'N' Non Urgent 
    * @value i_collection_by            {*} 'L' Laboratory {*} 'D' Department
    * @value i_change                   {*} 'Y' Yes {*} 'N' No            
    *
    * @return                           True or False
    *
    * @author                           Amanda Lee
    * @version                          2.7.3.5
    * @since                            2018/06/15
    */
    FUNCTION set_department
    (
        i_lang               IN language.id_language%TYPE,
        i_id_department      IN department.id_department%TYPE,
        i_id_institution     IN department.id_institution%TYPE,
        i_desc               IN VARCHAR2,
        i_abbreviation       IN department.abbreviation%TYPE,
        i_flg_type           IN department.flg_type%TYPE,
        i_id_dept            IN department.id_dept%TYPE,
        i_flg_default        IN department.flg_default%TYPE,
        i_def_priority       IN department.flg_priority%TYPE,
        i_collection_by      IN department.flg_collection_by%TYPE,
        i_floors_institution IN table_number,
        i_change             IN table_varchar,
        i_id_admission_type  IN admission_type.id_admission_type%TYPE,
        i_admission_time     IN VARCHAR2,
        o_id_department      OUT department.id_department%TYPE,
        o_error              OUT t_error_out
    ) RETURN BOOLEAN IS
        l_bool                      BOOLEAN;
        l_id_floors_department_list table_number;
    BEGIN
        --EMR-23160: Flash layer is wrongly sending the addmission time (i_admission_time)
        --This has been done for a COMPAL development, and, for now,
        --it was decided that this value will be sent as NULL
        l_bool := set_department_no_commit(i_lang                 => i_lang,
                                           i_id_department        => i_id_department,
                                           i_id_institution       => i_id_institution,
                                           i_desc                 => i_desc,
                                           i_abbreviation         => i_abbreviation,
                                           i_flg_type             => i_flg_type,
                                           i_id_dept              => i_id_dept,
                                           i_flg_default          => i_flg_default,
                                           i_def_priority         => i_def_priority,
                                           i_collection_by        => i_collection_by,
                                           i_floors_institution   => i_floors_institution,
                                           i_change               => i_change,
                                           i_id_admission_type    => i_id_admission_type,
                                           i_admission_time       => NULL,
                                           o_id_department        => o_id_department,
                                           o_id_floors_department => l_id_floors_department_list,
                                           o_error                => o_error);
        IF l_bool
        THEN
            COMMIT;
        END IF;
        RETURN l_bool;
    END set_department;

    /**
    * Public Function. Get floors_institution
    * 
    * @param i_id_department           Department id
    *
    * @return                          floors_institution list
    *
    * @author                          Amanda Lee
    * @version                         2.7.3.6
    * @since                           2018/06/20
    */
    FUNCTION get_floors_institution(i_id_department IN floors_department.id_department%TYPE) RETURN table_number IS
        l_ret table_number;
    BEGIN
        SELECT fd.id_floors_institution
          BULK COLLECT
          INTO l_ret
          FROM floors_department fd
         WHERE fd.id_department = i_id_department
           AND fd.flg_available = g_flg_available
         ORDER BY fd.id_floors_institution;
    
        RETURN l_ret;
    END get_floors_institution;

    /**
    * Public Function. get_floors_institution
    * 
    * @param i_lang                    Language identification
    * @param i_id_department           Department id
    * @param o_id_floors_institution   id_floors_institution list
    * @param o_error                   Error
    *
    * @return                          True or False
    *
    * @raises                          PL/SQL generic error "OTHERS"
    *
    * @author                          Amanda Lee
    * @version                         2.7.3.6
    * @since                           2018/06/20
    */
    FUNCTION get_floors_institution
    (
        i_lang                  IN language.id_language%TYPE,
        i_id_department         IN floors_department.id_department%TYPE,
        o_id_floors_institution OUT table_number,
        o_error                 OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        o_id_floors_institution := get_floors_institution(i_id_department => i_id_department);
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              k_owner,
                                              k_package_name,
                                              'GET_FLOORS_INSTITUTION',
                                              o_error);
            RETURN FALSE;
    END get_floors_institution;

    /**
    * Insert new room
    *
    * @param i_category                  Room category
    * @param o_flg_prof                  flg_prof
    * @param o_flg_recovery              flg_recovery 
    * @param o_flg_lab                   flg_lab
    * @param o_flg_wait                  flg_wait
    * @param o_flg_wl                    flg_wl
    * @param o_flg_transp                flg_transp
    * @param o_flg_icu                   flg_icu
    * @param o_error                     Error
    *
    * @value i_category                 {*} 'P' l_flg_prof=Y {*} 'R' l_flg_recovery=Y
    *                                   {*} 'L' l_flg_lab=Y  {*} 'W' l_flg_wait=Y
    *                                   {*} 'C' l_flg_wl=Y   {*} 'T' l_flg_transp=Y
    *                                   {*} 'I' l_flg_icu=Y
    * 
    * @return                           true or false on success or error
    *
    * @raises                           PL/SQL generic error "OTHERS" and "user define"
    *
    * @author                           Amanda Lee
    * @version                          2.7.3.5
    * @since                            2018/06/05
    */
    FUNCTION get_room_flags_by_category
    (
        i_category     IN table_varchar,
        o_flg_prof     OUT room.flg_prof%TYPE,
        o_flg_recovery OUT room.flg_recovery%TYPE,
        o_flg_lab      OUT room.flg_lab%TYPE,
        o_flg_wait     OUT room.flg_wait%TYPE,
        o_flg_wl       OUT room.flg_wl%TYPE,
        o_flg_transp   OUT room.flg_transp%TYPE,
        o_flg_icu      OUT room.flg_icu%TYPE
    ) RETURN BOOLEAN IS
    
    BEGIN
        o_flg_prof     := pk_alert_constant.g_no;
        o_flg_recovery := pk_alert_constant.g_no;
        o_flg_lab      := pk_alert_constant.g_no;
        o_flg_wait     := pk_alert_constant.g_no;
        o_flg_wl       := pk_alert_constant.g_no;
        o_flg_transp   := pk_alert_constant.g_no;
        o_flg_icu      := pk_alert_constant.g_no;
    
        IF i_category IS NOT NULL
        THEN
            FOR i IN 1 .. i_category.count
            LOOP
                CASE i_category(i)
                    WHEN 'P' THEN
                        o_flg_prof := pk_alert_constant.g_yes;
                    WHEN 'R' THEN
                        o_flg_recovery := pk_alert_constant.g_yes;
                    WHEN 'L' THEN
                        o_flg_lab := pk_alert_constant.g_yes;
                    WHEN 'W' THEN
                        o_flg_wait := pk_alert_constant.g_yes;
                    WHEN 'C' THEN
                        o_flg_wl := pk_alert_constant.g_yes;
                    WHEN 'T' THEN
                        o_flg_transp := pk_alert_constant.g_yes;
                    WHEN 'I' THEN
                        o_flg_icu := pk_alert_constant.g_yes;
                END CASE;
            END LOOP;
        END IF;
    
        RETURN TRUE;
    END get_room_flags_by_category;

    /**
    * Get current id_room_hist
    *
    * @param i_id_room                   Room id
    * 
    * @return                            Number
    *
    * @author                            Amanda Lee
    * @version                           2.7.3.5
    * @since                             2018/06/14
    */
    FUNCTION get_current_id_room_hist(i_id_room IN room.id_room%TYPE) RETURN NUMBER IS
        l_ret NUMBER;
    BEGIN
        SELECT MAX(rh.id_room_hist)
          INTO l_ret
          FROM room_hist rh
         WHERE rh.id_room = i_id_room;
    
        RETURN l_ret;
    END get_current_id_room_hist;

    /**
    * Public Function. Create or update room
    *
    * @param i_lang                      Language identification
    * @param i_prof                      Professional data
    * @param i_id_room                   Room ID (not null only for the edit operation)
    * @param i_room_name                 Room name
    * @param i_abbreviation              Room abbreviation
    * @param i_category                  Room category
    * @param i_room_type                 Room type
    * @param i_room_service              select room service
    * @param i_room_specialties          list of specialties
    * @param i_flg_selected_spec         Flag that indicates the type of selection of specialties
    * @param i_floors_department         Floors_department id
    * @param i_state                     Room's state
    * @param i_capacity                  Room's patient capacity
    * @param i_rank                      Room's rank
    * @param o_id_room                   Room's id
    * @param o_error                     Error
    *
    * @value i_category                 {*} 'P' l_flg_prof=Y {*} 'R' l_flg_recovery=Y
    *                                   {*} 'L' l_flg_lab=Y  {*} 'W' l_flg_wait=Y
    *                                   {*} 'C' l_flg_wl=Y   {*} 'T' l_flg_transp=Y
    *                                   {*} 'I' l_flg_icu=Y
    * @value i_flg_selected_spec        {*} 'A' All {*} 'N' None {*} 'O' Other
    * @value i_state                    {*} 'Y' Yes {*} 'N' No
    * 
    * @return                           true or false on success or error
    *
    * @raises                           PL/SQL generic error "OTHERS" and "user define"
    *
    * @author                           Amanda Lee
    * @version                          2.7.3.5
    * @since                            2018/06/05
    */
    FUNCTION set_room
    (
        i_lang              IN language.id_language%TYPE,
        i_prof              IN profissional,
        i_id_room           IN room.id_room%TYPE,
        i_room_name         IN VARCHAR2,
        i_abbreviation      IN VARCHAR2,
        i_category          IN table_varchar,
        i_room_type         IN room_type.id_room_type%TYPE,
        i_room_service      IN room.id_department%TYPE,
        i_flg_selected_spec IN room.flg_selected_specialties%TYPE,
        i_floors_department IN floors_department.id_floors_department%TYPE,
        i_state             IN room.flg_available%TYPE,
        i_capacity          IN room.capacity%TYPE,
        i_rank              IN room.rank%TYPE,
        o_id_room           OUT room.id_room%TYPE,
        o_error             OUT t_error_out
    ) RETURN BOOLEAN IS
        l_room_code      VARCHAR2(100 CHAR) := 'ROOM.CODE_ROOM.';
        l_room_abbr_code VARCHAR2(100 CHAR) := 'ROOM.CODE_ABBREVIATION.';
        l_flg_prof       VARCHAR2(001 CHAR);
        l_flg_recovery   VARCHAR2(001 CHAR);
        l_flg_lab        VARCHAR2(001 CHAR);
        l_flg_wait       VARCHAR2(001 CHAR);
        l_flg_wl         VARCHAR2(001 CHAR);
        l_flg_transp     VARCHAR2(001 CHAR);
        l_flg_icu        VARCHAR2(001 CHAR);
    
        l_flg_status room.flg_status%TYPE := pk_alert_constant.g_active;
        l_backoffice_parameterization CONSTANT VARCHAR2(1 CHAR) := 'B';
    
        --created/updated rows
        l_rows_out     table_varchar := table_varchar();
        l_id_room_hist room_hist.id_room_hist%TYPE;
    
        l_count                NUMBER;
        l_id_floors_department NUMBER;
    
        -- ********************************************
        FUNCTION get_floors_department_by_room(i_id_room IN NUMBER) RETURN NUMBER IS
            tbl_fd   table_number;
            l_return NUMBER := 0;
        BEGIN
        
            SELECT r.id_floors_department
              BULK COLLECT
              INTO tbl_fd
              FROM room r
             WHERE r.id_room = i_id_room;
        
            IF tbl_fd.count > 0
            THEN
                l_return := tbl_fd(1);
            END IF;
        
            RETURN l_return;
        
        END get_floors_department_by_room;
    
        FUNCTION get_all_languages RETURN table_number IS
            tbl_lang table_number;
        BEGIN
        
            SELECT id_language
              BULK COLLECT
              INTO tbl_lang
              FROM LANGUAGE
             WHERE flg_available = pk_alert_constant.g_available;
        
            RETURN tbl_lang;
        
        END get_all_languages;
    
        PROCEDURE fill_translation IS
            tbl_lang table_number;
        BEGIN
        
            tbl_lang := get_all_languages();
        
            <<lup_thru_language>>
            FOR i IN 1 .. tbl_lang.count
            LOOP
            
                -- insert or update description               
                pk_translation.insert_into_translation(i_lang       => tbl_lang(i),
                                                       i_code_trans => l_room_code || o_id_room,
                                                       i_desc_trans => i_room_name);
            
                IF i_abbreviation IS NULL
                THEN
                    pk_translation.clean_translation(i_lang => tbl_lang(i), i_code => l_room_abbr_code || o_id_room);
                ELSE
                    pk_translation.insert_into_translation(i_lang       => tbl_lang(i),
                                                           i_code_trans => l_room_abbr_code || o_id_room,
                                                           i_desc_trans => i_abbreviation);
                END IF;
            
            END LOOP lup_thru_language;
        
        END fill_translation;
    
        PROCEDURE del_room_pos(i_floor IN NUMBER) IS
        BEGIN
        
            IF nvl(i_floor, 0) != 0
            THEN
            
                g_error := 'DELETE FROM ROOM_DEP_POSITION';
                DELETE FROM room_dep_position rdp
                 WHERE rdp.id_room = i_id_room;
            
            END IF;
        
        END del_room_pos;
    
    BEGIN
        --Check room name is not null
        IF i_room_name IS NULL
        THEN
            g_error := 'Room name can not null';
            RAISE g_exception;
        END IF;
    
        g_sysdate_tstz := current_timestamp;
        g_error        := 'Get all flag by id_category';
        --room flags:
        --find the room category and set the correspondent flag:
        IF NOT get_room_flags_by_category(i_category     => i_category,
                                          o_flg_prof     => l_flg_prof,
                                          o_flg_recovery => l_flg_recovery,
                                          o_flg_lab      => l_flg_lab,
                                          o_flg_wait     => l_flg_wait,
                                          o_flg_wl       => l_flg_wl,
                                          o_flg_transp   => l_flg_transp,
                                          o_flg_icu      => l_flg_icu)
        THEN
            RAISE g_exception;
        END IF;
    
        g_error := 'Insert or update room';
        IF i_id_room IS NULL
        THEN
            g_error   := 'Create room';
            o_id_room := get_next_value('ROOM', 0);
        ELSE
            g_error      := 'update room';
            o_id_room    := i_id_room;
            l_flg_status := pk_alert_constant.g_flg_status_e;
        
            l_id_floors_department := get_floors_department_by_room(i_id_room);
        
            del_room_pos(l_id_floors_department);
        
        END IF;
    
        ts_room.upd(id_room_in                   => o_id_room,
                    flg_prof_in                  => l_flg_prof,
                    id_department_in             => i_room_service,
                    code_room_in                 => l_room_code || o_id_room,
                    capacity_in                  => i_capacity,
                    capacity_nin                 => NOT (i_capacity IS NULL),
                    flg_recovery_in              => l_flg_recovery,
                    flg_lab_in                   => l_flg_lab,
                    rank_in                      => i_rank,
                    flg_wait_in                  => l_flg_wait,
                    flg_wl_in                    => l_flg_wl,
                    flg_transp_in                => l_flg_transp,
                    code_abbreviation_in         => l_room_abbr_code || o_id_room,
                    id_floors_department_in      => i_floors_department,
                    id_floors_department_nin     => NOT (i_floors_department IS NULL),
                    flg_available_in             => i_state,
                    id_room_type_in              => i_room_type,
                    id_room_type_nin             => NOT (i_room_type IS NULL),
                    flg_status_in                => l_flg_status,
                    flg_parameterization_type_in => l_backoffice_parameterization,
                    id_professional_in           => i_prof.id,
                    dt_creation_in               => g_sysdate_tstz,
                    dt_last_update_in            => g_sysdate_tstz,
                    flg_selected_specialties_in  => i_flg_selected_spec,
                    flg_selected_specialties_nin => NOT (i_flg_selected_spec IS NULL),
                    desc_room_in                 => i_room_name,
                    desc_room_nin                => NOT (i_room_name IS NULL),
                    desc_room_abbreviation_in    => i_abbreviation,
                    desc_room_abbreviation_nin   => NOT (i_abbreviation IS NULL),
                    flg_icu_in                   => l_flg_icu,
                    handle_error_in              => TRUE,
                    rows_out                     => l_rows_out);
        IF SQL%ROWCOUNT = 0
        THEN
            ts_room.ins(id_room_in                   => o_id_room,
                        flg_prof_in                  => l_flg_prof,
                        id_department_in             => i_room_service,
                        code_room_in                 => l_room_code || o_id_room,
                        capacity_in                  => i_capacity,
                        flg_recovery_in              => l_flg_recovery,
                        flg_lab_in                   => l_flg_lab,
                        rank_in                      => i_rank,
                        flg_wait_in                  => l_flg_wait,
                        flg_wl_in                    => l_flg_wl,
                        flg_transp_in                => l_flg_transp,
                        code_abbreviation_in         => l_room_abbr_code || o_id_room,
                        id_floors_department_in      => i_floors_department,
                        flg_available_in             => i_state,
                        id_room_type_in              => i_room_type,
                        flg_status_in                => l_flg_status,
                        flg_parameterization_type_in => l_backoffice_parameterization,
                        id_professional_in           => i_prof.id,
                        dt_creation_in               => g_sysdate_tstz,
                        dt_last_update_in            => g_sysdate_tstz,
                        flg_selected_specialties_in  => i_flg_selected_spec,
                        desc_room_in                 => i_room_name,
                        desc_room_abbreviation_in    => i_abbreviation,
                        flg_icu_in                   => l_flg_icu,
                        rows_out                     => l_rows_out);
            g_error := 'CALL t_data_gov_mnt.process_insert';
            t_data_gov_mnt.process_insert(i_lang       => i_lang,
                                          i_prof       => i_prof,
                                          i_table_name => 'ROOM',
                                          i_rowids     => l_rows_out,
                                          o_error      => o_error);
        ELSE
            g_error := 'CALL t_data_gov_mnt.process_update';
            t_data_gov_mnt.process_update(i_lang       => i_lang,
                                          i_prof       => i_prof,
                                          i_table_name => 'ROOM',
                                          i_rowids     => l_rows_out,
                                          o_error      => o_error);
        END IF;
    
        -- insert or update description  
        fill_translation();
    
        IF NOT set_room_hist(i_lang              => i_lang,
                             i_prof              => i_prof,
                             i_id_room           => o_id_room,
                             i_room_name         => i_room_name,
                             i_abbreviation      => i_abbreviation,
                             i_category          => i_category,
                             i_room_type         => i_room_type,
                             i_room_service      => i_room_service,
                             i_flg_selected_spec => i_flg_selected_spec,
                             i_floors_department => i_floors_department,
                             i_state             => i_state,
                             i_capacity          => i_capacity,
                             i_rank              => i_rank,
                             o_id_room_hist      => l_id_room_hist,
                             o_error             => o_error)
        THEN
            RAISE g_exception;
        END IF;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              k_owner,
                                              k_package_name,
                                              'SET_ROOM',
                                              o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_room;

    /**
    * Insert room history record
    *
    * @param i_lang                      Language identification
    * @param i_prof                      Professional data
    * @param i_id_room                   Room ID (not null only for the edit operation)
    * @param i_room_name                 Room name
    * @param i_abbreviation              Room abbreviation
    * @param i_category                  Room category
    * @param i_room_type                 Room type
    * @param i_room_service              select room service
    * @param i_flg_selected_spec         Flag that indicates the type of selection of specialties
    * @param i_floors_department         Floors_department id
    * @param i_state                     Room's state
    * @param i_capacity                  Room's patient capacity
    * @param i_rank                      Room's rank
    * @param o_id_room_hist              Room's change_hist id
    * @param o_error                     Error
    *
    * @value i_category                 {*} 'P' l_flg_prof=Y {*} 'R' l_flg_recovery=Y
    *                                   {*} 'L' l_flg_lab=Y  {*} 'W' l_flg_wait=Y
    *                                   {*} 'C' l_flg_wl=Y   {*} 'T' l_flg_transp=Y
    *                                   {*} 'I' l_flg_icu=Y
    * 
    * @return                           true or false on success or error
    *
    * @raises                           PL/SQL generic error "OTHERS" and "user define"
    *
    * @author                           Amanda Lee
    * @version                          2.7.3.5
    * @since                            2018/06/05
    */
    FUNCTION set_room_hist
    (
        i_lang              IN language.id_language%TYPE,
        i_prof              IN profissional,
        i_id_room           IN room.id_room%TYPE,
        i_room_name         IN VARCHAR2,
        i_abbreviation      IN VARCHAR2,
        i_category          IN table_varchar,
        i_room_type         IN room_type.id_room_type%TYPE,
        i_room_service      IN room.id_department%TYPE,
        i_flg_selected_spec IN room.flg_selected_specialties%TYPE,
        i_floors_department IN floors_department.id_floors_department%TYPE,
        i_state             IN room.flg_available%TYPE,
        i_capacity          IN room.capacity%TYPE,
        i_rank              IN room.rank%TYPE,
        o_id_room_hist      OUT room_hist.id_room_hist%TYPE,
        o_error             OUT t_error_out
    ) RETURN BOOLEAN IS
        l_room_code      VARCHAR2(100 CHAR) := 'ROOM.CODE_ROOM.';
        l_room_abbr_code VARCHAR2(100 CHAR) := 'ROOM.CODE_ABBREVIATION.';
        l_flg_prof       VARCHAR2(001 CHAR);
        l_flg_recovery   VARCHAR2(001 CHAR);
        l_flg_lab        VARCHAR2(001 CHAR);
        l_flg_wait       VARCHAR2(001 CHAR);
        l_flg_wl         VARCHAR2(001 CHAR);
        l_flg_transp     VARCHAR2(001 CHAR);
        l_flg_icu        VARCHAR2(001 CHAR);
    
        l_backoffice_parameterization CONSTANT VARCHAR2(1 CHAR) := 'B';
    BEGIN
        g_sysdate_tstz := current_timestamp;
        --room flags:
        --find the room category and set the correspondent flag:
        IF NOT get_room_flags_by_category(i_category     => i_category,
                                          o_flg_prof     => l_flg_prof,
                                          o_flg_recovery => l_flg_recovery,
                                          o_flg_lab      => l_flg_lab,
                                          o_flg_wait     => l_flg_wait,
                                          o_flg_wl       => l_flg_wl,
                                          o_flg_transp   => l_flg_transp,
                                          o_flg_icu      => l_flg_icu)
        THEN
            RAISE g_exception;
        END IF;
    
        g_error        := 'Insert into room_hist';
        o_id_room_hist := seq_room_hist.nextval;
        --history
        INSERT INTO room_hist
            (id_room_hist,
             id_room,
             id_department,
             rank,
             flg_available,
             flg_prof,
             flg_recovery,
             flg_lab,
             flg_wait,
             flg_wl,
             flg_transp,
             id_floors_department,
             code_room,
             code_abbreviation,
             id_room_type,
             flg_parameterization_type,
             flg_status,
             flg_selected_specialties,
             id_professional,
             dt_creation,
             dt_last_update,
             desc_room,
             desc_room_abbreviation,
             capacity,
             flg_icu)
        VALUES
            (o_id_room_hist,
             i_id_room,
             i_room_service,
             i_rank,
             i_state,
             l_flg_prof,
             l_flg_recovery,
             l_flg_lab,
             l_flg_wait,
             l_flg_wl,
             l_flg_transp,
             i_floors_department,
             l_room_code || i_id_room,
             l_room_abbr_code || i_id_room,
             i_room_type,
             l_backoffice_parameterization,
             pk_alert_constant.g_flg_status_a,
             i_flg_selected_spec,
             i_prof.id,
             g_sysdate_tstz,
             g_sysdate_tstz,
             i_room_name,
             i_abbreviation,
             i_capacity,
             l_flg_icu);
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              k_owner,
                                              k_package_name,
                                              'INSERT_ROOM_HIST',
                                              o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_room_hist;

    /**
    * Public Function. Insert New Relation Department/Clinical Service Room OR Update Relation Department/Clinical Service Room Information
    *
    * @param i_lang                               Language identification
    * @param i_id_room                            Room identification
    * @param i_id_dep_clin_serv                   Department/clinical service identification 
    * @param o_id_room_dep_clin_serv              Cursor with rooms of departments/clinical services information
    * @param o_error                              Error 
    *
    * @return                                     True or False
    *
    * @author                                     Amanda Lee
    * @version                                    2.7.3.6
    * @since                                      2018/06/20
    */
    FUNCTION set_room_dep_clin_serv
    (
        i_lang               IN language.id_language%TYPE,
        i_id_room            IN room_dep_clin_serv.id_room%TYPE,
        i_dep_clin_serv      IN table_number,
        o_room_dep_clin_serv OUT table_number,
        o_error              OUT t_error_out
    ) RETURN BOOLEAN IS
        l_bool BOOLEAN;
    BEGIN
        l_bool := set_room_dcs_no_commit(i_lang               => i_lang,
                                         i_id_room            => i_id_room,
                                         i_dep_clin_serv      => i_dep_clin_serv,
                                         o_room_dep_clin_serv => o_room_dep_clin_serv,
                                         o_error              => o_error);
    
        IF l_bool
        THEN
            COMMIT;
        END IF;
        RETURN l_bool;
    END set_room_dep_clin_serv;

    /**
    * Create or update a bed.
    *
    * @param i_lang                      Preferred language ID for this professional
    * @param i_prof                      Object (professional ID, institution ID, software ID)
    * @param i_id_room                   Room ID (not null only for the edit operation)
    * @param i_bed_name                  Bed name
    * @param i_bed_type                  Type of bed identifier
    * @param i_bed_flg_selected_spec     Flg indicating the type of selection of specialties
    * @param i_bed_flg_available         Flg_available
    * @param i_bed_date                  Bed date
    * @param i_dep_clin_serv             dep_clin_serv list
    * @param o_id_bed                    Bed id lists
    * @param o_error                     Error
    *
    * @value i_flg_selected_spec        {*} 'A' All {*} 'N' None {*} 'O' Other
    * @value i_bed_flg_available        {*} 'Y' Yes {*} 'N' No
    *
    * @return                           true or false on success or error
    *
    * @raises                           PL/SQL generic error "OTHERS"
    *
    * @author                           Amanda Lee
    * @version                          2.7.3.6
    * @since                            2018/06/14
    */
    FUNCTION set_bed
    (
        i_lang                  IN language.id_language%TYPE,
        i_prof                  IN profissional,
        i_id_room               IN room.id_room%TYPE,
        i_id_bed                IN bed.id_bed%TYPE,
        i_bed_name              IN pk_translation.t_desc_translation,
        i_bed_type              IN bed_type.id_bed_type%TYPE,
        i_bed_flg_selected_spec IN VARCHAR2,
        i_bed_flg_available     IN bed.flg_available%TYPE,
        i_bed_date              IN VARCHAR2 DEFAULT NULL,
        o_id_bed                OUT bed.id_bed%TYPE,
        o_error                 OUT t_error_out
    ) RETURN BOOLEAN IS
        l_bed_code VARCHAR2(100 CHAR) := 'BED.CODE_BED.';
    
        --created/updated rows
        l_rows_out table_varchar := table_varchar();
        l_bed_row  bed%ROWTYPE;
    
        l_flg_type                  bed.flg_type%TYPE := pk_backoffice_adm_surgery.g_bed_type_permanent_p;
        l_flg_status                bed.flg_status%TYPE := pk_backoffice_adm_surgery.g_bed_occupation_v;
        l_bed_status                bed.flg_bed_status%TYPE := pk_alert_constant.g_flg_status_a;
        l_flg_parameterization_type bed.flg_parameterization_type%TYPE := pk_backoffice_adm_surgery.g_backoffice_parameterization;
    
        l_id_bed_hist bed_hist.id_bed_hist%TYPE;
    BEGIN
        --Check bed name is not null
        IF i_bed_name IS NULL
        THEN
            g_error := 'Bed name can not null';
            RAISE g_exception;
        END IF;
    
        IF i_bed_date IS NOT NULL
        THEN
            g_sysdate_tstz := pk_date_utils.get_string_tstz(i_lang      => i_lang,
                                                            i_prof      => i_prof,
                                                            i_timestamp => i_bed_date,
                                                            i_timezone  => NULL);
        ELSE
            g_sysdate_tstz := current_timestamp;
        END IF;
    
        IF i_id_bed IS NULL
        THEN
            g_error := 'INSERT_INTO BED: i_beds_name =' || i_bed_name;
            pk_alertlog.log_debug(g_error);
            o_id_bed := ts_bed.next_key;
        
        ELSE
            g_error := 'UPDATE BED';
            pk_alertlog.log_debug(g_error);
            o_id_bed := i_id_bed;
        
            --history
            SELECT *
              INTO l_bed_row
              FROM bed b
             WHERE b.id_bed = o_id_bed;
        
            l_bed_status := pk_alert_constant.g_flg_status_e;
            l_flg_status := l_bed_row.flg_status;
        END IF;
    
        ts_bed.upd(id_bed_in                    => o_id_bed,
                   code_bed_in                  => l_bed_code || o_id_bed,
                   id_room_in                   => i_id_room,
                   flg_type_in                  => l_flg_type,
                   flg_status_in                => l_flg_status,
                   desc_bed_in                  => i_bed_name,
                   desc_bed_nin                 => NOT (i_bed_name IS NULL),
                   flg_available_in             => i_bed_flg_available,
                   id_bed_type_in               => i_bed_type,
                   id_bed_type_nin              => NOT (i_bed_type IS NULL),
                   dt_creation_in               => g_sysdate_tstz,
                   flg_bed_status_in            => l_bed_status,
                   flg_bed_status_nin           => NOT (l_bed_status IS NULL),
                   flg_parameterization_type_in => l_flg_parameterization_type,
                   id_professional_in           => i_prof.id,
                   dt_last_update_in            => g_sysdate_tstz,
                   flg_selected_specialties_in  => i_bed_flg_selected_spec,
                   flg_selected_specialties_nin => NOT (i_bed_flg_selected_spec IS NULL),
                   handle_error_in              => TRUE,
                   rows_out                     => l_rows_out);
        IF SQL%ROWCOUNT = 0
        THEN
            ts_bed.upd_ins(id_bed_in                    => o_id_bed,
                           code_bed_in                  => l_bed_code || o_id_bed,
                           id_room_in                   => i_id_room,
                           flg_type_in                  => l_flg_type,
                           flg_status_in                => l_flg_status,
                           desc_bed_in                  => i_bed_name,
                           flg_available_in             => i_bed_flg_available,
                           id_bed_type_in               => i_bed_type,
                           dt_creation_in               => g_sysdate_tstz,
                           flg_bed_status_in            => l_bed_status,
                           flg_parameterization_type_in => l_flg_parameterization_type,
                           id_professional_in           => i_prof.id,
                           dt_last_update_in            => g_sysdate_tstz,
                           flg_selected_specialties_in  => i_bed_flg_selected_spec,
                           rows_out                     => l_rows_out);
            g_error := 'CALL t_data_gov_mnt.process_insert';
            t_data_gov_mnt.process_insert(i_lang       => i_lang,
                                          i_prof       => i_prof,
                                          i_table_name => 'BED',
                                          i_rowids     => l_rows_out,
                                          o_error      => o_error);
        ELSE
            g_error := 'CALL t_data_gov_mnt.process_update';
            t_data_gov_mnt.process_update(i_lang       => i_lang,
                                          i_prof       => i_prof,
                                          i_table_name => 'BED',
                                          i_rowids     => l_rows_out,
                                          o_error      => o_error);
        END IF;
    
        -- Insert or update description                
        pk_translation.insert_into_translation(i_lang       => i_lang,
                                               i_code_trans => l_bed_code || o_id_bed,
                                               i_desc_trans => i_bed_name);
    
        IF NOT set_bed_hist(i_lang                      => i_lang,
                            i_prof                      => i_prof,
                            i_id_room                   => i_id_room,
                            i_id_room_hist              => NULL,
                            i_id_bed                    => o_id_bed,
                            i_bed_name                  => i_bed_name,
                            i_bed_type                  => i_bed_type,
                            i_bed_flg_selected_spec     => i_bed_flg_selected_spec,
                            i_bed_flg_available         => i_bed_flg_available,
                            i_flg_bed_status            => l_bed_status,
                            i_flg_parameterization_type => l_flg_parameterization_type,
                            o_id_bed_hist               => l_id_bed_hist,
                            o_error                     => o_error)
        THEN
            RAISE g_exception;
        END IF;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              k_owner,
                                              k_package_name,
                                              'SET_BED',
                                              o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_bed;

    /**
    * Public Function. Insert New Relation Room/Dep Clinical Service
    *
    * @param i_lang                         Preferred language ID for this professional
    * @param i_id_bed                       Bed id
    * @param i_dep_clin_serv                Dep_clin_serv id list
    * @param o_bed_dep_clin_serv            Dep_clin_serv id list
    * @param o_error                        error
    *
    * @return                               true or false on success or error
    *
    * @raises                               PL/SQL generic error "OTHERS"
    *
    * @author                               Amanda Lee
    * @version                              2.7.3.6
    * @since                                2018/06/14
    */
    FUNCTION set_bed_dep_clin_serv
    (
        i_lang          IN language.id_language%TYPE,
        i_id_bed        IN bed_dep_clin_serv.id_bed%TYPE,
        i_dep_clin_serv IN table_number,
        ---o_bed_dep_clin_serv OUT table_number,
        o_error OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        g_error := 'Remove bed_dep_clin_serv';
        DELETE FROM bed_dep_clin_serv bdcs
         WHERE bdcs.id_bed = i_id_bed;
    
        g_error := 'Create bed_dep_clin_serv';
        FORALL i IN 1 .. i_dep_clin_serv.count
            INSERT INTO bed_dep_clin_serv
                (id_bed, id_dep_clin_serv, flg_available)
            VALUES
                (i_id_bed, i_dep_clin_serv(i), pk_alert_constant.g_yes);
    
        IF NOT set_bed_dcs_hist(i_lang          => i_lang,
                                i_id_bed        => i_id_bed,
                                i_dep_clin_serv => i_dep_clin_serv,
                                o_error         => o_error)
        THEN
            RAISE g_exception;
        END IF;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              k_owner,
                                              k_package_name,
                                              'SET_BED_DEP_CLIN_SERV',
                                              o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_bed_dep_clin_serv;

    /**
    * Public Function. Insert New Relation Room/Dep Clinical Service
    *
    * @param i_lang                         Preferred language ID for this professional
    * @param i_prof                         Object (professional ID, institution ID, software ID)
    * @param i_id_room                      Room id
    * @param i_id_room_hist                 Room hist id
    * @param i_bed                          Bed id
    * @param i_bed_name                     Bed name
    * @param i_bed_type                     Bed type
    * @param i_bed_flg_selected_spec        Flg indicating the type of selection of specialties
    * @param i_bed_flg_available            Flg_bed_status
    * @param i_flg_parameterization_type    Type of parameterization used to create this data
    *
    * @value i_flg_selected_spec            {*} 'A' All {*} 'N' None {*} 'O' Other
    * @value i_bed_flg_available            {*} 'A' Active {*} 'I' Inactive
    * @value i_flg_parameterization_type    {*} 'C' configurations team {*} 'B' backoffice
    *
    * @return                               true or false on success or error
    *
    * @raises                               PL/SQL generic error "OTHERS"
    *
    * @author                               Amanda Lee
    * @version                              2.7.3.6
    * @since                                2018/06/14
    */
    FUNCTION set_bed_hist
    (
        i_lang                      IN language.id_language%TYPE,
        i_prof                      IN profissional,
        i_id_room                   IN room.id_room%TYPE,
        i_id_room_hist              IN room_hist.id_room_hist%TYPE,
        i_id_bed                    IN bed.id_bed%TYPE,
        i_bed_name                  IN pk_translation.t_desc_translation,
        i_bed_type                  IN bed_type.id_bed_type%TYPE,
        i_bed_flg_selected_spec     IN VARCHAR2,
        i_bed_flg_available         IN bed.flg_available%TYPE,
        i_flg_bed_status            IN VARCHAR2,
        i_flg_parameterization_type IN bed.flg_parameterization_type%TYPE,
        o_id_bed_hist               OUT bed_hist.id_bed_hist%TYPE,
        o_error                     OUT t_error_out
    ) RETURN BOOLEAN IS
        l_bed_code     VARCHAR2(100 CHAR) := 'BED.CODE_BED.';
        l_bed_row      bed%ROWTYPE;
        l_id_room_hist room_hist.id_room_hist%TYPE := i_id_room_hist;
    BEGIN
    
        IF i_id_room_hist IS NULL
        THEN
        
            l_id_room_hist := get_current_id_room_hist(i_id_room => i_id_room);
        
        END IF;
    
        --history
        SELECT *
          INTO l_bed_row
          FROM bed b
         WHERE b.id_bed = i_id_bed;
    
        o_id_bed_hist := seq_bed_hist.nextval;
        INSERT INTO bed_hist
            (id_bed_hist,
             id_bed,
             code_bed,
             id_room_hist,
             flg_type,
             flg_status,
             flg_available,
             id_bed_type,
             flg_bed_status,
             flg_parameterization_type,
             id_professional,
             flg_selected_specialties,
             desc_bed,
             dt_creation,
             dt_last_update)
        VALUES
            (o_id_bed_hist,
             i_id_bed,
             l_bed_code || o_id_bed_hist,
             l_id_room_hist,
             l_bed_row.flg_type,
             l_bed_row.flg_status,
             i_bed_flg_available,
             i_bed_type,
             i_flg_bed_status,
             i_flg_parameterization_type,
             i_prof.id,
             i_bed_flg_selected_spec,
             i_bed_name,
             g_sysdate_tstz,
             g_sysdate_tstz);
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              k_owner,
                                              k_package_name,
                                              'SET_BED_HIST',
                                              o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_bed_hist;

    /**
    * Insert the history of the bed_dep_clin_serv
    *
    * @param i_lang                     Preferred language ID for this professional
    * @param i_id_bed_hist              Bed ID History
    * @param i_id_bed                   Bed ID
    * @param o_error                    Error
    *
    * @return                           true or false on success or error
    *
    * @author                           Amanda Lee
    * @version                          2.7.3.6
    * @since                            2018/06/14
    */
    FUNCTION set_bed_dcs_hist
    (
        i_lang          IN language.id_language%TYPE,
        i_id_bed        IN bed.id_bed%TYPE,
        i_dep_clin_serv IN table_number,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
        l_rows_out table_varchar := table_varchar();
    BEGIN
    
        FOR item_bed_hist IN 1 .. i_dep_clin_serv.count
        LOOP
            ts_bed_dep_clin_serv_hist.ins(id_bed_hist_in      => seq_bed_hist.nextval,
                                          id_dep_clin_serv_in => i_dep_clin_serv(item_bed_hist),
                                          id_bed_in           => i_id_bed,
                                          rows_out            => l_rows_out);
        END LOOP;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              k_owner,
                                              k_package_name,
                                              'INSERT_ROOM_HIST',
                                              o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_bed_dcs_hist;

    /**
    * Public Function. Get all available clinical service
    * 
    *
    * @return                          Clinical service list
    *
    * @author                          Amanda Lee
    * @version                         2.7.3.6
    * @since                           2018/06/27
    */
    FUNCTION get_clinical_service_list RETURN table_number IS
        l_ret table_number;
    BEGIN
        SELECT cs.id_clinical_service
          BULK COLLECT
          INTO l_ret
          FROM clinical_service cs
         WHERE cs.flg_available = pk_alert_constant.g_yes
         ORDER BY cs.id_clinical_service;
    
        RETURN l_ret;
    END get_clinical_service_list;

    /**
    * Public Function. Public Function. Get all available clinical service
    * 
    * @param i_lang                       Language identification
    * @param o_id_clinical_service_list   Clinical service list  
    * @param o_error                      Error
    *
    * @return                             True or False
    *
    * @raises                             PL/SQL generic error "OTHERS"
    *
    * @author                             Amanda Lee
    * @version                            2.7.3.6
    * @since                              2018/06/27
    */
    FUNCTION get_clinical_service_list
    (
        i_lang                     IN language.id_language%TYPE,
        o_id_clinical_service_list OUT table_number,
        o_error                    OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        o_id_clinical_service_list := get_clinical_service_list;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              k_owner,
                                              k_package_name,
                                              'GET_CLINICAL_SERVICE_LIST',
                                              o_error);
            RETURN FALSE;
    END get_clinical_service_list;

    /**
    * Public Function. set dep_clin_serv
    * 
    * @param i_lang                    Language identification
    * @param i_id_department           Insert department id
    * @param i_id_clin_service         Insert clinical service id list
    * @param o_id_dep_clin_serv        dep_clin_serv id list
    * @param o_error                   Error
    *
    * @return                          True or False
    *
    * @raises                          PL/SQL generic error "OTHERS"
    *
    * @author                          Amanda Lee
    * @version                         2.7.3.6
    * @since                           2018/06/20
    */
    FUNCTION set_dep_clin_serv_no_commit
    (
        i_lang             IN language.id_language%TYPE,
        i_id_department    IN department.id_department%TYPE,
        i_id_clin_service  IN table_number,
        o_id_dep_clin_serv OUT table_number,
        o_error            OUT t_error_out
    ) RETURN BOOLEAN IS
        l_id_dep_clin_serv dep_clin_serv.id_dep_clin_serv%TYPE;
    
        FUNCTION get_dcs(i_cli_serv IN NUMBER) RETURN NUMBER IS
            tbl_dcs  table_number;
            l_return NUMBER;
        BEGIN
        
            SELECT dcs.id_dep_clin_serv
              BULK COLLECT
              INTO tbl_dcs
              FROM dep_clin_serv dcs
             WHERE dcs.id_department = i_id_department
               AND dcs.id_clinical_service = i_cli_serv;
        
            IF tbl_dcs.count > 0
            THEN
                l_return := tbl_dcs(1);
            END IF;
        
            RETURN l_return;
        
        END get_dcs;
    
    BEGIN
        o_id_dep_clin_serv := table_number();
        g_sysdate          := SYSDATE;
        g_error            := 'Del all dep_clin_serv id for id_department';
        UPDATE dep_clin_serv dcs
           SET dcs.flg_available = pk_alert_constant.g_no
         WHERE dcs.id_department = i_id_department;
    
        g_error := 'Insert or update dep_clin_serv id for id_deparment';
        FOR i IN 1 .. i_id_clin_service.count
        LOOP
        
            l_id_dep_clin_serv := get_dcs(i_cli_serv => i_id_clin_service(i));
        
            IF l_id_dep_clin_serv IS NULL
            THEN
                l_id_dep_clin_serv := seq_dep_clin_serv.nextval;
            
                INSERT INTO dep_clin_serv
                    (id_dep_clin_serv, id_clinical_service, id_department, rank, adw_last_update, flg_available)
                VALUES
                    (l_id_dep_clin_serv, i_id_clin_service(i), i_id_department, 1, g_sysdate, pk_alert_constant.g_yes);
            ELSE
                UPDATE dep_clin_serv dcs
                   SET dcs.flg_available = pk_alert_constant.g_yes
                 WHERE dcs.id_department = i_id_department
                   AND dcs.id_dep_clin_serv = l_id_dep_clin_serv;
            END IF;
        
            o_id_dep_clin_serv.extend;
            o_id_dep_clin_serv(o_id_dep_clin_serv.last) := l_id_dep_clin_serv;
        END LOOP;
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              k_owner,
                                              k_package_name,
                                              'SET_DEP_CLIN_SERV_NO_COMMIT',
                                              o_error);
            pk_utils.undo_changes;
            RETURN FALSE;
    END set_dep_clin_serv_no_commit;

    /**
    * Public Function. Create or update dept
    *
    * @param i_lang                      Language identification
    * @param i_id_dept                   Dept id
    * @param i_desc                      Dept name
    * @param i_id_institution            Institution identification
    * @param i_abbreviation              Department abbreviation
    * @param i_flg_available             Record availability
    * @param i_software                  Software identification
    * @param i_change                    Change
    * @param o_id_dept                   Dept id
    * @param o_error                     Error
    *
    * @value i_change                    {*} 'Y' Yes {*} 'N' No
    * @value i_flg_available             {*} 'Y' yes {*} 'N' No
    *
    * @return                            true or false on success or error
    *
    * @raises                            PL/SQL generic error "OTHERS" and "user define"
    *
    * @author                            Kelsey Lai
    * @version                           2.7.3.6
    * @since                             2018/06/19
    */
    FUNCTION set_dept_no_commit
    (
        i_lang           IN language.id_language%TYPE,
        i_id_dept        IN dept.id_dept%TYPE,
        i_dept_desc      IN VARCHAR2,
        i_id_institution IN dept.id_institution%TYPE,
        i_abbreviation   IN dept.abbreviation%TYPE,
        i_flg_available  IN dept.flg_available%TYPE DEFAULT NULL,
        i_software       IN table_number,
        i_change         IN table_varchar,
        o_id_dept        OUT dept.id_dept%TYPE,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
        l_code          VARCHAR2(200 CHAR);
        l_id_dept       dept.id_dept%TYPE;
        l_flg_available dept.flg_available%TYPE := nvl(i_flg_available, pk_alert_constant.g_available);
        l_input         table_varchar := table_varchar(i_lang, i_dept_desc, i_id_institution);
        l_input_name    table_varchar := table_varchar('i_lang', 'i_dept_desc', 'i_id_institution');
    
        PROCEDURE local_exception IS
        BEGIN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              k_owner,
                                              k_package_name,
                                              'SET_DEPT_NO_COMMIT',
                                              o_error);
        
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
        END local_exception;
    
        --insert software_dept
        PROCEDURE set_software_dept
        (
            i_id_software IN software.id_software%TYPE,
            i_id_dept     IN dept.id_dept%TYPE
        ) IS
            l_id_software_dept NUMBER;
        BEGIN
            g_error := 'INSERT INTO SOFTWARE_DEPT';
        
            l_id_software_dept := get_next_value('SOFTWARE_DEPT', i_id_institution);
            INSERT INTO software_dept
                (id_software_dept, id_software, id_dept)
            VALUES
                (l_id_software_dept, i_id_software, i_id_dept);
        
        END set_software_dept;
    
        FUNCTION get_code_dept(i_id_dept IN dept.id_dept %TYPE) RETURN VARCHAR2 IS
        BEGIN
            RETURN 'DEPT.CODE_DEPT.' || i_id_dept;
        END get_code_dept;
    
    BEGIN
        g_error := 'INTO SET_DEPT_NO_COMMIT';
        --check arguments
        FOR i IN 1 .. l_input.count
        LOOP
            IF l_input(i) IS NULL
            THEN
                g_error := 'The argument ' || l_input_name(i) || ' cannot be null!';
                RAISE my_exception;
            END IF;
        END LOOP;
    
        IF i_id_dept IS NULL
        THEN
            g_error   := 'GET SEQ_DEPT.NEXTVAL';
            l_id_dept := get_next_value('DEPT', i_id_institution);
        
            l_code  := get_code_dept(l_id_dept);
            g_error := 'INSERT INTO DEPT';
        
            INSERT INTO dept
                (id_dept, code_dept, rank, id_institution, abbreviation, flg_available)
            VALUES
                (l_id_dept, l_code, 0, i_id_institution, i_abbreviation, l_flg_available);
        
            FOR i IN 1 .. i_software.count
            LOOP
                IF i_change(i) = 'Y'
                THEN
                    set_software_dept(i_software(i), l_id_dept);
                END IF;
            END LOOP;
        
        ELSE
            g_error := 'UPDATE DEPT';
            UPDATE dept
               SET rank           = 0,
                   id_institution = i_id_institution,
                   abbreviation   = i_abbreviation,
                   flg_available  = l_flg_available
             WHERE dept.id_dept = i_id_dept;
        
            l_id_dept := i_id_dept;
        
            FOR i IN 1 .. i_software.count
            LOOP
                IF i_change(i) = 'Y'
                THEN
                    set_software_dept(i_software(i), l_id_dept);
                ELSE
                    g_error := 'DELETE FROM SOFTWARE_DEPT';
                    DELETE FROM software_dept sd
                     WHERE sd.id_dept = i_id_dept
                       AND sd.id_software = i_software(i);
                END IF;
            END LOOP;
        
        END IF;
    
        l_code := get_code_dept(l_id_dept);
        pk_translation.insert_into_translation(i_lang, l_code, i_dept_desc);
    
        o_id_dept := l_id_dept;
        RETURN TRUE;
    
    EXCEPTION
        WHEN my_exception THEN
            local_exception();
            RETURN FALSE;
        
        WHEN OTHERS THEN
            local_exception();
            RETURN FALSE;
        
    END set_dept_no_commit;

    /**
    * Public Function. Create or update building
    *
    * @param i_lang                      Language identification
    * @param i_id_building               Building id
    * @param i_building_desc             Building name
    * @param i_id_institution            Institution id
    * @param i_flg_available             Record availability
    * @param o_id_building               Building id
    * @param o_error                     Error
    *
    * @value i_flg_available             {*} 'Y' yes {*} 'N' No
    *
    * @return                            true or false on success or error
    *
    * @raises                            PL/SQL generic error "OTHERS" and "user define"
    *
    * @author                            Kelsey Lai
    * @version                           2.7.3.6
    * @since                             2018/06/19
    */
    FUNCTION set_building
    (
        i_lang           IN language.id_language%TYPE,
        i_id_building    IN building.id_building%TYPE,
        i_building_desc  IN VARCHAR2,
        i_id_institution IN institution.id_institution%TYPE,
        i_flg_available  IN building.flg_available%TYPE DEFAULT NULL,
        o_id_building    OUT building.id_building%TYPE,
        o_error          OUT t_error_out
    ) RETURN BOOLEAN IS
        l_code          VARCHAR2(200 CHAR);
        l_id_building   building.id_building%TYPE;
        l_flg_available building.flg_available%TYPE := nvl(i_flg_available, pk_alert_constant.g_available);
        l_input         table_varchar := table_varchar(i_lang, i_building_desc);
        l_input_name    table_varchar := table_varchar('i_lang', 'i_building_desc');
    
        PROCEDURE local_exception IS
        BEGIN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              k_owner,
                                              k_package_name,
                                              'SET_BUILDING',
                                              o_error);
        
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
        END local_exception;
    
        FUNCTION get_code_building(i_id_building IN building.id_building%TYPE) RETURN VARCHAR2 IS
        BEGIN
            RETURN 'BUILDING.CODE_BUILDING.' || i_id_building;
        END get_code_building;
    
    BEGIN
        g_error := 'INTO SET_BUILDING';
    
        --check arguments
        FOR i IN 1 .. l_input.count
        LOOP
            IF l_input(i) IS NULL
            THEN
                g_error := 'The argument ' || l_input_name(i) || ' cannot be null!';
                RAISE my_exception;
            END IF;
        END LOOP;
    
        IF i_id_building IS NULL
        THEN
            g_error       := 'get seq_building.nextval';
            l_id_building := get_next_value('BUILDING', i_id_institution);
            l_code        := get_code_building(l_id_building);
        
            g_error := 'insert into building';
            INSERT INTO building
                (id_building, code_building, flg_available, id_institution)
            VALUES
                (l_id_building, l_code, l_flg_available, i_id_institution);
        
        ELSE
            g_error       := 'update building';
            l_code        := get_code_building(i_id_building);
            l_id_building := i_id_building;
        
            UPDATE building b
               SET b.id_institution = i_id_institution, b.flg_available = l_flg_available
             WHERE b.id_building = i_id_building;
        
        END IF;
    
        --insert or update bulding description
        pk_translation.insert_into_translation(i_lang, l_code, i_building_desc);
        o_id_building := l_id_building;
    
        RETURN TRUE;
    EXCEPTION
        WHEN my_exception THEN
            local_exception();
        
            RETURN FALSE;
        WHEN OTHERS THEN
            local_exception();
            RETURN FALSE;
        
    END set_building;

    /**
    * Public Function. Create or update floors
    *
    * @param i_lang                     Language identification
    * @param i_id_floors                Floors id
    * @param i_rank                     Rank
    * @param i_image_plant              Contains imagem plant swf file
    * @param i_id_institution           Institution id
    * @param i_id_building              Building id
    * @param i_flg_available            Record availability
    * @param o_id_floors                Floors's id
    * @param o_id_floors_institution    Floors_institution id
    * @param o_error                    Error
    *
    * @value i_flg_available            {*} 'Y' yes {*} 'N' No
    *
    * @return                           true or false on success or error
    *
    * @raises                           PL/SQL generic error "OTHERS" and "user define"
    *
    * @author                           Kelsey Lai
    * @version                          2.7.3.6
    * @since                            2018/06/19
    */
    FUNCTION set_floors
    (
        i_lang                  IN language.id_language%TYPE,
        i_id_floors             IN floors.id_floors%TYPE,
        i_rank                  IN floors.rank%TYPE DEFAULT 0,
        i_image_plant           IN floors.image_plant%TYPE,
        i_floors_desc           IN VARCHAR2,
        i_id_institution        IN institution.id_institution%TYPE,
        i_id_building           IN building.id_building%TYPE,
        i_flg_available         IN floors.flg_available%TYPE DEFAULT NULL,
        o_id_floors             OUT floors.id_floors%TYPE,
        o_id_floors_institution OUT floors_institution.id_floors_institution%TYPE,
        o_error                 OUT t_error_out
    ) RETURN BOOLEAN IS
        l_code          VARCHAR2(200 CHAR);
        l_id_floors     floors.id_floors%TYPE;
        l_flg_available floors.flg_available%TYPE := nvl(i_flg_available, pk_alert_constant.g_available);
        l_input         table_varchar := table_varchar(i_lang, i_floors_desc, i_id_institution, i_id_building);
        l_input_name    table_varchar := table_varchar('i_lang', 'i_floors_desc', 'i_id_institution', 'i_id_building');
    
        PROCEDURE local_exception IS
        BEGIN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              k_owner,
                                              k_package_name,
                                              'SET_FLOORS',
                                              o_error);
        
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
        END local_exception;
    
        FUNCTION get_code_floors(i_id_floors IN floors.id_floors%TYPE) RETURN VARCHAR2 IS
        BEGIN
            g_error := 'INTO GET_CODE_FLOORS';
            RETURN 'FLOORS.CODE_FLOORS.' || i_id_floors;
        END get_code_floors;
    
    BEGIN
        g_error := 'INTO SET_FLOOR';
    
        --check arguments
        FOR i IN 1 .. l_input.count
        LOOP
            IF l_input(i) IS NULL
            THEN
                g_error := 'The argument ' || l_input_name(i) || ' cannot be null!';
                RAISE my_exception;
            END IF;
        END LOOP;
    
        IF i_id_floors IS NULL
        THEN
            g_error     := 'get seq_floors.nextval';
            l_id_floors := get_next_value('FLOORS', i_id_institution);
        
            l_code  := get_code_floors(l_id_floors);
            g_error := 'INSERT INTO floors';
            --insert floors
            INSERT INTO floors
                (id_floors, code_floors, image_plant, rank, flg_available)
            VALUES
                (l_id_floors, l_code, i_image_plant, i_rank, l_flg_available);
        
            --insert floors_institution
            IF NOT set_floors_institution(i_id_floors_institution => NULL,
                                          i_lang                  => i_lang,
                                          i_id_floors             => l_id_floors,
                                          i_id_institution        => i_id_institution,
                                          i_id_building           => i_id_building,
                                          i_flg_available         => i_flg_available,
                                          o_id_floors_institution => o_id_floors_institution,
                                          o_error                 => o_error)
            THEN
                g_error := 'Set floors_institution fail';
                RAISE my_exception;
            END IF;
        ELSE
            l_code      := get_code_floors(i_id_floors);
            l_id_floors := i_id_floors;
            g_error     := 'UPDATE floors';
            UPDATE floors f
               SET f.image_plant = i_image_plant, f.flg_available = l_flg_available, f.rank = i_rank
             WHERE f.id_floors = i_id_floors;
        END IF;
    
        -- insert or update description
        pk_translation.insert_into_translation(i_lang => i_lang, i_code_trans => l_code, i_desc_trans => i_floors_desc);
    
        o_id_floors := l_id_floors;
        RETURN TRUE;
    EXCEPTION
        WHEN my_exception THEN
            local_exception();
            RETURN FALSE;
        
        WHEN OTHERS THEN
            local_exception();
            RETURN FALSE;
    END set_floors;

    /**
    * Public Function. insert or update floors_institution
    *
    * @param i_lang                     Language identification
    * @param i_id_floors_institution    Floors_institution id
    * @param i_id_floors                Floors id
    * @param i_id_institution           Institution id
    * @param i_id_building              Building id
    * @param i_flg_available            Record availability
    * @param o_id_floors_institution    Floors_institution id
    * @param o_error                    Error
    *
    * @value i_flg_available            {*} 'Y' yes {*} 'N' No
    *
    * @return                           true or false on success or error
    *
    * @raises                           PL/SQL generic error "OTHERS" and "user define"
    *
    * @author                           Kelsey Lai
    * @version                          2.7.3.5
    * @since                            2018/06/19
    */
    FUNCTION set_floors_institution
    (
        i_lang                  IN language.id_language%TYPE,
        i_id_floors_institution IN floors_institution.id_floors_institution%TYPE,
        i_id_floors             IN floors.id_floors%TYPE,
        i_id_institution        IN institution.id_institution%TYPE,
        i_id_building           IN floors_institution.id_building%TYPE,
        i_flg_available         IN floors_institution.flg_available%TYPE DEFAULT NULL,
        o_id_floors_institution OUT floors_institution.id_floors_institution%TYPE,
        o_error                 OUT t_error_out
    ) RETURN BOOLEAN IS
        l_id_floors_institution floors_institution.id_floors_institution%TYPE;
        l_flg_available         floors_institution.flg_available%TYPE := nvl(i_flg_available,
                                                                             pk_alert_constant.g_available);
        l_input                 table_varchar := table_varchar(i_lang, i_id_floors, i_id_institution, i_id_building);
        l_input_name            table_varchar := table_varchar('i_lang',
                                                               'i_id_floors',
                                                               'i_id_institution',
                                                               'i_id_building');
    
        PROCEDURE local_exception IS
        BEGIN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              k_owner,
                                              k_package_name,
                                              'SET_FLOORS_INSTITUTION',
                                              o_error);
        
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
        END local_exception;
    
    BEGIN
    
        g_error := 'INTO  SET_FLOORS_INSTITUTION';
    
        --check arguments
        FOR i IN 1 .. l_input.count
        LOOP
            IF l_input(i) IS NULL
            THEN
                g_error := 'The argument ' || l_input_name(i) || ' cannot be null!';
                RAISE my_exception;
            END IF;
        END LOOP;
    
        --Insert floors_institution
        IF i_id_floors_institution IS NULL
        THEN
            g_error                 := 'get floors_institution.nextval';
            l_id_floors_institution := get_next_value('FLOORS_INSTITUTION', i_id_institution);
        
            g_error := 'INSERT INTO floors_institution';
            INSERT INTO floors_institution
                (id_floors_institution, id_floors, id_institution, flg_available, id_building)
            VALUES
                (l_id_floors_institution, i_id_floors, i_id_institution, l_flg_available, i_id_building);
        
        ELSE
            g_error                 := 'UPDATE floors_institution';
            l_id_floors_institution := i_id_floors_institution;
        
            UPDATE floors_institution fi
               SET fi.id_floors      = i_id_floors,
                   fi.id_institution = i_id_institution,
                   fi.id_building    = i_id_building,
                   fi.flg_available  = i_flg_available
             WHERE fi.id_floors_institution = i_id_floors_institution;
        END IF;
    
        o_id_floors_institution := l_id_floors_institution;
    
        RETURN TRUE;
    EXCEPTION
        WHEN my_exception THEN
            local_exception();
            RETURN FALSE;
        WHEN OTHERS THEN
            local_exception();
            RETURN FALSE;
        
    END set_floors_institution;

    FUNCTION get_prof_func_all
    (
        i_lang      IN language.id_language%TYPE,
        i_prof      IN profissional,
        o_prof_func OUT table_varchar,
        o_error     OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        o_prof_func := pk_prof_utils.get_prof_func_all(i_lang => i_lang, i_prof => i_prof);
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_FUNC_ALL',
                                              o_error);
            RETURN FALSE;
    END get_prof_func_all;

    FUNCTION get_prof_id_by_doc_type
    (
        i_lang        IN language.id_language%TYPE,
        i_prof        IN profissional,
        i_doc_type    IN prof_doc.id_doc_type%TYPE,
        i_doc_value   IN prof_doc.value%TYPE,
        i_institution IN NUMBER,
        o_prof        OUT NUMBER,
        o_error       OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        BEGIN
            SELECT p.id_professional
              INTO o_prof
              FROM prof_doc p
             WHERE p.value = i_doc_value
               AND p.id_institution = i_institution
               AND p.id_doc_type = i_doc_type;
        EXCEPTION
            WHEN no_data_found THEN
                RETURN NULL;
        END;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROF_ID_BY_DOC_TYPE',
                                              o_error);
            RETURN FALSE;
    END get_prof_id_by_doc_type;

    FUNCTION get_profs_by_dcs
    (
        i_lang          IN language.id_language%TYPE,
        i_prof          IN profissional,
        i_dep_clin_serv IN dep_clin_serv.id_dep_clin_serv%TYPE,
        o_profs         OUT table_number,
        o_error         OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
        SELECT a.id_professional
          BULK COLLECT
          INTO o_profs
          FROM prof_dep_clin_serv a
         WHERE a.id_dep_clin_serv = i_dep_clin_serv;
    
        RETURN TRUE;
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'GET_PROFS_BY_DCS',
                                              o_error);
            RETURN FALSE;
    END get_profs_by_dcs;

    FUNCTION set_prof_bleep_info
    (
        i_lang       IN language.id_language%TYPE,
        i_prof       IN profissional,
        i_work_phone IN professional.work_phone%TYPE,
        i_cell_phone IN professional.cell_phone%TYPE,
        i_bleep      IN professional.bleep_number%TYPE,
        o_error      OUT t_error_out
    ) RETURN BOOLEAN IS
    BEGIN
    
        g_error := 'Set bleep information for professional ' || i_prof.id;
        UPDATE professional p
           SET p.work_phone = i_work_phone, p.cell_phone = i_cell_phone, p.bleep_number = i_bleep
         WHERE p.id_professional = i_prof.id;
    
        g_error := 'SET PROFESSIONAL HISTORY';
        pk_backoffice.ins_professional_hist(i_id_professional => i_prof.id,
                                            i_operation_type  => pk_backoffice.g_prof_hist_oper_u);
    
        RETURN TRUE;
    
    EXCEPTION
        WHEN OTHERS THEN
            pk_alert_exceptions.process_error(i_lang,
                                              SQLCODE,
                                              SQLERRM,
                                              g_error,
                                              'ALERT',
                                              'PK_BACKOFFICE',
                                              'SET_PROF_BLEEP_INFO',
                                              o_error);
            pk_utils.undo_changes;
            pk_alert_exceptions.reset_error_state;
            RETURN FALSE;
    END set_prof_bleep_info;
BEGIN

    pk_alertlog.log_init(pk_alertlog.who_am_i);

    --g_analysis_freq := 'M';
    g_alert_institution := 1;
    g_exam_freq         := 'M';
    g_diag_freq         := 'M';
    g_drug_freq         := 'M';
    g_flg_avail         := 'Y';
    g_active            := 'A';

    g_cat_type_doc  := 'D';
    g_cat_type_nurs := 'N';
    g_cat_type_tec  := 'T';
    g_cat_type_adm  := 'A';
    g_cat_type_farm := 'P';
    g_cat_type_oth  := 'O';

    g_flg_avail := 'Y';

    g_status_pdcs_s := 'S';
    g_flg_available := 'Y';

    g_selected              := 'S';
    g_exam_avail            := 'Y';
    g_prof_flg_state_active := 'A';

    g_id_portugal := 620;

    g_profile_template_available  := 'Y';
    g_profile_template_cost_avlbl := 'Y';
    g_profile_template_desc_avlbl := 'Y';
    g_product_purchasable_avlbl   := 'Y';
    g_product_purch_cost_avlbl    := 'Y';
    g_product_purch_type          := 'N';
    g_profile_template_pay_type   := 'P';
    g_profile_template_free_type  := 'F';
    g_profile_template_type       := 'L';
    g_license_available           := 'Y';
    g_license_cancel              := 'C';
    g_license_waiting             := 'W';
    g_trans_status_available      := 'Y';
    g_payment_future_yes          := 'Y';
    g_payment_future_no           := 'N';
    g_flg_not_setupfee            := 'N';

    g_trans_status_waiting := 'W';
    g_trans_status_avlbl   := 'Y';

    g_flg_icon_active   := 'A';
    g_flg_icon_inactive := 'I';

    g_currency_available := 'Y';

    -- Bulk fetch limit
    g_bulk_fetch_rows := 100;

    g_flg_montlhy_payment    := 'M';
    g_flg_biannually_payment := 'B';
    g_flg_annually_payment   := 'A';

    g_montlhy_payment    := 1;
    g_biannually_payment := 6;
    g_annually_payment   := 12;

    g_flg_nonclinical := 'N';

    g_status_i := 'I';
    g_status_a := 'A';
    g_status_s := 'S';

    g_sysdate_tstz := current_timestamp;
    g_sysdate      := SYSDATE;

    g_series_active        := 'A';
    g_series_suspended     := 'S';
    g_series_inactive      := 'I';
    g_series_edit          := 'E';
    g_series_no            := 'N';
    g_series_pending       := 'P';
    g_series_concluded     := 'F';
    g_series_can_desc      := 'X';
    g_series_can           := 'C';
    g_series_desc          := 'D';
    g_series_available     := 'Y';
    g_series_edit_msg      := 'SIS_PRE_NATAL_T022';
    g_series_na_msg        := 'SIS_PRE_NATAL_T018';
    g_series_from_msg      := 'SIS_PRE_NATAL_T007';
    g_series_to_msg        := 'SIS_PRE_NATAL_T008';
    g_series_mask          := 'SIS_PRE_NATAL_MASK';
    g_series_avai_perc     := 'SIS_PRE_NATAL_AVAILABLE_%';
    g_series_domain        := 'SERIES.FLG_STATUS';
    g_series_not_valid_msg := 'SIS_PRE_NATAL_M003';

    g_account_type_p      := 'P';
    g_account_type_i      := 'I';
    g_account_type_b      := 'B';
    g_account_multichoice := 'M';

    g_account_prof_adeli  := 90;
    g_account_prof_drass  := 91;
    g_account_prof_stud   := 92;
    g_account_inst_finess := 93;
    g_account_inst_siren  := 94;
    g_account_inst_siret  := 95;
    g_account_inst_rpps   := 96;

END pk_backoffice;
/
