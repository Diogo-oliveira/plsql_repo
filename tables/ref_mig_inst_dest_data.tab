-- CHANGED BY: Ana Monteiro
-- CHANGE DATE: 29/06/2012 17:38
-- CHANGE REASON: [ALERT-234793] 
DECLARE
    l_count PLS_INTEGER;
BEGIN
    SELECT COUNT(1)
      INTO l_count
      FROM user_tables u
     WHERE u.table_name = 'REF_MIG_INST_DEST_DATA';

    IF l_count = 0
    THEN
        EXECUTE IMMEDIATE q'[CREATE TABLE REF_MIG_INST_DEST_DATA
 (ID_EXTERNAL_REQUEST NUMBER(24) NOT NULL
 ,ID_INST_DEST NUMBER(24) NOT NULL
 ,NUM_CLIN_RECORD VARCHAR2(100)
 ,SEQUENTIAL_NUMBER VARCHAR2(200)
 ,ID_PROF_FORWARD NUMBER(24)
 ,ID_PROF_SCHEDULE NUMBER(24)
 ,DT_SCHEDULE DATE
 ,CREATE_USER VARCHAR2(30)
 ,CREATE_TIME TIMESTAMP WITH LOCAL TIME ZONE
 ,CREATE_INSTITUTION NUMBER(24)
 ,UPDATE_USER VARCHAR2(30)
 ,UPDATE_TIME TIMESTAMP WITH LOCAL TIME ZONE
 ,UPDATE_INSTITUTION NUMBER(24)
 )]';
    
        EXECUTE IMMEDIATE 'COMMENT ON COLUMN REF_MIG_INST_DEST_DATA.ID_EXTERNAL_REQUEST IS ''Referral identifier to be migrated''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN REF_MIG_INST_DEST_DATA.ID_INST_DEST IS ''New dest institution identifier''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN REF_MIG_INST_DEST_DATA.NUM_CLIN_RECORD IS ''Patient clinical process number within the new institution''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN REF_MIG_INST_DEST_DATA.SEQUENTIAL_NUMBER IS ''Patient sequential number in the new institution''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN REF_MIG_INST_DEST_DATA.ID_PROF_FORWARD IS ''New professional to which the referral was forwarded''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN REF_MIG_INST_DEST_DATA.ID_PROF_SCHEDULE IS ''New professional identifier to which the referral was scheduled''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN REF_MIG_INST_DEST_DATA.DT_SCHEDULE IS ''New Schedule date in the new institution''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN REF_MIG_INST_DEST_DATA.CREATE_USER IS ''Creation User''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN REF_MIG_INST_DEST_DATA.CREATE_TIME IS ''Creation Time''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN REF_MIG_INST_DEST_DATA.CREATE_INSTITUTION IS ''Creation Institution''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN REF_MIG_INST_DEST_DATA.UPDATE_USER IS ''Update User''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN REF_MIG_INST_DEST_DATA.UPDATE_TIME IS ''Update Time''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN REF_MIG_INST_DEST_DATA.UPDATE_INSTITUTION IS ''Update Institution''';

    END IF;

END;
/
-- CHANGE END: Ana Monteiro

-- CHANGED BY: Ana Monteiro
-- CHANGE DATE: 10/09/2012 09:52
-- CHANGE REASON: [ALERT-239611] 
DECLARE
    l_count PLS_INTEGER;
BEGIN
    SELECT COUNT(1)
      INTO l_count
      FROM user_tab_columns t
     WHERE t.table_name = 'REF_MIG_INST_DEST_DATA'
       AND t.column_name = 'FLG_PROCESSED';

    IF l_count = 0
    THEN
        EXECUTE IMMEDIATE 'alter table REF_MIG_INST_DEST_DATA add flg_processed VARCHAR2(1 CHAR) default ''N'' not null';
    END IF;

END;
/

comment on table REF_MIG_INST_DEST_DATA is 'Referrals that are to be migrated or were already migrated';
comment on column REF_MIG_INST_DEST_DATA.flg_processed is 'Flag indicating if this record was already processed. S- successful, U- unsuccessful, N- not processed';
-- CHANGE END: Ana Monteiro