-- CHANGED BY: Ana Matos
-- CHANGE DATE: 23/11/2011 11:26
-- CHANGE REASON: [ALERT-205008] 
CREATE TABLE ANALYSIS_RESULT_HIST(
 DT_ANALYSIS_RESULT_HIST TIMESTAMP WITH LOCAL TIME ZONE NOT NULL,
 ID_ANALYSIS_RESULT NUMBER NOT NULL,
 ID_ANALYSIS NUMBER(12) NOT NULL,
 ID_ANALYSIS_REQ_DET NUMBER(24),
 ID_PROFESSIONAL NUMBER(24) NOT NULL,
 ID_PATIENT NUMBER(24) NOT NULL,
 DT_ANALYSIS_RESULT_TSTZ TIMESTAMP WITH LOCAL TIME ZONE NOT NULL,
 NOTES CLOB,
 FLG_TYPE VARCHAR2(1 CHAR) NOT NULL,
 ID_EPISODE NUMBER(24) NOT NULL,
 LOINC_CODE VARCHAR2(200 CHAR),
 FLG_STATUS VARCHAR2(1 CHAR),
 ID_INSTITUTION NUMBER(12),
 ID_VISIT NUMBER(24) NOT NULL,
 DT_SAMPLE TIMESTAMP(6) WITH LOCAL TIME ZONE,
 ID_EXAM_CAT NUMBER(24) NOT NULL,
 FLG_ORIG_ANALYSIS VARCHAR2(1 CHAR),
 ID_EPISODE_ORIG NUMBER(24),
 ID_RESULT_STATUS NUMBER(24) NOT NULL,
 FLG_RESULT_ORIGIN VARCHAR2(2 CHAR),
 ID_PROF_REQ NUMBER(24,0),
 ID_HARVEST NUMBER(24) NOT NULL,
 CREATE_USER VARCHAR2(24 CHAR),
 CREATE_TIME TIMESTAMP WITH LOCAL TIME ZONE,
 CREATE_INSTITUTION NUMBER(24),
 UPDATE_USER VARCHAR2(24 CHAR),
 UPDATE_TIME TIMESTAMP WITH LOCAL TIME ZONE,
 UPDATE_INSTITUTION NUMBER(24));

COMMENT ON TABLE ANALYSIS_RESULT_HIST IS 'Resultados das análises.Se estão associados a uma requisição, correspondem ao utente do episódio. Mas este registo também pode estar directamente associado ao utente, nos casos em que existem resultados de análises não requisitadas na instituição.';

COMMENT ON COLUMN ANALYSIS_RESULT_HIST.NOTES IS 'Descritivo do resultado (valor)';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.FLG_TYPE IS 'Registado por: D - médico; T - técnico';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.ID_EPISODE IS 'ID do episódio em que foram lidos os resultados, pelo requisitante';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.LOINC_CODE IS 'Código LOINC associado ao resultado';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.DT_SAMPLE IS 'Data do registo do resultado (Observações Periódicas, Histórico e Saúde Materna)';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.ID_EXAM_CAT IS 'Categoria da análise';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.FLG_ORIG_ANALYSIS IS 'Indicação da origem do resultado: O - observações periódicas; S - análises seriadas; M - saúde materna; X - outro .';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.ID_EPISODE_ORIG IS 'ID do episódio de criação da requisição';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.CREATE_USER IS 'Creation User';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.CREATE_TIME IS 'Creation Time';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.CREATE_INSTITUTION IS 'Creation Institution';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.UPDATE_USER IS 'Update User';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.UPDATE_TIME IS 'Update Time';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.UPDATE_INSTITUTION IS 'Update Institution';
-- CHANGE END: Ana Matos

-- CHANGED BY: Ana Matos
-- CHANGE DATE: 20/12/2011 09:06
-- CHANGE REASON: [ALERT-210670] 
ALTER TABLE ANALYSIS_RESULT_HIST MODIFY (ID_EPISODE NUMBER(24) NULL);
-- CHANGE END: Ana Matos

-- CHANGED BY: Ana Matos
-- CHANGE DATE: 03/12/2012 14:57
-- CHANGE REASON: [ALERT-246252] 
ALTER TABLE analysis_result_hist MODIFY (ID_SAMPLE_TYPE NUMBER(12) NOT NULL);
-- CHANGE END: Ana Matos

-- CHANGED BY: Ana Matos
-- CHANGE DATE: 03/12/2012 17:11
-- CHANGE REASON: [ALERT-246248] 
ALTER TABLE ANALYSIS_RESULT_HIST ADD (ID_SAMPLE_TYPE NUMBER(12));

COMMENT ON COLUMN ANALYSIS_RESULT_HIST.ID_SAMPLE_TYPE IS 'Sample type id';
-- CHANGE END: Ana Matos

-- CHANGED BY: Ana Matos
-- CHANGE DATE: 27/05/2013 17:35
-- CHANGE REASON: [ALERT-253722] 
ALTER TABLE ANALYSIS_RESULT_HIST ADD (RESULT_ORIGIN_NOTES VARCHAR2(200));

COMMENT ON COLUMN ANALYSIS_RESULT_HIST.RESULT_ORIGIN_NOTES IS 'Result origin notes';
-- CHANGE END: Ana Matos

-- CHANGED BY: Ana Matos
-- CHANGE DATE: 08/01/2016 12:01
-- CHANGE REASON: [ALERT-317702] 
COMMENT ON TABLE ANALYSIS_RESULT_HIST IS 'Lab tests'' orders results history table';

COMMENT ON COLUMN ANALYSIS_RESULT_HIST.DT_ANALYSIS_RESULT_HIST IS 'Date when the register was made';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.ID_ANALYSIS_RESULT IS 'Lab test result ID';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.ID_ANALYSIS IS 'Lab test ID';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.ID_ANALYSIS_REQ_DET IS 'Lab test''s order detail ID';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.ID_PROFESSIONAL IS 'Professional ID';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.ID_PATIENT IS 'Patient ID';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.FLG_TYPE IS 'Flag that indicates the professional''s category';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.ID_INSTITUTION IS 'Institution ID';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.ID_EPISODE IS 'Episode ID (when the results were read)';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.LOINC_CODE IS 'Result loinc code';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.FLG_STATUS IS 'Flag that indicates the result status';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.DT_ANALYSIS_RESULT_TSTZ IS 'Date that indicates when the result was registered';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.DT_SAMPLE IS 'Date of collection (when the result is registered manually)';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.ID_VISIT IS 'Visit ID';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.ID_EXAM_CAT IS 'Lab test''s category ID';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.FLG_ORIG_ANALYSIS IS 'Functionality result origin:  S - Lab tests'' history, M - Woman health, O - Flowsheets';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.ID_EPISODE_ORIG IS 'Episode ID';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.ID_RESULT_STATUS IS 'Result status ID';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.CREATE_USER IS 'Creation User';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.CREATE_TIME IS 'Creation Time';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.CREATE_INSTITUTION IS 'Creation Institution';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.UPDATE_USER IS 'Update User';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.UPDATE_TIME IS 'Update Time';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.UPDATE_INSTITUTION IS 'Update Institution';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.FLG_RESULT_ORIGIN IS 'Flag that indicates the result origin: I ? Interfaces; P ? Paciente: PC ? Prestador de cuidados; O ? Outro';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.ID_PROF_REQ IS 'Professional that order the lab test (when the result is registered manually)';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.NOTES IS 'Result notes';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.ID_HARVEST IS 'Harvest ID';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.ID_SAMPLE_TYPE IS 'Sample type ID';
COMMENT ON COLUMN ANALYSIS_RESULT_HIST.RESULT_ORIGIN_NOTES IS 'Result origin notes';
-- CHANGE END: Ana Matos

-- CHANGED BY: Ana Matos
-- CHANGE DATE: 21/01/2016 16:40
-- CHANGE REASON: [ALERT-318048] 
comment on column ANALYSIS_RESULT_HIST.FLG_RESULT_ORIGIN
  is 'Flag that indicates the result origin: I ? Interfaces, P ? Patient, PC ? Healthcare provider, O ? Other';
-- CHANGE END: Ana Matos

-- CHANGED BY: Pedro Henriques
-- CHANGE DATE: 09/07/2018 11:33
-- CHANGE REASON: [EMR-4796] 
DECLARE l_sql VARCHAR2(1000 CHAR);
BEGIN
    l_sql := 'ALTER TABLE alert.analysis_result_hist move lob(notes) store AS (tablespace alert_lob)';
    pk_versioning.run(l_sql);
EXCEPTION
    WHEN OTHERS THEN
        NULL;
END;
/
-- CHANGE END: Pedro Henriques