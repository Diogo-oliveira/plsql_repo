-- CHANGED BY: Ana Matos
-- CHANGE DATE: 06/09/2012 12:28
-- CHANGE REASON: [ALERT-237379] 
CREATE UNIQUE INDEX ADC_CNT_UK ON ANALYSIS_DESC
 (CASE  WHEN (ID_CONTENT IS NOT NULL AND NVL(FLG_AVAILABLE,'Y')<>'N') THEN ID_CONTENT END
 ,CASE  WHEN (ID_CONTENT IS NOT NULL AND NVL(FLG_AVAILABLE,'Y')<>'N') THEN FLG_AVAILABLE END
 ,CASE  WHEN (ID_CONTENT IS NOT NULL AND NVL(FLG_AVAILABLE,'Y')<>'N') THEN ID_ANALYSIS END
 ,CASE  WHEN (ID_CONTENT IS NOT NULL AND NVL(FLG_AVAILABLE,'Y')<>'N') THEN ID_ANALYSIS_PARAMETER END
 ,CASE  WHEN (ID_CONTENT IS NOT NULL AND NVL(FLG_AVAILABLE,'Y')<>'N') THEN VALUE END);
-- CHANGE END: Ana Matos

-- CHANGED BY: Ana Matos
-- CHANGE DATE: 07/03/2013 14:31
-- CHANGE REASON: [ALERT-252968] 
DECLARE
    e_object_exists EXCEPTION;
    e_index_not_exists EXCEPTION;

    PRAGMA EXCEPTION_INIT(e_object_exists, -00955);
    PRAGMA EXCEPTION_INIT(e_index_not_exists, -01418);
BEGIN
    BEGIN
        EXECUTE IMMEDIATE 'drop index ADC_CNT_UK';
    EXCEPTION
        WHEN e_index_not_exists THEN
            dbms_output.put_line('Non existing Index');
    END;
    BEGIN
        EXECUTE IMMEDIATE 'CREATE UNIQUE INDEX ADC_CNT_UK ON analysis_desc(CASE  WHEN (ID_CONTENT IS NOT NULL AND NVL(FLG_AVAILABLE,''Y'')<>''N'') THEN ID_CONTENT END, 
CASE  WHEN (ID_CONTENT IS NOT NULL AND NVL(FLG_AVAILABLE,''Y'')<>''N'') THEN FLG_AVAILABLE END, 
  CASE  WHEN (ID_CONTENT IS NOT NULL AND NVL(FLG_AVAILABLE,''Y'')<>''N'') THEN ID_ANALYSIS END, 
    CASE  WHEN (ID_CONTENT IS NOT NULL AND NVL(FLG_AVAILABLE,''Y'')<>''N'') THEN ID_ANALYSIS_PARAMETER END, 
      CASE  WHEN (ID_CONTENT IS NOT NULL AND NVL(FLG_AVAILABLE,''Y'')<>''N'') THEN id_sample_type END,
      CASE  WHEN (ID_CONTENT IS NOT NULL AND NVL(FLG_AVAILABLE,''Y'')<>''N'') THEN VALUE END                                                                       
                                                                        ) tablespace alert_idx';
    EXCEPTION
        WHEN e_object_exists THEN
            dbms_output.put_line('Index already there');
    END;
END;
/
-- CHANGE END: Ana Matos